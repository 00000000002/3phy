!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).AMMO={})}(this,(function(t){"use strict";var e=function(t){var e,s=Object.prototype,i=s.hasOwnProperty,r="function"==typeof Symbol?Symbol:{},o=r.iterator||"@@iterator",a=r.asyncIterator||"@@asyncIterator",n=r.toStringTag||"@@toStringTag";function l(t,e,s){return Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{l({},"")}catch(t){l=function(t,e,s){return t[e]=s}}function h(t,e,s,i){var r=e&&e.prototype instanceof y?e:y,o=Object.create(r.prototype),a=new M(i||[]);return o._invoke=function(t,e,s){var i=c;return function(r,o){if(i===d)throw new Error("Generator is already running");if(i===p){if("throw"===r)throw o;return L()}for(s.method=r,s.arg=o;;){var a=s.delegate;if(a){var n=k(a,s);if(n){if(n===f)continue;return n}}if("next"===s.method)s.sent=s._sent=s.arg;else if("throw"===s.method){if(i===c)throw i=p,s.arg;s.dispatchException(s.arg)}else"return"===s.method&&s.abrupt("return",s.arg);i=d;var l=m(t,e,s);if("normal"===l.type){if(i=s.done?p:u,l.arg===f)continue;return{value:l.arg,done:s.done}}"throw"===l.type&&(i=p,s.method="throw",s.arg=l.arg)}}}(t,s,a),o}function m(t,e,s){try{return{type:"normal",arg:t.call(e,s)}}catch(t){return{type:"throw",arg:t}}}t.wrap=h;var c="suspendedStart",u="suspendedYield",d="executing",p="completed",f={};function y(){}function g(){}function b(){}var A={};A[o]=function(){return this};var v=Object.getPrototypeOf,w=v&&v(v(C([])));w&&w!==s&&i.call(w,o)&&(A=w);var _=b.prototype=y.prototype=Object.create(A);function x(t){["next","throw","return"].forEach((function(e){l(t,e,(function(t){return this._invoke(e,t)}))}))}function S(t,e){function s(r,o,a,n){var l=m(t[r],t,o);if("throw"!==l.type){var h=l.arg,c=h.value;return c&&"object"==typeof c&&i.call(c,"__await")?e.resolve(c.__await).then((function(t){s("next",t,a,n)}),(function(t){s("throw",t,a,n)})):e.resolve(c).then((function(t){h.value=t,a(h)}),(function(t){return s("throw",t,a,n)}))}n(l.arg)}var r;this._invoke=function(t,i){function o(){return new e((function(e,r){s(t,i,e,r)}))}return r=r?r.then(o,o):o()}}function k(t,s){var i=t.iterator[s.method];if(i===e){if(s.delegate=null,"throw"===s.method){if(t.iterator.return&&(s.method="return",s.arg=e,k(t,s),"throw"===s.method))return f;s.method="throw",s.arg=new TypeError("The iterator does not provide a 'throw' method")}return f}var r=m(i,t.iterator,s.arg);if("throw"===r.type)return s.method="throw",s.arg=r.arg,s.delegate=null,f;var o=r.arg;return o?o.done?(s[t.resultName]=o.value,s.next=t.nextLoc,"return"!==s.method&&(s.method="next",s.arg=e),s.delegate=null,f):o:(s.method="throw",s.arg=new TypeError("iterator result is not an object"),s.delegate=null,f)}function T(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function V(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function M(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(T,this),this.reset(!0)}function C(t){if(t){var s=t[o];if(s)return s.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var r=-1,a=function s(){for(;++r<t.length;)if(i.call(t,r))return s.value=t[r],s.done=!1,s;return s.value=e,s.done=!0,s};return a.next=a}}return{next:L}}function L(){return{value:e,done:!0}}return g.prototype=_.constructor=b,b.constructor=g,g.displayName=l(b,n,"GeneratorFunction"),t.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===g||"GeneratorFunction"===(e.displayName||e.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,b):(t.__proto__=b,l(t,n,"GeneratorFunction")),t.prototype=Object.create(_),t},t.awrap=function(t){return{__await:t}},x(S.prototype),S.prototype[a]=function(){return this},t.AsyncIterator=S,t.async=function(e,s,i,r,o){void 0===o&&(o=Promise);var a=new S(h(e,s,i,r),o);return t.isGeneratorFunction(s)?a:a.next().then((function(t){return t.done?t.value:a.next()}))},x(_),l(_,n,"Generator"),_[o]=function(){return this},_.toString=function(){return"[object Generator]"},t.keys=function(t){var e=[];for(var s in t)e.push(s);return e.reverse(),function s(){for(;e.length;){var i=e.pop();if(i in t)return s.value=i,s.done=!1,s}return s.done=!0,s}},t.values=C,M.prototype={constructor:M,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(V),!t)for(var s in this)"t"===s.charAt(0)&&i.call(this,s)&&!isNaN(+s.slice(1))&&(this[s]=e)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var s=this;function r(i,r){return n.type="throw",n.arg=t,s.next=i,r&&(s.method="next",s.arg=e),!!r}for(var o=this.tryEntries.length-1;o>=0;--o){var a=this.tryEntries[o],n=a.completion;if("root"===a.tryLoc)return r("end");if(a.tryLoc<=this.prev){var l=i.call(a,"catchLoc"),h=i.call(a,"finallyLoc");if(l&&h){if(this.prev<a.catchLoc)return r(a.catchLoc,!0);if(this.prev<a.finallyLoc)return r(a.finallyLoc)}else if(l){if(this.prev<a.catchLoc)return r(a.catchLoc,!0)}else{if(!h)throw new Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return r(a.finallyLoc)}}}},abrupt:function(t,e){for(var s=this.tryEntries.length-1;s>=0;--s){var r=this.tryEntries[s];if(r.tryLoc<=this.prev&&i.call(r,"finallyLoc")&&this.prev<r.finallyLoc){var o=r;break}}o&&("break"===t||"continue"===t)&&o.tryLoc<=e&&e<=o.finallyLoc&&(o=null);var a=o?o.completion:{};return a.type=t,a.arg=e,o?(this.method="next",this.next=o.finallyLoc,f):this.complete(a)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),f},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var s=this.tryEntries[e];if(s.finallyLoc===t)return this.complete(s.completion,s.afterLoc),V(s),f}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var s=this.tryEntries[e];if(s.tryLoc===t){var i=s.completion;if("throw"===i.type){var r=i.arg;V(s)}return r}}throw new Error("illegal catch attempt")},delegateYield:function(t,s,i){return this.delegate={iterator:C(t),resultName:s,nextLoc:i},"next"===this.method&&(this.arg=e),f}},t}("object"==typeof module?module.exports:{});try{regeneratorRuntime=e}catch(t){Function("r","regeneratorRuntime = r")(e)}const s=new Map,i={world:null,bodyRef:null,byName:null,delta:0,substep:1,flow:{tmp:[],key:[]},reflow:{ray:[],stat:{fps:0,delta:0}}},r=Math.PI/180,o={clamp:(t,e,s)=>t=(t=t<e?e:t)>s?s:t},a={clear:()=>{s.clear()},byName:t=>s.has(t)?s.get(t):null,add:t=>{if("ray"!==t.type&&"contact"!==t.type)switch(t.type){case"joint":i.world.addConstraint(t,!t.collision);break;case"solid":i.world.addCollisionObject(t,t.group,t.mask);break;case"terrain":i.world.addCollisionObject(t.body,t.group,t.mask);break;case"body":i.world.addRigidBody(t,t.group,t.mask)}s.set(t.name,t)},remove:t=>{if("ray"!==t.type&&"contact"!==t.type)switch(t.type){case"joint":i.world.removeConstraint(t),Ammo.destroy(t.formA),Ammo.destroy(t.formB),Ammo.destroy(t);break;case"solid":i.world.removeCollisionObject(t),Ammo.destroy(t);break;case"body":i.world.removeRigidBody(t),Ammo.destroy(t);break;case"vehicle":case"terrain":t.release()}s.delete(t.name)},getVolume:(t,e,s)=>{let i=1;switch(t){case"sphere":i=4*Math.PI*e[0]*e[0]*e[0]/3;break;case"cone":i=Math.PI*e[0]*(.5*e[1])*2;break;case"box":i=.5*e[0]*8*(.5*e[1])*(.5*e[2]);break;case"cylinder":i=Math.PI*e[0]*e[0]*(.5*e[1])*2;break;case"capsule":i=4*Math.PI*e[0]*e[0]*e[0]/3+Math.PI*e[0]*e[0]*(.5*e[1])*2;break;case"convex":case"mesh":i=a.getConvexVolume(s)}return i},getConvexVolume:t=>{let e,s=t.length/3,i=[t[0],t[1],t[2]],r=[t[0],t[1],t[2]];for(;s--;)e=3*s,t[e]<i[0]?i[0]=t[e]:t[e]>r[0]&&(r[0]=t[e]),t[e+1]<i[1]?i[1]=t[e+1]:t[e+1]>r[1]&&(r[1]=t[e+1]),t[e+2]<i[2]?i[2]=t[e+2]:t[e+2]>r[2]&&(r[2]=t[e+2]);return(r[0]-i[0])*(r[1]-i[1])*(r[2]-i[2])},malloc:(t,e)=>{var s=t.length*t.BYTES_PER_ELEMENT;return void 0===e&&(e=Ammo._malloc(s)),new Uint8Array(Ammo.HEAPU8.buffer,e,s).set(new Uint8Array(t.buffer)),e},free:t=>{t&&Ammo._free(t)},stats:()=>{},extends:()=>{Ammo.btVector3.prototype.set=function(t,e,s){return this.setValue(t,e,s),this},Ammo.btVector3.prototype.toArray=function(t,e){let s=void 0!==t;if(s||(t=[]),t[e=e||0]=this.x(),t[e+1]=this.y(),t[e+2]=this.z(),!s)return t},Ammo.btVector3.prototype.fromArray=function(t,e){return e=e||0,this.setValue(t[e],t[e+1],t[e+2]),this},Ammo.btVector3.prototype.copy=function(t){return this.setValue(t.x(),t.y(),t.z()),this},Ammo.btVector3.prototype.sub=function(t){return this.setValue(this.x()-t.x(),this.y()-t.y(),this.z()-t.z()),this},Ammo.btVector3.prototype.mul=function(){return this.x()*this.y()*this.z()},Ammo.btVector3.prototype.multiplyArray=function(t){return this.setValue(this.x()*t[0],this.y()*t[1],this.z()*t[2]),this},Ammo.btVector3.prototype.multiplyScalar=function(t){return this.setValue(this.x()*t,this.y()*t,this.z()*t),this},Ammo.btVector3.prototype.divideScalar=function(t){return this.multiplyScalar(1/t)},Ammo.btVector3.prototype.applyMatrix3=function(t){const e=this.x(),s=this.y(),i=this.z(),r=[];return t.getRow(0).toArray(r,0),t.getRow(1).toArray(r,3),t.getRow(2).toArray(r,6),this.setValue(r[0]*e+r[3]*s+r[6]*i,r[1]*e+r[4]*s+r[7]*i,r[2]*e+r[5]*s+r[8]*i),this},Ammo.btVector3.prototype.free=function(){},Ammo.btQuaternion.prototype.set=function(t,e,s,i){return this.setValue(t,e,s,i),this},Ammo.btQuaternion.prototype.toArray=function(t,e){let s=void 0!==t;if(s||(t=[]),t[e=e||0]=this.x(),t[e+1]=this.y(),t[e+2]=this.z(),t[e+3]=this.w(),!s)return t},Ammo.btQuaternion.prototype.fromArray=function(t,e){return e=e||0,this.setValue(t[e],t[e+1],t[e+2],t[e+3]),this},Ammo.btQuaternion.prototype.multiply=function(t){return this.multiplyQuaternions(this,t)},Ammo.btQuaternion.prototype.premultiply=function(t){return this.multiplyQuaternions(t,this)},Ammo.btQuaternion.prototype.multiplyQuaternions=function(t,e){const s=t.x(),i=t.y(),r=t.z(),o=t.w(),a=e.x(),n=e.y(),l=e.z(),h=e.w();return this.setValue(s*h+o*a+i*l-r*n,i*h+o*n+r*a-s*l,r*h+o*l+s*n-i*a,o*h-s*a-i*n-r*l),this},Ammo.btQuaternion.prototype.fromAxisAngle=function(t,e){var s=.5*e,i=Math.sin(s);return this.setValue(t[0]*i,t[1]*i,t[2]*i,Math.cos(s)),this},Ammo.btQuaternion.prototype.fromAxis=function(t){let e=t.toArray();if(e[2]>.99999)this.setValue(0,0,0,1);else if(e[2]<-.99999)this.setValue(1,0,0,0);else{let t=[e[1],e[0],0],s=Math.acos(e[2]);this.fromAxisAngle(t,s)}return this},Ammo.btQuaternion.prototype.free=function(){},Ammo.btTransform.prototype.set=function(t,e){return this.setOrigin(t),this.setRotation(e),this},Ammo.btTransform.prototype.identity=function(){return this.setIdentity(),this},Ammo.btTransform.prototype.fromArray=function(t,e,s,i){let r=this.getOrigin();r.fromArray(t||[0,0,0],s||0),this.setOrigin(r);let o=this.getRotation();return o.fromArray(e||[0,0,0,1],i||0),this.setRotation(o),this},Ammo.btTransform.prototype.toArray=function(t,e){e=e||0,this.getOrigin().toArray(t,e),this.getRotation().toArray(t,e+3)},Ammo.btTransform.prototype.getPos=function(){return this.getOrigin().toArray()},Ammo.btTransform.prototype.getQuat=function(){return this.getRotation().toArray()},Ammo.btTransform.prototype.copy=function(t){return this.setOrigin(t.getOrigin()),this.setRotation(t.getRotation()),this},Ammo.btTransform.prototype.rotationFromAxis=function(t){let e=this.getRotation();return e.fromAxis(t),this.setRotation(e),this},Ammo.btTransform.prototype.free=function(){}}},n={bodyFull:14,body:8,joint:16,contact:8,ray:8,character:16,vehicle:64,solver:256};class l{constructor(){this.id=0,this.list=[],this.type="item",this.Utils=null}reset(){let t=this.list.length;for(;t--;)this.dispose(this.list[t]);this.id=0,this.list=[]}byName(t){return this.Utils.byName(t)}setName(t={}){let e=void 0!==t.name?t.name:this.type+this.id++;return t.id=this.remove(e,!0),t.name=e,e}addToWorld(t,e=-1){this.Utils.add(t),-1!==e?this.list[e]=t:this.list.push(t)}remove(t,e){let s=this.byName(t);return s?this.clear(s,e):-1}clear(t,e){let s=this.list.indexOf(t);return-1===s||e?this.list[s]=null:this.list.splice(s,1),this.dispose(t),s}dispose(t){null!==t&&this.Utils.remove(t)}add(t={}){}set(t={}){}step(t,e){}}class h extends l{constructor(){super(),this.Utils=a,this.type="ray",this.callback=new Ammo.ClosestRayResultCallback}step(t,e){i.reflow.ray=[];let s,r,o,a=this.list.length,l=this.callback;for(;a--;)r=e+a*n.ray,s=this.list[a],t[r]=0,l.set_m_collisionObject(null),l.get_m_rayFromWorld().fromArray(t,r+1),l.get_m_rayToWorld().fromArray(t,r+4),l.set_m_collisionFilterGroup(s.group),l.set_m_collisionFilterMask(s.mask),l.set_m_closestHitFraction(s.precision),i.world.rayTest(l.get_m_rayFromWorld(),l.get_m_rayToWorld(),l),l.hasHit()&&(t[r]=1,l.get_m_hitPointWorld().toArray(t,r+1),l.get_m_hitNormalWorld().toArray(t,r+4),o=Ammo.castObject(l.get_m_collisionObject(),Ammo.btRigidBody).name,void 0===o&&(o=Ammo.castObject(ray.get_m_collisionObject(),Ammo.btSoftBody).name),i.reflow.ray[a]=o)}add(t={}){this.setName(t);let e=new m(t);this.addToWorld(e,t.id)}set(t={},e=null){}}class m{constructor(t={}){this.type="ray",this.name=t.name,this.precision=t.precision||1,this.group=void 0!==t.group||1,this.mask=void 0!==t.mask||-1}}class c extends l{constructor(){super(),this.Utils=a,this.type="body",this.num=n[this.type],this.full=!1,this.v=new Ammo.btVector3,this.vv=new Ammo.btVector3,this.q=new Ammo.btQuaternion,this.t=new Ammo.btTransform,this.v1=new Ammo.btVector3,this.v2=new Ammo.btVector3,this.v3=new Ammo.btVector3}setFull(t){this.num=n[t?"bodyFull":"body"],this.full=t}step(t,e){let s,i,r,o,a=this.list.length;for(;a--;)s=this.list[a],i=e+a*this.num,s?(t[i]=2===s.getMotionState()?0:1,s.getMotionState().getWorldTransform(this.t),this.t.toArray(t,i+1),this.full&&(r=s.getLinearVelocity(),r.toArray(t,i+8),1===t[i]&&(t[i]=9.8*r.length()),o=s.getAngularVelocity(),o.toArray(t,i+11))):t[i]=t[i+1]=t[i+2]=t[i+3]=t[i+4]=t[i+5]=t[i+6]=t[i+7]=0}shape(t={}){let e,s,i,r=t.type||"box",o=t.size||[1,1,1];switch(r){case"plane":e=new Ammo.btStaticPlaneShape(this.v.fromArray(t.dir||[0,1,0]),0);break;case"box":e=new Ammo.btBoxShape(this.v.set(.5*o[0],.5*o[1],.5*o[2]));break;case"sphere":e=new Ammo.btSphereShape(o[0]);break;case"cone":e=new Ammo.btConeShape(o[0],o[1]);break;case"cylinder":e=new Ammo.btCylinderShape(this.v.set(o[0],.5*o[1],o[0]));break;case"capsule":e=new Ammo.btCapsuleShape(o[0],o[1]);break;case"convex":for(e=new Ammo.btConvexHullShape,s=Math.floor(t.v.length/3);s--;)i=3*s,e.addPoint(this.v.fromArray(t.v,i),!1);e.optimizeConvexHull(),e.recalcLocalAabb();break;case"mesh":let r=new Ammo.btTriangleMesh,a=!1,n=t.v,l=t.index||null,h=n.length;if(null!==l){for(h=n.length,s=0;s<h;s+=3)r.findOrAddVertex(this.v.set(n[s],n[s+1],n[s+2]),!1);for(h=l.length,s=0;s<h;s+=3)r.addTriangleIndices&&r.addTriangleIndices(l[s],l[s+1],l[s+2])}else for(s=0;s<h;s+=9)r.addTriangle(this.v1.set(n[s+0],n[s+1],n[s+2]),this.v2.set(n[s+3],n[s+4],n[s+5]),this.v3.set(n[s+6],n[s+7],n[s+8]),a);"solid"!==this.type&&Ammo.btGImpactMeshShape?(e=new Ammo.btGImpactMeshShape(r),e.setMargin(t.margin||.01)):e=new Ammo.btBvhTriangleMeshShape(r,!0,!0)}return e.setMargin&&e.setMargin(t.margin||1e-4),e.volume=a.getVolume(r,o,t.v),e}add(t={}){let e=this.setName(t),s=void 0!==t.flag?t.flag:"solid"===this.type?1:0,i=void 0!==t.group?t.group:"solid"===this.type?2:1,r=void 0!==t.mask?t.mask:-1;t.kinematic&&(s=2,i=4);let o=null;switch(t.type){case"null":r=0,o=this.shape({type:"sphere",size:[.01]});break;case"compound":let e,s;o=new Ammo.btCompoundShape,o.volume=0;for(var a=0;a<t.shapes.length;a++)e=t.shapes[a],this.t.fromArray(e.pos,e.quat),s=this.shape(e),o.volume+=s.volume,o.addChildShape(this.t,s);break;default:o=this.shape(t)}this.t.fromArray(t.pos,t.quat),this.v.set(0,0,0);let n=(t.density||0)*o.volume;0!==n&&o.calculateLocalInertia(n,this.v);let l=new Ammo.btDefaultMotionState(this.t),h=new Ammo.btRigidBodyConstructionInfo(n,l,o,this.v),m=new Ammo.btRigidBody(h);m.setCollisionFlags(s),Ammo.destroy(h),m.name=e,m.type=this.type,m.isKinematic=t.kinematic||!1,m.isGhost=!1,m.group=i,m.mask=r,m.first=!0,delete t.pos,delete t.quat,this.set(t,m),this.addToWorld(m,t.id)}set(t={},e=null){null===e&&(e=this.byName(t.name)),null!==e&&(void 0!==t.flag&&(e.setCollisionFlags(t.flag),e.isKinematic=2===t.flag),t.noGravity&&e.setGravity(this.v.fromArray([0,0,0])),(t.pos||t.quat)&&(t.pos&&t.quat||e.getMotionState().getWorldTransform(this.t),t.pos||(t.pos=this.t.getPos()),t.quat||(t.quat=this.t.getQuat()),this.t.fromArray(t.pos,t.quat),e.isKinematic?e.getMotionState().setWorldTransform(this.t):e.setWorldTransform(this.t)),void 0!==t.state&&e.setActivationState(t.state),(t.activate||t.wake)&&e.activate(),void 0!==t.neverSleep&&(t.neverSleep?(e.setSleepingThresholds(0,0),e.activate()):e.setSleepingThresholds(.8,1)),t.sleep&&e.setActivationState(2),void 0!==t.friction&&e.setFriction(t.friction),void 0!==t.restitution&&e.setRestitution(t.restitution),void 0!==t.rollingFriction&&e.setRollingFriction(t.rollingFriction),t.reset&&(e.setLinearVelocity(this.v.set(0,0,0)),e.setAngularVelocity(this.v.set(0,0,0))),e.isGhost||(void 0!==t.group&&(e.getBroadphaseProxy().set_m_collisionFilterGroup(t.group),e.group=t.group),void 0!==t.mask&&(e.getBroadphaseProxy().set_m_collisionFilterMask(t.mask),e.mask=t.mask),void 0!==t.damping&&e.setDamping(t.damping[0],t.damping[1]),void 0!==t.sleeping&&e.setSleepingThresholds(t.sleeping[0],t.sleeping[1])),void 0!==t.linearVelocity&&e.setLinearVelocity(this.v.fromArray(t.linearVelocity)),void 0!==t.angularVelocity&&e.setAngularVelocity(this.v.fromArray(t.angularVelocity)),void 0!==t.linearFactor&&e.setLinearFactor(this.v.fromArray(t.linearFactor)),void 0!==t.angularFactor&&e.setAngularFactor(this.v.fromArray(t.angularFactor)),void 0!==t.anisotropic&&e.setAnisotropicFriction(t.anisotropic[0],t.anisotropic[1]),void 0!==t.massProps&&e.setMassProps(t.massProps[0],t.massProps[1]),void 0!==t.ccdThreshold&&e.setCcdMotionThreshold(t.ccdThreshold),void 0!==t.ccdRadius&&e.setCcdSweptSphereRadius(t.ccdRadius),void 0!==t.gravity&&e.setGravity(this.v.fromArray(t.gravity)),t.worldForce&&e.applyForce(this.v.fromArray(t.worldForce),this.v.fromArray(t.worldForce,3)),t.force&&e.applyForce(this.v.fromArray(t.force).divideScalar(i.substep)),t.torque&&e.applyTorque(this.v.fromArray(t.torque).divideScalar(i.substep)),t.linearImpulse&&(t.impulseCentral=t.linearImpulse),t.impulseCentral&&e.applyCentralImpulse(this.v.fromArray(t.impulseCentral)),t.impulse&&e.applyImpulse(this.v.fromArray(t.impulse),this.v.fromArray(t.impulse,3)))}}class u extends l{constructor(){super(),this.Utils=a,this.type="joint",this.t=new Ammo.btTransform,this.t1=new Ammo.btTransform,this.t2=new Ammo.btTransform,this.v1=new Ammo.btVector3,this.v2=new Ammo.btVector3,this.p1=new Ammo.btVector3,this.p2=new Ammo.btVector3,this.q1=new Ammo.btQuaternion,this.q2=new Ammo.btQuaternion}step(t,e){let s,i,r=this.list.length;for(;r--;)s=this.list[r],i=e+r*n.joint,s.visible&&(this.t.copy(s.B1.getWorldTransform()).op_mul(s.formA).toArray(t,i),this.t.copy(s.B2.getWorldTransform()).op_mul(s.formB).toArray(t,i+7))}add(t={}){this.v;let e=this.setName(t);const s=this.byName(t.b1),i=this.byName(t.b2);let r=this.v1.fromArray(t.pos1||[0,0,0]),o=this.v2.fromArray(t.pos2||[0,0,0]),a=this.q1.fromArray(t.quat1||[0,0,0,1]),n=this.q2.fromArray(t.quat2||[0,0,0,1]),l=this.p1.fromArray(t.axis1||[0,0,1]),h=this.p2.fromArray(t.axis2||[0,0,1]);t.quat1||a.fromAxis(l),t.quat2||n.fromAxis(h),this.t1.identity(),this.t2.identity();const m=t.useA||!1;(t.worldAnchor||t.worldAxis)&&(s&&(s.activate(),s.getMotionState().getWorldTransform(this.t1)),i&&(i.activate(),i.getMotionState().getWorldTransform(this.t2))),t.worldAnchor&&(r=this.v1.fromArray(t.worldAnchor).op_sub(this.t1.getOrigin()),o=this.v2.fromArray(t.worldAnchor).op_sub(this.t2.getOrigin()),r.applyMatrix3(this.t1.getBasis()),o.applyMatrix3(this.t2.getBasis())),t.worldAxis&&(l=this.p1.fromArray(t.worldAxis),h=this.p2.fromArray(t.worldAxis),l.applyMatrix3(this.t1.getBasis()),h.applyMatrix3(this.t2.getBasis()),a.fromAxis(l),n.fromAxis(h));const c=(new Ammo.btTransform).set(r,a),u=(new Ammo.btTransform).set(o,n);let d,p=t.mode||"revolute";switch("d6"===p&&(p="dof"),"slider"===p&&(p="prismatic"),"joint_p2p"===p&&(p="spherical"),"conetwist"===p&&(p="ragdoll"),p){case"spherical":d=new Ammo.btPoint2PointConstraint(s,i,r,o),t.strength&&d.get_m_setting().set_m_tau(t.strength),t.damping&&d.get_m_setting().set_m_damping(t.damping),t.impulse&&d.get_m_setting().set_m_impulseClamp(t.impulse);break;case"hinge2":d=new Ammo.btHinge2Constraint(s,i,r,l,h);break;case"hinge":case"revolute":d=new Ammo.btHingeConstraint(s,i,c,u,m);break;case"prismatic":d=new Ammo.btSliderConstraint(s,i,c,u,m);break;case"ragdoll":d=new Ammo.btConeTwistConstraint(s,i,c,u);break;case"dof":d=new Ammo.btGeneric6DofSpringConstraint(s,i,c,u,m),d.setAngularLowerLimit(this.v1.fromArray([0,0,0])),d.setAngularUpperLimit(this.v1.fromArray([0,0,0]));break;case"fixe":d=new Ammo.btFixedConstraint(s,i,c,u);break;case"gear":d=new Ammo.btGearConstraint(s,i,l,h,t.ratio||1)}d.name=e,d.mode=p,d.type=this.type,d.B1=s,d.B2=i,d.formA=c,d.formB=u,d.visible=void 0===t.visible||t.visible,d.collision=t.collision||!1,this.set(t,d),this.addToWorld(d,t.id)}set(t={},e=null){if(null===e&&(e=this.byName(t.name)),null===e)return;let s,i,o,a;t.breaking&&e.setBreakingImpulseThreshold&&e.setBreakingImpulseThreshold(t.breaking),t.iteration&&e.setOverrideNumSolverIterations&&e.setOverrideNumSolverIterations(t.iteration);const n=["x","y","z","rx","ry","rz"];switch(e.mode){case"prismatic":break;case"hinge":case"revolute":t.lm&&e.setLimit(t.lm[0]*r,t.lm[1]*r,t.lm[2]||.9,t.lm[3]||.3,t.lm[4]||1),t.motor&&e.enableAngularMotor(!0,t.motor[0]*r,t.motor[1]);break;case"dof":case"sdof":if(t.motor)for(s=t.motor.length;s--;)i=t.motor[s],"rx"===i[0]&&(o=e.getRotationalLimitMotor(0)),"ry"===i[0]&&(o=e.getRotationalLimitMotor(1)),"rz"===i[0]&&(o=e.getRotationalLimitMotor(2)),o&&(o.set_m_enableMotor(!0),o.set_m_targetVelocity(-i[1]*r),o.set_m_maxMotorForce(i[2]));if(t.lm){for(o=[[0,0,0],[0,0,0],[0,0,0],[0,0,0]],s=t.lm.length;s--;)i=t.lm[s],"rx"===i[0]&&(o[0][0]=i[1]*r,o[1][0]=i[2]*r),"ry"===i[0]&&(o[0][1]=i[1]*r,o[1][1]=i[2]*r),"rz"===i[0]&&(o[0][2]=i[1]*r,o[1][2]=i[2]*r),"x"===i[0]&&(o[2][0]=i[1],o[3][0]=i[2]),"y"===i[0]&&(o[2][1]=i[1],o[3][1]=i[2]),"z"===i[0]&&(o[2][2]=i[1],o[3][2]=i[2]);e.setAngularLowerLimit(this.v1.fromArray(o[0])),e.setAngularUpperLimit(this.v1.fromArray(o[1])),e.setLinearLowerLimit(this.v1.fromArray(o[2])),e.setLinearUpperLimit(this.v1.fromArray(o[3]))}if(t.sd)for(s=t.sd.length;s--;)i=t.sd[s],a=n.indexOf(i[0]),e.setStiffness(a,i[1]),e.setDamping(a,i[2]),e.enableSpring(a,!0),i[3]&&e.setEquilibriumPoint(a)}}}class d extends l{constructor(){super(),this.Utils=a,this.type="contact",this.cb=new Ammo.ConcreteContactResultCallback}step(t,e){let s,r,o,a=this.list.length;for(;a--;)o=0,s=this.list[a],r=e+a*n.contact,this.cb.addSingleResult=function(){o=1},null!==s.b2?i.world.contactPairTest(s.b1,s.b2,this.cb):i.world.contactTest(s.b1,this.cb),t[r]=o}add(t={}){this.setName(t),t.b1=this.byName(t.b1),t.b2=this.byName(t.b2);let e=new p(t);this.addToWorld(e,t.id)}}class p{constructor(t={}){this.type="contact",this.name=t.name,this.b1=t.b1||null,this.b2=t.b2||null,this.ignore=t.ignore||[],this.result={hit:!1,point:[0,0,0],normal:[0,0,0],distance:0}}update(){}}class f extends l{constructor(){super(),this.type="vehicle",this.Utils=a,this.trans=new Ammo.btTransform}step(t,e){let s,i=this.list.length;for(;i--;)s=e+i*n.vehicle,this.list[i].step(t,s,this.trans)}add(t){this.setName(t);let e=new y(t);this.addToWorld(e,t.id)}set(t={},e=null){null===e&&(e=this.byName(t.name)),null!==e&&e.set(t)}}class y{constructor(t){this.type="vehicle",this.name=t.name,this.numWheel=t.numWheel||4,this.wheelsPosition=t.wheelsPosition,this.radius=t.radius,this.radiusBack=t.radiusBack,this.deep=t.deep,this.deepBack=t.deepBack,this.massCenter=t.massCenter||[0,.55,1.594],this.chassisPos=t.chassisPos||[0,.83,0],this.chassis=null,this.body=null,this.steering=0,this.breaking=0,this.motor=0,this.gearRatio=[-1,0,2.3,1.8,1.3,.9,.5],this.key=[0,0,0,0,0,0,0,0],this.limitAngular=[1,1,1],this.transforms=[],this.wheelBody=[],this.wheelJoint=[],this.wheelRadius=[],this.isRay=!0,this.data={mass:t.mass||2e3,incSteering:t.incSteering||2,maxSteering:t.maxSteering||24,wMass:1,wWidth:.25,nWheel:t.nWheel||4,wPos:[1,0,1.6],engine:1e3,acceleration:10,breaking:100,pos:[0,0,0],quat:[0,0,0,1],masscenter:[0,-.6,0],friction:.6,restitution:.1,linear:0,angular:0,rolling:0,autoSuspension:!1,compValue:.2,dampValue:.3,s_stiffness:20,s_compression:2.3,s_damping:4.4,s_travel:5,s_force:6e3,s_length:.2,w_friction:10.5,w_roll:.001},this.init(t)}init(t){this.wpos=t.wPos;const e=this.data;let s=new Ammo.btTransform,r=new Ammo.btVector3,o=new Ammo.btVector3,a=new Ammo.btVector3,n=new Ammo.btVector3;this.isRay=void 0===t.isRay||t.isRay,e.mass=void 0===t.mass?800:t.mass,e.pos=void 0===t.pos?[0,0,0]:t.pos,e.quat=void 0===t.quat?[0,0,0,1]:t.quat,e.nWheel=t.nWheel||4,this.chassisShape=t.chassisShape?i.bodyRef.shape(t.chassisShape):new Ammo.btBoxShape(r.set(.85,.65,2.5)),r.fromArray(this.massCenter),s.setIdentity(),s.setOrigin(r);const l=new Ammo.btCompoundShape;l.addChildShape(s,this.chassisShape),this.startPose=(new Ammo.btTransform).fromArray(this.startPosition,this.startQuaternion),r.setValue(0,0,0),l.calculateLocalInertia(e.mass,r);var h=new Ammo.btDefaultMotionState(this.startPose),m=new Ammo.btRigidBodyConstructionInfo(e.mass,h,l,r);this.body=new Ammo.btRigidBody(m),this.body.name=this.name,this.body.setActivationState(4),Ammo.destroy(m);const c=new Ammo.btVehicleTuning,u=new Ammo.btDefaultVehicleRaycaster(i.world);this.chassis=new Ammo.btRaycastVehicle(c,this.body,u),this.chassis.setCoordinateSystem(0,1,2);const d=this.numWheel;for(let e=0;e<d;e++){let s=!0;o.fromArray(this.wheelsPosition[e]),a.setValue(0,-1,0),n.setValue(-1,0,0),this.chassis.addWheel(o,a,n,1,this.radius,c,s),this.chassis.setBrake(t.breaking||100,e)}this.setData(t),s.free(),r.free(),o.free(),a.free(),n.free(),i.world.addAction(this.chassis),i.world.addRigidBody(this.body)}step(t,e,s){this.drive(),t[e]=this.chassis.getCurrentSpeedKmHour(),this.body.getMotionState().getWorldTransform(s),s.toArray(t,e+1),s=s.inverse();for(var i,r,o=this.data.nWheel;o--;)this.chassis.updateWheelTransform(o,!0),(r=this.chassis.getWheelTransformWS(o)).mult(s,r),t[e+56+o]=this.chassis.getWheelInfo(o).get_m_raycastInfo().get_m_suspensionLength(),i=8*(o+1),r.toArray(t,e+i+1),0===o&&(t[e+i]=this.chassis.getWheelInfo(0).get_m_steering()),1===o&&(t[e+i]=this.chassis.getWheelInfo(1).get_m_steering()),2===o&&(t[e+i]=this.steering);t[e+62]=this.chassis.getWheelInfo(0).m_rotation,t[e+63]=this.chassis.getWheelInfo(1).m_rotation}set(t){t.key&&(this.key=t.key)}setMass(t){var e=o.vector3();this.data.mass=t,e.setValue(0,0,0),this.body.getCollisionShape().calculateLocalInertia(this.data.mass,e),this.body.setMassProps(t,e),this.body.updateInertiaTensor(),e.free()}setPosition(){this.steering=0,this.breaking=0,this.motor=0;var t=o.transform();t.identity().fromArray(this.data.pos.concat(this.data.quat));var e=o.vector3().set(0,0,0);this.body.setAngularVelocity(e),this.body.setLinearVelocity(e),this.body.setWorldTransform(t),this.chassis.resetSuspension();for(var s=this.data.nWheel;s--;)this.chassis.updateWheelTransform(s,!0);t.free(),e.free()}drive(){const t=this.data,e=this.key;let s,i;if(0===e[0]?this.steering*=.9:this.steering-=t.incSteering*e[0],this.steering=o.clamp(this.steering,-t.maxSteering,t.maxSteering),0===e[1]?(this.motor=0,this.breaking=t.breaking):(this.motor-=t.acceleration*e[1],this.breaking=0),this.motor=o.clamp(this.motor,-t.engine,t.engine),this.numWheel>3){let t=2*this.wpos[2],e=this.wpos[0],o=t/Math.tan(this.steering*r);s=Math.atan2(t,e+o),i=Math.atan2(t,-e+o),o<0&&(s-=Math.PI,i-=Math.PI)}let a=this.numWheel;for(;a--;)this.numWheel<4?0===a&&this.chassis.setSteeringValue(this.steering*r,a):(0===a&&this.chassis.setSteeringValue(i,a),1===a&&this.chassis.setSteeringValue(s,a)),this.chassis.applyEngineForce(this.motor,a),this.chassis.setBrake(this.breaking,a);if(this.motor<1){var n=this.body.getAngularVelocity();n.multiplyArray(this.limitAngular),this.body.setAngularVelocity(n)}}clear(){this.body=null,this.chassis=null}setData(t){var e=this.data;for(var s in void 0!==t.mass&&t.mass!==e.mass&&this.setMass(t.mass),t)void 0!==e[s]&&(e[s]=t[s]);this.body.setFriction(e.friction),this.body.setRestitution(e.restitution),this.body.setDamping(e.linear,e.angular),this.body.setRollingFriction(e.rolling),void 0!==t.limitAngular&&(this.limitAngular=t.limitAngular);var i=new Ammo.btVector3;if(void 0!==t.linearFactor&&this.body.setLinearFactor(i.fromArray(t.linearFactor)),void 0!==t.angularFactor&&this.body.setAngularFactor(i.fromArray(t.angularFactor)),i.free(),e.autoSuspension){var r=Math.sqrt(e.s_stiffness);e.s_compression=2*e.compValue*r,e.s_damping=2*e.dampValue*r}for(var o,a=e.nWheel;a--;)(o=this.chassis.getWheelInfo(a)).set_m_suspensionStiffness(e.s_stiffness),o.set_m_wheelsDampingCompression(e.s_compression),o.set_m_wheelsDampingRelaxation(e.s_damping),o.set_m_maxSuspensionTravelCm(100*e.s_travel),o.set_m_suspensionRestLength1(e.s_length),o.set_m_maxSuspensionForce(e.s_force),o.set_m_rollInfluence(e.w_roll),o.set_m_frictionSlip(e.w_friction),o.set_m_wheelsRadius(a<2?this.radius:this.radiusBack);t.reset&&this.setPosition()}get(){self.postMessage({m:"carData",o:this.data})}release(){i.world.removeAction(this.chassis),i.world.removeRigidBody(this.body),Ammo.destroy(this.chassis),Ammo.destroy(this.body)}}class g extends l{constructor(){super(),this.type="terrain",this.Utils=a}add(t){this.setName(t);let e=new b(t);this.addToWorld(e,t.id)}set(t={},e=null){null===e&&(e=this.byName(t.name)),null!==e&&e.set(t)}}class b{constructor(t){this.type="terrain",this.name=t.name,this.needUpdate=!1,this.heightField=null,this.t=new Ammo.btTransform,this.data=null,this.init(t)}init(t){const e=t.size,s=[e[0]/(t.sample[0]-1),e[2]/(t.sample[1]-1)];this.fullSample=[t.sample[0],t.sample[1]],this.setData(t),this.update();let i=void 0===t.margin?.02:t.margin,r=void 0===t.heightScale?1:t.heightScale,o=void 0===t.upAxis?1:t.upAxis,a=new Ammo.btHeightfieldTerrainShape(t.sample[0],t.sample[1],this.data,r,2*-e[1],2*e[1],o,"PHY_FLOAT",!1),n=new Ammo.btVector3(s[0],1,s[1]);a.setLocalScaling(n),a.setMargin(i);let l=void 0===t.mass?0:t.mass,h=void 0===t.friction?.5:t.friction,m=void 0===t.restitution?0:t.restitution,c=void 0===t.flag?1:t.flag;this.group=void 0!==t.group?t.group:2,this.mask=void 0!==t.mask?t.mask:-1,this.t.fromArray(t.pos,t.quat),n.set(0,0,0);let u=new Ammo.btDefaultMotionState(this.t),d=new Ammo.btRigidBodyConstructionInfo(l,u,a,n);d.set_m_friction(h),d.set_m_restitution(m),this.body=new Ammo.btRigidBody(d),this.body.setCollisionFlags(c)}setData(t){this.tmpData=t.heightData,this.nDataBytes=this.tmpData.length*this.tmpData.BYTES_PER_ELEMENT,this.needsUpdate=!0}update(){this.needsUpdate&&(this.malloc(),this.needsUpdate=!1,this.tmpData=null)}malloc(){null===this.data&&(this.data=Ammo._malloc(this.nDataBytes));let t=this.tmpData.length,e=0,s=0;for(;t--;)Ammo.HEAPF32[this.data+s>>2]=this.tmpData[e],e++,s+=4}release(){i.world.removeCollisionObject(this.body),Ammo.destroy(this.body),this.body=null,this.data=null,this.tmpData=null,this.dataHeap=null}set(t){t.heightData&&(this.setData(t),this.update())}}class A extends c{constructor(){super(),this.type="character"}}let v;self.onmessage=function(t){$.message(t)};let w,_,x,S,k,T=!1,V=!1,M=!0,C=!1;const L="undefined"==typeof performance?Date:performance,R={tmp:0,n:0,dt:0,fps:0};let F,W,I,P,B,N,O,D=1/60,E=4,j=!0,q=2,z=0,G=0,U=!0,Q=null,H=null,Y=null,K=null,J=[],X=[],Z=[];class ${static test(){}static message(t){let e=t.data;e.Ar&&(w=e.Ar),e.flow&&(i.flow=e.flow),e.m&&$[e.m](e.o)}static post(t,e){k?self.postMessage(t,e):S({data:t})}static init(t={}){k=!0,C=t.isBuffer||!1,void 0!==t.fps&&(D=1/t.fps),void 0!==t.substep&&(E=t.substep),t.returnMessage&&(S=t.returnMessage,k=!1,C=!1),t.blob&&importScripts(t.blob),Ammo().then((t=>{self.Ammo=t,a.extends(),$.initItems(),$.post({m:"ready",o:{}})}))}static set(t={}){_=t.ArPos,x=t.ArMax,v.body.setFull(t.full),V=t.outsideStep||!1,T=t.isTimeout||!1,D=1/(t.fps||60),E=t.substep||1,j=void 0===t.fixe||t.fixe,q=t.broadphase||2,i.substep=E,M=void 0===t.soft||t.soft,Y=(new Ammo.btVector3).fromArray(t.gravity||[0,-9.8,0]),t.penetration&&(K=t.penetration),null===i.world&&$.start()}static start(){null===i.world&&(w=new Float32Array(x),$.initWorld()),U=!1,F=!1,G=0,W=0,V||(T?$.step():Q=setInterval($.step,1e3*D))}static initWorld(){switch(I=new Ammo.btSequentialImpulseConstraintSolver,P=M?new Ammo.btDefaultSoftBodySolver:null,B=M?new Ammo.btSoftBodyRigidBodyCollisionConfiguration:new Ammo.btDefaultCollisionConfiguration,N=new Ammo.btCollisionDispatcher(B),q){case 1:let t=1e3;O=new Ammo.btAxisSweep3(new Ammo.btVector3(-t,-t,-t),new Ammo.btVector3(t,t,t),4096);break;case 2:O=new Ammo.btDbvtBroadphase}(i.world=M?new Ammo.btSoftRigidDynamicsWorld(N,O,I,B,P):new Ammo.btDiscreteDynamicsWorld(N,O,I,B),i.world.setGravity(Y),M)&&i.world.getWorldInfo().set_m_gravity(Y);K&&i.world.getDispatchInfo().set_m_allowedCcdPenetration(K)}static dispatch(){for(X=i.flow.remove,J=i.flow.add,Z=i.flow.tmp;X.length>0;)this.remove(X.shift());for(;J.length>0;)this.add(J.shift());for(;Z.length>0;)this.change(Z.shift());i.flow={key:[],add:[],remove:[],tmp:[]}}static poststep(){if(!U&&(W=1,this.dispatch(),!V&&T)){let t=1e3*D-(L.now()-z);t<0?$.step():H=setTimeout($.step,t)}}static step(t){F&&$.endReset(),U||W>=2||(W=2,z=t||L.now(),i.delta=.001*(z-G),G=z,j?i.world.stepSimulation(D,E,D/E):i.world.stepSimulation(i.delta,E,D/E),$.stepItems(),z-1e3>R.tmp&&(R.tmp=z,i.reflow.stat.fps=R.n,R.n=0),R.n++,i.reflow.stat.delta=i.delta,C?$.post({m:"step",reflow:i.reflow,Ar:w},[w.buffer]):$.post({m:"step",reflow:i.reflow,Ar:w}))}static byName(t){return a.byName(t)}static reset(){F=!0}static endReset(){$.stop(),$.resetItems(),Ammo.destroy(i.world),Ammo.destroy(I),M&&Ammo.destroy(P),Ammo.destroy(B),Ammo.destroy(N),Ammo.destroy(O),i.world=null,a.clear(),$.post({m:"resetCallback",o:{}})}static stop(){U=!0,V||(H&&clearTimeout(H),Q&&clearInterval(Q),Q=null,H=null)}static pause(t){let e=t.value;e!==U&&(e?this.stop():this.start())}static initItems(){v={ray:new h,body:new c,solid:new tt,joint:new u,contact:new d,character:new A,vehicle:new f,terrain:new g},i.bodyRef=v.body,i.byName=$.byName}static resetItems(){for(const t in v)v[t].reset()}static stepItems(){for(const t in v)v[t].step(w,_[t])}static add(t={}){let e=function(t){switch(t.type){case"plane":case"box":case"sphere":case"highSphere":case"cylinder":case"cone":case"capsule":case"mesh":case"convex":case"compound":case"null":return t.density||t.kinematic?"body":"solid";default:return t.type}}(t);v[e].add(t)}static remove(t={}){let e=this.byName(t.name);null!==e&&v[e.type].clear(e)}static change(t={}){let e=this.byName(t.name);null!==e&&v[e.type].set(t,e)}}class tt extends c{constructor(){super(),this.type="solid"}step(t,e){}}t.engine=$,Object.defineProperty(t,"__esModule",{value:!0})}));
