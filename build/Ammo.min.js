!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).AMMO={})}(this,(function(t){"use strict";var e=function(t){var e,i=Object.prototype,r=i.hasOwnProperty,s="function"==typeof Symbol?Symbol:{},o=s.iterator||"@@iterator",a=s.asyncIterator||"@@asyncIterator",n=s.toStringTag||"@@toStringTag";function l(t,e,i){return Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{l({},"")}catch(t){l=function(t,e,i){return t[e]=i}}function h(t,e,i,r){var s=e&&e.prototype instanceof f?e:f,o=Object.create(s.prototype),a=new V(r||[]);return o._invoke=function(t,e,i){var r=c;return function(s,o){if(r===d)throw new Error("Generator is already running");if(r===p){if("throw"===s)throw o;return R()}for(i.method=s,i.arg=o;;){var a=i.delegate;if(a){var n=k(a,i);if(n){if(n===y)continue;return n}}if("next"===i.method)i.sent=i._sent=i.arg;else if("throw"===i.method){if(r===c)throw r=p,i.arg;i.dispatchException(i.arg)}else"return"===i.method&&i.abrupt("return",i.arg);r=d;var l=m(t,e,i);if("normal"===l.type){if(r=i.done?p:u,l.arg===y)continue;return{value:l.arg,done:i.done}}"throw"===l.type&&(r=p,i.method="throw",i.arg=l.arg)}}}(t,i,a),o}function m(t,e,i){try{return{type:"normal",arg:t.call(e,i)}}catch(t){return{type:"throw",arg:t}}}t.wrap=h;var c="suspendedStart",u="suspendedYield",d="executing",p="completed",y={};function f(){}function g(){}function b(){}var A={};A[o]=function(){return this};var v=Object.getPrototypeOf,w=v&&v(v(L([])));w&&w!==i&&r.call(w,o)&&(A=w);var _=b.prototype=f.prototype=Object.create(A);function S(t){["next","throw","return"].forEach((function(e){l(t,e,(function(t){return this._invoke(e,t)}))}))}function x(t,e){function i(s,o,a,n){var l=m(t[s],t,o);if("throw"!==l.type){var h=l.arg,c=h.value;return c&&"object"==typeof c&&r.call(c,"__await")?e.resolve(c.__await).then((function(t){i("next",t,a,n)}),(function(t){i("throw",t,a,n)})):e.resolve(c).then((function(t){h.value=t,a(h)}),(function(t){return i("throw",t,a,n)}))}n(l.arg)}var s;this._invoke=function(t,r){function o(){return new e((function(e,s){i(t,r,e,s)}))}return s=s?s.then(o,o):o()}}function k(t,i){var r=t.iterator[i.method];if(r===e){if(i.delegate=null,"throw"===i.method){if(t.iterator.return&&(i.method="return",i.arg=e,k(t,i),"throw"===i.method))return y;i.method="throw",i.arg=new TypeError("The iterator does not provide a 'throw' method")}return y}var s=m(r,t.iterator,i.arg);if("throw"===s.type)return i.method="throw",i.arg=s.arg,i.delegate=null,y;var o=s.arg;return o?o.done?(i[t.resultName]=o.value,i.next=t.nextLoc,"return"!==i.method&&(i.method="next",i.arg=e),i.delegate=null,y):o:(i.method="throw",i.arg=new TypeError("iterator result is not an object"),i.delegate=null,y)}function T(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function M(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function V(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(T,this),this.reset(!0)}function L(t){if(t){var i=t[o];if(i)return i.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var s=-1,a=function i(){for(;++s<t.length;)if(r.call(t,s))return i.value=t[s],i.done=!1,i;return i.value=e,i.done=!0,i};return a.next=a}}return{next:R}}function R(){return{value:e,done:!0}}return g.prototype=_.constructor=b,b.constructor=g,g.displayName=l(b,n,"GeneratorFunction"),t.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===g||"GeneratorFunction"===(e.displayName||e.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,b):(t.__proto__=b,l(t,n,"GeneratorFunction")),t.prototype=Object.create(_),t},t.awrap=function(t){return{__await:t}},S(x.prototype),x.prototype[a]=function(){return this},t.AsyncIterator=x,t.async=function(e,i,r,s,o){void 0===o&&(o=Promise);var a=new x(h(e,i,r,s),o);return t.isGeneratorFunction(i)?a:a.next().then((function(t){return t.done?t.value:a.next()}))},S(_),l(_,n,"Generator"),_[o]=function(){return this},_.toString=function(){return"[object Generator]"},t.keys=function(t){var e=[];for(var i in t)e.push(i);return e.reverse(),function i(){for(;e.length;){var r=e.pop();if(r in t)return i.value=r,i.done=!1,i}return i.done=!0,i}},t.values=L,V.prototype={constructor:V,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(M),!t)for(var i in this)"t"===i.charAt(0)&&r.call(this,i)&&!isNaN(+i.slice(1))&&(this[i]=e)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var i=this;function s(r,s){return n.type="throw",n.arg=t,i.next=r,s&&(i.method="next",i.arg=e),!!s}for(var o=this.tryEntries.length-1;o>=0;--o){var a=this.tryEntries[o],n=a.completion;if("root"===a.tryLoc)return s("end");if(a.tryLoc<=this.prev){var l=r.call(a,"catchLoc"),h=r.call(a,"finallyLoc");if(l&&h){if(this.prev<a.catchLoc)return s(a.catchLoc,!0);if(this.prev<a.finallyLoc)return s(a.finallyLoc)}else if(l){if(this.prev<a.catchLoc)return s(a.catchLoc,!0)}else{if(!h)throw new Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return s(a.finallyLoc)}}}},abrupt:function(t,e){for(var i=this.tryEntries.length-1;i>=0;--i){var s=this.tryEntries[i];if(s.tryLoc<=this.prev&&r.call(s,"finallyLoc")&&this.prev<s.finallyLoc){var o=s;break}}o&&("break"===t||"continue"===t)&&o.tryLoc<=e&&e<=o.finallyLoc&&(o=null);var a=o?o.completion:{};return a.type=t,a.arg=e,o?(this.method="next",this.next=o.finallyLoc,y):this.complete(a)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),y},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var i=this.tryEntries[e];if(i.finallyLoc===t)return this.complete(i.completion,i.afterLoc),M(i),y}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var i=this.tryEntries[e];if(i.tryLoc===t){var r=i.completion;if("throw"===r.type){var s=r.arg;M(i)}return s}}throw new Error("illegal catch attempt")},delegateYield:function(t,i,r){return this.delegate={iterator:L(t),resultName:i,nextLoc:r},"next"===this.method&&(this.arg=e),y}},t}("object"==typeof module?module.exports:{});try{regeneratorRuntime=e}catch(t){Function("r","regeneratorRuntime = r")(e)}const i=new Map,r={world:null,gravity:null,bodyRef:null,byName:null,delta:0,substep:1,numBreak:0,key:[],reflow:{ray:[],point:{},stat:{fps:0,delta:0}}},s={clear:()=>{i.clear()},byName:t=>i.has(t)?i.get(t):null,add:t=>{if("ray"!==t.type&&"contact"!==t.type)switch(t.type){case"joint":r.world.addConstraint(t,!t.collision);break;case"solid":r.world.addCollisionObject(t,t.group,t.mask);break;case"terrain":r.world.addCollisionObject(t.body,t.group,t.mask);break;case"body":r.world.addRigidBody(t,t.group,t.mask)}i.set(t.name,t)},remove:t=>{if("ray"!==t.type&&"contact"!==t.type)switch(t.type){case"joint":r.world.removeConstraint(t),Ammo.destroy(t.formA),Ammo.destroy(t.formB),Ammo.destroy(t);break;case"solid":r.world.removeCollisionObject(t),Ammo.destroy(t);break;case"body":r.world.removeRigidBody(t),Ammo.destroy(t);break;case"vehicle":case"terrain":t.release()}i.delete(t.name)},getVolume:(t,e,i)=>{let r=1;switch(t){case"sphere":r=4*Math.PI*e[0]*e[0]*e[0]/3;break;case"cone":r=Math.PI*e[0]*(.5*e[1])*2;break;case"box":r=.5*e[0]*8*(.5*e[1])*(.5*e[2]);break;case"cylinder":r=Math.PI*e[0]*e[0]*(.5*e[1])*2;break;case"capsule":r=4*Math.PI*e[0]*e[0]*e[0]/3+Math.PI*e[0]*e[0]*(.5*e[1])*2;break;case"convex":case"mesh":r=s.getConvexVolume(i)}return r},getConvexVolume:t=>{let e,i=t.length/3,r=[t[0],t[1],t[2]],s=[t[0],t[1],t[2]];for(;i--;)e=3*i,t[e]<r[0]?r[0]=t[e]:t[e]>s[0]&&(s[0]=t[e]),t[e+1]<r[1]?r[1]=t[e+1]:t[e+1]>s[1]&&(s[1]=t[e+1]),t[e+2]<r[2]?r[2]=t[e+2]:t[e+2]>s[2]&&(s[2]=t[e+2]);return(s[0]-r[0])*(s[1]-r[1])*(s[2]-r[2])},malloc:(t,e)=>{var i=t.length*t.BYTES_PER_ELEMENT;return void 0===e&&(e=Ammo._malloc(i)),new Uint8Array(Ammo.HEAPU8.buffer,e,i).set(new Uint8Array(t.buffer)),e},free:t=>{t&&Ammo._free(t)},stats:()=>{},extends:()=>{Ammo.btVector3.prototype.set=function(t,e,i){return this.setValue(t,e,i),this},Ammo.btVector3.prototype.toArray=function(t,e){let i=void 0!==t;if(i||(t=[]),t[e=e||0]=this.x(),t[e+1]=this.y(),t[e+2]=this.z(),!i)return t},Ammo.btVector3.prototype.fromArray=function(t,e){return e=e||0,this.setValue(t[e],t[e+1],t[e+2]),this},Ammo.btVector3.prototype.copy=function(t){return this.setValue(t.x(),t.y(),t.z()),this},Ammo.btVector3.prototype.sub=function(t){return this.setValue(this.x()-t.x(),this.y()-t.y(),this.z()-t.z()),this},Ammo.btVector3.prototype.mul=function(){return this.x()*this.y()*this.z()},Ammo.btVector3.prototype.multiplyArray=function(t){return this.setValue(this.x()*t[0],this.y()*t[1],this.z()*t[2]),this},Ammo.btVector3.prototype.multiplyScalar=function(t){return this.setValue(this.x()*t,this.y()*t,this.z()*t),this},Ammo.btVector3.prototype.divideScalar=function(t){return this.multiplyScalar(1/t)},Ammo.btVector3.prototype.applyQuaternion=function(t){const e=this.x(),i=this.y(),r=this.z(),s=t.x(),o=t.y(),a=t.z(),n=t.w(),l=n*e+o*r-a*i,h=n*i+a*e-s*r,m=n*r+s*i-o*e,c=-s*e-o*i-a*r;return this.setValue(l*n+c*-s+h*-a-m*-o,h*n+c*-o+m*-s-l*-a,m*n+c*-a+l*-o-h*-s),this},Ammo.btVector3.prototype.applyMatrix3=function(t){const e=this.x(),i=this.y(),r=this.z(),s=[];return t.getRow(0).toArray(s,0),t.getRow(1).toArray(s,3),t.getRow(2).toArray(s,6),this.setValue(s[0]*e+s[3]*i+s[6]*r,s[1]*e+s[4]*i+s[7]*r,s[2]*e+s[5]*i+s[8]*r),this},Ammo.btVector3.prototype.free=function(){},Ammo.btQuaternion.prototype.set=function(t,e,i,r){return this.setValue(t,e,i,r),this},Ammo.btQuaternion.prototype.toArray=function(t,e){let i=void 0!==t;if(i||(t=[]),t[e=e||0]=this.x(),t[e+1]=this.y(),t[e+2]=this.z(),t[e+3]=this.w(),!i)return t},Ammo.btQuaternion.prototype.fromArray=function(t,e){return e=e||0,this.setValue(t[e],t[e+1],t[e+2],t[e+3]),this},Ammo.btQuaternion.prototype.multiply=function(t){return this.multiplyQuaternions(this,t)},Ammo.btQuaternion.prototype.premultiply=function(t){return this.multiplyQuaternions(t,this)},Ammo.btQuaternion.prototype.multiplyQuaternions=function(t,e){const i=t.x(),r=t.y(),s=t.z(),o=t.w(),a=e.x(),n=e.y(),l=e.z(),h=e.w();return this.setValue(i*h+o*a+r*l-s*n,r*h+o*n+s*a-i*l,s*h+o*l+i*n-r*a,o*h-i*a-r*n-s*l),this},Ammo.btQuaternion.prototype.fromAxisAngle=function(t,e){var i=.5*e,r=Math.sin(i);return this.setValue(t[0]*r,t[1]*r,t[2]*r,Math.cos(i)),this},Ammo.btQuaternion.prototype.fromAxis=function(t){let e=t.toArray();if(e[2]>.99999)this.setValue(0,0,0,1);else if(e[2]<-.99999)this.setValue(1,0,0,0);else{let t=[e[1],e[0],0],i=Math.acos(e[2]);this.fromAxisAngle(t,i)}return this},Ammo.btQuaternion.prototype.free=function(){},Ammo.btTransform.prototype.set=function(t,e){return this.setOrigin(t),this.setRotation(e),this},Ammo.btTransform.prototype.identity=function(){return this.setIdentity(),this},Ammo.btTransform.prototype.fromArray=function(t,e,i,r){let s=this.getOrigin();s.fromArray(t||[0,0,0],i||0),this.setOrigin(s);let o=this.getRotation();return o.fromArray(e||[0,0,0,1],r||0),this.setRotation(o),this},Ammo.btTransform.prototype.toArray=function(t,e){e=e||0,this.getOrigin().toArray(t,e),this.getRotation().toArray(t,e+3)},Ammo.btTransform.prototype.getPos=function(){return this.getOrigin().toArray()},Ammo.btTransform.prototype.getQuat=function(){return this.getRotation().toArray()},Ammo.btTransform.prototype.copy=function(t){return this.setOrigin(t.getOrigin()),this.setRotation(t.getRotation()),this},Ammo.btTransform.prototype.rotationFromAxis=function(t){let e=this.getRotation();return e.fromAxis(t),this.setRotation(e),this},Ammo.btTransform.prototype.free=function(){}}},o=2e3,a=100,n=50,l=100,h=50,m=50,c=20,u={bodyFull:14,body:8,joint:16,contact:8,ray:11,character:16,vehicle:72,solver:128},d=Math.PI/180,p={toFixed:(t,e=3)=>1*t.toFixed(e),clamp:(t,e,i)=>t=(t=t<e?e:t)>i?i:t,equalArray:(t,e)=>{let i=t.length;for(;i--;)if(t[i]!==e[i])return!1;return!0},composeMatrixArray:(t,e,i=[1,1,1])=>{const r=e[0],s=e[1],o=e[2],a=e[3],n=r+r,l=s+s,h=o+o,m=r*n,c=r*l,u=r*h,d=s*l,p=s*h,y=o*h,f=a*n,g=a*l,b=a*h,A=i[0],v=i[1],w=i[2];return[(1-(d+y))*A,(c+b)*A,(u-g)*A,0,(c-b)*v,(1-(m+y))*v,(p+f)*v,0,(u+g)*w,(p-f)*w,(1-(m+d))*w,0,t[0],t[1],t[2],1]},applyTransformArray:(t,e,i,r=[1,1,1])=>{const s=p.composeMatrixArray(e,i,r),o=t[0],a=t[1],n=t[2],l=1/(s[3]*o+s[7]*a+s[11]*n+s[15]);return[(s[0]*o+s[4]*a+s[8]*n+s[12])*l,(s[1]*o+s[5]*a+s[9]*n+s[13])*l,(s[2]*o+s[6]*a+s[10]*n+s[14])*l]},equalArray:(t,e)=>{let i=t.length;for(;i--;)if(t[i]!==e[i])return!1;return!0},lerpArray:(t,e,i)=>{if(0===i)return t;if(1===i)return e;let r=t.length,s=[];for(;r--;)s[r]=t[r],s[r]+=(e[r]-s[r])*i;return s},slerpQuatArray:(t,e,i)=>{if(0===i)return t;if(1===i)return e;let r=[...t];const s=t[0],o=t[1],a=t[2],n=t[3],l=e[0],h=e[1],m=e[2],c=e[3];let u=n*c+s*l+o*h+a*m;if(u<0?(r=[-l,-h,-m,-c],u=-u):r=[...e],u>=1)return t;const d=1-u*u;if(d<=1e-5){const t=1-i;return r[3]=t*n+i*r[3],r[0]=t*s+i*r[0],r[1]=t*o+i*r[1],r[2]=t*a+i*r[2],p.quatNomalize(r)}const y=Math.sqrt(d),f=Math.atan2(y,u),g=Math.sin((1-i)*f)/y,b=Math.sin(i*f)/y;return r[3]=n*g+r[3]*b,r[0]=s*g+r[0]*b,r[1]=o*g+r[1]*b,r[2]=a*g+r[2]*b,r},lengthArray:t=>{let e=t.length,i=0;for(;e--;)i+=t[e]*t[e];return Math.sqrt(i)},quatNomalize:t=>{let e=p.lengthArray(t);return 0===e?[0,0,0,1]:(e=1/e,p.mulArray(t,e))},quatInvert:t=>[-t[0],-t[1],-t[2],t[3]],quatMultiply:(t,e)=>{const i=t[0],r=t[1],s=t[2],o=t[3],a=e[0],n=e[1],l=e[2],h=e[3];return[i*h+o*a+r*l-s*n,r*h+o*n+s*a-i*l,s*h+o*l+i*n-r*a,o*h-i*a-r*n-s*l]},quatToAxis:t=>{let e=2*Math.acos(t[3]);const i=Math.sqrt(1-t[3]*t[3]);return i<1e-4?[1,0,0]:[t[0]/i,t[1]/i,t[2]/i,e]},eulerFromMatrix:t=>{const e=t[0],i=t[4],r=t[8];t[1];const s=t[5],o=t[9];t[2];const a=t[6],n=t[10];let l=[0,0,0];return l[1]=Math.asin(p.clamp(r,-1,1)),Math.abs(r)<.9999999?(l[0]=Math.atan2(-o,n),l[2]=Math.atan2(-i,e)):(l[0]=Math.atan2(a,s),l[2]=0),l},angleTo:(t,e)=>2*Math.acos(Math.abs(p.clamp(p.dotArray(t,e),-1,1))),dotArray:(t,e)=>{let i=t.length,r=0;for(;i--;)r+=t[i]*e[i];return r},addArray:(t,e)=>{let i=t.length,r=[];for(;i--;)r[i]=t[i]+e[i];return r},subArray:(t,e)=>{let i=t.length,r=[];for(;i--;)r[i]=t[i]-e[i];return r},mulArray:(t,e)=>{let i=t.length;for(;i--;)t[i]*=e;return t},distanceArray:(t,e)=>p.lengthArray(p.subArray(t,e))};class y{constructor(){this.id=0,this.list=[],this.type="item",this.Utils=null}reset(){let t=this.list.length;for(;t--;)this.dispose(this.list[t]);this.id=0,this.list=[]}byName(t){return this.Utils.byName(t)}setName(t={}){let e=void 0!==t.name?t.name:this.type+this.id++;return t.id=this.remove(e,!0),t.name=e,e}addToWorld(t,e=-1){this.Utils.add(t),-1!==e?this.list[e]=t:this.list.push(t)}remove(t,e){let i=this.byName(t);return i?this.clear(i,e):-1}clear(t,e){let i=this.list.indexOf(t);return-1===i||e?this.list[i]=null:this.list.splice(i,1),this.dispose(t),i}dispose(t){null!==t&&this.Utils.remove(t)}vecZero(t,e,i){for(;i--;)t[e+i]=0}fillArray(t,e,i,r){for(i=i||0,r=r??t.length;r--;)e[i+r]=t[r]}arLength(t){let e=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]);return e<.001&&(e=0),e}multiplyScalar(t,e,i){for(i=i??t.length;i--;)t[i]*=e}divideScalar(t,e,i){this.multiplyScalar(t,1/e,i)}add(t={}){}set(t={}){}step(t,e){}}class f extends y{constructor(){super(),this.Utils=s,this.type="ray",this.callback=new Ammo.ClosestRayResultCallback,this.t=new Ammo.btTransform}step(t,e){r.reflow.ray=[];let i,s,o,a,n,l=this.list.length,h=this.callback;for(;l--;)s=e+l*u.ray,i=this.list[l],t[s]=0,h.set_m_collisionObject(null),a=i.getPoint(this.t),h.get_m_rayFromWorld().fromArray(a[0]),h.get_m_rayToWorld().fromArray(a[1]),h.set_m_collisionFilterGroup(i.group),h.set_m_collisionFilterMask(i.mask),h.set_m_closestHitFraction(i.precision),r.world.rayTest(h.get_m_rayFromWorld(),h.get_m_rayToWorld(),h),h.hasHit()&&(t[s]=1,n=h.get_m_hitPointWorld().toArray(),t[s+1]=p.distanceArray(a[0],n),t[s+2]=a[0][0],t[s+3]=a[0][1],t[s+4]=a[0][2],t[s+5]=n[0],t[s+6]=n[1],t[s+7]=n[2],h.get_m_hitNormalWorld().toArray(t,s+8),o=Ammo.castObject(h.get_m_collisionObject(),Ammo.btRigidBody).name,void 0===o&&(o=Ammo.castObject(ray.get_m_collisionObject(),Ammo.btSoftBody).name),r.reflow.ray[l]=o)}add(t={}){this.setName(t);let e=new g(t);this.addToWorld(e,t.id)}set(t={},e=null){null===e&&(e=this.byName(t.name)),null!==e&&(t.begin&&(e.begin=t.begin),t.end&&(e.end=t.end))}}class g{constructor(t={}){this.type="ray",this.name=t.name,this.parent=t.parent||"",this.begin=t.begin||[0,0,0],this.end=t.end||[0,0,1],this.precision=t.precision||1,this.group=void 0!==t.group||1,this.mask=void 0!==t.mask||-1}getPoint(t){if(this.parent){const e=s.byName(this.parent);if(e){e.getMotionState().getWorldTransform(t);const i=t.getOrigin().toArray(),r=t.getRotation().toArray();return[p.applyTransformArray(this.begin,i,r),p.applyTransformArray(this.end,i,r)]}}return[this.begin,this.end]}}class b extends y{constructor(){super(),this.Utils=s,this.type="body",this.num=u[this.type],this.full=!1,this.v=new Ammo.btVector3,this.vv=new Ammo.btVector3,this.q=new Ammo.btQuaternion,this.t=new Ammo.btTransform,this.v1=new Ammo.btVector3,this.v2=new Ammo.btVector3,this.v3=new Ammo.btVector3}setFull(t){this.num=u[t?"bodyFull":"body"],this.full=t}step(t,e){let i,r,s,o,a=this.list.length;for(;a--;)i=this.list[a],r=e+a*this.num,i?(t[r]=2===i.getActivationState()?0:1,i.getMotionState().getWorldTransform(this.t),this.t.toArray(t,r+1),this.full&&(s=i.getLinearVelocity(),s.toArray(t,r+8),1===t[r]&&(t[r]=9.8*s.length()),o=i.getAngularVelocity(),o.toArray(t,r+11))):this.vecZero(t,r,this.num)}shape(t={}){let e,i,r,o=t.type||"box",a=t.size||[1,1,1];switch(o){case"plane":e=new Ammo.btStaticPlaneShape(this.v.fromArray(t.dir||[0,1,0]),.001),e.setLocalScaling(this.v.fromArray([1,1,1]));break;case"box":e=new Ammo.btBoxShape(this.v.set(.5*a[0],.5*a[1],.5*a[2]));break;case"sphere":e=new Ammo.btSphereShape(a[0]);break;case"cone":e=new Ammo.btConeShape(a[0],a[1]);break;case"cylinder":e=new Ammo.btCylinderShape(this.v.set(a[0],.5*a[1],a[0]));break;case"capsule":e=new Ammo.btCapsuleShape(a[0],a[1]);break;case"convex":for(e=new Ammo.btConvexHullShape,i=Math.floor(t.v.length/3);i--;)r=3*i,e.addPoint(this.v.fromArray(t.v,r),!1);e.optimizeConvexHull(),e.recalcLocalAabb();break;case"mesh":let s=new Ammo.btTriangleMesh,o=!1,n=t.v,l=t.index||null,h=n.length;if(null!==l){for(h=n.length,i=0;i<h;i+=3)s.findOrAddVertex(this.v.set(n[i],n[i+1],n[i+2]),!1);for(h=l.length,i=0;i<h;i+=3)s.addTriangleIndices&&s.addTriangleIndices(l[i],l[i+1],l[i+2])}else for(i=0;i<h;i+=9)s.addTriangle(this.v1.set(n[i+0],n[i+1],n[i+2]),this.v2.set(n[i+3],n[i+4],n[i+5]),this.v3.set(n[i+6],n[i+7],n[i+8]),o);"solid"!==this.type&&Ammo.btGImpactMeshShape?(e=new Ammo.btGImpactMeshShape(s),e.setMargin(t.margin||.01)):e=new Ammo.btBvhTriangleMeshShape(s,!0,!0)}return e.setMargin&&e.setMargin(t.margin||1e-4),e.volume=s.getVolume(o,a,t.v),e}add(t={}){let e=this.setName(t),i=void 0!==t.flag?t.flag:"solid"===this.type?1:0,s=void 0!==t.group?t.group:"solid"===this.type?2:1,o=void 0!==t.mask?t.mask:-1;t.kinematic&&(i=2,s=4);let a=null;switch(t.type){case"null":o=0,a=this.shape({type:"sphere",size:[.01]});break;case"compound":let e,i;a=new Ammo.btCompoundShape,a.volume=0;for(var n=0;n<t.shapes.length;n++)e=t.shapes[n],this.t.fromArray(e.pos,e.quat),i=this.shape(e),a.volume+=i.volume,a.addChildShape(this.t,i);break;default:a=this.shape(t)}this.t.fromArray(t.pos,t.quat),this.v.set(0,0,0);let l=(t.density||0)*a.volume;0!==l&&a.calculateLocalInertia(l,this.v);let h=new Ammo.btDefaultMotionState(this.t),m=new Ammo.btRigidBodyConstructionInfo(l,h,a,this.v),c=new Ammo.btRigidBody(m);c.setCollisionFlags(i),Ammo.destroy(m),c.mass=l,c.g=a,c.name=e,c.type=this.type,c.isKinematic=t.kinematic||!1,c.isGhost=!1,c.breakable=t.breakable||!1,c.breakable&&r.numBreak++,c.group=s,c.mask=o,c.first=!0,delete t.pos,delete t.quat,t.kinematic&&(t.neverSleep=!0,delete t.kinematic),this.set(t,c),this.addToWorld(c,t.id)}set(t={},e=null){null===e&&(e=this.byName(t.name)),null!==e&&(void 0!==t.kinematic&&(e.setCollisionFlags(t.kinematic?2:0),e.isKinematic=t.kinematic,e.isKinematic||e.setGravity(r.gravity)),void 0!==t.flag&&(e.setCollisionFlags(t.flag),e.isKinematic=2===t.flag),t.noGravity&&e.setGravity(this.v.fromArray([0,0,0])),(t.pos||t.quat)&&(t.pos&&t.quat||e.getMotionState().getWorldTransform(this.t),t.pos||(t.pos=this.t.getPos()),t.quat||(t.quat=this.t.getQuat()),this.t.fromArray(t.pos,t.quat),e.isKinematic?e.getMotionState().setWorldTransform(this.t):e.setWorldTransform(this.t)),void 0!==t.state&&e.setActivationState(t.state),(t.activate||t.wake)&&e.activate(),void 0!==t.neverSleep&&(t.neverSleep?(e.setSleepingThresholds(0,0),e.activate()):e.setSleepingThresholds(.8,1)),t.sleep&&e.setActivationState(2),void 0!==t.friction&&e.setFriction(t.friction),void 0!==t.restitution&&e.setRestitution(t.restitution),void 0!==t.rollingFriction&&e.setRollingFriction(t.rollingFriction),t.reset&&(e.setLinearVelocity(this.v.set(0,0,0)),e.setAngularVelocity(this.v.set(0,0,0))),e.isGhost||(void 0!==t.group&&(e.getBroadphaseProxy().set_m_collisionFilterGroup(t.group),e.group=t.group),void 0!==t.mask&&(e.getBroadphaseProxy().set_m_collisionFilterMask(t.mask),e.mask=t.mask),void 0!==t.damping&&e.setDamping(t.damping[0],t.damping[1]),void 0!==t.sleeping&&e.setSleepingThresholds(t.sleeping[0],t.sleeping[1])),"body"===e.type&&(void 0!==t.linearVelocity&&e.setLinearVelocity(this.v.fromArray(t.linearVelocity)),void 0!==t.angularVelocity&&e.setAngularVelocity(this.v.fromArray(t.angularVelocity))),void 0!==t.linearFactor&&e.setLinearFactor(this.v.fromArray(t.linearFactor)),void 0!==t.angularFactor&&e.setAngularFactor(this.v.fromArray(t.angularFactor)),void 0!==t.anisotropic&&e.setAnisotropicFriction(t.anisotropic[0],t.anisotropic[1]),void 0!==t.massProps&&e.setMassProps(t.massProps[0],t.massProps[1]),void 0!==t.ccdThreshold&&e.setCcdMotionThreshold(t.ccdThreshold),void 0!==t.ccdRadius&&e.setCcdSweptSphereRadius(t.ccdRadius),void 0!==t.gravity&&e.setGravity(this.v.fromArray(t.gravity)),t.worldForce&&e.applyForce(this.v.fromArray(t.worldForce),this.v.fromArray(t.worldForce,3)),t.force&&e.applyForce(this.v.fromArray(t.force).divideScalar(r.substep)),t.torque&&e.applyTorque(this.v.fromArray(t.torque).divideScalar(r.substep)),t.linearImpulse&&(t.impulseCentral=t.linearImpulse,this.multiplyScalar(t.impulseCentral,r.delta,3)),t.impulseCentral&&e.applyCentralImpulse(this.v.fromArray(t.impulseCentral)),t.impulse&&e.applyImpulse(this.v.fromArray(t.impulse),this.v.fromArray(t.impulse,3)))}}class A extends y{constructor(){super(),this.Utils=s,this.type="joint",this.t=new Ammo.btTransform,this.t1=new Ammo.btTransform,this.t2=new Ammo.btTransform,this.v1=new Ammo.btVector3,this.v2=new Ammo.btVector3,this.p1=new Ammo.btVector3,this.p2=new Ammo.btVector3,this.q1=new Ammo.btQuaternion,this.q2=new Ammo.btQuaternion}step(t,e){if(16!==u.joint)return;let i,r,s=this.list.length;for(;s--;)i=this.list[s],r=e+s*u.joint,i.visible&&(this.t.copy(i.B1.getWorldTransform()).op_mul(i.formA).toArray(t,r),this.t.copy(i.B2.getWorldTransform()).op_mul(i.formB).toArray(t,r+7))}add(t={}){this.v;let e=this.setName(t),i=this.byName(t.b1),r=this.byName(t.b2);i&&"vehicle"===i.type&&(i=i.body),r&&"vehicle"===r.type&&(r=r.body);let s=this.v1.fromArray(t.pos1||[0,0,0]),o=this.v2.fromArray(t.pos2||[0,0,0]),a=this.q1.fromArray(t.quat1||[0,0,0,1]),n=this.q2.fromArray(t.quat2||[0,0,0,1]),l=this.p1.fromArray(t.axis1||[0,0,1]),h=this.p2.fromArray(t.axis2||[0,0,1]);t.quat1||a.fromAxis(l),t.quat2||n.fromAxis(h);const m=t.useA||!0,c=(new Ammo.btTransform).set(s,a),u=(new Ammo.btTransform).set(o,n);let d,p=t.mode||"revolute";switch("d6"!==p&&"universal"!==p&&"generic"!==p||(p="dof"),"slider"!==p&&"cylindrical"!==p||(p="prismatic"),"joint_p2p"===p&&(p="spherical"),"conetwist"===p&&(p="ragdoll"),p){case"spherical":d=new Ammo.btPoint2PointConstraint(i,r,s,o),t.strength&&d.get_m_setting().set_m_tau(t.strength),t.damping&&d.get_m_setting().set_m_damping(t.damping),t.impulse&&d.get_m_setting().set_m_impulseClamp(t.impulse);break;case"hinge2":d=new Ammo.btHinge2Constraint(i,r,s,l,h),d.setAxis(this.v1.fromArray([0,0,1]));break;case"hinge":case"revolute":d=new Ammo.btHingeConstraint(i,r,c,u,m),d.setAxis(l);break;case"prismatic":d=new Ammo.btSliderConstraint(i,r,c,u,m),console.log(d);break;case"ragdoll":d=new Ammo.btConeTwistConstraint(i,r,c,u);break;case"dof":d=new Ammo.btGeneric6DofSpringConstraint(i,r,c,u,m);break;case"fixe":d=new Ammo.btFixedConstraint(i,r,c,u);break;case"gear":d=new Ammo.btGearConstraint(i,r,l,h,t.ratio||1)}d.name=e,d.mode=p,d.type=this.type,d.B1=i,d.B2=r,d.formA=c,d.formB=u,d.visible=!1,d.collision=t.collision||!1,this.set(t,d),this.addToWorld(d,t.id)}set(t={},e=null){if(null===e&&(e=this.byName(t.name)),null===e)return;let i,r,s,o;void 0!==t.visible&&(e.visible=t.visible),t.breaking&&e.setBreakingImpulseThreshold&&e.setBreakingImpulseThreshold(t.breaking),t.iteration&&e.setOverrideNumSolverIterations&&e.setOverrideNumSolverIterations(t.iteration);const a=["x","y","z","rx","ry","rz"];switch(e.mode){case"prismatic":t.lm&&(e.setLowerLinLimit(t.lm[0]),e.setUpperLinLimit(t.lm[1])),t.lmr&&(e.setLowerAngLimit(t.lmr[0]*d),e.setUpperAngLimit(t.lmr[1]*d)),t.motor&&(e.setTargetLinMotorVelocity(t.motor[0]),e.setMaxLinMotorForce(t.motor[1])),t.amotor&&(e.setTargetAngMotorVelocity(t.amotor[0]*d),e.setMaxAngMotorForce(t.amotor[1]));break;case"hinge":case"revolute":t.lm&&e.setLimit(t.lm[0]*d,t.lm[1]*d,t.lm[2]||.9,t.lm[3]||.3,t.lm[4]||1),t.motor&&e.enableAngularMotor(!0,t.motor[0]*d,t.motor[1]);break;case"dof":case"sdof":if(t.motor){i=t.motor.length;let o=!1;for(;i--;)r=t.motor[i],"rx"===r[0]?s=e.getRotationalLimitMotor(0):"ry"===r[0]?s=e.getRotationalLimitMotor(1):"rz"===r[0]?s=e.getRotationalLimitMotor(2):(s=getTranslationalLimitMotor(),o=!0),s&&(o||(s.set_m_enableMotor(!0),s.set_m_targetVelocity(-r[1]*d),s.set_m_maxMotorForce(r[2])))}if(t.lm){for(s=[[0,0,0],[0,0,0],[0,0,0],[0,0,0]],i=t.lm.length;i--;)r=t.lm[i],"rx"===r[0]&&(s[0][0]=-r[2]*d,s[1][0]=-r[1]*d),"ry"===r[0]&&(s[0][1]=-r[2]*d,s[1][1]=-r[1]*d),"rz"===r[0]&&(s[0][2]=-r[2]*d,s[1][2]=-r[1]*d),"x"===r[0]&&(s[2][0]=r[1],s[3][0]=r[2]),"y"===r[0]&&(s[2][1]=r[1],s[3][1]=r[2]),"z"===r[0]&&(s[2][2]=r[1],s[3][2]=r[2]),r.length>3&&(o=a.indexOf(r[0]),e.enableSpring(o,0!==r[3]),e.setStiffness(o,1/r[3]||0),e.setDamping(o,1/r[4]||0));e.setAngularLowerLimit(this.v1.fromArray(s[0])),e.setAngularUpperLimit(this.v1.fromArray(s[1])),e.setLinearLowerLimit(this.v1.fromArray(s[2])),e.setLinearUpperLimit(this.v1.fromArray(s[3]))}}}}class v extends y{constructor(){super(),this.Utils=s,this.type="contact",this.cb=new Ammo.ConcreteContactResultCallback}step(t,e){let i,s,o,a=this.list.length;for(;a--;)o=0,i=this.list[a],s=e+a*u.contact,this.cb.addSingleResult=function(){o=1},null!==i.b2?r.world.contactPairTest(i.b1,i.b2,this.cb):r.world.contactTest(i.b1,this.cb),t[s]=o}add(t={}){this.setName(t),t.b1=this.byName(t.b1),t.b2=this.byName(t.b2);let e=new w(t);this.addToWorld(e,t.id)}}class w{constructor(t={}){this.type="contact",this.name=t.name,this.b1=t.b1||null,this.b2=t.b2||null,this.ignore=t.ignore||[],this.result={hit:!1,point:[0,0,0],normal:[0,0,0],distance:0}}update(){}}class _ extends y{constructor(){super(),this.type="vehicle",this.Utils=s,this.trans=new Ammo.btTransform}step(t,e){let i,r=this.list.length;for(;r--;)i=e+r*u.vehicle,this.list[r].step(t,i,this.trans)}add(t){this.setName(t);let e=new S(t);this.addToWorld(e,t.id)}set(t={},e=null){null===e&&(e=this.byName(t.name)),null!==e&&e.set(t)}}class S{constructor(t){this.type="vehicle",this.name=t.name,this.enable=!1,this.numWheel=t.numWheel||4,this.wheelsPosition=t.wheelsPosition,this.radius=t.radius,this.radiusBack=t.radiusBack,this.deep=t.deep,this.deepBack=t.deepBack,this.massCenter=t.massCenter||[0,.55,1.594],this.chassisPos=t.chassisPos||[0,.83,0],this.chassis=null,this.body=null,this.steering=0,this.breaking=0,this.motor=0,this.gearRatio=[-1,0,2.3,1.8,1.3,.9,.5],this.key=[0,0,0,0,0,0,0,0],this.limitAngular=[1,1,1],this.transforms=[],this.wheelBody=[],this.wheelJoint=[],this.wheelRadius=[],this.isRay=!0,this.tr=new Ammo.btTransform,this.tmpT=new Ammo.btTransform,this.tmpV=new Ammo.btVector3,this.data={mass:t.mass||2e3,incSteering:t.incSteering||2,maxSteering:t.maxSteering||24,wMass:1,wWidth:.25,engine:1e3,acceleration:10,breaking:100,pos:[0,0,0],quat:[0,0,0,1],masscenter:[0,-.6,0],friction:.6,restitution:.1,rolling:0,autoSuspension:!1,compValue:.2,dampValue:.3,s_stiffness:t.s_stiffness||20,s_damping:t.s_damping||4.4,s_compression:t.s_compression||2.3,s_travel:t.s_travel||.4,s_force:6e3,w_friction:10.5,w_roll:.001};let e=Math.round(this.data.mass/this.numWheel);t.s_compression||(this.data.s_compression=.6*this.data.s_damping),t.s_force||(this.data.s_force=25*e),this.init(t)}init(t){this.size=t.size||[1.7,1,5];const e=this.data;let i=new Ammo.btTransform,s=new Ammo.btVector3,o=new Ammo.btVector3,a=new Ammo.btVector3,n=new Ammo.btVector3;e.mass=void 0===t.mass?800:t.mass,e.pos=void 0===t.pos?[0,0,0]:t.pos,e.quat=void 0===t.quat?[0,0,0,1]:t.quat,this.chassisShape=t.chassisShape?r.bodyRef.shape(t.chassisShape):new Ammo.btBoxShape(s.set(.5*this.size[0],.5*this.size[1],.5*this.size[2])),s.fromArray(this.massCenter),i.setIdentity(),i.setOrigin(s);const l=new Ammo.btCompoundShape;l.addChildShape(i,this.chassisShape),this.startPose=(new Ammo.btTransform).fromArray(t.pos||[0,1,0],t.quat||[0,0,0,1]),s.setValue(0,0,0),l.calculateLocalInertia(e.mass,s);var h=new Ammo.btDefaultMotionState(this.startPose),m=new Ammo.btRigidBodyConstructionInfo(e.mass,h,l,s);this.body=new Ammo.btRigidBody(m),this.body.name=this.name,this.body.setActivationState(4),Ammo.destroy(m);const c=new Ammo.btVehicleTuning,u=new Ammo.btDefaultVehicleRaycaster(r.world);this.chassis=new Ammo.btRaycastVehicle(c,this.body,u),this.chassis.setCoordinateSystem(0,1,2);const d=this.numWheel;for(let l=0;l<d;l++){let u=l<2;if(o.fromArray(this.wheelsPosition[l]),a.setValue(0,-1,0),n.setValue(-1,0,0),this.isRay)this.chassis.addWheel(o,a,n,1,u?this.radius:this.radiusBack,c,u),this.chassis.setBrake(t.breaking||100,l);else{i.identity(),i.setOrigin(o),a.setValue(e.wWidth*r.invScale,radius,radius),shape=new Ammo.btCylinderShape(a),s.setValue(0,0,0),shape.calculateLocalInertia(e.wMass,s);h=new Ammo.btDefaultMotionState(i),m=new Ammo.btRigidBodyConstructionInfo(e.wMass,h,shape,s);var p=new Ammo.btRigidBody(m);p.setFriction(1),p.setActivationState(4),r.world.addRigidBody(p,1,-1),this.wheelBody[l]=p;var y=new Ammo.btHingeConstraint(this.body,p,o,s,a,n,!1);r.world.addConstraint(y,!1)}}this.setData(t),i.free(),s.free(),o.free(),a.free(),n.free(),r.world.addAction(this.chassis),r.world.addRigidBody(this.body)}step(t,e,i){this.drive(),t[e]=this.chassis.getCurrentSpeedKmHour(),this.body.getMotionState().getWorldTransform(i),i.toArray(t,e+1),i=i.inverse();for(var r,s,o=this.numWheel;o--;)this.chassis.updateWheelTransform(o,!0),(s=this.chassis.getWheelTransformWS(o)).mult(i,s),r=8*(o+1),s.toArray(t,e+r+1),0===o&&(t[e+r]=this.chassis.getWheelInfo(0).get_m_steering()),1===o&&(t[e+r]=this.chassis.getWheelInfo(1).get_m_steering()),2===o&&(t[e+r]=this.steering)}set(t){t.key&&(this.key=t.key),(t.pos||t.quat)&&(this.body.getMotionState().getWorldTransform(this.tr),t.pos&&this.tr.setOrigin(this.tr.getOrigin().fromArray(t.pos)),t.quat&&this.tr.setRotation(this.tr.getRotation().fromArray(t.quat)),this.body.setWorldTransform(this.tr))}setMass(t){var e=this.tmpV;this.data.mass=t,e.setValue(0,0,0),this.body.getCollisionShape().calculateLocalInertia(this.data.mass,e),this.body.setMassProps(t,e),this.body.updateInertiaTensor(),e.free()}setPosition(){this.steering=0,this.breaking=0,this.motor=0,this.tmpT.identity().fromArray(this.data.pos.concat(this.data.quat));var t=this.tmpV.set(0,0,0);this.body.setAngularVelocity(t),this.body.setLinearVelocity(t),this.body.setWorldTransform(this.tmpT),this.chassis.resetSuspension();for(var e=this.numWheel;e--;)this.chassis.updateWheelTransform(e,!0)}drive(){if(!this.enable)return;const t=this.data,e=r.key;let i,s;if(0===e[0]?this.steering*=.9:this.steering-=t.incSteering*e[0],this.steering=p.clamp(this.steering,-t.maxSteering,t.maxSteering),0===e[1]?(this.motor=0,this.breaking=t.breaking):(this.motor-=t.acceleration*e[1],this.breaking=0),this.motor=p.clamp(this.motor,-t.engine,t.engine),this.wheelSide=this.wheelsPosition[1][0],this.wheelBase=2*this.wheelsPosition[1][2],this.numWheel>3){let t=this.wheelBase/Math.tan(this.steering*d);i=Math.atan2(this.wheelBase,this.wheelSide+t),s=Math.atan2(this.wheelBase,-this.wheelSide+t),t<0&&(i-=Math.PI,s-=Math.PI)}let o=this.numWheel;for(;o--;)this.numWheel<4?0===o&&this.chassis.setSteeringValue(this.steering*d,o):(0===o&&this.chassis.setSteeringValue(s,o),1===o&&this.chassis.setSteeringValue(i,o)),this.chassis.applyEngineForce(this.motor,o),this.chassis.setBrake(this.breaking,o);if(this.motor<1){var a=this.body.getAngularVelocity();a.multiplyArray(this.limitAngular),this.body.setAngularVelocity(a)}}clear(){this.body=null,this.chassis=null}setData(t){var e=this.data;for(var i in void 0!==t.mass&&t.mass!==e.mass&&this.setMass(t.mass),t)void 0!==e[i]&&(e[i]=t[i]);this.body.setFriction(e.friction),this.body.setRestitution(e.restitution),this.body.setRollingFriction(e.rolling),void 0!==t.damping&&this.body.setDamping(t.damping[0],t.damping[1]),void 0!==t.limitAngular&&(this.limitAngular=t.limitAngular);var r=new Ammo.btVector3;if(void 0!==t.linearFactor&&this.body.setLinearFactor(r.fromArray(t.linearFactor)),void 0!==t.angularFactor&&this.body.setAngularFactor(r.fromArray(t.angularFactor)),r.free(),e.autoSuspension){var s=Math.sqrt(e.s_stiffness);e.s_compression=2*e.compValue*s,e.s_damping=2*e.dampValue*s,console.log(s,e.s_damping,e.s_compression)}for(var o,a=this.numWheel;a--;)(o=this.chassis.getWheelInfo(a)).set_m_suspensionStiffness(e.s_stiffness),o.set_m_wheelsDampingCompression(e.s_compression),o.set_m_wheelsDampingRelaxation(e.s_damping),o.set_m_maxSuspensionTravelCm(100*e.s_travel),o.set_m_suspensionRestLength1(.5*e.s_travel),o.set_m_maxSuspensionForce(e.s_force),o.set_m_rollInfluence(e.w_roll),o.set_m_frictionSlip(e.w_friction),o.set_m_wheelsRadius(a<2?this.radius:this.radiusBack);t.reset&&this.setPosition()}get(){self.postMessage({m:"carData",o:this.data})}release(){r.world.removeAction(this.chassis),r.world.removeRigidBody(this.body),Ammo.destroy(this.chassis),Ammo.destroy(this.body)}}class x extends y{constructor(){super(),this.type="terrain",this.Utils=s}add(t){this.setName(t);let e=new k(t);this.addToWorld(e,t.id)}set(t={},e=null){null===e&&(e=this.byName(t.name)),null!==e&&e.set(t)}}class k{constructor(t){this.type="terrain",this.name=t.name,this.needUpdate=!1,this.heightField=null,this.t=new Ammo.btTransform,this.data=null,this.init(t)}init(t){const e=t.size,i=[e[0]/(t.sample[0]-1),e[2]/(t.sample[1]-1)];this.fullSample=[t.sample[0],t.sample[1]],this.setData(t),this.update();let r=void 0===t.margin?.02:t.margin,s=void 0===t.heightScale?1:t.heightScale,o=void 0===t.upAxis?1:t.upAxis,a=new Ammo.btHeightfieldTerrainShape(t.sample[0],t.sample[1],this.data,s,2*-e[1],2*e[1],o,"PHY_FLOAT",!1),n=new Ammo.btVector3(i[0],1,i[1]);a.setLocalScaling(n),a.setMargin(r);let l=void 0===t.mass?0:t.mass,h=void 0===t.friction?.5:t.friction,m=void 0===t.restitution?0:t.restitution,c=void 0===t.flag?1:t.flag;this.group=void 0!==t.group?t.group:2,this.mask=void 0!==t.mask?t.mask:-1,this.t.fromArray(t.pos,t.quat),n.set(0,0,0);let u=new Ammo.btDefaultMotionState(this.t),d=new Ammo.btRigidBodyConstructionInfo(l,u,a,n);d.set_m_friction(h),d.set_m_restitution(m),this.body=new Ammo.btRigidBody(d),this.body.setCollisionFlags(c)}setData(t){this.tmpData=t.heightData,this.nDataBytes=this.tmpData.length*this.tmpData.BYTES_PER_ELEMENT,this.needsUpdate=!0}update(){this.needsUpdate&&(this.malloc(),this.needsUpdate=!1,this.tmpData=null)}malloc(){null===this.data&&(this.data=Ammo._malloc(this.nDataBytes));let t=this.tmpData.length,e=0,i=0;for(;t--;)Ammo.HEAPF32[this.data+i>>2]=this.tmpData[e],e++,i+=4}release(){r.world.removeCollisionObject(this.body),Ammo.destroy(this.body),this.body=null,this.data=null,this.tmpData=null,this.dataHeap=null}set(t){t.heightData&&(this.setData(t),this.update())}}class T extends b{constructor(){super(),this.num=u.character}add(t={}){t.type="capsule",super.add(t)}}let M;self.onmessage=function(t){ot.message(t)};let V,L,R,C,B=!1,F=!1,I=!0,P=!1;const W="undefined"==typeof performance?Date:performance,O={tmp:0,n:0,dt:0,fps:0};let N,q,D,j,E,z,G,U=1/60,Q=16.67,H=4,K=!0,Y=2,X=0,Z=0,J=!0,$=null,tt=null,et=null,it=null,rt={},st="";class ot{static test(){}static message(t){let e=t.data;e.Ar&&(V=e.Ar),e.flow&&(rt=e.flow),e.m&&ot[e.m](e.o)}static post(t,e){C?self.postMessage(t,e):R({data:t})}static init(t={}){C=!0,P=t.isBuffer||!1,void 0!==t.fps&&(U=1/t.fps),void 0!==t.substep&&(H=t.substep),t.message&&(R=t.message,C=!1,P=!1),t.blob&&importScripts(t.blob),Ammo().then((t=>{self.Ammo=t,s.extends(),ot.initItems(),ot.post({m:"ready",o:{}})}))}static set(t={}){L=t.ArPos||function(t,e=!1){let i={},r={body:o*(e?u.bodyFull:u.body),joint:a*u.joint,ray:l*u.ray,contact:n*u.contact,character:h*u.character};"PHYSX"!==t&&"AMMO"!==t||(r.vehicle=m*u.vehicle),"PHYSX"===t&&(r.solver=c*u.solver),"HAVOK"!==t&&"RAPIER"!==t||(u.joint=0);let s=0;for(let t in r)i[t]=s,s+=r[t];return i.total=s,i}("AMMO",t.full),M.body.setFull(t.full),F=t.outsideStep||!1,B=t.isTimeout||!1,U=1/(t.fps||60),Q=p.toFixed(1e3*U,2),H=t.substep||1,K=void 0===t.fixe||t.fixe,Y=t.broadphase||2,r.substep=H,I=void 0===t.soft||t.soft,et=(new Ammo.btVector3).fromArray(t.gravity||[0,-9.8,0]),r.gravity=et,t.penetration&&(it=t.penetration),null===r.world&&ot.start()}static start(){null===r.world&&(V=new Float32Array(L.total),ot.initWorld()),J=!1,N=!1,Z=0,q=0,F||(B?(tt&&clearTimeout(tt),tt=setTimeout(ot.step,0)):$=setInterval(ot.step,Q))}static initWorld(){switch(D=new Ammo.btSequentialImpulseConstraintSolver,j=I?new Ammo.btDefaultSoftBodySolver:null,E=I?new Ammo.btSoftBodyRigidBodyCollisionConfiguration:new Ammo.btDefaultCollisionConfiguration,z=new Ammo.btCollisionDispatcher(E),Y){case 1:let t=1e3;G=new Ammo.btAxisSweep3(new Ammo.btVector3(-t,-t,-t),new Ammo.btVector3(t,t,t),4096);break;case 2:G=new Ammo.btDbvtBroadphase}(r.world=I?new Ammo.btSoftRigidDynamicsWorld(z,G,D,E,j):new Ammo.btDiscreteDynamicsWorld(z,G,D,E),r.world.setGravity(et),I)&&r.world.getWorldInfo().set_m_gravity(et);it&&r.world.getDispatchInfo().set_m_allowedCcdPenetration(it)}static controle(t){t!==st&&(this.enable(st,!1),st=t,this.enable(st,!0))}static enable(t,e){if(""===t)return;let i=ot.byName(t);null!==i&&(i.enable=e)}static dispatch(){if(r.key=rt.key,rt.remove)for(;rt.remove.length>0;)this.remove(rt.remove.shift());if(rt.add)for(;rt.add.length>0;)this.add(rt.add.shift());if(rt.tmp)for(;rt.tmp.length>0;)this.change(rt.tmp.shift());this.controle(rt.current)}static poststep(){if(!J&&(q=1,this.dispatch(),!F&&B)){tt&&clearTimeout(tt);let t=Q-(W.now()-Z);t<0&&(t=0),tt=setTimeout(ot.step,t)}}static step(t){if(N&&ot.endReset(),J||q>=2)return;q=2,X=t||W.now(),r.delta=.001*(X-Z),Z=X;let e=H,i=K?U/H:r.delta/H;K?r.world.stepSimulation(U,e,i):r.world.stepSimulation(r.delta,e,i),ot.stepItems(),r.numBreak>0&&ot.stepBreak(),X-1e3>O.tmp&&(O.tmp=X,r.reflow.stat.fps=O.n,O.n=0),O.n++,r.reflow.stat.delta=r.delta,P?ot.post({m:"step",reflow:r.reflow,Ar:V},[V.buffer]):ot.post({m:"step",reflow:r.reflow,Ar:V}),r.reflow.point={}}static byName(t){return s.byName(t)}static reset(){N=!0}static endReset(){ot.stop(),ot.resetItems(),ot.clearReFlow(),r.numBreak=0,Ammo.destroy(r.world),Ammo.destroy(D),I&&Ammo.destroy(j),Ammo.destroy(E),Ammo.destroy(z),Ammo.destroy(G),r.world=null,st="",s.clear(),ot.post({m:"resetCallback",o:{}})}static stop(){J=!0,F||(tt&&clearTimeout(tt),$&&clearInterval($),$=null,tt=null)}static pause(t){let e=t.value;e!==J&&(e?this.stop():this.start())}static clearReFlow(){r.reflow={ray:[],stat:{fps:0,delta:0},point:{}}}static stepBreak(){let t,e,i,s,o,a,n;for(let l=0,h=z.getNumManifolds();l<h;l++)if(t=z.getManifoldByIndexInternal(l),a=Ammo.castObject(t.getBody0(),Ammo.btRigidBody),n=Ammo.castObject(t.getBody1(),Ammo.btRigidBody),s=a.name,o=n.name,(a.breakable||n.breakable)&&!a.breakable&&n.breakable)for(let h=0,m=t.getNumContacts();h<m;h++)if(e=t.getContactPoint(h),i=p.toFixed(e.getDistance(),3),i<-.01){let t={distance:i,pos:e.get_m_positionWorldOnB().toArray(),normal:e.get_m_normalWorldOnB().toArray(),impulse:20*e.getAppliedImpulse(),v1:ot.getVelocity(a),v2:ot.getVelocity(n)};r.reflow.point[s+"_"+o+"_"+l+"_"+h]={b1:s,b2:o,hit:i<0,...t}}}static getVelocity(t){if(t&&t.breakable){return[...t.getLinearVelocity().toArray(),...t.getAngularVelocity().toArray()]}return[0,0,0,0,0,0]}static initItems(){M={ray:new f,body:new b,solid:new at,joint:new A,contact:new v,character:new T,vehicle:new _,terrain:new x},r.bodyRef=M.body,r.byName=ot.byName}static resetItems(){for(const t in M)M[t].reset()}static stepItems(){for(const t in M)M[t].step(V,L[t])}static add(t={}){let e=function(t){switch(t.type){case"plane":case"box":case"sphere":case"highSphere":case"cylinder":case"stair":case"cone":case"capsule":case"mesh":case"convex":case"compound":case"null":return t.density||t.kinematic?"body":"solid";default:return t.type}}(t);M[e].add(t)}static remove(t={}){let e=this.byName(t.name);null!==e&&M[e.type].clear(e)}static change(t={}){let e=this.byName(t.name);null!==e&&M[e.type].set(t,e)}}class at extends b{constructor(){super(),this.type="solid"}step(t,e){}}t.engine=ot,Object.defineProperty(t,"__esModule",{value:!0})}));
