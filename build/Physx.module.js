const e=new Map,t=new Map,s=new Map,i={byName:null,world:null,scene:null,gravity:null,cooking:null,cookingParams:null,tolerances:null,defaultMaterial:null,bodyRef:null,garbage:[],delta:0,substep:1,restitution:0,setFilter:null,setFilterData:null,flow:{tmp:[],key:[]},reflow:{ray:[],stat:{fps:0,delta:0}}},r=Math.PI/180,a=180/Math.PI,n=Number.MAX_SAFE_INTEGER,o=(e,t,s)=>e=(e=e<t?t:e)>s?s:e,l={solverAxis:null,D6Axis:null,clear:()=>{e.clear(),t.clear(),s.clear()},byName:t=>e.has(t)?e.get(t):null,byPtr:e=>t.has(e)?t.get(e):null,byContact:e=>s.has(e)?s.get(e):null,clearContact:()=>{s.clear()},addContact:e=>{s.set(e,!0)},add:(s,r)=>{switch(s.type){case"body":case"solid":s.isBone||i.scene.addActor(s,r),t.set(s.ptr,s.name)}e.set(s.name,s)},remove:t=>{if("ray"!==t.type&&"contact"!==t.type)switch(t.type){case"joint":case"solver":case"vehicle":case"terrain":t.release();break;default:t.isBone||(i.scene.removeActor(t),t.release())}e.delete(t.name)},stats:()=>{},malloc:(e,t)=>{const s=e.length*e.BYTES_PER_ELEMENT;return void 0===t&&(t=PhysX._malloc(s)),new Uint8Array(PhysX.HEAPU8.buffer,t,s).set(new Uint8Array(e.buffer)),t},free:e=>{e&&PhysX._emscripten_stack_get_free(e)},extends:()=>{l.solverAxis={x:PhysX._emscripten_enum_PxArticulationAxisEnum_eX(),y:PhysX._emscripten_enum_PxArticulationAxisEnum_eY(),z:PhysX._emscripten_enum_PxArticulationAxisEnum_eZ(),rx:PhysX._emscripten_enum_PxArticulationAxisEnum_eTWIST(),ry:PhysX._emscripten_enum_PxArticulationAxisEnum_eSWING1(),rz:PhysX._emscripten_enum_PxArticulationAxisEnum_eSWING2(),twist:PhysX._emscripten_enum_PxArticulationAxisEnum_eTWIST(),swing1:PhysX._emscripten_enum_PxArticulationAxisEnum_eSWING1(),swing2:PhysX._emscripten_enum_PxArticulationAxisEnum_eSWING2()},l.D6Axis={x:PhysX._emscripten_enum_PxD6AxisEnum_eX(),y:PhysX._emscripten_enum_PxD6AxisEnum_eY(),z:PhysX._emscripten_enum_PxD6AxisEnum_eZ(),rx:PhysX._emscripten_enum_PxD6AxisEnum_eTWIST(),ry:PhysX._emscripten_enum_PxD6AxisEnum_eSWING1(),rz:PhysX._emscripten_enum_PxD6AxisEnum_eSWING2(),twist:PhysX._emscripten_enum_PxD6AxisEnum_eTWIST(),swing1:PhysX._emscripten_enum_PxD6AxisEnum_eSWING1(),swing2:PhysX._emscripten_enum_PxD6AxisEnum_eSWING2()},PhysX.PxVec3.prototype.set=function(e,t,s){return this.x=e,this.y=t,this.z=s,this},PhysX.PxVec3.prototype.toArray=function(e,t){let s=void 0!==e;if(s||(e=[]),e[t=t||0]=this.x,e[t+1]=this.y,e[t+2]=this.z,!s)return e},PhysX.PxVec3.prototype.multiplyScalar=function(e){return this.x*=e,this.y*=e,this.z*=e,this},PhysX.PxVec3.prototype.divideScalar=function(e){return this.multiplyScalar(1/e)},PhysX.PxVec3.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},PhysX.PxVec3.prototype.normalize=function(){return this.divideScalar(this.length()||1)},PhysX.PxVec3.prototype.directionVector=function(e){const t=b.x-this.x,s=b.y-this.y,i=b.z-this.z;return Math.sqrt(t*t+s*s+i*i)},PhysX.PxVec3.prototype.distanceTo=function(e){const t=this.x-e.x,s=this.y-e.y,i=this.z-e.z;return Math.sqrt(t*t+s*s+i*i)},PhysX.PxVec3.prototype.op_sub=function(e){return this.set(this.x-e.x,this.y-e.y,this.z-e.z),this},PhysX.PxVec3.prototype.fromArray=function(e,t){return t=t||0,this.set(e[t],e[t+1],e[t+2]),this},PhysX.PxVec3.prototype.copy=function(e){return this.set(e.x,e.y,e.z),this},PhysX.PxVec3.prototype.dot=function(e){return this.x*e.x+this.y*e.y+this.z*e.z},PhysX.PxVec3.prototype.applyQuaternion=function(e){const t=this.x,s=this.y,i=this.z,r=e.x,a=e.y,n=e.z,o=e.w,l=o*t+a*i-n*s,h=o*s+n*t-r*i,c=o*i+r*s-a*t,y=-r*t-a*s-n*i;return this.x=l*o+y*-r+h*-n-c*-a,this.y=h*o+y*-a+c*-r-l*-n,this.z=c*o+y*-n+l*-a-h*-r,this},PhysX.PxVec3.prototype.applyMatrix3=function(e){const t=this.x,s=this.y,i=this.z,r=e.getBasis();return this.x=r[0]*t+r[3]*s+r[6]*i,this.y=r[1]*t+r[4]*s+r[7]*i,this.z=r[2]*t+r[5]*s+r[8]*i,this},PhysX.PxVec3.prototype.free=function(){PhysX.destroy(this),PhysX._emscripten_stack_get_free(this.ptr)},PhysX.PxQuat.prototype.identity=function(e,t){return this.set(0,0,0,1)},PhysX.PxQuat.prototype.set=function(e,t,s,i){return this.x=e,this.y=t,this.z=s,this.w=i,this},PhysX.PxQuat.prototype.toArray=function(e,t){let s=void 0!==e;if(s||(e=[]),e[t=t||0]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.w,!s)return e},PhysX.PxQuat.prototype.multiplyQuaternions=function(e,t){const s=e.x,i=e.y,r=e.z,a=e.w,n=t.x,o=t.y,l=t.z,h=t.w;return this.x=s*h+a*n+i*l-r*o,this.y=i*h+a*o+r*n-s*l,this.z=r*h+a*l+s*o-i*n,this.w=a*h-s*n-i*o-r*l,this},PhysX.PxQuat.prototype.premultiply=function(e){return this.multiplyQuaternions(e,this)},PhysX.PxQuat.prototype.multiply=function(e){return this.multiplyQuaternions(this,e)},PhysX.PxQuat.prototype.fromArray=function(e,t){return t=t||0,this.set(e[t],e[t+1],e[t+2],e[t+3]),this},PhysX.PxQuat.prototype.fromAxisAngle=function(e,t){const s=.5*t,i=Math.sin(s);return this.x=e[0]*i,this.y=e[1]*i,this.z=e[2]*i,this.w=Math.cos(s),this},PhysX.PxQuat.prototype.fromAxis=function(e){let t=e.toArray();if(t[2]>.99999)this.set(0,0,0,1);else if(t[2]<-.99999)this.set(1,0,0,0);else{let e=[t[1],t[0],0],s=Math.acos(t[2]);this.fromAxisAngle(e,s)}return this},PhysX.PxQuat.prototype.setFromRotationMatrix=function(e){const t=e[0],s=e[4],i=e[8],r=e[1],a=e[5],n=e[9],o=e[2],l=e[6],h=e[10],c=t+a+h;if(c>0){const e=.5/Math.sqrt(c+1);this.w=.25/e,this.x=(l-n)*e,this.y=(i-o)*e,this.z=(r-s)*e}else if(t>a&&t>h){const e=2*Math.sqrt(1+t-a-h);this.w=(l-n)/e,this.x=.25*e,this.y=(s+r)/e,this.z=(i+o)/e}else if(a>h){const e=2*Math.sqrt(1+a-t-h);this.w=(i-o)/e,this.x=(s+r)/e,this.y=.25*e,this.z=(n+l)/e}else{const e=2*Math.sqrt(1+h-t-a);this.w=(r-s)/e,this.x=(i+o)/e,this.y=(n+l)/e,this.z=.25*e}return this},PhysX.PxQuat.prototype.free=function(){PhysX.destroy(this),PhysX._emscripten_stack_get_free(this.ptr)},PhysX.PxTransform.prototype.set=function(e,t){return this.p=e,this.q=t,this},PhysX.PxTransform.prototype.identity=function(){return this.p.fromArray([0,0,0]),this.q.fromArray([0,0,0,1]),this},PhysX.PxTransform.prototype.fromArray=function(e,t,s,i){return this.p.fromArray(e||[0,0,0],s||0),this.q.fromArray(t||[0,0,0,1],i||0),this},PhysX.PxTransform.prototype.multiply=function(e){const t=this.getElements(),s=e.getElements(),i=[],r=t[0],a=t[4],n=t[8],o=t[12],l=t[1],h=t[5],c=t[9],y=t[13],m=t[2],p=t[6],u=t[10],P=t[14],_=t[3],d=t[7],g=t[11],x=t[15],f=s[0],v=s[4],A=s[8],X=s[12],E=s[1],w=s[5],F=s[9],S=s[13],C=s[2],b=s[6],T=s[10],D=s[14],I=s[3],L=s[7],R=s[11],M=s[15];return i[0]=r*f+a*E+n*C+o*I,i[4]=r*v+a*w+n*b+o*L,i[8]=r*A+a*F+n*T+o*R,i[12]=r*X+a*S+n*D+o*M,i[1]=l*f+h*E+c*C+y*I,i[5]=l*v+h*w+c*b+y*L,i[9]=l*A+h*F+c*T+y*R,i[13]=l*X+h*S+c*D+y*M,i[2]=m*f+p*E+u*C+P*I,i[6]=m*v+p*w+u*b+P*L,i[10]=m*A+p*F+u*T+P*R,i[14]=m*X+p*S+u*D+P*M,i[3]=_*f+d*E+g*C+x*I,i[7]=_*v+d*w+g*b+x*L,i[11]=_*A+d*F+g*T+x*R,i[15]=_*X+d*S+g*D+x*M,this.decompose(i)},PhysX.PxTransform.prototype.decompose=function(e){return this.p.set(e[12],e[13],e[14]),this.q.setFromRotationMatrix(e),this},PhysX.PxTransform.prototype.getElements=function(e,t,s){const i=[];e=e||this.p,s=s||{x:1,y:1,z:1};const r=(t=t||this.q).x,a=t.y,n=t.z,o=t.w,l=r+r,h=a+a,c=n+n,y=r*l,m=r*h,p=r*c,u=a*h,P=a*c,_=n*c,d=o*l,g=o*h,x=o*c,f=s.x,v=s.y,A=s.z;return i[0]=(1-(u+_))*f,i[1]=(m+x)*f,i[2]=(p-g)*f,i[3]=0,i[4]=(m-x)*v,i[5]=(1-(y+_))*v,i[6]=(P+d)*v,i[7]=0,i[8]=(p+g)*A,i[9]=(P-d)*A,i[10]=(1-(y+u))*A,i[11]=0,i[12]=e.x,i[13]=e.y,i[14]=e.z,i[15]=1,i},PhysX.PxTransform.prototype.getBasis=function(){let e=this.getElements();return[e[0],e[4],e[8],e[1],e[5],e[9],e[2],e[6],e[10]]},PhysX.PxTransform.prototype.toArray=function(e,t){t=t||0,this.p.toArray(e,t),this.q.toArray(e,t+3)},PhysX.PxTransform.prototype.copy=function(e){return this.p=e.p,this.q=e.q,this},PhysX.PxTransform.prototype.rotationFromAxis=function(e){return this.q.fromAxis(e),this},PhysX.PxTransform.prototype.free=function(){PhysX.destroy(this),this.p.free(),this.q.free(),PhysX._emscripten_stack_get_free(this.ptr)}}},h={bodyFull:14,body:8,joint:16,contact:8,ray:8,character:16,vehicle:64,solver:256};class c{constructor(){this.id=0,this.list=[],this.type="item",this.Utils=null}reset(){let e=this.list.length;for(;e--;)this.dispose(this.list[e]);this.id=0,this.list=[]}byName(e){return this.Utils.byName(e)}setName(e={}){let t=void 0!==e.name?e.name:this.type+this.id++;return e.id=this.remove(t,!0),e.name=t,t}addToWorld(e,t=-1){this.Utils.add(e),-1!==t?this.list[t]=e:this.list.push(e)}remove(e,t){let s=this.byName(e);return s?this.clear(s,t):-1}clear(e,t){let s=this.list.indexOf(e);return-1===s||t?this.list[s]=null:this.list.splice(s,1),this.dispose(e),s}dispose(e){null!==e&&this.Utils.remove(e)}add(e={}){}set(e={}){}step(e,t){}}class y extends c{constructor(){super(),this.Utils=l,this.type="ray",this.init()}init(){this.rayBuffer=new PhysX.PxRaycastBuffer10,this.rayFlags=new PhysX.PxHitFlags(PhysX._emscripten_enum_PxHitFlagEnum_eDEFAULT()),this.rayFilter=new PhysX.PxQueryFilterData,this.v1=new PhysX.PxVec3(0,0,0),this.v2=new PhysX.PxVec3(0,0,0)}byPtr(e){return l.byPtr(e)}step(e,t){i.reflow.ray=[];let s,r,a=this.list.length;for(;a--;){if(s=t+a*h.ray,this.list[a],e[s]=0,this.v1.fromArray(e,s+1),this.v2.fromArray(e,s+4),r=this.v1.distanceTo(this.v2),this.v2.op_sub(this.v1).normalize(),i.scene.raycast(this.v1,this.v2,r,this.rayBuffer,this.rayFlags,this.rayFilter)){e[s]=1;let t=this.rayBuffer.getAnyHit();t.position.toArray(e,s+1),t.normal.toArray(e,s+4),i.reflow.ray[a]=this.byPtr(t.actor.ptr)}}}add(e={}){this.setName(e);let t=new m(e);this.addToWorld(t,e.id)}set(e={},t=null){}}class m{constructor(e={}){this.type="ray",this.name=e.name,this.precision=e.precision||1,this.group=void 0!==e.group||1,this.mask=void 0!==e.mask||-1}}class p extends c{constructor(){super(),this.Utils=l,this.type="body",this.num=h[this.type],this.full=!1,this.tv=null,this.v=new PhysX.PxVec3,this.q=new PhysX.PxQuat,this.qr=new PhysX.PxQuat,this.t=new PhysX.PxTransform}setFull(e){this.num=h[e?"bodyFull":"body"],this.full=e}step(e,t){let s,i,r,a,n,o=this.list.length;for(;o--;)s=this.list[o],i=t+o*this.num,s?(n=s.isBone?s.getArticulation().isSleeping():s.isSleeping(),e[i]=n?0:1,s.getGlobalPose().toArray(e,i+1),this.full&&(r=s.getLinearVelocity(),a=s.getAngularVelocity(),r.toArray(e,i+8),a.toArray(e,i+11),1===e[i]&&(e[i]=9.8*r.length()))):e[i]=e[i+1]=e[i+2]=e[i+3]=e[i+4]=e[i+5]=e[i+6]=e[i+7]=0}preRotate(e=[0,0,0,1],t="Z"){let s;switch(t){case"Y":s=[0,.7071067811865475,0,.7071067811865476];break;case"Z":s=[0,0,.7071067811865475,.7071067811865476]}return this.q.fromArray(e).premultiply(this.qr.fromArray(s)).toArray()}setShapeFlag(e){let t=PhysX._emscripten_enum_PxShapeFlagEnum_eSCENE_QUERY_SHAPE()|PhysX._emscripten_enum_PxShapeFlagEnum_eSIMULATION_SHAPE();return void 0!==e&&("noCollision"===e&&(t=PhysX._emscripten_enum_PxShapeFlagEnum_eSCENE_QUERY_SHAPE()),"noQuery"===e&&(t=PhysX._emscripten_enum_PxShapeFlagEnum_eSIMULATION_SHAPE()),"ghost"===e&&(t=PhysX._emscripten_enum_PxShapeFlagEnum_eTRIGGER_SHAPE()),"ghostAndQuery"===e&&(t=PhysX._emscripten_enum_PxShapeFlagEnum_eTRIGGER_SHAPE()|PhysX._emscripten_enum_PxShapeFlagEnum_eSCENE_QUERY_SHAPE()),"none"===e&&(t=0)),new PhysX.PxShapeFlags(t)}shape(e={}){let t,s,r,a,n,o,h=null,c=null,y=null,m=e.type||"box",p=e.size||[1,1,1],u=!1,P=null;switch(m){case"plane":t=new PhysX.PxPlaneGeometry;break;case"box":t=new PhysX.PxBoxGeometry(.5*p[0],.5*p[1],.5*p[2]);break;case"sphere":t=new PhysX.PxSphereGeometry(p[0]);break;case"capsule":t=new PhysX.PxCapsuleGeometry(p[0],.5*p[1]);break;case"convex":s=new PhysX.PxConvexMeshDesc,r=e.v,h=l.malloc(r),s.points.stride=3*r.BYTES_PER_ELEMENT,s.points.count=r.length/3,s.points.data=h;let m=0;m|=PhysX._emscripten_enum_PxConvexFlagEnum_eCOMPUTE_CONVEX(),m|=PhysX._emscripten_enum_PxConvexFlagEnum_eQUANTIZE_INPUT(),m|=PhysX._emscripten_enum_PxConvexFlagEnum_eDISABLE_MESH_VALIDATION(),m|=PhysX._emscripten_enum_PxConvexFlagEnum_eGPU_COMPATIBLE(),m|=PhysX._emscripten_enum_PxConvexFlagEnum_eSHIFT_VERTICES(),y=new PhysX.PxConvexFlags(m),s.flags=y,a=i.cooking.createConvexMesh(s,i.world.getPhysicsInsertionCallback()),n=new PhysX.PxMeshScale,o=new PhysX.PxConvexMeshGeometryFlags,t=new PhysX.PxConvexMeshGeometry(a,n,o),i.garbage.push(a),PhysX.destroy(y),PhysX.destroy(n),PhysX.destroy(o),PhysX.destroy(s),l.free(h);break;case"mesh":s=new PhysX.PxTriangleMeshDesc,r=e.v,P=e.index||null,P&&(P.constructor===Uint16Array&&(u=!0),P.constructor===Uint32Array&&(u=!1)),h=l.malloc(r),s.points.stride=3*r.BYTES_PER_ELEMENT,s.points.count=r.length/3,s.points.data=h,null!==P&&(c=l.malloc(P),s.triangles.stride=3*P.BYTES_PER_ELEMENT,s.triangles.count=P.length/3,s.triangles.data=c),u&&(y=new PhysX.PxTriangleMeshFlags(PhysX._emscripten_enum_PxTriangleMeshFlagEnum_e16_BIT_INDICES()),s.flags=y),a=i.cooking.createTriangleMesh(s,i.world.getPhysicsInsertionCallback()),n=new PhysX.PxMeshScale,o=new PhysX.PxMeshGeometryFlags,t=new PhysX.PxTriangleMeshGeometry(a,n,o),i.garbage.push(a),y&&PhysX.destroy(y),PhysX.destroy(n),PhysX.destroy(o),PhysX.destroy(s),l.free(h),l.free(c)}return t}add(e={}){let t=this.setName(e),s=["body"===this.type?1:2,-1,0,0];void 0!==e.filter&&(s=e.filter,delete e.filter),void 0!==e.group&&(s[0]=e.group),void 0!==e.mask&&(s[1]=e.mask),e.isTrigger&&(s[1]=-1,s[2]=[3,5],e.flags="ghostAndQuery"),e.friction||(e.friction=.5),e.staticFriction||(e.staticFriction=e.friction),e.restitution||(e.restitution=i.restitution);let r,a,n,o=.5===e.friction&&.5===e.staticFriction&&e.restitution===i.restitution,h=o?i.defaultMaterial:i.world.createMaterial(e.staticFriction,e.friction,e.restitution),c=[];switch(e.type){case"null":s[1]=0,r=this.shape({type:"sphere",size:[.01]}),n=this.setShapeFlag(0),c.push(i.world.createShape(r,h,void 0===e.isExclusive||e.isExclusive,n)),PhysX.destroy(n),PhysX.destroy(r);break;case"compound":let t,a;c=[],n=this.setShapeFlag(e.flags);for(var y=0;y<e.shapes.length;y++)t=e.shapes[y],r=this.shape(t),a=i.world.createShape(r,h,e.isExclusive||!1,n),"plane"!==t.type&&"capsule"!==t.type||(t.quat=this.preRotate(t.quat)),a.setLocalPose(this.t.fromArray(t.pos,t.quat)),PhysX.destroy(r),c.push(a);PhysX.destroy(n);break;default:r=this.shape(e),n=this.setShapeFlag(e.flags),c.push(i.world.createShape(r,h,void 0===e.isExclusive||e.isExclusive,n));let o=e.localPos||[0,0,0],l=e.localQuat||[0,0,0,1];"plane"!==e.type&&"capsule"!==e.type||(l=this.preRotate(l)),c[0].setLocalPose(this.t.fromArray(o,l)),r?PhysX.destroy(r):console.log(e),PhysX.destroy(n)}if(o||h.release(),this.t.fromArray(e.pos,e.quat),e.solver){let s=l.byName(e.solver);null!==s&&(a=s.addBone(t,this.t,e.linked),a.isBone=!0)}else a="body"===this.type?i.world.createRigidDynamic(this.t):i.world.createRigidStatic(this.t);let m=c.length;for(;m--;)i.setFilter(c[m],s),a.attachShape(c[m]),c[m].release();e.density&&"body"===this.type&&(a.isBone?PhysX.PxRigidBodyExt.prototype.setMassAndUpdateInertia(a,e.density,null,!1):PhysX.PxRigidBodyExt.prototype.updateMassAndInertia(a,e.density)),a&&(a.name=t,a.type=this.type,a.isKinematic=e.kinematic||!1,a.filter=s,delete e.pos,delete e.quat,this.set(e,a),this.addToWorld(a,e.id))}set(e={},t=null){if(null===t&&(t=this.byName(e.name)),null===t)return;e.noGravity&&t.setActorFlag(PhysX._emscripten_enum_PxActorFlagEnum_eDISABLE_GRAVITY(),!0),e.disable&&t.setActorFlag(PhysX._emscripten_enum_PxActorFlagEnum_eDISABLE_SIMULATION(),!0);let s=!e.activate||e.activate;if(t.isBone||(e.sleep&&(t.putToSleep(),s=!1),e.wake&&t.wakeUp(),void 0!==e.neverSleep&&(t.setSleepThreshold(e.neverSleep?0:.005),e.neverSleep&&t.wakeUp())),e.pos||e.quat){if(!e.pos){let s=t.getGlobalPose().p;e.pos=[s.x,s.y,s.z]}if(!e.quat){let s=t.getGlobalPose().q;e.quat=[s.x,s.y,s.z,s.w]}t.setGlobalPose(this.t.fromArray(e.pos,e.quat),s)}if(e.force){let i;switch(e.forceMode||"force"){case"force":i=PhysX._emscripten_enum_PxForceModeEnum_eFORCE();break;case"impulse":i=PhysX._emscripten_enum_PxForceModeEnum_eIMPULSE();break;case"velocity":i=PhysX._emscripten_enum_PxForceModeEnum_eVELOCITY_CHANGE();break;case"acceleration":i=PhysX._emscripten_enum_PxForceModeEnum_eACCELERATION()}t.addForce(this.v.fromArray(e.force),i,s)}if(e.torque){let i;switch(e.torqueMode||"force"){case"force":i=PhysX._emscripten_enum_PxForceModeEnum_eFORCE();break;case"impulse":i=PhysX._emscripten_enum_PxForceModeEnum_eIMPULSE();break;case"velocity":i=PhysX._emscripten_enum_PxForceModeEnum_eVELOCITY_CHANGE();break;case"acceleration":i=PhysX._emscripten_enum_PxForceModeEnum_eACCELERATION()}t.addTorque(this.v.fromArray(e.torque),i,s)}"body"===t.type&&(void 0!==e.linearVelocity&&t.setLinearVelocity(this.v.fromArray(e.linearVelocity),s),void 0!==e.angularVelocity&&t.setAngularVelocity(this.v.fromArray(e.angularVelocity).multiplyScalar(i.substep),s),void 0!==e.linearFactor&&(t.setRigidDynamicLockFlag(PhysX.eLOCK_LINEAR_X,!e.linearFactor[0]),t.setRigidDynamicLockFlag(PhysX.eLOCK_LINEAR_Y,!e.linearFactor[1]),t.setRigidDynamicLockFlag(PhysX.eLOCK_LINEAR_Z,!e.linearFactor[2])),void 0!==e.angularFactor&&(t.setRigidDynamicLockFlag(PhysX.eLOCK_ANGULAR_X,!e.angularFactor[0]),t.setRigidDynamicLockFlag(PhysX.eLOCK_ANGULAR_Y,!e.angularFactor[1]),t.setRigidDynamicLockFlag(PhysX.eLOCK_ANGULAR_Z,!e.angularFactor[2])),void 0!==e.damping&&(t.setLinearDamping(e.damping[0]),t.setAngularDamping(e.damping[1])),void 0!==e.maxDamping&&(t.setMaxLinearVelocity(e.maxDamping[0]),t.setMaxAngularVelocity(e.maxDamping[1])),e.reset&&(t.setLinearVelocity(this.v.set(0,0,0),s),t.setAngularVelocity(this.v.set(0,0,0),s))),e.iterations&&t.setSolverIterationCounts&&t.setSolverIterationCounts(e.iterations[0],e.iterations[1]),void 0!==e.minCCD&&t.setMinCCDAdvanceCoefficient(e.minCCD),void 0!==e.kinematic&&(t.setRigidBodyFlag(PhysX._emscripten_enum_PxRigidBodyFlagEnum_eKINEMATIC(),e.kinematic),t.isKinematic=e.kinematic),void 0!==e.kinematicTarget&&t.setRigidBodyFlag(PhysX._emscripten_enum_PxRigidBodyFlagEnum_eUSE_KINEMATIC_TARGET_FOR_SCENE_QUERIES(),e.kinematic),void 0!==e.enableCCD&&t.setRigidBodyFlag(PhysX._emscripten_enum_PxRigidBodyFlagEnum_eENABLE_CCD(),e.enableCCD),void 0!==e.enableCCD_FRICTION&&t.setRigidBodyFlag(PhysX._emscripten_enum_PxRigidBodyFlagEnum_eENABLE_CCD_FRICTION(),e.enableCCD_FRICTION),void 0!==e.speculativeCCD&&t.setRigidBodyFlag(PhysX._emscripten_enum_PxRigidBodyFlagEnum_eENABLE_SPECULATIVE_CCD(),e.speculativeCCD),void 0!==e.enablePose&&t.setRigidBodyFlag(PhysX._emscripten_enum_PxRigidBodyFlagEnum_eENABLE_POSE_INTEGRATION_PREVIEW(),e.enablePose),void 0!==e.ccdMaxContact&&t.setRigidBodyFlag(PhysX._emscripten_enum_PxRigidBodyFlagEnum_eENABLE_CCD_MAX_CONTACT_IMPULSE(),e.ccdMaxContact),void 0!==e.retainAcc&&t.setRigidBodyFlag(PhysX._emscripten_enum_PxRigidBodyFlagEnum_eRETAIN_ACCELERATIONS(),e.retainAcc),e.massCenter&&t.setCMassLocalPose(this.t.fromArray(e.massCenter)),e.inertiaTensor&&t.setMassSpaceInertiaTensor(this.v.fromArray(e.inertiaTensor)),e.dmv&&(e.dmv[0]&&t.setLinearDamping(e.dmv[0]),e.dmv[1]&&t.setAngularDamping(e.dmv[1]),e.dmv[2]&&t.setMaxLinearVelocity(e.dmv[2]),e.dmv[3]&&t.setMaxAngularVelocity(e.dmv[3]))}setShapes(e={},t=null){let s,r=t.getNbShapes();for(;r--;)s=PhysX.SupportFunctions.prototype.PxActor_getShape(t,r),e.filter&&i.setFilter(s,e.filter)}}class u extends c{constructor(){super(),this.Utils=l,this.type="joint",this.t1=new PhysX.PxTransform,this.t2=new PhysX.PxTransform,this.v1=new PhysX.PxVec3,this.v2=new PhysX.PxVec3,this.p1=new PhysX.PxVec3,this.p2=new PhysX.PxVec3,this.q1=new PhysX.PxQuat,this.q2=new PhysX.PxQuat,this.q3=new PhysX.PxQuat}step(e,t){let s,i,r=this.list.length;for(;r--;)s=this.list[r],i=t+r*h.joint,s.visible&&(s.b1&&this.t1.copy(s.b1.getGlobalPose()).multiply(s.formA).toArray(e,i),s.b2&&this.t1.copy(s.b2.getGlobalPose()).multiply(s.formB).toArray(e,i+7))}add(e={}){this.v;let t=this.setName(e);const s=this.byName(e.b1),a=this.byName(e.b2);let n=e.mode||"revolute",o=this.v1.fromArray(e.pos1||[0,0,0]),l=this.v2.fromArray(e.pos2||[0,0,0]),h=this.q1.fromArray(e.quat1||[0,0,0,1]),c=this.q2.fromArray(e.quat2||[0,0,0,1]),y=this.p1.fromArray(e.axis1||[-1,0,0]),m=this.p2.fromArray(e.axis2||[-1,0,0]);e.worldTwistAxis&&(e.worldAxis=e.worldTwistAxis),e.quat1||h.fromAxis(y),e.quat2||c.fromAxis(m),this.t1.identity(),this.t2.identity(),(e.worldAnchor||e.worldAxis)&&(s&&("body"===s.type&&(s.isBone||s.wakeUp()),this.t1.copy(s.getGlobalPose())),a&&("body"===a.type&&(a.isBone||a.wakeUp()),this.t2.copy(a.getGlobalPose()))),e.worldAnchor&&(o=this.v1.fromArray(e.worldAnchor).op_sub(this.t1.p),l=this.v2.fromArray(e.worldAnchor).op_sub(this.t2.p),o.applyMatrix3(this.t1),l.applyMatrix3(this.t2)),e.worldAxis&&(y=this.p1.fromArray(e.worldAxis),m=this.p2.fromArray(e.worldAxis),y.applyMatrix3(this.t1).normalize(),m.applyMatrix3(this.t2).normalize(),h.fromAxis(y),c.fromAxis(m)),e.mainAxis;let p=e.mainDeg||90;this.q3.fromAxisAngle([0,1,0],p*r),h.multiply(this.q3),c.multiply(this.q3);const u=new PhysX.PxTransform(o,h),P=new PhysX.PxTransform(l,c);let _;switch(n){case"spherical":_=new PhysX.PxTopLevelFunctions.prototype.SphericalJointCreate(i.world,s,u,a,P);break;case"hinge":case"revolute":_=new PhysX.PxTopLevelFunctions.prototype.RevoluteJointCreate(i.world,s,u,a,P);break;case"slider":case"prismatic":_=new PhysX.PxTopLevelFunctions.prototype.PrismaticJointCreate(i.world,s,u,a,P);break;case"dof":case"d6":case"ragdoll":_=new PhysX.PxTopLevelFunctions.prototype.D6JointCreate(i.world,s,u,a,P);break;case"distance":_=new PhysX.PxTopLevelFunctions.prototype.DistanceJointCreate(i.world,s,u,a,P);break;case"fixe":_=new PhysX.PxTopLevelFunctions.prototype.FixedJointCreate(i.world,s,u,a,P)}_.name=t,_.mode=n,_.type=this.type,_.b1=s,_.b2=a,_.formA=u,_.formB=P,_.visible=void 0===e.visible||e.visible,this.set(e,_);let d=void 0!==e.collision&&e.collision;_.setConstraintFlag(PhysX._emscripten_enum_PxConstraintFlagEnum_eCOLLISION_ENABLED(),d),this.addToWorld(_,e.id)}spring(e,t=[0,0]){}motor(e,t=[0,0],s=!1){}limit(e,t=[0,0],s=!1){}set(e={},t=null){if(null===t&&(t=this.byName(e.name)),null===t)return;let s,i,a,o,h,c,y,m={},p=void 0===e.wake||e.wake;switch(
//!!!need PxSimulationEventCallbackImpl::onConstraintBreak.
void 0!==e.projection&&(t.setProjectionLinearTolerance(e.projection),t.setConstraintFlag(PhysX._emscripten_enum_PxConstraintFlagEnum_ePROJECTION(),!0)),e.acc&&t.setConstraintFlag(PhysX._emscripten_enum_PxD6JointDriveFlagEnum_eACCELERATION(),!0),t.mode){case"spherical":e.lm&&(s=this.coneLimit(e.lm),t.setLimitCone(s),t.setSphericalJointFlag(PhysX._emscripten_enum_PxSphericalJointFlagEnum_eLIMIT_ENABLED(),!0));break;case"slider":case"prismatic":e.lm&&(s=this.linearLimit(e.lm),t.setLimit(s),t.setPrismaticJointFlag(PhysX._emscripten_enum_PxPrismaticJointFlagEnum_eLIMIT_ENABLED(),!0)),console.log(t);break;case"revolute":case"hinge":void 0!==e.lm&&(s=this.angularLimit(e.lm),t.setLimit(s),t.setRevoluteJointFlag(PhysX._emscripten_enum_PxRevoluteJointFlagEnum_eLIMIT_ENABLED(),!0)),e.driveFree&&t.setRevoluteJointFlag(PhysX._emscripten_enum_PxRevoluteJointFlagEnum_eDRIVE_FREESPIN(),!0),e.driveVelocity&&(e.driveVelocity instanceof Array&&(e.driveVelocity=e.driveVelocity[0]),t.setDriveVelocity(e.driveVelocity,p),t.setRevoluteJointFlag(PhysX._emscripten_enum_PxRevoluteJointFlagEnum_eDRIVE_ENABLED(),!0)),void 0!==e.driveForceLimit&&t.setDriveForceLimit(e.driveForceLimit),void 0!==e.driveGearRatio&&(e.gearRatio=e.driveGearRatio),void 0!==e.gearRatio&&t.setDriveGearRatio(e.gearRatio),e.motor&&(t.setDriveVelocity(e.motor[0]*r,!0),t.setRevoluteJointFlag(PhysX._emscripten_enum_PxRevoluteJointFlagEnum_eDRIVE_ENABLED(),!0));break;case"dof":case"d6":case"ragdoll":if(e.sd)for(i=e.sd.length;i--;)h=e.sd[i],m[h[0]]=h.slice(1);if(e.lm)for(i=e.lm.length;i--;)switch(h=e.lm[i],c=h.slice(1),y=l.D6Axis[h[0]],t.setMotion(y,PhysX._emscripten_enum_PxD6MotionEnum_eLIMITED()),h[0]){case"rx":case"twist":s=this.angularLimit(c),t.setTwistLimit(s);break;case"ry":case"swing1":s=this.coneLimit(c),t.setSwingLimit(s);break;case"rz":case"swing2":s=this.coneLimit(c),t.setSwingLimit(s);break;default:s=this.linearLimit(c),t.setLinearLimit(y,s)}if(e.motion&&(e.motions=e.motion),e.motions)for(i=e.motions.length;i--;)a=e.motions[i],t.setMotion(l.D6Axis[a[0]],PhysX["_emscripten_enum_PxD6MotionEnum_e"+a[1].toUpperCase()]());if(e.drive&&(e.drives=e.drive),e.drives)for(i=e.drives.length;i--;)a=e.drives[i],"rx"===a[0]&&(a[0]="twist"),"ry"===a[0]&&(a[0]="swing"),"rz"===a[0]&&(a[0]="slerp"),o=new PhysX.PxD6JointDrive(a[1]||0,a[2]||0,a[3]||n,void 0!==a[4]?a[4]?1:0:1),t.setDrive(PhysX["_emscripten_enum_PxD6DriveEnum_e"+a[0].toUpperCase()](),o);e.drivePosition&&t.setDrivePosition(this.t1.fromArray(e.drivePosition.pos||[0,0,0],e.drivePosition.quat||[0,0,0,1]),p),e.driveVelocity&&t.setDriveVelocity(this.v1.fromArray(e.driveVelocity[0]),this.v2.fromArray(e.driveVelocity[1]),p),void 0!==e.distanceLimit&&(s=this.distanceLimit(e.distanceLimit),t.setDistanceLimit(s))}}distanceLimit(e){let t=new PhysX.PxJointLinearLimit(e[0]);return e.length>2&&this.sring(t,e),t}linearLimit(e){let t=new PhysX.PxJointLinearLimitPair(e[0],e[1]);return e.length>2&&this.sring(t,e),t}angularLimit(e){let t=new PhysX.PxJointAngularLimitPair(e[0]*r,e[1]*r);return e.length>2&&this.sring(t,e),t}coneLimit(e){let t=new PhysX.PxJointLimitCone(Math.abs(e[0])*r,Math.abs(e[1])*r);return e.length>2&&this.sring(t,e),t}pyramidLimit(e){let t=new PhysX.PxJointLimitPyramid(-e[0]*r,e[0]*r,-e[1]*r,e[1]*r);return this.sring(t,e),t}sring(e,t){void 0!==t[2]&&(e.stiffness=t[2]),void 0!==t[3]&&(e.damping=t[3]),void 0!==t[4]&&(e.restitution=t[4]),void 0!==t[5]&&(e.bounceThreshold=t[5]),void 0!==t[6]&&(e.contactDistance=t[6])}}class P extends c{constructor(){super(),this.type="solver",this.Utils=l}step(e,t){let s,i=this.list.length;for(;i--;)s=t+i*h[this.type],this.list[i].step(e,s)}add(e={}){this.setName(e);let t=new _(e);this.addToWorld(t,e.id)}set(e={},t=null){console.log("set ??")}}class _{constructor(e){this.angulars=["twist","swing1","swing2","TWIST","SWING1","SWING2"],this.name=e.name,this.type="solver",this.needData=e.needData||!1,this.cache=null,this.jid=0,this.useReducer=!0,this.chain=this.useReducer?i.world.createArticulationReducedCoordinate():i.world.createArticulation(),this.positionIters=void 0!==e.iteration?e.iteration:4,this.velocityIters=void 0!==e.velocityIteration?e.velocityIteration:1,this.chain.setSolverIterationCounts(this.positionIters,this.velocityIters),void 0!==e.fix&&this.chain.setArticulationFlag(PhysX.eFIX_BASE,e.fix),void 0!==e.driveLimite&&this.chain.setArticulationFlag(PhysX.eDRIVE_LIMITS_ARE_FORCES,e.driveLimite),void 0!==e.noCollision&&this.chain.setArticulationFlag(PhysX.eDISABLE_SELF_COLLISION,e.noCollision),void 0!==e.jointForce&&this.chain.setArticulationFlag(PhysX.eCOMPUTE_JOINT_FORCES,e.jointForce),void 0!==e.maxAngular&&this.chain.setMaxCOMAngularVelocity(e.maxAngular),void 0!==e.maxLinear&&this.chain.setMaxCOMLinearVelocity(e.maxLinear),void 0!==e.stabilization&&this.chain.setStabilizationThreshold(e.stabilization),this.t=new PhysX.PxTransform([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),this.bones={},this.joints=[]}step(e,t){if(!this.needData)return;let s,i=0;for(let r of this.joints)s=t+7*i,e[s+0]=r.getDriveTarget(l.solverAxis.x),e[s+1]=r.getDriveTarget(l.solverAxis.y),e[s+2]=r.getDriveTarget(l.solverAxis.z),e[s+3]=r.getDriveTarget(l.solverAxis.rx)*a,e[s+4]=r.getDriveTarget(l.solverAxis.ry)*a,e[s+5]=r.getDriveTarget(l.solverAxis.rz)*a,e[s+6]=0,i++}start(){this.chain.wakeUp(),i.scene.addArticulation(this.chain)}commonInit(e){this.chain.commonInit(),this.cache=this.chain.createCache();var t=new PhysX.PxArticulationCacheFlags(PhysX._emscripten_enum_PxArticulationCacheFlagEnum_eALL());this.chain.copyInternalStateToCache(this.cache,t),this.chain.computeGeneralizedGravityForce(this.cache),this.chain.computeCoriolisAndCentrifugalForce(this.cache),this.chain.computeJointAcceleration(this.cache),this.chain.computeJointForce(this.cache),this.chain.computeGeneralizedMassMatrix(this.cache),this.chain.computeCoefficientMatrix(this.cache),this.chain.computeGeneralizedExternalForce(this.cache)}release(){i.scene.removeArticulation(this.chain,!0),this.cache&&this.cache.release(),this.chain.release(),this.bones={},this.joints=[]}addBone(e,t,s){var i=null!==s?this.bones[s]:null,r=this.chain.createLink(i||null,t);return this.bones[e]=r,r}addTendon(e,t,s){this.chain.createFixedTendon(),this.chain.createSpatialTendon()}update(e){}addJoint(t){this.jid=this.joints.length;let s=t.name||this.name+"_Joint_"+this.jid,i=this.bones[t.bone].getInboundJoint();switch(t.type=void 0!==t.type?t.type:"fix",t.type){case"fixed":case"fixe":t.type="fix";break;case"slider":t.type="prismatic";break;case"hinge":t.type="revolute";break;case"ball":t.type="spherical";break;case"null":t.type="undefined"}i.setJointType(PhysX["_emscripten_enum_PxArticulationJointTypeEnum_e"+t.type.toUpperCase()]()),i.setParentPose(this.t.fromArray(t.pos1,t.quat1)),i.setChildPose(this.t.fromArray(t.pos2,t.quat2)),i.name=s,i.type="solverJoint",i.solver=this.name,this.joints.push(i),e.set(s,i),this.updateJoint(t,i)}updateJoint(e,t){let s,i,a,n;if(this.chain.wakeUp(),e.limits)for(s=e.limits.length;s--;){i=e.limits[s],n=-1!==this.angulars.indexOf(i[0])?r:1;let a=new PhysX.PxArticulationLimit(i[1]*n,i[2]*n);t.setLimitParams(l.solverAxis[i[0]],a),t.setMotion(l.solverAxis[i[0]],PhysX._emscripten_enum_PxArticulationMotionEnum_eLIMITED())}if(e.motions)for(s=e.motions.length;s--;)i=e.motions[s],t.setMotion(l.solverAxis[i[0]],PhysX["_emscripten_enum_PxArticulationMotionEnum_e"+i[1].toUpperCase()]());if(e.drives)for(s=e.drives.length;s--;){i=e.drives[s],a=void 0!==i[4]?"string"==typeof i[4]||i[4]instanceof String?PhysX["_emscripten_enum_PxArticulationDriveTypeEnum_e"+i[4].toUpperCase()]():i[4]?PhysX._emscripten_enum_PxArticulationDriveTypeEnum_eACCELERATION():PhysX._emscripten_enum_PxArticulationDriveTypeEnum_eFORCE():PhysX._emscripten_enum_PxArticulationDriveTypeEnum_eFORCE();let r=new PhysX.PxArticulationDrive(i[1]||0,i[2]||0,i[3],a);t.setDriveParams(l.solverAxis[i[0]],r)}if(e.drivesTarget)for(s=e.drivesTarget.length;s--;)i=e.drivesTarget[s],n=-1!==this.angulars.indexOf(i[0])?r:1,t.setDriveTarget(l.solverAxis[i[0]],i[1]*n);if(e.drivesTargetVelocity&&(e.drivesVelocity=e.drivesTargetVelocity),e.drivesVelocity)for(s=e.drivesVelocity.length;s--;)i=e.drivesVelocity[s],n=-1!==this.angulars.indexOf(i[0])?r:1,t.setDriveVelocity(l.solverAxis[i[0]],i[1]*n);void 0!==e.frictionCoefficient&&t.setFrictionCoefficient(e.frictionCoefficient),void 0!==e.maxJointVelocity&&t.setMaxJointVelocity(e.maxJointVelocity)}}class d extends c{constructor(){super(),this.Utils=l,this.type="contact"}step(e,t){let s,i,r=this.list.length;for(;r--;)s=this.list[r],i=t+r*h.contact,e[i]=l.byContact(s.cc)?1:0;l.clearContact()}add(e={}){this.setName(e);let t=this.byName(e.b1);if(null===t)return;i.setCollisionFilter(t,[4,5,11]);let s=new g(e);this.addToWorld(s,e.id)}}class g{constructor(e={}){this.type="contact",this.name=e.name,this.cc=e.b1+"_"+e.b2,this.b1=e.b1||null,this.b2=e.b2||null,this.ignore=e.ignore||[],this.result={hit:!1,point:[0,0,0],normal:[0,0,0],distance:0}}update(){}}class x extends c{constructor(){super(),this.type="vehicle",this.Utils=l}simulate(e){let t=this.list.length;for(;t--;)this.list[t].simulate(e)}step(e,t){let s,i=this.list.length;for(;i--;)s=t+i*h.vehicle,this.list[i].step(e,s)}add(e){this.setName(e);let t=new f(e);this.addToWorld(t,e.id)}set(e={},t=null){null===t&&(t=this.byName(e.name)),null!==t&&t.applyOption(e)}}class f{constructor(e){this.type="vehicle",this.name=e.name,this.numWheel=e.numWheel||4,this.wheelsPosition=e.wheelsPosition,this.radius=e.radius,this.radiusBack=e.radiusBack,this.deep=e.deep,this.deepBack=e.deepBack,this.massCenter=e.massCenter||[0,.55,1.594],this.chassisPos=e.chassisPos||[0,.83,0],this.t=new PhysX.PxTransform,this.key=[0,0,0,0,0,0,0,0],this.startPosition=e.pos||[0,3,0],this.startQuaternion=e.quat||[0,0,0,1],this.curentGear=0,this.autoGear=PhysX._emscripten_enum_PxVehicleEngineDriveTransmissionCommandStateEnum_eAUTOMATIC_GEAR(),this.motor=0,this.breaking=0,this.steering=0,this.data={mass:e.mass||2e3,incSteering:e.incSteering||2,maxSteering:e.maxSteering||24,acceleration:e.acceleration||10,breaking:e.breaking||100,engine:e.engine||1e3,topSpeed:e.topSpeed||1/0,coast:e.coast||!1},this.init(e)}init(e){this.carType=e.cartype||"fourWheelDrive",this.roadQueryType="sweep",this.suspensionJounceCalculation="sweep",this.vehicle=new PhysX.EngineDriveVehicle,this.vehicleSimulationContext=new PhysX.PxVehiclePhysXSimulationContext,this.chassisShape=e.chassisShape?i.bodyRef.shape(e.chassisShape):new PhysX.PxBoxGeometry(.85,.65,2.5),this.setBaseParams(),this.setPhysxIntegrationParams(),this.setEngineDriveParams(),this.vehicle.initialize(i.world,i.cookingParams,i.defaultMaterial,PhysX["_emscripten_enum_EngineDriveVehicleEnum_eDIFFTYPE_"+this.carType.toUpperCase()]()),this.vehicleActor=this.vehicle.get_physXState().get_physxActor().get_rigidBody(),this.startPose=(new PhysX.PxTransform).fromArray(this.startPosition,this.startQuaternion),this.vehicleActor.setGlobalPose(this.startPose),this.vehicleActor.setName(this.name),i.scene.addActor(this.vehicleActor),this.vehicle.get_engineDriveState().get_gearboxState().set_currentGear(this.vehicle.get_engineDriveParams().get_gearBoxParams().get_neutralGear()+1),this.vehicle.get_engineDriveState().get_gearboxState().set_targetGear(this.vehicle.get_engineDriveParams().get_gearBoxParams().get_neutralGear()+1),this.vehicle.get_transmissionCommandState().set_targetGear(0),this.vehicleSimulationContext.setToDefault(),this.vehicleSimulationContext.get_frame().set_lngAxis(PhysX._emscripten_enum_PxVehicleAxesEnum_ePosZ()),this.vehicleSimulationContext.get_frame().set_latAxis(PhysX._emscripten_enum_PxVehicleAxesEnum_ePosX()),this.vehicleSimulationContext.get_frame().set_vrtAxis(PhysX._emscripten_enum_PxVehicleAxesEnum_ePosY()),this.vehicleSimulationContext.get_scale().set_scale(1),this.vehicleSimulationContext.set_gravity(i.gravity),this.vehicleSimulationContext.set_physxScene(i.scene),this.vehicleSimulationContext.set_physxActorUpdateMode(PhysX._emscripten_enum_PxVehiclePhysXActorUpdateModeEnum_eAPPLY_ACCELERATION()),this.vehicleSimulationContext.set_physxUnitCylinderSweepMesh(PhysX.PxVehicleTopLevelFunctions.prototype.VehicleUnitCylinderSweepMeshCreate(this.vehicleSimulationContext.get_frame(),i.world,i.cookingParams)),console.log(this.vehicle),console.log(this.vehicle.get_physXParams()),console.log(this.vehicle.get_baseParams()),console.log(this.vehicle.get_physXState().get_physxActor()),console.log(this.vehicle.get_baseState()),console.log(this.vehicleSimulationContext),console.log(this.vehicle.get_commandState()),console.log(this.vehicle.get_engineDriveState()),console.log(this.vehicle.get_engineDriveState().get_engineState()),console.log(this.vehicle.get_transmissionCommandState())}validate(e,t){e||console.log("Bug on:",t)}setBaseParams(){const e=this.data;let t=0;const s=this.numWheel,i=this.vehicle.get_baseParams();let r=i.get_axleDescription();for(r.set_nbAxles(2),r.set_nbWheels(s),r.set_nbWheelsPerAxle(0,2),r.set_nbWheelsPerAxle(1,2),r.set_axleToWheelIds(0,0),r.set_axleToWheelIds(1,2),t=0;t<s;t++)r.set_wheelIdsInAxleOrder(t,t);let a=i.get_frame();a.set_latAxis(PhysX._emscripten_enum_PxVehicleAxesEnum_ePosX()),a.set_lngAxis(PhysX._emscripten_enum_PxVehicleAxesEnum_ePosZ()),a.set_vrtAxis(PhysX._emscripten_enum_PxVehicleAxesEnum_ePosY()),i.get_scale().set_scale(1);let n=i.get_rigidBodyParams();n.set_mass(e.mass),n.set_moi(new PhysX.PxVec3(3200,3400,750));let o=i.get_brakeResponseParams(0);for(o.set_maxResponse(2e3),t=0;t<s;t++)o.set_wheelResponseMultipliers(t,1);let l=i.get_brakeResponseParams(0);for(l.set_maxResponse(2e3),t=0;t<s;t++)l.set_wheelResponseMultipliers(t,t<2?1:0);let h=i.get_steerResponseParams();for(h.set_maxResponse(.5),t=0;t<s;t++)h.set_wheelResponseMultipliers(t,t<2?1:0);var c=i.get_ackermannParams(0);c.set_wheelIds(0,0),c.set_wheelIds(1,1),c.set_wheelBase(2.87),c.set_trackWidth(1.6),c.set_strength(1);let y=(new PhysX.PxTransform).fromArray([0,0,0]),m=new PhysX.PxVec3(0,-1,0);for(t=0;t<s;t++){let e=i.get_suspensionParams(t);this.t.fromArray(this.wheelsPosition[t]),e.set_suspensionAttachment(this.t),e.set_suspensionTravelDir(m),e.set_wheelAttachment(y),e.set_suspensionTravelDist(.25)}let p=i.get_suspensionStateCalculationParams();p.set_suspensionJounceCalculationType(PhysX["_emscripten_enum_PxVehicleSuspensionJounceCalculationTypeEnum_e"+this.suspensionJounceCalculation.toUpperCase()]()),p.set_limitSuspensionExpansionVelocity(!1);let u=new PhysX.PxVec3(0,0,-.11);for(t=0;t<s;t++){let e=i.get_suspensionComplianceParams(t);e.get_wheelToeAngle().addPair(0,0),e.get_wheelCamberAngle().addPair(0,0),e.get_suspForceAppPoint().addPair(0,u),e.get_tireForceAppPoint().addPair(0,u)}for(t=0;t<s;t++){let e=i.get_suspensionForceParams(t);e.set_damping(8e3),e.set_stiffness(32e3),e.set_sprungMass(500)}for(t=0;t<s;t++){let e=i.get_tireForceParams(t);e.set_longStiff(25e3),e.set_latStiffX(.01),e.set_latStiffY(12e4),e.set_camberStiff(0),e.set_restLoad(5500),PhysX.PxVehicleTireForceParamsExt.prototype.setFrictionVsSlip(e,0,0,0),PhysX.PxVehicleTireForceParamsExt.prototype.setFrictionVsSlip(e,0,1,1),PhysX.PxVehicleTireForceParamsExt.prototype.setFrictionVsSlip(e,1,0,.1),PhysX.PxVehicleTireForceParamsExt.prototype.setFrictionVsSlip(e,1,1,1),PhysX.PxVehicleTireForceParamsExt.prototype.setFrictionVsSlip(e,2,0,1),PhysX.PxVehicleTireForceParamsExt.prototype.setFrictionVsSlip(e,2,1,1),PhysX.PxVehicleTireForceParamsExt.prototype.setLoadFilter(e,0,0,0),PhysX.PxVehicleTireForceParamsExt.prototype.setLoadFilter(e,0,1,.23),PhysX.PxVehicleTireForceParamsExt.prototype.setLoadFilter(e,1,0,3),PhysX.PxVehicleTireForceParamsExt.prototype.setLoadFilter(e,1,1,3)}for(t=0;t<s;t++){let e=i.get_wheelParams(t),s=25,r=t<2?this.radius:this.radiusBack;e.set_mass(s),e.set_radius(r),e.set_halfWidth(.5*(t<2?this.deep:this.deepBack)),e.set_dampingRate(.25),e.set_moi(.5*s*r*r)}this.validate(i.isValid(),"baseParams")}setPhysxIntegrationParams(){const e=this.vehicle.get_baseParams(),t=this.vehicle.get_physXParams(),s=e.get_axleDescription();var r=new PhysX.PxFilterData(0,0,0,0),a=new PhysX.PxQueryFlags(PhysX._emscripten_enum_PxQueryFlagEnum_eSTATIC()),n=new PhysX.PxQueryFilterData(r,a),o=new PhysX.PxFilterData(1,4294967295,0,0),l=new PhysX.PxQueryFlags(PhysX._emscripten_enum_PxQueryFlagEnum_eDYNAMIC()),h=new PhysX.PxQueryFilterData(o,l);let c=(new PhysX.PxTransform).fromArray(this.massCenter),y=(new PhysX.PxTransform).fromArray(this.chassisPos),m=new PhysX.PxVehiclePhysXMaterialFriction;m.set_friction(1);let p=i.world.createMaterial(.5,.5,.5);m.set_material(p),t.create(s,n,null,m,1,1,c,this.chassisShape,y,PhysX["_emscripten_enum_PxVehiclePhysXRoadGeometryQueryTypeEnum_e"+this.roadQueryType.toUpperCase()]()),t.set_physxActorShapeFlags(i.bodyRef.setShapeFlag()),t.set_physxActorSimulationFilterData(h),this.validate(t.isValid(),"physxParams")}setEngineDriveParams(){const e=this.numWheel,t=this.vehicle.get_engineDriveParams();this.vehicle.get_baseParams().get_axleDescription();const s=t.get_autoboxParams();s.set_upRatios(0,.65),s.set_upRatios(1,.15),s.set_upRatios(2,.65),s.set_upRatios(3,.65),s.set_upRatios(4,.65),s.set_upRatios(5,.65),s.set_upRatios(6,.65),s.set_downRatios(0,.5),s.set_downRatios(1,.5),s.set_downRatios(2,.5),s.set_downRatios(3,.5),s.set_downRatios(4,.5),s.set_downRatios(5,.5),s.set_downRatios(6,.5),s.set_latency(2),t.get_clutchCommandResponseParams().set_maxResponse(10);const i=t.get_engineParams();i.get_torqueCurve().addPair(0,1),i.get_torqueCurve().addPair(.33,1),i.get_torqueCurve().addPair(1,1),i.set_moi(1),i.set_peakTorque(500),i.set_idleOmega(0),i.set_maxOmega(600),i.set_dampingRateFullThrottle(.15),i.set_dampingRateZeroThrottleClutchEngaged(2),i.set_dampingRateZeroThrottleClutchDisengaged(.35);const r=t.get_gearBoxParams();r.set_neutralGear(1),r.set_ratios(0,-4),r.set_ratios(1,0),r.set_ratios(2,4),r.set_ratios(3,2),r.set_ratios(4,1.5),r.set_ratios(5,1.1),r.set_ratios(6,1),r.set_nbRatios(7),r.set_finalRatio(4),r.set_switchTime(.5);const a=t.get_fourWheelDifferentialParams(),n=t.get_multiWheelDifferentialParams(),o=t.get_tankDifferentialParams();for(let t=0;t<e;t++)a.set_torqueRatios(t,.25),a.set_aveWheelSpeedRatios(t,.25),n.set_torqueRatios(t,.25),n.set_aveWheelSpeedRatios(t,.25),o.set_torqueRatios(t,.25),o.set_aveWheelSpeedRatios(t,.25);a.set_frontWheelIds(0,0),a.set_frontWheelIds(1,1),a.set_rearWheelIds(0,2),a.set_rearWheelIds(1,3),a.set_centerBias(1.3),a.set_centerTarget(1.29),a.set_frontBias(1.3),a.set_frontTarget(1.29),a.set_rearBias(1.3),a.set_rearTarget(1.29),a.set_rate(10);const l=t.get_clutchParams();l.set_accuracyMode(PhysX._emscripten_enum_PxVehicleClutchAccuracyModeEnum_eESTIMATE()),l.set_estimateIterations(5),this.validate(t.isValid(),"engineDriveParams")}respawn(e){}applyOption(e){e.key&&(this.key=e.key)}release(){console.log("delete car !!!")}simulate(e){let t=this.vehicleActor.getLinearVelocity(),s=this.vehicleActor.getGlobalPose().getBasis(),i=t.dot({x:s[6],y:s[7],z:s[8]})<5?3:1;this.vehicle.set_componentSequenceSubstepGroupHandle(i),this.vehicle.step(e,this.vehicleSimulationContext)}step(e,t){this.drive();const s=this.vehicle.get_baseState(),i=this.vehicle.get_physXParams();let r,a;for(this.vehicleActor.getGlobalPose().toArray(e,t+1),r=0;r<this.numWheel;r++){a=8*(r+1),s.get_wheelLocalPoses(r).localPose.toArray(e,t+a+1),e[t+a+2]+=this.massCenter[1]}i.get_physxActorBoxShapeLocalPose().toArray(e,t+48),i.get_physxActorCMassLocalPose().toArray(e,t+56)}drive(){const e=this.key,t=this.data;let s=this.vehicle.get_commandState();0===e[0]?Math.abs(this.steering)>.1?this.steering*=.9:this.steering=0:(this.steering-=t.incSteering*e[0],this.steering=o(this.steering,-t.maxSteering,t.maxSteering)),s.set_steer(this.steering*r),0===e[1]?this.breaking=1:(e[1]<0?this.vehicle.get_transmissionCommandState().set_targetGear(this.autoGear):this.vehicle.get_transmissionCommandState().set_targetGear(0),this.breaking=0),s.set_nbBrakes(1),s.set_brakes(0,this.breaking),s.set_throttle(Math.abs(e[1]))}}class v extends c{constructor(){super(),this.type="terrain",this.Utils=l}add(e){this.setName(e);let t=new A(e);this.addToWorld(t,e.id)}set(e={},t=null){null===t&&(t=this.byName(e.name)),null!==t&&t.set(e)}}class A{constructor(e){this.type="terrain",this.name=e.name,this.needUpdate=!1,this.heightField=null,this.init(e)}init(e){const t=e.size,s=[t[0]/(e.sample[0]-1),t[2]/(e.sample[1]-1)];this.fullSample=[e.sample[0],e.sample[1]],this.setDataTest(e);let r=new PhysX.PxMeshGeometryFlags(0),a=new PhysX.PxHeightFieldGeometry(this.heightField,r,1e-4*t[1],s[0],s[1]),n=i.world.createMaterial(e.staticFriction||.5,e.friction||.5,e.restitution||0),o=i.bodyRef.setShapeFlag(e.flags),l=i.world.createShape(a,n,!0,o),h=e.filter?e.filter:[2,-1,0,0];i.setFilter(l,h),PhysX.destroy(r),PhysX.destroy(o),PhysX.destroy(a),n.release();let c=(new PhysX.PxTransform).fromArray([e.pos[0]-.5*t[0],e.pos[1],e.pos[2]-.5*t[2]]);this.body=i.world.createRigidStatic(c),this.body.attachShape(l),l.release(),c.free(),i.scene.addActor(this.body)}setData(e){let t,s;const r=e.heightData,a=e.sample?e.sample:this.fullSample,n=e.decal?e.decal:[0,0],o=e.reverse||!1,l=e.shrink||!1;t=new PhysX.PxHeightFieldSample,s=new PhysX.Vector_PxHeightFieldSample;let h=r.length;for(;h--;)t.height=1e4*r[h],o&&t.setTessFlag(),s.push_back(t);const c=new PhysX.PxHeightFieldDesc;c.format=PhysX._emscripten_enum_PxHeightFieldFormatEnum_eS16_TM(),c.nbColumns=a[0],c.nbRows=a[1],c.samples.stride=4,c.samples.data=s.data(),this.heightField?this.heightField.modifySamples(n[0],n[1],c,l):this.heightField=i.cooking.createHeightField(c,i.world.getPhysicsInsertionCallback()),PhysX.destroy(c),PhysX.destroy(s),PhysX.destroy(t)}setDataTest(e){let t,s,r=e.heightData;const a=e.sample?e.sample:this.fullSample,n=e.decal?e.decal:[0,0],o=e.shrink||!1;s=new Uint32Array(r.length);let h=r.length,c=0;for(;h--;)s[h]=1e4*r[c],c++;const y=new PhysX.PxHeightFieldDesc;y.format=PhysX._emscripten_enum_PxHeightFieldFormatEnum_eS16_TM(),y.nbColumns=a[0],y.nbRows=a[1],t=l.malloc(s),y.samples.stride=s.BYTES_PER_ELEMENT,y.samples.data=t,this.heightField?this.heightField.modifySamples(n[0],n[1],y,o):this.heightField=i.cooking.createHeightField(y,i.world.getPhysicsInsertionCallback()),PhysX.destroy(y),l.free(t)}release(){i.scene.removeActor(this.body,!0),this.heightField&&this.heightField.release()}set(e){e.heightData&&this.setDataTest(e)}}class X extends p{constructor(){super(),this.type="character"}}let E;self.onmessage=function(e){he.message(e)};let w,F,S,C,T,D,I,L,R,M,V,k,N,B,G,U,z=!1,q=!1,O=!1,W="default";const J="undefined"==typeof performance?Date:performance,Q={tmp:0,n:0,dt:0,fps:0};let H,Y,j=1/60,Z=4,K=!0,$=0,ee=0,te=!0,se=null,ie=null,re={},ae=[],ne=[],oe=[],le=!0;class he{static test(){}static message(e){let t=e.data;t.Ar&&(w=t.Ar),t.flow&&(i.flow=t.flow),t.m&&he[t.m](t.o)}static post(e,t){T?self.postMessage(e,t):C({data:e})}static init(e={}){T=!0,O=e.isBuffer||!1,void 0!==e.fps&&(j=1/e.fps),void 0!==e.substep&&(Z=e.substep),e.returnMessage&&(C=e.returnMessage,T=!1,O=!1),e.blob&&importScripts(e.blob),PhysX().then((e=>{self.PhysX=e,l.extends(),he.initItems(),he.post({m:"ready",o:{}})}))}static set(e={}){F=e.ArPos,S=e.ArMax,E.body.setFull(e.full),q=e.outsideStep||!1,z=e.isTimeout||!1,j=1/(e.fps||60),Z=e.substep||1,K=void 0===e.fixe||e.fixe,i.substep=Z,void 0===e.filter||e.filter,W=void 0!==e.solver?e.solver:"default",k=void 0===e.pcm||e.pcm,N=void 0!==e.cdd&&e.ccd,B=void 0===e.gpu||e.gpu,G=void 0!==e.stabiliz&&e.stabiliz,U=void 0===e.mutable||e.mutable,i.gravity=new PhysX.PxVec3(0,-9.81,0),i.gravity.fromArray(e.gravity||[0,-9.8,0]),null===i.scene&&he.start()}static start(){null===i.world&&(w=new Float32Array(S),he.initWorld(),he.initScene()),te=!1,H=!1,ee=0,Y=0,q||(z?he.step():se=setInterval(he.step,1e3*j))}static initWorld(){D=new PhysX.PxDefaultAllocator,I=new PhysX.PxDefaultErrorCallback;let e=PhysX.PxTopLevelFunctions.prototype.PHYSICS_VERSION;if(le){let t=e.toString(16);t=t.substring(0,1)+"."+t.substring(1,3),console.log("PHYSX "+t),le=!1}L=PhysX.PxTopLevelFunctions.prototype.CreateFoundation(e,D,I),i.tolerances=new PhysX.PxTolerancesScale,i.world=PhysX.PxTopLevelFunctions.prototype.CreatePhysics(e,L,i.tolerances,!0,null),i.cookingParams=new PhysX.PxCookingParams(i.tolerances),i.cooking=PhysX.PxTopLevelFunctions.prototype.CreateCooking(e,L,i.cookingParams),i.defaultMaterial=i.world.createMaterial(.5,.5,i.restitution),PhysX.PxTopLevelFunctions.prototype.InitExtensions(i.world),PhysX.PxVehicleTopLevelFunctions.prototype.InitVehicleExtension(L),R=PhysX.PxTopLevelFunctions.prototype.DefaultCpuDispatcherCreate(0),M=new PhysX.PxFilterData(1,-1,0,0),i.setFilter=he.setFilter,i.setFilterData=he.setFilterData,i.setCollisionFilter=he.setCollisionFilter}static initScene(){if(null!==i.scene)return;let e=new PhysX.PxSceneDesc(i.tolerances);e.set_cpuDispatcher(R),e.gravity=i.gravity;let t=0;k&&(t|=PhysX._emscripten_enum_PxSceneFlagEnum_eENABLE_PCM()),N&&(t|=PhysX._emscripten_enum_PxRigidBodyFlagEnum_eENABLE_CCD()),G&&(t|=PhysX._emscripten_enum_PxSceneFlagEnum_eENABLE_STABILIZATION()),B&&(t|=PhysX._emscripten_enum_PxSceneFlagEnum_eENABLE_GPU_DYNAMICS()),U&&(t|=PhysX._emscripten_enum_PxSceneFlagEnum_eENABLE_ACTIVE_ACTORS(),t|=PhysX._emscripten_enum_PxSceneFlagEnum_eEXCLUDE_KINEMATICS_FROM_ACTIVE_ACTORS());let s=new PhysX.PxSceneFlags(t);e.flags=s,PhysX.destroy(s),e.set_solverType(PhysX["e"+("default"===W?"TGS":"PGS")]),e.set_filterShader(PhysX.PxTopLevelFunctions.prototype.DefaultFilterShader()),i.scene=i.world.createScene(e),PhysX.destroy(e),V=new PhysX.PxSimulationEventCallbackImpl,V.onContact=he.onContact,V.onTrigger=he.onTrigger,V.onConstraintBreak=he.onConstraintBreak,i.scene.setSimulationEventCallback(V)}static onWake(e,t){}static onConstraintBreak(e,t){}static onTrigger(e,t){if(Y<2)return;let s,i,r;for(;t--;)s=PhysX.NativeArrayHelpers.prototype.getTriggerPairAt(e,t),i=he.byPtr(s.triggerActor.ptr),r=he.byPtr(s.otherActor.ptr),i&&r&&(4===s.status&&(re[r+"_"+i]=!0),16===s.status&&(re[r+"_"+i]=!1))}static onContact(e,t,s){if(2!==Y)return;let i,r,a=PhysX.NativeArrayHelpers.prototype.getContactPairHeaderAt(e,0),n=a.get_actors(0),o=a.get_actors(1);for(;s--;)PhysX.NativeArrayHelpers.prototype.getContactPairAt(t,s),i=he.byPtr(n.ptr),r=he.byPtr(o.ptr),i&&r&&l.addContact(i+"_"+r)}static dispatch(){for(ne=i.flow.remove,ae=i.flow.add,oe=i.flow.tmp;ne.length>0;)this.remove(ne.shift());for(;ae.length>0;)this.add(ae.shift());for(;oe.length>0;)this.change(oe.shift());i.flow={key:[],add:[],remove:[],tmp:[]}}static poststep(){if(!te&&(Y=1,this.dispatch(),!q&&z)){let e=1e3*j-(J.now()-$);e<=0?he.step():ie=setTimeout(he.step,e)}}static step(e){if(H&&he.endReset(),te||Y>=2)return;Y=2,$=e||J.now(),i.delta=.001*($-ee),ee=$;let t=Z,s=K?j/Z:i.delta/Z;for(;t--;)E.vehicle.simulate(s),i.scene.simulate(s),i.scene.fetchResults(!0),Y++;he.stepItems(),$-1e3>Q.tmp&&(Q.tmp=$,i.reflow.stat.fps=Q.n,Q.n=0),Q.n++,i.reflow.stat.delta=i.delta,O?he.post({m:"step",reflow:i.reflow,Ar:w},[w.buffer]):he.post({m:"step",reflow:i.reflow,Ar:w})}static byName(e){return l.byName(e)}static byPtr(e){return l.byPtr(e)}static reset(){H=!0}static endReset(){he.stop(),he.resetItems(),this.clearGarbage(),this.clearScene(),this.clearWorld(),l.clear(),re={},he.post({m:"resetCallback",o:{}})}static clearScene(){null!==i.scene&&(i.scene.release(),i.scene=null)}static clearWorld(){null!==i.world&&(PhysX.destroy(i.tolerances),PhysX.destroy(M),PhysX.destroy(i.gravity),PhysX.PxTopLevelFunctions.prototype.CloseExtensions(),PhysX.PxVehicleTopLevelFunctions.prototype.CloseVehicleExtension(),PhysX.destroy(i.cookingParams),i.defaultMaterial.release(),i.cooking.release(),i.world.release(),L.release(),PhysX.destroy(I),PhysX.destroy(D),i.world=null,i.gravity=null)}static clearGarbage(){for(;i.garbage.length>0;)i.garbage.pop().release();i.garbage=[]}static stop(){te=!0,q||(ie&&clearTimeout(ie),se&&clearInterval(se),se=null,ie=null)}static pause(e){let t=e.value;t!==te&&(t?this.stop():this.start())}static setFilterData(e,t=[]){if(void 0!==t[1]&&t[1]<0&&(t[1]=4294967295),t[2]instanceof Array){let e,s;for(e=t[2].length,s=0;e--;)s|=1<<t[2][e]-1;t[2]=s}else t[2]<0&&(t[2]=4294967295);void 0!==t[3]&&(1===t[3]&&(t[3]=4294901760),-1===t[3]&&(t[3]=65535)),e.word0=void 0!==t[0]?t[0]:1,e.word1=void 0!==t[1]?t[1]:4294967295,e.word2=t[2]||0,e.word3=t[3]||0}static setFilter(e,t){he.setFilterData(M,t),e&&(e.setSimulationFilterData(M),e.setQueryFilterData(M))}static setShapes(e,t={}){let s,i=e.getNbShapes();for(;i--;)s=PhysX.SupportFunctions.prototype.PxActor_getShape(e,i),t.filter&&he.setFilter(s,t.filter),t.flag&&he.setFilter(s,t.flag)}static setCollisionFilter(e,t){let s=e.filter;s[2]=t,he.setShapes(e,{filter:s})}static initItems(){E={ray:new y,body:new p,solid:new ce,joint:new u,solver:new P,contact:new d,character:new X,vehicle:new x,terrain:new v},i.bodyRef=E.body,i.byName=he.byName}static resetItems(){for(const e in E)E[e].reset()}static stepItems(){for(var e in re)re[e]&&l.addContact(e);for(const e in E)E[e].step(w,F[e])}static add(e={}){let t=function(e){switch(e.type){case"plane":case"box":case"sphere":case"highSphere":case"cylinder":case"cone":case"capsule":case"mesh":case"convex":case"compound":case"null":return e.density||e.kinematic?"body":"solid";default:return e.type}}(e);E[t].add(e)}static remove(e={}){let t=he.byName(e.name);null!==t&&E[t.type].clear(t)}static change(e={}){let t=he.byName(e.name);null!==t&&("solverJoint"===t.type?he.byName(t.solver).updateJoint(e,t):E[t.type].set(e,t))}static addSolverJoint(e){let t=he.byName(e.solver);null!==t&&t.addJoint(e)}static startArticulation(e){let t=he.byName(e.name);null!==t&&t.start()}static commonInitArticulation(e){let t=he.byName(e.name);null!==t&&t.commonInit(e)}}class ce extends p{constructor(){super(),this.type="solid"}step(e,t){}}export{he as engine};
