!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("three")):"function"==typeof define&&define.amd?define(["exports","three"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).phy={},e.three)}(this,(function(e,t){"use strict";var r=function(e){var t,r=Object.prototype,s=r.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},i=n.iterator||"@@iterator",a=n.asyncIterator||"@@asyncIterator",o=n.toStringTag||"@@toStringTag";function l(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{l({},"")}catch(e){l=function(e,t,r){return e[t]=r}}function c(e,t,r,s){var n=t&&t.prototype instanceof g?t:g,i=Object.create(n.prototype),a=new E(s||[]);return i._invoke=function(e,t,r){var s=u;return function(n,i){if(s===p)throw new Error("Generator is already running");if(s===f){if("throw"===n)throw i;return L()}for(r.method=n,r.arg=i;;){var a=r.delegate;if(a){var o=S(a,r);if(o){if(o===m)continue;return o}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(s===u)throw s=f,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);s=p;var l=h(e,t,r);if("normal"===l.type){if(s=r.done?f:d,l.arg===m)continue;return{value:l.arg,done:r.done}}"throw"===l.type&&(s=f,r.method="throw",r.arg=l.arg)}}}(e,r,a),i}function h(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=c;var u="suspendedStart",d="suspendedYield",p="executing",f="completed",m={};function g(){}function y(){}function v(){}var w={};w[i]=function(){return this};var x=Object.getPrototypeOf,b=x&&x(x(I([])));b&&b!==r&&s.call(b,i)&&(w=b);var A=v.prototype=g.prototype=Object.create(w);function M(e){["next","throw","return"].forEach((function(t){l(e,t,(function(e){return this._invoke(t,e)}))}))}function T(e,t){function r(n,i,a,o){var l=h(e[n],e,i);if("throw"!==l.type){var c=l.arg,u=c.value;return u&&"object"==typeof u&&s.call(u,"__await")?t.resolve(u.__await).then((function(e){r("next",e,a,o)}),(function(e){r("throw",e,a,o)})):t.resolve(u).then((function(e){c.value=e,a(c)}),(function(e){return r("throw",e,a,o)}))}o(l.arg)}var n;this._invoke=function(e,s){function i(){return new t((function(t,n){r(e,s,t,n)}))}return n=n?n.then(i,i):i()}}function S(e,r){var s=e.iterator[r.method];if(s===t){if(r.delegate=null,"throw"===r.method){if(e.iterator.return&&(r.method="return",r.arg=t,S(e,r),"throw"===r.method))return m;r.method="throw",r.arg=new TypeError("The iterator does not provide a 'throw' method")}return m}var n=h(s,e.iterator,r.arg);if("throw"===n.type)return r.method="throw",r.arg=n.arg,r.delegate=null,m;var i=n.arg;return i?i.done?(r[e.resultName]=i.value,r.next=e.nextLoc,"return"!==r.method&&(r.method="next",r.arg=t),r.delegate=null,m):i:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,m)}function R(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function k(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function E(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(R,this),this.reset(!0)}function I(e){if(e){var r=e[i];if(r)return r.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,a=function r(){for(;++n<e.length;)if(s.call(e,n))return r.value=e[n],r.done=!1,r;return r.value=t,r.done=!0,r};return a.next=a}}return{next:L}}function L(){return{value:t,done:!0}}return y.prototype=A.constructor=v,v.constructor=y,y.displayName=l(v,o,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===y||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,v):(e.__proto__=v,l(e,o,"GeneratorFunction")),e.prototype=Object.create(A),e},e.awrap=function(e){return{__await:e}},M(T.prototype),T.prototype[a]=function(){return this},e.AsyncIterator=T,e.async=function(t,r,s,n,i){void 0===i&&(i=Promise);var a=new T(c(t,r,s,n),i);return e.isGeneratorFunction(r)?a:a.next().then((function(e){return e.done?e.value:a.next()}))},M(A),l(A,o,"Generator"),A[i]=function(){return this},A.toString=function(){return"[object Generator]"},e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var s=t.pop();if(s in e)return r.value=s,r.done=!1,r}return r.done=!0,r}},e.values=I,E.prototype={constructor:E,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach(k),!e)for(var r in this)"t"===r.charAt(0)&&s.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=t)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var r=this;function n(s,n){return o.type="throw",o.arg=e,r.next=s,n&&(r.method="next",r.arg=t),!!n}for(var i=this.tryEntries.length-1;i>=0;--i){var a=this.tryEntries[i],o=a.completion;if("root"===a.tryLoc)return n("end");if(a.tryLoc<=this.prev){var l=s.call(a,"catchLoc"),c=s.call(a,"finallyLoc");if(l&&c){if(this.prev<a.catchLoc)return n(a.catchLoc,!0);if(this.prev<a.finallyLoc)return n(a.finallyLoc)}else if(l){if(this.prev<a.catchLoc)return n(a.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return n(a.finallyLoc)}}}},abrupt:function(e,t){for(var r=this.tryEntries.length-1;r>=0;--r){var n=this.tryEntries[r];if(n.tryLoc<=this.prev&&s.call(n,"finallyLoc")&&this.prev<n.finallyLoc){var i=n;break}}i&&("break"===e||"continue"===e)&&i.tryLoc<=t&&t<=i.finallyLoc&&(i=null);var a=i?i.completion:{};return a.type=e,a.arg=t,i?(this.method="next",this.next=i.finallyLoc,m):this.complete(a)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),m},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),k(r),m}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var s=r.completion;if("throw"===s.type){var n=s.arg;k(r)}return n}}throw new Error("illegal catch attempt")},delegateYield:function(e,r,s){return this.delegate={iterator:I(e),resultName:r,nextLoc:s},"next"===this.method&&(this.arg=t),m}},e}("object"==typeof module?module.exports:{});try{regeneratorRuntime=r}catch(e){Function("r","regeneratorRuntime = r")(r)}const s=new Map,n={engine:"OIMO",scene:null,scenePlus:null,post:null,up:null,update:null,add:null,remove:null,tmpMesh:[],instanceMesh:{},tmpTex:[],flow:{tmp:[],key:[],add:[],remove:[]},reflow:{ray:[],stat:{fps:0}},extraMaterial:()=>{},disposeTmp:()=>{let e,t,r;for(e in n.tmpMesh){if(r=n.tmpMesh[e],r.children)for(t in r.children)n.disposeMesh(r.children[t]);n.disposeMesh(r),r.parent&&r.parent.remove(r)}for(e in n.tmpMesh=[],n.tmpTex)n.tmpTex[e].dispose()},disposeMesh:e=>{e.geometry&&e.geometry.dispose(),e.dispose&&e.dispose()}},i={byName:e=>s.has(e)?s.get(e):null,add:(e,t)=>{if("contact"!==e.type&&!e.isInstance&&e.isObject3D)if(t)t.add(e);else switch(e.type){case"terrain":case"solid":case"joint":case"ray":case"articulation":n.scenePlus.add(e);break;default:n.scene.add(e)}s.set(e.name,e)},remove:e=>{e.dispose&&e.dispose(),e.parent&&e.parent.remove(e),e.instance&&e.instance.remove(e.id),s.delete(e.name)}};let a=0,l={};const c=e=>{l["geo"+a++]=e},h=e=>{l[e.name]=e},u=(e,r={})=>{if(!l[e]){let r;switch(e){case"plane":r=new t.PlaneGeometry(1,1),r.rotateX(.5*-Math.PI);break;case"box":r=new t.BoxGeometry(1,1,1);break;case"sphere":r=new t.SphereGeometry(1,16,12);break;case"cylinder":r=new t.CylinderGeometry(1,1,1,16);break;case"cone":r=new t.CylinderGeometry(.001,1,1,16);break;case"joint":r=(new t.Box3Helper).geometry,r.scale(.05,.05,.05);break;default:return null}l[e]=r}return l[e]},d=()=>{for(let e in l)l[e].dispose();l={},a=0},p={metalness:.6,roughness:.3},f={body:new t.Color(16749391).convertSRGBToLinear(),sleep:new t.Color(4633033).convertSRGBToLinear()},m={},g=e=>{n.extraMaterial(e),m[e.name]=e},y=e=>{if(!m[e]){let r;switch(e){case"base":r=new t.MeshStandardMaterial({color:16777215,...p});break;case"simple":r=new t.MeshStandardMaterial({color:8421504,metalness:0,roughness:1});break;case"body":r=new t.MeshStandardMaterial({color:16749391,...p});break;case"sleep":r=new t.MeshStandardMaterial({color:4633033,...p});break;case"solid":r=new t.MeshStandardMaterial({color:3950411,...p});break;case"hero":r=new t.MeshStandardMaterial({color:65416,...p});break;case"skin":r=new t.MeshStandardMaterial({color:14724201,...p});break;case"chrome":r=new t.MeshStandardMaterial({color:13421772,metalness:1,roughness:0});break;case"glass":r=new t.MeshPhysicalMaterial({color:16777215,transparent:!0,opacity:.8,depthTest:!0,depthWrite:!1,roughness:.02,metalness:0,alphaToCoverage:!0,premultipliedAlpha:!0,transmission:1,clearcoat:1,thickness:.02});break;case"plexi":r=new t.MeshPhysicalMaterial({color:214748364,transparent:!0,opacity:.4});break;case"glass2":r=new t.MeshPhysicalMaterial({color:13421823,transparent:!0,opacity:.3});break;case"joint":r=new t.LineBasicMaterial({color:65280,toneMapped:!1});break;case"ray":r=new t.LineBasicMaterial({vertexColors:!0,toneMapped:!1});break;case"debug":r=new t.MeshBasicMaterial({color:0,wireframe:!0});break;case"debug2":r=new t.MeshBasicMaterial({color:65535,wireframe:!0});break;case"hide":r=new t.MeshBasicMaterial({visible:!1})}r.name=e,n.extraMaterial(r),m[e]=r}return m[e]},v=()=>{for(let e in m)m[e].dispose(),delete m[e]},w=Math.PI/180,x=new t.Euler,b=new t.Quaternion,A={torad:Math.PI/180,todeg:180/Math.PI,Pi:Math.PI,TwoPI:2*Math.PI,PI90:.5*Math.PI,PI45:.25*Math.PI,PI270:.5*Math.PI*3,inv255:.003921569,golden:1.618033,epsilon:Math.pow(2,-52),tmpE:new t.Euler,tmpM:new t.Matrix4,tmpM2:new t.Matrix4,tmpQ:new t.Quaternion,tmpV:new t.Vector3,clampA:(e,t,r)=>Math.max(t,Math.min(r,e)),clamp:(e,t,r)=>e=(e=e<t?t:e)>r?r:e,int:e=>Math.floor(e),toFixed:(e,t=3)=>1*e.toFixed(t),lerp:(e,t,r)=>(1-r)*e+r*t,lerpAr:(e,t,r,s)=>{let n=e.length;for(;n--;)e[n]=A.lerp(t[n],r[n],s)},randomSign:()=>Math.random()<.5?-1:1,randSpread:e=>e*(.5-Math.random()),rand:(e=0,t=1)=>e+Math.random()*(t-e),randInt:(e,t)=>e+Math.floor(Math.random()*(t-e+1)),nearEquals:(e,t,r)=>Math.abs(e-t)<=r,angleDistance:(e,t)=>{var r=(e-t+180)%360-180;return r<-180?r+360:r},unwrapDeg:e=>e-360*Math.floor((e+180)/360),unwrapRad:e=>e-2*Math.floor((e+Math.PI)/(2*Math.PI))*Math.PI,autoSize:(e=[1,1,1],t="box")=>{1===e.length&&(e[1]=e[0]);let r=e[0],s=e[1];return"sphere"===t&&(e=[r,r,r]),"cylinder"!==t&&"wheel"!==t&&"capsule"!==t||(e=[r,s,r]),"cone"!==t&&"pyramid"!==t||(e=[r,s,r]),2===e.length&&(e[2]=e[0]),e},toQuatArray:(e=[0,0,0])=>b.setFromEuler(x.fromArray(A.vectorad(e))).toArray(),toLocalQuatArray:(e=[0,0,0],t)=>(b.setFromEuler(x.fromArray(A.vectorad(e))),b.premultiply(t.quaternion.invert()),b.toArray()),vecAdd:(e,t)=>{let r=e.length,s=[];for(;r--;)s[r]=e[r]+t[r];return s},vecSub:(e,t)=>{let r=e.length,s=[];for(;r--;)s[r]=e[r]-t[r];return s},addArray:(e,t)=>A.vecAdd(e,t),vectorad:e=>{let t=3,r=[];for(;t--;)r[t]=e[t]*w;return r[3]=e[3],r},scaleArray:(e,t)=>{for(var r=e.length;r--;)e[r]*=t;return e},getIndex:e=>e.index.array||null,getVertex:(e,t)=>{let r=e.attributes.position.array;if(t){r=e.clone().toNonIndexed().attributes.position.array}return r},arCopy:(e,t)=>{},fromTransformToQ:(e,t,r)=>(r=r||!1,A.tmpM.compose(A.tmpV.fromArray(e),A.tmpQ.fromArray(t),{x:1,y:1,z:1}),A.tmpM.decompose(A.tmpV,A.tmpQ,{x:1,y:1,z:1}),r&&A.tmpQ.invert(),A.tmpQ.toArray()),fromTransform:(e,t,r,s,n)=>(n=n||!1,s=s||[0,0,0,1],A.tmpM.compose(A.tmpV.fromArray(e),A.tmpQ.fromArray(t),{x:1,y:1,z:1}),A.tmpM2.compose(A.tmpV.fromArray(r),A.tmpQ.fromArray(s),{x:1,y:1,z:1}),n?(A.tmpM.invert(),A.tmpM.multiply(A.tmpM2)):A.tmpM.multiply(A.tmpM2),A.tmpM.decompose(A.tmpV,A.tmpQ,{x:1,y:1,z:1}),A.tmpV.toArray()),axisToQuatArray:(e,t)=>(t=t||!1,A.tmpQ.setFromAxisAngle(A.tmpV.fromArray(e,1),t?e[0]*A.torad:e[0]).normalize().toArray()),toQuatArray:e=>A.tmpQ.setFromEuler(A.tmpE.fromArray(A.vectorad(e))).toArray()},M=2e3,T=100,S=50,R=50,k=20,E=20,I=20,L={bodyFull:14,body:8,joint:16,contact:8,ray:8,character:16,vehicle:64,solver:256};class P{constructor(){this.id=0,this.list=[],this.type="item",this.Utils=null}reset(){let e=this.list.length;for(;e--;)this.dispose(this.list[e]);this.id=0,this.list=[]}byName(e){return this.Utils.byName(e)}setName(e={}){let t=void 0!==e.name?e.name:this.type+this.id++;return e.id=this.remove(t,!0),e.name=t,t}addToWorld(e,t=-1){this.Utils.add(e),-1!==t?this.list[t]=e:this.list.push(e)}remove(e,t){let r=this.byName(e);return r?this.clear(r,t):-1}clear(e,t){let r=this.list.indexOf(e);return-1===r||t?this.list[r]=null:this.list.splice(r,1),this.dispose(e),r}dispose(e){null!==e&&this.Utils.remove(e)}add(e={}){}set(e={}){}step(e,t){}}class C extends P{constructor(){super(),this.Utils=i,this.type="ray"}step(e,t){let r,s,i=this.list.length;for(;i--;)r=this.list[i],s=t+i*L.ray,r.update(e,s,n.reflow.ray[i]||null),r.begin.toArray(e,s+1),r.end.toArray(e,s+4)}add(e={}){this.setName(e),e.link&&"string"!=typeof e.link&&(e.link=e.link.name);let t=new _(e,y("ray"));return t.visible=void 0===e.visible||e.visible,this.addToWorld(t,e.id),e.parent&&delete e.parent,e.callback&&delete e.callback,n.post({m:"add",o:e}),t}set(e={},t=null){null===t&&(t=this.byName(e.name)),null!==t&&(void 0!==e.begin&&t._begin.fromrray(e.begin),void 0!==e.end&&t._end.fromrray(e.end))}}class _ extends t.Line{constructor(e={},r){super(new t.BufferGeometry,r),this.data={hit:!1,body:"",point:[0,0,0],normal:[0,0,0],distance:0},this.type="ray",this.name=e.name,"string"==typeof e.parent&&(e.parent=i.byName(e.parent)),this.linked=void 0!==e.parent,this.linked&&(this.parent=e.parent),this.callback=e.callback||function(){},this.matrix=this.linked?this.parent.matrixWorld:new t.Matrix4,this.inv=new t.Matrix4,this.c0=[.1,.1,.3],this.c1=[.1,.4,.6],this.c2=[1,.1,.1],this.c3=[.4,.1,.1],this._begin=(new t.Vector3).fromArray(e.begin||[0,3,0]),this._end=(new t.Vector3).fromArray(e.end||[0,0,0]),this.begin=(new t.Vector3).copy(this._begin),this.end=(new t.Vector3).copy(this._end),this.tmp=new t.Vector3,this.normal=new t.Vector3;this.geometry.setAttribute("position",new t.Float32BufferAttribute([0,0,0,0,0,0,0,0,0],3)),this.geometry.setAttribute("color",new t.Float32BufferAttribute([0,0,0,0,0,0,0,0,0],3)),this.vertices=this.geometry.attributes.position,this.colors=this.geometry.attributes.color,this.local=[0,0,0,0,0,0],this.updateGeometry(),this.matrixAutoUpdate=!1}update(e,t=0,r=null){if(this.linked?(this.inv.copy(this.matrix).invert(),this.begin.copy(this._begin).applyMatrix4(this.matrix),this.end.copy(this._end).applyMatrix4(this.matrix)):this.updateMatrix(),this.data.hit=0!==e[t],this.data.body=r||"",this.data.hit){this.tmp.fromArray(e,t+1),this.normal.fromArray(e,t+4),this.linked&&(this.tmp.applyMatrix4(this.inv),this.inv.extractRotation(this.inv),this.normal.applyMatrix4(this.inv)),this.data.point=this.tmp.toArray(),this.data.normal=this.normal.toArray(),this.data.distance=this._begin.distanceTo(this.tmp),this.tmp.toArray(this.local,0);let r=this.tmp.distanceTo(this._end);this.tmp.addScaledVector(this.normal,r),this.tmp.toArray(this.local,3)}this.updateGeometry(),this.callback(this.data)}dispose(){this.geometry.dispose()}updateGeometry(){if(!this.visible)return;let e,t,r,s=this.vertices.array,n=this.colors.array,i=this.local;if(this.data.hit)n[3]=n[6]=this.c2[0],n[4]=n[7]=this.c2[1],n[5]=n[8]=this.c2[2],n[6]=this.c3[0],n[7]=this.c3[1],n[8]=this.c3[2],s[0]=this._begin.x,s[1]=this._begin.y,s[2]=this._begin.z,s[3]=i[0],s[4]=i[1],s[5]=i[2],s[6]=i[3],s[7]=i[4],s[8]=i[5];else for(r=3;r--;)e=3*r,t=0===r,n[e]=t?this.c0[0]:this.c1[0],n[e+1]=t?this.c0[1]:this.c1[1],n[e+2]=t?this.c0[2]:this.c1[2],s[e]=t?this._begin.x:this._end.x,s[e+1]=t?this._begin.y:this._end.y,s[e+2]=t?this._begin.z:this._end.z;this.vertices.needsUpdate=!0,this.colors.needsUpdate=!0}}_.prototype.isRay=!0;let F=0;const B=new t.Vector3,D=new t.Quaternion,O=new t.Matrix4,N=new t.Vector3,z=new t.Vector3,U=new t.Vector3,G=new t.Quaternion,V=new t.Vector3(1,0,0),H=new t.Vector3(0,1,0),j=new t.Vector3(0,0,1),W={type:"added"},X={type:"removed"};class q extends t.EventDispatcher{constructor(){super(),this.isObject3D=!0,Object.defineProperty(this,"id",{value:F++}),this.uuid=t.MathUtils.generateUUID(),this.isRay=!0,this.matrix=new t.Matrix4,this.matrixWorld=new t.Matrix4,this.name="",this.type="Object3D",this.children=[],this.parent=null,this.position=new t.Vector3,this.quaternion=new t.Quaternion,this.scale=new t.Vector3(1,1,1),this.isKinematic=!1,this.matrixAutoUpdate=!1,this.matrixWorldNeedsUpdate=!1,this.layers=new t.Layers,this.visible=!0,this.isVisible=!0,this.frustumCulled=!0,this.renderOrder=0,this.shapetype="box",this.size=[1,1,1],this.velocity=new t.Vector3,this.angular=new t.Vector3,this.defMat=!1,this.actif=!1,this.auto=!1,this.sleep=!1,this.mesh=null,this.linked=[]}select(e){}dispose(){this.traverse((function(e){e.isMesh&&e.unic&&e.geometry.dispose()})),this.children=[]}set receiveShadow(e){this.traverse((function(t){t.isMesh&&(t.receiveShadow=e)}))}get receiveShadow(){return!!this.children[0]&&this.children[0].receiveShadow}set castShadow(e){this.traverse((function(t){t.isMesh&&(t.castShadow=e)}))}get castShadow(){return!!this.children[0]&&this.children[0].castShadow}set material(e){this.traverse((function(t){t.isMesh&&(t.material=e)}))}get material(){return this.children,this.children[0]?this.children[0].material:null}onBeforeRender(){}onAfterRender(){}applyMatrix4(e){this.matrixAutoUpdate&&this.updateMatrix(),this.matrix.premultiply(e),this.matrix.decompose(this.position,this.quaternion,this.scale)}applyQuaternion(e){return this.quaternion.premultiply(e),this}setRotationFromAxisAngle(e,t){this.quaternion.setFromAxisAngle(e,t)}setRotationFromEuler(e){this.quaternion.setFromEuler(e,!0)}setRotationFromMatrix(e){this.quaternion.setFromRotationMatrix(e)}setRotationFromQuaternion(e){this.quaternion.copy(e)}rotateOnAxis(e,t){return D.setFromAxisAngle(e,t),this.quaternion.multiply(D),this}rotateOnWorldAxis(e,t){return D.setFromAxisAngle(e,t),this.quaternion.premultiply(D),this}rotateX(e){return this.rotateOnAxis(V,e)}rotateY(e){return this.rotateOnAxis(H,e)}rotateZ(e){return this.rotateOnAxis(j,e)}translateOnAxis(e,t){return B.copy(e).applyQuaternion(this.quaternion),this.position.add(B.multiplyScalar(t)),this}translateX(e){return this.translateOnAxis(V,e)}translateY(e){return this.translateOnAxis(H,e)}translateZ(e){return this.translateOnAxis(j,e)}localToWorld(e){return e.applyMatrix4(this.matrixWorld)}worldToLocal(e){return e.applyMatrix4(O.copy(this.matrixWorld).invert())}lookAt(e,t,r){e.isVector3?N.copy(e):N.set(e,t,r);const s=this.parent;this.updateWorldMatrix(!0,!1),z.setFromMatrixPosition(this.matrixWorld),this.isCamera||this.isLight?O.lookAt(z,N,this.up):O.lookAt(N,z,this.up),this.quaternion.setFromRotationMatrix(O),s&&(O.extractRotation(s.matrixWorld),D.setFromRotationMatrix(O),this.quaternion.premultiply(D.invert()))}add(e){if(arguments.length>1){for(let e=0;e<arguments.length;e++)this.add(arguments[e]);return this}return e===this?(console.error("THREE.Object3D.add: object can't be added as a child of itself.",e),this):(e&&e.isObject3D?(null!==e.parent&&e.parent.remove(e),e.parent=this,this.children.push(e),e.dispatchEvent(W)):console.error("THREE.Object3D.add: object not an instance of THREE.Object3D.",e),this)}remove(e){if(arguments.length>1){for(let e=0;e<arguments.length;e++)this.remove(arguments[e]);return this}const t=this.children.indexOf(e);return-1!==t&&(e.parent=null,this.children.splice(t,1),e.dispatchEvent(X)),this}removeFromParent(){const e=this.parent;return null!==e&&e.remove(this),this}clear(){const e=this.children;let t=e.length;for(;t--;){const r=e[t];r.parent=null,r.dispatchEvent(X)}return this.children.length=0,this}attach(e){return this.updateWorldMatrix(!0,!1),O.copy(this.matrixWorld).invert(),null!==e.parent&&(e.parent.updateWorldMatrix(!0,!1),O.multiply(e.parent.matrixWorld)),e.applyMatrix4(O),this.add(e),e.updateWorldMatrix(!1,!0),this}getObjectById(e){return this.getObjectByProperty("id",e)}getObjectByName(e){return this.getObjectByProperty("name",e)}getObjectByProperty(e,t){if(this[e]===t)return this;const r=this.children;let s=r.length;for(;s--;){const n=r[s].getObjectByProperty(e,t);if(void 0!==n)return n}}getWorldPosition(e){return this.updateWorldMatrix(!0,!1),e.setFromMatrixPosition(this.matrixWorld)}getWorldQuaternion(e){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(z,e,U),e}getWorldScale(e){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(z,G,e),e}getWorldDirection(e){this.updateWorldMatrix(!0,!1);const t=this.matrixWorld.elements;return e.set(t[8],t[9],t[10]).normalize()}setRaycast(e){if(void 0!==e&&(this.isRay=e),!this.isRay){let e=this.children.length;for(;e--;)this.children[e].raycast=()=>{}}}raycast(e,t){if(!this.isRay)return;const r=this.children;let s=r.length;for(;s--;)r[s].layers.test(e.layers)&&r[s].raycast(e,t)}traverse(e){e(this);const t=this.children;let r=t.length;for(;r--;)t[r].traverse(e)}traverseVisible(e){if(!1===this.visible)return;e(this);const t=this.children;let r=t.length;for(;r--;)t[r].traverseVisible(e)}traverseAncestors(e){const t=this.parent;null!==t&&(e(t),t.traverseAncestors(e))}updateMatrix(){this.matrix.compose(this.position,this.quaternion,this.scale),this.matrixWorldNeedsUpdate=!0}updateMatrixWorld(e){this.matrixAutoUpdate&&this.updateMatrix(),(this.matrixWorldNeedsUpdate||e)&&(null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),this.matrixWorldNeedsUpdate=!1,e=!0);const t=this.children;let r=t.length;for(;r--;)t[r].updateMatrixWorld(e)}updateWorldMatrix(e,t){const r=this.parent;if(!0===e&&null!==r&&r.updateWorldMatrix(!0,!1),this.matrixAutoUpdate&&this.updateMatrix(),null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),!0===t){const e=this.children;let t=e.length;for(;t--;)e[t].updateWorldMatrix(!1,!0)}}}class K extends t.InstancedMesh{constructor(e,r,s=0){super(e,r,s),this.matrixAutoUpdate=!1,this.tmpMatrix=new t.Matrix4,this.tmpQuat=new t.Quaternion,this.isRay=!0}getInfo(e){this.tmpMatrix.fromArray(this.instanceMatrix.array,16*e);let t={x:0,y:0,z:0},r={x:0,y:0,z:0};return this.tmpMatrix.decompose(t,this.tmpQuat,r),{pos:[t.x,t.y,t.z],quat:this.tmpQuat.toArray(),scale:[r.x,r.y,r.z]}}add(e=[0,0,0],r=[0,0,0,1],s=[1,1,1],n){3===r.length&&(r=this.tmpQuat.setFromEuler({_x:r[0],_y:r[1],_z:r[2],_order:"XYZ"},!1).toArray()),n&&(n.isColor&&(n=n.toArray()),null===this.instanceColor&&(this.instanceColor=new t.InstancedBufferAttribute(new Float32Array(3*this.instanceMatrix.count),3))),this.expand(e,r,s,n)}setColorAt(e,r){null===this.instanceColor&&(this.instanceColor=new t.InstancedBufferAttribute(new Float32Array(3*this.instanceMatrix.count),3)),r.isColor&&(r=r.toArray());let s=3*e;this.instanceColor.array[s]=r[0],this.instanceColor.array[s+1]=r[1],this.instanceColor.array[s+2]=r[2]}remove(e){if(!this.count)return;let r=[...this.instanceMatrix.array];r.splice(16*e,16),this.instanceMatrix=new t.InstancedBufferAttribute(new Float32Array(r),16),null!==this.instanceColor&&(r=[...this.instanceColor.array],r.splice(3*e,3),this.instanceColor=new t.InstancedBufferAttribute(new Float32Array(r),3)),this.count--}expand(e,r,s,n=[1,1,1]){let i=null!==this.instanceMatrix?this.instanceMatrix.array:[];this.tmpMatrix.compose({x:e[0],y:e[1],z:e[2]},{_x:r[0],_y:r[1],_z:r[2],_w:r[3]},{x:s[0],y:s[1],z:s[2]}),this.instanceMatrix=new t.InstancedBufferAttribute(new Float32Array([...i,...this.tmpMatrix.toArray()]),16),this.instanceMatrix.setUsage(t.DynamicDrawUsage),null!==this.instanceColor&&(i=this.instanceColor.array,this.instanceColor=new t.InstancedBufferAttribute(new Float32Array([...i,...n]),3)),this.count++}setTransformAt(e,t,r,s){this.tmpMatrix.compose({x:t[0],y:t[1],z:t[2]},{_x:r[0],_y:r[1],_z:r[2],_w:r[3]},{x:s[0],y:s[1],z:s[2]}),this.tmpMatrix.toArray(this.instanceMatrix.array,16*e)}dispose(){this.parent.remove(this),this.geometry.dispose(),this.instanceColor=null,this.count=0,this.dispatchEvent({type:"dispose"})}setRaycast(e){void 0!==e&&(this.isRay=e)}raycast(e,t){this.isRay&&super.raycast(e,t)}update(){this.instanceMatrix&&(this.instanceMatrix.needsUpdate=!0),this.instanceColor&&(this.instanceColor.needsUpdate=!0)}}function Q(e,r=!1){const s=null!==e[0].index,n=new Set(Object.keys(e[0].attributes)),i=new Set(Object.keys(e[0].morphAttributes)),a={},o={},l=e[0].morphTargetsRelative,c=new t.BufferGeometry;let h=0;for(let t=0;t<e.length;++t){const u=e[t];let d=0;if(s!==(null!==u.index))return console.error("THREE.BufferGeometryUtils: .mergeBufferGeometries() failed with geometry at index "+t+". All geometries must have compatible attributes; make sure index attribute exists among all geometries, or in none of them."),null;for(const e in u.attributes){if(!n.has(e))return console.error("THREE.BufferGeometryUtils: .mergeBufferGeometries() failed with geometry at index "+t+'. All geometries must have compatible attributes; make sure "'+e+'" attribute exists among all geometries, or in none of them.'),null;void 0===a[e]&&(a[e]=[]),a[e].push(u.attributes[e]),d++}if(d!==n.size)return console.error("THREE.BufferGeometryUtils: .mergeBufferGeometries() failed with geometry at index "+t+". Make sure all geometries have the same number of attributes."),null;if(l!==u.morphTargetsRelative)return console.error("THREE.BufferGeometryUtils: .mergeBufferGeometries() failed with geometry at index "+t+". .morphTargetsRelative must be consistent throughout all geometries."),null;for(const e in u.morphAttributes){if(!i.has(e))return console.error("THREE.BufferGeometryUtils: .mergeBufferGeometries() failed with geometry at index "+t+".  .morphAttributes must be consistent throughout all geometries."),null;void 0===o[e]&&(o[e]=[]),o[e].push(u.morphAttributes[e])}if(r){let e;if(s)e=u.index.count;else{if(void 0===u.attributes.position)return console.error("THREE.BufferGeometryUtils: .mergeBufferGeometries() failed with geometry at index "+t+". The geometry must have either an index or a position attribute"),null;e=u.attributes.position.count}c.addGroup(h,e,u.forceMatId||t),h+=e}}if(s){let t=0;const r=[];for(let s=0;s<e.length;++s){const n=e[s].index;for(let e=0;e<n.count;++e)r.push(n.getX(e)+t);t+=e[s].attributes.position.count}c.setIndex(r)}for(const e in a){const t=Y(a[e]);if(!t)return console.error("THREE.BufferGeometryUtils: .mergeBufferGeometries() failed while trying to merge the "+e+" attribute."),null;c.setAttribute(e,t)}for(const e in o){const t=o[e][0].length;if(0===t)break;c.morphAttributes=c.morphAttributes||{},c.morphAttributes[e]=[];for(let r=0;r<t;++r){const t=[];for(let s=0;s<o[e].length;++s)t.push(o[e][s][r]);const s=Y(t);if(!s)return console.error("THREE.BufferGeometryUtils: .mergeBufferGeometries() failed while trying to merge the "+e+" morphAttribute."),null;c.morphAttributes[e].push(s)}}return c}function Y(e){let r,s,n,i=0;for(let t=0;t<e.length;++t){const a=e[t];if(a.isInterleavedBufferAttribute)return console.error("THREE.BufferGeometryUtils: .mergeBufferAttributes() failed. InterleavedBufferAttributes are not supported."),null;if(void 0===r&&(r=a.array.constructor),r!==a.array.constructor)return console.error("THREE.BufferGeometryUtils: .mergeBufferAttributes() failed. BufferAttribute.array must be of consistent array types across matching attributes."),null;if(void 0===s&&(s=a.itemSize),s!==a.itemSize)return console.error("THREE.BufferGeometryUtils: .mergeBufferAttributes() failed. BufferAttribute.itemSize must be consistent across matching attributes."),null;if(void 0===n&&(n=a.normalized),n!==a.normalized)return console.error("THREE.BufferGeometryUtils: .mergeBufferAttributes() failed. BufferAttribute.normalized must be consistent across matching attributes."),null;i+=a.array.length}const a=new r(i);let o=0;for(let t=0;t<e.length;++t)a.set(e[t].array,o),o+=e[t].array.length;return new t.BufferAttribute(a,s,n)}function Z(e,r=1e-4){r=Math.max(r,Number.EPSILON);const s={},n=e.getIndex(),i=e.getAttribute("position"),a=n?n.count:i.count;let o=0;const l=Object.keys(e.attributes),c={},h={},u=[],d=["getX","getY","getZ","getW"],p=["setX","setY","setZ","setW"];for(let r=0,s=l.length;r<s;r++){const s=l[r],n=e.attributes[s];c[s]=new t.BufferAttribute(new n.array.constructor(n.count*n.itemSize),n.itemSize,n.normalized);const i=e.morphAttributes[s];i&&(h[s]=new t.BufferAttribute(new i.array.constructor(i.count*i.itemSize),i.itemSize,i.normalized))}const f=Math.log10(1/r),m=Math.pow(10,f);for(let t=0;t<a;t++){const r=n?n.getX(t):t;let i="";for(let t=0,s=l.length;t<s;t++){const s=l[t],n=e.getAttribute(s),a=n.itemSize;for(let e=0;e<a;e++)i+=~~(n[d[e]](r)*m)+","}if(i in s)u.push(s[i]);else{for(let t=0,s=l.length;t<s;t++){const s=l[t],n=e.getAttribute(s),i=e.morphAttributes[s],a=n.itemSize,u=c[s],f=h[s];for(let e=0;e<a;e++){const t=d[e],s=p[e];if(u[s](o,n[t](r)),i)for(let e=0,n=i.length;e<n;e++)f[e][s](o,i[e][t](r))}}s[i]=o,u.push(o),o++}}const g=e.clone();for(const r in e.attributes){const e=c[r];if(g.setAttribute(r,new t.BufferAttribute(e.array.slice(0,o*e.itemSize),e.itemSize,e.normalized)),r in h)for(let e=0;e<h[r].length;e++){const s=h[r][e];g.morphAttributes[r][e]=new t.BufferAttribute(s.array.slice(0,o*s.itemSize),s.itemSize,s.normalized)}}return g.setIndex(u),g}function J(e,r){if(r===t.TrianglesDrawMode)return console.warn("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Geometry already defined as triangles."),e;if(r===t.TriangleFanDrawMode||r===t.TriangleStripDrawMode){let s=e.getIndex();if(null===s){const t=[],r=e.getAttribute("position");if(void 0===r)return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),e;for(let e=0;e<r.count;e++)t.push(e);e.setIndex(t),s=e.getIndex()}const n=s.count-2,i=[];if(r===t.TriangleFanDrawMode)for(let e=1;e<=n;e++)i.push(s.getX(0)),i.push(s.getX(e)),i.push(s.getX(e+1));else for(let e=0;e<n;e++)e%2==0?(i.push(s.getX(e)),i.push(s.getX(e+1)),i.push(s.getX(e+2))):(i.push(s.getX(e+2)),i.push(s.getX(e+1)),i.push(s.getX(e)));i.length/3!==n&&console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");const a=e.clone();return a.setIndex(i),a.clearGroups(),a}return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unknown draw mode:",r),e}class $ extends t.BufferGeometry{constructor(e=1,r=10,s=10,n=10,i=1){super(),this.type="SphereBox",this.name="SphereBox_"+e+"_"+r+"_"+s+"_"+n+"_"+i,e=e||1,r=Math.floor(r),s=Math.floor(s),n=Math.floor(n);let a,o=new t.BoxGeometry(1,1,1,r,s,n),l=new t.Vector3,c=new t.Vector3,h=o.attributes.position.array,u=o.attributes.normal.array;for(let t=0,r=o.attributes.position.count;t<r;t++)a=3*t,l.set(h[a],h[a+1],h[a+2]),c.copy(l).normalize(),l.lerp(c,i).multiplyScalar(e),h[a]=l.x,h[a+1]=l.y,h[a+2]=l.z,l.normalize(),u[a]=l.x,u[a+1]=l.y,u[a+2]=l.z;this.copy(o)}}class ee extends t.BufferGeometry{constructor(e=1,r=1,s=12,n=1){super(),this.type="CapsuleGeometry";let i=Math.PI,a=e/(2*e+r),o=1-2*a;s=Math.floor(s),n=Math.floor(n);let l=Math.floor(.5*s),c=2*Math.PI,h=.5*Math.PI,u=new t.CylinderGeometry(e,e,r,s,n,!0);ie(u,0,a,1,o);let d=new t.SphereGeometry(e,s,l,0,c,0,h);ie(d,0,1-a,1,a);let p=new t.SphereGeometry(e,s,l,0,c,h,h);ie(p,0,0,1,a);let f=(new t.Matrix4).makeRotationY(.5*-i),m=(new t.Matrix4).makeTranslation(0,.5*r,0),g=(new t.Matrix4).makeTranslation(0,.5*-r,0);u.applyMatrix4(f),d.applyMatrix4(m),p.applyMatrix4(g);let y=Z(Q([u,d,p]));this.copy(y)}}class te extends t.BufferGeometry{constructor(e=1,r=.4,s=8,n=6,i=2*Math.PI,a=0,o=Math.PI){super(),this.type="TorusGeometryFix",this.parameters={radius:e,tube:r,radialSegments:s,tubularSegments:n,arc:i},s=Math.floor(s),n=Math.floor(n);const l=[],c=[],h=[],u=[],d=new t.Vector3,p=new t.Vector3,f=new t.Vector3;let m,g;for(m=0;m<=s;m++)for(g=0;g<=n;g++){const t=g/n*i,l=m/s*o+a;p.x=(e+r*Math.cos(l))*Math.cos(t),p.y=(e+r*Math.cos(l))*Math.sin(t),p.z=r*Math.sin(l),c.push(p.x,p.y,p.z),d.x=e*Math.cos(t),d.y=e*Math.sin(t),f.subVectors(p,d).normalize(),h.push(f.x,f.y,f.z),u.push(g/n),u.push(m/s)}for(m=1;m<=s;m++)for(g=1;g<=n;g++){const e=(n+1)*m+g-1,t=(n+1)*(m-1)+g-1,r=(n+1)*(m-1)+g,s=(n+1)*m+g;l.push(e,t,s),l.push(t,r,s)}this.setIndex(l),this.setAttribute("position",new t.Float32BufferAttribute(c,3)),this.setAttribute("normal",new t.Float32BufferAttribute(h,3)),this.setAttribute("uv",new t.Float32BufferAttribute(u,2))}}class re extends t.BufferGeometry{constructor(e=1,r=1,s=1,n=.01,i=12,a=1,o=2){super(),this.type="ChamferCyl",i=Math.floor(i),a=Math.floor(a),o=Math.floor(o);let l=new t.Matrix4,c=new t.Matrix4,h=Math.PI,u=.5*h,d=2*h,p=n/s,f=1-2*p,m=new t.CylinderGeometry(e,r,s-2*n,i,a,!0,0);l.makeRotationY(u),m.applyMatrix4(l),ie(m,0,p,1,f);let g=new te(e-n,n,o,i,d,0,u),y=new t.CircleGeometry(e-n,i);c.makeTranslation(0,0,n),y.applyMatrix4(c),ie(g,0,1-p,1,p);let v=Q([g,y]);l.makeTranslation(0,0,.5*s-n),c.makeRotationX(-u),v.applyMatrix4(c.multiply(l)),g=new te(r-n,n,o,i,d,0,u),y=new t.CircleGeometry(r-n,i),c.makeTranslation(0,0,n),y.applyMatrix4(c),ie(g,0,1-p,1,p,!0);let w=Q([g,y]);l.makeTranslation(0,0,.5*s-n),c.makeRotationX(u),w.applyMatrix4(c.multiply(l));let x=Z(Q([v,m,w]));this.copy(x)}}class se extends t.BufferGeometry{constructor(e=1,r=1,s=1,n=.01,i=1,a=1,o=1,l=2){super(),this.type="ChamferBox",i=Math.floor(i),a=Math.floor(a),o=Math.floor(o),l=Math.floor(l);let c=Math.PI,h=.5*c,u=2*n,d=.5*e,p=.5*r,f=.5*s,m=new t.Matrix4,g=new t.Matrix4,y=new t.Matrix4,v=n/e,w=1-2*v,x=n/r,b=1-2*v,A=n/s,M=1-2*A,T=new t.PlaneGeometry(e-u,r-u,i,a),S=new t.CylinderGeometry(n,n,e-u,l,i,!0,0,h),R=new t.CylinderGeometry(n,n,r-u,l,a,!0,0,h),k=new ne(n,l,l,0,h,0,-h),E=new ne(n,l,l,0,h,0,-h);ie(T,-v,x,w,b),ie(S,0,v,x,w),g.makeTranslation(0,p-n,0),m.makeRotationX(h),k.applyMatrix4(g.multiply(m)),g.makeTranslation(0,-p+n,0),m.makeRotationX(h),y.makeRotationY(-h),E.applyMatrix4(g.multiply(m).multiply(y));let I=Q([R,k,E]),L=I.clone();g.makeTranslation(d-n,0,-n),I.applyMatrix4(g),g.makeTranslation(-d+n,0,-n),m.makeRotationZ(c),L.applyMatrix4(g.multiply(m));let P=S.clone();m.makeRotationZ(h),g.makeTranslation(0,p-n,-n),S.applyMatrix4(g.multiply(m)),g.makeTranslation(0,-p+n,-n),m.makeRotationZ(-h),P.applyMatrix4(g.multiply(m));let C=Q([S,P,T,I,L]),_=C.clone();g.makeTranslation(0,0,f),C.applyMatrix4(g),g.makeTranslation(0,0,-f),m.makeRotationY(c),_.applyMatrix4(g.multiply(m)),T=new t.PlaneGeometry(s-u,r-u,o,a),S=new t.CylinderGeometry(n,n,s-u,l,o,!0,0,h),P=S.clone(),ie(T,-A,x,M,b),g.makeTranslation(0,-(p-n),-n,0),m.makeRotationZ(-h),S.applyMatrix4(g.multiply(m)),g.makeTranslation(0,p-n,-n,0),m.makeRotationZ(h),P.applyMatrix4(g.multiply(m));let F=Q([S,P,T]),B=F.clone();g.makeTranslation(-d,0,0),m.makeRotationY(-h),F.applyMatrix4(g.multiply(m)),g.makeTranslation(d,0,0),m.makeRotationY(h),B.applyMatrix4(g.multiply(m)),T=new t.PlaneGeometry(e-u,s-u,i,o),ie(T,-v,A,w,M);let D=T.clone();g.makeTranslation(0,p,0),m.makeRotationX(-h),T.applyMatrix4(g.multiply(m)),g.makeTranslation(0,-p,0),m.makeRotationX(h),D.applyMatrix4(g.multiply(m));let O=Z(Q([C,_,F,B,T,D]));!function(e,r="sphere",s,n){void 0===s&&(s=new t.Matrix4);e.computeBoundingBox();let i=e.boundingBox;n=Math.max(i.max.x-i.min.x,i.max.y-i.min.y,i.max.z-i.min.z);let a=i,o=[];o.length=2*e.attributes.position.count,void 0===e.attributes.uv&&e.addAttribute("uv",new t.Float32BufferAttribute(o,2));let l,c,h,u,d,p=function(e,r,n){e.applyMatrix4(s),r.applyMatrix4(s),n.applyMatrix4(s);let i=1/(2*Math.PI),a=1/Math.PI;return e.normalize(),r.normalize(),n.normalize(),{uv0:new t.Vector2(.5-Math.atan(e.z,-e.x)*i,.5-Math.asin(e.y)*a),uv1:new t.Vector2(.5-Math.atan(r.z,-r.x)*i,.5-Math.asin(r.y)*a),uv2:new t.Vector2(.5-Math.atan(n.z,-n.x)*i,.5-Math.asin(n.y)*a)}},f=function(e,r,i){e.applyMatrix4(s),r.applyMatrix4(s),i.applyMatrix4(s);let o=new t.Vector3;o.crossVectors(r.clone().sub(e),r.clone().sub(i)).normalize(),o.x<0||o.y<0||o.z,o.x=Math.abs(o.x),o.y=Math.abs(o.y),o.z=Math.abs(o.z);let l=new t.Vector2,c=new t.Vector2,h=new t.Vector2,u=1/n;return o.y>o.x&&o.y>o.z?(l.set(e.x-a.min.x,a.max.z-e.z).multiplyScalar(u),c.set(r.x-a.min.x,a.max.z-r.z).multiplyScalar(u),h.set(i.x-a.min.x,a.max.z-i.z).multiplyScalar(u)):o.x>o.y&&o.x>o.z?(l.set(e.z-a.min.z,e.y-a.min.y).multiplyScalar(u),c.set(r.z-a.min.z,r.y-a.min.y).multiplyScalar(u),h.set(i.z-a.min.z,i.y-a.min.y).multiplyScalar(u)):o.z>o.y&&o.z>o.x&&(l.set(e.x-a.min.x,e.y-a.min.y).multiplyScalar(u),c.set(r.x-a.min.x,r.y-a.min.y).multiplyScalar(u),h.set(i.x-a.min.x,i.y-a.min.y).multiplyScalar(u)),{uv0:l,uv1:c,uv2:h}},m=new t.Vector3,g=new t.Vector3,y=new t.Vector3;new t.Vector3,new t.Vector3,new t.Vector3;const v=e.getAttribute("position");if(e.getAttribute("normal"),e.index)for(l=0;l<e.index.count;l+=3)c=e.index.getX(l+0),h=e.index.getX(l+1),u=e.index.getX(l+2),m.fromBufferAttribute(v,c),g.fromBufferAttribute(v,h),y.fromBufferAttribute(v,u),d="sphere"===r?p(m,g,y):f(m,g,y),o[2*c]=d.uv0.x,o[2*c+1]=d.uv0.y,o[2*h]=d.uv1.x,o[2*h+1]=d.uv1.y,o[2*u]=d.uv2.x,o[2*u+1]=d.uv2.y;else for(l=0;l<v.count;l+=3){m.fromBufferAttribute(v,l+0),g.fromBufferAttribute(v,l+1),y.fromBufferAttribute(v,l+2),d="sphere"===r?p(m,g,y):f(m,g,y);let e=l,t=l+1,s=l+2;o[2*e]=d.uv0.x,o[2*e+1]=d.uv0.y,o[2*t]=d.uv1.x,o[2*t+1]=d.uv1.y,o[2*s]=d.uv2.x,o[2*s+1]=d.uv2.y}e.attributes.uv.array=new Float32Array(o),e.attributes.uv.needsUpdate=!0}(O,"box"),this.copy(O)}}class ne extends t.BufferGeometry{constructor(e=1,r=8,s=6,n=0,i=2*Math.PI,a=0,o=Math.PI){super(),this.type="SphereGeometryFix",this.parameters={radius:e,widthSegments:r,heightSegments:s,phiStart:n,phiLength:i,thetaStart:a,thetaLength:o},r=Math.floor(r),s=Math.floor(s);const l=Math.min(a+o,Math.PI);let c=0;const h=[],u=new t.Vector3,d=new t.Vector3,p=[],f=[],m=[],g=[];for(let t=0;t<=s;t++){const p=[],y=t/s;let v=0;0==t&&0==a?v=.5/r:t==s&&l==Math.PI&&(v=-.5/r);for(let t=0;t<=r;t++){const s=t/r;u.x=-e*Math.cos(n+s*i)*Math.sin(a+y*o),u.y=e*Math.cos(a+y*o),u.z=e*Math.sin(n+s*i)*Math.sin(a+y*o),f.push(u.x,u.y,u.z),d.copy(u).normalize(),m.push(d.x,d.y,d.z),g.push(s+v,1-y),p.push(c++)}h.push(p)}for(let e=0;e<s;e++)for(let t=0;t<r;t++){const r=h[e][t+1],n=h[e][t],i=h[e+1][t],o=h[e+1][t+1];(0!==e||a>0)&&p.push(r,n,o),(e!==s-1||l<Math.PI)&&p.push(n,i,o)}this.setIndex(p),this.setAttribute("position",new t.Float32BufferAttribute(f,3)),this.setAttribute("normal",new t.Float32BufferAttribute(m,3)),this.setAttribute("uv",new t.Float32BufferAttribute(g,2))}}function ie(e,t=0,r=0,s=1,n=1,i){let a=e.attributes.uv,o=a.array,l=a.count,c=0;for(;l--;)c=2*l,o[c]=o[c]*s-t,o[c+1]=o[c+1]*n+r,i&&(o[c]=1-o[c],o[c+1]=1-o[c+1])}const ae=new t.Vector3,oe=new t.Line3,le=new t.Plane,ce=new t.Vector3,he=new t.Triangle;class ue{constructor(){this.tolerance=-1,this.faces=[],this.newFaces=[],this.assigned=new me,this.unassigned=new me,this.vertices=[]}setFromPoints(e){if(e.length>=4){this.makeEmpty();for(let t=0,r=e.length;t<r;t++)this.vertices.push(new fe(e[t]));this.compute()}return this}setFromObject(e){const r=[];return e.updateMatrixWorld(!0),e.traverse((function(e){const s=e.geometry;if(void 0!==s){if(s.isGeometry)return void console.error("THREE.ConvexHull no longer supports Geometry. Use THREE.BufferGeometry instead.");if(s.isBufferGeometry){const n=s.attributes.position;if(void 0!==n)for(let s=0,i=n.count;s<i;s++){const i=new t.Vector3;i.fromBufferAttribute(n,s).applyMatrix4(e.matrixWorld),r.push(i)}}}})),this.setFromPoints(r)}containsPoint(e){const t=this.faces;for(let r=0,s=t.length;r<s;r++){if(t[r].distanceToPoint(e)>this.tolerance)return!1}return!0}intersectRay(e,t){const r=this.faces;let s=-1/0,n=1/0;for(let t=0,i=r.length;t<i;t++){const i=r[t],a=i.distanceToPoint(e.origin),o=i.normal.dot(e.direction);if(a>0&&o>=0)return null;const l=0!==o?-a/o:0;if(!(l<=0)&&(o>0?n=Math.min(l,n):s=Math.max(l,s),s>n))return null}return s!==-1/0?e.at(s,t):e.at(n,t),t}intersectsRay(e){return null!==this.intersectRay(e,ae)}makeEmpty(){return this.faces=[],this.vertices=[],this}addVertexToFace(e,t){return e.face=t,null===t.outside?this.assigned.append(e):this.assigned.insertBefore(t.outside,e),t.outside=e,this}removeVertexFromFace(e,t){return e===t.outside&&(null!==e.next&&e.next.face===t?t.outside=e.next:t.outside=null),this.assigned.remove(e),this}removeAllVerticesFromFace(e){if(null!==e.outside){const t=e.outside;let r=e.outside;for(;null!==r.next&&r.next.face===e;)r=r.next;return this.assigned.removeSubList(t,r),t.prev=r.next=null,e.outside=null,t}}deleteFaceVertices(e,t){const r=this.removeAllVerticesFromFace(e);if(void 0!==r)if(void 0===t)this.unassigned.appendChain(r);else{let e=r;do{const r=e.next;t.distanceToPoint(e.point)>this.tolerance?this.addVertexToFace(e,t):this.unassigned.append(e),e=r}while(null!==e)}return this}resolveUnassignedPoints(e){if(!1===this.unassigned.isEmpty()){let t=this.unassigned.first();do{const r=t.next;let s=this.tolerance,n=null;for(let r=0;r<e.length;r++){const i=e[r];if(0===i.mark){const e=i.distanceToPoint(t.point);if(e>s&&(s=e,n=i),s>1e3*this.tolerance)break}}null!==n&&this.addVertexToFace(t,n),t=r}while(null!==t)}return this}computeExtremes(){const e=new t.Vector3,r=new t.Vector3,s=[],n=[];for(let e=0;e<3;e++)s[e]=n[e]=this.vertices[0];e.copy(this.vertices[0].point),r.copy(this.vertices[0].point);for(let t=0,i=this.vertices.length;t<i;t++){const i=this.vertices[t],a=i.point;for(let t=0;t<3;t++)a.getComponent(t)<e.getComponent(t)&&(e.setComponent(t,a.getComponent(t)),s[t]=i);for(let e=0;e<3;e++)a.getComponent(e)>r.getComponent(e)&&(r.setComponent(e,a.getComponent(e)),n[e]=i)}return this.tolerance=3*Number.EPSILON*(Math.max(Math.abs(e.x),Math.abs(r.x))+Math.max(Math.abs(e.y),Math.abs(r.y))+Math.max(Math.abs(e.z),Math.abs(r.z))),{min:s,max:n}}computeInitialHull(){const e=this.vertices,t=this.computeExtremes(),r=t.min,s=t.max;let n=0,i=0;for(let e=0;e<3;e++){const t=s[e].point.getComponent(e)-r[e].point.getComponent(e);t>n&&(n=t,i=e)}const a=r[i],o=s[i];let l,c;n=0,oe.set(a.point,o.point);for(let t=0,r=this.vertices.length;t<r;t++){const r=e[t];if(r!==a&&r!==o){oe.closestPointToPoint(r.point,!0,ce);const e=ce.distanceToSquared(r.point);e>n&&(n=e,l=r)}}n=-1,le.setFromCoplanarPoints(a.point,o.point,l.point);for(let t=0,r=this.vertices.length;t<r;t++){const r=e[t];if(r!==a&&r!==o&&r!==l){const e=Math.abs(le.distanceToPoint(r.point));e>n&&(n=e,c=r)}}const h=[];if(le.distanceToPoint(c.point)<0){h.push(de.create(a,o,l),de.create(c,o,a),de.create(c,l,o),de.create(c,a,l));for(let e=0;e<3;e++){const t=(e+1)%3;h[e+1].getEdge(2).setTwin(h[0].getEdge(t)),h[e+1].getEdge(1).setTwin(h[t+1].getEdge(0))}}else{h.push(de.create(a,l,o),de.create(c,a,o),de.create(c,o,l),de.create(c,l,a));for(let e=0;e<3;e++){const t=(e+1)%3;h[e+1].getEdge(2).setTwin(h[0].getEdge((3-e)%3)),h[e+1].getEdge(0).setTwin(h[t+1].getEdge(1))}}for(let e=0;e<4;e++)this.faces.push(h[e]);for(let t=0,r=e.length;t<r;t++){const r=e[t];if(r!==a&&r!==o&&r!==l&&r!==c){n=this.tolerance;let e=null;for(let t=0;t<4;t++){const s=this.faces[t].distanceToPoint(r.point);s>n&&(n=s,e=this.faces[t])}null!==e&&this.addVertexToFace(r,e)}}return this}reindexFaces(){const e=[];for(let t=0;t<this.faces.length;t++){const r=this.faces[t];0===r.mark&&e.push(r)}return this.faces=e,this}nextVertexToAdd(){if(!1===this.assigned.isEmpty()){let e,t=0;const r=this.assigned.first().face;let s=r.outside;do{const n=r.distanceToPoint(s.point);n>t&&(t=n,e=s),s=s.next}while(null!==s&&s.face===r);return e}}computeHorizon(e,t,r,s){let n;this.deleteFaceVertices(r),r.mark=1,n=null===t?t=r.getEdge(0):t.next;do{const t=n.twin,r=t.face;0===r.mark&&(r.distanceToPoint(e)>this.tolerance?this.computeHorizon(e,t,r,s):s.push(n)),n=n.next}while(n!==t);return this}addAdjoiningFace(e,t){const r=de.create(e,t.tail(),t.head());return this.faces.push(r),r.getEdge(-1).setTwin(t.twin),r.getEdge(0)}addNewFaces(e,t){this.newFaces=[];let r=null,s=null;for(let n=0;n<t.length;n++){const i=t[n],a=this.addAdjoiningFace(e,i);null===r?r=a:a.next.setTwin(s),this.newFaces.push(a.face),s=a}return r.next.setTwin(s),this}addVertexToHull(e){const t=[];return this.unassigned.clear(),this.removeVertexFromFace(e,e.face),this.computeHorizon(e.point,null,e.face,t),this.addNewFaces(e,t),this.resolveUnassignedPoints(this.newFaces),this}cleanup(){return this.assigned.clear(),this.unassigned.clear(),this.newFaces=[],this}compute(){let e;for(this.computeInitialHull();void 0!==(e=this.nextVertexToAdd());)this.addVertexToHull(e);return this.reindexFaces(),this.cleanup(),this}}class de{constructor(){this.normal=new t.Vector3,this.midpoint=new t.Vector3,this.area=0,this.constant=0,this.outside=null,this.mark=0,this.edge=null}static create(e,t,r){const s=new de,n=new pe(e,s),i=new pe(t,s),a=new pe(r,s);return n.next=a.prev=i,i.next=n.prev=a,a.next=i.prev=n,s.edge=n,s.compute()}getEdge(e){let t=this.edge;for(;e>0;)t=t.next,e--;for(;e<0;)t=t.prev,e++;return t}compute(){const e=this.edge.tail(),t=this.edge.head(),r=this.edge.next.head();return he.set(e.point,t.point,r.point),he.getNormal(this.normal),he.getMidpoint(this.midpoint),this.area=he.getArea(),this.constant=this.normal.dot(this.midpoint),this}distanceToPoint(e){return this.normal.dot(e)-this.constant}}class pe{constructor(e,t){this.vertex=e,this.prev=null,this.next=null,this.twin=null,this.face=t}head(){return this.vertex}tail(){return this.prev?this.prev.vertex:null}length(){const e=this.head(),t=this.tail();return null!==t?t.point.distanceTo(e.point):-1}lengthSquared(){const e=this.head(),t=this.tail();return null!==t?t.point.distanceToSquared(e.point):-1}setTwin(e){return this.twin=e,e.twin=this,this}}class fe{constructor(e){this.point=e,this.prev=null,this.next=null,this.face=null}}class me{constructor(){this.head=null,this.tail=null}first(){return this.head}last(){return this.tail}clear(){return this.head=this.tail=null,this}insertBefore(e,t){return t.prev=e.prev,t.next=e,null===t.prev?this.head=t:t.prev.next=t,e.prev=t,this}insertAfter(e,t){return t.prev=e,t.next=e.next,null===t.next?this.tail=t:t.next.prev=t,e.next=t,this}append(e){return null===this.head?this.head=e:this.tail.next=e,e.prev=this.tail,e.next=null,this.tail=e,this}appendChain(e){for(null===this.head?this.head=e:this.tail.next=e,e.prev=this.tail;null!==e.next;)e=e.next;return this.tail=e,this}remove(e){return null===e.prev?this.head=e.next:e.prev.next=e.next,null===e.next?this.tail=e.prev:e.next.prev=e.prev,this}removeSubList(e,t){return null===e.prev?this.head=t.next:e.prev.next=t.next,null===t.next?this.tail=e.prev:t.next.prev=e.prev,this}isEmpty(){return null===this.head}}class ge extends t.BufferGeometry{constructor(e){super();const r=[],s=[];void 0===ue&&console.error("THREE.ConvexBufferGeometry: ConvexBufferGeometry relies on ConvexHull");const n=(new ue).setFromPoints(e).faces;for(let e=0;e<n.length;e++){const t=n[e];let i=t.edge;do{const e=i.head().point;r.push(e.x,e.y,e.z),s.push(t.normal.x,t.normal.y,t.normal.z),i=i.next}while(i!==t.edge)}this.setAttribute("position",new t.Float32BufferAttribute(r,3)),this.setAttribute("normal",new t.Float32BufferAttribute(s,3))}}class ye extends P{constructor(){super(),this.Utils=i,this.type="body",this.num=L[this.type],this.full=!1,this.extraConvex=!1}setFull(e){this.num=L[e?"bodyFull":"body"],this.full=e}step(e,t){const r=this.list;let s,n,i,a=r.length;for(;a--;)if(s=r[a],null!==s){if(n=t+a*this.num,!s.actif){if(i=e[n+0]+e[n+1]+e[n+2]+e[n+3]+e[n+4]+e[n+5]+e[n+6]+e[n+7],0===i)continue;s.actif=!0}s.sleep=!(e[n]>0),s.defMat&&(s.isInstance?s.instance.setColorAt(s.id,s.sleep?f.sleep:f.body):(s.sleep||"sleep"!==s.material.name||(s.material=y("body")),s.sleep&&"body"===s.material.name&&(s.material=y("sleep")))),s.sleep&&!s.isKinematic||(s.isInstance?(s.speedMat&&s.instance.setColorAt(s.id,[.5*Math.abs(e[n+8]),.5*Math.abs(e[n+9]),.5*Math.abs(e[n+10])]),s.instance.setTransformAt(s.id,[e[n+1],e[n+2],e[n+3]],[e[n+4],e[n+5],e[n+6],e[n+7]],s.noScale?[1,1,1]:s.size),s.position={x:e[n+1],y:e[n+2],z:e[n+3]},this.full&&(s.velocity={x:e[n+8],y:e[n+9],z:e[n+10]},s.angular={x:e[n+11],y:e[n+12],z:e[n+13]})):(s.position.fromArray(e,n+1),s.quaternion.fromArray(e,n+4),this.full&&(s.velocity.fromArray(e,n+8),s.angular.fromArray(e,n+11)),s.auto||s.updateMatrix()))}}geometry(e={},r=null,s=null){let i,a,o,l=e.size,d="",p=e.type,f=!1,m=!1,g=e.seg||16;if(e.instance&&"capsule"!==p&&(l=e.instanceSize||[1,1,1]),e.instance&&"compound"===p&&(p=e.shapes[0].type,l=e.shapes[0].size,e.translate=e.shapes[0].pos),"mesh"!==p&&"convex"!==p||(e.shape?e.shape.isMesh&&(e.shape=e.shape.geometry):e.mesh&&!e.v&&(e.shape=e.mesh.geometry)),e.radius&&("box"===p&&(p="ChamferBox"),"cylinder"===p&&(p="ChamferCyl")),e.geometry&&("convex"===p?e.shape=e.geometry:p="direct"),this.extraConvex&&("cylinder"===e.type||"cone"===e.type)){let r=new t.CylinderGeometry("cone"===e.type?0:e.size[0],e.size[0],e.size[1],g,1);e.isWheel&&r.rotateZ(-A.PI90),e.v=A.getVertex(r),e.type="convex"}switch(p){case"direct":i=e.geometry.clone(),e.size&&i.scale(e.size[0],e.size[1],e.size[2]),m=!0,f=!0;break;case"convex":if(e.v){if(e.nogeo)i=new t.BufferGeometry;else{let r=[];for(a=Math.floor(e.v.length/3);a--;)o=3*a,r.push(new t.Vector3(e.v[o],e.v[o+1],e.v[o+2]));i=new ge(r)}m=!0,f=!0}e.shape&&(i=e.shape.clone(),e.size&&i.scale(e.size[0],e.size[0],e.size[0]),e.v=A.getVertex(i),e.index=A.getIndex(i),m=!0,f=!0);break;case"mesh":i=e.shape.clone(),e.size&&i.scale(e.size[0],e.size[0],e.size[0]),e.v=A.getVertex(i,"OIMO"===n.engine),e.index="OIMO"===n.engine?null:A.getIndex(i),m=!0,f=!0;break;case"highSphere":d="highSphere_"+l[0],i=u(d),i?d="":(i=new $(l[0]),i.name=d),f=!0,e.type="sphere";break;case"capsule":d="capsule_"+l[0]+"_"+l[1]+"_"+g,i=u(d),i?d="":(i=new ee(l[0],l[1],g),i.name=d),f=!0;break;case"ChamferBox":d="ChamferBox_"+l[0]+"_"+l[1]+"_"+l[2]+"_"+e.radius+"_"+g,i=u(d),i?d="":(i=new se(l[0],l[1],l[2],e.radius,g),i.name=d),f=!0;break;case"ChamferCyl":d="ChamferCyl_"+l[0]+"_"+l[1]+"_"+l[2]+"_"+e.radius+"_"+g,i=u(d),i?d="":(i=new re(l[0],l[0],l[1],e.radius,g),i.name=d),f=!0;break;default:i=u(p)}if(e.translate&&i.translate(e.translate[0],e.translate[1],e.translate[2]),e.shape&&delete e.shape,e.geometry&&delete e.geometry,""!==d&&h(i),e.isWheel&&(i=i.clone(),i.rotateZ(-A.PI90),m=!0),m&&c(i),null===r&&null===s)return i.noScale=f,i;let y=new t.Mesh(i,s);e.localRot&&(e.localQuat=A.toQuatArray(e.localRot)),e.localPos&&y.position.fromArray(e.localPos),e.localQuat&&y.quaternion.fromArray(e.localQuat),f||y.scale.fromArray(e.size),e.meshRemplace&&!e.debug||r.add(y)}add(e={}){let t,r,s;if(e.instance||(s=this.setName(e)),e.type=void 0===e.type?"box":e.type,"plane"!==e.type||e.visible||(e.visible=!1),e.massCenter&&"PHYSX"!==n.engine)if("compound"!==e.type)e.shapes=[{type:e.type,pos:e.massCenter,size:e.size}],e.seg&&(e.shapes[0].seg=e.seg),e.radius&&(e.shapes[0].radius=e.radius),delete e.size,e.type="compound";else for(t=0;t<e.shapes.length;t++)r=e.shapes[t],r.pos?r.pos=i.vecAdd(r.pos,e.massCenter):r.pos=e.massCenter,c(r);e.pos=void 0===e.pos?[0,0,0]:e.pos,e.quat=void 0===e.quat?[0,0,0,1]:e.quat,void 0!==e.rot&&(e.quat=A.toQuatArray(e.rot),delete e.rot),void 0!==e.meshRot&&(e.meshQuat=A.toQuatArray(e.meshRot),delete e.meshRot),e.size=A.autoSize(e.size,e.type),e.meshScale&&(e.meshScale=A.autoSize(e.meshScale));let a,o=!1;void 0!==e.material?a=e.material.constructor===String?y(e.material):e.material:(o=!0,a=y(this.type),e.instance&&(a=y("base"))),e.material&&delete e.material;let l=e.instance?{}:new q;if(e.mesh){"terrain"===e.mesh.type&&(e.noClone=!0);let t=e.noClone?e.mesh:e.mesh.clone();t.position.fromArray(e.meshPos||[0,0,0]),e.meshRot&&(e.meshQuat=A.toQuatArray(e.meshRot),delete e.meshRot),e.meshQuat&&t.quaternion.fromArray(e.meshQuat),e.meshSize&&t.scale.set(1,1,1).multiplyScalar(e.meshSize),e.meshScale&&t.scale.fromArray(e.meshScale),o||(t.material=a),n.tmpMesh.push(t),e.meshRemplace=!0,l.add(t)}switch(e.type){case"null":break;case"compound":for(t=0;t<e.shapes.length;t++)r=e.shapes[t],r.type=void 0===r.type?"box":r.type,r.size=A.autoSize(r.size,r.type),r.pos&&(r.localPos=r.pos),void 0!==r.rot&&(r.quat=A.toQuatArray(r.rot),delete r.rot),r.quat&&(r.localQuat=r.quat),r.debug=e.debug||!1,r.meshRemplace=e.meshRemplace||!1,e.instance||this.geometry(r,l,a);break;default:e.instance||this.geometry(e,l,a)}if(l.type=this.type,l.size=e.size,l.shapetype=e.type,l.isKinematic=e.kinematic||!1,l.isRay="body"===l.type,void 0!==e.ray&&(l.isRay=e.ray),e.instance||l.setRaycast(),o||(l.material=a),l.defMat=!1,l.material&&(l.defMat="body"===l.material.name),e.instance){l.isInstance=!0,l.instance=n.instanceMesh[e.instance]||this.addInstance(e,a),l.instance.isRay=l.isRay,l.defMat="base"===l.instance.material.name,l.id=l.instance.count,l.name=l.instance.name+l.id,e.name=l.name,l.noScale=!1,"capsule"===e.type&&(l.noScale=!0);let t=e.color;l.defMat&&(t=e.sleep?f.sleep:f.body),l.instance.add(e.pos,e.quat,l.noScale?[1,1,1]:l.size,t),l.position={x:e.pos[0],y:e.pos[1],z:e.pos[2]},l.velocity={x:0,y:0,z:0},l.angular={x:0,y:0,z:0},l.instance.v&&(e.v=l.instance.v),l.instance.index&&(e.index=l.instance.index),e.type=l.instance.type}else l.name=s,e.renderOrder&&(l.renderOrder=e.renderOrder),void 0===e.visible&&(e.visible=!0),void 0===e.shadow&&(e.shadow=e.visible),l.visible=void 0===e.visible||e.visible,l.receiveShadow=e.shadow,l.castShadow=e.shadow,this.set(e,l);return e.instance&&delete e.instance,e.mesh&&delete e.mesh,this.addToWorld(l,e.id),e.onlyMakeMesh||(e.phySize&&(e.size=e.phySize),e.phyPos&&(e.pos=e.phyPos),n.post({m:"add",o:e})),l}set(e={},t=null){null===t&&(t=this.byName(e.name)),null!==t&&(e.pos&&t.position.fromArray(e.pos),e.quat&&t.quaternion.fromArray(e.quat),t.auto=e.auto||!1,t.auto?t.matrixAutoUpdate=!0:(t.matrixAutoUpdate=!1,t.updateMatrix()))}addInstance(e,t){let r=new K(this.geometry(e),t,0);return e.v&&(r.v=e.v),e.index&&(r.index=e.index),r.type=e.type,r.receiveShadow=void 0===e.shadow||e.shadow,r.castShadow=void 0===e.shadow||e.shadow,r.name=e.instance,n.scene.add(r),n.instanceMesh[e.instance]=r,r}}class ve extends P{constructor(){super(),this.Utils=i,this.type="joint"}step(e,t){let r,s,n=this.list.length;for(;n--;)r=this.list[n],s=t+n*L.joint,r.update(e,s)}add(e={}){let t=this.setName(e);e.b1&&"string"!=typeof e.b1&&(e.b1=e.b1.name),e.b2&&"string"!=typeof e.b2&&(e.b2=e.b2.name),void 0!==e.rot1&&(e.quat1=A.toQuatArray(e.rot1),delete e.rot1),void 0!==e.rot2&&(e.quat2=A.toQuatArray(e.rot2),delete e.rot2),e.drivePosition&&void 0!==e.drivePosition.rot&&(e.drivePosition.quat=A.toQuatArray(e.drivePosition.rot),delete e.drivePosition.rot);let r=new we(u("joint"),y("joint"));return r.name=t,r.visible=!1,r.isVisible=void 0===e.visible||e.visible,this.addToWorld(r,e.id),n.post({m:"add",o:e}),r}set(e={}){}}class we extends q{constructor(e,r){super(),this.type="joint",this.mode="revolute",this.isJoint=!0,this.mtx=new t.Matrix4,this.m1=new t.LineSegments(e,r),this.add(this.m1),this.m2=new t.LineSegments(e,r),this.add(this.m2),this.m2.matrixAutoUpdate=!1;const s=new t.BufferGeometry;s.setAttribute("position",new t.Float32BufferAttribute([0,0,0,0,0,0],3)),s.computeBoundingSphere(),this.m3=new t.LineSegments(s,r),this.add(this.m3)}update(e,t=0){if(!this.isVisible)return;this.position.fromArray(e,t),this.quaternion.fromArray(e,t+3),this.updateMatrix(),this.m2.position.fromArray(e,t+7),this.m2.quaternion.fromArray(e,t+10),this.m2.matrix.compose(this.m2.position,this.m2.quaternion,{x:1,y:1,z:1}),this.mtx.copy(this.matrix).invert().multiply(this.m2.matrix),this.mtx.decompose(this.m2.position,this.m2.quaternion,{x:1,y:1,z:1}),this.m2.updateMatrix();const r=this.m3.geometry.attributes.position;r.setXYZ(1,this.m2.position.x,this.m2.position.y,this.m2.position.z),r.needsUpdate=!0,this.visible||(this.visible=!0)}dispose(){this.m1.geometry.dispose(),this.m2.geometry.dispose(),this.m3.geometry.dispose(),this.children=[]}}class xe extends P{constructor(){super(),this.Utils=i,this.type="contact"}step(e,t){let r,s,n=this.list.length;for(;n--;)r=this.list[n],s=t+n*L.contact,r.update(e,s)}add(e={}){this.setName(e);let t=new be(e);return e.callback&&delete e.callback,this.addToWorld(t,e.id),n.post({m:"add",o:e}),t}}class be{constructor(e={}){this.type="contact",this.name=e.name,this.callback=e.callback||function(){},this.b1=e.b1||null,this.b2=e.b2||null,this.ignore=e.ignore||[],this.always=void 0===e.always||e.always,this.simple=e.simple||!1,this.data={hit:!1,point:[0,0,0],normal:[0,0,0]}}update(e,t=0){this.data.hit=e[t]>0,this.simple||(this.data.point=[e[t+1],e[t+2],e[t+3]],this.data.normal=[e[t+4],e[t+5],e[t+6]]),(this.data.hit||this.always)&&this.callback(this.data)}}class Ae extends P{constructor(){super(),this.Utils=i,this.type="vehicle",this.num=L[this.type]}step(e,t){let r,s,n=this.list.length;for(;n--;)s=this.list[n],r=t+n*this.num,s.step(e,r)}add(e={}){this.setName(e);const t=new Me(e);return this.addToWorld(t,e.id),n.post({m:"add",o:t.o}),t}set(e={},t=null){null===t&&(t=this.byName(e.name))}}class Me{constructor(e){this.type="vehicle",this.isCar=!0,this.name=e.name,this.withBody=!1,this.actif=!1,this.init(e)}drive(){}init(e){if(this.size=e.size||[1.7,1,5],this.massCenter=e.massCenter||[0,.55,1.594],this.chassisPos=e.chassisPos||[0,.83,0],this.numWheel=e.numWheel||4,this.radius=e.radius||.35,this.radiusBack=e.radiusBack||this.radius,this.deep=e.deep||.3,this.deepBack=e.deepBack||this.deep,e.wPos||(e.wPos=[.8,.1,1.4]),e.wPos){for(var t,r=e.wPos,s=[],i=1,a=3===r.length,o=1,l=0;l<this.numWheel;l++)-1===(i=l%2==0?-1:1)&&o++,t=a?[r[0]*i,r[1],l<2?r[2]:-r[2]]:[r[0]*i,r[1],-r[o]],s.push(t);this.wheelsPosition=s}else this.wheelsPosition=e.wheelsPosition;const c=[];e.chassisShape?c.push({type:"convex",shape:e.chassisShape,filter:[1,-1,0,0],isExclusive:!0}):c.push({type:"box",size:this.size,pos:this.chassisPos});let h="cylinder";for(let e=0;e<this.numWheel;e++)e<2?c.push({type:h,size:[this.radius,this.deep],isWheel:!0,radius:.05}):c.push({type:h,size:[this.radiusBack,this.deepBack],isWheel:!0,radius:.05});if(this.kinematic=e.kinematic,this.chassis=n.add({onlyMakeMesh:!0,name:this.name+"_chassis",type:"compound",shapes:c,pos:e.pos,rot:e.rot,ray:!1,material:"debug"}),this.chassis.car=this,e.body){this.withBody=!0,this.body=e.noClone?e.body:e.body.clone(),this.body.matrixAutoUpdate=!1,this.chassisName=e.chassisName||"chassis",this.wheelNamePrefix=e.wheelNamePrefix||"wheel_",this.body.scale.x!==e.bodyScale&&this.body.scale.multiplyScalar(e.bodyScale),this.invScale=1/e.bodyScale,n.content.add(this.body);l=this.body.children.length;for(this.bodys={};l--;){var u=this.body.children[l],d=u.name;this.bodys[d]=u}var p=this.bodys[this.chassisName];this.kinematic&&p&&(p.position.y-=this.decal),delete e.body}e.size=this.size,e.numWheel=this.numWheel,e.wheelsPosition=this.wheelsPosition,e.radius=this.radius,e.radiusBack=this.radiusBack,e.deep=this.deep,e.deepBack=this.deepBack,e.chassisShape=c[0],e.massCenter=this.massCenter,e.chassisPos=this.chassisPos,this.o=e}respawn(e){(e=e||{}).respawn=!0,e.name=this.name,e.keepRotation&&(e.quat=this.chassis.quaternion.toArray()),n.view.up(e)}dispose(){this.withBody&&n.content.remove(this.body),n.remove(this.name+"_chassis")}step(e,t){if(!this.actif){if(0===e[t+0]+e[t+1]+e[t+2]+e[t+3]+e[t+4]+e[t+5]+e[t+6]+e[t+7])return;this.actif=!0}this.chassis.position.fromArray(e,t+1),this.chassis.quaternion.fromArray(e,t+4),this.chassis.updateMatrix(),this.withBody&&(this.body.position.copy(this.chassis.position),this.body.quaternion.copy(this.chassis.quaternion),this.body.updateMatrix());for(var r,s=this.numWheel+1,n=0,i=0;i<s;i++)n=8*i+t,0===i&&(e[n],this.circum),(r=this.chassis.children[i])&&i>0&&(r.position.fromArray(e,n+1),r.quaternion.fromArray(e,n+4))}}class Te extends P{constructor(){super(),this.Utils=i,this.type="character"}step(e,t){let r,s,n=this.list.length;for(;n--;)s=this.list[n],r=t+n*L.character,s.step(e,r)}add(e={}){this.setName(e);const t=new Se(e);return this.addToWorld(t,e.id),n.post({m:"add",o:t.o}),t}set(e={},t=null){null===t&&(t=this.byName(e.name)),null!==t&&t.set(e)}}class Se{constructor(e){this.type="character",this.name=e.name,this.init(e)}init(e){this.shape=n.add({onlyMakeMesh:!0,name:this.name+"_shape",type:"capsule",size:e.size,pos:e.pos,rot:e.rot,ray:!1,material:"hero"})}step(e,t){this.shape.position.fromArray(e,t+1),this.shape.quaternion.fromArray(e,t+4),this.shape.updateMatrix()}set(e){}}const Re={torad:Math.PI/180,todeg:180/Math.PI,Pi:Math.PI,TwoPI:2*Math.PI,PI90:.5*Math.PI,PI45:.25*Math.PI,PI270:.5*Math.PI*3,inv255:.003921569,golden:1.618033,epsilon:Math.pow(2,-52),randomSign:()=>Math.random()<.5?-1:1,randSpread:e=>e*(.5-Math.random()),rand:(e=0,t=1)=>e+Math.random()*(t-e),randInt:(e,t)=>e+Math.floor(Math.random()*(t-e+1)),toFixed:(e,t=3)=>1*e.toFixed(t),int:e=>Math.floor(e),lerp:(e,t,r)=>(1-r)*e+r*t,clamp:(e,t,r)=>Math.max(t,Math.min(r,e)),nearEquals:(e,t,r)=>Math.abs(e-t)<=r,lerpAr:(e,t,r,s)=>{let n=e.length;for(;n--;)e[n]=Re.lerp(t[n],r[n],s)},unwrapDeg:e=>e-360*Math.floor((e+180)/360),unwrapRad:e=>e-2*Math.floor((e+Math.PI)/(2*Math.PI))*Math.PI,scaleArray:(e,t)=>{for(var r=e.length;r--;)e[r]*=t;return e},addArray:(e,t)=>{for(var r=[],s=e.length;s--;)r[s]=e[s]+t[s];return r},angleDistance:(e,t)=>{var r=(e-t+180)%360-180;return r<-180?r+360:r},tmpE:new t.Euler,tmpM:new t.Matrix4,tmpM2:new t.Matrix4,tmpV:new t.Vector3,tmpQ:new t.Quaternion,fromTransformToQ:(e,t,r)=>(r=r||!1,Re.tmpM.compose(Re.tmpV.fromArray(e),Re.tmpQ.fromArray(t),{x:1,y:1,z:1}),Re.tmpM.decompose(Re.tmpV,Re.tmpQ,{x:1,y:1,z:1}),r&&Re.tmpQ.invert(),Re.tmpQ.toArray()),fromTransform:(e,t,r,s,n)=>(n=n||!1,s=s||[0,0,0,1],Re.tmpM.compose(Re.tmpV.fromArray(e),Re.tmpQ.fromArray(t),{x:1,y:1,z:1}),Re.tmpM2.compose(Re.tmpV.fromArray(r),Re.tmpQ.fromArray(s),{x:1,y:1,z:1}),n?(Re.tmpM.invert(),Re.tmpM.multiply(Re.tmpM2)):Re.tmpM.multiply(Re.tmpM2),Re.tmpM.decompose(Re.tmpV,Re.tmpQ,{x:1,y:1,z:1}),Re.tmpV.toArray()),arCopy:(e,t)=>{},axisToQuatArray:(e,t)=>(t=t||!1,Re.tmpQ.setFromAxisAngle(Re.tmpV.fromArray(e,1),t?e[0]*Re.torad:e[0]).normalize().toArray()),toQuatArray:e=>Re.tmpQ.setFromEuler(Re.tmpE.fromArray(Re.vectorad(e))).toArray(),vectorad:e=>{let t=3,r=[];for(;t--;)r[t]=e[t]*Re.torad;return r[3]=e[3],r},rgbToHex:e=>"0x"+("000000"+(255*e[0]<<16^255*e[1]<<8^255*e[2]<<0).toString(16)).slice(-6),hexToRgb:e=>[((e=Math.floor(e))>>16&255)/255,(e>>8&255)/255,(255&e)/255],htmlToHex:e=>e.toUpperCase().replace("#","0x"),hexToHtml:e=>"#"+("000000"+(e=void 0===e?0:e).toString(16)).substr(-6),rgbToHtml:e=>"#"+("000000"+(255*e[0]<<16^255*e[1]<<8^255*e[2]<<0).toString(16)).slice(-6),perlin:null,noise:(e,t)=>{null===Re.perlin&&(Re.perlin=new ke);let r,s,n=(t=t||{}).level||[1,.2,.05],i=t.frequency||[.016,.05,.2],a=0,o=0;for(r=0;r<n.length;r++)s=i[r],a+=n[r]*(.5+.5*Re.perlin.noise3d(e.x*s,e.y*s,e.z*s)),o+=n[r];return a/=o,a}};class ke{constructor(e){null==e&&(e=Math),this.grad3=[[1,1,0],[-1,1,0],[1,-1,0],[-1,-1,0],[1,0,1],[-1,0,1],[1,0,-1],[-1,0,-1],[0,1,1],[0,-1,1],[0,1,-1],[0,-1,-1]],this.grad4=[[0,1,1,1],[0,1,1,-1],[0,1,-1,1],[0,1,-1,-1],[0,-1,1,1],[0,-1,1,-1],[0,-1,-1,1],[0,-1,-1,-1],[1,0,1,1],[1,0,1,-1],[1,0,-1,1],[1,0,-1,-1],[-1,0,1,1],[-1,0,1,-1],[-1,0,-1,1],[-1,0,-1,-1],[1,1,0,1],[1,1,0,-1],[1,-1,0,1],[1,-1,0,-1],[-1,1,0,1],[-1,1,0,-1],[-1,-1,0,1],[-1,-1,0,-1],[1,1,1,0],[1,1,-1,0],[1,-1,1,0],[1,-1,-1,0],[-1,1,1,0],[-1,1,-1,0],[-1,-1,1,0],[-1,-1,-1,0]],this.p=[];for(var t=0;t<256;t++)this.p[t]=Math.floor(256*e.random());this.perm=[];for(t=0;t<512;t++)this.perm[t]=this.p[255&t];this.simplex=[[0,1,2,3],[0,1,3,2],[0,0,0,0],[0,2,3,1],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,2,3,0],[0,2,1,3],[0,0,0,0],[0,3,1,2],[0,3,2,1],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,3,2,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,2,0,3],[0,0,0,0],[1,3,0,2],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,3,0,1],[2,3,1,0],[1,0,2,3],[1,0,3,2],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,0,3,1],[0,0,0,0],[2,1,3,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,0,1,3],[0,0,0,0],[0,0,0,0],[0,0,0,0],[3,0,1,2],[3,0,2,1],[0,0,0,0],[3,1,2,0],[2,1,0,3],[0,0,0,0],[0,0,0,0],[0,0,0,0],[3,1,0,2],[0,0,0,0],[3,2,0,1],[3,2,1,0]]}dot(e,t,r){return e[0]*t+e[1]*r}dot3(e,t,r,s){return e[0]*t+e[1]*r+e[2]*s}dot4(e,t,r,s,n){return e[0]*t+e[1]*r+e[2]*s+e[3]*n}noise(e,t){var r,s,n=(e+t)*(.5*(Math.sqrt(3)-1)),i=Math.floor(e+n),a=Math.floor(t+n),o=(3-Math.sqrt(3))/6,l=(i+a)*o,c=e-(i-l),h=t-(a-l);c>h?(r=1,s=0):(r=0,s=1);var u=c-r+o,d=h-s+o,p=c-1+2*o,f=h-1+2*o,m=255&i,g=255&a,y=this.perm[m+this.perm[g]]%12,v=this.perm[m+r+this.perm[g+s]]%12,w=this.perm[m+1+this.perm[g+1]]%12,x=.5-c*c-h*h,b=.5-u*u-d*d,A=.5-p*p-f*f;return 70*((x<0?0:(x*=x)*x*this.dot(this.grad3[y],c,h))+(b<0?0:(b*=b)*b*this.dot(this.grad3[v],u,d))+(A<0?0:(A*=A)*A*this.dot(this.grad3[w],p,f)))}noise3d(e,t,r){var s,n,i,a,o,l,c=(e+t+r)*(1/3),h=Math.floor(e+c),u=Math.floor(t+c),d=Math.floor(r+c),p=1/6,f=(h+u+d)*p,m=e-(h-f),g=t-(u-f),y=r-(d-f);m>=g?g>=y?(s=1,n=0,i=0,a=1,o=1,l=0):m>=y?(s=1,n=0,i=0,a=1,o=0,l=1):(s=0,n=0,i=1,a=1,o=0,l=1):g<y?(s=0,n=0,i=1,a=0,o=1,l=1):m<y?(s=0,n=1,i=0,a=0,o=1,l=1):(s=0,n=1,i=0,a=1,o=1,l=0);var v=m-s+p,w=g-n+p,x=y-i+p,b=m-a+2*p,A=g-o+2*p,M=y-l+2*p,T=m-1+.5,S=g-1+.5,R=y-1+.5,k=255&h,E=255&u,I=255&d,L=this.perm[k+this.perm[E+this.perm[I]]]%12,P=this.perm[k+s+this.perm[E+n+this.perm[I+i]]]%12,C=this.perm[k+a+this.perm[E+o+this.perm[I+l]]]%12,_=this.perm[k+1+this.perm[E+1+this.perm[I+1]]]%12,F=.6-m*m-g*g-y*y,B=.6-v*v-w*w-x*x,D=.6-b*b-A*A-M*M,O=.6-T*T-S*S-R*R;return 32*((F<0?0:(F*=F)*F*this.dot3(this.grad3[L],m,g,y))+(B<0?0:(B*=B)*B*this.dot3(this.grad3[P],v,w,x))+(D<0?0:(D*=D)*D*this.dot3(this.grad3[C],b,A,M))+(O<0?0:(O*=O)*O*this.dot3(this.grad3[_],T,S,R)))}noise4d(e,t,r,s){var n,i,a,o,l,c,h,u,d,p,f,m,g=this.grad4,y=this.simplex,v=this.perm,w=(Math.sqrt(5)-1)/4,x=(5-Math.sqrt(5))/20,b=(e+t+r+s)*w,A=Math.floor(e+b),M=Math.floor(t+b),T=Math.floor(r+b),S=Math.floor(s+b),R=(A+M+T+S)*x,k=e-(A-R),E=t-(M-R),I=r-(T-R),L=s-(S-R),P=(k>E?32:0)+(k>I?16:0)+(E>I?8:0)+(k>L?4:0)+(E>L?2:0)+(I>L?1:0),C=k-(n=y[P][0]>=3?1:0)+x,_=E-(i=y[P][1]>=3?1:0)+x,F=I-(a=y[P][2]>=3?1:0)+x,B=L-(o=y[P][3]>=3?1:0)+x,D=k-(l=y[P][0]>=2?1:0)+2*x,O=E-(c=y[P][1]>=2?1:0)+2*x,N=I-(h=y[P][2]>=2?1:0)+2*x,z=L-(u=y[P][3]>=2?1:0)+2*x,U=k-(d=y[P][0]>=1?1:0)+3*x,G=E-(p=y[P][1]>=1?1:0)+3*x,V=I-(f=y[P][2]>=1?1:0)+3*x,H=L-(m=y[P][3]>=1?1:0)+3*x,j=k-1+4*x,W=E-1+4*x,X=I-1+4*x,q=L-1+4*x,K=255&A,Q=255&M,Y=255&T,Z=255&S,J=v[K+v[Q+v[Y+v[Z]]]]%32,$=v[K+n+v[Q+i+v[Y+a+v[Z+o]]]]%32,ee=v[K+l+v[Q+c+v[Y+h+v[Z+u]]]]%32,te=v[K+d+v[Q+p+v[Y+f+v[Z+m]]]]%32,re=v[K+1+v[Q+1+v[Y+1+v[Z+1]]]]%32,se=.6-k*k-E*E-I*I-L*L,ne=.6-C*C-_*_-F*F-B*B,ie=.6-D*D-O*O-N*N-z*z,ae=.6-U*U-G*G-V*V-H*H,oe=.6-j*j-W*W-X*X-q*q;return 27*((se<0?0:(se*=se)*se*this.dot4(g[J],k,E,I,L))+(ne<0?0:(ne*=ne)*ne*this.dot4(g[$],C,_,F,B))+(ie<0?0:(ie*=ie)*ie*this.dot4(g[ee],D,O,N,z))+(ae<0?0:(ae*=ae)*ae*this.dot4(g[te],U,G,V,H))+(oe<0?0:(oe*=oe)*oe*this.dot4(g[re],j,W,X,q)))}}class Ee extends t.Loader{constructor(e){super(e),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register((function(e){return new Fe(e)})),this.register((function(e){return new Ge(e)})),this.register((function(e){return new Ve(e)})),this.register((function(e){return new He(e)})),this.register((function(e){return new De(e)})),this.register((function(e){return new Oe(e)})),this.register((function(e){return new Ne(e)})),this.register((function(e){return new ze(e)})),this.register((function(e){return new _e(e)})),this.register((function(e){return new Ue(e)})),this.register((function(e){return new Be(e)})),this.register((function(e){return new Pe(e)})),this.register((function(e){return new je(e)})),this.register((function(e){return new We(e)}))}load(e,r,s,n){const i=this;let a;a=""!==this.resourcePath?this.resourcePath:""!==this.path?this.path:t.LoaderUtils.extractUrlBase(e),this.manager.itemStart(e);const o=function(t){n?n(t):console.error(t),i.manager.itemError(e),i.manager.itemEnd(e)},l=new t.FileLoader(this.manager);l.setPath(this.path),l.setResponseType("arraybuffer"),l.setRequestHeader(this.requestHeader),l.setWithCredentials(this.withCredentials),l.load(e,(function(t){try{i.parse(t,a,(function(t){r(t),i.manager.itemEnd(e)}),o)}catch(e){o(e)}}),s,o)}setDRACOLoader(e){return this.dracoLoader=e,this}setDDSLoader(){throw new Error('THREE.GLTFLoader: "MSFT_texture_dds" no longer supported. Please update to "KHR_texture_basisu".')}setKTX2Loader(e){return this.ktx2Loader=e,this}setMeshoptDecoder(e){return this.meshoptDecoder=e,this}register(e){return-1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this}unregister(e){return-1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,r,s){let n;const i={},a={},o=new TextDecoder;if("string"==typeof e)n=JSON.parse(e);else if(e instanceof ArrayBuffer){if(o.decode(new Uint8Array(e,0,4))===Xe){try{i[Le.KHR_BINARY_GLTF]=new Qe(e)}catch(e){return void(s&&s(e))}n=JSON.parse(i[Le.KHR_BINARY_GLTF].content)}else n=JSON.parse(o.decode(e))}else n=e;if(void 0===n.asset||n.asset.version[0]<2)return void(s&&s(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported.")));const l=new xt(n,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});l.fileLoader.setRequestHeader(this.requestHeader);for(let e=0;e<this.pluginCallbacks.length;e++){const t=this.pluginCallbacks[e](l);a[t.name]=t,i[t.name]=!0}if(n.extensionsUsed)for(let e=0;e<n.extensionsUsed.length;++e){const t=n.extensionsUsed[e],r=n.extensionsRequired||[];switch(t){case Le.KHR_MATERIALS_UNLIT:i[t]=new Ce;break;case Le.KHR_DRACO_MESH_COMPRESSION:i[t]=new Ye(n,this.dracoLoader);break;case Le.KHR_TEXTURE_TRANSFORM:i[t]=new Ze;break;case Le.KHR_MESH_QUANTIZATION:i[t]=new Je;break;default:r.indexOf(t)>=0&&void 0===a[t]&&console.warn('THREE.GLTFLoader: Unknown extension "'+t+'".')}}l.setExtensions(i),l.setPlugins(a),l.parse(r,s)}parseAsync(e,t){const r=this;return new Promise((function(s,n){r.parse(e,t,s,n)}))}}function Ie(){let e={};return{get:function(t){return e[t]},add:function(t,r){e[t]=r},remove:function(t){delete e[t]},removeAll:function(){e={}}}}const Le={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_IRIDESCENCE:"KHR_materials_iridescence",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",KHR_MATERIALS_EMISSIVE_STRENGTH:"KHR_materials_emissive_strength",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_TEXTURE_AVIF:"EXT_texture_avif",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression",EXT_MESH_GPU_INSTANCING:"EXT_mesh_gpu_instancing"};class Pe{constructor(e){this.parser=e,this.name=Le.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){const e=this.parser,t=this.parser.json.nodes||[];for(let r=0,s=t.length;r<s;r++){const s=t[r];s.extensions&&s.extensions[this.name]&&void 0!==s.extensions[this.name].light&&e._addNodeRef(this.cache,s.extensions[this.name].light)}}_loadLight(e){const r=this.parser,s="light:"+e;let n=r.cache.get(s);if(n)return n;const i=r.json,a=((i.extensions&&i.extensions[this.name]||{}).lights||[])[e];let o;const l=new t.Color(16777215);void 0!==a.color&&l.fromArray(a.color);const c=void 0!==a.range?a.range:0;switch(a.type){case"directional":o=new t.DirectionalLight(l),o.target.position.set(0,0,-1),o.add(o.target);break;case"point":o=new t.PointLight(l),o.distance=c;break;case"spot":o=new t.SpotLight(l),o.distance=c,a.spot=a.spot||{},a.spot.innerConeAngle=void 0!==a.spot.innerConeAngle?a.spot.innerConeAngle:0,a.spot.outerConeAngle=void 0!==a.spot.outerConeAngle?a.spot.outerConeAngle:Math.PI/4,o.angle=a.spot.outerConeAngle,o.penumbra=1-a.spot.innerConeAngle/a.spot.outerConeAngle,o.target.position.set(0,0,-1),o.add(o.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+a.type)}return o.position.set(0,0,0),o.decay=2,ft(o,a),void 0!==a.intensity&&(o.intensity=a.intensity),o.name=r.createUniqueName(a.name||"light_"+e),n=Promise.resolve(o),r.cache.add(s,n),n}getDependency(e,t){if("light"===e)return this._loadLight(t)}createNodeAttachment(e){const t=this,r=this.parser,s=r.json.nodes[e],n=(s.extensions&&s.extensions[this.name]||{}).light;return void 0===n?null:this._loadLight(n).then((function(e){return r._getNodeRef(t.cache,n,e)}))}}class Ce{constructor(){this.name=Le.KHR_MATERIALS_UNLIT}getMaterialType(){return t.MeshBasicMaterial}extendParams(e,r,s){const n=[];e.color=new t.Color(1,1,1),e.opacity=1;const i=r.pbrMetallicRoughness;if(i){if(Array.isArray(i.baseColorFactor)){const t=i.baseColorFactor;e.color.fromArray(t),e.opacity=t[3]}void 0!==i.baseColorTexture&&n.push(s.assignTexture(e,"map",i.baseColorTexture,t.sRGBEncoding))}return Promise.all(n)}}class _e{constructor(e){this.parser=e,this.name=Le.KHR_MATERIALS_EMISSIVE_STRENGTH}extendMaterialParams(e,t){const r=this.parser.json.materials[e];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();const s=r.extensions[this.name].emissiveStrength;return void 0!==s&&(t.emissiveIntensity=s),Promise.resolve()}}class Fe{constructor(e){this.parser=e,this.name=Le.KHR_MATERIALS_CLEARCOAT}getMaterialType(e){const r=this.parser.json.materials[e];return r.extensions&&r.extensions[this.name]?t.MeshPhysicalMaterial:null}extendMaterialParams(e,r){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=[],a=n.extensions[this.name];if(void 0!==a.clearcoatFactor&&(r.clearcoat=a.clearcoatFactor),void 0!==a.clearcoatTexture&&i.push(s.assignTexture(r,"clearcoatMap",a.clearcoatTexture)),void 0!==a.clearcoatRoughnessFactor&&(r.clearcoatRoughness=a.clearcoatRoughnessFactor),void 0!==a.clearcoatRoughnessTexture&&i.push(s.assignTexture(r,"clearcoatRoughnessMap",a.clearcoatRoughnessTexture)),void 0!==a.clearcoatNormalTexture&&(i.push(s.assignTexture(r,"clearcoatNormalMap",a.clearcoatNormalTexture)),void 0!==a.clearcoatNormalTexture.scale)){const e=a.clearcoatNormalTexture.scale;r.clearcoatNormalScale=new t.Vector2(e,e)}return Promise.all(i)}}class Be{constructor(e){this.parser=e,this.name=Le.KHR_MATERIALS_IRIDESCENCE}getMaterialType(e){const r=this.parser.json.materials[e];return r.extensions&&r.extensions[this.name]?t.MeshPhysicalMaterial:null}extendMaterialParams(e,t){const r=this.parser,s=r.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const n=[],i=s.extensions[this.name];return void 0!==i.iridescenceFactor&&(t.iridescence=i.iridescenceFactor),void 0!==i.iridescenceTexture&&n.push(r.assignTexture(t,"iridescenceMap",i.iridescenceTexture)),void 0!==i.iridescenceIor&&(t.iridescenceIOR=i.iridescenceIor),void 0===t.iridescenceThicknessRange&&(t.iridescenceThicknessRange=[100,400]),void 0!==i.iridescenceThicknessMinimum&&(t.iridescenceThicknessRange[0]=i.iridescenceThicknessMinimum),void 0!==i.iridescenceThicknessMaximum&&(t.iridescenceThicknessRange[1]=i.iridescenceThicknessMaximum),void 0!==i.iridescenceThicknessTexture&&n.push(r.assignTexture(t,"iridescenceThicknessMap",i.iridescenceThicknessTexture)),Promise.all(n)}}class De{constructor(e){this.parser=e,this.name=Le.KHR_MATERIALS_SHEEN}getMaterialType(e){const r=this.parser.json.materials[e];return r.extensions&&r.extensions[this.name]?t.MeshPhysicalMaterial:null}extendMaterialParams(e,r){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=[];r.sheenColor=new t.Color(0,0,0),r.sheenRoughness=0,r.sheen=1;const a=n.extensions[this.name];return void 0!==a.sheenColorFactor&&r.sheenColor.fromArray(a.sheenColorFactor),void 0!==a.sheenRoughnessFactor&&(r.sheenRoughness=a.sheenRoughnessFactor),void 0!==a.sheenColorTexture&&i.push(s.assignTexture(r,"sheenColorMap",a.sheenColorTexture,t.sRGBEncoding)),void 0!==a.sheenRoughnessTexture&&i.push(s.assignTexture(r,"sheenRoughnessMap",a.sheenRoughnessTexture)),Promise.all(i)}}class Oe{constructor(e){this.parser=e,this.name=Le.KHR_MATERIALS_TRANSMISSION}getMaterialType(e){const r=this.parser.json.materials[e];return r.extensions&&r.extensions[this.name]?t.MeshPhysicalMaterial:null}extendMaterialParams(e,t){const r=this.parser,s=r.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const n=[],i=s.extensions[this.name];return void 0!==i.transmissionFactor&&(t.transmission=i.transmissionFactor),void 0!==i.transmissionTexture&&n.push(r.assignTexture(t,"transmissionMap",i.transmissionTexture)),Promise.all(n)}}class Ne{constructor(e){this.parser=e,this.name=Le.KHR_MATERIALS_VOLUME}getMaterialType(e){const r=this.parser.json.materials[e];return r.extensions&&r.extensions[this.name]?t.MeshPhysicalMaterial:null}extendMaterialParams(e,r){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=[],a=n.extensions[this.name];r.thickness=void 0!==a.thicknessFactor?a.thicknessFactor:0,void 0!==a.thicknessTexture&&i.push(s.assignTexture(r,"thicknessMap",a.thicknessTexture)),r.attenuationDistance=a.attenuationDistance||1/0;const o=a.attenuationColor||[1,1,1];return r.attenuationColor=new t.Color(o[0],o[1],o[2]),Promise.all(i)}}class ze{constructor(e){this.parser=e,this.name=Le.KHR_MATERIALS_IOR}getMaterialType(e){const r=this.parser.json.materials[e];return r.extensions&&r.extensions[this.name]?t.MeshPhysicalMaterial:null}extendMaterialParams(e,t){const r=this.parser.json.materials[e];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();const s=r.extensions[this.name];return t.ior=void 0!==s.ior?s.ior:1.5,Promise.resolve()}}class Ue{constructor(e){this.parser=e,this.name=Le.KHR_MATERIALS_SPECULAR}getMaterialType(e){const r=this.parser.json.materials[e];return r.extensions&&r.extensions[this.name]?t.MeshPhysicalMaterial:null}extendMaterialParams(e,r){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=[],a=n.extensions[this.name];r.specularIntensity=void 0!==a.specularFactor?a.specularFactor:1,void 0!==a.specularTexture&&i.push(s.assignTexture(r,"specularIntensityMap",a.specularTexture));const o=a.specularColorFactor||[1,1,1];return r.specularColor=new t.Color(o[0],o[1],o[2]),void 0!==a.specularColorTexture&&i.push(s.assignTexture(r,"specularColorMap",a.specularColorTexture,t.sRGBEncoding)),Promise.all(i)}}class Ge{constructor(e){this.parser=e,this.name=Le.KHR_TEXTURE_BASISU}loadTexture(e){const t=this.parser,r=t.json,s=r.textures[e];if(!s.extensions||!s.extensions[this.name])return null;const n=s.extensions[this.name],i=t.options.ktx2Loader;if(!i){if(r.extensionsRequired&&r.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return t.loadTextureImage(e,n.source,i)}}class Ve{constructor(e){this.parser=e,this.name=Le.EXT_TEXTURE_WEBP,this.isSupported=null}loadTexture(e){const t=this.name,r=this.parser,s=r.json,n=s.textures[e];if(!n.extensions||!n.extensions[t])return null;const i=n.extensions[t],a=s.images[i.source];let o=r.textureLoader;if(a.uri){const e=r.options.manager.getHandler(a.uri);null!==e&&(o=e)}return this.detectSupport().then((function(n){if(n)return r.loadTextureImage(e,i.source,o);if(s.extensionsRequired&&s.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: WebP required by asset but unsupported.");return r.loadTexture(e)}))}detectSupport(){return this.isSupported||(this.isSupported=new Promise((function(e){const t=new Image;t.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",t.onload=t.onerror=function(){e(1===t.height)}}))),this.isSupported}}class He{constructor(e){this.parser=e,this.name=Le.EXT_TEXTURE_AVIF,this.isSupported=null}loadTexture(e){const t=this.name,r=this.parser,s=r.json,n=s.textures[e];if(!n.extensions||!n.extensions[t])return null;const i=n.extensions[t],a=s.images[i.source];let o=r.textureLoader;if(a.uri){const e=r.options.manager.getHandler(a.uri);null!==e&&(o=e)}return this.detectSupport().then((function(n){if(n)return r.loadTextureImage(e,i.source,o);if(s.extensionsRequired&&s.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: AVIF required by asset but unsupported.");return r.loadTexture(e)}))}detectSupport(){return this.isSupported||(this.isSupported=new Promise((function(e){const t=new Image;t.src="data:image/avif;base64,AAAAIGZ0eXBhdmlmAAAAAGF2aWZtaWYxbWlhZk1BMUIAAADybWV0YQAAAAAAAAAoaGRscgAAAAAAAAAAcGljdAAAAAAAAAAAAAAAAGxpYmF2aWYAAAAADnBpdG0AAAAAAAEAAAAeaWxvYwAAAABEAAABAAEAAAABAAABGgAAABcAAAAoaWluZgAAAAAAAQAAABppbmZlAgAAAAABAABhdjAxQ29sb3IAAAAAamlwcnAAAABLaXBjbwAAABRpc3BlAAAAAAAAAAEAAAABAAAAEHBpeGkAAAAAAwgICAAAAAxhdjFDgQAMAAAAABNjb2xybmNseAACAAIABoAAAAAXaXBtYQAAAAAAAAABAAEEAQKDBAAAAB9tZGF0EgAKCBgABogQEDQgMgkQAAAAB8dSLfI=",t.onload=t.onerror=function(){e(1===t.height)}}))),this.isSupported}}class je{constructor(e){this.name=Le.EXT_MESHOPT_COMPRESSION,this.parser=e}loadBufferView(e){const t=this.parser.json,r=t.bufferViews[e];if(r.extensions&&r.extensions[this.name]){const e=r.extensions[this.name],s=this.parser.getDependency("buffer",e.buffer),n=this.parser.options.meshoptDecoder;if(!n||!n.supported){if(t.extensionsRequired&&t.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return s.then((function(t){const r=e.byteOffset||0,s=e.byteLength||0,i=e.count,a=e.byteStride,o=new Uint8Array(t,r,s);return n.decodeGltfBufferAsync?n.decodeGltfBufferAsync(i,a,o,e.mode,e.filter).then((function(e){return e.buffer})):n.ready.then((function(){const t=new ArrayBuffer(i*a);return n.decodeGltfBuffer(new Uint8Array(t),i,a,o,e.mode,e.filter),t}))}))}return null}}class We{constructor(e){this.name=Le.EXT_MESH_GPU_INSTANCING,this.parser=e}createNodeMesh(e){const r=this.parser.json,s=r.nodes[e];if(!s.extensions||!s.extensions[this.name]||void 0===s.mesh)return null;const n=r.meshes[s.mesh];for(const e of n.primitives)if(e.mode!==rt.TRIANGLES&&e.mode!==rt.TRIANGLE_STRIP&&e.mode!==rt.TRIANGLE_FAN&&void 0!==e.mode)return null;const i=s.extensions[this.name].attributes,a=[],o={};for(const e in i)a.push(this.parser.getDependency("accessor",i[e]).then((t=>(o[e]=t,o[e]))));return a.length<1?null:(a.push(this.parser.createNodeMesh(e)),Promise.all(a).then((e=>{const r=e.pop(),s=r.isGroup?r.children:[r],n=e[0].count,i=[];for(const e of s){const r=new t.Matrix4,s=new t.Vector3,a=new t.Quaternion,l=new t.Vector3(1,1,1),c=new t.InstancedMesh(e.geometry,e.material,n);for(let e=0;e<n;e++)o.TRANSLATION&&s.fromBufferAttribute(o.TRANSLATION,e),o.ROTATION&&a.fromBufferAttribute(o.ROTATION,e),o.SCALE&&l.fromBufferAttribute(o.SCALE,e),c.setMatrixAt(e,r.compose(s,a,l));for(const t in o)"TRANSLATION"!==t&&"ROTATION"!==t&&"SCALE"!==t&&e.geometry.setAttribute(t,o[t]);t.Object3D.prototype.copy.call(c,e),c.frustumCulled=!1,this.parser.assignFinalMaterial(c),i.push(c)}return r.isGroup?(r.clear(),r.add(...i),r):i[0]})))}}const Xe="glTF",qe=1313821514,Ke=5130562;class Qe{constructor(e){this.name=Le.KHR_BINARY_GLTF,this.content=null,this.body=null;const t=new DataView(e,0,12),r=new TextDecoder;if(this.header={magic:r.decode(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==Xe)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");const s=this.header.length-12,n=new DataView(e,12);let i=0;for(;i<s;){const t=n.getUint32(i,!0);i+=4;const s=n.getUint32(i,!0);if(i+=4,s===qe){const s=new Uint8Array(e,12+i,t);this.content=r.decode(s)}else if(s===Ke){const r=12+i;this.body=e.slice(r,r+t)}i+=t}if(null===this.content)throw new Error("THREE.GLTFLoader: JSON content not found.")}}class Ye{constructor(e,t){if(!t)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=Le.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}decodePrimitive(e,t){const r=this.json,s=this.dracoLoader,n=e.extensions[this.name].bufferView,i=e.extensions[this.name].attributes,a={},o={},l={};for(const e in i){const t=ot[e]||e.toLowerCase();a[t]=i[e]}for(const t in e.attributes){const s=ot[t]||t.toLowerCase();if(void 0!==i[t]){const n=r.accessors[e.attributes[t]],i=st[n.componentType];l[s]=i.name,o[s]=!0===n.normalized}}return t.getDependency("bufferView",n).then((function(e){return new Promise((function(t){s.decodeDracoFile(e,(function(e){for(const t in e.attributes){const r=e.attributes[t],s=o[t];void 0!==s&&(r.normalized=s)}t(e)}),a,l)}))}))}}class Ze{constructor(){this.name=Le.KHR_TEXTURE_TRANSFORM}extendTexture(e,t){return void 0!==t.texCoord&&console.warn('THREE.GLTFLoader: Custom UV sets in "'+this.name+'" extension not yet supported.'),void 0===t.offset&&void 0===t.rotation&&void 0===t.scale||(e=e.clone(),void 0!==t.offset&&e.offset.fromArray(t.offset),void 0!==t.rotation&&(e.rotation=t.rotation),void 0!==t.scale&&e.repeat.fromArray(t.scale),e.needsUpdate=!0),e}}class Je{constructor(){this.name=Le.KHR_MESH_QUANTIZATION}}class $e extends t.Interpolant{constructor(e,t,r,s){super(e,t,r,s)}copySampleValue_(e){const t=this.resultBuffer,r=this.sampleValues,s=this.valueSize,n=e*s*3+s;for(let e=0;e!==s;e++)t[e]=r[n+e];return t}interpolate_(e,t,r,s){const n=this.resultBuffer,i=this.sampleValues,a=this.valueSize,o=2*a,l=3*a,c=s-t,h=(r-t)/c,u=h*h,d=u*h,p=e*l,f=p-l,m=-2*d+3*u,g=d-u,y=1-m,v=g-u+h;for(let e=0;e!==a;e++){const t=i[f+e+a],r=i[f+e+o]*c,s=i[p+e+a],l=i[p+e]*c;n[e]=y*t+v*r+m*s+g*l}return n}}const et=new t.Quaternion;class tt extends $e{interpolate_(e,t,r,s){const n=super.interpolate_(e,t,r,s);return et.fromArray(n).normalize().toArray(n),n}}const rt={FLOAT:5126,FLOAT_MAT3:35675,FLOAT_MAT4:35676,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,LINEAR:9729,REPEAT:10497,SAMPLER_2D:35678,POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,UNSIGNED_BYTE:5121,UNSIGNED_SHORT:5123},st={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},nt={9728:t.NearestFilter,9729:t.LinearFilter,9984:t.NearestMipmapNearestFilter,9985:t.LinearMipmapNearestFilter,9986:t.NearestMipmapLinearFilter,9987:t.LinearMipmapLinearFilter},it={33071:t.ClampToEdgeWrapping,33648:t.MirroredRepeatWrapping,10497:t.RepeatWrapping},at={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},ot={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv2",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},lt={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},ct={CUBICSPLINE:void 0,LINEAR:t.InterpolateLinear,STEP:t.InterpolateDiscrete},ht="OPAQUE",ut="MASK",dt="BLEND";function pt(e,t,r){for(const s in r.extensions)void 0===e[s]&&(t.userData.gltfExtensions=t.userData.gltfExtensions||{},t.userData.gltfExtensions[s]=r.extensions[s])}function ft(e,t){void 0!==t.extras&&("object"==typeof t.extras?Object.assign(e.userData,t.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+t.extras))}function mt(e,t){if(e.updateMorphTargets(),void 0!==t.weights)for(let r=0,s=t.weights.length;r<s;r++)e.morphTargetInfluences[r]=t.weights[r];if(t.extras&&Array.isArray(t.extras.targetNames)){const r=t.extras.targetNames;if(e.morphTargetInfluences.length===r.length){e.morphTargetDictionary={};for(let t=0,s=r.length;t<s;t++)e.morphTargetDictionary[r[t]]=t}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function gt(e){const t=e.extensions&&e.extensions[Le.KHR_DRACO_MESH_COMPRESSION];let r;return r=t?"draco:"+t.bufferView+":"+t.indices+":"+yt(t.attributes):e.indices+":"+yt(e.attributes)+":"+e.mode,r}function yt(e){let t="";const r=Object.keys(e).sort();for(let s=0,n=r.length;s<n;s++)t+=r[s]+":"+e[r[s]]+";";return t}function vt(e){switch(e){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}const wt=new t.Matrix4;class xt{constructor(e={},r={}){this.json=e,this.extensions={},this.plugins={},this.options=r,this.cache=new Ie,this.associations=new Map,this.primitiveCache={},this.nodeCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={};let s=!1,n=!1,i=-1;"undefined"!=typeof navigator&&(s=!0===/^((?!chrome|android).)*safari/i.test(navigator.userAgent),n=navigator.userAgent.indexOf("Firefox")>-1,i=n?navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1]:-1),"undefined"==typeof createImageBitmap||s||n&&i<98?this.textureLoader=new t.TextureLoader(this.options.manager):this.textureLoader=new t.ImageBitmapLoader(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new t.FileLoader(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),"use-credentials"===this.options.crossOrigin&&this.fileLoader.setWithCredentials(!0)}setExtensions(e){this.extensions=e}setPlugins(e){this.plugins=e}parse(e,t){const r=this,s=this.json,n=this.extensions;this.cache.removeAll(),this.nodeCache={},this._invokeAll((function(e){return e._markDefs&&e._markDefs()})),Promise.all(this._invokeAll((function(e){return e.beforeRoot&&e.beforeRoot()}))).then((function(){return Promise.all([r.getDependencies("scene"),r.getDependencies("animation"),r.getDependencies("camera")])})).then((function(t){const i={scene:t[0][s.scene||0],scenes:t[0],animations:t[1],cameras:t[2],asset:s.asset,parser:r,userData:{}};pt(n,i,s),ft(i,s),Promise.all(r._invokeAll((function(e){return e.afterRoot&&e.afterRoot(i)}))).then((function(){e(i)}))})).catch(t)}_markDefs(){const e=this.json.nodes||[],t=this.json.skins||[],r=this.json.meshes||[];for(let r=0,s=t.length;r<s;r++){const s=t[r].joints;for(let t=0,r=s.length;t<r;t++)e[s[t]].isBone=!0}for(let t=0,s=e.length;t<s;t++){const s=e[t];void 0!==s.mesh&&(this._addNodeRef(this.meshCache,s.mesh),void 0!==s.skin&&(r[s.mesh].isSkinnedMesh=!0)),void 0!==s.camera&&this._addNodeRef(this.cameraCache,s.camera)}}_addNodeRef(e,t){void 0!==t&&(void 0===e.refs[t]&&(e.refs[t]=e.uses[t]=0),e.refs[t]++)}_getNodeRef(e,t,r){if(e.refs[t]<=1)return r;const s=r.clone(),n=(e,t)=>{const r=this.associations.get(e);null!=r&&this.associations.set(t,r);for(const[r,s]of e.children.entries())n(s,t.children[r])};return n(r,s),s.name+="_instance_"+e.uses[t]++,s}_invokeOne(e){const t=Object.values(this.plugins);t.push(this);for(let r=0;r<t.length;r++){const s=e(t[r]);if(s)return s}return null}_invokeAll(e){const t=Object.values(this.plugins);t.unshift(this);const r=[];for(let s=0;s<t.length;s++){const n=e(t[s]);n&&r.push(n)}return r}getDependency(e,t){const r=e+":"+t;let s=this.cache.get(r);if(!s){switch(e){case"scene":s=this.loadScene(t);break;case"node":s=this._invokeOne((function(e){return e.loadNode&&e.loadNode(t)}));break;case"mesh":s=this._invokeOne((function(e){return e.loadMesh&&e.loadMesh(t)}));break;case"accessor":s=this.loadAccessor(t);break;case"bufferView":s=this._invokeOne((function(e){return e.loadBufferView&&e.loadBufferView(t)}));break;case"buffer":s=this.loadBuffer(t);break;case"material":s=this._invokeOne((function(e){return e.loadMaterial&&e.loadMaterial(t)}));break;case"texture":s=this._invokeOne((function(e){return e.loadTexture&&e.loadTexture(t)}));break;case"skin":s=this.loadSkin(t);break;case"animation":s=this._invokeOne((function(e){return e.loadAnimation&&e.loadAnimation(t)}));break;case"camera":s=this.loadCamera(t);break;default:if(s=this._invokeOne((function(r){return r!=this&&r.getDependency&&r.getDependency(e,t)})),!s)throw new Error("Unknown type: "+e)}this.cache.add(r,s)}return s}getDependencies(e){let t=this.cache.get(e);if(!t){const r=this,s=this.json[e+("mesh"===e?"es":"s")]||[];t=Promise.all(s.map((function(t,s){return r.getDependency(e,s)}))),this.cache.add(e,t)}return t}loadBuffer(e){const r=this.json.buffers[e],s=this.fileLoader;if(r.type&&"arraybuffer"!==r.type)throw new Error("THREE.GLTFLoader: "+r.type+" buffer type is not supported.");if(void 0===r.uri&&0===e)return Promise.resolve(this.extensions[Le.KHR_BINARY_GLTF].body);const n=this.options;return new Promise((function(e,i){s.load(t.LoaderUtils.resolveURL(r.uri,n.path),e,void 0,(function(){i(new Error('THREE.GLTFLoader: Failed to load buffer "'+r.uri+'".'))}))}))}loadBufferView(e){const t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then((function(e){const r=t.byteLength||0,s=t.byteOffset||0;return e.slice(s,s+r)}))}loadAccessor(e){const r=this,s=this.json,n=this.json.accessors[e];if(void 0===n.bufferView&&void 0===n.sparse){const e=at[n.type],r=st[n.componentType],s=!0===n.normalized,i=new r(n.count*e);return Promise.resolve(new t.BufferAttribute(i,e,s))}const i=[];return void 0!==n.bufferView?i.push(this.getDependency("bufferView",n.bufferView)):i.push(null),void 0!==n.sparse&&(i.push(this.getDependency("bufferView",n.sparse.indices.bufferView)),i.push(this.getDependency("bufferView",n.sparse.values.bufferView))),Promise.all(i).then((function(e){const i=e[0],a=at[n.type],o=st[n.componentType],l=o.BYTES_PER_ELEMENT,c=l*a,h=n.byteOffset||0,u=void 0!==n.bufferView?s.bufferViews[n.bufferView].byteStride:void 0,d=!0===n.normalized;let p,f;if(u&&u!==c){const e=Math.floor(h/u),s="InterleavedBuffer:"+n.bufferView+":"+n.componentType+":"+e+":"+n.count;let c=r.cache.get(s);c||(p=new o(i,e*u,n.count*u/l),c=new t.InterleavedBuffer(p,u/l),r.cache.add(s,c)),f=new t.InterleavedBufferAttribute(c,a,h%u/l,d)}else p=null===i?new o(n.count*a):new o(i,h,n.count*a),f=new t.BufferAttribute(p,a,d);if(void 0!==n.sparse){const r=at.SCALAR,s=st[n.sparse.indices.componentType],l=n.sparse.indices.byteOffset||0,c=n.sparse.values.byteOffset||0,h=new s(e[1],l,n.sparse.count*r),u=new o(e[2],c,n.sparse.count*a);null!==i&&(f=new t.BufferAttribute(f.array.slice(),f.itemSize,f.normalized));for(let e=0,t=h.length;e<t;e++){const t=h[e];if(f.setX(t,u[e*a]),a>=2&&f.setY(t,u[e*a+1]),a>=3&&f.setZ(t,u[e*a+2]),a>=4&&f.setW(t,u[e*a+3]),a>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}}return f}))}loadTexture(e){const t=this.json,r=this.options,s=t.textures[e].source,n=t.images[s];let i=this.textureLoader;if(n.uri){const e=r.manager.getHandler(n.uri);null!==e&&(i=e)}return this.loadTextureImage(e,s,i)}loadTextureImage(e,r,s){const n=this,i=this.json,a=i.textures[e],o=i.images[r],l=(o.uri||o.bufferView)+":"+a.sampler;if(this.textureCache[l])return this.textureCache[l];const c=this.loadImageSource(r,s).then((function(r){r.flipY=!1,r.name=a.name||o.name||"";const s=(i.samplers||{})[a.sampler]||{};return r.magFilter=nt[s.magFilter]||t.LinearFilter,r.minFilter=nt[s.minFilter]||t.LinearMipmapLinearFilter,r.wrapS=it[s.wrapS]||t.RepeatWrapping,r.wrapT=it[s.wrapT]||t.RepeatWrapping,n.associations.set(r,{textures:e}),r})).catch((function(){return null}));return this.textureCache[l]=c,c}loadImageSource(e,r){const s=this,n=this.json,i=this.options;if(void 0!==this.sourceCache[e])return this.sourceCache[e].then((e=>e.clone()));const a=n.images[e],o=self.URL||self.webkitURL;let l=a.uri||"",c=!1;if(void 0!==a.bufferView)l=s.getDependency("bufferView",a.bufferView).then((function(e){c=!0;const t=new Blob([e],{type:a.mimeType});return l=o.createObjectURL(t),l}));else if(void 0===a.uri)throw new Error("THREE.GLTFLoader: Image "+e+" is missing URI and bufferView");const h=Promise.resolve(l).then((function(e){return new Promise((function(s,n){let a=s;!0===r.isImageBitmapLoader&&(a=function(e){const r=new t.Texture(e);r.needsUpdate=!0,s(r)}),r.load(t.LoaderUtils.resolveURL(e,i.path),a,void 0,n)}))})).then((function(e){var t;return!0===c&&o.revokeObjectURL(l),e.userData.mimeType=a.mimeType||((t=a.uri).search(/\.jpe?g($|\?)/i)>0||0===t.search(/^data\:image\/jpeg/)?"image/jpeg":t.search(/\.webp($|\?)/i)>0||0===t.search(/^data\:image\/webp/)?"image/webp":"image/png"),e})).catch((function(e){throw console.error("THREE.GLTFLoader: Couldn't load texture",l),e}));return this.sourceCache[e]=h,h}assignTexture(e,t,r,s){const n=this;return this.getDependency("texture",r.index).then((function(i){if(!i)return null;if(void 0===r.texCoord||0==r.texCoord||"aoMap"===t&&1==r.texCoord||console.warn("THREE.GLTFLoader: Custom UV set "+r.texCoord+" for texture "+t+" not yet supported."),n.extensions[Le.KHR_TEXTURE_TRANSFORM]){const e=void 0!==r.extensions?r.extensions[Le.KHR_TEXTURE_TRANSFORM]:void 0;if(e){const t=n.associations.get(i);i=n.extensions[Le.KHR_TEXTURE_TRANSFORM].extendTexture(i,e),n.associations.set(i,t)}}return void 0!==s&&(i.encoding=s),e[t]=i,i}))}assignFinalMaterial(e){const r=e.geometry;let s=e.material;const n=void 0===r.attributes.tangent,i=void 0!==r.attributes.color,a=void 0===r.attributes.normal;if(e.isPoints){const e="PointsMaterial:"+s.uuid;let r=this.cache.get(e);r||(r=new t.PointsMaterial,t.Material.prototype.copy.call(r,s),r.color.copy(s.color),r.map=s.map,r.sizeAttenuation=!1,this.cache.add(e,r)),s=r}else if(e.isLine){const e="LineBasicMaterial:"+s.uuid;let r=this.cache.get(e);r||(r=new t.LineBasicMaterial,t.Material.prototype.copy.call(r,s),r.color.copy(s.color),this.cache.add(e,r)),s=r}if(n||i||a){let e="ClonedMaterial:"+s.uuid+":";n&&(e+="derivative-tangents:"),i&&(e+="vertex-colors:"),a&&(e+="flat-shading:");let t=this.cache.get(e);t||(t=s.clone(),i&&(t.vertexColors=!0),a&&(t.flatShading=!0),n&&(t.normalScale&&(t.normalScale.y*=-1),t.clearcoatNormalScale&&(t.clearcoatNormalScale.y*=-1)),this.cache.add(e,t),this.associations.set(t,this.associations.get(s))),s=t}s.aoMap&&void 0===r.attributes.uv2&&void 0!==r.attributes.uv&&r.setAttribute("uv2",r.attributes.uv),e.material=s}getMaterialType(){return t.MeshStandardMaterial}loadMaterial(e){const r=this,s=this.json,n=this.extensions,i=s.materials[e];let a;const o={},l=[];if((i.extensions||{})[Le.KHR_MATERIALS_UNLIT]){const e=n[Le.KHR_MATERIALS_UNLIT];a=e.getMaterialType(),l.push(e.extendParams(o,i,r))}else{const s=i.pbrMetallicRoughness||{};if(o.color=new t.Color(1,1,1),o.opacity=1,Array.isArray(s.baseColorFactor)){const e=s.baseColorFactor;o.color.fromArray(e),o.opacity=e[3]}void 0!==s.baseColorTexture&&l.push(r.assignTexture(o,"map",s.baseColorTexture,t.sRGBEncoding)),o.metalness=void 0!==s.metallicFactor?s.metallicFactor:1,o.roughness=void 0!==s.roughnessFactor?s.roughnessFactor:1,void 0!==s.metallicRoughnessTexture&&(l.push(r.assignTexture(o,"metalnessMap",s.metallicRoughnessTexture)),l.push(r.assignTexture(o,"roughnessMap",s.metallicRoughnessTexture))),a=this._invokeOne((function(t){return t.getMaterialType&&t.getMaterialType(e)})),l.push(Promise.all(this._invokeAll((function(t){return t.extendMaterialParams&&t.extendMaterialParams(e,o)}))))}!0===i.doubleSided&&(o.side=t.DoubleSide);const c=i.alphaMode||ht;if(c===dt?(o.transparent=!0,o.depthWrite=!1):(o.transparent=!1,c===ut&&(o.alphaTest=void 0!==i.alphaCutoff?i.alphaCutoff:.5)),void 0!==i.normalTexture&&a!==t.MeshBasicMaterial&&(l.push(r.assignTexture(o,"normalMap",i.normalTexture)),o.normalScale=new t.Vector2(1,1),void 0!==i.normalTexture.scale)){const e=i.normalTexture.scale;o.normalScale.set(e,e)}return void 0!==i.occlusionTexture&&a!==t.MeshBasicMaterial&&(l.push(r.assignTexture(o,"aoMap",i.occlusionTexture)),void 0!==i.occlusionTexture.strength&&(o.aoMapIntensity=i.occlusionTexture.strength)),void 0!==i.emissiveFactor&&a!==t.MeshBasicMaterial&&(o.emissive=(new t.Color).fromArray(i.emissiveFactor)),void 0!==i.emissiveTexture&&a!==t.MeshBasicMaterial&&l.push(r.assignTexture(o,"emissiveMap",i.emissiveTexture,t.sRGBEncoding)),Promise.all(l).then((function(){const t=new a(o);return i.name&&(t.name=i.name),ft(t,i),r.associations.set(t,{materials:e}),i.extensions&&pt(n,t,i),t}))}createUniqueName(e){const r=t.PropertyBinding.sanitizeNodeName(e||"");let s=r;for(let e=1;this.nodeNamesUsed[s];++e)s=r+"_"+e;return this.nodeNamesUsed[s]=!0,s}loadGeometries(e){const r=this,s=this.extensions,n=this.primitiveCache;function i(e){return s[Le.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(e,r).then((function(t){return bt(t,e,r)}))}const a=[];for(let s=0,o=e.length;s<o;s++){const o=e[s],l=gt(o),c=n[l];if(c)a.push(c.promise);else{let e;e=o.extensions&&o.extensions[Le.KHR_DRACO_MESH_COMPRESSION]?i(o):bt(new t.BufferGeometry,o,r),n[l]={primitive:o,promise:e},a.push(e)}}return Promise.all(a)}loadMesh(e){const r=this,s=this.json,n=this.extensions,i=s.meshes[e],a=i.primitives,o=[];for(let e=0,r=a.length;e<r;e++){const r=void 0===a[e].material?(void 0===(l=this.cache).DefaultMaterial&&(l.DefaultMaterial=new t.MeshStandardMaterial({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:t.FrontSide})),l.DefaultMaterial):this.getDependency("material",a[e].material);o.push(r)}var l;return o.push(r.loadGeometries(a)),Promise.all(o).then((function(s){const o=s.slice(0,s.length-1),l=s[s.length-1],c=[];for(let s=0,h=l.length;s<h;s++){const h=l[s],u=a[s];let d;const p=o[s];if(u.mode===rt.TRIANGLES||u.mode===rt.TRIANGLE_STRIP||u.mode===rt.TRIANGLE_FAN||void 0===u.mode)d=!0===i.isSkinnedMesh?new t.SkinnedMesh(h,p):new t.Mesh(h,p),!0!==d.isSkinnedMesh||d.geometry.attributes.skinWeight.normalized||d.normalizeSkinWeights(),u.mode===rt.TRIANGLE_STRIP?d.geometry=J(d.geometry,t.TriangleStripDrawMode):u.mode===rt.TRIANGLE_FAN&&(d.geometry=J(d.geometry,t.TriangleFanDrawMode));else if(u.mode===rt.LINES)d=new t.LineSegments(h,p);else if(u.mode===rt.LINE_STRIP)d=new t.Line(h,p);else if(u.mode===rt.LINE_LOOP)d=new t.LineLoop(h,p);else{if(u.mode!==rt.POINTS)throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+u.mode);d=new t.Points(h,p)}Object.keys(d.geometry.morphAttributes).length>0&&mt(d,i),d.name=r.createUniqueName(i.name||"mesh_"+e),ft(d,i),u.extensions&&pt(n,d,u),r.assignFinalMaterial(d),c.push(d)}for(let t=0,s=c.length;t<s;t++)r.associations.set(c[t],{meshes:e,primitives:t});if(1===c.length)return c[0];const h=new t.Group;r.associations.set(h,{meshes:e});for(let e=0,t=c.length;e<t;e++)h.add(c[e]);return h}))}loadCamera(e){let r;const s=this.json.cameras[e],n=s[s.type];if(n)return"perspective"===s.type?r=new t.PerspectiveCamera(t.MathUtils.radToDeg(n.yfov),n.aspectRatio||1,n.znear||1,n.zfar||2e6):"orthographic"===s.type&&(r=new t.OrthographicCamera(-n.xmag,n.xmag,n.ymag,-n.ymag,n.znear,n.zfar)),s.name&&(r.name=this.createUniqueName(s.name)),ft(r,s),Promise.resolve(r);console.warn("THREE.GLTFLoader: Missing camera parameters.")}loadSkin(e){const r=this.json.skins[e],s=[];for(let e=0,t=r.joints.length;e<t;e++)s.push(this._loadNodeShallow(r.joints[e]));return void 0!==r.inverseBindMatrices?s.push(this.getDependency("accessor",r.inverseBindMatrices)):s.push(null),Promise.all(s).then((function(e){const s=e.pop(),n=e,i=[],a=[];for(let e=0,o=n.length;e<o;e++){const o=n[e];if(o){i.push(o);const r=new t.Matrix4;null!==s&&r.fromArray(s.array,16*e),a.push(r)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',r.joints[e])}return new t.Skeleton(i,a)}))}loadAnimation(e){const r=this.json.animations[e],s=[],n=[],i=[],a=[],o=[];for(let e=0,t=r.channels.length;e<t;e++){const t=r.channels[e],l=r.samplers[t.sampler],c=t.target,h=c.node,u=void 0!==r.parameters?r.parameters[l.input]:l.input,d=void 0!==r.parameters?r.parameters[l.output]:l.output;s.push(this.getDependency("node",h)),n.push(this.getDependency("accessor",u)),i.push(this.getDependency("accessor",d)),a.push(l),o.push(c)}return Promise.all([Promise.all(s),Promise.all(n),Promise.all(i),Promise.all(a),Promise.all(o)]).then((function(s){const n=s[0],i=s[1],a=s[2],o=s[3],l=s[4],c=[];for(let e=0,r=n.length;e<r;e++){const r=n[e],s=i[e],h=a[e],u=o[e],d=l[e];if(void 0===r)continue;let p;switch(r.updateMatrix(),lt[d.path]){case lt.weights:p=t.NumberKeyframeTrack;break;case lt.rotation:p=t.QuaternionKeyframeTrack;break;case lt.position:case lt.scale:default:p=t.VectorKeyframeTrack}const f=r.name?r.name:r.uuid,m=void 0!==u.interpolation?ct[u.interpolation]:t.InterpolateLinear,g=[];lt[d.path]===lt.weights?r.traverse((function(e){e.morphTargetInfluences&&g.push(e.name?e.name:e.uuid)})):g.push(f);let y=h.array;if(h.normalized){const e=vt(y.constructor),t=new Float32Array(y.length);for(let r=0,s=y.length;r<s;r++)t[r]=y[r]*e;y=t}for(let e=0,r=g.length;e<r;e++){const r=new p(g[e]+"."+lt[d.path],s.array,y,m);"CUBICSPLINE"===u.interpolation&&(r.createInterpolant=function(e){return new(this instanceof t.QuaternionKeyframeTrack?tt:$e)(this.times,this.values,this.getValueSize()/3,e)},r.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0),c.push(r)}}const h=r.name?r.name:"animation_"+e;return new t.AnimationClip(h,void 0,c)}))}createNodeMesh(e){const t=this.json,r=this,s=t.nodes[e];return void 0===s.mesh?null:r.getDependency("mesh",s.mesh).then((function(e){const t=r._getNodeRef(r.meshCache,s.mesh,e);return void 0!==s.weights&&t.traverse((function(e){if(e.isMesh)for(let t=0,r=s.weights.length;t<r;t++)e.morphTargetInfluences[t]=s.weights[t]})),t}))}loadNode(e){const t=this.json,r=this,s=t.nodes[e];return function(){const t=r._loadNodeShallow(e),n=[],i=s.children||[];for(let e=0,t=i.length;e<t;e++)n.push(r.getDependency("node",i[e]));const a=void 0===s.skin?Promise.resolve(null):r.getDependency("skin",s.skin);return Promise.all([t,Promise.all(n),a])}().then((function(e){const t=e[0],r=e[1],s=e[2];null!==s&&t.traverse((function(e){e.isSkinnedMesh&&e.bind(s,wt)}));for(let e=0,s=r.length;e<s;e++)t.add(r[e]);return t}))}_loadNodeShallow(e){const r=this.json,s=this.extensions,n=this;if(void 0!==this.nodeCache[e])return this.nodeCache[e];const i=r.nodes[e],a=i.name?n.createUniqueName(i.name):"";return this.nodeCache[e]=function(){const t=[],r=n._invokeOne((function(t){return t.createNodeMesh&&t.createNodeMesh(e)}));return r&&t.push(r),void 0!==i.camera&&t.push(n.getDependency("camera",i.camera).then((function(e){return n._getNodeRef(n.cameraCache,i.camera,e)}))),n._invokeAll((function(t){return t.createNodeAttachment&&t.createNodeAttachment(e)})).forEach((function(e){t.push(e)})),Promise.all(t)}().then((function(r){let o;if(o=!0===i.isBone?new t.Bone:r.length>1?new t.Group:1===r.length?r[0]:new t.Object3D,o!==r[0])for(let e=0,t=r.length;e<t;e++)o.add(r[e]);if(i.name&&(o.userData.name=i.name,o.name=a),ft(o,i),i.extensions&&pt(s,o,i),void 0!==i.matrix){const e=new t.Matrix4;e.fromArray(i.matrix),o.applyMatrix4(e)}else void 0!==i.translation&&o.position.fromArray(i.translation),void 0!==i.rotation&&o.quaternion.fromArray(i.rotation),void 0!==i.scale&&o.scale.fromArray(i.scale);return n.associations.has(o)||n.associations.set(o,{}),n.associations.get(o).nodes=e,o})),this.nodeCache[e]}loadScene(e){const r=this.extensions,s=this.json.scenes[e],n=this,i=new t.Group;s.name&&(i.name=n.createUniqueName(s.name)),ft(i,s),s.extensions&&pt(r,i,s);const a=s.nodes||[],o=[];for(let e=0,t=a.length;e<t;e++)o.push(n.getDependency("node",a[e]));return Promise.all(o).then((function(e){for(let t=0,r=e.length;t<r;t++)i.add(e[t]);return n.associations=(e=>{const r=new Map;for(const[e,s]of n.associations)(e instanceof t.Material||e instanceof t.Texture)&&r.set(e,s);return e.traverse((e=>{const t=n.associations.get(e);null!=t&&r.set(e,t)})),r})(i),i}))}}function bt(e,r,s){const n=r.attributes,i=[];function a(t,r){return s.getDependency("accessor",t).then((function(t){e.setAttribute(r,t)}))}for(const t in n){const r=ot[t]||t.toLowerCase();r in e.attributes||i.push(a(n[t],r))}if(void 0!==r.indices&&!e.index){const t=s.getDependency("accessor",r.indices).then((function(t){e.setIndex(t)}));i.push(t)}return ft(e,r),function(e,r,s){const n=r.attributes,i=new t.Box3;if(void 0===n.POSITION)return;{const e=s.json.accessors[n.POSITION],r=e.min,a=e.max;if(void 0===r||void 0===a)return void console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");if(i.set(new t.Vector3(r[0],r[1],r[2]),new t.Vector3(a[0],a[1],a[2])),e.normalized){const t=vt(st[e.componentType]);i.min.multiplyScalar(t),i.max.multiplyScalar(t)}}const a=r.targets;if(void 0!==a){const e=new t.Vector3,r=new t.Vector3;for(let t=0,n=a.length;t<n;t++){const n=a[t];if(void 0!==n.POSITION){const t=s.json.accessors[n.POSITION],i=t.min,a=t.max;if(void 0!==i&&void 0!==a){if(r.setX(Math.max(Math.abs(i[0]),Math.abs(a[0]))),r.setY(Math.max(Math.abs(i[1]),Math.abs(a[1]))),r.setZ(Math.max(Math.abs(i[2]),Math.abs(a[2]))),t.normalized){const e=vt(st[t.componentType]);r.multiplyScalar(e)}e.max(r)}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}i.expandByVector(e)}e.boundingBox=i;const o=new t.Sphere;i.getCenter(o.center),o.radius=i.min.distanceTo(i.max)/2,e.boundingSphere=o}(e,r,s),Promise.all(i).then((function(){return void 0!==r.targets?function(e,t,r){let s=!1,n=!1,i=!1;for(let e=0,r=t.length;e<r;e++){const r=t[e];if(void 0!==r.POSITION&&(s=!0),void 0!==r.NORMAL&&(n=!0),void 0!==r.COLOR_0&&(i=!0),s&&n&&i)break}if(!s&&!n&&!i)return Promise.resolve(e);const a=[],o=[],l=[];for(let c=0,h=t.length;c<h;c++){const h=t[c];if(s){const t=void 0!==h.POSITION?r.getDependency("accessor",h.POSITION):e.attributes.position;a.push(t)}if(n){const t=void 0!==h.NORMAL?r.getDependency("accessor",h.NORMAL):e.attributes.normal;o.push(t)}if(i){const t=void 0!==h.COLOR_0?r.getDependency("accessor",h.COLOR_0):e.attributes.color;l.push(t)}}return Promise.all([Promise.all(a),Promise.all(o),Promise.all(l)]).then((function(t){const r=t[0],a=t[1],o=t[2];return s&&(e.morphAttributes.position=r),n&&(e.morphAttributes.normal=a),i&&(e.morphAttributes.color=o),e.morphTargetsRelative=!0,e}))}(e,r.targets,s):e}))}const At=new WeakMap;class Mt extends t.Loader{constructor(e){super(e),this.decoderPath="",this.decoderConfig={},this.decoderBinary=null,this.decoderPending=null,this.workerLimit=4,this.workerPool=[],this.workerNextTaskID=1,this.workerSourceURL="",this.defaultAttributeIDs={position:"POSITION",normal:"NORMAL",color:"COLOR",uv:"TEX_COORD"},this.defaultAttributeTypes={position:"Float32Array",normal:"Float32Array",color:"Float32Array",uv:"Float32Array"}}setDecoderPath(e){return this.decoderPath=e,this}setDecoderConfig(e){return this.decoderConfig=e,this}setWorkerLimit(e){return this.workerLimit=e,this}load(e,r,s,n){const i=new t.FileLoader(this.manager);i.setPath(this.path),i.setResponseType("arraybuffer"),i.setRequestHeader(this.requestHeader),i.setWithCredentials(this.withCredentials),i.load(e,(e=>{this.decodeDracoFile(e,r).catch(n)}),s,n)}decodeDracoFile(e,t,r,s){const n={attributeIDs:r||this.defaultAttributeIDs,attributeTypes:s||this.defaultAttributeTypes,useUniqueIDs:!!r};return this.decodeGeometry(e,n).then(t)}decodeGeometry(e,t){const r=JSON.stringify(t);if(At.has(e)){const t=At.get(e);if(t.key===r)return t.promise;if(0===e.byteLength)throw new Error("THREE.DRACOLoader: Unable to re-decode a buffer with different settings. Buffer has already been transferred.")}let s;const n=this.workerNextTaskID++,i=e.byteLength,a=this._getWorker(n,i).then((r=>(s=r,new Promise(((r,i)=>{s._callbacks[n]={resolve:r,reject:i},s.postMessage({type:"decode",id:n,taskConfig:t,buffer:e},[e])}))))).then((e=>this._createGeometry(e.geometry)));return a.catch((()=>!0)).then((()=>{s&&n&&this._releaseTask(s,n)})),At.set(e,{key:r,promise:a}),a}_createGeometry(e){const r=new t.BufferGeometry;e.index&&r.setIndex(new t.BufferAttribute(e.index.array,1));for(let s=0;s<e.attributes.length;s++){const n=e.attributes[s],i=n.name,a=n.array,o=n.itemSize;r.setAttribute(i,new t.BufferAttribute(a,o))}return r}_loadLibrary(e,r){const s=new t.FileLoader(this.manager);return s.setPath(this.decoderPath),s.setResponseType(r),s.setWithCredentials(this.withCredentials),new Promise(((t,r)=>{s.load(e,t,void 0,r)}))}preload(){return this._initDecoder(),this}_initDecoder(){if(this.decoderPending)return this.decoderPending;const e="object"!=typeof WebAssembly||"js"===this.decoderConfig.type,t=[];return e?t.push(this._loadLibrary("draco_decoder.js","text")):(t.push(this._loadLibrary("draco_wasm_wrapper.js","text")),t.push(this._loadLibrary("draco_decoder.wasm","arraybuffer"))),this.decoderPending=Promise.all(t).then((t=>{const r=t[0];e||(this.decoderConfig.wasmBinary=t[1]);const s=Tt.toString(),n=["/* draco decoder */",r,"","/* worker */",s.substring(s.indexOf("{")+1,s.lastIndexOf("}"))].join("\n");this.workerSourceURL=URL.createObjectURL(new Blob([n]))})),this.decoderPending}_getWorker(e,t){return this._initDecoder().then((()=>{if(this.workerPool.length<this.workerLimit){const e=new Worker(this.workerSourceURL);e._callbacks={},e._taskCosts={},e._taskLoad=0,e.postMessage({type:"init",decoderConfig:this.decoderConfig}),e.onmessage=function(t){const r=t.data;switch(r.type){case"decode":e._callbacks[r.id].resolve(r);break;case"error":e._callbacks[r.id].reject(r);break;default:console.error('THREE.DRACOLoader: Unexpected message, "'+r.type+'"')}},this.workerPool.push(e)}else this.workerPool.sort((function(e,t){return e._taskLoad>t._taskLoad?-1:1}));const r=this.workerPool[this.workerPool.length-1];return r._taskCosts[e]=t,r._taskLoad+=t,r}))}_releaseTask(e,t){e._taskLoad-=e._taskCosts[t],delete e._callbacks[t],delete e._taskCosts[t]}debug(){console.log("Task load: ",this.workerPool.map((e=>e._taskLoad)))}dispose(){for(let e=0;e<this.workerPool.length;++e)this.workerPool[e].terminate();return this.workerPool.length=0,this}}function Tt(){let e,t;function r(e,t,r,s,n,i){const a=i.num_components(),o=r.num_points()*a,l=o*n.BYTES_PER_ELEMENT,c=function(e,t){switch(t){case Float32Array:return e.DT_FLOAT32;case Int8Array:return e.DT_INT8;case Int16Array:return e.DT_INT16;case Int32Array:return e.DT_INT32;case Uint8Array:return e.DT_UINT8;case Uint16Array:return e.DT_UINT16;case Uint32Array:return e.DT_UINT32}}(e,n),h=e._malloc(l);t.GetAttributeDataArrayForAllPoints(r,i,c,l,h);const u=new n(e.HEAPF32.buffer,h,o).slice();return e._free(h),{name:s,array:u,itemSize:a}}onmessage=function(s){const n=s.data;switch(n.type){case"init":e=n.decoderConfig,t=new Promise((function(t){e.onModuleLoaded=function(e){t({draco:e})},DracoDecoderModule(e)}));break;case"decode":const s=n.buffer,i=n.taskConfig;t.then((e=>{const t=e.draco,a=new t.Decoder,o=new t.DecoderBuffer;o.Init(new Int8Array(s),s.byteLength);try{const e=function(e,t,s,n){const i=n.attributeIDs,a=n.attributeTypes;let o,l;const c=t.GetEncodedGeometryType(s);if(c===e.TRIANGULAR_MESH)o=new e.Mesh,l=t.DecodeBufferToMesh(s,o);else{if(c!==e.POINT_CLOUD)throw new Error("THREE.DRACOLoader: Unexpected geometry type.");o=new e.PointCloud,l=t.DecodeBufferToPointCloud(s,o)}if(!l.ok()||0===o.ptr)throw new Error("THREE.DRACOLoader: Decoding failed: "+l.error_msg());const h={index:null,attributes:[]};for(const s in i){const l=self[a[s]];let c,u;if(n.useUniqueIDs)u=i[s],c=t.GetAttributeByUniqueId(o,u);else{if(u=t.GetAttributeId(o,e[i[s]]),-1===u)continue;c=t.GetAttribute(o,u)}h.attributes.push(r(e,t,o,s,l,c))}c===e.TRIANGULAR_MESH&&(h.index=function(e,t,r){const s=3*r.num_faces(),n=4*s,i=e._malloc(n);t.GetTrianglesUInt32Array(r,n,i);const a=new Uint32Array(e.HEAPF32.buffer,i,s).slice();return e._free(i),{array:a,itemSize:1}}(e,t,o));return e.destroy(o),h}(t,a,o,i),s=e.attributes.map((e=>e.array.buffer));e.index&&s.push(e.index.array.buffer),self.postMessage({type:"decode",id:n.id,geometry:e},s)}catch(e){console.error(e),self.postMessage({type:"error",id:n.id,error:e.message})}finally{t.destroy(o),t.destroy(a)}}))}}}
/*!
  fflate - fast JavaScript compression/decompression
  <https://101arrowz.github.io/fflate>
  Licensed under MIT. https://github.com/101arrowz/fflate/blob/master/LICENSE
  version 0.6.9
  */var St={},Rt=function(e){return URL.createObjectURL(new Blob([e],{type:"text/javascript"}))},kt=function(e){return new Worker(e)};try{URL.revokeObjectURL(Rt(""))}catch(e){Rt=function(e){return"data:application/javascript;charset=UTF-8,"+encodeURI(e)},kt=function(e){return new Worker(e,{type:"module"})}}var Et=Uint8Array,It=Uint16Array,Lt=Uint32Array,Pt=new Et([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),Ct=new Et([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),_t=new Et([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),Ft=function(e,t){for(var r=new It(31),s=0;s<31;++s)r[s]=t+=1<<e[s-1];var n=new Lt(r[30]);for(s=1;s<30;++s)for(var i=r[s];i<r[s+1];++i)n[i]=i-r[s]<<5|s;return[r,n]},Bt=Ft(Pt,2),Dt=Bt[0],Ot=Bt[1];Dt[28]=258,Ot[258]=28;for(var Nt=Ft(Ct,0),zt=Nt[0],Ut=Nt[1],Gt=new It(32768),Vt=0;Vt<32768;++Vt){var Ht=(43690&Vt)>>>1|(21845&Vt)<<1;Ht=(61680&(Ht=(52428&Ht)>>>2|(13107&Ht)<<2))>>>4|(3855&Ht)<<4,Gt[Vt]=((65280&Ht)>>>8|(255&Ht)<<8)>>>1}var jt=function(e,t,r){for(var s=e.length,n=0,i=new It(t);n<s;++n)++i[e[n]-1];var a,o=new It(t);for(n=0;n<t;++n)o[n]=o[n-1]+i[n-1]<<1;if(r){a=new It(1<<t);var l=15-t;for(n=0;n<s;++n)if(e[n])for(var c=n<<4|e[n],h=t-e[n],u=o[e[n]-1]++<<h,d=u|(1<<h)-1;u<=d;++u)a[Gt[u]>>>l]=c}else for(a=new It(s),n=0;n<s;++n)e[n]&&(a[n]=Gt[o[e[n]-1]++]>>>15-e[n]);return a},Wt=new Et(288);for(Vt=0;Vt<144;++Vt)Wt[Vt]=8;for(Vt=144;Vt<256;++Vt)Wt[Vt]=9;for(Vt=256;Vt<280;++Vt)Wt[Vt]=7;for(Vt=280;Vt<288;++Vt)Wt[Vt]=8;var Xt=new Et(32);for(Vt=0;Vt<32;++Vt)Xt[Vt]=5;var qt=jt(Wt,9,0),Kt=jt(Wt,9,1),Qt=jt(Xt,5,0),Yt=jt(Xt,5,1),Zt=function(e){for(var t=e[0],r=1;r<e.length;++r)e[r]>t&&(t=e[r]);return t},Jt=function(e,t,r){var s=t/8|0;return(e[s]|e[s+1]<<8)>>(7&t)&r},$t=function(e,t){var r=t/8|0;return(e[r]|e[r+1]<<8|e[r+2]<<16)>>(7&t)},er=function(e){return(e/8|0)+(7&e&&1)},tr=function(e,t,r){(null==t||t<0)&&(t=0),(null==r||r>e.length)&&(r=e.length);var s=new(e instanceof It?It:e instanceof Lt?Lt:Et)(r-t);return s.set(e.subarray(t,r)),s},rr=function(e,t,r){var s=e.length;if(!s||r&&!r.l&&s<5)return t||new Et(0);var n=!t||r,i=!r||r.i;r||(r={}),t||(t=new Et(3*s));var a=function(e){var r=t.length;if(e>r){var s=new Et(Math.max(2*r,e));s.set(t),t=s}},o=r.f||0,l=r.p||0,c=r.b||0,h=r.l,u=r.d,d=r.m,p=r.n,f=8*s;do{if(!h){r.f=o=Jt(e,l,1);var m=Jt(e,l+1,3);if(l+=3,!m){var g=e[(k=er(l)+4)-4]|e[k-3]<<8,y=k+g;if(y>s){if(i)throw"unexpected EOF";break}n&&a(c+g),t.set(e.subarray(k,y),c),r.b=c+=g,r.p=l=8*y;continue}if(1==m)h=Kt,u=Yt,d=9,p=5;else{if(2!=m)throw"invalid block type";var v=Jt(e,l,31)+257,w=Jt(e,l+10,15)+4,x=v+Jt(e,l+5,31)+1;l+=14;for(var b=new Et(x),A=new Et(19),M=0;M<w;++M)A[_t[M]]=Jt(e,l+3*M,7);l+=3*w;var T=Zt(A),S=(1<<T)-1,R=jt(A,T,1);for(M=0;M<x;){var k,E=R[Jt(e,l,S)];if(l+=15&E,(k=E>>>4)<16)b[M++]=k;else{var I=0,L=0;for(16==k?(L=3+Jt(e,l,3),l+=2,I=b[M-1]):17==k?(L=3+Jt(e,l,7),l+=3):18==k&&(L=11+Jt(e,l,127),l+=7);L--;)b[M++]=I}}var P=b.subarray(0,v),C=b.subarray(v);d=Zt(P),p=Zt(C),h=jt(P,d,1),u=jt(C,p,1)}if(l>f){if(i)throw"unexpected EOF";break}}n&&a(c+131072);for(var _=(1<<d)-1,F=(1<<p)-1,B=l;;B=l){var D=(I=h[$t(e,l)&_])>>>4;if((l+=15&I)>f){if(i)throw"unexpected EOF";break}if(!I)throw"invalid length/literal";if(D<256)t[c++]=D;else{if(256==D){B=l,h=null;break}var O=D-254;if(D>264){var N=Pt[M=D-257];O=Jt(e,l,(1<<N)-1)+Dt[M],l+=N}var z=u[$t(e,l)&F],U=z>>>4;if(!z)throw"invalid distance";l+=15&z;C=zt[U];if(U>3){N=Ct[U];C+=$t(e,l)&(1<<N)-1,l+=N}if(l>f){if(i)throw"unexpected EOF";break}n&&a(c+131072);for(var G=c+O;c<G;c+=4)t[c]=t[c-C],t[c+1]=t[c+1-C],t[c+2]=t[c+2-C],t[c+3]=t[c+3-C];c=G}}r.l=h,r.p=B,r.b=c,h&&(o=1,r.m=d,r.d=u,r.n=p)}while(!o);return c==t.length?t:tr(t,0,c)},sr=function(e,t,r){r<<=7&t;var s=t/8|0;e[s]|=r,e[s+1]|=r>>>8},nr=function(e,t,r){r<<=7&t;var s=t/8|0;e[s]|=r,e[s+1]|=r>>>8,e[s+2]|=r>>>16},ir=function(e,t){for(var r=[],s=0;s<e.length;++s)e[s]&&r.push({s:s,f:e[s]});var n=r.length,i=r.slice();if(!n)return[dr,0];if(1==n){var a=new Et(r[0].s+1);return a[r[0].s]=1,[a,1]}r.sort((function(e,t){return e.f-t.f})),r.push({s:-1,f:25001});var o=r[0],l=r[1],c=0,h=1,u=2;for(r[0]={s:-1,f:o.f+l.f,l:o,r:l};h!=n-1;)o=r[r[c].f<r[u].f?c++:u++],l=r[c!=h&&r[c].f<r[u].f?c++:u++],r[h++]={s:-1,f:o.f+l.f,l:o,r:l};var d=i[0].s;for(s=1;s<n;++s)i[s].s>d&&(d=i[s].s);var p=new It(d+1),f=ar(r[h-1],p,0);if(f>t){s=0;var m=0,g=f-t,y=1<<g;for(i.sort((function(e,t){return p[t.s]-p[e.s]||e.f-t.f}));s<n;++s){var v=i[s].s;if(!(p[v]>t))break;m+=y-(1<<f-p[v]),p[v]=t}for(m>>>=g;m>0;){var w=i[s].s;p[w]<t?m-=1<<t-p[w]++-1:++s}for(;s>=0&&m;--s){var x=i[s].s;p[x]==t&&(--p[x],++m)}f=t}return[new Et(p),f]},ar=function(e,t,r){return-1==e.s?Math.max(ar(e.l,t,r+1),ar(e.r,t,r+1)):t[e.s]=r},or=function(e){for(var t=e.length;t&&!e[--t];);for(var r=new It(++t),s=0,n=e[0],i=1,a=function(e){r[s++]=e},o=1;o<=t;++o)if(e[o]==n&&o!=t)++i;else{if(!n&&i>2){for(;i>138;i-=138)a(32754);i>2&&(a(i>10?i-11<<5|28690:i-3<<5|12305),i=0)}else if(i>3){for(a(n),--i;i>6;i-=6)a(8304);i>2&&(a(i-3<<5|8208),i=0)}for(;i--;)a(n);i=1,n=e[o]}return[r.subarray(0,s),t]},lr=function(e,t){for(var r=0,s=0;s<t.length;++s)r+=e[s]*t[s];return r},cr=function(e,t,r){var s=r.length,n=er(t+2);e[n]=255&s,e[n+1]=s>>>8,e[n+2]=255^e[n],e[n+3]=255^e[n+1];for(var i=0;i<s;++i)e[n+i+4]=r[i];return 8*(n+4+s)},hr=function(e,t,r,s,n,i,a,o,l,c,h){sr(t,h++,r),++n[256];for(var u=ir(n,15),d=u[0],p=u[1],f=ir(i,15),m=f[0],g=f[1],y=or(d),v=y[0],w=y[1],x=or(m),b=x[0],A=x[1],M=new It(19),T=0;T<v.length;++T)M[31&v[T]]++;for(T=0;T<b.length;++T)M[31&b[T]]++;for(var S=ir(M,7),R=S[0],k=S[1],E=19;E>4&&!R[_t[E-1]];--E);var I,L,P,C,_=c+5<<3,F=lr(n,Wt)+lr(i,Xt)+a,B=lr(n,d)+lr(i,m)+a+14+3*E+lr(M,R)+(2*M[16]+3*M[17]+7*M[18]);if(_<=F&&_<=B)return cr(t,h,e.subarray(l,l+c));if(sr(t,h,1+(B<F)),h+=2,B<F){I=jt(d,p,0),L=d,P=jt(m,g,0),C=m;var D=jt(R,k,0);sr(t,h,w-257),sr(t,h+5,A-1),sr(t,h+10,E-4),h+=14;for(T=0;T<E;++T)sr(t,h+3*T,R[_t[T]]);h+=3*E;for(var O=[v,b],N=0;N<2;++N){var z=O[N];for(T=0;T<z.length;++T){var U=31&z[T];sr(t,h,D[U]),h+=R[U],U>15&&(sr(t,h,z[T]>>>5&127),h+=z[T]>>>12)}}}else I=qt,L=Wt,P=Qt,C=Xt;for(T=0;T<o;++T)if(s[T]>255){U=s[T]>>>18&31;nr(t,h,I[U+257]),h+=L[U+257],U>7&&(sr(t,h,s[T]>>>23&31),h+=Pt[U]);var G=31&s[T];nr(t,h,P[G]),h+=C[G],G>3&&(nr(t,h,s[T]>>>5&8191),h+=Ct[G])}else nr(t,h,I[s[T]]),h+=L[s[T]];return nr(t,h,I[256]),h+L[256]},ur=new Lt([65540,131080,131088,131104,262176,1048704,1048832,2114560,2117632]),dr=new Et(0),pr=function(e,t,r,s,n,i){var a=e.length,o=new Et(s+a+5*(1+Math.ceil(a/7e3))+n),l=o.subarray(s,o.length-n),c=0;if(!t||a<8)for(var h=0;h<=a;h+=65535){var u=h+65535;u<a?c=cr(l,c,e.subarray(h,u)):(l[h]=i,c=cr(l,c,e.subarray(h,a)))}else{for(var d=ur[t-1],p=d>>>13,f=8191&d,m=(1<<r)-1,g=new It(32768),y=new It(m+1),v=Math.ceil(r/3),w=2*v,x=function(t){return(e[t]^e[t+1]<<v^e[t+2]<<w)&m},b=new Lt(25e3),A=new It(288),M=new It(32),T=0,S=0,R=(h=0,0),k=0,E=0;h<a;++h){var I=x(h),L=32767&h,P=y[I];if(g[L]=P,y[I]=L,k<=h){var C=a-h;if((T>7e3||R>24576)&&C>423){c=hr(e,l,0,b,A,M,S,R,E,h-E,c),R=T=S=0,E=h;for(var _=0;_<286;++_)A[_]=0;for(_=0;_<30;++_)M[_]=0}var F=2,B=0,D=f,O=L-P&32767;if(C>2&&I==x(h-O))for(var N=Math.min(p,C)-1,z=Math.min(32767,h),U=Math.min(258,C);O<=z&&--D&&L!=P;){if(e[h+F]==e[h+F-O]){for(var G=0;G<U&&e[h+G]==e[h+G-O];++G);if(G>F){if(F=G,B=O,G>N)break;var V=Math.min(O,G-2),H=0;for(_=0;_<V;++_){var j=h-O+_+32768&32767,W=j-g[j]+32768&32767;W>H&&(H=W,P=j)}}}O+=(L=P)-(P=g[L])+32768&32767}if(B){b[R++]=268435456|Ot[F]<<18|Ut[B];var X=31&Ot[F],q=31&Ut[B];S+=Pt[X]+Ct[q],++A[257+X],++M[q],k=h+F,++T}else b[R++]=e[h],++A[e[h]]}}c=hr(e,l,i,b,A,M,S,R,E,h-E,c),!i&&7&c&&(c=cr(l,c+1,dr))}return tr(o,0,s+er(c)+n)},fr=function(){for(var e=new Lt(256),t=0;t<256;++t){for(var r=t,s=9;--s;)r=(1&r&&3988292384)^r>>>1;e[t]=r}return e}(),mr=function(){var e=-1;return{p:function(t){for(var r=e,s=0;s<t.length;++s)r=fr[255&r^t[s]]^r>>>8;e=r},d:function(){return~e}}},gr=function(){var e=1,t=0;return{p:function(r){for(var s=e,n=t,i=r.length,a=0;a!=i;){for(var o=Math.min(a+2655,i);a<o;++a)n+=s+=r[a];s=(65535&s)+15*(s>>16),n=(65535&n)+15*(n>>16)}e=s,t=n},d:function(){return(255&(e%=65521))<<24|e>>>8<<16|(255&(t%=65521))<<8|t>>>8}}},yr=function(e,t,r,s,n){return pr(e,null==t.level?6:t.level,null==t.mem?Math.ceil(1.5*Math.max(8,Math.min(13,Math.log(e.length)))):12+t.mem,r,s,!n)},vr=function(e,t){var r={};for(var s in e)r[s]=e[s];for(var s in t)r[s]=t[s];return r},wr=function(e,t,r){for(var s=e(),n=e.toString(),i=n.slice(n.indexOf("[")+1,n.lastIndexOf("]")).replace(/ /g,"").split(","),a=0;a<s.length;++a){var o=s[a],l=i[a];if("function"==typeof o){t+=";"+l+"=";var c=o.toString();if(o.prototype)if(-1!=c.indexOf("[native code]")){var h=c.indexOf(" ",8)+1;t+=c.slice(h,c.indexOf("(",h))}else for(var u in t+=c,o.prototype)t+=";"+l+".prototype."+u+"="+o.prototype[u].toString();else t+=c}else r[l]=o}return[t,r]},xr=[],br=function(e,t,r,s){var n;if(!xr[r]){for(var i="",a={},o=e.length-1,l=0;l<o;++l)i=(n=wr(e[l],i,a))[0],a=n[1];xr[r]=wr(e[o],i,a)}var c=vr({},xr[r][1]);return function(e,t,r,s,n){var i=kt(St[t]||(St[t]=Rt(e)));return i.onerror=function(e){return n(e.error,null)},i.onmessage=function(e){return n(null,e.data)},i.postMessage(r,s),i}(xr[r][0]+";onmessage=function(e){for(var k in e.data)self[k]=e.data[k];onmessage="+t.toString()+"}",r,c,function(e){var t=[];for(var r in e)(e[r]instanceof Et||e[r]instanceof It||e[r]instanceof Lt)&&t.push((e[r]=new e[r].constructor(e[r])).buffer);return t}(c),s)},Ar=function(){return[Et,It,Lt,Pt,Ct,_t,Dt,zt,Kt,Yt,Gt,jt,Zt,Jt,$t,er,tr,rr,Zr,Er,Ir]},Mr=function(){return[Et,It,Lt,Pt,Ct,_t,Ot,Ut,qt,Wt,Qt,Xt,Gt,ur,dr,jt,sr,nr,ir,ar,or,lr,cr,hr,er,tr,pr,yr,qr,Er]},Tr=function(){return[Or,Ur,Dr,mr,fr]},Sr=function(){return[Nr,zr]},Rr=function(){return[Gr,Dr,gr]},kr=function(){return[Vr]},Er=function(e){return postMessage(e,[e.buffer])},Ir=function(e){return e&&e.size&&new Et(e.size)},Lr=function(e,t,r,s,n,i){var a=br(r,s,n,(function(e,t){a.terminate(),i(e,t)}));return a.postMessage([e,t],t.consume?[e.buffer]:[]),function(){a.terminate()}},Pr=function(e){return e.ondata=function(e,t){return postMessage([e,t],[e.buffer])},function(t){return e.push(t.data[0],t.data[1])}},Cr=function(e,t,r,s,n){var i,a=br(e,s,n,(function(e,r){e?(a.terminate(),t.ondata.call(t,e)):(r[1]&&a.terminate(),t.ondata.call(t,e,r[0],r[1]))}));a.postMessage(r),t.push=function(e,r){if(i)throw"stream finished";if(!t.ondata)throw"no stream handler";a.postMessage([e,i=r],[e.buffer])},t.terminate=function(){a.terminate()}},_r=function(e,t){return e[t]|e[t+1]<<8},Fr=function(e,t){return(e[t]|e[t+1]<<8|e[t+2]<<16|e[t+3]<<24)>>>0},Br=function(e,t){return Fr(e,t)+4294967296*Fr(e,t+4)},Dr=function(e,t,r){for(;r;++t)e[t]=r,r>>>=8},Or=function(e,t){var r=t.filename;if(e[0]=31,e[1]=139,e[2]=8,e[8]=t.level<2?4:9==t.level?2:0,e[9]=3,0!=t.mtime&&Dr(e,4,Math.floor(new Date(t.mtime||Date.now())/1e3)),r){e[3]=8;for(var s=0;s<=r.length;++s)e[s+10]=r.charCodeAt(s)}},Nr=function(e){if(31!=e[0]||139!=e[1]||8!=e[2])throw"invalid gzip data";var t=e[3],r=10;4&t&&(r+=e[10]|2+(e[11]<<8));for(var s=(t>>3&1)+(t>>4&1);s>0;s-=!e[r++]);return r+(2&t)},zr=function(e){var t=e.length;return(e[t-4]|e[t-3]<<8|e[t-2]<<16|e[t-1]<<24)>>>0},Ur=function(e){return 10+(e.filename&&e.filename.length+1||0)},Gr=function(e,t){var r=t.level,s=0==r?0:r<6?1:9==r?3:2;e[0]=120,e[1]=s<<6|(s?32-2*s:1)},Vr=function(e){if(8!=(15&e[0])||e[0]>>>4>7||(e[0]<<8|e[1])%31)throw"invalid zlib data";if(32&e[1])throw"invalid zlib data: preset dictionaries not supported"};function Hr(e,t){return t||"function"!=typeof e||(t=e,e={}),this.ondata=t,e}var jr=function(){function e(e,t){t||"function"!=typeof e||(t=e,e={}),this.ondata=t,this.o=e||{}}return e.prototype.p=function(e,t){this.ondata(yr(e,this.o,0,0,!t),t)},e.prototype.push=function(e,t){if(this.d)throw"stream finished";if(!this.ondata)throw"no stream handler";this.d=t,this.p(e,t||!1)},e}(),Wr=function(){return function(e,t){Cr([Mr,function(){return[Pr,jr]}],this,Hr.call(this,e,t),(function(e){var t=new jr(e.data);onmessage=Pr(t)}),6)}}();function Xr(e,t,r){if(r||(r=t,t={}),"function"!=typeof r)throw"no callback";return Lr(e,t,[Mr],(function(e){return Er(qr(e.data[0],e.data[1]))}),0,r)}function qr(e,t){return yr(e,t||{},0,0)}var Kr=function(){function e(e){this.s={},this.p=new Et(0),this.ondata=e}return e.prototype.e=function(e){if(this.d)throw"stream finished";if(!this.ondata)throw"no stream handler";var t=this.p.length,r=new Et(t+e.length);r.set(this.p),r.set(e,t),this.p=r},e.prototype.c=function(e){this.d=this.s.i=e||!1;var t=this.s.b,r=rr(this.p,this.o,this.s);this.ondata(tr(r,t,this.s.b),this.d),this.o=tr(r,this.s.b-32768),this.s.b=this.o.length,this.p=tr(this.p,this.s.p/8|0),this.s.p&=7},e.prototype.push=function(e,t){this.e(e),this.c(t)},e}(),Qr=function(){return function(e){this.ondata=e,Cr([Ar,function(){return[Pr,Kr]}],this,0,(function(){var e=new Kr;onmessage=Pr(e)}),7)}}();function Yr(e,t,r){if(r||(r=t,t={}),"function"!=typeof r)throw"no callback";return Lr(e,t,[Ar],(function(e){return Er(Zr(e.data[0],Ir(e.data[1])))}),1,r)}function Zr(e,t){return rr(e,t)}var Jr=function(){function e(e,t){this.c=mr(),this.l=0,this.v=1,jr.call(this,e,t)}return e.prototype.push=function(e,t){jr.prototype.push.call(this,e,t)},e.prototype.p=function(e,t){this.c.p(e),this.l+=e.length;var r=yr(e,this.o,this.v&&Ur(this.o),t&&8,!t);this.v&&(Or(r,this.o),this.v=0),t&&(Dr(r,r.length-8,this.c.d()),Dr(r,r.length-4,this.l)),this.ondata(r,t)},e}(),$r=function(){return function(e,t){Cr([Mr,Tr,function(){return[Pr,jr,Jr]}],this,Hr.call(this,e,t),(function(e){var t=new Jr(e.data);onmessage=Pr(t)}),8)}}();function es(e,t,r){if(r||(r=t,t={}),"function"!=typeof r)throw"no callback";return Lr(e,t,[Mr,Tr,function(){return[ts]}],(function(e){return Er(ts(e.data[0],e.data[1]))}),2,r)}function ts(e,t){t||(t={});var r=mr(),s=e.length;r.p(e);var n=yr(e,t,Ur(t),8),i=n.length;return Or(n,t),Dr(n,i-8,r.d()),Dr(n,i-4,s),n}var rs=function(){function e(e){this.v=1,Kr.call(this,e)}return e.prototype.push=function(e,t){if(Kr.prototype.e.call(this,e),this.v){var r=this.p.length>3?Nr(this.p):4;if(r>=this.p.length&&!t)return;this.p=this.p.subarray(r),this.v=0}if(t){if(this.p.length<8)throw"invalid gzip stream";this.p=this.p.subarray(0,-8)}Kr.prototype.c.call(this,t)},e}(),ss=function(){return function(e){this.ondata=e,Cr([Ar,Sr,function(){return[Pr,Kr,rs]}],this,0,(function(){var e=new rs;onmessage=Pr(e)}),9)}}();function ns(e,t,r){if(r||(r=t,t={}),"function"!=typeof r)throw"no callback";return Lr(e,t,[Ar,Sr,function(){return[is]}],(function(e){return Er(is(e.data[0]))}),3,r)}function is(e,t){return rr(e.subarray(Nr(e),-8),t||new Et(zr(e)))}var as=function(){function e(e,t){this.c=gr(),this.v=1,jr.call(this,e,t)}return e.prototype.push=function(e,t){jr.prototype.push.call(this,e,t)},e.prototype.p=function(e,t){this.c.p(e);var r=yr(e,this.o,this.v&&2,t&&4,!t);this.v&&(Gr(r,this.o),this.v=0),t&&Dr(r,r.length-4,this.c.d()),this.ondata(r,t)},e}(),os=function(){return function(e,t){Cr([Mr,Rr,function(){return[Pr,jr,as]}],this,Hr.call(this,e,t),(function(e){var t=new as(e.data);onmessage=Pr(t)}),10)}}();function ls(e,t){t||(t={});var r=gr();r.p(e);var s=yr(e,t,2,4);return Gr(s,t),Dr(s,s.length-4,r.d()),s}var cs=function(){function e(e){this.v=1,Kr.call(this,e)}return e.prototype.push=function(e,t){if(Kr.prototype.e.call(this,e),this.v){if(this.p.length<2&&!t)return;this.p=this.p.subarray(2),this.v=0}if(t){if(this.p.length<4)throw"invalid zlib stream";this.p=this.p.subarray(0,-4)}Kr.prototype.c.call(this,t)},e}(),hs=function(){return function(e){this.ondata=e,Cr([Ar,kr,function(){return[Pr,Kr,cs]}],this,0,(function(){var e=new cs;onmessage=Pr(e)}),11)}}();function us(e,t,r){if(r||(r=t,t={}),"function"!=typeof r)throw"no callback";return Lr(e,t,[Ar,kr,function(){return[ds]}],(function(e){return Er(ds(e.data[0],Ir(e.data[1])))}),5,r)}function ds(e,t){return rr((Vr(e),e.subarray(2,-4)),t)}var ps=function(){function e(e){this.G=rs,this.I=Kr,this.Z=cs,this.ondata=e}return e.prototype.push=function(e,t){if(!this.ondata)throw"no stream handler";if(this.s)this.s.push(e,t);else{if(this.p&&this.p.length){var r=new Et(this.p.length+e.length);r.set(this.p),r.set(e,this.p.length)}else this.p=e;if(this.p.length>2){var s=this,n=function(){s.ondata.apply(s,arguments)};this.s=31==this.p[0]&&139==this.p[1]&&8==this.p[2]?new this.G(n):8!=(15&this.p[0])||this.p[0]>>4>7||(this.p[0]<<8|this.p[1])%31?new this.I(n):new this.Z(n),this.s.push(this.p,t),this.p=null}}},e}(),fs=function(){function e(e){this.G=ss,this.I=Qr,this.Z=hs,this.ondata=e}return e.prototype.push=function(e,t){ps.prototype.push.call(this,e,t)},e}();var ms=function(e,t,r,s){for(var n in e){var i=e[n],a=t+n;i instanceof Et?r[a]=[i,s]:Array.isArray(i)?r[a]=[i[0],vr(s,i[1])]:ms(i,a+"/",r,s)}},gs="undefined"!=typeof TextEncoder&&new TextEncoder,ys="undefined"!=typeof TextDecoder&&new TextDecoder,vs=0;try{ys.decode(dr,{stream:!0}),vs=1}catch(e){}var ws=function(e){for(var t="",r=0;;){var s=e[r++],n=(s>127)+(s>223)+(s>239);if(r+n>e.length)return[t,tr(e,r-1)];n?3==n?(s=((15&s)<<18|(63&e[r++])<<12|(63&e[r++])<<6|63&e[r++])-65536,t+=String.fromCharCode(55296|s>>10,56320|1023&s)):t+=1&n?String.fromCharCode((31&s)<<6|63&e[r++]):String.fromCharCode((15&s)<<12|(63&e[r++])<<6|63&e[r++]):t+=String.fromCharCode(s)}},xs=function(){function e(e){this.ondata=e,vs?this.t=new TextDecoder:this.p=dr}return e.prototype.push=function(e,t){if(!this.ondata)throw"no callback";if(t=!!t,this.t){if(this.ondata(this.t.decode(e,{stream:!0}),t),t){if(this.t.decode().length)throw"invalid utf-8 data";this.t=null}}else{if(!this.p)throw"stream finished";var r=new Et(this.p.length+e.length);r.set(this.p),r.set(e,this.p.length);var s=ws(r),n=s[0],i=s[1];if(t){if(i.length)throw"invalid utf-8 data";this.p=null}else this.p=i;this.ondata(n,t)}},e}(),bs=function(){function e(e){this.ondata=e}return e.prototype.push=function(e,t){if(!this.ondata)throw"no callback";if(this.d)throw"stream finished";this.ondata(As(e),this.d=t||!1)},e}();function As(e,t){if(t){for(var r=new Et(e.length),s=0;s<e.length;++s)r[s]=e.charCodeAt(s);return r}if(gs)return gs.encode(e);var n=e.length,i=new Et(e.length+(e.length>>1)),a=0,o=function(e){i[a++]=e};for(s=0;s<n;++s){if(a+5>i.length){var l=new Et(a+8+(n-s<<1));l.set(i),i=l}var c=e.charCodeAt(s);c<128||t?o(c):c<2048?(o(192|c>>6),o(128|63&c)):c>55295&&c<57344?(o(240|(c=65536+(1047552&c)|1023&e.charCodeAt(++s))>>18),o(128|c>>12&63),o(128|c>>6&63),o(128|63&c)):(o(224|c>>12),o(128|c>>6&63),o(128|63&c))}return tr(i,0,a)}function Ms(e,t){if(t){for(var r="",s=0;s<e.length;s+=16384)r+=String.fromCharCode.apply(null,e.subarray(s,s+16384));return r}if(ys)return ys.decode(e);var n=ws(e),i=n[0];if(n[1].length)throw"invalid utf-8 data";return i}var Ts=function(e){return 1==e?3:e<6?2:9==e?1:0},Ss=function(e,t){return t+30+_r(e,t+26)+_r(e,t+28)},Rs=function(e,t,r){var s=_r(e,t+28),n=Ms(e.subarray(t+46,t+46+s),!(2048&_r(e,t+8))),i=t+46+s,a=Fr(e,t+20),o=r&&4294967295==a?ks(e,i):[a,Fr(e,t+24),Fr(e,t+42)],l=o[0],c=o[1],h=o[2];return[_r(e,t+10),l,c,n,i+_r(e,t+30)+_r(e,t+32),h]},ks=function(e,t){for(;1!=_r(e,t);t+=4+_r(e,t+2));return[Br(e,t+12),Br(e,t+4),Br(e,t+20)]},Es=function(e){var t=0;if(e)for(var r in e){var s=e[r].length;if(s>65535)throw"extra field too long";t+=s+4}return t},Is=function(e,t,r,s,n,i,a,o){var l=s.length,c=r.extra,h=o&&o.length,u=Es(c);Dr(e,t,null!=a?33639248:67324752),t+=4,null!=a&&(e[t++]=20,e[t++]=r.os),e[t]=20,t+=2,e[t++]=r.flag<<1|(null==i&&8),e[t++]=n&&8,e[t++]=255&r.compression,e[t++]=r.compression>>8;var d=new Date(null==r.mtime?Date.now():r.mtime),p=d.getFullYear()-1980;if(p<0||p>119)throw"date not in range 1980-2099";if(Dr(e,t,p<<25|d.getMonth()+1<<21|d.getDate()<<16|d.getHours()<<11|d.getMinutes()<<5|d.getSeconds()>>>1),t+=4,null!=i&&(Dr(e,t,r.crc),Dr(e,t+4,i),Dr(e,t+8,r.size)),Dr(e,t+12,l),Dr(e,t+14,u),t+=16,null!=a&&(Dr(e,t,h),Dr(e,t+6,r.attrs),Dr(e,t+10,a),t+=14),e.set(s,t),t+=l,u)for(var f in c){var m=c[f],g=m.length;Dr(e,t,+f),Dr(e,t+2,g),e.set(m,t+4),t+=4+g}return h&&(e.set(o,t),t+=h),t},Ls=function(e,t,r,s,n){Dr(e,t,101010256),Dr(e,t+8,r),Dr(e,t+10,r),Dr(e,t+12,s),Dr(e,t+16,n)},Ps=function(){function e(e){this.filename=e,this.c=mr(),this.size=0,this.compression=0}return e.prototype.process=function(e,t){this.ondata(null,e,t)},e.prototype.push=function(e,t){if(!this.ondata)throw"no callback - add to ZIP archive before pushing";this.c.p(e),this.size+=e.length,t&&(this.crc=this.c.d()),this.process(e,t||!1)},e}(),Cs=function(){function e(e,t){var r=this;t||(t={}),Ps.call(this,e),this.d=new jr(t,(function(e,t){r.ondata(null,e,t)})),this.compression=8,this.flag=Ts(t.level)}return e.prototype.process=function(e,t){try{this.d.push(e,t)}catch(e){this.ondata(e,null,t)}},e.prototype.push=function(e,t){Ps.prototype.push.call(this,e,t)},e}(),_s=function(){function e(e,t){var r=this;t||(t={}),Ps.call(this,e),this.d=new Wr(t,(function(e,t,s){r.ondata(e,t,s)})),this.compression=8,this.flag=Ts(t.level),this.terminate=this.d.terminate}return e.prototype.process=function(e,t){this.d.push(e,t)},e.prototype.push=function(e,t){Ps.prototype.push.call(this,e,t)},e}(),Fs=function(){function e(e){this.ondata=e,this.u=[],this.d=1}return e.prototype.add=function(e){var t=this;if(2&this.d)throw"stream finished";var r=As(e.filename),s=r.length,n=e.comment,i=n&&As(n),a=s!=e.filename.length||i&&n.length!=i.length,o=s+Es(e.extra)+30;if(s>65535)throw"filename too long";var l=new Et(o);Is(l,0,e,r,a);var c=[l],h=function(){for(var e=0,r=c;e<r.length;e++){var s=r[e];t.ondata(null,s,!1)}c=[]},u=this.d;this.d=0;var d=this.u.length,p=vr(e,{f:r,u:a,o:i,t:function(){e.terminate&&e.terminate()},r:function(){if(h(),u){var e=t.u[d+1];e?e.r():t.d=1}u=1}}),f=0;e.ondata=function(r,s,n){if(r)t.ondata(r,s,n),t.terminate();else if(f+=s.length,c.push(s),n){var i=new Et(16);Dr(i,0,134695760),Dr(i,4,e.crc),Dr(i,8,f),Dr(i,12,e.size),c.push(i),p.c=f,p.b=o+f+16,p.crc=e.crc,p.size=e.size,u&&p.r(),u=1}else u&&h()},this.u.push(p)},e.prototype.end=function(){var e=this;if(2&this.d){if(1&this.d)throw"stream finishing";throw"stream finished"}this.d?this.e():this.u.push({r:function(){1&e.d&&(e.u.splice(-1,1),e.e())},t:function(){}}),this.d=3},e.prototype.e=function(){for(var e=0,t=0,r=0,s=0,n=this.u;s<n.length;s++){r+=46+(l=n[s]).f.length+Es(l.extra)+(l.o?l.o.length:0)}for(var i=new Et(r+22),a=0,o=this.u;a<o.length;a++){var l=o[a];Is(i,e,l,l.f,l.u,l.c,t,l.o),e+=46+l.f.length+Es(l.extra)+(l.o?l.o.length:0),t+=l.b}Ls(i,e,this.u.length,r,t),this.ondata(null,i,!0),this.d=2},e.prototype.terminate=function(){for(var e=0,t=this.u;e<t.length;e++){t[e].t()}this.d=2},e}();var Bs=function(){function e(){}return e.prototype.push=function(e,t){this.ondata(null,e,t)},e.compression=0,e}(),Ds=function(){function e(){var e=this;this.i=new Kr((function(t,r){e.ondata(null,t,r)}))}return e.prototype.push=function(e,t){try{this.i.push(e,t)}catch(r){this.ondata(r,e,t)}},e.compression=8,e}(),Os=function(){function e(e,t){var r=this;t<32e4?this.i=new Kr((function(e,t){r.ondata(null,e,t)})):(this.i=new Qr((function(e,t,s){r.ondata(e,t,s)})),this.terminate=this.i.terminate)}return e.prototype.push=function(e,t){this.i.terminate&&(e=tr(e,0)),this.i.push(e,t)},e.compression=8,e}(),Ns=function(){function e(e){this.onfile=e,this.k=[],this.o={0:Bs},this.p=dr}return e.prototype.push=function(e,t){var r=this;if(!this.onfile)throw"no callback";if(!this.p)throw"stream finished";if(this.c>0){var s=Math.min(this.c,e.length),n=e.subarray(0,s);if(this.c-=s,this.d?this.d.push(n,!this.c):this.k[0].push(n),(e=e.subarray(s)).length)return this.push(e,t)}else{var i=0,a=0,o=void 0,l=void 0;this.p.length?e.length?((l=new Et(this.p.length+e.length)).set(this.p),l.set(e,this.p.length)):l=this.p:l=e;for(var c=l.length,h=this.c,u=h&&this.d,d=function(){var e,t=Fr(l,a);if(67324752==t){i=1,o=a,p.d=null,p.c=0;var s=_r(l,a+6),n=_r(l,a+8),u=2048&s,d=8&s,f=_r(l,a+26),m=_r(l,a+28);if(c>a+30+f+m){var g=[];p.k.unshift(g),i=2;var y,v=Fr(l,a+18),w=Fr(l,a+22),x=Ms(l.subarray(a+30,a+=30+f),!u);4294967295==v?(e=d?[-2]:ks(l,a),v=e[0],w=e[1]):d&&(v=-1),a+=m,p.c=v;var b={name:x,compression:n,start:function(){if(!b.ondata)throw"no callback";if(v){var e=r.o[n];if(!e)throw"unknown compression type "+n;(y=v<0?new e(x):new e(x,v,w)).ondata=function(e,t,r){b.ondata(e,t,r)};for(var t=0,s=g;t<s.length;t++){var i=s[t];y.push(i,!1)}r.k[0]==g&&r.c?r.d=y:y.push(dr,!0)}else b.ondata(null,dr,!0)},terminate:function(){y&&y.terminate&&y.terminate()}};v>=0&&(b.size=v,b.originalSize=w),p.onfile(b)}return"break"}if(h){if(134695760==t)return o=a+=12+(-2==h&&8),i=3,p.c=0,"break";if(33639248==t)return o=a-=4,i=3,p.c=0,"break"}},p=this;a<c-4;++a){if("break"===d())break}if(this.p=dr,h<0){var f=i?l.subarray(0,o-12-(-2==h&&8)-(134695760==Fr(l,o-16)&&4)):l.subarray(0,a);u?u.push(f,!!i):this.k[+(2==i)].push(f)}if(2&i)return this.push(l.subarray(a),t);this.p=l.subarray(a)}if(t){if(this.c)throw"invalid zip file";this.p=null}},e.prototype.register=function(e){this.o[e.compression]=e},e}();var zs=Object.freeze({__proto__:null,Deflate:jr,AsyncDeflate:Wr,deflate:Xr,deflateSync:qr,Inflate:Kr,AsyncInflate:Qr,inflate:Yr,inflateSync:Zr,Gzip:Jr,AsyncGzip:$r,gzip:es,gzipSync:ts,Gunzip:rs,AsyncGunzip:ss,gunzip:ns,gunzipSync:is,Zlib:as,AsyncZlib:os,zlib:function(e,t,r){if(r||(r=t,t={}),"function"!=typeof r)throw"no callback";return Lr(e,t,[Mr,Rr,function(){return[ls]}],(function(e){return Er(ls(e.data[0],e.data[1]))}),4,r)},zlibSync:ls,Unzlib:cs,AsyncUnzlib:hs,unzlib:us,unzlibSync:ds,compress:es,AsyncCompress:$r,compressSync:ts,Compress:Jr,Decompress:ps,AsyncDecompress:fs,decompress:function(e,t,r){if(r||(r=t,t={}),"function"!=typeof r)throw"no callback";return 31==e[0]&&139==e[1]&&8==e[2]?ns(e,t,r):8!=(15&e[0])||e[0]>>4>7||(e[0]<<8|e[1])%31?Yr(e,t,r):us(e,t,r)},decompressSync:function(e,t){return 31==e[0]&&139==e[1]&&8==e[2]?is(e,t):8!=(15&e[0])||e[0]>>4>7||(e[0]<<8|e[1])%31?Zr(e,t):ds(e,t)},DecodeUTF8:xs,EncodeUTF8:bs,strToU8:As,strFromU8:Ms,ZipPassThrough:Ps,ZipDeflate:Cs,AsyncZipDeflate:_s,Zip:Fs,zip:function(e,t,r){if(r||(r=t,t={}),"function"!=typeof r)throw"no callback";var s={};ms(e,"",s,t);var n=Object.keys(s),i=n.length,a=0,o=0,l=i,c=new Array(i),h=[],u=function(){for(var e=0;e<h.length;++e)h[e]()},d=function(){var e=new Et(o+22),t=a,s=o-a;o=0;for(var n=0;n<l;++n){var i=c[n];try{var h=i.c.length;Is(e,o,i,i.f,i.u,h);var u=30+i.f.length+Es(i.extra),d=o+u;e.set(i.c,d),Is(e,a,i,i.f,i.u,h,o,i.m),a+=16+u+(i.m?i.m.length:0),o=d+h}catch(e){return r(e,null)}}Ls(e,a,c.length,s,t),r(null,e)};i||d();for(var p=function(e){var t=n[e],l=s[t],p=l[0],f=l[1],m=mr(),g=p.length;m.p(p);var y=As(t),v=y.length,w=f.comment,x=w&&As(w),b=x&&x.length,A=Es(f.extra),M=0==f.level?0:8,T=function(s,n){if(s)u(),r(s,null);else{var l=n.length;c[e]=vr(f,{size:g,crc:m.d(),c:n,f:y,m:x,u:v!=t.length||x&&w.length!=b,compression:M}),a+=30+v+A+l,o+=76+2*(v+A)+(b||0)+l,--i||d()}};if(v>65535&&T("filename too long",null),M)if(g<16e4)try{T(null,qr(p,f))}catch(e){T(e,null)}else h.push(Xr(p,f,T));else T(null,p)},f=0;f<l;++f)p(f);return u},zipSync:function(e,t){t||(t={});var r={},s=[];ms(e,"",r,t);var n=0,i=0;for(var a in r){var o=r[a],l=o[0],c=o[1],h=0==c.level?0:8,u=(M=As(a)).length,d=c.comment,p=d&&As(d),f=p&&p.length,m=Es(c.extra);if(u>65535)throw"filename too long";var g=h?qr(l,c):l,y=g.length,v=mr();v.p(l),s.push(vr(c,{size:l.length,crc:v.d(),c:g,f:M,m:p,u:u!=a.length||p&&d.length!=f,o:n,compression:h})),n+=30+u+m+y,i+=76+2*(u+m)+(f||0)+y}for(var w=new Et(i+22),x=n,b=i-n,A=0;A<s.length;++A){var M=s[A];Is(w,M.o,M,M.f,M.u,M.c.length);var T=30+M.f.length+Es(M.extra);w.set(M.c,M.o+T),Is(w,n,M,M.f,M.u,M.c.length,M.o,M.m),n+=16+T+(M.m?M.m.length:0)}return Ls(w,n,s.length,b,x),w},UnzipPassThrough:Bs,UnzipInflate:Ds,AsyncUnzipInflate:Os,Unzip:Ns,unzip:function(e,t){if("function"!=typeof t)throw"no callback";for(var r=[],s=function(){for(var e=0;e<r.length;++e)r[e]()},n={},i=e.length-22;101010256!=Fr(e,i);--i)if(!i||e.length-i>65558)return void t("invalid zip file",null);var a=_r(e,i+8);a||t(null,{});var o=a,l=Fr(e,i+16),c=4294967295==l;if(c){if(i=Fr(e,i-12),101075792!=Fr(e,i))return void t("invalid zip file",null);o=a=Fr(e,i+32),l=Fr(e,i+48)}for(var h=function(i){var o=Rs(e,l,c),h=o[0],u=o[1],d=o[2],p=o[3],f=o[4],m=o[5],g=Ss(e,m);l=f;var y=function(e,r){e?(s(),t(e,null)):(n[p]=r,--a||t(null,n))};if(h)if(8==h){var v=e.subarray(g,g+u);if(u<32e4)try{y(null,Zr(v,new Et(d)))}catch(e){y(e,null)}else r.push(Yr(v,{size:d},y))}else y("unknown compression type "+h,null);else y(null,tr(e,g,g+u))},u=0;u<o;++u)h();return s},unzipSync:function(e){for(var t={},r=e.length-22;101010256!=Fr(e,r);--r)if(!r||e.length-r>65558)throw"invalid zip file";var s=_r(e,r+8);if(!s)return{};var n=Fr(e,r+16),i=4294967295==n;if(i){if(r=Fr(e,r-12),101075792!=Fr(e,r))throw"invalid zip file";s=Fr(e,r+32),n=Fr(e,r+48)}for(var a=0;a<s;++a){var o=Rs(e,n,i),l=o[0],c=o[1],h=o[2],u=o[3],d=o[4],p=o[5],f=Ss(e,p);if(n=d,l){if(8!=l)throw"unknown compression type "+l;t[u]=Zr(e.subarray(f,f+c),new Et(h))}else t[u]=tr(e,f,f+c)}return t}});function Us(e,t,r){const s=r.length-e-1;if(t>=r[s])return s-1;if(t<=r[e])return e;let n=e,i=s,a=Math.floor((n+i)/2);for(;t<r[a]||t>=r[a+1];)t<r[a]?i=a:n=a,a=Math.floor((n+i)/2);return a}function Gs(e,t){let r=1;for(let t=2;t<=e;++t)r*=t;let s=1;for(let e=2;e<=t;++e)s*=e;for(let r=2;r<=e-t;++r)s*=r;return r/s}function Vs(e,r,s,n,i){return function(e){const r=e.length,s=[],n=[];for(let i=0;i<r;++i){const r=e[i];s[i]=new t.Vector3(r.x,r.y,r.z),n[i]=r.w}const i=[];for(let e=0;e<r;++e){const t=s[e].clone();for(let r=1;r<=e;++r)t.sub(i[e-r].clone().multiplyScalar(Gs(e,r)*n[r]));i[e]=t.divideScalar(n[0])}return i}(function(e,r,s,n,i){const a=i<e?i:e,o=[],l=Us(e,n,r),c=function(e,t,r,s,n){const i=[];for(let e=0;e<=r;++e)i[e]=0;const a=[];for(let e=0;e<=s;++e)a[e]=i.slice(0);const o=[];for(let e=0;e<=r;++e)o[e]=i.slice(0);o[0][0]=1;const l=i.slice(0),c=i.slice(0);for(let s=1;s<=r;++s){l[s]=t-n[e+1-s],c[s]=n[e+s]-t;let r=0;for(let e=0;e<s;++e){const t=c[e+1],n=l[s-e];o[s][e]=t+n;const i=o[e][s-1]/o[s][e];o[e][s]=r+t*i,r=n*i}o[s][s]=r}for(let e=0;e<=r;++e)a[0][e]=o[e][r];for(let e=0;e<=r;++e){let t=0,n=1;const l=[];for(let e=0;e<=r;++e)l[e]=i.slice(0);l[0][0]=1;for(let i=1;i<=s;++i){let s=0;const c=e-i,h=r-i;e>=i&&(l[n][0]=l[t][0]/o[h+1][c],s=l[n][0]*o[c][h]);const u=e-1<=h?i-1:r-e;for(let e=c>=-1?1:-c;e<=u;++e)l[n][e]=(l[t][e]-l[t][e-1])/o[h+1][c+e],s+=l[n][e]*o[c+e][h];e<=h&&(l[n][i]=-l[t][i-1]/o[h+1][e],s+=l[n][i]*o[e][h]),a[i][e]=s;const d=t;t=n,n=d}}let h=r;for(let e=1;e<=s;++e){for(let t=0;t<=r;++t)a[e][t]*=h;h*=r-e}return a}(l,n,e,a,r),h=[];for(let e=0;e<s.length;++e){const t=s[e].clone(),r=t.w;t.x*=r,t.y*=r,t.z*=r,h[e]=t}for(let t=0;t<=a;++t){const r=h[l-e].clone().multiplyScalar(c[t][0]);for(let s=1;s<=e;++s)r.add(h[l-e+s].clone().multiplyScalar(c[t][s]));o[t]=r}for(let e=a+1;e<=i+1;++e)o[e]=new t.Vector4(0,0,0);return o}(e,r,s,n,i))}class Hs extends t.Curve{constructor(e,r,s,n,i){super(),this.degree=e,this.knots=r,this.controlPoints=[],this.startKnot=n||0,this.endKnot=i||this.knots.length-1;for(let e=0;e<s.length;++e){const r=s[e];this.controlPoints[e]=new t.Vector4(r.x,r.y,r.z,r.w)}}getPoint(e,r=new t.Vector3){const s=r,n=this.knots[this.startKnot]+e*(this.knots[this.endKnot]-this.knots[this.startKnot]),i=function(e,r,s,n){const i=Us(e,n,r),a=function(e,t,r,s){const n=[],i=[],a=[];n[0]=1;for(let o=1;o<=r;++o){i[o]=t-s[e+1-o],a[o]=s[e+o]-t;let r=0;for(let e=0;e<o;++e){const t=a[e+1],s=i[o-e],l=n[e]/(t+s);n[e]=r+t*l,r=s*l}n[o]=r}return n}(i,n,e,r),o=new t.Vector4(0,0,0,0);for(let t=0;t<=e;++t){const r=s[i-e+t],n=a[t],l=r.w*n;o.x+=r.x*l,o.y+=r.y*l,o.z+=r.z*l,o.w+=r.w*n}return o}(this.degree,this.knots,this.controlPoints,n);return 1!==i.w&&i.divideScalar(i.w),s.set(i.x,i.y,i.z)}getTangent(e,r=new t.Vector3){const s=r,n=this.knots[0]+e*(this.knots[this.knots.length-1]-this.knots[0]),i=Vs(this.degree,this.knots,this.controlPoints,n,1);return s.copy(i[1]).normalize(),s}}let js,Ws,Xs;class qs extends t.Loader{constructor(e){super(e)}load(e,r,s,n){const i=this,a=""===i.path?t.LoaderUtils.extractUrlBase(e):i.path,o=new t.FileLoader(this.manager);o.setPath(i.path),o.setResponseType("arraybuffer"),o.setRequestHeader(i.requestHeader),o.setWithCredentials(i.withCredentials),o.load(e,(function(t){try{r(i.parse(t,a))}catch(t){n?n(t):console.error(t),i.manager.itemError(e)}}),s,n)}parse(e,r){if(function(e){const t="Kaydara FBX Binary  \0";return e.byteLength>=t.length&&t===un(e,0,t.length)}(e))js=(new Js).parse(e);else{const t=un(e);if(!function(e){const t=["K","a","y","d","a","r","a","\\","F","B","X","\\","B","i","n","a","r","y","\\","\\"];let r=0;function s(t){const s=e[t-1];return e=e.slice(r+t),r++,s}for(let e=0;e<t.length;++e){if(s(1)===t[e])return!1}return!0}(t))throw new Error("THREE.FBXLoader: Unknown format.");if(tn(t)<7e3)throw new Error("THREE.FBXLoader: FBX version not supported, FileVersion: "+tn(t));js=(new Zs).parse(t)}const s=new t.TextureLoader(this.manager).setPath(this.resourcePath||r).setCrossOrigin(this.crossOrigin);return new Ks(s,this.manager).parse(js)}}class Ks{constructor(e,t){this.textureLoader=e,this.manager=t}parse(){Ws=this.parseConnections();const e=this.parseImages(),t=this.parseTextures(e),r=this.parseMaterials(t),s=this.parseDeformers(),n=(new Qs).parse(s);return this.parseScene(s,n,r),Xs}parseConnections(){const e=new Map;if("Connections"in js){js.Connections.connections.forEach((function(t){const r=t[0],s=t[1],n=t[2];e.has(r)||e.set(r,{parents:[],children:[]});const i={ID:s,relationship:n};e.get(r).parents.push(i),e.has(s)||e.set(s,{parents:[],children:[]});const a={ID:r,relationship:n};e.get(s).children.push(a)}))}return e}parseImages(){const e={},t={};if("Video"in js.Objects){const r=js.Objects.Video;for(const s in r){const n=r[s];if(e[parseInt(s)]=n.RelativeFilename||n.Filename,"Content"in n){const e=n.Content instanceof ArrayBuffer&&n.Content.byteLength>0,i="string"==typeof n.Content&&""!==n.Content;if(e||i){const e=this.parseImage(r[s]);t[n.RelativeFilename||n.Filename]=e}}}}for(const r in e){const s=e[r];void 0!==t[s]?e[r]=t[s]:e[r]=e[r].split("\\").pop()}return e}parseImage(e){const t=e.Content,r=e.RelativeFilename||e.Filename,s=r.slice(r.lastIndexOf(".")+1).toLowerCase();let n;switch(s){case"bmp":n="image/bmp";break;case"jpg":case"jpeg":n="image/jpeg";break;case"png":n="image/png";break;case"tif":n="image/tiff";break;case"tga":null===this.manager.getHandler(".tga")&&console.warn("FBXLoader: TGA loader not found, skipping ",r),n="image/tga";break;default:return void console.warn('FBXLoader: Image type "'+s+'" is not supported.')}if("string"==typeof t)return"data:"+n+";base64,"+t;{const e=new Uint8Array(t);return window.URL.createObjectURL(new Blob([e],{type:n}))}}parseTextures(e){const t=new Map;if("Texture"in js.Objects){const r=js.Objects.Texture;for(const s in r){const n=this.parseTexture(r[s],e);t.set(parseInt(s),n)}}return t}parseTexture(e,r){const s=this.loadTexture(e,r);s.ID=e.id,s.name=e.attrName;const n=e.WrapModeU,i=e.WrapModeV,a=void 0!==n?n.value:0,o=void 0!==i?i.value:0;if(s.wrapS=0===a?t.RepeatWrapping:t.ClampToEdgeWrapping,s.wrapT=0===o?t.RepeatWrapping:t.ClampToEdgeWrapping,"Scaling"in e){const t=e.Scaling.value;s.repeat.x=t[0],s.repeat.y=t[1]}if("Translation"in e){const t=e.Translation.value;s.offset.x=t[0],s.offset.y=t[1]}return s}loadTexture(e,r){let s;const n=this.textureLoader.path,i=Ws.get(e.id).children;let a;void 0!==i&&i.length>0&&void 0!==r[i[0].ID]&&(s=r[i[0].ID],0!==s.indexOf("blob:")&&0!==s.indexOf("data:")||this.textureLoader.setPath(void 0));const o=e.FileName.slice(-3).toLowerCase();if("tga"===o){const r=this.manager.getHandler(".tga");null===r?(console.warn("FBXLoader: TGA loader not found, creating placeholder texture for",e.RelativeFilename),a=new t.Texture):(r.setPath(this.textureLoader.path),a=r.load(s))}else"psd"===o?(console.warn("FBXLoader: PSD textures are not supported, creating placeholder texture for",e.RelativeFilename),a=new t.Texture):a=this.textureLoader.load(s);return this.textureLoader.setPath(n),a}parseMaterials(e){const t=new Map;if("Material"in js.Objects){const r=js.Objects.Material;for(const s in r){const n=this.parseMaterial(r[s],e);null!==n&&t.set(parseInt(s),n)}}return t}parseMaterial(e,r){const s=e.id,n=e.attrName;let i=e.ShadingModel;if("object"==typeof i&&(i=i.value),!Ws.has(s))return null;const a=this.parseParameters(e,r,s);let o;switch(i.toLowerCase()){case"phong":o=new t.MeshPhongMaterial;break;case"lambert":o=new t.MeshLambertMaterial;break;default:console.warn('THREE.FBXLoader: unknown material type "%s". Defaulting to MeshPhongMaterial.',i),o=new t.MeshPhongMaterial}return o.setValues(a),o.name=n,o}parseParameters(e,r,s){const n={};e.BumpFactor&&(n.bumpScale=e.BumpFactor.value),e.Diffuse?n.color=(new t.Color).fromArray(e.Diffuse.value):!e.DiffuseColor||"Color"!==e.DiffuseColor.type&&"ColorRGB"!==e.DiffuseColor.type||(n.color=(new t.Color).fromArray(e.DiffuseColor.value)),e.DisplacementFactor&&(n.displacementScale=e.DisplacementFactor.value),e.Emissive?n.emissive=(new t.Color).fromArray(e.Emissive.value):!e.EmissiveColor||"Color"!==e.EmissiveColor.type&&"ColorRGB"!==e.EmissiveColor.type||(n.emissive=(new t.Color).fromArray(e.EmissiveColor.value)),e.EmissiveFactor&&(n.emissiveIntensity=parseFloat(e.EmissiveFactor.value)),e.Opacity&&(n.opacity=parseFloat(e.Opacity.value)),n.opacity<1&&(n.transparent=!0),e.ReflectionFactor&&(n.reflectivity=e.ReflectionFactor.value),e.Shininess&&(n.shininess=e.Shininess.value),e.Specular?n.specular=(new t.Color).fromArray(e.Specular.value):e.SpecularColor&&"Color"===e.SpecularColor.type&&(n.specular=(new t.Color).fromArray(e.SpecularColor.value));const i=this;return Ws.get(s).children.forEach((function(e){const s=e.relationship;switch(s){case"Bump":n.bumpMap=i.getTexture(r,e.ID);break;case"Maya|TEX_ao_map":n.aoMap=i.getTexture(r,e.ID);break;case"DiffuseColor":case"Maya|TEX_color_map":n.map=i.getTexture(r,e.ID),void 0!==n.map&&(n.map.encoding=t.sRGBEncoding);break;case"DisplacementColor":n.displacementMap=i.getTexture(r,e.ID);break;case"EmissiveColor":n.emissiveMap=i.getTexture(r,e.ID),void 0!==n.emissiveMap&&(n.emissiveMap.encoding=t.sRGBEncoding);break;case"NormalMap":case"Maya|TEX_normal_map":n.normalMap=i.getTexture(r,e.ID);break;case"ReflectionColor":n.envMap=i.getTexture(r,e.ID),void 0!==n.envMap&&(n.envMap.mapping=t.EquirectangularReflectionMapping,n.envMap.encoding=t.sRGBEncoding);break;case"SpecularColor":n.specularMap=i.getTexture(r,e.ID),void 0!==n.specularMap&&(n.specularMap.encoding=t.sRGBEncoding);break;case"TransparentColor":case"TransparencyFactor":n.alphaMap=i.getTexture(r,e.ID),n.transparent=!0;break;case"AmbientColor":case"ShininessExponent":case"SpecularFactor":case"VectorDisplacementColor":default:console.warn("THREE.FBXLoader: %s map is not supported in three.js, skipping texture.",s)}})),n}getTexture(e,t){return"LayeredTexture"in js.Objects&&t in js.Objects.LayeredTexture&&(console.warn("THREE.FBXLoader: layered textures are not supported in three.js. Discarding all but first layer."),t=Ws.get(t).children[0].ID),e.get(t)}parseDeformers(){const e={},t={};if("Deformer"in js.Objects){const r=js.Objects.Deformer;for(const s in r){const n=r[s],i=Ws.get(parseInt(s));if("Skin"===n.attrType){const t=this.parseSkeleton(i,r);t.ID=s,i.parents.length>1&&console.warn("THREE.FBXLoader: skeleton attached to more than one geometry is not supported."),t.geometryID=i.parents[0].ID,e[s]=t}else if("BlendShape"===n.attrType){const e={id:s};e.rawTargets=this.parseMorphTargets(i,r),e.id=s,i.parents.length>1&&console.warn("THREE.FBXLoader: morph target attached to more than one geometry is not supported."),t[s]=e}}}return{skeletons:e,morphTargets:t}}parseSkeleton(e,r){const s=[];return e.children.forEach((function(e){const n=r[e.ID];if("Cluster"!==n.attrType)return;const i={ID:e.ID,indices:[],weights:[],transformLink:(new t.Matrix4).fromArray(n.TransformLink.a)};"Indexes"in n&&(i.indices=n.Indexes.a,i.weights=n.Weights.a),s.push(i)})),{rawBones:s,bones:[]}}parseMorphTargets(e,t){const r=[];for(let s=0;s<e.children.length;s++){const n=e.children[s],i=t[n.ID],a={name:i.attrName,initialWeight:i.DeformPercent,id:i.id,fullWeights:i.FullWeights.a};if("BlendShapeChannel"!==i.attrType)return;a.geoID=Ws.get(parseInt(n.ID)).children.filter((function(e){return void 0===e.relationship}))[0].ID,r.push(a)}return r}parseScene(e,r,s){Xs=new t.Group;const n=this.parseModels(e.skeletons,r,s),i=js.Objects.Model,a=this;n.forEach((function(e){const t=i[e.ID];a.setLookAtProperties(e,t);Ws.get(e.ID).parents.forEach((function(t){const r=n.get(t.ID);void 0!==r&&r.add(e)})),null===e.parent&&Xs.add(e)})),this.bindSkeleton(e.skeletons,r,n),this.createAmbientLight(),Xs.traverse((function(e){if(e.userData.transformData){e.parent&&(e.userData.transformData.parentMatrix=e.parent.matrix,e.userData.transformData.parentMatrixWorld=e.parent.matrixWorld);const t=ln(e.userData.transformData);e.applyMatrix4(t),e.updateWorldMatrix()}}));const o=(new Ys).parse();1===Xs.children.length&&Xs.children[0].isGroup&&(Xs.children[0].animations=o,Xs=Xs.children[0]),Xs.animations=o}parseModels(e,r,s){const n=new Map,i=js.Objects.Model;for(const a in i){const o=parseInt(a),l=i[a],c=Ws.get(o);let h=this.buildSkeleton(c,e,o,l.attrName);if(!h){switch(l.attrType){case"Camera":h=this.createCamera(c);break;case"Light":h=this.createLight(c);break;case"Mesh":h=this.createMesh(c,r,s);break;case"NurbsCurve":h=this.createCurve(c,r);break;case"LimbNode":case"Root":h=new t.Bone;break;case"Null":default:h=new t.Group}h.name=l.attrName?t.PropertyBinding.sanitizeNodeName(l.attrName):"",h.ID=o}this.getTransformData(h,l),n.set(o,h)}return n}buildSkeleton(e,r,s,n){let i=null;return e.parents.forEach((function(e){for(const a in r){const o=r[a];o.rawBones.forEach((function(r,a){if(r.ID===e.ID){const e=i;i=new t.Bone,i.matrixWorld.copy(r.transformLink),i.name=n?t.PropertyBinding.sanitizeNodeName(n):"",i.ID=s,o.bones[a]=i,null!==e&&i.add(e)}}))}})),i}createCamera(e){let r,s;if(e.children.forEach((function(e){const t=js.Objects.NodeAttribute[e.ID];void 0!==t&&(s=t)})),void 0===s)r=new t.Object3D;else{let e=0;void 0!==s.CameraProjectionType&&1===s.CameraProjectionType.value&&(e=1);let n=1;void 0!==s.NearPlane&&(n=s.NearPlane.value/1e3);let i=1e3;void 0!==s.FarPlane&&(i=s.FarPlane.value/1e3);let a=window.innerWidth,o=window.innerHeight;void 0!==s.AspectWidth&&void 0!==s.AspectHeight&&(a=s.AspectWidth.value,o=s.AspectHeight.value);const l=a/o;let c=45;void 0!==s.FieldOfView&&(c=s.FieldOfView.value);const h=s.FocalLength?s.FocalLength.value:null;switch(e){case 0:r=new t.PerspectiveCamera(c,l,n,i),null!==h&&r.setFocalLength(h);break;case 1:r=new t.OrthographicCamera(-a/2,a/2,o/2,-o/2,n,i);break;default:console.warn("THREE.FBXLoader: Unknown camera type "+e+"."),r=new t.Object3D}}return r}createLight(e){let r,s;if(e.children.forEach((function(e){const t=js.Objects.NodeAttribute[e.ID];void 0!==t&&(s=t)})),void 0===s)r=new t.Object3D;else{let e;e=void 0===s.LightType?0:s.LightType.value;let n=16777215;void 0!==s.Color&&(n=(new t.Color).fromArray(s.Color.value));let i=void 0===s.Intensity?1:s.Intensity.value/100;void 0!==s.CastLightOnObject&&0===s.CastLightOnObject.value&&(i=0);let a=0;void 0!==s.FarAttenuationEnd&&(a=void 0!==s.EnableFarAttenuation&&0===s.EnableFarAttenuation.value?0:s.FarAttenuationEnd.value);const o=1;switch(e){case 0:r=new t.PointLight(n,i,a,o);break;case 1:r=new t.DirectionalLight(n,i);break;case 2:let e=Math.PI/3;void 0!==s.InnerAngle&&(e=t.MathUtils.degToRad(s.InnerAngle.value));let l=0;void 0!==s.OuterAngle&&(l=t.MathUtils.degToRad(s.OuterAngle.value),l=Math.max(l,1)),r=new t.SpotLight(n,i,a,e,l,o);break;default:console.warn("THREE.FBXLoader: Unknown light type "+s.LightType.value+", defaulting to a PointLight."),r=new t.PointLight(n,i)}void 0!==s.CastShadows&&1===s.CastShadows.value&&(r.castShadow=!0)}return r}createMesh(e,r,s){let n,i=null,a=null;const o=[];return e.children.forEach((function(e){r.has(e.ID)&&(i=r.get(e.ID)),s.has(e.ID)&&o.push(s.get(e.ID))})),o.length>1?a=o:o.length>0?a=o[0]:(a=new t.MeshPhongMaterial({color:13421772}),o.push(a)),"color"in i.attributes&&o.forEach((function(e){e.vertexColors=!0})),i.FBX_Deformer?(n=new t.SkinnedMesh(i,a),n.normalizeSkinWeights()):n=new t.Mesh(i,a),n}createCurve(e,r){const s=e.children.reduce((function(e,t){return r.has(t.ID)&&(e=r.get(t.ID)),e}),null),n=new t.LineBasicMaterial({color:3342591,linewidth:1});return new t.Line(s,n)}getTransformData(e,t){const r={};"InheritType"in t&&(r.inheritType=parseInt(t.InheritType.value)),r.eulerOrder="RotationOrder"in t?cn(t.RotationOrder.value):"ZYX","Lcl_Translation"in t&&(r.translation=t.Lcl_Translation.value),"PreRotation"in t&&(r.preRotation=t.PreRotation.value),"Lcl_Rotation"in t&&(r.rotation=t.Lcl_Rotation.value),"PostRotation"in t&&(r.postRotation=t.PostRotation.value),"Lcl_Scaling"in t&&(r.scale=t.Lcl_Scaling.value),"ScalingOffset"in t&&(r.scalingOffset=t.ScalingOffset.value),"ScalingPivot"in t&&(r.scalingPivot=t.ScalingPivot.value),"RotationOffset"in t&&(r.rotationOffset=t.RotationOffset.value),"RotationPivot"in t&&(r.rotationPivot=t.RotationPivot.value),e.userData.transformData=r}setLookAtProperties(e,r){if("LookAtProperty"in r){Ws.get(e.ID).children.forEach((function(r){if("LookAtProperty"===r.relationship){const s=js.Objects.Model[r.ID];if("Lcl_Translation"in s){const r=s.Lcl_Translation.value;void 0!==e.target?(e.target.position.fromArray(r),Xs.add(e.target)):e.lookAt((new t.Vector3).fromArray(r))}}}))}}bindSkeleton(e,r,s){const n=this.parsePoseNodes();for(const i in e){const a=e[i];Ws.get(parseInt(a.ID)).parents.forEach((function(e){if(r.has(e.ID)){const r=e.ID;Ws.get(r).parents.forEach((function(e){if(s.has(e.ID)){s.get(e.ID).bind(new t.Skeleton(a.bones),n[e.ID])}}))}}))}}parsePoseNodes(){const e={};if("Pose"in js.Objects){const r=js.Objects.Pose;for(const s in r)if("BindPose"===r[s].attrType&&r[s].NbPoseNodes>0){const n=r[s].PoseNode;Array.isArray(n)?n.forEach((function(r){e[r.Node]=(new t.Matrix4).fromArray(r.Matrix.a)})):e[n.Node]=(new t.Matrix4).fromArray(n.Matrix.a)}}return e}createAmbientLight(){if("GlobalSettings"in js&&"AmbientColor"in js.GlobalSettings){const e=js.GlobalSettings.AmbientColor.value,r=e[0],s=e[1],n=e[2];if(0!==r||0!==s||0!==n){const e=new t.Color(r,s,n);Xs.add(new t.AmbientLight(e,1))}}}}class Qs{constructor(){this.negativeMaterialIndices=!1}parse(e){const t=new Map;if("Geometry"in js.Objects){const r=js.Objects.Geometry;for(const s in r){const n=Ws.get(parseInt(s)),i=this.parseGeometry(n,r[s],e);t.set(parseInt(s),i)}}return!0===this.negativeMaterialIndices&&console.warn("THREE.FBXLoader: The FBX file contains invalid (negative) material indices. The asset might not render as expected."),t}parseGeometry(e,t,r){switch(t.attrType){case"Mesh":return this.parseMeshGeometry(e,t,r);case"NurbsCurve":return this.parseNurbsGeometry(t)}}parseMeshGeometry(e,t,r){const s=r.skeletons,n=[],i=e.parents.map((function(e){return js.Objects.Model[e.ID]}));if(0===i.length)return;const a=e.children.reduce((function(e,t){return void 0!==s[t.ID]&&(e=s[t.ID]),e}),null);e.children.forEach((function(e){void 0!==r.morphTargets[e.ID]&&n.push(r.morphTargets[e.ID])}));const o=i[0],l={};"RotationOrder"in o&&(l.eulerOrder=cn(o.RotationOrder.value)),"InheritType"in o&&(l.inheritType=parseInt(o.InheritType.value)),"GeometricTranslation"in o&&(l.translation=o.GeometricTranslation.value),"GeometricRotation"in o&&(l.rotation=o.GeometricRotation.value),"GeometricScaling"in o&&(l.scale=o.GeometricScaling.value);const c=ln(l);return this.genGeometry(t,a,n,c)}genGeometry(e,r,s,n){const i=new t.BufferGeometry;e.attrName&&(i.name=e.attrName);const a=this.parseGeoNode(e,r),o=this.genBuffers(a),l=new t.Float32BufferAttribute(o.vertex,3);if(l.applyMatrix4(n),i.setAttribute("position",l),o.colors.length>0&&i.setAttribute("color",new t.Float32BufferAttribute(o.colors,3)),r&&(i.setAttribute("skinIndex",new t.Uint16BufferAttribute(o.weightsIndices,4)),i.setAttribute("skinWeight",new t.Float32BufferAttribute(o.vertexWeights,4)),i.FBX_Deformer=r),o.normal.length>0){const e=(new t.Matrix3).getNormalMatrix(n),r=new t.Float32BufferAttribute(o.normal,3);r.applyNormalMatrix(e),i.setAttribute("normal",r)}if(o.uvs.forEach((function(e,r){let s="uv"+(r+1).toString();0===r&&(s="uv"),i.setAttribute(s,new t.Float32BufferAttribute(o.uvs[r],2))})),a.material&&"AllSame"!==a.material.mappingType){let e=o.materialIndex[0],t=0;if(o.materialIndex.forEach((function(r,s){r!==e&&(i.addGroup(t,s-t,e),e=r,t=s)})),i.groups.length>0){const t=i.groups[i.groups.length-1],r=t.start+t.count;r!==o.materialIndex.length&&i.addGroup(r,o.materialIndex.length-r,e)}0===i.groups.length&&i.addGroup(0,o.materialIndex.length,o.materialIndex[0])}return this.addMorphTargets(i,e,s,n),i}parseGeoNode(e,t){const r={};if(r.vertexPositions=void 0!==e.Vertices?e.Vertices.a:[],r.vertexIndices=void 0!==e.PolygonVertexIndex?e.PolygonVertexIndex.a:[],e.LayerElementColor&&(r.color=this.parseVertexColors(e.LayerElementColor[0])),e.LayerElementMaterial&&(r.material=this.parseMaterialIndices(e.LayerElementMaterial[0])),e.LayerElementNormal&&(r.normal=this.parseNormals(e.LayerElementNormal[0])),e.LayerElementUV){r.uv=[];let t=0;for(;e.LayerElementUV[t];)e.LayerElementUV[t].UV&&r.uv.push(this.parseUVs(e.LayerElementUV[t])),t++}return r.weightTable={},null!==t&&(r.skeleton=t,t.rawBones.forEach((function(e,t){e.indices.forEach((function(s,n){void 0===r.weightTable[s]&&(r.weightTable[s]=[]),r.weightTable[s].push({id:t,weight:e.weights[n]})}))}))),r}genBuffers(e){const t={vertex:[],normal:[],colors:[],uvs:[],materialIndex:[],vertexWeights:[],weightsIndices:[]};let r=0,s=0,n=!1,i=[],a=[],o=[],l=[],c=[],h=[];const u=this;return e.vertexIndices.forEach((function(d,p){let f,m=!1;d<0&&(d^=-1,m=!0);let g=[],y=[];if(i.push(3*d,3*d+1,3*d+2),e.color){const t=nn(p,r,d,e.color);o.push(t[0],t[1],t[2])}if(e.skeleton){if(void 0!==e.weightTable[d]&&e.weightTable[d].forEach((function(e){y.push(e.weight),g.push(e.id)})),y.length>4){n||(console.warn("THREE.FBXLoader: Vertex has more than 4 skinning weights assigned to vertex. Deleting additional weights."),n=!0);const e=[0,0,0,0],t=[0,0,0,0];y.forEach((function(r,s){let n=r,i=g[s];t.forEach((function(t,r,s){if(n>t){s[r]=n,n=t;const a=e[r];e[r]=i,i=a}}))})),g=e,y=t}for(;y.length<4;)y.push(0),g.push(0);for(let e=0;e<4;++e)c.push(y[e]),h.push(g[e])}if(e.normal){const t=nn(p,r,d,e.normal);a.push(t[0],t[1],t[2])}e.material&&"AllSame"!==e.material.mappingType&&(f=nn(p,r,d,e.material)[0],f<0&&(u.negativeMaterialIndices=!0,f=0)),e.uv&&e.uv.forEach((function(e,t){const s=nn(p,r,d,e);void 0===l[t]&&(l[t]=[]),l[t].push(s[0]),l[t].push(s[1])})),s++,m&&(u.genFace(t,e,i,f,a,o,l,c,h,s),r++,s=0,i=[],a=[],o=[],l=[],c=[],h=[])})),t}genFace(e,t,r,s,n,i,a,o,l,c){for(let h=2;h<c;h++)e.vertex.push(t.vertexPositions[r[0]]),e.vertex.push(t.vertexPositions[r[1]]),e.vertex.push(t.vertexPositions[r[2]]),e.vertex.push(t.vertexPositions[r[3*(h-1)]]),e.vertex.push(t.vertexPositions[r[3*(h-1)+1]]),e.vertex.push(t.vertexPositions[r[3*(h-1)+2]]),e.vertex.push(t.vertexPositions[r[3*h]]),e.vertex.push(t.vertexPositions[r[3*h+1]]),e.vertex.push(t.vertexPositions[r[3*h+2]]),t.skeleton&&(e.vertexWeights.push(o[0]),e.vertexWeights.push(o[1]),e.vertexWeights.push(o[2]),e.vertexWeights.push(o[3]),e.vertexWeights.push(o[4*(h-1)]),e.vertexWeights.push(o[4*(h-1)+1]),e.vertexWeights.push(o[4*(h-1)+2]),e.vertexWeights.push(o[4*(h-1)+3]),e.vertexWeights.push(o[4*h]),e.vertexWeights.push(o[4*h+1]),e.vertexWeights.push(o[4*h+2]),e.vertexWeights.push(o[4*h+3]),e.weightsIndices.push(l[0]),e.weightsIndices.push(l[1]),e.weightsIndices.push(l[2]),e.weightsIndices.push(l[3]),e.weightsIndices.push(l[4*(h-1)]),e.weightsIndices.push(l[4*(h-1)+1]),e.weightsIndices.push(l[4*(h-1)+2]),e.weightsIndices.push(l[4*(h-1)+3]),e.weightsIndices.push(l[4*h]),e.weightsIndices.push(l[4*h+1]),e.weightsIndices.push(l[4*h+2]),e.weightsIndices.push(l[4*h+3])),t.color&&(e.colors.push(i[0]),e.colors.push(i[1]),e.colors.push(i[2]),e.colors.push(i[3*(h-1)]),e.colors.push(i[3*(h-1)+1]),e.colors.push(i[3*(h-1)+2]),e.colors.push(i[3*h]),e.colors.push(i[3*h+1]),e.colors.push(i[3*h+2])),t.material&&"AllSame"!==t.material.mappingType&&(e.materialIndex.push(s),e.materialIndex.push(s),e.materialIndex.push(s)),t.normal&&(e.normal.push(n[0]),e.normal.push(n[1]),e.normal.push(n[2]),e.normal.push(n[3*(h-1)]),e.normal.push(n[3*(h-1)+1]),e.normal.push(n[3*(h-1)+2]),e.normal.push(n[3*h]),e.normal.push(n[3*h+1]),e.normal.push(n[3*h+2])),t.uv&&t.uv.forEach((function(t,r){void 0===e.uvs[r]&&(e.uvs[r]=[]),e.uvs[r].push(a[r][0]),e.uvs[r].push(a[r][1]),e.uvs[r].push(a[r][2*(h-1)]),e.uvs[r].push(a[r][2*(h-1)+1]),e.uvs[r].push(a[r][2*h]),e.uvs[r].push(a[r][2*h+1])}))}addMorphTargets(e,t,r,s){if(0===r.length)return;e.morphTargetsRelative=!0,e.morphAttributes.position=[];const n=this;r.forEach((function(r){r.rawTargets.forEach((function(r){const i=js.Objects.Geometry[r.geoID];void 0!==i&&n.genMorphGeometry(e,t,i,s,r.name)}))}))}genMorphGeometry(e,r,s,n,i){const a=void 0!==r.PolygonVertexIndex?r.PolygonVertexIndex.a:[],o=void 0!==s.Vertices?s.Vertices.a:[],l=void 0!==s.Indexes?s.Indexes.a:[],c=3*e.attributes.position.count,h=new Float32Array(c);for(let e=0;e<l.length;e++){const t=3*l[e];h[t]=o[3*e],h[t+1]=o[3*e+1],h[t+2]=o[3*e+2]}const u={vertexIndices:a,vertexPositions:h},d=this.genBuffers(u),p=new t.Float32BufferAttribute(d.vertex,3);p.name=i||s.attrName,p.applyMatrix4(n),e.morphAttributes.position.push(p)}parseNormals(e){const t=e.MappingInformationType,r=e.ReferenceInformationType,s=e.Normals.a;let n=[];return"IndexToDirect"===r&&("NormalIndex"in e?n=e.NormalIndex.a:"NormalsIndex"in e&&(n=e.NormalsIndex.a)),{dataSize:3,buffer:s,indices:n,mappingType:t,referenceType:r}}parseUVs(e){const t=e.MappingInformationType,r=e.ReferenceInformationType,s=e.UV.a;let n=[];return"IndexToDirect"===r&&(n=e.UVIndex.a),{dataSize:2,buffer:s,indices:n,mappingType:t,referenceType:r}}parseVertexColors(e){const t=e.MappingInformationType,r=e.ReferenceInformationType,s=e.Colors.a;let n=[];return"IndexToDirect"===r&&(n=e.ColorIndex.a),{dataSize:4,buffer:s,indices:n,mappingType:t,referenceType:r}}parseMaterialIndices(e){const t=e.MappingInformationType,r=e.ReferenceInformationType;if("NoMappingInformation"===t)return{dataSize:1,buffer:[0],indices:[0],mappingType:"AllSame",referenceType:r};const s=e.Materials.a,n=[];for(let e=0;e<s.length;++e)n.push(e);return{dataSize:1,buffer:s,indices:n,mappingType:t,referenceType:r}}parseNurbsGeometry(e){if(void 0===Hs)return console.error("THREE.FBXLoader: The loader relies on NURBSCurve for any nurbs present in the model. Nurbs will show up as empty geometry."),new t.BufferGeometry;const r=parseInt(e.Order);if(isNaN(r))return console.error("THREE.FBXLoader: Invalid Order %s given for geometry ID: %s",e.Order,e.id),new t.BufferGeometry;const s=r-1,n=e.KnotVector.a,i=[],a=e.Points.a;for(let e=0,r=a.length;e<r;e+=4)i.push((new t.Vector4).fromArray(a,e));let o,l;if("Closed"===e.Form)i.push(i[0]);else if("Periodic"===e.Form){o=s,l=n.length-1-o;for(let e=0;e<s;++e)i.push(i[e])}const c=new Hs(s,n,i,o,l).getPoints(12*i.length);return(new t.BufferGeometry).setFromPoints(c)}}class Ys{parse(){const e=[],t=this.parseClips();if(void 0!==t)for(const r in t){const s=t[r],n=this.addClip(s);e.push(n)}return e}parseClips(){if(void 0===js.Objects.AnimationCurve)return;const e=this.parseAnimationCurveNodes();this.parseAnimationCurves(e);const t=this.parseAnimationLayers(e);return this.parseAnimStacks(t)}parseAnimationCurveNodes(){const e=js.Objects.AnimationCurveNode,t=new Map;for(const r in e){const s=e[r];if(null!==s.attrName.match(/S|R|T|DeformPercent/)){const e={id:s.id,attr:s.attrName,curves:{}};t.set(e.id,e)}}return t}parseAnimationCurves(e){const t=js.Objects.AnimationCurve;for(const r in t){const s={id:t[r].id,times:t[r].KeyTime.a.map(rn),values:t[r].KeyValueFloat.a},n=Ws.get(s.id);if(void 0!==n){const t=n.parents[0].ID,r=n.parents[0].relationship;r.match(/X/)?e.get(t).curves.x=s:r.match(/Y/)?e.get(t).curves.y=s:r.match(/Z/)?e.get(t).curves.z=s:r.match(/d|DeformPercent/)&&e.has(t)&&(e.get(t).curves.morph=s)}}}parseAnimationLayers(e){const r=js.Objects.AnimationLayer,s=new Map;for(const n in r){const r=[],i=Ws.get(parseInt(n));if(void 0!==i){i.children.forEach((function(s,n){if(e.has(s.ID)){const i=e.get(s.ID);if(void 0!==i.curves.x||void 0!==i.curves.y||void 0!==i.curves.z){if(void 0===r[n]){const e=Ws.get(s.ID).parents.filter((function(e){return void 0!==e.relationship}))[0].ID;if(void 0!==e){const i=js.Objects.Model[e.toString()];if(void 0===i)return void console.warn("THREE.FBXLoader: Encountered a unused curve.",s);const a={modelName:i.attrName?t.PropertyBinding.sanitizeNodeName(i.attrName):"",ID:i.id,initialPosition:[0,0,0],initialRotation:[0,0,0],initialScale:[1,1,1]};Xs.traverse((function(e){e.ID===i.id&&(a.transform=e.matrix,e.userData.transformData&&(a.eulerOrder=e.userData.transformData.eulerOrder))})),a.transform||(a.transform=new t.Matrix4),"PreRotation"in i&&(a.preRotation=i.PreRotation.value),"PostRotation"in i&&(a.postRotation=i.PostRotation.value),r[n]=a}}r[n]&&(r[n][i.attr]=i)}else if(void 0!==i.curves.morph){if(void 0===r[n]){const e=Ws.get(s.ID).parents.filter((function(e){return void 0!==e.relationship}))[0].ID,i=Ws.get(e).parents[0].ID,a=Ws.get(i).parents[0].ID,o=Ws.get(a).parents[0].ID,l=js.Objects.Model[o],c={modelName:l.attrName?t.PropertyBinding.sanitizeNodeName(l.attrName):"",morphName:js.Objects.Deformer[e].attrName};r[n]=c}r[n][i.attr]=i}}})),s.set(parseInt(n),r)}}return s}parseAnimStacks(e){const t=js.Objects.AnimationStack,r={};for(const s in t){const n=Ws.get(parseInt(s)).children;n.length>1&&console.warn("THREE.FBXLoader: Encountered an animation stack with multiple layers, this is currently not supported. Ignoring subsequent layers.");const i=e.get(n[0].ID);r[s]={name:t[s].attrName,layer:i}}return r}addClip(e){let r=[];const s=this;return e.layer.forEach((function(e){r=r.concat(s.generateTracks(e))})),new t.AnimationClip(e.name,-1,r)}generateTracks(e){const r=[];let s=new t.Vector3,n=new t.Quaternion,i=new t.Vector3;if(e.transform&&e.transform.decompose(s,n,i),s=s.toArray(),n=(new t.Euler).setFromQuaternion(n,e.eulerOrder).toArray(),i=i.toArray(),void 0!==e.T&&Object.keys(e.T.curves).length>0){const t=this.generateVectorTrack(e.modelName,e.T.curves,s,"position");void 0!==t&&r.push(t)}if(void 0!==e.R&&Object.keys(e.R.curves).length>0){const t=this.generateRotationTrack(e.modelName,e.R.curves,n,e.preRotation,e.postRotation,e.eulerOrder);void 0!==t&&r.push(t)}if(void 0!==e.S&&Object.keys(e.S.curves).length>0){const t=this.generateVectorTrack(e.modelName,e.S.curves,i,"scale");void 0!==t&&r.push(t)}if(void 0!==e.DeformPercent){const t=this.generateMorphTrack(e);void 0!==t&&r.push(t)}return r}generateVectorTrack(e,r,s,n){const i=this.getTimesForAllAxes(r),a=this.getKeyframeTrackValues(i,r,s);return new t.VectorKeyframeTrack(e+"."+n,i,a)}generateRotationTrack(e,r,s,n,i,a){void 0!==r.x&&(this.interpolateRotations(r.x),r.x.values=r.x.values.map(t.MathUtils.degToRad)),void 0!==r.y&&(this.interpolateRotations(r.y),r.y.values=r.y.values.map(t.MathUtils.degToRad)),void 0!==r.z&&(this.interpolateRotations(r.z),r.z.values=r.z.values.map(t.MathUtils.degToRad));const o=this.getTimesForAllAxes(r),l=this.getKeyframeTrackValues(o,r,s);void 0!==n&&((n=n.map(t.MathUtils.degToRad)).push(a),n=(new t.Euler).fromArray(n),n=(new t.Quaternion).setFromEuler(n)),void 0!==i&&((i=i.map(t.MathUtils.degToRad)).push(a),i=(new t.Euler).fromArray(i),i=(new t.Quaternion).setFromEuler(i).invert());const c=new t.Quaternion,h=new t.Euler,u=[];for(let e=0;e<l.length;e+=3)h.set(l[e],l[e+1],l[e+2],a),c.setFromEuler(h),void 0!==n&&c.premultiply(n),void 0!==i&&c.multiply(i),c.toArray(u,e/3*4);return new t.QuaternionKeyframeTrack(e+".quaternion",o,u)}generateMorphTrack(e){const r=e.DeformPercent.curves.morph,s=r.values.map((function(e){return e/100})),n=Xs.getObjectByName(e.modelName).morphTargetDictionary[e.morphName];return new t.NumberKeyframeTrack(e.modelName+".morphTargetInfluences["+n+"]",r.times,s)}getTimesForAllAxes(e){let t=[];if(void 0!==e.x&&(t=t.concat(e.x.times)),void 0!==e.y&&(t=t.concat(e.y.times)),void 0!==e.z&&(t=t.concat(e.z.times)),t=t.sort((function(e,t){return e-t})),t.length>1){let e=1,r=t[0];for(let s=1;s<t.length;s++){const n=t[s];n!==r&&(t[e]=n,r=n,e++)}t=t.slice(0,e)}return t}getKeyframeTrackValues(e,t,r){const s=r,n=[];let i=-1,a=-1,o=-1;return e.forEach((function(e){if(t.x&&(i=t.x.times.indexOf(e)),t.y&&(a=t.y.times.indexOf(e)),t.z&&(o=t.z.times.indexOf(e)),-1!==i){const e=t.x.values[i];n.push(e),s[0]=e}else n.push(s[0]);if(-1!==a){const e=t.y.values[a];n.push(e),s[1]=e}else n.push(s[1]);if(-1!==o){const e=t.z.values[o];n.push(e),s[2]=e}else n.push(s[2])})),n}interpolateRotations(e){for(let t=1;t<e.values.length;t++){const r=e.values[t-1],s=e.values[t]-r,n=Math.abs(s);if(n>=180){const i=n/180,a=s/i;let o=r+a;const l=e.times[t-1],c=(e.times[t]-l)/i;let h=l+c;const u=[],d=[];for(;h<e.times[t];)u.push(h),h+=c,d.push(o),o+=a;e.times=dn(e.times,t,u),e.values=dn(e.values,t,d)}}}}class Zs{getPrevNode(){return this.nodeStack[this.currentIndent-2]}getCurrentNode(){return this.nodeStack[this.currentIndent-1]}getCurrentProp(){return this.currentProp}pushStack(e){this.nodeStack.push(e),this.currentIndent+=1}popStack(){this.nodeStack.pop(),this.currentIndent-=1}setCurrentProp(e,t){this.currentProp=e,this.currentPropName=t}parse(e){this.currentIndent=0,this.allNodes=new en,this.nodeStack=[],this.currentProp=[],this.currentPropName="";const t=this,r=e.split(/[\r\n]+/);return r.forEach((function(e,s){const n=e.match(/^[\s\t]*;/),i=e.match(/^[\s\t]*$/);if(n||i)return;const a=e.match("^\\t{"+t.currentIndent+"}(\\w+):(.*){",""),o=e.match("^\\t{"+t.currentIndent+"}(\\w+):[\\s\\t\\r\\n](.*)"),l=e.match("^\\t{"+(t.currentIndent-1)+"}}");a?t.parseNodeBegin(e,a):o?t.parseNodeProperty(e,o,r[++s]):l?t.popStack():e.match(/^[^\s\t}]/)&&t.parseNodePropertyContinued(e)})),this.allNodes}parseNodeBegin(e,t){const r=t[1].trim().replace(/^"/,"").replace(/"$/,""),s=t[2].split(",").map((function(e){return e.trim().replace(/^"/,"").replace(/"$/,"")})),n={name:r},i=this.parseNodeAttr(s),a=this.getCurrentNode();0===this.currentIndent?this.allNodes.add(r,n):r in a?("PoseNode"===r?a.PoseNode.push(n):void 0!==a[r].id&&(a[r]={},a[r][a[r].id]=a[r]),""!==i.id&&(a[r][i.id]=n)):"number"==typeof i.id?(a[r]={},a[r][i.id]=n):"Properties70"!==r&&(a[r]="PoseNode"===r?[n]:n),"number"==typeof i.id&&(n.id=i.id),""!==i.name&&(n.attrName=i.name),""!==i.type&&(n.attrType=i.type),this.pushStack(n)}parseNodeAttr(e){let t=e[0];""!==e[0]&&(t=parseInt(e[0]),isNaN(t)&&(t=e[0]));let r="",s="";return e.length>1&&(r=e[1].replace(/^(\w+)::/,""),s=e[2]),{id:t,name:r,type:s}}parseNodeProperty(e,t,r){let s=t[1].replace(/^"/,"").replace(/"$/,"").trim(),n=t[2].replace(/^"/,"").replace(/"$/,"").trim();"Content"===s&&","===n&&(n=r.replace(/"/g,"").replace(/,$/,"").trim());const i=this.getCurrentNode();if("Properties70"!==i.name){if("C"===s){const e=n.split(",").slice(1),t=parseInt(e[0]),r=parseInt(e[1]);let a=n.split(",").slice(3);a=a.map((function(e){return e.trim().replace(/^"/,"")})),s="connections",n=[t,r],function(e,t){for(let r=0,s=e.length,n=t.length;r<n;r++,s++)e[s]=t[r]}(n,a),void 0===i[s]&&(i[s]=[])}"Node"===s&&(i.id=n),s in i&&Array.isArray(i[s])?i[s].push(n):"a"!==s?i[s]=n:i.a=n,this.setCurrentProp(i,s),"a"===s&&","!==n.slice(-1)&&(i.a=hn(n))}else this.parseNodeSpecialProperty(e,s,n)}parseNodePropertyContinued(e){const t=this.getCurrentNode();t.a+=e,","!==e.slice(-1)&&(t.a=hn(t.a))}parseNodeSpecialProperty(e,t,r){const s=r.split('",').map((function(e){return e.trim().replace(/^\"/,"").replace(/\s/,"_")})),n=s[0],i=s[1],a=s[2],o=s[3];let l=s[4];switch(i){case"int":case"enum":case"bool":case"ULongLong":case"double":case"Number":case"FieldOfView":l=parseFloat(l);break;case"Color":case"ColorRGB":case"Vector3D":case"Lcl_Translation":case"Lcl_Rotation":case"Lcl_Scaling":l=hn(l)}this.getPrevNode()[n]={type:i,type2:a,flag:o,value:l},this.setCurrentProp(this.getPrevNode(),n)}}class Js{parse(e){const t=new $s(e);t.skip(23);const r=t.getUint32();if(r<6400)throw new Error("THREE.FBXLoader: FBX version not supported, FileVersion: "+r);const s=new en;for(;!this.endOfContent(t);){const e=this.parseNode(t,r);null!==e&&s.add(e.name,e)}return s}endOfContent(e){return e.size()%16==0?(e.getOffset()+160+16&-16)>=e.size():e.getOffset()+160+16>=e.size()}parseNode(e,t){const r={},s=t>=7500?e.getUint64():e.getUint32(),n=t>=7500?e.getUint64():e.getUint32();t>=7500?e.getUint64():e.getUint32();const i=e.getUint8(),a=e.getString(i);if(0===s)return null;const o=[];for(let t=0;t<n;t++)o.push(this.parseProperty(e));const l=o.length>0?o[0]:"",c=o.length>1?o[1]:"",h=o.length>2?o[2]:"";for(r.singleProperty=1===n&&e.getOffset()===s;s>e.getOffset();){const s=this.parseNode(e,t);null!==s&&this.parseSubNode(a,r,s)}return r.propertyList=o,"number"==typeof l&&(r.id=l),""!==c&&(r.attrName=c),""!==h&&(r.attrType=h),""!==a&&(r.name=a),r}parseSubNode(e,t,r){if(!0===r.singleProperty){const e=r.propertyList[0];Array.isArray(e)?(t[r.name]=r,r.a=e):t[r.name]=e}else if("Connections"===e&&"C"===r.name){const e=[];r.propertyList.forEach((function(t,r){0!==r&&e.push(t)})),void 0===t.connections&&(t.connections=[]),t.connections.push(e)}else if("Properties70"===r.name){Object.keys(r).forEach((function(e){t[e]=r[e]}))}else if("Properties70"===e&&"P"===r.name){let e=r.propertyList[0],s=r.propertyList[1];const n=r.propertyList[2],i=r.propertyList[3];let a;0===e.indexOf("Lcl ")&&(e=e.replace("Lcl ","Lcl_")),0===s.indexOf("Lcl ")&&(s=s.replace("Lcl ","Lcl_")),a="Color"===s||"ColorRGB"===s||"Vector"===s||"Vector3D"===s||0===s.indexOf("Lcl_")?[r.propertyList[4],r.propertyList[5],r.propertyList[6]]:r.propertyList[4],t[e]={type:s,type2:n,flag:i,value:a}}else void 0===t[r.name]?"number"==typeof r.id?(t[r.name]={},t[r.name][r.id]=r):t[r.name]=r:"PoseNode"===r.name?(Array.isArray(t[r.name])||(t[r.name]=[t[r.name]]),t[r.name].push(r)):void 0===t[r.name][r.id]&&(t[r.name][r.id]=r)}parseProperty(e){const t=e.getString(1);let r;switch(t){case"C":return e.getBoolean();case"D":return e.getFloat64();case"F":return e.getFloat32();case"I":return e.getInt32();case"L":return e.getInt64();case"R":return r=e.getUint32(),e.getArrayBuffer(r);case"S":return r=e.getUint32(),e.getString(r);case"Y":return e.getInt16();case"b":case"c":case"d":case"f":case"i":case"l":const s=e.getUint32(),n=e.getUint32(),i=e.getUint32();if(0===n)switch(t){case"b":case"c":return e.getBooleanArray(s);case"d":return e.getFloat64Array(s);case"f":return e.getFloat32Array(s);case"i":return e.getInt32Array(s);case"l":return e.getInt64Array(s)}void 0===zs&&console.error("THREE.FBXLoader: External library fflate.min.js required.");const a=ds(new Uint8Array(e.getArrayBuffer(i))),o=new $s(a.buffer);switch(t){case"b":case"c":return o.getBooleanArray(s);case"d":return o.getFloat64Array(s);case"f":return o.getFloat32Array(s);case"i":return o.getInt32Array(s);case"l":return o.getInt64Array(s)}break;default:throw new Error("THREE.FBXLoader: Unknown property type "+t)}}}class $s{constructor(e,t){this.dv=new DataView(e),this.offset=0,this.littleEndian=void 0===t||t}getOffset(){return this.offset}size(){return this.dv.buffer.byteLength}skip(e){this.offset+=e}getBoolean(){return 1==(1&this.getUint8())}getBooleanArray(e){const t=[];for(let r=0;r<e;r++)t.push(this.getBoolean());return t}getUint8(){const e=this.dv.getUint8(this.offset);return this.offset+=1,e}getInt16(){const e=this.dv.getInt16(this.offset,this.littleEndian);return this.offset+=2,e}getInt32(){const e=this.dv.getInt32(this.offset,this.littleEndian);return this.offset+=4,e}getInt32Array(e){const t=[];for(let r=0;r<e;r++)t.push(this.getInt32());return t}getUint32(){const e=this.dv.getUint32(this.offset,this.littleEndian);return this.offset+=4,e}getInt64(){let e,t;return this.littleEndian?(e=this.getUint32(),t=this.getUint32()):(t=this.getUint32(),e=this.getUint32()),2147483648&t?(t=4294967295&~t,e=4294967295&~e,4294967295===e&&(t=t+1&4294967295),e=e+1&4294967295,-(4294967296*t+e)):4294967296*t+e}getInt64Array(e){const t=[];for(let r=0;r<e;r++)t.push(this.getInt64());return t}getUint64(){let e,t;return this.littleEndian?(e=this.getUint32(),t=this.getUint32()):(t=this.getUint32(),e=this.getUint32()),4294967296*t+e}getFloat32(){const e=this.dv.getFloat32(this.offset,this.littleEndian);return this.offset+=4,e}getFloat32Array(e){const t=[];for(let r=0;r<e;r++)t.push(this.getFloat32());return t}getFloat64(){const e=this.dv.getFloat64(this.offset,this.littleEndian);return this.offset+=8,e}getFloat64Array(e){const t=[];for(let r=0;r<e;r++)t.push(this.getFloat64());return t}getArrayBuffer(e){const t=this.dv.buffer.slice(this.offset,this.offset+e);return this.offset+=e,t}getString(e){let r=[];for(let t=0;t<e;t++)r[t]=this.getUint8();const s=r.indexOf(0);return s>=0&&(r=r.slice(0,s)),t.LoaderUtils.decodeText(new Uint8Array(r))}}class en{add(e,t){this[e]=t}}function tn(e){const t=e.match(/FBXVersion: (\d+)/);if(t){return parseInt(t[1])}throw new Error("THREE.FBXLoader: Cannot find the version number for the file given.")}function rn(e){return e/46186158e3}const sn=[];function nn(e,t,r,s){let n;switch(s.mappingType){case"ByPolygonVertex":n=e;break;case"ByPolygon":n=t;break;case"ByVertice":n=r;break;case"AllSame":n=s.indices[0];break;default:console.warn("THREE.FBXLoader: unknown attribute mapping type "+s.mappingType)}"IndexToDirect"===s.referenceType&&(n=s.indices[n]);const i=n*s.dataSize,a=i+s.dataSize;return function(e,t,r,s){for(let n=r,i=0;n<s;n++,i++)e[i]=t[n];return e}(sn,s.buffer,i,a)}const an=new t.Euler,on=new t.Vector3;function ln(e){const r=new t.Matrix4,s=new t.Matrix4,n=new t.Matrix4,i=new t.Matrix4,a=new t.Matrix4,o=new t.Matrix4,l=new t.Matrix4,c=new t.Matrix4,h=new t.Matrix4,u=new t.Matrix4,d=new t.Matrix4,p=new t.Matrix4,f=e.inheritType?e.inheritType:0;if(e.translation&&r.setPosition(on.fromArray(e.translation)),e.preRotation){const r=e.preRotation.map(t.MathUtils.degToRad);r.push(e.eulerOrder||t.Euler.DefaultOrder),s.makeRotationFromEuler(an.fromArray(r))}if(e.rotation){const r=e.rotation.map(t.MathUtils.degToRad);r.push(e.eulerOrder||t.Euler.DefaultOrder),n.makeRotationFromEuler(an.fromArray(r))}if(e.postRotation){const r=e.postRotation.map(t.MathUtils.degToRad);r.push(e.eulerOrder||t.Euler.DefaultOrder),i.makeRotationFromEuler(an.fromArray(r)),i.invert()}e.scale&&a.scale(on.fromArray(e.scale)),e.scalingOffset&&l.setPosition(on.fromArray(e.scalingOffset)),e.scalingPivot&&o.setPosition(on.fromArray(e.scalingPivot)),e.rotationOffset&&c.setPosition(on.fromArray(e.rotationOffset)),e.rotationPivot&&h.setPosition(on.fromArray(e.rotationPivot)),e.parentMatrixWorld&&(d.copy(e.parentMatrix),u.copy(e.parentMatrixWorld));const m=s.clone().multiply(n).multiply(i),g=new t.Matrix4;g.extractRotation(u);const y=new t.Matrix4;y.copyPosition(u);const v=y.clone().invert().multiply(u),w=g.clone().invert().multiply(v),x=a,b=new t.Matrix4;if(0===f)b.copy(g).multiply(m).multiply(w).multiply(x);else if(1===f)b.copy(g).multiply(w).multiply(m).multiply(x);else{const e=(new t.Matrix4).scale((new t.Vector3).setFromMatrixScale(d)).clone().invert(),r=w.clone().multiply(e);b.copy(g).multiply(m).multiply(r).multiply(x)}const A=h.clone().invert(),M=o.clone().invert();let T=r.clone().multiply(c).multiply(h).multiply(s).multiply(n).multiply(i).multiply(A).multiply(l).multiply(o).multiply(a).multiply(M);const S=(new t.Matrix4).copyPosition(T),R=u.clone().multiply(S);return p.copyPosition(R),T=p.clone().multiply(b),T.premultiply(u.invert()),T}function cn(e){const t=["ZYX","YZX","XZY","ZXY","YXZ","XYZ"];return 6===(e=e||0)?(console.warn("THREE.FBXLoader: unsupported Euler Order: Spherical XYZ. Animations and rotations may be incorrect."),t[0]):t[e]}function hn(e){return e.split(",").map((function(e){return parseFloat(e)}))}function un(e,r,s){return void 0===r&&(r=0),void 0===s&&(s=e.byteLength),t.LoaderUtils.decodeText(new Uint8Array(e,r,s))}function dn(e,t,r){return e.slice(0,t).concat(r).concat(e.slice(t))}class pn extends t.DataTextureLoader{constructor(e){super(e),this.type=t.HalfFloatType}parse(e){const r=function(e,t){switch(e){case 1:console.error("THREE.RGBELoader Read Error: "+(t||""));break;case 2:console.error("THREE.RGBELoader Write Error: "+(t||""));break;case 3:console.error("THREE.RGBELoader Bad File Format: "+(t||""));break;default:case 4:console.error("THREE.RGBELoader: Error: "+(t||""))}return-1},s=function(e,t,r){t=t||1024;let s=e.pos,n=-1,i=0,a="",o=String.fromCharCode.apply(null,new Uint16Array(e.subarray(s,s+128)));for(;0>(n=o.indexOf("\n"))&&i<t&&s<e.byteLength;)a+=o,i+=o.length,s+=128,o+=String.fromCharCode.apply(null,new Uint16Array(e.subarray(s,s+128)));return-1<n&&(!1!==r&&(e.pos+=i+n+1),a+o.slice(0,n))},n=function(e,t,r,s){const n=e[t+3],i=Math.pow(2,n-128)/255;r[s+0]=e[t+0]*i,r[s+1]=e[t+1]*i,r[s+2]=e[t+2]*i,r[s+3]=1},i=function(e,r,s,n){const i=e[r+3],a=Math.pow(2,i-128)/255;s[n+0]=t.DataUtils.toHalfFloat(Math.min(e[r+0]*a,65504)),s[n+1]=t.DataUtils.toHalfFloat(Math.min(e[r+1]*a,65504)),s[n+2]=t.DataUtils.toHalfFloat(Math.min(e[r+2]*a,65504)),s[n+3]=t.DataUtils.toHalfFloat(1)},a=new Uint8Array(e);a.pos=0;const o=function(e){const t=/^\s*GAMMA\s*=\s*(\d+(\.\d+)?)\s*$/,n=/^\s*EXPOSURE\s*=\s*(\d+(\.\d+)?)\s*$/,i=/^\s*FORMAT=(\S+)\s*$/,a=/^\s*\-Y\s+(\d+)\s+\+X\s+(\d+)\s*$/,o={valid:0,string:"",comments:"",programtype:"RGBE",format:"",gamma:1,exposure:1,width:0,height:0};let l,c;if(e.pos>=e.byteLength||!(l=s(e)))return r(1,"no header found");if(!(c=l.match(/^#\?(\S+)/)))return r(3,"bad initial token");for(o.valid|=1,o.programtype=c[1],o.string+=l+"\n";l=s(e),!1!==l;)if(o.string+=l+"\n","#"!==l.charAt(0)){if((c=l.match(t))&&(o.gamma=parseFloat(c[1])),(c=l.match(n))&&(o.exposure=parseFloat(c[1])),(c=l.match(i))&&(o.valid|=2,o.format=c[1]),(c=l.match(a))&&(o.valid|=4,o.height=parseInt(c[1],10),o.width=parseInt(c[2],10)),2&o.valid&&4&o.valid)break}else o.comments+=l+"\n";return 2&o.valid?4&o.valid?o:r(3,"missing image size specifier"):r(3,"missing format specifier")}(a);if(-1!==o){const e=o.width,s=o.height,l=function(e,t,s){const n=t;if(n<8||n>32767||2!==e[0]||2!==e[1]||128&e[2])return new Uint8Array(e);if(n!==(e[2]<<8|e[3]))return r(3,"wrong scanline width");const i=new Uint8Array(4*t*s);if(!i.length)return r(4,"unable to allocate buffer space");let a=0,o=0;const l=4*n,c=new Uint8Array(4),h=new Uint8Array(l);let u=s;for(;u>0&&o<e.byteLength;){if(o+4>e.byteLength)return r(1);if(c[0]=e[o++],c[1]=e[o++],c[2]=e[o++],c[3]=e[o++],2!=c[0]||2!=c[1]||(c[2]<<8|c[3])!=n)return r(3,"bad rgbe scanline format");let t,s=0;for(;s<l&&o<e.byteLength;){t=e[o++];const n=t>128;if(n&&(t-=128),0===t||s+t>l)return r(3,"bad scanline data");if(n){const r=e[o++];for(let e=0;e<t;e++)h[s++]=r}else h.set(e.subarray(o,o+t),s),s+=t,o+=t}const d=n;for(let e=0;e<d;e++){let t=0;i[a]=h[e+t],t+=n,i[a+1]=h[e+t],t+=n,i[a+2]=h[e+t],t+=n,i[a+3]=h[e+t],a+=4}u--}return i}(a.subarray(a.pos),e,s);if(-1!==l){let r,a,c;switch(this.type){case t.FloatType:c=l.length/4;const e=new Float32Array(4*c);for(let t=0;t<c;t++)n(l,4*t,e,4*t);r=e,a=t.FloatType;break;case t.HalfFloatType:c=l.length/4;const s=new Uint16Array(4*c);for(let e=0;e<c;e++)i(l,4*e,s,4*e);r=s,a=t.HalfFloatType;break;default:console.error("THREE.RGBELoader: unsupported type: ",this.type)}return{width:e,height:s,data:r,header:o.string,gamma:o.gamma,exposure:o.exposure,type:a}}}return null}setDataType(e){return this.type=e,this}load(e,r,s,n){return super.load(e,(function(e,s){switch(e.type){case t.FloatType:case t.HalfFloatType:e.encoding=t.LinearEncoding,e.minFilter=t.LinearFilter,e.magFilter=t.LinearFilter,e.generateMipmaps=!1,e.flipY=!0}r&&r(e,s)}),s,n)}}let fn=!0;const mn=new Map,gn={renderMode:{value:2},depthPacking:{value:1},time:{value:0},shadow:{value:.25},shadowLuma:{value:0},shadowContrast:{value:1},shadowGamma:{value:.25},lightSizeUV:{value:1.3},nearPlane:{value:9.5},rings:{value:11},nSample:{value:17},noiseIntensity:{value:1},softness:{value:3}};class yn{static setGl2(e){fn=e}static getGl2(e){return fn}static init(e={}){let r;t.ShaderChunk.tonemapping_pars_fragment=t.ShaderChunk.tonemapping_pars_fragment.replace("vec3 CustomToneMapping( vec3 color ) { return color; }","#define Uncharted2Helper( x ) max( ( ( x * ( 0.15 * x + 0.10 * 0.50 ) + 0.20 * 0.02 ) / ( x * ( 0.15 * x + 0.50 ) + 0.20 * 0.30 ) ) - 0.02 / 0.30, vec3( 0.0 ) )\n            float toneMappingWhitePoint = 1.0;\n            vec3 CustomToneMapping( vec3 color ) {\n                color *= toneMappingExposure;\n                return saturate( Uncharted2Helper( color ) / Uncharted2Helper( vec3( toneMappingWhitePoint ) ) );\n            }"),this.up(e),r=t.ShaderChunk.shadowmap_pars_fragment,r=r.replace("#ifdef USE_SHADOWMAP",vn),r=r.replace("shadow = texture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z );","\n                return PCSS( shadowMap, shadowCoord );\n            "),t.ShaderChunk.shadowmap_pars_fragment=r,r=t.ShaderChunk.common,r=r.replace("#define EPSILON 1e-6","\n        \t#define EPSILON 1e-6\n        \tuniform float shadow;\n            uniform float shadowLuma;\n            uniform float shadowContrast;\n            uniform float shadowGamma;\n\n            uniform int renderMode;\n            uniform int depthPacking;\n\n            varying vec2 vZW;\n\n            float shadowValue = 1.0;\n            float shadowTmp = 1.0;\n            vec3 shadowColor = vec3(1.0);\n\n            \n            /*\n            float color_distance( vec3 a, vec3 b){\n                vec3 s = vec3( a - b );\n                float dist = sqrt( s.r * s.r + s.g * s.g + s.b * s.b );\n                return clamp(dist, 0.0, 1.0);\n            }\n\n            vec3 rgb2hsv(vec3 c){\n                vec4 K = vec4(0.0, -1.0 / 3.0, 2.0 / 3.0, -1.0);\n                vec4 p = mix(vec4(c.bg, K.wz), vec4(c.gb, K.xy), step(c.b, c.g));\n                vec4 q = mix(vec4(p.xyw, c.r), vec4(c.r, p.yzx), step(p.x, c.r));\n\n                float d = q.x - min(q.w, q.y);\n                float e = 1.0e-10;\n                return vec3(abs(q.z + (q.w - q.y) / (6.0 * d + e)), d / (q.x + e), q.x);\n            }\n\n            vec3 hsv2rgb(vec3 c){\n                vec4 K = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);\n                vec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);\n                return c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);\n            }\n\n            vec3 brightnessContrastCorrection(vec3 value, float brightness, float contrast){\n                return (value - 0.5) * contrast + 0.5 + brightness;\n            }\n\n            vec3 GammaCorrection(vec3 value, float param){\n                return vec3(pow(abs(value.r), param),pow(abs(value.g), param),pow(abs(value.b), param));\n            }\n            */\n\n        "),t.ShaderChunk.common=r,r=t.ShaderChunk.fog_vertex,r=r.replace("#ifdef USE_FOG","\n            vZW = gl_Position.zw;\n            #ifdef USE_FOG\n        "),t.ShaderChunk.fog_vertex=r,r=t.ShaderChunk.lights_fragment_begin,r=r.replace("directLight.color *= ( directLight.visible && receiveShadow ) ? getPointShadow( pointShadowMap[ i ], pointLightShadow.shadowMapSize, pointLightShadow.shadowBias, pointLightShadow.shadowRadius, vPointShadowCoord[ i ], pointLightShadow.shadowCameraNear, pointLightShadow.shadowCameraFar ) : 1.0;","\n            shadowTmp = 1.0;\n            shadowTmp *= ( directLight.visible && receiveShadow ) ? getPointShadow( pointShadowMap[ i ], pointLightShadow.shadowMapSize, pointLightShadow.shadowBias, pointLightShadow.shadowRadius, vPointShadowCoord[ i ], pointLightShadow.shadowCameraNear, pointLightShadow.shadowCameraFar ) : 1.0;;\n            //directLight.color *= shadowTmp;\n            shadowValue *= shadowTmp;\n        "),r=r.replace("directLight.color *= ( directLight.visible && receiveShadow ) ? getShadow( spotShadowMap[ i ], spotLightShadow.shadowMapSize, spotLightShadow.shadowBias, spotLightShadow.shadowRadius, vSpotLightCoord[ i ] ) : 1.0;","\n            shadowTmp = 1.0;\n            shadowTmp *= ( directLight.visible && receiveShadow ) ? getShadow( spotShadowMap[ i ], spotLightShadow.shadowMapSize, spotLightShadow.shadowBias, spotLightShadow.shadowRadius, vSpotLightCoord[ i ] ) : 1.0;\n            //directLight.color *= shadowTmp;\n            shadowValue *= shadowTmp;\n        "),r=r.replace("directLight.color *= ( directLight.visible && receiveShadow ) ? getShadow( directionalShadowMap[ i ], directionalLightShadow.shadowMapSize, directionalLightShadow.shadowBias, directionalLightShadow.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;","\n            shadowTmp = 1.0;\n            shadowTmp *= ( directLight.visible && receiveShadow ) ? getShadow( directionalShadowMap[ i ], directionalLightShadow.shadowMapSize, directionalLightShadow.shadowBias, directionalLightShadow.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n            //directLight.color *= shadowTmp;\n            shadowValue *= shadowTmp;\n        "),t.ShaderChunk.lights_fragment_begin=r,r=t.ShaderChunk.output_fragment,r=r.replace("gl_FragColor = vec4( outgoingLight, diffuseColor.a );","\n\n            gl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\n        \t#if defined( USE_SHADOWMAP )\n\n            shadowValue = (shadowValue - 0.5) * shadowContrast + 0.5 + shadowLuma;\n            shadowValue = pow(abs(shadowValue), shadowGamma );\n            shadowValue = clamp( shadowValue, 0.0, 1.0 );\n\n            shadowColor = vec3( shadowValue );\n\n\n\n\n            \n            /*\n            vec3 invColor = vec3(1.0 - gl_FragColor.rgb);\n            vec3 cc = rgb2hsv( invColor );\n            cc.r += 0.1; // teint\n            cc.g *= 1.0; // saturation\n            cc.b *= 0.5; // luma\n            invColor = hsv2rgb( cc );\n\n            shadowColor = shadowColor + invColor;\n            shadowColor = clamp( shadowColor, 0.0, 1.0 );\n            */\n            \n\n\n            //gl_FragColor.rgb = mix( gl_FragColor.rgb, gl_FragColor.rgb * shadowColor, (1.0-shadowValue) * shadow );\n\n            gl_FragColor.rgb *= ((1.0-shadowValue) * (1.0-shadow)) + shadowColor;\n\n\n        \t#endif\n            \n        "),t.ShaderChunk.output_fragment=r,r=t.ShaderChunk.dithering_fragment,r=r.replace("#endif","\n\n            #endif\n\n            #ifdef STANDARD\n\n            if( renderMode == 1 ){ \n                float fz = 0.5 * vZW[0] / vZW[1] + 0.5;\n                gl_FragColor = depthPacking == 1 ? packDepthToRGBA( fz ) : vec4( vec3( 1.0 - fz ), opacity );// depth render\n            }\n            if( renderMode == 2 ) gl_FragColor = vec4(  packNormalToRGB( normal ), opacity );// normal render\n            if( renderMode == 3 ) gl_FragColor = vec4(  shadowColor, opacity );// normal render\n\n            #else\n\n            if( renderMode != 0 ) discard;\n\n            #endif\n\n        "),t.ShaderChunk.dithering_fragment=r,r=t.ShaderChunk.color_vertex,r=r.replace("vColor.xyz *= instanceColor.xyz;","vColor.xyz = instanceColor.xyz;"),t.ShaderChunk.color_vertex=r}static add(e){let r=e.name;mn.has(r)||(mn.set(r,!0),e.shadowSide=t.DoubleSide,e.isEncod||(e.map&&(e.map.encoding=t.sRGBEncoding),e.color.convertSRGBToLinear(),e.isEncod=!0),e.onBeforeCompile=function(e){yn.modify(e)})}static refresh(){}static setDefines(e){}static modify(e){for(let t in gn)e.uniforms[t]=gn[t]}static up(e){for(let t in e)gn[t]&&(gn[t].value.isColor?gn[t].value.setHex(e[t]):gn[t].value=e[t])}static reset(){mn.clear()}}const vn="\n#ifdef USE_SHADOWMAP\n\nuniform float lightSizeUV;\nuniform float nearPlane;\nuniform float rings;\nuniform int nSample;\nuniform float noiseIntensity;\nuniform float softness;\n\n//#define LIGHT_WORLD_SIZE 0.005\n//#define LIGHT_FRUSTUM_WIDTH 3.75\n//#define LIGHT_SIZE_UV (LIGHT_WORLD_SIZE / LIGHT_FRUSTUM_WIDTH)\n//#define NEAR_PLANE 9.5\n\n#define NUM_SAMPLES 17\n\nvec2 poissonDisk[32];\n\nvoid initPoissonSamples( const in vec2 randomSeed ) {\n\n    int numSample = nSample;\n\n    float ANGLE_STEP = PI2 * rings / float( numSample );\n    float INV_NUM_SAMPLES = 1.0 / float( numSample );\n\n    // jsfiddle that shows sample pattern: https://jsfiddle.net/a16ff1p7/\n    float angle = rand( randomSeed ) * PI2 * noiseIntensity;\n    float radius = INV_NUM_SAMPLES;\n    float radiusStep = radius;\n\n    for( int i = 0; i < numSample; i ++ ) {\n        poissonDisk[i] = vec2( cos( angle ), sin( angle ) ) * pow( radius, 0.75 );\n        radius += radiusStep;\n        angle += ANGLE_STEP;\n    }\n}\n\nfloat penumbraSize( const in float zReceiver, const in float zBlocker ) { // Parallel plane estimation\n    return (zReceiver - zBlocker) / zBlocker;\n}\n\nfloat findBlocker( sampler2D shadowMap, const in vec2 uv, const in float zReceiver, float ls ) {\n\n    // This uses similar triangles to compute what\n    // area of the shadow map we should search\n    float searchRadius = ls * ( zReceiver - nearPlane ) / zReceiver;\n    float blockerDepthSum = 0.0;\n    int numBlockers = 0;\n    int numSample = nSample;\n    float shadowMapDepth = 0.0;\n\n    for( int i = 0; i < numSample; i++ ) {\n        shadowMapDepth = unpackRGBAToDepth(texture2D(shadowMap, uv + poissonDisk[i] * searchRadius));\n        if ( shadowMapDepth < zReceiver ) {\n            blockerDepthSum += shadowMapDepth;\n            numBlockers ++;\n        }\n    }\n\n    if( numBlockers == 0 ) return -1.0;\n\n    return blockerDepthSum / float( numBlockers );\n\n}\n\nfloat PCF_Filter(sampler2D shadowMap, vec2 uv, float zReceiver, float filterRadius ) {\n    \n    /*int numSample = nSample;\n    float sum = 0.0;\n    float depth;\n    #pragma unroll_loop_start\n    for( int i = 0; i < 17; i ++ ) {\n        depth = unpackRGBAToDepth( texture2D( shadowMap, uv + poissonDisk[ i ] * filterRadius ) );\n        if( zReceiver <= depth ) sum += 1.0;\n    }\n    #pragma unroll_loop_end\n    #pragma unroll_loop_start\n    for( int i = 0; i < 17; i ++ ) {\n        depth = unpackRGBAToDepth( texture2D( shadowMap, uv + -poissonDisk[ i ].yx * filterRadius ) );\n        if( zReceiver <= depth ) sum += 1.0;\n    }\n    #pragma unroll_loop_end\n    return sum / ( 2.0 * float( 17 ) );*/\n\n    int numSample = nSample;\n    float sum = 0.0;\n    float top = 0.0;\n    float low = 0.0;\n    #pragma unroll_loop_start\n    for( int i = 0; i < 17; i ++ ) {\n        top = unpackRGBAToDepth( texture2D( shadowMap, uv + poissonDisk[ i ] * filterRadius ) );\n        low = unpackRGBAToDepth( texture2D( shadowMap, uv + -poissonDisk[ i ].yx * filterRadius ) );\n        if( zReceiver <= top ) sum += 1.0;\n        if( zReceiver <= low ) sum += 1.0;\n    }\n    #pragma unroll_loop_end\n    return sum / ( 2.0 * float( 17 ) );\n}\n\nfloat PCSS ( sampler2D shadowMap, vec4 coords ) {\n\n    vec2 uv = coords.xy;\n    float zReceiver = coords.z; // Assumed to be eye-space z in this code\n    //float lightSizeUV = LIGHT_WORLD_SIZE / LIGHT_FRUSTUM_WIDTH;\n\n    float ls = lightSizeUV * 0.001;\n\n    initPoissonSamples( uv );\n    // STEP 1: blocker search\n    float avgBlockerDepth = findBlocker( shadowMap, uv, zReceiver, ls );\n\n    //There are no occluders so early out (this saves filtering)\n    if( avgBlockerDepth == -1.0 ) return 1.0;\n\n    // STEP 2: penumbra size\n    float penumbraRatio = penumbraSize( zReceiver, avgBlockerDepth );\n    float filterRadius = penumbraRatio * ls * nearPlane / zReceiver;\n\n    // STEP 3: filtering\n    //return avgBlockerDepth;\n    return PCF_Filter( shadowMap, uv, zReceiver, filterRadius );\n}\n",wn={getMesh:e=>{let t={};return e.traverse((function(e){e.isMesh&&(t[e.name]=e)})),t},getGroup:(e,t,r)=>{const s={};let n=null;return e.traverse((function(i){i.isGroup&&(r&&(n=wn.getMaterial(e,!0)),s[i.name]=t?wn.groupToMesh(i,n):i)})),s},getMaterial:(e,t)=>{const r={},s=[];let n,i;return e.traverse((function(e){e.isMesh&&(n=e.material,r[n.name]||(yn.add(n),r[n.name]=n,i=Number(n.name.substring(0,n.name.lastIndexOf("_"))),s[i]=n))})),t?s:r},groupToMesh:(e,t)=>{if(e.children[0].name!==e.name+"_1")return e;if(!e.children[0].isMesh)return e;let r,s=[],n=e.children.length,i=0;for(let t=0;t<n;t++)r=e.children[t].material.name,i=Number(r.substring(0,r.lastIndexOf("_"))),e.children[t].material.dispose(),s[t]=e.children[t].geometry,s[t].forceMatId=i;let a=new THREE.Mesh(new Q(s,!0),t);return a.name=e.name,a},symetric:e=>{e.isMesh&&(e=e.geometry);let t=e.attributes.uv.array,r=.5*t.length;for(;r--;)t[2*r]<0&&(t[2*r]*=-1);e.attributes.uv.needsUpdate=!0},uv2:e=>{e.isMesh&&(e=e.geometry),e.setAttribute("uv2",e.attributes.uv)},autoMorph:(e,t)=>{let r,s,n,i,a,o,l=Pool.getMesh(e);for(let e in l)if(r=l[e],s=r.name,-1!==s.search("__morph__")&&(i=l[s.substring(0,s.indexOf("__"))],n=s.substring(s.lastIndexOf("__")+2),i))if(i.userData.morph||(i.userData.morph={},i.material.morphTargets=!0),o=i.geometry,o.attributes.position.count===r.geometry.attributes.position.count){if(o.morphAttributes.position||(o.morphAttributes.position=[]),a=o.morphAttributes.position.length,o.morphAttributes.position.push(r.geometry.attributes.position),t)for(let e in r.geometry.attributes)"position"!==e&&o.attributes[e]&&(o.morphAttributes[e]||(o.morphAttributes[e]=[]),o.morphAttributes[e][a]=r.geometry.attributes[e]);r.parent.remove(r),r.material.dispose(),r.geometry.dispose(),i.updateMorphTargets(),i.userData.morph[n]=a}else console.warn("this morph target is not good : ",n)}},xn={msg:"",inLoad:!1,clip:[],data:new Map,tmp:[],extraTexture:[],dracoLoader:null,dracoLoaderType:"js",dispose:()=>{let e=xn.extraTexture.length;for(;e--;)xn.get(xn.extraTexture[e],"T").dispose(),xn.delete(xn.extraTexture[e],"T");xn.extraTexture=[]},createElementNS:e=>document.createElementNS("http://www.w3.org/1999/xhtml",e),exist:(e,t="")=>!!xn.get(e,t),delete:(e,t="")=>xn.data.delete(xn.prefix(t)+e),get:(e,t="")=>xn.data.get(xn.prefix(t)+e),set:(e,t,r="")=>{t.isMaterial&&(r="material",t.name=e),t.isTexture&&(r="texture"),t.isObject3D&&(r="object3d"),xn.get(e,r)||xn.data.set(xn.prefix(r)+e,t)},getScript:e=>xn.data.get(xn.prefix("js")+e),getMaterials:(e,t)=>("string"==typeof e&&(e=xn.get(e,"O")),wn.getMaterial(e,t)),getMesh:e=>("string"==typeof e&&(e=xn.get(e,"O")),wn.getMesh(e)),getGroup:(e,t,r)=>("string"==typeof e&&(e=xn.get(e,"O")),wn.getGroup(e,t,r)),add:(e,t,r)=>{xn.set(e,t,r),xn.next()},getMaterial:e=>xn.data.get("M_"+e),directTexture:(e,r={})=>{xn.loaderMap||(xn.loaderMap=new t.TextureLoader);let s=e.substring(e.lastIndexOf("/")+1,e.lastIndexOf("."));return xn.exist(s,"texture")?xn.get(s,"texture"):xn.loaderMap.load(e,(function(e){return xn.setTextureOption(e,r),xn.data.set("T_"+s,e),xn.extraTexture.push(s),r.callback&&r.callback(),e}))},getTexture:(e,r={})=>{let s=xn.get(e,"texture");if(!s){let n=xn.data.get("I_"+e);if(!n)return null;s=new t.Texture(n),-1!==e.search("_c")&&(r.encoding=!0)}return xn.setTextureOption(s,r),s},setTextureOption:(e,r={})=>{r.encoding&&(e.encoding=t.sRGBEncoding),e.flipY=void 0!==(r.flipY||r.flip)&&r.flipY,void 0!==r.anisotropy&&(e.anisotropy=r.anisotropy),void 0!==r.generateMipmaps&&(e.generateMipmaps=r.generateMipmaps),r.repeat&&(e.repeat.fromArray(r.repeat),e.wrapS=e.wrapT=t.RepeatWrapping),r.filter&&"near"===r.filter&&(e.minFilter=t.NearestFilter,e.magFilter=t.NearestFilter),e.needsUpdate=!0},prefix:e=>{let t="";switch(e){case"S":case"sound":case"mp3":case"wav":case"ogg":t="S_";break;case"I":case"image":case"jpg":case"png":t="I_";break;case"E":case"hdr":case"env":t="T_";break;case"J":case"json":t="J_";break;case"JS":case"js":t="JS_";break;case"O":case"object3d":t="O_";break;case"M":case"material":t="M_";break;case"T":case"texture":t="T_"}return t},log:e=>{},load:(e,t,r="",s="")=>{xn.msg=s;let n=[],i=t||function(){},a=("undefined"==typeof performance?Date:performance).now();"string"==typeof e||e instanceof String?n.push(e):n=n.concat(e),xn.tmp.push({urls:n,path:r,callback:i,start:a}),xn.inLoad||xn.loadOne()},loadOne:()=>{xn.inLoad=!0;let e=xn.tmp[0].path+xn.tmp[0].urls[0],t=e.substring(e.lastIndexOf("/")+1,e.lastIndexOf(".")),r=e.substring(e.lastIndexOf(".")+1).toLowerCase();xn.exist(t,r)?xn.next():xn.loading(e,t,r)},next:()=>{xn.tmp[0].urls.shift(),0===xn.tmp[0].urls.length?(Math.floor(("undefined"==typeof performance?Date:performance).now()-xn.tmp[0].start),xn.tmp[0].callback(),xn.tmp.shift(),xn.tmp.length>0?xn.loadOne():xn.inLoad=!1):xn.loadOne()},loading:(e,t,r)=>{switch(r){case"glb":case"gltf":xn.load_GLTF(e,t);break;case"fbx":case"FBX":xn.load_FBX(e,t);break;case"hdr":xn.load_RGBE(e,t);break;default:xn.extand(e,t,r)}},extand:(e,t,r)=>{xn.XHTTP||(xn.XHTTP=new XMLHttpRequest);const s=xn.XHTTP;switch(s.open("GET",e,!0),"json"===r&&s.overrideMimeType("application/json"),r){case"hex":case"wasm":case"mp3":case"wav":case"ogg":case"jpg":case"png":s.responseType="arraybuffer";break;case"bvh":case"glsl":case"js":case"json":s.responseType="text"}s.onreadystatechange=function(){4===s.readyState&&(s.status>=300?console.log("Error, status code = "+s.status):xn.direct(s.response,t,r))},"onprogress"in s&&(s.onprogress=function(e){}),s.send(null)},direct:(e,t,r)=>{switch(r){case"jpg":case"png":let s=xn.createElementNS("img");s.src=window.URL.createObjectURL(new Blob([e])),xn.add(t,s,"image");break;case"mp3":case"wav":case"ogg":AudioContext.getContext().decodeAudioData(e.slice(0),(function(e){xn.add(t,e,"sound")}),(function(e){console.error("decodeAudioData error",e)}));break;case"hex":LzmaUnpack.parse(e,(function(e){xn.add(t,e,r)}));break;case"wasm":xn.add(t,new Uint8Array(e),r);break;case"json":xn.add(t,JSON.parse(e),r);break;case"js":xn.add(t,e,r);break;default:xn.add(t,e,r)}},loaderDRACO:()=>(xn.dracoLoader=(new Mt).setDecoderPath("./src/libs/draco/"),xn.dracoLoader.setDecoderConfig({type:xn.dracoLoaderType}),xn.dracoLoader),loaderGLTF:()=>(xn.GLTF||(xn.GLTF=new Ee),xn.GLTF),loaderFBX:()=>(xn.FBX||(xn.FBX=new qs),xn.FBX),loaderRGBE:()=>(xn.RGBE||(xn.RGBE=new pn),xn.RGBE),load_GLTF:(e,t)=>{xn.loaderGLTF().setDRACOLoader(xn.loaderDRACO()).load(e,(function(e){xn.add(t,e.scene),xn.dracoLoader.dispose()}))},load_FBX:(e,t)=>{xn.loaderFBX().load(e,(function(e){xn.add(t,e)}))},load_RGBE:(e,r)=>{xn.loaderRGBE().load(e,(function(e){e.mapping=t.EquirectangularReflectionMapping,xn.add(r,e)}))}};class bn extends t.Mesh{constructor(e={}){super(),this.ready=!1,this.type="terrain",this.name=e.name,this.mapN=0,this.mapMax=6,this.ttype=e.terrainType||"terrain",this.callback=e.callback||function(){},this.physicsUpdate=()=>{},this.uvx=[e.uv||18,e.uv||18],this.sample=null==e.sample?[128,128]:e.sample,this.size=void 0===e.size?[100,30,100]:e.size,this.data={level:e.level||[1,.2,.05],frequency:e.frequency||[.016,.05,.2],expo:e.expo||1},this.isWater=e.water||!1,this.isBorder=!1,this.wantBorder=e.border||!1,this.isBottom=!1,this.wantBottom=e.bottom||!1,this.wantBorder=e.border||!1,this.colorBase=this.isWater?{r:0,g:.7,b:1}:{r:.25,g:.25,b:.25},this.maxspeed=e.maxSpeed||.1,this.acc=null==e.acc?.01:e.acc,this.dec=null==e.dec?.01:e.dec,this.deep=null==e.deep?0:e.deep,this.ease=new t.Vector2,this.complexity=null==e.complexity?30:e.complexity,this.complexity2=null==e.complexity2?null:e.complexity2,this.local=new t.Vector3,e.local&&this.local.fromArray(e.local),this.pp=new t.Vector3,this.lng=this.sample[0]*this.sample[1];var r=this.sample[0]-1,s=this.sample[1]-1;this.rx=r/this.size[0],this.rz=s/this.size[2],this.ratio=1/this.sample[0],this.ruvx=1/(this.size[0]/this.uvx[0]),this.ruvy=-1/(this.size[2]/this.uvx[1]),this.is64=e.is64||!1,this.isTurn=e.turn||!1,this.heightData=new Float32Array(this.lng),this.height=[],this.isAbsolute=e.isAbsolute||!1,this.isReverse=e.isReverse||!1,this.isTurned=e.isTurned||!1,this.changeId=this.isReverse||this.isTurned,this.changeId&&this.getReverseID(),this.colors=new Float32Array(3*this.lng),this.geometry=new t.PlaneGeometry(this.size[0],this.size[2],this.sample[0]-1,this.sample[1]-1),this.geometry.rotateX(-Re.PI90),this.geometry.setAttribute("color",new t.BufferAttribute(this.colors,3)),this.vertices=this.geometry.attributes.position.array;var n=new t.Quaternion(.95,.8,.1,.05);e.maplevels&&n.fromArray(e.maplevels);var i,a=An,o=e.maps||["sand","grass","rock"],l={};this.isWater&&(o=["water"]);for(let t in o)i=o[t],l[i]=xn.directTexture("./assets/textures/terrain/"+i+".jpg",{flip:!1,repeat:this.uvx,encoding:e.encoding||!0,callback:this.mapcallback.bind(this)}),l[i+"_n"]=xn.directTexture("./assets/textures/terrain/"+i+"_n.jpg",{flip:!1,repeat:this.uvx,callback:this.mapcallback.bind(this)});this.txt=l,this.material=new t.MeshStandardMaterial({name:"terrain",vertexColors:!0,color:16777215,map:l[o[0]],normalMap:l[o[0]+"_n"]}),void 0!==e.envmap&&(this.material.envMap=e.envmap),this.isWater?(this.material.transparent=!0,this.material.opacity=e.opacity||.4,this.material.side=t.DoubleSide,this.material.alphaMap=l[o[0]],this.material.map=null,this.material.metalnes=.9,this.material.roughness=.1):(this.material.metalnes=.25,this.material.roughness=.7);var c=e.nScale||1;if(this.material.normalScale.set(c,c),this.isWater?this.material.onBeforeCompile=function(e){var t=e.fragmentShader;t=t.replace("#include <alphamap_fragment>",a.alphamap),e.fragmentShader=t}:this.material.onBeforeCompile=function(e){var t=e.uniforms;t.clevels={value:n},t.map1={value:l[o[1]]},t.map2={value:l[o[2]]},t.normalMap1={value:l[o[1]+"_n"]},t.normalMap2={value:l[o[2]+"_n"]},e.uniforms=t;var r=e.fragmentShader;r=(r=(r=(r=r.replace("uniform vec3 diffuse;",a.baseRemplace)).replace("#include <map_fragment>",a.map)).replace("#include <normal_fragment_maps>",a.normal)).replace("#include <color_fragment>",""),e.fragmentShader=r,yn.modify(e)},e.debuger){var h=new t.Mesh(this.geometry,new t.MeshBasicMaterial({vertexColors:VertexColors,wireframe:!0,transparent:!0,opacity:.25}));this.add(h)}this.wantBorder&&this.addBorder(e),this.wantBottom&&this.addBottom(e),e.pos&&this.position.fromArray(e.pos),e.quat=void 0===e.quat?[0,0,0,1]:e.quat,void 0!==e.rot&&(e.quat=Re.toQuatArray(e.rot),delete e.rot),this.quaternion.fromArray(e.quat),e.decal&&(this.position.y+=e.decal),this.castShadow=!0,this.receiveShadow=!0,this.update()}mapcallback(){this.mapN++,this.mapN==this.mapMax&&this.callback()}addBottom(e){var r=new t.PlaneGeometry(this.size[0],this.size[2],1,1);r.rotateX(Re.PI90),this.bottomMesh=new t.Mesh(r,this.borderMaterial),this.add(this.bottomMesh),this.isBottom=!0}addBorder(e){this.borderMaterial=new t.MeshStandardMaterial({vertexColors:VertexColors,metalness:this.isWater?.8:.4,roughness:this.isWater?.2:.6,normalScale:this.isWater?[.25,.25]:[-1,-1],transparent:!!this.isWater,opacity:this.isWater?e.opacity||.8:1,envMap:e.envmap||null});var r=new t.PlaneGeometry(this.size[0],2,this.sample[0]-1,1),s=new t.PlaneGeometry(this.size[0],2,this.sample[0]-1,1),n=new t.PlaneGeometry(this.size[2],2,this.sample[1]-1,1),i=new t.PlaneGeometry(this.size[2],2,this.sample[1]-1,1);r.translate(0,1,.5*this.size[2]),s.rotateY(-Re.Pi),s.translate(0,1,.5*-this.size[2]),n.rotateY(-Re.PI90),n.translate(.5*-this.size[0],1,0),i.rotateY(Re.PI90),i.translate(.5*this.size[0],1,0),this.borderGeometry=Z(Q([r,s,n,i])),this.borderVertices=this.borderGeometry.attributes.position.array,this.lng2=this.borderVertices.length/3,this.list=new Array(this.lng2),this.borderColors=new Float32Array(3*this.lng),this.borderGeometry.setAttribute("color",new t.BufferAttribute(this.borderColors,3)),this.borderMesh=new t.Mesh(this.borderGeometry,this.borderMaterial);for(var a,o,l=this.lng2;l--;)a=3*l,o=this.borderVertices[a+1]>0?this.findPoint(this.borderVertices[a],this.borderVertices[a+2]):-1,this.list[l]=o;this.add(this.borderMesh),this.borderMesh.castShadow=!0,this.borderMesh.receiveShadow=!0,this.isBorder=!0}dispose(){this.isBottom&&(this.remove(this.bottomMesh),this.bottomMesh.geometry.dispose()),this.isBorder&&(this.remove(this.borderMesh),this.borderMesh.geometry.dispose(),this.borderMesh.material.dispose()),this.geometry.dispose(),this.material.dispose();for(let e in this.txt)this.txt[e].dispose()}easing(e,t,r){if(0!==e[0]||0!==e[1]){var s=t||0;e[7]?this.maxspeed=1.5:this.maxspeed=.25,this.ease.y+=e[1]*this.acc,this.ease.x+=e[0]*this.acc,this.ease.x=this.ease.x>this.maxspeed?this.maxspeed:this.ease.x,this.ease.x=this.ease.x<-this.maxspeed?-this.maxspeed:this.ease.x,this.ease.y=this.ease.y>this.maxspeed?this.maxspeed:this.ease.y,this.ease.y=this.ease.y<-this.maxspeed?-this.maxspeed:this.ease.y,e[1]||(this.ease.y>this.dec?this.ease.y-=this.dec:this.ease.y<-this.dec?this.ease.y+=this.dec:this.ease.y=0),e[0]||(this.ease.x>this.dec?this.ease.x-=this.dec:this.ease.x<-this.dec?this.ease.x+=this.dec:this.ease.x=0),(this.ease.x||this.ease.y)&&(this.local.z+=Math.sin(s)*this.ease.x+Math.cos(s)*this.ease.y,this.local.x+=Math.cos(s)*this.ease.x-Math.sin(s)*this.ease.y,this.update(r))}}getTri(){return this.geometry}getHeight(e,t){return e*=this.rx,t*=this.rz,e+=.5*this.sample[0],t+=.5*this.sample[1],e=Math.floor(e),t=Math.floor(t),(this.isTurn?this.height[this.findId2(e,t)]:this.height[this.findId(e,t)])*this.size[1]+this.position.y}findId(e,t){return e+t*this.sample[1]}findId2(e,t){return t+-e*this.sample[0]||1}findId3(e,t){return t+e*this.sample[0]}findPoint(e,t){for(var r,s=this.lng;s--;)if(r=3*s,this.vertices[r]===e&&this.vertices[r+2]===t)return s;return-1}getReverseID(){this.invId=[];let e,t,r=this.lng;const s=this.sample[1]-1;for(this.sample[0];r--;)e=r%this.sample[0],t=Math.floor(r*this.ratio),this.isReverse&&(t=s-t),this.invId[r]=this.isTurned?this.lng-1-this.findId(t,e):this.findId(e,t)}update(e){this.isWater?(this.material.normalMap.offset.x+=.002,this.material.normalMap.offset.y+=.001):this.material.map&&(this.material.map.offset.x=this.local.x*this.ruvx,this.material.map.offset.y=this.local.z*this.ruvy);let t,r,s,n,i,a,o,l,c,h,u=this.pp,d=[1,1,1],p=this.lng;for(;p--;)t=3*p,r=p%this.sample[0],s=Math.floor(p*this.ratio),u.set(r+this.local.x*this.rx,this.local.y,s+this.local.z*this.rz),n=Re.noise(u,this.data),n=Math.pow(n,this.data.expo),n=n>1?1:n,n=n<0?0:n,"road"===this.ttype&&(o===s?n=1===r||2===r||29===r||30===r?l+.1:l:(o=s,l=n)),this.height[p]=n,i=this.changeId?this.invId[p]:p,a=this.isAbsolute?n:n*this.size[1],this.heightData[i]=a,c=n*this.size[1]+this.deep,this.vertices[t+1]=c,d=this.isWater?[n*this.colorBase.r,n*this.colorBase.g,n*this.colorBase.b]:[n,0,0],h=Re.clamp(d[0]+.25,.25,1),this.colors[t]=h,this.colors[t+1]=h,this.colors[t+2]=h;if(this.isBorder){let e,r=this.lng2;for(;r--;)t=3*r,-1!==this.list[r]?(e=this.height[this.list[r]],this.borderVertices[t+1]=e*this.size[1]+this.deep,h=Re.clamp(e+.25,.25,1),this.borderColors[t]=h,this.borderColors[t+1]=h,this.borderColors[t+2]=h):(this.borderColors[t]=this.colorBase.r,this.borderColors[t+1]=this.colorBase.g,this.borderColors[t+2]=this.colorBase.b)}this.updateGeometry(),this.ready&&this.physicsUpdate(this.heightData),this.ready=!0}updateGeometry(){this.geometry.attributes.position.needsUpdate=!0,this.geometry.attributes.color.needsUpdate=!0,this.geometry.computeVertexNormals(),this.isBorder&&(this.borderGeometry.attributes.position.needsUpdate=!0,this.borderGeometry.attributes.color.needsUpdate=!0)}}const An={baseRemplace:"\n        uniform vec3 diffuse; \n        uniform vec4 clevels;\n\n        uniform sampler2D normalMap1;\n        uniform sampler2D normalMap2;\n\n        uniform sampler2D roughnessMap1;\n        uniform sampler2D roughnessMap2;\n\n        uniform float aoMapIntensity;\n        uniform sampler2D map1;\n        uniform sampler2D map2;\n\n        vec4 MappingMix( float slope, vec4 level, vec4 rocks, vec4 grasss, vec4 sands ){\n            vec4 cc = rocks;\n            if (slope < level.y) cc = grasss;\n            if (slope < level.z) cc = sands;\n            if (( slope < level.x ) && (slope >= level.y)) cc = mix( grasss , rocks, (slope - level.y) * (1. / (level.x - level.y)));\n            if (( slope < level.y ) && (slope >= level.z)) cc = mix( sands , grasss, (slope - level.z) * (1. / (level.y - level.z)));\n            return cc;\n        }\n    ",rough:"\n        float roughnessFactor = roughness;\n        float metalnessFactor = metalness;\n        #ifdef USE_ROUGHNESSMAP\n\n            vec4 sandR = texture2D( roughnessMap, vUv );\n            vec4 grassR = texture2D( roughnessMap1, vUv );\n            vec4 rockR = texture2D( roughnessMap2, vUv );\n\n            vec4 baseColorR = MappingMix( vColor.r, clevels, rockR, grassR, sandR );\n            // reads channel G, compatible with a combined OcclusionRoughnessMetallic (RGB) texture\n            float ambientOcclusion =( baseColorR.r - 1.0 ) * aoMapIntensity + 1.0;\n            roughnessFactor *= baseColorR.g;\n            metalnessFactor *= baseColorR.b;\n        #endif\n    ",ao:"\n        reflectedLight.indirectDiffuse *= ambientOcclusion;\n        #if defined( USE_ENVMAP ) && defined( STANDARD )\n            float dotNV = saturate( dot( geometry.normal, geometry.viewDir ) );\n            reflectedLight.indirectSpecular *= computeSpecularOcclusion( dotNV, ambientOcclusion, material.specularRoughness );\n        #endif\n    ",map:"\n        #ifdef USE_MAP\n            vec4 sand = texture2D( map, vUv );\n            vec4 grass = texture2D( map1, vUv );\n            vec4 rock = texture2D( map2, vUv );\n\n            vec4 baseColor = MappingMix(vColor.r, clevels, rock, grass, sand);\n            diffuseColor *= baseColor;\n\n        #endif\n    ",normal:"\n        #ifdef USE_NORMALMAP\n            vec4 sandN =  texture2D( normalMap, vUv );\n            vec4 grassN = texture2D( normalMap1, vUv );\n            vec4 rockN = texture2D( normalMap2, vUv );\n\n            vec3 extraNormal = MappingMix(vColor.r, clevels, rockN, grassN, sandN).xyz * 2.0 - 1.0;\n            extraNormal.xy *= normalScale;\n            normal = perturbNormal2Arb( -vViewPosition, normal, extraNormal, faceDirection );\n        #endif\n    ",alphamap:"\n        #ifdef USE_ALPHAMAP\n            diffuseColor.a = opacity +( texture2D( alphaMap, vUv ).g * opacity) * (1.0-opacity);\n        #endif\n    "};class Mn extends P{constructor(){super(),this.Utils=i,this.type="terrain"}add(e={}){this.setName(e),"PHYSX"===n.engine&&(e.isAbsolute=!0,e.isTurned=!0);const t=new bn(e);return this.addToWorld(t,e.id),n.post({m:"add",o:Tn(t)}),t}set(e={},t=null){null===t&&(t=this.byName(e.name))}}const Tn=function(e){const t={name:e.name,type:e.type,pos:e.position.toArray(),quat:"PHYSX"===n.engine?[0,0,0,1]:e.quaternion.toArray()};return"PHYSX"===n.engine||"AMMO"===n.engine?(t.type="terrain",t.size=e.size,t.sample=e.sample,t.heightData=e.heightData):(t.type="mesh",t.v=A.getVertex(e.geometry,"OIMO"===n.engine),t.index="OIMO"===n.engine?null:A.getIndex(e.geometry)),t};class Sn extends P{constructor(){super(),this.Utils=i,this.type="solver"}step(e,t){let r,s,n,i,a=this.list.length,o=0;for(;a--;)if(s=this.list[a],r=t+a*L[this.type],s.needData)for(n of s.joints)i=r+7*o,n.data.target.x=e[i+0],n.data.target.y=e[i+1],n.data.target.z=e[i+2],n.data.target.twiwt=Math.round(e[i+3]),n.data.target.swing1=Math.round(e[i+4]),n.data.target.swing2=Math.round(e[i+5]),n.data.target.count=e[i+6],o++}add(e={}){this.setName(e);let t=new Rn(e);return this.addToWorld(t,e.id),n.post({m:"add",o:e}),t}set(e={}){}}class Rn extends t.Object3D{constructor(e){super(),this.name=e.name,this.type="solver",this.needData=e.needData||!1,this.chain=new THREE.Group,this.joints=[],this.jid=0,this.add(this.chain)}start(){n.post({m:"startArticulation",o:{name:this.name}})}commonInit(){n.post({m:"commonInitArticulation",o:{name:this.name}})}addJoint(e){this.jid=this.joints.length,e.name=e.name||this.name+"_Joint_"+this.jid,e.solver=this.name,this.joints.push(new kn(e,this)),n.post({m:"addSolverJoint",o:e})}addBone(e){this.chain.add(e)}release(){n.destroy(this.chain)}driveJoints(e){let t=!1;for(let r of this.joints)r.update(e),t=!!r.isDrive||t;this.resolve&&!t&&(this.resolve(),delete this.resolve)}setAngles(e,t){if(e){for(var r=this.joints.length;r--;)this.joints[r].pose(void 0!==e[r]?e[r]:0,void 0!==t?t:5);return new Promise((e=>this.resolve=e))}}}class kn{constructor(e,t){this.name=e.name,this.solver=t,this.type="solverJoint",this.isDrive=!1,this.data={target:{x:0,y:0,z:0,twist:0,swing1:0,swing2:0,count:0}},e.limits&&(this.min=e.limits[0][1],this.max=e.limits[0][2],this.driveType=e.limits[0][0]),this.current=0,this.tmp=0,this.target=0,this.start=0,this.time=0}start(){}pose(e,t){this.target=A.clamp(e,this.min,this.max),this.current=A.clamp(this.data.target[this.driveType],this.min,this.max),this.target!==this.current&&(this.start=this.current,this.tmp=0,this.time=t,this.isDrive=!0)}update(e){if(this.isDrive){this.tmp+=e;let t=this.tmp/this.time;t=t>1?1:t;let r=A.lerp(this.start,this.target,t);n.update({name:this.name,drivesTarget:[[this.driveType,r]]}),1===t&&(this.isDrive=!1)}}}class En{constructor(e){this.values=[],this.ready=0,this.key=e}update(){var e,t,r,s,n,i,a=this.fix,o=navigator.getGamepads();for(e=0;e<o.length;e++)if(i=o[e])if(r=i.axes.length,s=i.buttons.length){for(this.values[e]||(this.values[e]=[]),t=0;t<r;t++)n=a(i.axes[t],.08),0==this.ready&&0!==n&&(this.ready=1),this.values[e][t]=n;for(t=0;t<s;t++)n=a(i.buttons[t].value),0==this.ready&&0!==n&&(this.ready=1),this.values[e][r+t]=n}else this.values[e]&&(this.values[e]=null)}getValue(e){for(var t,r=19;r--;)t=this.values[e][r],0==this.ready&&0!==t&&(this.ready=1),this.key[r]=t}reset(){this.ready=0}fix(e,t){let r=Number(e.toString().substring(0,5));return t&&r<t&&r>-t&&(r=0),r}}let In,Ln,Pn=null,Cn={},_n=60,Fn=null,Bn=!1,Dn=!1,On=!1,Nn=!1,zn=null,Un=null,Gn=!0,Vn=null,Hn=null,jn=0,Wn=0;const Xn=new class{constructor(){this.key=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.key2=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.gamepad=new En(this.key),this.useGamepad=!1,this.sameAxis=!1,document.addEventListener("keydown",function(e){this.keyDown(e)}.bind(this),!1),document.addEventListener("keyup",function(e){this.keyUp(e)}.bind(this),!1)}update(){return this.gamepad.update(),this.gamepad.ready&&(this.useGamepad||(this.useGamepad=!0),this.gamepad.getValue(0)),this.sameAxis&&(this.key[2]=this.key[0],this.key[3]=this.key[1]),this.key}keyDown(e){var t=this.key,r=this.key2;if(e=e||window.event,this.sameAxis)switch(e.which){case 65:case 81:case 37:t[0]=-1,r[0]=1;break;case 68:case 39:t[0]=1,r[1]=1;break;case 87:case 90:case 38:t[1]=-1;break;case 83:case 40:t[1]=1;break;case 32:t[4]=1;break;case 17:case 67:case 69:t[5]=1;break;case 16:t[7]=1}else switch(e.which){case 65:case 81:t[0]=-1,r[0]=1;break;case 68:t[0]=1,r[1]=1;break;case 87:case 90:t[1]=-1;break;case 83:t[1]=1;break;case 37:t[2]=-1,r[0]=1;break;case 39:t[2]=1,r[1]=1;break;case 38:t[3]=-1;break;case 40:t[3]=1;break;case 32:t[4]=1;break;case 17:case 67:case 69:t[5]=1;break;case 16:t[7]=1}this.gamepad.reset()}keyUp(e){var t=this.key,r=this.key2;if(e=e||window.event,this.sameAxis)switch(e.which){case 65:case 81:case 37:t[0]=t[0]<0?0:t[0],r[0]=0;break;case 68:case 39:t[0]=t[0]>0?0:t[0],r[1]=0;break;case 87:case 90:case 38:t[1]=t[1]<0?0:t[1];break;case 83:case 40:t[1]=t[1]>0?0:t[1];break;case 32:t[4]=0;break;case 17:case 67:case 69:t[5]=0;break;case 16:t[7]=0}else switch(e.which){case 65:case 81:t[0]=t[0]<0?0:t[0],r[0]=0;break;case 68:t[0]=t[0]>0?0:t[0],r[1]=0;break;case 87:case 90:t[1]=t[1]<0?0:t[1];break;case 83:t[1]=t[1]>0?0:t[1];break;case 37:t[2]=t[2]<0?0:t[2],r[0]=0;break;case 39:t[2]=t[2]>0?0:t[2],r[1]=0;break;case 38:t[3]=t[3]<0?0:t[3];break;case 40:t[3]=t[3]>0?0:t[3];break;case 32:t[4]=0;break;case 17:case 67:case 69:t[5]=0;break;case 16:t[7]=0}}},qn=new class{constructor(e=-1){this.time={now:0,delta:0,then:0,interval:0,tmp:0,n:0,dt:0},this.fps=0,this.delta=0,this.elapsedTime=0,this.unlimited=!0,this.setFramerate(e)}up(e=0){let t=this.time;return t.now=void 0!==e?e:Date.now(),t.delta=t.now-t.then,!!(t.delta>t.interval||this.unlimited)&&(t.then=this.unlimited?t.now:t.now-t.delta%t.interval,this.delta=.001*t.delta,this.elapsedTime+=this.delta,t.now-1e3>t.tmp&&(t.tmp=t.now,this.fps=t.n,t.n=0),t.n++,!0)}setFramerate(e){this.elapsedTime=0,this.framerate=e,this.unlimited=this.framerate<0,this.time.interval=1e3/e}}(60);let Kn=function(){return 0},Qn=function(){},Yn=function(){},Zn=function(){};class Jn{static setMaxFps(e){_n=e}static setExtraTexture(e){Zn=e}static setExtraMaterial(e){n.extraMaterial=e}static setPostUpdate(e){Yn=null!==e?e:function(){}}static setAzimut(e){Kn=e}static getKey(){return Xn.key}static getKey2(){return Xn.key2}static getAzimut(){return Kn()}static math(){return A}static setContent(e){e.add(n.scene),e.add(n.scenePlus)}static setControl(e){Un=e,Kn=Un.getAzimuthalAngle}static message(e){let t=e.data;t.Ar&&(Ln=t.Ar),t.reflow&&(n.reflow=t.reflow,n.reflow.stat.delta&&(Wn+=n.reflow.stat.delta)),Jn[t.m](t.o)}static post(e,t){Bn?"add"===e.m?"solver"===e.o.type||void 0!==e.o.solver?Fn.postMessage(e):n.flow.add.push(e.o):"remove"===e.m?n.flow.remove.push(e.o):Fn.postMessage(e,t):zn({data:e})}static makeView(){}static getScene(){return n.scene}static getHideMat(){return y("hide")}static init(e={}){let r=e.type||"PHYSX",s=r.toLowerCase(),i=s.charAt(0).toUpperCase()+s.slice(1),a="",o=navigator.userAgent.toLowerCase().indexOf("firefox")>-1;if(n.engine=r,Jn.initItems(),In.body.extraConvex="Physx"===i,In.solid.extraConvex="Physx"===i,e.callback&&(Pn=e.callback,delete e.callback),n.scene=new t.Group,n.scene.name="phy_scene",n.scenePlus=new t.Group,n.scenePlus.name="phy_scenePlus",n.post=Jn.post,n.up=Jn.up,n.update=Jn.update,n.add=Jn.add,n.remove=Jn.remove,e.direct)zn=e.direct,e.message=Jn.message,console.log(r+" is direct");else{switch(r){case"OIMO":if(o)Fn=new Worker("./build/"+i+".min.js");else try{Fn=new Worker("./build/"+i+".module.js",{type:"module"}),a="ES6"}catch(e){Fn=new Worker("./build/"+i+".js")}break;default:"RAPIER"===r&&(s="rapier3d",i="rapier3d"),e.link&&(e.blob=document.location.href.replace(/\/[^/]*$/,"/")+e.link),Fn=new Worker("./build/"+i+".min.js")}Fn.postMessage=Fn.webkitPostMessage||Fn.postMessage,Fn.onmessage=Jn.message;let t=new ArrayBuffer(1);Fn.postMessage({m:"test",ab:t},[t]),Dn=!t.byteLength,e.isBuffer=Dn,console.log(a+" Worker "+r+(e.isBuffer?" with Shared Buffer":"")),Bn=!0}n.post({m:"init",o:e})}static getPause(){return Nn}static pause(e){e!==Nn&&(Nn=e,Nn?Jn.pausetimout():Jn.playtimout(),n.post({m:"pause",o:{value:Nn}}))}static flowReset(){n.flow={tmp:[],key:[],add:[],remove:[]}}static reset(e){if(Gn)return Gn=!1,void e();Jn.cleartimout(),Un&&Un.resetAll(),Qn=e,Yn=function(){},Jn.flowReset(),Jn.clearInstance(),Jn.resetItems(),d(),v(),n.disposeTmp(),n.tmpTex=[],n.scenePlus.children=[],n.scene.children=[],n.post({m:"reset"})}static resetCallback(){Qn()}static ready(){console.log("Motor is ready !!"),Pn&&Pn()}static start(e={}){n.post({m:"start",o:e})}static setTimeout(e){On=e}static getTimeout(e){return On}static set(e={}){void 0===e.full&&(e.full=!1),In.body.setFull(e.full),Jn.initArray(e.full),e.ArPos=Cn,Wn=0,e.outsideStep=true,e.isTimeout=On,e.gravity||(e.gravity=[0,-9.81,0]),e.substep||(e.substep=2),e.fps?e.fps<0&&(e.fps=_n):e.fps=60,qn.setFramerate(e.fps),n.post({m:"set",o:e})}static getFps(){return n.reflow.stat.fps}static getDelta2(){return n.reflow.stat.delta}static getElapsedTime2(){return Wn}static getDelta(){return qn.delta}static getElapsedTime(){return qn.elapsedTime}static doStep(e){qn.up(e)&&n.post({m:"step",o:e})}static step(e){Jn.stepItems(),n.flow.key=Xn.update(),Yn(n.reflow.stat.delta),Jn.changes(n.flow.tmp),Dn?n.post({m:"poststep",flow:n.flow,Ar:Ln},[Ln.buffer]):n.post({m:"poststep",flow:n.flow,Ar:Ln}),Jn.flowReset()}static up(e){e instanceof Array?Jn.changes(e,!0):Jn.change(e,!0)}static update(e){e instanceof Array?n.flow.tmp.push(...e):n.flow.tmp.push(e)}static initArray(e=!1){Cn=function(e,t=!1){let r={},s={body:M*(t?L.bodyFull:L.body),joint:T*L.joint,ray:R*L.ray,contact:S*L.contact,character:k*L.character};"PHYSX"!==e&&"AMMO"!==e||(s.vehicle=E*L.vehicle),"PHYSX"===e&&(s.solver=I*L.solver);let n=0;for(let e in s)r[e]=n,n+=s[e];return r.total=n,r}(n.engine,e)}static upInstance(){for(let e in n.instanceMesh)n.instanceMesh[e].update()}static clearInstance(){for(let e in n.instanceMesh)n.instanceMesh[e].dispose();n.instanceMesh={}}static addDirect(e){n.scene.add(e),n.tmpMesh.push(e)}static texture(e={}){return Zn(e)}static material(e={}){let r;return r=e.isMaterial?e:new t.MeshPhysicalMaterial(e),m[r.name]?null:(g(r),r)}static byName(e){return i.byName(e)}static getAllBody(e){return In.body.list}static explosion(e=[0,0,0],r=10,s=100){let n,i,a=[],o=(new t.Vector3).fromArray(e),l=new t.Vector3,c=In.body.list.length;for(;c--;)n=In.body.list[c],l.copy(n.position).sub(o),i=1-l.length()/r,i<0||(l.setLength(i),l.multiplyScalar(s),a.push({name:n.name,linearImpulse:l.toArray()}));Jn.update(a)}static getBodyRef(){return In.body}static initItems(){In={ray:new C,body:new ye,solid:new $n,joint:new ve,contact:new xe,terrain:new Mn,character:new Te},"PHYSX"!==n.engine&&"AMMO"!==n.engine||(In.vehicle=new Ae),"PHYSX"===n.engine&&(In.solver=new Sn)}static resetItems(){for(const e in In)In[e].reset()}static stepItems(){for(const e in In)In[e].step(Ln,Cn[e]);Jn.upInstance(),Un&&Un.follow&&Un.follow(Jn.getDelta())}static adds(e=[]){for(let t in e)Jn.add(e[t])}static add(e={}){if(e.constructor===Array)return Jn.adds(e);void 0!==e.mass&&(e.density=e.mass),void 0!==e.bounce&&(e.restitution=e.bounce),void 0===e.type&&(e.type="box");let t=function(e){switch(e.type){case"plane":case"box":case"sphere":case"highSphere":case"cylinder":case"cone":case"capsule":case"mesh":case"convex":case"compound":case"null":return e.density||e.kinematic?"body":"solid";default:return e.type}}(e);return In[t].add(e)}static removes(e=[]){for(let t in e)Jn.remove(e[t])}static remove(e){if(e.constructor===Array)return Jn.removes(o);let t=Jn.byName(e);null!==t&&(In[t.type].clear(t),n.post({m:"remove",o:{name:e,type:t.type}}))}static changes(e=[],t=!1){for(let r in e)Jn.change(e[r],t)}static change(e={},t=!1){let r=Jn.byName(e.name);if(null===r)return null;let s=r.type;switch(e.drivePosition&&void 0!==e.drivePosition.rot&&(e.drivePosition.quat=A.toQuatArray(e.drivePosition.rot),delete e.drivePosition.rot),void 0!==e.rot&&(e.quat=A.toQuatArray(e.rot),delete e.rot),void 0!==e.localRot&&(e.quat=A.toLocalQuatArray(e.localRot,r),delete e.localRot),s){case"solid":r=In.solid.set(e,r);break;case"ray":r=In.ray.set(e,r),t=!1}t&&n.post({m:"change",o:e})}static setCamera(e={}){Un.moveCam(e)}static follow(e="",t={}){let r=null;"string"==typeof e||e instanceof String?r=""===e?null:Jn.byName(e):(e.isMesh||e.isGroup)&&(r=e),null===r?Un.resetFollow():Un.startFollow(r,t)}static setTimeout(e,t){Hn=e,jn=t,Vn=setTimeout(Hn,jn)}static playtimout(){null!==Hn&&(Vn=setTimeout(Hn,jn))}static pausetimout(){null!==Vn&&clearTimeout(Vn)}static cleartimout(e,t){null!==Vn&&(Hn=null,jn=0,clearTimeout(Vn),Vn=null)}}class $n extends ye{constructor(){super(),this.type="solid"}step(e,t){}}const ei=Jn;e.phy=ei,Object.defineProperty(e,"__esModule",{value:!0})}));
