!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("three")):"function"==typeof define&&define.amd?define(["exports","three"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).Phy={},e.three)}(this,(function(e,t){"use strict";var s=function(e){var t,s=Object.prototype,r=s.hasOwnProperty,i="function"==typeof Symbol?Symbol:{},n=i.iterator||"@@iterator",a=i.asyncIterator||"@@asyncIterator",o=i.toStringTag||"@@toStringTag";function l(e,t,s){return Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{l({},"")}catch(e){l=function(e,t,s){return e[t]=s}}function h(e,t,s,r){var i=t&&t.prototype instanceof g?t:g,n=Object.create(i.prototype),a=new E(r||[]);return n._invoke=function(e,t,s){var r=u;return function(i,n){if(r===d)throw new Error("Generator is already running");if(r===m){if("throw"===i)throw n;return I()}for(s.method=i,s.arg=n;;){var a=s.delegate;if(a){var o=S(a,s);if(o){if(o===f)continue;return o}}if("next"===s.method)s.sent=s._sent=s.arg;else if("throw"===s.method){if(r===u)throw r=m,s.arg;s.dispatchException(s.arg)}else"return"===s.method&&s.abrupt("return",s.arg);r=d;var l=c(e,t,s);if("normal"===l.type){if(r=s.done?m:p,l.arg===f)continue;return{value:l.arg,done:s.done}}"throw"===l.type&&(r=m,s.method="throw",s.arg=l.arg)}}}(e,s,a),n}function c(e,t,s){try{return{type:"normal",arg:e.call(t,s)}}catch(e){return{type:"throw",arg:e}}}e.wrap=h;var u="suspendedStart",p="suspendedYield",d="executing",m="completed",f={};function g(){}function y(){}function b(){}var x={};x[n]=function(){return this};var v=Object.getPrototypeOf,w=v&&v(v(P([])));w&&w!==s&&r.call(w,n)&&(x=w);var M=b.prototype=g.prototype=Object.create(x);function A(e){["next","throw","return"].forEach((function(t){l(e,t,(function(e){return this._invoke(t,e)}))}))}function T(e,t){function s(i,n,a,o){var l=c(e[i],e,n);if("throw"!==l.type){var h=l.arg,u=h.value;return u&&"object"==typeof u&&r.call(u,"__await")?t.resolve(u.__await).then((function(e){s("next",e,a,o)}),(function(e){s("throw",e,a,o)})):t.resolve(u).then((function(e){h.value=e,a(h)}),(function(e){return s("throw",e,a,o)}))}o(l.arg)}var i;this._invoke=function(e,r){function n(){return new t((function(t,i){s(e,r,t,i)}))}return i=i?i.then(n,n):n()}}function S(e,s){var r=e.iterator[s.method];if(r===t){if(s.delegate=null,"throw"===s.method){if(e.iterator.return&&(s.method="return",s.arg=t,S(e,s),"throw"===s.method))return f;s.method="throw",s.arg=new TypeError("The iterator does not provide a 'throw' method")}return f}var i=c(r,e.iterator,s.arg);if("throw"===i.type)return s.method="throw",s.arg=i.arg,s.delegate=null,f;var n=i.arg;return n?n.done?(s[e.resultName]=n.value,s.next=e.nextLoc,"return"!==s.method&&(s.method="next",s.arg=t),s.delegate=null,f):n:(s.method="throw",s.arg=new TypeError("iterator result is not an object"),s.delegate=null,f)}function k(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function R(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function E(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(k,this),this.reset(!0)}function P(e){if(e){var s=e[n];if(s)return s.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var i=-1,a=function s(){for(;++i<e.length;)if(r.call(e,i))return s.value=e[i],s.done=!1,s;return s.value=t,s.done=!0,s};return a.next=a}}return{next:I}}function I(){return{value:t,done:!0}}return y.prototype=M.constructor=b,b.constructor=y,y.displayName=l(b,o,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===y||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,b):(e.__proto__=b,l(e,o,"GeneratorFunction")),e.prototype=Object.create(M),e},e.awrap=function(e){return{__await:e}},A(T.prototype),T.prototype[a]=function(){return this},e.AsyncIterator=T,e.async=function(t,s,r,i,n){void 0===n&&(n=Promise);var a=new T(h(t,s,r,i),n);return e.isGeneratorFunction(s)?a:a.next().then((function(e){return e.done?e.value:a.next()}))},A(M),l(M,o,"Generator"),M[n]=function(){return this},M.toString=function(){return"[object Generator]"},e.keys=function(e){var t=[];for(var s in e)t.push(s);return t.reverse(),function s(){for(;t.length;){var r=t.pop();if(r in e)return s.value=r,s.done=!1,s}return s.done=!0,s}},e.values=P,E.prototype={constructor:E,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach(R),!e)for(var s in this)"t"===s.charAt(0)&&r.call(this,s)&&!isNaN(+s.slice(1))&&(this[s]=t)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var s=this;function i(r,i){return o.type="throw",o.arg=e,s.next=r,i&&(s.method="next",s.arg=t),!!i}for(var n=this.tryEntries.length-1;n>=0;--n){var a=this.tryEntries[n],o=a.completion;if("root"===a.tryLoc)return i("end");if(a.tryLoc<=this.prev){var l=r.call(a,"catchLoc"),h=r.call(a,"finallyLoc");if(l&&h){if(this.prev<a.catchLoc)return i(a.catchLoc,!0);if(this.prev<a.finallyLoc)return i(a.finallyLoc)}else if(l){if(this.prev<a.catchLoc)return i(a.catchLoc,!0)}else{if(!h)throw new Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return i(a.finallyLoc)}}}},abrupt:function(e,t){for(var s=this.tryEntries.length-1;s>=0;--s){var i=this.tryEntries[s];if(i.tryLoc<=this.prev&&r.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var n=i;break}}n&&("break"===e||"continue"===e)&&n.tryLoc<=t&&t<=n.finallyLoc&&(n=null);var a=n?n.completion:{};return a.type=e,a.arg=t,n?(this.method="next",this.next=n.finallyLoc,f):this.complete(a)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),f},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var s=this.tryEntries[t];if(s.finallyLoc===e)return this.complete(s.completion,s.afterLoc),R(s),f}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var s=this.tryEntries[t];if(s.tryLoc===e){var r=s.completion;if("throw"===r.type){var i=r.arg;R(s)}return i}}throw new Error("illegal catch attempt")},delegateYield:function(e,s,r){return this.delegate={iterator:P(e),resultName:s,nextLoc:r},"next"===this.method&&(this.arg=t),f}},e}("object"==typeof module?module.exports:{});try{regeneratorRuntime=s}catch(e){Function("r","regeneratorRuntime = r")(s)}const r=Math.PI,i=r/180,n=180/r,a=Number.EPSILON,o=.5*r,l={todeg:n,torad:i,toFixed:(e,t=3)=>1*e.toFixed(t),clamp:(e,t,s)=>e=(e=e<t?t:e)>s?s:e,clampA:(e,t,s)=>Math.max(t,Math.min(s,e)),lerp:(e,t,s)=>(1-s)*e+s*t,damp:(e,t,s,r)=>l.lerp(e,t,1-Math.exp(-s*r)),nearAngle:(e,t,s=!1)=>t+Math.atan2(Math.sin(e-t),Math.cos(e-t))*(s?n:1),unwrapDeg:e=>e-360*Math.floor((e+180)/360),unwrapRad:e=>Math.atan2(Math.sin(e),Math.cos(e)),nearEquals:(e,t,s)=>Math.abs(e-t)<=s,autoSize:(e=[1,1,1],t="box")=>{1===e.length&&(e[1]=e[0]);let s=e[0],r=e[1];return"sphere"===t&&(e=[s,s,s]),"cylinder"!==t&&"wheel"!==t&&"capsule"!==t||(e=[s,r,s]),"cone"!==t&&"pyramid"!==t||(e=[s,r,s]),2===e.length&&(e[2]=e[0]),e},randomSign:()=>Math.random()<.5?-1:1,randSpread:e=>e*(.5-Math.random()),rand:(e=0,t=1)=>e+Math.random()*(t-e),randInt:(e,t)=>e+Math.floor(Math.random()*(t-e+1)),equalArray:(e,t)=>{let s=e.length;for(;s--;)if(e[s]!==t[s])return!1;return!0},composeMatrixArray:(e,t,s=[1,1,1])=>{const r=t[0],i=t[1],n=t[2],a=t[3],o=r+r,l=i+i,h=n+n,c=r*o,u=r*l,p=r*h,d=i*l,m=i*h,f=n*h,g=a*o,y=a*l,b=a*h,x=s[0],v=s[1],w=s[2];return[(1-(d+f))*x,(u+b)*x,(p-y)*x,0,(u-b)*v,(1-(c+f))*v,(m+g)*v,0,(p+y)*w,(m-g)*w,(1-(c+d))*w,0,e[0],e[1],e[2],1]},decomposeMatrixArray:e=>[e[12],e[13],e[14]],applyTransformArray:(e,t,s,r=[1,1,1])=>{const i=l.composeMatrixArray(t,s,r),n=e[0],a=e[1],o=e[2],h=1/(i[3]*n+i[7]*a+i[11]*o+i[15]);return[(i[0]*n+i[4]*a+i[8]*o+i[12])*h,(i[1]*n+i[5]*a+i[9]*o+i[13])*h,(i[2]*n+i[6]*a+i[10]*o+i[14])*h]},equalArray:(e,t)=>{let s=e.length;for(;s--;)if(e[s]!==t[s])return!1;return!0},lerpArray:(e,t,s)=>{if(0===s)return e;if(1===s)return t;let r=e.length,i=[];for(;r--;)i[r]=e[r],i[r]+=(t[r]-i[r])*s;return i},slerpQuatArray:(e,t,s)=>{if(0===s)return e;if(1===s)return t;let r=[...e];const i=e[0],n=e[1],o=e[2],h=e[3],c=t[0],u=t[1],p=t[2],d=t[3];let m=h*d+i*c+n*u+o*p;if(m<0?(r=[-c,-u,-p,-d],m=-m):r=[...t],m>=1)return e;const f=1-m*m;if(f<=a){const e=1-s;return r[3]=e*h+s*r[3],r[0]=e*i+s*r[0],r[1]=e*n+s*r[1],r[2]=e*o+s*r[2],l.quatNomalize(r)}const g=Math.sqrt(f),y=Math.atan2(g,m),b=Math.sin((1-s)*y)/g,x=Math.sin(s*y)/g;return r[3]=h*b+r[3]*x,r[0]=i*b+r[0]*x,r[1]=n*b+r[1]*x,r[2]=o*b+r[2]*x,r},toLocalQuatArray:(e=[0,0,0],t)=>{let s=l.quatFromEuler(e),r=l.quatInvert(t.quaternion.toArray());return l.quatMultiply(r,s)},quatFromEuler:(e=[0,0,0],t=!0)=>{const s=Math.cos,r=Math.sin,n=t?i:1,a=e[0]*n*.5,o=e[1]*n*.5,l=e[2]*n*.5,h=s(a),c=s(o),u=s(l),p=r(a),d=r(o),m=r(l);return[p*c*u+h*d*m,h*d*u-p*c*m,h*c*m+p*d*u,h*c*u-p*d*m]},quatFromAxis:(e=[0,0,0],t,s=!0)=>{const r=.5*t*(s?i:1),n=Math.sin(r);return[e[0]*n,e[1]*n,e[2]*n,Math.cos(r)]},quatNomalize:e=>{let t=l.lengthArray(e);return 0===t?[0,0,0,1]:(t=1/t,l.scaleArray(e,t,4))},quatInvert:e=>[-e[0],-e[1],-e[2],e[3]],quatMultiply:(e,t)=>{const s=e[0],r=e[1],i=e[2],n=e[3],a=t[0],o=t[1],l=t[2],h=t[3];return[s*h+n*a+r*l-i*o,r*h+n*o+i*a-s*l,i*h+n*l+s*o-r*a,n*h-s*a-r*o-i*l]},quatToAxis:e=>{let t=2*Math.acos(e[3]);const s=Math.sqrt(1-e[3]*e[3]);return s<1e-4?[1,0,0]:[e[0]/s,e[1]/s,e[2]/s,t]},eulerFromMatrix:e=>{const t=e[0],s=e[4],r=e[8];e[1];const i=e[5],n=e[9];e[2];const a=e[6],o=e[10];let h=[0,0,0];return h[1]=Math.asin(l.clamp(r,-1,1)),Math.abs(r)<.9999999?(h[0]=Math.atan2(-n,o),h[2]=Math.atan2(-s,t)):(h[0]=Math.atan2(a,i),h[2]=0),h},angleTo:(e,t)=>2*Math.acos(Math.abs(l.clamp(l.dotArray(e,t),-1,1))),lengthArray:e=>{let t=e.length,s=0;for(;t--;)s+=e[t]*e[t];return Math.sqrt(s)},dotArray:(e,t)=>{let s=e.length,r=0;for(;s--;)r+=e[s]*t[s];return r},addArray:(e,t,s)=>{s=s??e.length;let r=[];for(;s--;)r[s]=e[s]+t[s];return r},subArray:(e,t,s)=>{s=s??e.length;let r=[];for(;s--;)r[s]=e[s]-t[s];return r},mulArray:(e,t,s)=>{for(s=s??e.length;s--;)e[s]*=t;return e},divArray:(e,t,s)=>l.scaleArray(e,1/t,s),scaleArray:(e,t,s)=>{for(s=s??e.length;s--;)e[s]*=t;return e},fillArray(e,t,s,r){for(s=s||0,r=r??e.length;r--;)t[s+r]=e[r]},copyArray:(e,t)=>{},distanceArray:(e,t=[0,0,0])=>l.lengthArray(l.subArray(e,t)),getVolume:(e,t,s=null)=>{let r=1,i=t;switch(e){case"sphere":r=4*Math.PI*i[0]*i[0]*i[0]/3;break;case"cone":r=Math.PI*i[0]*(.5*i[1])*2;break;case"box":r=.5*i[0]*8*(.5*i[1])*(.5*i[2]);break;case"cylinder":r=Math.PI*i[0]*i[0]*(.5*i[1])*2;break;case"capsule":r=4*Math.PI*i[0]*i[0]*i[0]/3+Math.PI*i[0]*i[0]*(.5*i[1])*2;break;case"convex":case"mesh":r=l.getConvexVolume(s)}return r},getConvexVolume:e=>{let t,s=e.length/3,r=[0,0,0],i=[0,0,0];for(;s--;)t=3*s,e[t]<r[0]?r[0]=e[t]:e[t]>i[0]&&(i[0]=e[t]),e[t+1]<r[1]?r[1]=e[t+1]:e[t+1]>i[1]&&(i[1]=e[t+1]),e[t+2]<r[2]?r[2]=e[t+2]:e[t+2]>i[2]&&(i[2]=e[t+2]);let n=[i[0]-r[0],i[1]-r[1],i[2]-r[2]];return.5*n[0]*8*(.5*n[1])*(.5*n[2])},massFromDensity:(e,t)=>e*t,densityFromMass:(e,t)=>e/t,getIndex:e=>e.index&&e.index.array||null,getVertex:(e,t)=>{let s=e.attributes.position.array;if(t){s=e.clone().toNonIndexed().attributes.position.array}return s}},h=2e3,c=500,u=50,p=100,d=50,m=50,f=20,g={bodyFull:14,body:8,joint:16,contact:8,ray:11,character:16,vehicle:72,solver:128},y=new Map,b={AR:null,viewSize:null,engine:"OIMO",motor:null,scene:null,scenePlus:null,threeScene:null,post:null,jointVisible:!1,delta:0,add:null,remove:null,items:null,tmpMesh:[],instanceMesh:{},tmpTex:[],mouseDown:!1,flow:{stamp:0,current:"",key:[],tmp:[],add:[],remove:[]},reflow:{ray:[],stat:{fps:0},point:{}},extraMaterial:()=>{},disposeTmp:()=>{let e,t,s;for(e in b.tmpMesh){if(s=b.tmpMesh[e],s.children)for(t in s.children)b.disposeMesh(s.children[t]);b.disposeMesh(s),s.parent&&s.parent.remove(s)}for(e in b.tmpMesh=[],b.tmpTex)b.tmpTex[e].dispose()},disposeMesh:e=>{e.geometry&&e.geometry.dispose(),e.dispose&&e.dispose()}},x={byName:e=>y.has(e)?y.get(e):null,add:(e,t)=>{if("contact"!==e.type&&!e.isInstance&&e.isObject3D)if(t)t.add(e);else if(e.isButton)b.scene.add(e);else switch(e.type){case"terrain":case"solid":case"joint":case"ray":case"articulation":b.scenePlus.add(e);break;default:b.scene.add(e)}y.set(e.name,e)},remove:e=>{e.dispose&&e.dispose(),e.parent&&e.parent.remove(e),e.instance&&e.instance.remove(e.id),y.delete(e.name)},noRay:e=>{e.isObject3D&&(e.raycast=()=>{},e.traverse((e=>{e.isObject3D&&(e.raycast=()=>{})})))},morph:(e,t,s)=>{e.morphTargetInfluences&&void 0!==e.morphTargetDictionary[t]&&(e.morphTargetInfluences[e.morphTargetDictionary[t]]=s)},toLocal:(e,t,s=!1)=>{s||e.sub(t.position);let r=t.quaternion;return e.applyQuaternion({x:-r._x,y:-r._y,z:-r._z,w:r._w}),e},quatLocal:(e,s)=>{s.isObject3D&&s.updateWorldMatrix(!0,!1);let r=(new t.Quaternion).fromArray(e),i=s.quaternion.clone().invert();return r.premultiply(i),r.normalize().toArray()},axisLocal:(e,s)=>{s.isObject3D&&s.updateWorldMatrix(!0,!1);let r=(new t.Matrix3).setFromMatrix4(s.matrixWorld);return(new t.Vector3).fromArray(e).applyMatrix3(r).toArray()},quatToAngular:(e,s)=>{s[0]*=-1,s[1]*=-1,s[2]*=-1;let r,i=s[0]*e[3]+s[3]*e[0]+s[1]*e[2]-s[2]*e[1],n=s[1]*e[3]+s[3]*e[1]+s[2]*e[0]-s[0]*e[2],a=s[2]*e[3]+s[3]*e[2]+s[0]*e[1]-s[1]*e[0],o=s[3]*e[3]-s[0]*e[0]-s[1]*e[1]-s[2]*e[2],l=2*Math.acos(o),h=Math.sqrt(1-o*o);r=h<.001?[0,0,0]:[i/h,n/h,a/h];(new t.Vector3).fromArray(r).multiplyScalar(l/1)},refAxis:(e,s)=>{let r=(new t.Vector3).fromArray(s),i=new t.Vector3(1,0,0),n=new t.Vector3(0,1,0);Math.abs(s[1])>.9999||i.copy(r).cross(n).normalize(),n.copy(i).cross(r).normalize(),e.makeBasis(i,n,r)}};class v extends t.LineSegments{constructor(e,s=16776960){const r=new Uint16Array([0,1,1,2,2,3,3,4,4,5,5,0,6,7,7,8,8,9,9,10,10,11,11,6,12,13,13,14,14,15,15,16,16,17,17,12,18,19,20,21,22,23]),i=[.5,0,0,.25,.433,0,-.25,.433,0,-.5,0,0,-.25,-.433,0,.25,-.433,0,.5,0,0,.25,0,.433,-.25,0,.433,-.5,0,0,-.25,0,-.433,.25,0,-.433,0,.5,0,0,.25,.433,0,-.25,.433,0,-.5,0,0,-.25,-.433,0,.25,-.433,0,0,0,.6,0,0,0,0,0,0,.6,0,0,0,0,0,0,.6],n=new t.BufferGeometry;n.setIndex(new t.BufferAttribute(r,1)),n.setAttribute("position",new t.Float32BufferAttribute(i,3)),n.setAttribute("color",new t.Float32BufferAttribute([0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0,1,0,0,1,0,0,0,1,0,0,1],3)),super(n,new t.LineBasicMaterial({color:s,depthTest:!1,depthWrite:!1,toneMapped:!1,transparent:!0})),this.box=e,this.type="CircleHelper",this.geometry.computeBoundingSphere()}updateMatrixWorld(e){const t=this.box;t.isEmpty()||(t.getCenter(this.position),t.getSize(this.scale),this.scale.multiplyScalar(.5),super.updateMatrixWorld(e))}dispose(){this.geometry.dispose(),this.material.dispose()}}let w=0,M={};const A=e=>{M["geo"+w++]=e},T=e=>{M[e.name]=e},S=(e,s={})=>{if(!M[e]){let s;switch(e){case"plane":s=new t.PlaneGeometry(1,1),s.rotateX(.5*-Math.PI);break;case"box":s=new t.BoxGeometry(1,1,1);break;case"sphere":s=new t.SphereGeometry(1,16,12);break;case"cylinder":s=new t.CylinderGeometry(1,1,1,16);break;case"cone":s=new t.CylinderGeometry(.001,1,1,16);break;case"particle":s=new t.SphereGeometry(1,3,2);break;case"joint":s=(new v).geometry;break;default:return null}M[e]=s}return M[e]},k=()=>{for(let e in M)M[e].dispose();M={},w=0};class R{constructor(e,s="rgb(69,69,69)",r="rgb(39,39,39)"){const i=document.createElement("canvas");i.width=i.height=128;const n=i.getContext("2d");if(n.fillStyle=s,n.fillRect(0,0,128,128),e){let t,i,a,o,l=[[0,0],[32,32],[64,64],[96,96],[96,-32]],h=[[0,64],[32,96],[64,128],[96,160],[-32,32]],c=e?"rgb(128,128,255)":s,u=e?"rgb(160,100,255)":r,p=e?"rgba(100,160,255, 0.5)":"rgba(0,0,0, 0.1)";for(n.strokeStyle=p,n.lineWidth=1,t=0;t<5;t++){o=n.createLinearGradient(0,h[t][0],0,h[t][1]),o.addColorStop(0,u),o.addColorStop(1,c),n.beginPath(),n.fillStyle=o,n.rect(l[t][0],l[t][1],32,64),n.fill();for(let e=0;e<8;e++)a=2*(Math.random()-.5),n.beginPath(),n.moveTo(l[t][0]+a+2+4*e,l[t][1]),n.lineTo(l[t][0]+a+2+4*e,l[t][1]+64),n.stroke()}for(l=[[32,0],[64,32],[96,64],[-32,64],[0,96]],h=[[32,96],[64,128],[96,160],[-32,32],[0,64]],t=0;t<5;t++)for(o=n.createLinearGradient(h[t][0],0,h[t][1],0),o.addColorStop(0,c),o.addColorStop(1,u),n.beginPath(),n.fillStyle=o,n.rect(l[t][0],l[t][1],64,32),n.fill(),i=0;i<8;i++)a=2*(Math.random()-.5),n.beginPath(),n.moveTo(l[t][0],l[t][1]+a+2+4*i),n.lineTo(l[t][0]+64,l[t][1]+a+2+4*i),n.stroke()}else n.beginPath(),n.fillStyle=r,n.rect(0,0,32,64),n.rect(32,32,32,64),n.rect(64,64,32,64),n.rect(96,96,32,64),n.rect(96,-32,32,64),n.fill();const a=new t.CanvasTexture(i);return a.wrapS=a.wrapT=t.RepeatWrapping,a.repeat.x=a.repeat.y=60,e||(a.colorSpace=t.SRGBColorSpace),a}}const E={};let P=[];const I={metalness:.6,roughness:.3},_={body:new t.Color(15724500),sleep:new t.Color(12566445),solid:new t.Color(7105128),base:new t.Color(16777215),black:new t.Color(2236962),gold:new t.Color(.944,.776,.373),gold2:new t.Color(.998,.981,.751),copper:new t.Color(.96467984,.37626296,.25818297),carPaint:new t.Color(.1037792,.59212029,.85064936)},L={extendShader:()=>{},addToTmp:e=>{P.push(e)},create:e=>{let s,r=null;if(e.isMaterial)s=e;else{let i=void 0!==e.type?e.type:"Standard";switch(e.type&&delete e.type,r=e.beforeCompile||null,e.beforeCompile&&delete e.beforeCompile,(e.thickness||e.sheen||e.clearcoat||e.transmission||e.specularColor)&&(i="Physical"),e.normalScale&&(e.normalScale.isVector2||(e.normalScale=(new t.Vector2).fromArray(e.normalScale))),i=i.toLowerCase(),i){case"physical":s=new t.MeshPhysicalMaterial(e),s.defines={STANDARD:"",PHYSICAL:"",USE_UV:"",USE_SPECULAR:""};break;case"phong":s=new t.MeshPhongMaterial(e);break;case"lambert":s=new t.MeshLambertMaterial(e);break;case"basic":s=new t.MeshBasicMaterial(e);break;case"line":s=new t.LineBasicMaterial(e);break;case"toon":s=new t.MeshToonMaterial(e);break;default:s=new t.MeshStandardMaterial(e)}}return E[s.name]?null:(L.set(s,!1,r),s)},set:(e,t,s)=>{t||L.extendShader(e,s),E[e.name]=e},setEnvmapIntensity:e=>{let t;for(let s in E)t=E[s],t.userData.envp||(t.userData.envp=t.envMapIntensity),t.envMapIntensity=t.userData.envp*e},getList:()=>E,get:e=>{if(!E[e])switch(e){case"body":L.create({name:"body",color:_.body,...I});break;case"sleep":L.create({name:"sleep",color:_.sleep,...I});break;case"solid":L.create({name:"solid",color:_.solid,metalness:.1,roughness:.8});break;case"base":L.create({name:"base",color:_.base,...I});break;case"black":L.create({name:"black",color:_.black,metalness:0,roughness:.25});break;case"chrome":L.create({name:"chrome",color:13421772,metalness:1,roughness:.075});break;case"gold":L.create({name:"gold",color:_.gold,specularColor:_.gold2,metalness:1,roughness:.02});break;case"copper":L.create({name:"copper",color:_.copper,metalness:1,roughness:.25,clearcoat:1,clearcoatRoughness:.2});break;case"carPaint":L.create({name:"carPaint",color:_.carPaint,metalness:0,anisotropy:new t.Vector2(.5,.5),roughness:.4,clearcoat:1,clearcoatRoughness:0});break;case"carbon":L.create({name:"carbon",map:new R,normalMap:new R(!0),clearcoat:1,clearcoatRoughness:.1,roughness:.5});break;case"cloth":L.create({name:"cloth",color:8391119,roughness:.5,sheenColor:13335807,sheen:1,sheenRoughness:.2});break;case"skinny":L.create({name:"skinny",color:14724201,...I});break;case"glass":L.create({name:"glass",color:16777215,transparent:!0,opacity:.8,depthTest:!0,depthWrite:!0,roughness:.02,metalness:0,alphaToCoverage:!0,premultipliedAlpha:!0,transmission:1,clearcoat:1,thickness:.02});break;case"glassX":L.create({name:"glassX",color:16777215,transparent:!1,opacity:1,roughness:.1,metalness:0,side:t.DoubleSide,transmission:1,clearcoat:1,thickness:.1,ior:1.5,envMapIntensity:2.2,shadowSide:1,reflectivity:.5,iridescence:.5});break;case"plexi":L.create({name:"plexi",color:16777215,transparent:!0,opacity:.4,metalness:1,roughness:0,clearcoat:1,side:t.DoubleSide});break;case"glass2":L.create({name:"glass2",color:13421823,transparent:!0,opacity:.3});break;case"sat":L.create({name:"sat",color:16777215,metalness:1,roughness:0,clearcoat:1});break;case"car":L.create({name:"car",color:3158064,metalness:1,roughness:.5,clearcoat:1,clearcoatRoughness:.03,sheen:.5});break;case"carGlass":L.create({name:"carGlass",color:16777215,metalness:0,roughness:0,transmission:1,ior:1.52});break;case"debug":L.create({name:"debug",type:"Basic",color:15953986,wireframe:!0,toneMapped:!1,transparent:!0,opacity:.25});break;case"bones":L.create({name:"bones",color:13412915,wireframe:!0});break;case"bones2":L.create({name:"bones2",color:7829503});break;case"button":L.create({name:"button",color:16728139,...I});break;case"line":L.create({name:"line",type:"line",vertexColors:!0,toneMapped:!1});break;case"hide":L.create({name:"hide",type:"basic",visible:!1});break;case"particle":L.create({name:"particle",type:"basic",toneMapped:!1,color:65280})}return E[e]},dispose:()=>{for(let e in E)E[e].dispose(),delete E[e];let e=P.length;for(;e--;)P[e].dispose();P=[]}};class C{constructor(e){this.values=[],this.ready=0,this.key=e}update(){var e,t,s,r,i,n,a=this.fix,o=navigator.getGamepads();for(e=0;e<o.length;e++)if(n=o[e])if(s=n.axes.length,r=n.buttons.length){for(this.values[e]||(this.values[e]=[]),t=0;t<s;t++)i=a(n.axes[t],.08),0==this.ready&&0!==i&&(this.ready=1),this.values[e][t]=i;for(t=0;t<r;t++)i=a(n.buttons[t].value),0==this.ready&&0!==i&&(this.ready=1),this.values[e][s+t]=i}else this.values[e]&&(this.values[e]=null)}getValue(e){for(var t,s=19;s--;)t=this.values[e][s],0==this.ready&&0!==t&&(this.ready=1),this.key[s]=t}reset(){this.ready=0}fix(e,t){let s=Number(e.toString().substring(0,5));return t&&s<t&&s>-t&&(s=0),s}}class F{constructor(){this.id=0,this.list=[],this.type="item",this.Utils=null}reset(){let e=this.list.length;for(;e--;)this.dispose(this.list[e]);this.id=0,this.list=[]}byName(e){return this.Utils.byName(e)}setName(e={}){let t=void 0!==e.name?e.name:this.type+this.id++;return e.id=this.remove(t,!0),e.name=t,t}addToWorld(e,t=-1){this.Utils.add(e),-1!==t?this.list[t]=e:this.list.push(e)}remove(e,t){let s=this.byName(e);return s?this.clear(s,t):-1}clear(e,t){let s=this.list.indexOf(e);return-1===s||t?this.list[s]=null:this.list.splice(s,1),this.dispose(e),s}dispose(e){null!==e&&this.Utils.remove(e)}vecZero(e,t,s){for(;s--;)e[t+s]=0}fillArray(e,t,s,r){for(s=s||0,r=r??e.length;r--;)t[s+r]=e[r]}arLength(e){let t=Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]);return t<.001&&(t=0),t}multiplyScalar(e,t,s){for(s=s??e.length;s--;)e[s]*=t}divideScalar(e,t,s){this.multiplyScalar(e,1/t,s)}add(e={}){}set(e={}){}step(e,t){}}class B extends F{constructor(){super(),this.Utils=x,this.type="ray"}step(e,t){let s,r,i=this.list.length;for(;i--;)s=this.list[i],r=t+i*g.ray,s.update(e,r,b.reflow.ray[i]||null)}add(e={}){this.setName(e);let t=new O(e);return t.visible=void 0===e.visible||e.visible,this.addToWorld(t,e.id),e.parent&&"string"!=typeof e.parent&&(e.parent=e.parent.name),e.callback&&delete e.callback,b.post({m:"add",o:e}),t}set(e={},t=null){null===t&&(t=this.byName(e.name)),null!==t&&t.setRay(e)}}class O extends t.Line{constructor(e={}){super(new t.BufferGeometry,L.get("line")),this.data={hit:!1,body:"",point:[0,0,0],normal:[0,0,0],distance:0,angle:0},this.type="ray",this.name=e.name,this.parentMesh=null,e.parent&&(this.parentMesh="string"==typeof e.parent?x.byName(e.parent):e.parent),this.callback=e.callback||function(){},this.c0=[.1,.1,.3],this.c1=[.1,.4,.6],this.c2=[1,.1,.1],this.c3=[.1,1,.1],this.begin=new t.Vector3,this.end=new t.Vector3(0,1,0),this.fullDistance=0,this.setRay(e),this.tmp=new t.Vector3,this.normal=new t.Vector3,this.vv1=new t.Vector3,this.vv2=new t.Vector3;this.geometry.setAttribute("position",new t.Float32BufferAttribute([0,0,0,0,0,0,0,0,0],3)),this.geometry.setAttribute("color",new t.Float32BufferAttribute([0,0,0,0,0,0,0,0,0],3)),this.vertices=this.geometry.attributes.position,this.colors=this.geometry.attributes.color,this.local=[0,0,0,0,0,0,0,0,0],this.matrixAutoUpdate=!1,this.frustumCulled=!1}setRay(e){e.begin&&this.begin.fromArray(e.begin),e.end&&this.end.fromArray(e.end),this.fullDistance=this.begin.distanceTo(this.end)}update(e,t=0,s=null){if(this.data.hit=0!==e[t],this.data.body=s||"",this.data.distance=e[t+1],this.data.hit)this.local[0]=e[t+2],this.local[1]=e[t+3],this.local[2]=e[t+4],this.tmp.fromArray(e,t+5),this.normal.fromArray(e,t+8),this.data.point=this.tmp.toArray(),this.data.normal=this.normal.toArray(),this.tmp.toArray(this.local,3),this.vv1.fromArray(this.local).sub(this.tmp).normalize(),this.tmp.addScaledVector(this.normal,this.fullDistance-this.data.distance),this.tmp.toArray(this.local,6),this.data.angle=Math.floor(l.angleTo(this.vv1.toArray(),this.data.normal)*n);else if(this.parentMesh){const e=this.parentMesh.matrixWorld;this.tmp.copy(this.begin).applyMatrix4(e).toArray(this.local,0),this.tmp.copy(this.end).applyMatrix4(e),this.tmp.toArray(this.local,3),this.tmp.toArray(this.local,6)}else this.begin.toArray(this.local,0),this.end.toArray(this.local,3),this.end.toArray(this.local,6);this.updateGeometry(),this.callback(this.data)}dispose(){this.geometry.dispose()}raycast(){}updateGeometry(){if(!this.visible)return;let e=this.vertices.array,t=this.colors.array,s=this.local,r=this.data.hit,i=r?this.c2:this.c1,n=r?this.c3:this.c1;t[3]=i[0],t[4]=i[1],t[5]=i[2],t[6]=n[0],t[7]=n[1],t[8]=n[2],e[0]=s[0],e[1]=s[1],e[2]=s[2],e[3]=s[3],e[4]=s[4],e[5]=s[5],e[6]=s[6],e[7]=s[7],e[8]=s[8],this.vertices.needsUpdate=!0,this.colors.needsUpdate=!0}}O.prototype.isRay=!0;let z=0;const D=new t.Vector3,N=new t.Quaternion,U=new t.Matrix4,V=new t.Vector3,j=new t.Vector3,G=new t.Vector3,H=new t.Quaternion,W=new t.Vector3(1,0,0),q=new t.Vector3(0,1,0),X=new t.Vector3(0,0,1),K={type:"added"},Q={type:"removed"};class Z extends t.EventDispatcher{constructor(){super(),this.isObject3D=!0,Object.defineProperty(this,"id",{value:z++}),this.uuid=t.MathUtils.generateUUID(),this.isRay=!0,this.matrix=new t.Matrix4,this.matrixWorld=new t.Matrix4,this.name="",this.type="Object3D",this.children=[],this.parent=null,this.position=new t.Vector3,this.quaternion=new t.Quaternion,this.scale=new t.Vector3(1,1,1),this.isKinematic=!1,this.matrixAutoUpdate=!1,this.matrixWorldNeedsUpdate=!1,this.layers=new t.Layers,this.visible=!0,this.isVisible=!0,this.frustumCulled=!0,this.renderOrder=0,this.userData={},this.shapetype="box",this.size=[1,1,1],this.velocity=new t.Vector3,this.angular=new t.Vector3,this.defMat=!1,this.actif=!1,this.auto=!1,this.sleep=!1,this.mesh=null,this.linked=[]}select(e){}dispose(){this.traverse((function(e){e.isMesh&&e.unic&&e.geometry.dispose()})),this.children=[]}set receiveShadow(e){this.traverse((function(t){t.isMesh&&(t.receiveShadow=e)}))}get receiveShadow(){return!!this.children[0]&&this.children[0].receiveShadow}set castShadow(e){this.traverse((function(t){t.isMesh&&(t.castShadow=e)}))}get castShadow(){return!!this.children[0]&&this.children[0].castShadow}set material(e){this.traverse((function(t){t.isMesh&&(t.material=e)}))}get material(){return this.children,this.children[0]?this.children[0].material:null}onBeforeRender(){}onAfterRender(){}applyMatrix4(e){this.matrixAutoUpdate&&this.updateMatrix(),this.matrix.premultiply(e),this.matrix.decompose(this.position,this.quaternion,this.scale)}applyQuaternion(e){return this.quaternion.premultiply(e),this}setRotationFromAxisAngle(e,t){this.quaternion.setFromAxisAngle(e,t)}setRotationFromEuler(e){this.quaternion.setFromEuler(e,!0)}setRotationFromMatrix(e){this.quaternion.setFromRotationMatrix(e)}setRotationFromQuaternion(e){this.quaternion.copy(e)}rotateOnAxis(e,t){return N.setFromAxisAngle(e,t),this.quaternion.multiply(N),this}rotateOnWorldAxis(e,t){return N.setFromAxisAngle(e,t),this.quaternion.premultiply(N),this}rotateX(e){return this.rotateOnAxis(W,e)}rotateY(e){return this.rotateOnAxis(q,e)}rotateZ(e){return this.rotateOnAxis(X,e)}translateOnAxis(e,t){return D.copy(e).applyQuaternion(this.quaternion),this.position.add(D.multiplyScalar(t)),this}translateX(e){return this.translateOnAxis(W,e)}translateY(e){return this.translateOnAxis(q,e)}translateZ(e){return this.translateOnAxis(X,e)}localToWorld(e){return e.applyMatrix4(this.matrixWorld)}worldToLocal(e){return e.applyMatrix4(U.copy(this.matrixWorld).invert())}lookAt(e,t,s){e.isVector3?V.copy(e):V.set(e,t,s);const r=this.parent;this.updateWorldMatrix(!0,!1),j.setFromMatrixPosition(this.matrixWorld),this.isCamera||this.isLight?U.lookAt(j,V,this.up):U.lookAt(V,j,this.up),this.quaternion.setFromRotationMatrix(U),r&&(U.extractRotation(r.matrixWorld),N.setFromRotationMatrix(U),this.quaternion.premultiply(N.invert()))}add(e){if(arguments.length>1){for(let e=0;e<arguments.length;e++)this.add(arguments[e]);return this}return e===this?(console.error("THREE.Object3D.add: object can't be added as a child of itself.",e),this):(e&&e.isObject3D?(null!==e.parent&&e.parent.remove(e),e.parent=this,this.children.push(e),e.dispatchEvent(K)):console.error("THREE.Object3D.add: object not an instance of THREE.Object3D.",e),this)}remove(e){if(arguments.length>1){for(let e=0;e<arguments.length;e++)this.remove(arguments[e]);return this}const t=this.children.indexOf(e);return-1!==t&&(e.parent=null,this.children.splice(t,1),e.dispatchEvent(Q)),this}removeFromParent(){const e=this.parent;return null!==e&&e.remove(this),this}clear(){const e=this.children;let t=e.length;for(;t--;){const s=e[t];s.parent=null,s.dispatchEvent(Q)}return this.children.length=0,this}attach(e){return this.updateWorldMatrix(!0,!1),U.copy(this.matrixWorld).invert(),null!==e.parent&&(e.parent.updateWorldMatrix(!0,!1),U.multiply(e.parent.matrixWorld)),e.applyMatrix4(U),this.add(e),e.updateWorldMatrix(!1,!0),this}getObjectById(e){return this.getObjectByProperty("id",e)}getObjectByName(e){return this.getObjectByProperty("name",e)}getObjectByProperty(e,t){if(this[e]===t)return this;const s=this.children;let r=s.length;for(;r--;){const i=s[r].getObjectByProperty(e,t);if(void 0!==i)return i}}getWorldPosition(e){return this.updateWorldMatrix(!0,!1),e.setFromMatrixPosition(this.matrixWorld)}getWorldQuaternion(e){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(j,e,G),e}getWorldScale(e){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(j,H,e),e}getWorldDirection(e){this.updateWorldMatrix(!0,!1);const t=this.matrixWorld.elements;return e.set(t[8],t[9],t[10]).normalize()}setRaycast(e){if(void 0!==e&&(this.isRay=e),!this.isRay){let e=this.children.length;for(;e--;)this.children[e].raycast=()=>{}}}raycast(e,t){if(!this.isRay)return;const s=this.children;let r=s.length;for(;r--;)s[r].layers.test(e.layers)&&s[r].raycast(e,t)}traverse(e){e(this);const t=this.children;let s=t.length;for(;s--;)t[s].traverse(e)}traverseVisible(e){if(!1===this.visible)return;e(this);const t=this.children;let s=t.length;for(;s--;)t[s].traverseVisible(e)}traverseAncestors(e){const t=this.parent;null!==t&&(e(t),t.traverseAncestors(e))}updateMatrix(){this.matrix.compose(this.position,this.quaternion,this.scale),this.matrixWorldNeedsUpdate=!0}updateMatrixWorld(e){this.matrixAutoUpdate&&this.updateMatrix(),(this.matrixWorldNeedsUpdate||e)&&(null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),this.matrixWorldNeedsUpdate=!1,e=!0);const t=this.children;let s=t.length;for(;s--;)t[s].updateMatrixWorld(e)}updateWorldMatrix(e,t){const s=this.parent;if(!0===e&&null!==s&&s.updateWorldMatrix(!0,!1),this.matrixAutoUpdate&&this.updateMatrix(),null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),!0===t){const e=this.children;let t=e.length;for(;t--;)e[t].updateWorldMatrix(!1,!0)}}}class Y extends t.InstancedMesh{constructor(e,s,r=0){super(e,s,r),this.matrixAutoUpdate=!1,this.tmpMatrix=new t.Matrix4,this.tmpQuat=new t.Quaternion,this.needSphereUp=!1,this.isRay=!0}getInfo(e){this.tmpMatrix.fromArray(this.instanceMatrix.array,16*e);let t={x:0,y:0,z:0},s={x:0,y:0,z:0};return this.tmpMatrix.decompose(t,this.tmpQuat,s),{pos:[t.x,t.y,t.z],quat:this.tmpQuat.toArray(),scale:[s.x,s.y,s.z]}}add(e=[0,0,0],s=[0,0,0,1],r=[1,1,1],i=null,n=null){3===s.length&&(s=this.tmpQuat.setFromEuler({_x:s[0],_y:s[1],_z:s[2],_order:"XYZ"},!1).toArray()),i&&(i.isColor&&(i=i.toArray()),null===this.instanceColor&&(this.instanceColor=new t.InstancedBufferAttribute(new Float32Array(3*this.instanceMatrix.count),3))),this.expand(e,s,r,i,n)}setColorAt(e,s){null===this.instanceColor&&(this.instanceColor=new t.InstancedBufferAttribute(new Float32Array(3*this.instanceMatrix.count),3)),s.isColor&&(s=s.toArray());let r=3*e;this.instanceColor.array[r]=s[0],this.instanceColor.array[r+1]=s[1],this.instanceColor.array[r+2]=s[2]}remove(e){if(!this.count)return;let s=[...this.instanceMatrix.array];s.splice(16*e,16),this.instanceMatrix=new t.InstancedBufferAttribute(new Float32Array(s),16),null!==this.instanceColor&&(s=[...this.instanceColor.array],s.splice(3*e,3),this.instanceColor=new t.InstancedBufferAttribute(new Float32Array(s),3)),null!==this.instanceUv&&(s=[...this.instanceUv.array],s.splice(2*e,2),this.instanceUv=new t.InstancedBufferAttribute(new Float32Array(s),2)),this.count--}expand(e,s,r,i=[1,1,1],n){let a=null!==this.instanceMatrix?this.instanceMatrix.array:[];this.tmpMatrix.compose({x:e[0],y:e[1],z:e[2]},{_x:s[0],_y:s[1],_z:s[2],_w:s[3]},{x:r[0],y:r[1],z:r[2]}),this.instanceMatrix=new t.InstancedBufferAttribute(new Float32Array([...a,...this.tmpMatrix.toArray()]),16),null!==this.instanceColor&&(a=this.instanceColor.array,this.instanceColor=new t.InstancedBufferAttribute(new Float32Array([...a,...i]),3)),this.count++}setTransformAt(e,t,s,r){this.tmpMatrix.compose({x:t[0],y:t[1],z:t[2]},{_x:s[0],_y:s[1],_z:s[2],_w:s[3]},{x:r[0],y:r[1],z:r[2]}),this.tmpMatrix.toArray(this.instanceMatrix.array,16*e),this.needSphereUp=!0}dispose(){this.parent.remove(this),this.geometry.dispose(),this.instanceColor=null,this.count=0,this.dispatchEvent({type:"dispose"})}setRaycast(e){void 0!==e&&(this.isRay=e)}raycast(e,t){this.isRay&&super.raycast(e,t)}update(){this.needSphereUp&&this.computeBoundingSphere(),this.instanceMatrix&&(this.instanceMatrix.needsUpdate=!0),this.instanceColor&&(this.instanceColor.needsUpdate=!0),this.needSphereUp=!1}}function J(e,s=!1){const r=null!==e[0].index,i=new Set(Object.keys(e[0].attributes)),n=new Set(Object.keys(e[0].morphAttributes)),a={},o={},l=e[0].morphTargetsRelative,h=new t.BufferGeometry;let c=0;for(let t=0;t<e.length;++t){const u=e[t];let p=0;if(r!==(null!==u.index))return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+t+". All geometries must have compatible attributes; make sure index attribute exists among all geometries, or in none of them."),null;for(const e in u.attributes){if(!i.has(e))return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+t+'. All geometries must have compatible attributes; make sure "'+e+'" attribute exists among all geometries, or in none of them.'),null;void 0===a[e]&&(a[e]=[]),a[e].push(u.attributes[e]),p++}if(p!==i.size)return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+t+". Make sure all geometries have the same number of attributes."),null;if(l!==u.morphTargetsRelative)return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+t+". .morphTargetsRelative must be consistent throughout all geometries."),null;for(const e in u.morphAttributes){if(!n.has(e))return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+t+".  .morphAttributes must be consistent throughout all geometries."),null;void 0===o[e]&&(o[e]=[]),o[e].push(u.morphAttributes[e])}if(s){let e;if(r)e=u.index.count;else{if(void 0===u.attributes.position)return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+t+". The geometry must have either an index or a position attribute"),null;e=u.attributes.position.count}h.addGroup(c,e,t),c+=e}}if(r){let t=0;const s=[];for(let r=0;r<e.length;++r){const i=e[r].index;for(let e=0;e<i.count;++e)s.push(i.getX(e)+t);t+=e[r].attributes.position.count}h.setIndex(s)}for(const e in a){const t=$(a[e]);if(!t)return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed while trying to merge the "+e+" attribute."),null;h.setAttribute(e,t)}for(const e in o){const t=o[e][0].length;if(0===t)break;h.morphAttributes=h.morphAttributes||{},h.morphAttributes[e]=[];for(let s=0;s<t;++s){const t=[];for(let r=0;r<o[e].length;++r)t.push(o[e][r][s]);const r=$(t);if(!r)return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed while trying to merge the "+e+" morphAttribute."),null;h.morphAttributes[e].push(r)}}return h}function $(e){let s,r,i,n=-1,a=0;for(let t=0;t<e.length;++t){const o=e[t];if(o.isInterleavedBufferAttribute)return console.error("THREE.BufferGeometryUtils: .mergeAttributes() failed. InterleavedBufferAttributes are not supported."),null;if(void 0===s&&(s=o.array.constructor),s!==o.array.constructor)return console.error("THREE.BufferGeometryUtils: .mergeAttributes() failed. BufferAttribute.array must be of consistent array types across matching attributes."),null;if(void 0===r&&(r=o.itemSize),r!==o.itemSize)return console.error("THREE.BufferGeometryUtils: .mergeAttributes() failed. BufferAttribute.itemSize must be consistent across matching attributes."),null;if(void 0===i&&(i=o.normalized),i!==o.normalized)return console.error("THREE.BufferGeometryUtils: .mergeAttributes() failed. BufferAttribute.normalized must be consistent across matching attributes."),null;if(-1===n&&(n=o.gpuType),n!==o.gpuType)return console.error("THREE.BufferGeometryUtils: .mergeAttributes() failed. BufferAttribute.gpuType must be consistent across matching attributes."),null;a+=o.array.length}const o=new s(a);let l=0;for(let t=0;t<e.length;++t)o.set(e[t].array,l),l+=e[t].array.length;const h=new t.BufferAttribute(o,r,i);return void 0!==n&&(h.gpuType=n),h}function ee(e,s=1e-4){s=Math.max(s,Number.EPSILON);const r={},i=e.getIndex(),n=e.getAttribute("position"),a=i?i.count:n.count;let o=0;const l=Object.keys(e.attributes),h={},c={},u=[],p=["getX","getY","getZ","getW"],d=["setX","setY","setZ","setW"];for(let s=0,r=l.length;s<r;s++){const r=l[s],i=e.attributes[r];h[r]=new t.BufferAttribute(new i.array.constructor(i.count*i.itemSize),i.itemSize,i.normalized);const n=e.morphAttributes[r];n&&(c[r]=new t.BufferAttribute(new n.array.constructor(n.count*n.itemSize),n.itemSize,n.normalized))}const m=Math.log10(1/s),f=Math.pow(10,m);for(let t=0;t<a;t++){const s=i?i.getX(t):t;let n="";for(let t=0,r=l.length;t<r;t++){const r=l[t],i=e.getAttribute(r),a=i.itemSize;for(let e=0;e<a;e++)n+=~~(i[p[e]](s)*f)+","}if(n in r)u.push(r[n]);else{for(let t=0,r=l.length;t<r;t++){const r=l[t],i=e.getAttribute(r),n=e.morphAttributes[r],a=i.itemSize,u=h[r],m=c[r];for(let e=0;e<a;e++){const t=p[e],r=d[e];if(u[r](o,i[t](s)),n)for(let e=0,i=n.length;e<i;e++)m[e][r](o,n[e][t](s))}}r[n]=o,u.push(o),o++}}const g=e.clone();for(const s in e.attributes){const e=h[s];if(g.setAttribute(s,new t.BufferAttribute(e.array.slice(0,o*e.itemSize),e.itemSize,e.normalized)),s in c)for(let e=0;e<c[s].length;e++){const r=c[s][e];g.morphAttributes[s][e]=new t.BufferAttribute(r.array.slice(0,o*r.itemSize),r.itemSize,r.normalized)}}return g.setIndex(u),g}function te(e,s){if(s===t.TrianglesDrawMode)return console.warn("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Geometry already defined as triangles."),e;if(s===t.TriangleFanDrawMode||s===t.TriangleStripDrawMode){let r=e.getIndex();if(null===r){const t=[],s=e.getAttribute("position");if(void 0===s)return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),e;for(let e=0;e<s.count;e++)t.push(e);e.setIndex(t),r=e.getIndex()}const i=r.count-2,n=[];if(s===t.TriangleFanDrawMode)for(let e=1;e<=i;e++)n.push(r.getX(0)),n.push(r.getX(e)),n.push(r.getX(e+1));else for(let e=0;e<i;e++)e%2==0?(n.push(r.getX(e)),n.push(r.getX(e+1)),n.push(r.getX(e+2))):(n.push(r.getX(e+2)),n.push(r.getX(e+1)),n.push(r.getX(e)));n.length/3!==i&&console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");const a=e.clone();return a.setIndex(n),a.clearGroups(),a}return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unknown draw mode:",s),e}class se extends t.BufferGeometry{constructor(e=1,s=10,r=10,i=10,n=1){super(),this.type="SphereBox",this.name="SphereBox_"+e+"_"+s+"_"+r+"_"+i+"_"+n,e=e||1,s=Math.floor(s),r=Math.floor(r),i=Math.floor(i);let a,o=new t.BoxGeometry(1,1,1,s,r,i),l=new t.Vector3,h=new t.Vector3,c=o.attributes.position.array,u=o.attributes.normal.array;for(let t=0,s=o.attributes.position.count;t<s;t++)a=3*t,l.set(c[a],c[a+1],c[a+2]),h.copy(l).normalize(),l.lerp(h,n).multiplyScalar(e),c[a]=l.x,c[a+1]=l.y,c[a+2]=l.z,l.normalize(),u[a]=l.x,u[a+1]=l.y,u[a+2]=l.z;this.copy(o)}}class re extends t.BufferGeometry{constructor(e=1,s=1,r=12,i=1){super(),this.type="CapsuleGeometry";let n=Math.PI,a=e/(2*e+s),o=1-2*a;r=Math.floor(r),i=Math.floor(i);let l=Math.floor(.5*r),h=2*Math.PI,c=.5*Math.PI,u=new t.CylinderGeometry(e,e,s,r,i,!0);le(u,0,a,1,o);let p=new t.SphereGeometry(e,r,l,0,h,0,c);le(p,0,1-a,1,a);let d=new t.SphereGeometry(e,r,l,0,h,c,c);le(d,0,0,1,a);let m=(new t.Matrix4).makeRotationY(.5*-n),f=(new t.Matrix4).makeTranslation(0,.5*s,0),g=(new t.Matrix4).makeTranslation(0,.5*-s,0);u.applyMatrix4(m),p.applyMatrix4(f),d.applyMatrix4(g);let y=ee(J([u,p,d]));this.copy(y)}}class ie extends t.BufferGeometry{constructor(e=1,s=.4,r=8,i=6,n=2*Math.PI,a=0,o=Math.PI){super(),this.type="TorusGeometryFix",this.parameters={radius:e,tube:s,radialSegments:r,tubularSegments:i,arc:n},r=Math.floor(r),i=Math.floor(i);const l=[],h=[],c=[],u=[],p=new t.Vector3,d=new t.Vector3,m=new t.Vector3;let f,g;for(f=0;f<=r;f++)for(g=0;g<=i;g++){const t=g/i*n,l=f/r*o+a;d.x=(e+s*Math.cos(l))*Math.cos(t),d.y=(e+s*Math.cos(l))*Math.sin(t),d.z=s*Math.sin(l),h.push(d.x,d.y,d.z),p.x=e*Math.cos(t),p.y=e*Math.sin(t),m.subVectors(d,p).normalize(),c.push(m.x,m.y,m.z),u.push(g/i),u.push(f/r)}for(f=1;f<=r;f++)for(g=1;g<=i;g++){const e=(i+1)*f+g-1,t=(i+1)*(f-1)+g-1,s=(i+1)*(f-1)+g,r=(i+1)*f+g;l.push(e,t,r),l.push(t,s,r)}this.setIndex(l),this.setAttribute("position",new t.Float32BufferAttribute(h,3)),this.setAttribute("normal",new t.Float32BufferAttribute(c,3)),this.setAttribute("uv",new t.Float32BufferAttribute(u,2))}}class ne extends t.BufferGeometry{constructor(e=1,s=1,r=1,i=.01,n=12,a=1,o=2){super(),this.type="ChamferCyl",n=Math.floor(n),a=Math.floor(a),o=Math.floor(o);let l=new t.Matrix4,h=new t.Matrix4,c=Math.PI,u=.5*c,p=2*c,d=i/r,m=1-2*d,f=new t.CylinderGeometry(e,s,r-2*i,n,a,!0,0);l.makeRotationY(u),f.applyMatrix4(l),le(f,0,d,1,m);let g=new ie(e-i,i,o,n,p,0,u),y=new t.CircleGeometry(e-i,n);h.makeTranslation(0,0,i),y.applyMatrix4(h),le(g,0,1-d,1,d);let b=J([g,y]);l.makeTranslation(0,0,.5*r-i),h.makeRotationX(-u),b.applyMatrix4(h.multiply(l)),g=new ie(s-i,i,o,n,p,0,u),y=new t.CircleGeometry(s-i,n),h.makeTranslation(0,0,i),y.applyMatrix4(h),le(g,0,1-d,1,d,!0);let x=J([g,y]);l.makeTranslation(0,0,.5*r-i),h.makeRotationX(u),x.applyMatrix4(h.multiply(l));let v=ee(J([b,f,x]));this.copy(v)}}class ae extends t.BufferGeometry{constructor(e=1,s=1,r=1,i=.01,n=1,a=1,o=1,l=2){super(),this.type="ChamferBox",n=Math.floor(n),a=Math.floor(a),o=Math.floor(o),l=Math.floor(l);let h=Math.PI,c=.5*h,u=2*i,p=.5*e,d=.5*s,m=.5*r,f=new t.Matrix4,g=new t.Matrix4,y=new t.Matrix4,b=i/e,x=1-2*b,v=i/s,w=1-2*b,M=i/r,A=1-2*M,T=new t.PlaneGeometry(e-u,s-u,n,a),S=new t.CylinderGeometry(i,i,e-u,l,n,!0,0,c),k=new t.CylinderGeometry(i,i,s-u,l,a,!0,0,c),R=new oe(i,l,l,0,c,0,-c),E=new oe(i,l,l,0,c,0,-c);le(T,-b,v,x,w),le(S,0,b,v,x),g.makeTranslation(0,d-i,0),f.makeRotationX(c),R.applyMatrix4(g.multiply(f)),g.makeTranslation(0,-d+i,0),f.makeRotationX(c),y.makeRotationY(-c),E.applyMatrix4(g.multiply(f).multiply(y));let P=J([k,R,E]),I=P.clone();g.makeTranslation(p-i,0,-i),P.applyMatrix4(g),g.makeTranslation(-p+i,0,-i),f.makeRotationZ(h),I.applyMatrix4(g.multiply(f));let _=S.clone();f.makeRotationZ(c),g.makeTranslation(0,d-i,-i),S.applyMatrix4(g.multiply(f)),g.makeTranslation(0,-d+i,-i),f.makeRotationZ(-c),_.applyMatrix4(g.multiply(f));let L=J([S,_,T,P,I]),C=L.clone();g.makeTranslation(0,0,m),L.applyMatrix4(g),g.makeTranslation(0,0,-m),f.makeRotationY(h),C.applyMatrix4(g.multiply(f)),T=new t.PlaneGeometry(r-u,s-u,o,a),S=new t.CylinderGeometry(i,i,r-u,l,o,!0,0,c),_=S.clone(),le(T,-M,v,A,w),g.makeTranslation(0,-(d-i),-i,0),f.makeRotationZ(-c),S.applyMatrix4(g.multiply(f)),g.makeTranslation(0,d-i,-i,0),f.makeRotationZ(c),_.applyMatrix4(g.multiply(f));let F=J([S,_,T]),B=F.clone();g.makeTranslation(-p,0,0),f.makeRotationY(-c),F.applyMatrix4(g.multiply(f)),g.makeTranslation(p,0,0),f.makeRotationY(c),B.applyMatrix4(g.multiply(f)),T=new t.PlaneGeometry(e-u,r-u,n,o),le(T,-b,M,x,A);let O=T.clone();g.makeTranslation(0,d,0),f.makeRotationX(-c),T.applyMatrix4(g.multiply(f)),g.makeTranslation(0,-d,0),f.makeRotationX(c),O.applyMatrix4(g.multiply(f));let z=ee(J([L,C,F,B,T,O]));he(z,"box"),this.copy(z)}}class oe extends t.BufferGeometry{constructor(e=1,s=8,r=6,i=0,n=2*Math.PI,a=0,o=Math.PI){super(),this.type="SphereGeometryFix",this.parameters={radius:e,widthSegments:s,heightSegments:r,phiStart:i,phiLength:n,thetaStart:a,thetaLength:o},s=Math.floor(s),r=Math.floor(r);const l=Math.min(a+o,Math.PI);let h=0;const c=[],u=new t.Vector3,p=new t.Vector3,d=[],m=[],f=[],g=[];for(let t=0;t<=r;t++){const d=[],y=t/r;let b=0;0==t&&0==a?b=.5/s:t==r&&l==Math.PI&&(b=-.5/s);for(let t=0;t<=s;t++){const r=t/s;u.x=-e*Math.cos(i+r*n)*Math.sin(a+y*o),u.y=e*Math.cos(a+y*o),u.z=e*Math.sin(i+r*n)*Math.sin(a+y*o),m.push(u.x,u.y,u.z),p.copy(u).normalize(),f.push(p.x,p.y,p.z),g.push(r+b,1-y),d.push(h++)}c.push(d)}for(let e=0;e<r;e++)for(let t=0;t<s;t++){const s=c[e][t+1],i=c[e][t],n=c[e+1][t],o=c[e+1][t+1];(0!==e||a>0)&&d.push(s,i,o),(e!==r-1||l<Math.PI)&&d.push(i,n,o)}this.setIndex(d),this.setAttribute("position",new t.Float32BufferAttribute(m,3)),this.setAttribute("normal",new t.Float32BufferAttribute(f,3)),this.setAttribute("uv",new t.Float32BufferAttribute(g,2))}}function le(e,t=0,s=0,r=1,i=1,n){let a=e.attributes.uv,o=a.array,l=a.count,h=0;for(;l--;)h=2*l,o[h]=o[h]*r-t,o[h+1]=o[h+1]*i+s,n&&(o[h]=1-o[h],o[h+1]=1-o[h+1])}function he(e,s="sphere",r,i=[0,0,0],n=[0,0,0,1],a){if(void 0===a&&(a=new t.Matrix4),a.compose({x:i[0],y:i[1],z:i[2]},{_x:n[0],_y:n[1],_z:n[2],_w:n[3]},{x:1,y:1,z:1}),void 0===r){e.boundingBox||e.computeBoundingBox();let t=e.boundingBox;r=Math.max(t.max.x-t.min.x,t.max.y-t.min.y,t.max.z-t.min.z)}let o=new t.Box3(new t.Vector3(-r/2,-r/2,-r/2),new t.Vector3(r/2,r/2,r/2)),l=[];l.length=2*e.attributes.position.count,void 0===e.attributes.uv&&e.setAttribute("uv",new t.Float32BufferAttribute(l,2));let h,c,u,p,d,m=function(e,s,r){e.applyMatrix4(a),s.applyMatrix4(a),r.applyMatrix4(a);let i=1/(2*Math.PI),n=1/Math.PI;return e.normalize(),s.normalize(),r.normalize(),{uv0:new t.Vector2(.5-Math.atan(e.z,-e.x)*i,.5-Math.asin(e.y)*n),uv1:new t.Vector2(.5-Math.atan(s.z,-s.x)*i,.5-Math.asin(s.y)*n),uv2:new t.Vector2(.5-Math.atan(r.z,-r.x)*i,.5-Math.asin(r.y)*n)}},f=function(e,s,i){e.applyMatrix4(a),s.applyMatrix4(a),i.applyMatrix4(a);let n=new t.Vector3;n.crossVectors(s.clone().sub(e),s.clone().sub(i)).normalize(),n.x<0||n.y<0||n.z,n.x=Math.abs(n.x),n.y=Math.abs(n.y),n.z=Math.abs(n.z);let l=new t.Vector2,h=new t.Vector2,c=new t.Vector2,u=1/r;return n.y>n.x&&n.y>n.z?(l.set(e.x-o.min.x,o.max.z-e.z).multiplyScalar(u),h.set(s.x-o.min.x,o.max.z-s.z).multiplyScalar(u),c.set(i.x-o.min.x,o.max.z-i.z).multiplyScalar(u)):n.x>n.y&&n.x>n.z?(l.set(e.z-o.min.z,e.y-o.min.y).multiplyScalar(u),h.set(s.z-o.min.z,s.y-o.min.y).multiplyScalar(u),c.set(i.z-o.min.z,i.y-o.min.y).multiplyScalar(u)):n.z>n.y&&n.z>n.x&&(l.set(e.x-o.min.x,e.y-o.min.y).multiplyScalar(u),h.set(s.x-o.min.x,s.y-o.min.y).multiplyScalar(u),c.set(i.x-o.min.x,i.y-o.min.y).multiplyScalar(u)),{uv0:l,uv1:h,uv2:c}},g=new t.Vector3,y=new t.Vector3,b=new t.Vector3;new t.Vector3,new t.Vector3,new t.Vector3;const x=e.getAttribute("position");if(e.getAttribute("normal"),e.index)for(h=0;h<e.index.count;h+=3)c=e.index.getX(h+0),u=e.index.getX(h+1),p=e.index.getX(h+2),g.fromBufferAttribute(x,c),y.fromBufferAttribute(x,u),b.fromBufferAttribute(x,p),d="sphere"===s?m(g,y,b):f(g,y,b),l[2*c]=d.uv0.x,l[2*c+1]=d.uv0.y,l[2*u]=d.uv1.x,l[2*u+1]=d.uv1.y,l[2*p]=d.uv2.x,l[2*p+1]=d.uv2.y;else for(h=0;h<x.count;h+=3){g.fromBufferAttribute(x,h+0),y.fromBufferAttribute(x,h+1),b.fromBufferAttribute(x,h+2),d="sphere"===s?m(g,y,b):f(g,y,b);let e=h,t=h+1,r=h+2;l[2*e]=d.uv0.x,l[2*e+1]=d.uv0.y,l[2*t]=d.uv1.x,l[2*t+1]=d.uv1.y,l[2*r]=d.uv2.x,l[2*r+1]=d.uv2.y}e.attributes.uv.array=new Float32Array(l),e.attributes.uv.needsUpdate=!0}const ce=new t.Vector3,ue=new t.Line3,pe=new t.Plane,de=new t.Vector3,me=new t.Triangle;class fe{constructor(){this.tolerance=-1,this.faces=[],this.newFaces=[],this.assigned=new xe,this.unassigned=new xe,this.vertices=[]}setFromPoints(e){if(e.length>=4){this.makeEmpty();for(let t=0,s=e.length;t<s;t++)this.vertices.push(new be(e[t]));this.compute()}return this}setFromObject(e){const s=[];return e.updateMatrixWorld(!0),e.traverse((function(e){const r=e.geometry;if(void 0!==r){const i=r.attributes.position;if(void 0!==i)for(let r=0,n=i.count;r<n;r++){const n=new t.Vector3;n.fromBufferAttribute(i,r).applyMatrix4(e.matrixWorld),s.push(n)}}})),this.setFromPoints(s)}containsPoint(e){const t=this.faces;for(let s=0,r=t.length;s<r;s++){if(t[s].distanceToPoint(e)>this.tolerance)return!1}return!0}intersectRay(e,t){const s=this.faces;let r=-1/0,i=1/0;for(let t=0,n=s.length;t<n;t++){const n=s[t],a=n.distanceToPoint(e.origin),o=n.normal.dot(e.direction);if(a>0&&o>=0)return null;const l=0!==o?-a/o:0;if(!(l<=0)&&(o>0?i=Math.min(l,i):r=Math.max(l,r),r>i))return null}return r!==-1/0?e.at(r,t):e.at(i,t),t}intersectsRay(e){return null!==this.intersectRay(e,ce)}makeEmpty(){return this.faces=[],this.vertices=[],this}addVertexToFace(e,t){return e.face=t,null===t.outside?this.assigned.append(e):this.assigned.insertBefore(t.outside,e),t.outside=e,this}removeVertexFromFace(e,t){return e===t.outside&&(null!==e.next&&e.next.face===t?t.outside=e.next:t.outside=null),this.assigned.remove(e),this}removeAllVerticesFromFace(e){if(null!==e.outside){const t=e.outside;let s=e.outside;for(;null!==s.next&&s.next.face===e;)s=s.next;return this.assigned.removeSubList(t,s),t.prev=s.next=null,e.outside=null,t}}deleteFaceVertices(e,t){const s=this.removeAllVerticesFromFace(e);if(void 0!==s)if(void 0===t)this.unassigned.appendChain(s);else{let e=s;do{const s=e.next;t.distanceToPoint(e.point)>this.tolerance?this.addVertexToFace(e,t):this.unassigned.append(e),e=s}while(null!==e)}return this}resolveUnassignedPoints(e){if(!1===this.unassigned.isEmpty()){let t=this.unassigned.first();do{const s=t.next;let r=this.tolerance,i=null;for(let s=0;s<e.length;s++){const n=e[s];if(0===n.mark){const e=n.distanceToPoint(t.point);if(e>r&&(r=e,i=n),r>1e3*this.tolerance)break}}null!==i&&this.addVertexToFace(t,i),t=s}while(null!==t)}return this}computeExtremes(){const e=new t.Vector3,s=new t.Vector3,r=[],i=[];for(let e=0;e<3;e++)r[e]=i[e]=this.vertices[0];e.copy(this.vertices[0].point),s.copy(this.vertices[0].point);for(let t=0,n=this.vertices.length;t<n;t++){const n=this.vertices[t],a=n.point;for(let t=0;t<3;t++)a.getComponent(t)<e.getComponent(t)&&(e.setComponent(t,a.getComponent(t)),r[t]=n);for(let e=0;e<3;e++)a.getComponent(e)>s.getComponent(e)&&(s.setComponent(e,a.getComponent(e)),i[e]=n)}return this.tolerance=3*Number.EPSILON*(Math.max(Math.abs(e.x),Math.abs(s.x))+Math.max(Math.abs(e.y),Math.abs(s.y))+Math.max(Math.abs(e.z),Math.abs(s.z))),{min:r,max:i}}computeInitialHull(){const e=this.vertices,t=this.computeExtremes(),s=t.min,r=t.max;let i=0,n=0;for(let e=0;e<3;e++){const t=r[e].point.getComponent(e)-s[e].point.getComponent(e);t>i&&(i=t,n=e)}const a=s[n],o=r[n];let l,h;i=0,ue.set(a.point,o.point);for(let t=0,s=this.vertices.length;t<s;t++){const s=e[t];if(s!==a&&s!==o){ue.closestPointToPoint(s.point,!0,de);const e=de.distanceToSquared(s.point);e>i&&(i=e,l=s)}}i=-1,pe.setFromCoplanarPoints(a.point,o.point,l.point);for(let t=0,s=this.vertices.length;t<s;t++){const s=e[t];if(s!==a&&s!==o&&s!==l){const e=Math.abs(pe.distanceToPoint(s.point));e>i&&(i=e,h=s)}}const c=[];if(pe.distanceToPoint(h.point)<0){c.push(ge.create(a,o,l),ge.create(h,o,a),ge.create(h,l,o),ge.create(h,a,l));for(let e=0;e<3;e++){const t=(e+1)%3;c[e+1].getEdge(2).setTwin(c[0].getEdge(t)),c[e+1].getEdge(1).setTwin(c[t+1].getEdge(0))}}else{c.push(ge.create(a,l,o),ge.create(h,a,o),ge.create(h,o,l),ge.create(h,l,a));for(let e=0;e<3;e++){const t=(e+1)%3;c[e+1].getEdge(2).setTwin(c[0].getEdge((3-e)%3)),c[e+1].getEdge(0).setTwin(c[t+1].getEdge(1))}}for(let e=0;e<4;e++)this.faces.push(c[e]);for(let t=0,s=e.length;t<s;t++){const s=e[t];if(s!==a&&s!==o&&s!==l&&s!==h){i=this.tolerance;let e=null;for(let t=0;t<4;t++){const r=this.faces[t].distanceToPoint(s.point);r>i&&(i=r,e=this.faces[t])}null!==e&&this.addVertexToFace(s,e)}}return this}reindexFaces(){const e=[];for(let t=0;t<this.faces.length;t++){const s=this.faces[t];0===s.mark&&e.push(s)}return this.faces=e,this}nextVertexToAdd(){if(!1===this.assigned.isEmpty()){let e,t=0;const s=this.assigned.first().face;let r=s.outside;do{const i=s.distanceToPoint(r.point);i>t&&(t=i,e=r),r=r.next}while(null!==r&&r.face===s);return e}}computeHorizon(e,t,s,r){let i;this.deleteFaceVertices(s),s.mark=1,i=null===t?t=s.getEdge(0):t.next;do{const t=i.twin,s=t.face;0===s.mark&&(s.distanceToPoint(e)>this.tolerance?this.computeHorizon(e,t,s,r):r.push(i)),i=i.next}while(i!==t);return this}addAdjoiningFace(e,t){const s=ge.create(e,t.tail(),t.head());return this.faces.push(s),s.getEdge(-1).setTwin(t.twin),s.getEdge(0)}addNewFaces(e,t){this.newFaces=[];let s=null,r=null;for(let i=0;i<t.length;i++){const n=t[i],a=this.addAdjoiningFace(e,n);null===s?s=a:a.next.setTwin(r),this.newFaces.push(a.face),r=a}return s.next.setTwin(r),this}addVertexToHull(e){const t=[];return this.unassigned.clear(),this.removeVertexFromFace(e,e.face),this.computeHorizon(e.point,null,e.face,t),this.addNewFaces(e,t),this.resolveUnassignedPoints(this.newFaces),this}cleanup(){return this.assigned.clear(),this.unassigned.clear(),this.newFaces=[],this}compute(){let e;for(this.computeInitialHull();void 0!==(e=this.nextVertexToAdd());)this.addVertexToHull(e);return this.reindexFaces(),this.cleanup(),this}}class ge{constructor(){this.normal=new t.Vector3,this.midpoint=new t.Vector3,this.area=0,this.constant=0,this.outside=null,this.mark=0,this.edge=null}static create(e,t,s){const r=new ge,i=new ye(e,r),n=new ye(t,r),a=new ye(s,r);return i.next=a.prev=n,n.next=i.prev=a,a.next=n.prev=i,r.edge=i,r.compute()}getEdge(e){let t=this.edge;for(;e>0;)t=t.next,e--;for(;e<0;)t=t.prev,e++;return t}compute(){const e=this.edge.tail(),t=this.edge.head(),s=this.edge.next.head();return me.set(e.point,t.point,s.point),me.getNormal(this.normal),me.getMidpoint(this.midpoint),this.area=me.getArea(),this.constant=this.normal.dot(this.midpoint),this}distanceToPoint(e){return this.normal.dot(e)-this.constant}}class ye{constructor(e,t){this.vertex=e,this.prev=null,this.next=null,this.twin=null,this.face=t}head(){return this.vertex}tail(){return this.prev?this.prev.vertex:null}length(){const e=this.head(),t=this.tail();return null!==t?t.point.distanceTo(e.point):-1}lengthSquared(){const e=this.head(),t=this.tail();return null!==t?t.point.distanceToSquared(e.point):-1}setTwin(e){return this.twin=e,e.twin=this,this}}class be{constructor(e){this.point=e,this.prev=null,this.next=null,this.face=null}}class xe{constructor(){this.head=null,this.tail=null}first(){return this.head}last(){return this.tail}clear(){return this.head=this.tail=null,this}insertBefore(e,t){return t.prev=e.prev,t.next=e,null===t.prev?this.head=t:t.prev.next=t,e.prev=t,this}insertAfter(e,t){return t.prev=e,t.next=e.next,null===t.next?this.tail=t:t.next.prev=t,e.next=t,this}append(e){return null===this.head?this.head=e:this.tail.next=e,e.prev=this.tail,e.next=null,this.tail=e,this}appendChain(e){for(null===this.head?this.head=e:this.tail.next=e,e.prev=this.tail;null!==e.next;)e=e.next;return this.tail=e,this}remove(e){return null===e.prev?this.head=e.next:e.prev.next=e.next,null===e.next?this.tail=e.prev:e.next.prev=e.prev,this}removeSubList(e,t){return null===e.prev?this.head=t.next:e.prev.next=t.next,null===t.next?this.tail=e.prev:t.next.prev=e.prev,this}isEmpty(){return null===this.head}}class ve extends t.BufferGeometry{constructor(e=[]){super();const s=[],r=[],i=(new fe).setFromPoints(e).faces;for(let e=0;e<i.length;e++){const t=i[e];let n=t.edge;do{const e=n.head().point;s.push(e.x,e.y,e.z),r.push(t.normal.x,t.normal.y,t.normal.z),n=n.next}while(n!==t.edge)}this.setAttribute("position",new t.Float32BufferAttribute(s,3)),this.setAttribute("normal",new t.Float32BufferAttribute(r,3))}}class we extends F{constructor(){super(),this.Utils=x,this.type="body",this.num=g[this.type],this.full=!1,this.extraConvex=!1,this.needMatrix="RAPIER"===b.engine||"HAVOK"===b.engine}setFull(e){this.num=g[e?"bodyFull":"body"],this.full=e}step(e,t){const s=this.list;let r,i,n,a=s.length;for(;a--;)if(r=s[a],null!==r){if(i=t+a*this.num,!r.actif){if(n=e[i+0]+e[i+1]+e[i+2]+e[i+3]+e[i+4]+e[i+5]+e[i+6]+e[i+7],0===n)continue;r.actif=!0}r.sleep=!(e[i]>0),r.defMat&&(r.isInstance?r.instance.setColorAt(r.id,r.sleep?_.sleep:_.body):(r.sleep||"sleep"!==r.material.name||(r.material=L.get("body")),r.sleep&&"body"===r.material.name&&(r.material=L.get("sleep")))),r.sleep&&!r.isKinematic||(r.isInstance?(r.speedMat&&r.instance.setColorAt(r.id,[.5*Math.abs(e[i+8]),.5*Math.abs(e[i+9]),.5*Math.abs(e[i+10])]),r.instance.setTransformAt(r.id,[e[i+1],e[i+2],e[i+3]],[e[i+4],e[i+5],e[i+6],e[i+7]],r.noScale?[1,1,1]:r.size),r.position={x:e[i+1],y:e[i+2],z:e[i+3]},r.quaternion={_x:e[i+4],_y:e[i+5],_z:e[i+6],_w:e[i+7]},this.needMatrix&&r.matrixWorld.compose(r.position,r.quaternion,{x:1,y:1,z:1}),this.full&&(r.velocity={x:e[i+8],y:e[i+9],z:e[i+10]},r.angular={x:e[i+11],y:e[i+12],z:e[i+13]})):(r.position.fromArray(e,i+1),r.quaternion.fromArray(e,i+4),this.full&&(r.velocity.fromArray(e,i+8),r.angular.fromArray(e,i+11)),r.auto||r.updateMatrix()))}}geometry(e={},s=null,r=null){let i,n,a,h=e.size,c="",u=e.type,p=!1,d=!1,m=e.seg||16;if(e.instance&&"compound"===u&&(u=e.shapes[0].type,h=e.shapes[0].size,e.translate=e.shapes[0].pos),"mesh"!==u&&"convex"!==u||(e.shape?e.shape.isMesh&&(e.shape=e.shape.geometry):e.mesh&&!e.v&&(e.shape=e.mesh.geometry)),e.radius&&(e.breakable||("box"===u&&(u="ChamferBox"),"cylinder"===u&&(u="ChamferCyl"))),e.geometry&&("convex"===u?e.shape=e.geometry:u="direct"),"PHYSX"===b.engine&&("cylinder"===e.type||"cone"===e.type)){let s=new t.CylinderGeometry("cone"===e.type?0:e.size[0],e.size[0],e.size[1],m,1);e.isWheel&&s.rotateZ(-o),e.v=l.getVertex(s),e.type="convex"}if("HAVOK"===b.engine&&"cone"===e.type){let s=new t.CylinderGeometry("cone"===e.type?0:e.size[0],e.size[0],e.size[1],m,1);e.v=l.getVertex(s),e.type="convex"}switch("stair"===e.type&&(e.type="box",u="box"),u){case"direct":i=e.geometry.clone(),e.size&&i.scale(e.size[0],e.size[1],e.size[2]),d=!0,p=!0;break;case"convex":if(e.v){if(e.nogeo)i=new t.BufferGeometry;else{let s=[];for(n=Math.floor(e.v.length/3);n--;)a=3*n,s.push(new t.Vector3(e.v[a],e.v[a+1],e.v[a+2]));i=new ve(s)}d=!0,p=!0}e.shape&&(i=e.shape.clone(),e.size&&i.scale(e.size[0],e.size[0],e.size[0]),e.shapeScale&&i.scale(e.shapeScale[0],e.shapeScale[1],e.shapeScale[2]),e.v=l.getVertex(i),e.index=l.getIndex(i),d=!0,p=!0),i.boundingBox||i.computeBoundingBox();let s=i.boundingBox;e.boxSize=[-s.min.x+s.max.x,-s.min.y+s.max.y,-s.min.z+s.max.z];break;case"mesh":i=e.shape.clone(),e.size&&i.scale(e.size[0],e.size[0],e.size[0]),e.v=l.getVertex(i,"OIMO"===b.engine),e.index="OIMO"===b.engine?null:l.getIndex(i),d=!0,p=!0;break;case"highSphere":c="highSphere_"+h[0],i=S(c),i?c="":(i=new se(h[0]),i.name=c),p=!0,e.type="sphere";break;case"capsule":c="capsule_"+h[0]+"_"+h[1]+"_"+m,i=S(c),i?c="":(i=new re(h[0],h[1],m),i.name=c),p=!0;break;case"ChamferBox":c="ChamferBox_"+h[0]+"_"+h[1]+"_"+h[2]+"_"+e.radius,i=S(c),i?c="":(i=new ae(h[0],h[1],h[2],e.radius),i.name=c),p=!0;break;case"ChamferCyl":c="ChamferCyl_"+h[0]+"_"+h[1]+"_"+h[2]+"_"+e.radius+"_"+m,i=S(c),i?c="":(i=new ne(h[0],h[0],h[1],e.radius,m),i.name=c),p=!0;break;default:e.breakable?(i=S(u).clone(),i.scale(h[0],h[1],h[2]),d=!0,p=!0):i=S(u)}if(e.translate&&i.translate(e.translate[0],e.translate[1],e.translate[2]),e.shape&&delete e.shape,e.geometry&&delete e.geometry,(void 0===i.attributes.uv||e.autoUV)&&he(i,"box",5,e.pos,e.quat),""!==c&&T(i),e.isWheel&&(i=i.clone(),i.rotateZ(-o),d=!0),d&&A(i),null===s&&null===r)return i.noScale=p,i;e.meshRemplace&&e.debug&&(r=L.get("debug3"));let f=new t.Mesh(i,r);e.localRot&&(e.localQuat=l.quatFromEuler(e.localRot)),e.localPos&&f.position.fromArray(e.localPos),e.localQuat&&f.quaternion.fromArray(e.localQuat),p||f.scale.fromArray(e.size),void 0!==e.ray&&(e.ray||(f.raycast=()=>{})),e.meshRemplace&&!e.debug||s.add(f)}add(e={}){let s,r,i;if(e.instance||(i=this.setName(e)),e.type=void 0===e.type?"box":e.type,"plane"!==e.type||e.visible||(e.visible=!1),"stair"===e.type){let s=new t.Vector3(0,0,e.size[2]),r=new t.Vector3(0,.5*e.size[1],.5*e.size[2]),i=s.angleTo(r),a=s.distanceTo(r);e.rot=[i*n,0,0],e.size[1]*=e.div||.2,e.size[2]=2*a;let o=new t.Vector3(0,.5*-e.size[1],0);o.applyAxisAngle({x:1,y:0,z:0},i),e.pos[1]+=o.y,e.pos[2]+=o.z}if(e.massCenter&&"PHYSX"!==b.engine)if("compound"!==e.type)e.shapes=[{type:e.type,pos:e.massCenter,size:e.size}],e.seg&&(e.shapes[0].seg=e.seg),e.radius&&(e.shapes[0].radius=e.radius),delete e.size,e.type="compound";else for(s=0;s<e.shapes.length;s++)r=e.shapes[s],r.pos?r.pos=x.vecAdd(r.pos,e.massCenter):r.pos=e.massCenter,A(r);e.pos=void 0===e.pos?[0,0,0]:e.pos,e.quat=void 0===e.quat?[0,0,0,1]:e.quat,void 0!==e.rot&&(e.quat=l.quatFromEuler(e.rot),delete e.rot),void 0!==e.meshRot&&(e.meshQuat=l.quatFromEuler(e.meshRot),delete e.meshRot),e.size=l.autoSize(e.size,e.type),e.meshScale&&(e.meshScale=l.autoSize(e.meshScale));let a,o=!1;!1===e.visible&&(e.material="hide"),void 0!==e.material?a=e.material.constructor===String?L.get(e.material):e.material:(o=!0,a=L.get(this.type),e.instance&&(a=L.get("base"))),e.unicMat&&(a=a.clone(),L.addToTmp(a)),e.material&&delete e.material;let h=e.instance?{}:new Z;if(e.mesh&&!e.instance){"terrain"===e.mesh.type&&(e.noClone=!0);let t=e.noClone?e.mesh:e.mesh.clone();t.position.fromArray(e.meshPos||[0,0,0]),e.meshRot&&(e.meshQuat=l.quatFromEuler(e.meshRot),delete e.meshRot),e.meshQuat&&t.quaternion.fromArray(e.meshQuat),e.meshSize&&t.scale.set(1,1,1).multiplyScalar(e.meshSize),e.meshScale&&t.scale.fromArray(e.meshScale),o||(t.material=a),b.tmpMesh.push(t),e.meshRemplace=!0,h.add(t)}switch(e.type){case"null":break;case"compound":for(s=0;s<e.shapes.length;s++)r=e.shapes[s],r.type=void 0===r.type?"box":r.type,r.size=l.autoSize(r.size,r.type),r.pos&&(r.localPos=r.pos),void 0!==r.rot&&(r.quat=l.quatFromEuler(r.rot),delete r.rot),r.quat&&(r.localQuat=r.quat),r.debug=e.debug||!1,r.meshRemplace=e.meshRemplace||!1,e.instance||this.geometry(r,h,a);break;default:e.instance||this.geometry(e,h,a)}if(h.type=this.type,h.size=e.size,h.shapetype=e.type,h.isKinematic=e.kinematic||!1,e.button&&(h.isButton=!0),h.isRay=!0,void 0!==e.ray&&(h.isRay=e.ray),e.instance||h.setRaycast(),o||(h.material=a),h.defMat=!1,h.material&&o&&(h.defMat="body"===h.material.name),e.instance){h.isInstance=!0,h.instance=b.instanceMesh[e.instance]||this.addInstance(e,a),h.instance.isRay=h.isRay,h.defMat="base"===h.instance.material.name,h.id=h.instance.count,h.mass=e.mass||0,h.name=h.instance.name+h.id,e.name=h.name,h.noScale=h.instance.noScale,e.sizeByInstance&&(h.noScale=!1);let s=e.color;h.defMat&&(s=e.sleep?_.sleep:_.body),h.instance.add(e.pos,e.quat,h.noScale?[1,1,1]:h.size,s),h.position={x:e.pos[0],y:e.pos[1],z:e.pos[2]},h.quaternion={_x:e.quat[0],_y:e.quat[1],_z:e.quat[2],_w:e.quat[3]},h.velocity={x:0,y:0,z:0},h.angular={x:0,y:0,z:0},this.needMatrix&&(h.matrixWorld=new t.Matrix4),h.instance.v&&(e.v=h.instance.v),h.instance.index&&(e.index=h.instance.index),e.type=h.instance.type}else h.name=i,e.renderOrder&&(h.renderOrder=e.renderOrder),void 0===e.visible&&(e.visible=!0),void 0===e.shadow&&(e.shadow=e.visible),h.visible=void 0===e.visible||e.visible,h.receiveShadow=e.shadow,h.castShadow=e.shadow,this.set(e,h);if(e.instance&&delete e.instance,e.mesh&&delete e.mesh,e.breakable){b.motor.addBreaker();let t=h.children[0];h.remove(t),h=t,h.name=i,h.type=this.type,h.density=e.density,h.breakable=!0,h.breakOption=void 0!==e.breakOption?e.breakOption:[250,1,2,1]}return this.addToWorld(h,e.id),e.onlyMakeMesh||(e.phySize&&(e.size=e.phySize),e.phyPos&&(e.pos=e.phyPos),e.parent&&delete e.parent,b.post({m:"add",o:e})),h}set(e={},t=null){null===t&&(t=this.byName(e.name)),null!==t&&(e.pos&&t.position.fromArray(e.pos),e.quat&&t.quaternion.fromArray(e.quat),t.auto=e.auto||!1,t.auto?t.matrixAutoUpdate=!0:(t.matrixAutoUpdate=!1,t.updateMatrix()))}addInstance(e,t){e.sizeByInstance&&(e.size=[1,1,1]);let s=this.geometry(e);e.mesh&&(s=e.mesh.isObject3D?e.mesh.geometry.clone():e.mesh.clone(),e.meshScale&&s.scale(e.meshScale[0],e.meshScale[1],e.meshScale[2]),s.noScale=!0);let r=new Y(s,t,0);return r.type=e.type,r.noScale=s.noScale,"convex"===r.type&&(r.v=e.v),e.index&&(r.index=e.index),r.receiveShadow=void 0===e.shadow||e.shadow,r.castShadow=void 0===e.shadow||e.shadow,r.name=e.instance,b.scene.add(r),b.instanceMesh[e.instance]=r,r}}class Me extends F{constructor(){super(),this.Utils=x,this.type="joint",this.v1=new t.Vector3,this.v2=new t.Vector3}step(e,t){let s,r,i=this.list.length;for(;i--;)s=this.list[i],r=t+i*g.joint,16===g.joint?s.updateFromPhy(e,r):s.update()}add(e={}){let s,r=this.setName(e),i=null,n=null;e.b1&&(s="string"==typeof e.b1,i=s?x.byName(e.b1):e.b1,s||(e.b1=e.b1.name)),e.b2&&(s="string"==typeof e.b2,n=s?x.byName(e.b2):e.b2,s||(e.b2=e.b2.name)),e.worldPos&&(e.worldAnchor=e.worldPos),e.worldAnchor&&(this.v1.fromArray(e.worldAnchor),this.v2.fromArray(e.worldAnchor),e.pos1=i?x.toLocal(this.v1,i).toArray():e.worldAnchor,e.pos2=n?x.toLocal(this.v2,n).toArray():e.worldAnchor,delete e.worldAnchor),e.worldAxis&&(this.v1.fromArray(e.worldAxis),this.v2.fromArray(e.worldAxis),e.axis1=i?x.toLocal(this.v1,i,!0).toArray():e.worldAxis,e.axis2=n?x.toLocal(this.v2,n,!0).toArray():e.worldAxis,delete e.worldAxis),e.worldQuat&&(e.quat1=x.quatLocal(e.worldQuat,i),e.quat2=x.quatLocal(e.worldQuat,n),"OIMO"!==b.engine&&"HAVOK"!==b.engine||(e.axis1=x.axisLocal(l.quatToAxis(e.worldQuat),i),e.axis2=x.axisLocal(l.quatToAxis(e.worldQuat),n)),delete e.worldQuat),e.axis1||(e.axis1=[1,0,0]),e.axis2||(e.axis2=[1,0,0]),e.pos1||(e.pos1=[0,0,0]),e.pos2||(e.pos2=[0,0,0]),void 0!==e.rot1&&(e.quat1=l.quatFromEuler(e.rot1),delete e.rot1),void 0!==e.rot2&&(e.quat2=l.quatFromEuler(e.rot2),delete e.rot2),e.quat1||(e.quat1=(new t.Quaternion).setFromUnitVectors(new t.Vector3(1,0,0),(new t.Vector3).fromArray(e.axis1).normalize()).toArray()),e.quat2||(e.quat2=(new t.Quaternion).setFromUnitVectors(new t.Vector3(1,0,0),(new t.Vector3).fromArray(e.axis2).normalize()).toArray()),e.drivePosition&&void 0!==e.drivePosition.rot&&(e.drivePosition.quat=l.quatFromEuler(e.drivePosition.rot),delete e.drivePosition.rot);let a=new Ae(S("joint"),e);return a.name=r,a.visible=b.jointVisible||!1,e.visible||(e.visible=a.visible),a.visible=void 0===e.visible||e.visible,a.body1=i,a.body2=n,this.set(e,a),this.addToWorld(a,e.id),b.post({m:"add",o:e}),a}set(e={},t=null){null===t&&(t=this.byName(e.name)),null!==t&&void 0!==e.visible&&(t.visible=e.visible)}}class Ae extends Z{constructor(e,s){super();let r=L.get("line");this.type="joint",this.mode="revolute",this.isJoint=!0,this.mtx=new t.Matrix4,this.size=s.helperSize||.1,(e=e.clone()).scale(this.size,this.size,this.size),this.m1=new t.LineSegments(e,r),this.add(this.m1),this.m1.matrixAutoUpdate=!1,this.m2=new t.LineSegments(e,r),this.add(this.m2),this.m2.matrixAutoUpdate=!1,this.m2.updateMatrix(),this.m1.updateMatrix(),this.body1=null,this.body2=null,this.mat1=new t.Matrix4,this.mat2=new t.Matrix4,this.end=new t.Vector3;let i=new t.Quaternion;s.quat1&&this.mat1.makeRotationFromQuaternion(i.fromArray(s.quat1)),s.quat2&&this.mat2.makeRotationFromQuaternion(i.fromArray(s.quat2)),this.mat1.setPosition(s.pos1[0],s.pos1[1],s.pos1[2]),this.mat2.setPosition(s.pos2[0],s.pos2[1],s.pos2[2]);const n=new t.BufferGeometry;n.setAttribute("position",new t.Float32BufferAttribute([0,0,0,0,0,0],3)),n.setAttribute("color",new t.Float32BufferAttribute([1,0,0,1,0,0],3)),n.computeBoundingSphere(),this.m3=new t.LineSegments(n,r),this.add(this.m3),this.m3.matrixAutoUpdate=!1,this.pp=this.m3.geometry.attributes.position}update(){this.visible&&(this.body1?this.matrix.copy(this.body1.matrixWorld).multiply(this.mat1):this.matrix.copy(this.mat1),this.body2?this.m2.matrix.copy(this.body2.matrixWorld).multiply(this.mat2):this.m2.matrix.copy(this.mat2),this.m2.matrix.premultiply(this.matrix.clone().invert()),this.end.setFromMatrixPosition(this.m2.matrix),this.pp.setXYZ(1,this.end.x,this.end.y,this.end.z),this.pp.needsUpdate=!0,this.visible||(this.visible=!0))}updateFromPhy(e,t=0){this.visible&&(this.position.fromArray(e,t),this.quaternion.fromArray(e,t+3),this.updateMatrix(),this.m2.position.fromArray(e,t+7),this.m2.quaternion.fromArray(e,t+10),this.m2.matrix.compose(this.m2.position,this.m2.quaternion,{x:1,y:1,z:1}),this.mtx.copy(this.matrix).invert().multiply(this.m2.matrix),this.mtx.decompose(this.m2.position,this.m2.quaternion,{x:1,y:1,z:1}),this.m2.updateMatrix(),this.pp.setXYZ(1,this.m2.position.x,this.m2.position.y,this.m2.position.z),this.pp.needsUpdate=!0,this.visible||(this.visible=!0))}dispose(){this.m1.geometry.dispose(),this.m2.geometry.dispose(),this.m3.geometry.dispose(),this.children=[]}}class Te extends F{constructor(){super(),this.Utils=x,this.type="contact"}step(e,t){let s,r,i=this.list.length;for(;i--;)s=this.list[i],r=t+i*g.contact,s.update(e,r)}add(e={}){this.setName(e);let t=new Se(e);return e.callback&&delete e.callback,this.addToWorld(t,e.id),b.post({m:"add",o:e}),t}}class Se{constructor(e={}){this.type="contact",this.name=e.name,this.callback=e.callback||function(){},this.b1=e.b1||null,this.b2=e.b2||null,this.ignore=e.ignore||[],this.always=void 0===e.always||e.always,this.simple=e.simple||!1,this.data={hit:!1,point:[0,0,0],normal:[0,0,0]}}update(e,t=0){this.data.hit=e[t]>0,this.simple||(this.data.point=[e[t+1],e[t+2],e[t+3]],this.data.normal=[e[t+4],e[t+5],e[t+6]]),(this.data.hit||this.always)&&this.callback(this.data)}}class ke extends F{constructor(){super(),this.Utils=x,this.type="vehicle",this.num=g[this.type]}step(e,t){let s,r,i=this.list.length;for(;i--;)r=this.list[i],s=t+i*this.num,r.step(e,s)}add(e={}){this.setName(e);const t=new Re(e);return this.addToWorld(t,e.id),b.post({m:"add",o:t.o}),t}set(e={},t=null){null===t&&(t=this.byName(e.name))}}class Re extends Z{constructor(e){super(),e.extra&&(this.extra=e.extra,delete e.extra),this.type="vehicle",this.name=e.name||"car",this.isRay=e.ray||!1,this.actif=!1,this.steering=0,this.suspension=[],this.rolling=[],this.init(e)}drive(){}raycast(){}init(e){this.mass=e.mass||2e3,this.model=null,this.size=e.size||[1.7,1,5],this.massCenter=e.massCenter||[0,.55,1.594],this.chassisPos=e.chassisPos||[0,.83,0],this.maxSteering=e.maxSteering||24,this.incSteering=e.incSteering||2,this.s_travel=e.s_travel||.4,this.s_ratio=1/(.5*this.s_travel),this.decaly="PHYSX"===b.engine?.5*this.s_travel:0,this.numWheel=e.numWheel||4,this.radius=e.radius||.35,this.radiusBack=e.radiusBack||this.radius,this.deep=e.deep||.3,this.deepBack=e.deepBack||this.deep;let t=this.numWheel<4?1:2;if(e.wPos||(e.wPos=[.8,.1,1.4]),e.wPos){this.wPos=e.wPos;var s,r,i,n,a,o,h=e.wPos,c=[],u=1,p=0;h.length,h.length;for(let e=0;e<this.numWheel;e++)u=e%2==0?-1:1,r=Math.floor(.5*e),p=e>=t,0===(i=h[1])&&(i=p?this.radiusBack:this.radius),(n=h[0])instanceof Array&&(n=h[0][r]),a=p?-h[2]:h[2],h[2]instanceof Array&&(a=h[2][r]),s=[n*u,i,a],c.push(s);this.wheelsPosition=c,delete e.wPos}e.wheelsPosition&&(this.wheelsPosition=e.wheelsPosition);const d=e.meshScale||1,m=[];e.chassisShape?m.push({type:"convex",shape:e.chassisShape,size:[d],pos:this.chassisPos,filter:[1,-1,0,0],isExclusive:!0,ray:this.isRay}):m.push({type:"box",size:this.size,pos:this.chassisPos});for(let s=0;s<this.numWheel;s++)s<t?m.push({type:"cylinder",size:[this.radius,this.deep],isWheel:!0,radius:e.rad||.05,shadow:!1,ray:!1}):m.push({type:"cylinder",size:[this.radiusBack,this.deepBack],isWheel:!0,radius:e.rad||.05,shadow:!1,ray:!1});var f=L.get(e.debug?"debug":void 0===e.chassisMesh?"body":"hide");let g,y;for(let e=0;e<m.length;e++)g=m[e],g.pos&&(g.localPos=g.pos),g.size=l.autoSize(g.size,g.type),b.items.body.geometry(g,this,f);if(e.chassisMesh&&(y=e.noClone?e.chassisMesh:e.chassisMesh.clone(),y.position.set(0,0,0),x.noRay(y),y.scale.set(d,d,d),this.children[0].add(y),this.model=y,delete e.chassisMesh),e.wheelMesh){for(let s=1;s<this.numWheel+1;s++)p=s>=t+1,y=e.wheelMeshBack&&p?e.wheelMeshBack.clone():e.wheelMesh.clone(),x.noRay(y),y.position.set(0,0,0),2==s||4==s?y.scale.set(-d,d,d):y.scale.set(d,d,d),this.children[s].add(y);delete e.wheelMesh}if(e.suspensionMesh){this.suspensionMesh=[];for(let t=1;t<this.numWheel+1;t++)y=e.suspensionMesh.clone(),x.noRay(y),y.position.set(0,0,0),y.position.fromArray(this.wheelsPosition[t-1]),y.position.x=0,2==t||4==t?y.scale.set(d,d,d):y.scale.set(-d,d,d),this.children[0].add(y),this.suspensionMesh.push(y);delete e.suspensionMesh}if(e.brakeMesh){this.brake=[];for(let t=1;t<this.numWheel+1;t++)p=t>2,y=e.brakeMeshBack&&p?e.brakeMeshBack.clone():e.brakeMesh.clone(),x.noRay(y),y.position.set(0,0,0),y.position.fromArray(this.wheelsPosition[t-1]),o=e.brakeMeshBack||p?d:-d,2==t||4==t?y.scale.set(-d,d,o):y.scale.set(d,d,o),this.children[0].add(y),this.brake.push(y);delete e.brakeMesh}e.mass=this.mass,e.size=e.chassisShape?m[0].boxSize:this.size,e.numWheel=this.numWheel,e.wheelsPosition=this.wheelsPosition,e.radius=this.radius,e.radiusBack=this.radiusBack,e.deep=this.deep,e.deepBack=this.deepBack,e.chassisShape=m[0],e.maxSteering=this.maxSteering,e.incSteering=this.incSteering,e.s_travel=this.s_travel,e.massCenter=this.massCenter,e.chassisPos=this.chassisPos,this.o=e}respawn(e){(e=e||{}).respawn=!0,e.name=this.name,e.keepRotation&&(e.quat=this.quaternion.toArray()),b.motor.change(e)}move(){}dispose(){}step(e,t){if(!this.actif){if(0===e[t+0]+e[t+1]+e[t+2]+e[t+3]+e[t+4]+e[t+5]+e[t+6]+e[t+7])return;this.actif=!0}this.position.fromArray(e,t+1),this.quaternion.fromArray(e,t+4),this.updateMatrix();let s,r=this.numWheel+1,i=0,a=0,o=[],h=0;for(let n=0;n<r;n++)h=8*n+t,0===n&&(e[h],this.circum),1===n&&(i=e[h]),2===n&&(a=e[h]),s=this.children[n],s&&n>0&&(o[n-1]=this.wheelsPosition[n-1][1]-this.decaly-e[h+2],s.position.fromArray(e,h+1),s.quaternion.fromArray(e,h+4),this.rolling[n-1]=s.rotation.x,this.brake&&(this.brake[n-1].position.copy(s.position),1!=n&&2!=n||(this.brake[n-1].rotation.y=e[h])));for(h=4;h--;)this.suspension[h]=l.clamp(o[h]*this.s_ratio,-1,1),this.suspensionMesh&&(this.suspension[h]>0?(x.morph(this.suspensionMesh[h].children[0],"low",this.suspension[h]),x.morph(this.suspensionMesh[h].children[0],"top",0)):(x.morph(this.suspensionMesh[h].children[0],"low",0),x.morph(this.suspensionMesh[h].children[0],"top",-this.suspension[h])));this.steering=Math.round(.5*(i+a)*n)/this.maxSteering}}const Ee={POSITION:["byte","byte normalized","unsigned byte","unsigned byte normalized","short","short normalized","unsigned short","unsigned short normalized"],NORMAL:["byte normalized","short normalized"],TANGENT:["byte normalized","short normalized"],TEXCOORD:["byte","byte normalized","unsigned byte","short","short normalized","unsigned short"]};class Pe{constructor(){this.pluginCallbacks=[],this.register((function(e){return new lt(e)})),this.register((function(e){return new ht(e)})),this.register((function(e){return new pt(e)})),this.register((function(e){return new dt(e)})),this.register((function(e){return new mt(e)})),this.register((function(e){return new ft(e)})),this.register((function(e){return new ct(e)})),this.register((function(e){return new ut(e)})),this.register((function(e){return new gt(e)})),this.register((function(e){return new yt(e)}))}register(e){return-1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this}unregister(e){return-1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,s,r){const i=new ot,n=[];for(let e=0,t=this.pluginCallbacks.length;e<t;e++)n.push(this.pluginCallbacks[e](i));i.setPlugins(n),i.write(e,t,r).catch(s)}parseAsync(e,t){const s=this;return new Promise((function(r,i){s.parse(e,r,i,t)}))}}const Ie=0,_e=1,Le=2,Ce=3,Fe=4,Be=5120,Oe=5121,ze=5122,De=5123,Ne=5124,Ue=5125,Ve=5126,je=34962,Ge=34963,He=9728,We=9729,qe=9984,Xe=9985,Ke=9986,Qe=9987,Ze=33071,Ye=33648,Je=10497,$e={};$e[t.NearestFilter]=He,$e[t.NearestMipmapNearestFilter]=qe,$e[t.NearestMipmapLinearFilter]=Ke,$e[t.LinearFilter]=We,$e[t.LinearMipmapNearestFilter]=Xe,$e[t.LinearMipmapLinearFilter]=Qe,$e[t.ClampToEdgeWrapping]=Ze,$e[t.RepeatWrapping]=Je,$e[t.MirroredRepeatWrapping]=Ye;const et={scale:"scale",position:"translation",quaternion:"rotation",morphTargetInfluences:"weights"},tt=new t.Color;function st(e,t){return e.length===t.length&&e.every((function(e,s){return e===t[s]}))}function rt(e){return 4*Math.ceil(e/4)}function it(e,t=0){const s=rt(e.byteLength);if(s!==e.byteLength){const r=new Uint8Array(s);if(r.set(new Uint8Array(e)),0!==t)for(let i=e.byteLength;i<s;i++)r[i]=t;return r.buffer}return e}function nt(){return"undefined"==typeof document&&"undefined"!=typeof OffscreenCanvas?new OffscreenCanvas(1,1):document.createElement("canvas")}function at(e,t){if(void 0!==e.toBlob)return new Promise((s=>e.toBlob(s,t)));let s;return"image/jpeg"===t?s=.92:"image/webp"===t&&(s=.8),e.convertToBlob({type:t,quality:s})}class ot{constructor(){this.plugins=[],this.options={},this.pending=[],this.buffers=[],this.byteOffset=0,this.buffers=[],this.nodeMap=new Map,this.skins=[],this.extensionsUsed={},this.extensionsRequired={},this.uids=new Map,this.uid=0,this.json={asset:{version:"2.0",generator:"THREE.GLTFExporter"}},this.cache={meshes:new Map,attributes:new Map,attributesNormalized:new Map,materials:new Map,textures:new Map,images:new Map}}setPlugins(e){this.plugins=e}async write(e,t,s={}){this.options=Object.assign({binary:!1,trs:!1,onlyVisible:!0,maxTextureSize:1/0,animations:[],includeCustomExtensions:!1},s),this.options.animations.length>0&&(this.options.trs=!0),this.processInput(e),await Promise.all(this.pending);const r=this,i=r.buffers,n=r.json;s=r.options;const a=r.extensionsUsed,o=r.extensionsRequired,l=new Blob(i,{type:"application/octet-stream"}),h=Object.keys(a),c=Object.keys(o);if(h.length>0&&(n.extensionsUsed=h),c.length>0&&(n.extensionsRequired=c),n.buffers&&n.buffers.length>0&&(n.buffers[0].byteLength=l.size),!0===s.binary){const e=new FileReader;e.readAsArrayBuffer(l),e.onloadend=function(){const s=it(e.result),r=new DataView(new ArrayBuffer(8));r.setUint32(0,s.byteLength,!0),r.setUint32(4,5130562,!0);const i=it((a=JSON.stringify(n),(new TextEncoder).encode(a).buffer),32);var a;const o=new DataView(new ArrayBuffer(8));o.setUint32(0,i.byteLength,!0),o.setUint32(4,1313821514,!0);const l=new ArrayBuffer(12),h=new DataView(l);h.setUint32(0,1179937895,!0),h.setUint32(4,2,!0);const c=12+o.byteLength+i.byteLength+r.byteLength+s.byteLength;h.setUint32(8,c,!0);const u=new Blob([l,o,i,r,s],{type:"application/octet-stream"}),p=new FileReader;p.readAsArrayBuffer(u),p.onloadend=function(){t(p.result)}}}else if(n.buffers&&n.buffers.length>0){const e=new FileReader;e.readAsDataURL(l),e.onloadend=function(){const s=e.result;n.buffers[0].uri=s,t(n)}}else t(n)}serializeUserData(e,t){if(0===Object.keys(e.userData).length)return;const s=this.options,r=this.extensionsUsed;try{const i=JSON.parse(JSON.stringify(e.userData));if(s.includeCustomExtensions&&i.gltfExtensions){void 0===t.extensions&&(t.extensions={});for(const e in i.gltfExtensions)t.extensions[e]=i.gltfExtensions[e],r[e]=!0;delete i.gltfExtensions}Object.keys(i).length>0&&(t.extras=i)}catch(t){console.warn("THREE.GLTFExporter: userData of '"+e.name+"' won't be serialized because of JSON.stringify error - "+t.message)}}getUID(e,t=!1){if(!1===this.uids.has(e)){const t=new Map;t.set(!0,this.uid++),t.set(!1,this.uid++),this.uids.set(e,t)}return this.uids.get(e).get(t)}isNormalizedNormalAttribute(e){if(this.cache.attributesNormalized.has(e))return!1;const s=new t.Vector3;for(let t=0,r=e.count;t<r;t++)if(Math.abs(s.fromBufferAttribute(e,t).length()-1)>5e-4)return!1;return!0}createNormalizedNormalAttribute(e){const s=this.cache;if(s.attributesNormalized.has(e))return s.attributesNormalized.get(e);const r=e.clone(),i=new t.Vector3;for(let e=0,t=r.count;e<t;e++)i.fromBufferAttribute(r,e),0===i.x&&0===i.y&&0===i.z?i.setX(1):i.normalize(),r.setXYZ(e,i.x,i.y,i.z);return s.attributesNormalized.set(e,r),r}applyTextureTransform(e,t){let s=!1;const r={};0===t.offset.x&&0===t.offset.y||(r.offset=t.offset.toArray(),s=!0),0!==t.rotation&&(r.rotation=t.rotation,s=!0),1===t.repeat.x&&1===t.repeat.y||(r.scale=t.repeat.toArray(),s=!0),s&&(e.extensions=e.extensions||{},e.extensions.KHR_texture_transform=r,this.extensionsUsed.KHR_texture_transform=!0)}buildMetalRoughTexture(e,s){if(e===s)return e;function r(e){return e.encoding===t.sRGBEncoding?function(e){return e<.04045?.0773993808*e:Math.pow(.9478672986*e+.0521327014,2.4)}:function(e){return e}}console.warn("THREE.GLTFExporter: Merged metalnessMap and roughnessMap textures.");const i=e?e.image:null,n=s?s.image:null,a=Math.max(i?i.width:0,n?n.width:0),o=Math.max(i?i.height:0,n?n.height:0),l=nt();l.width=a,l.height=o;const h=l.getContext("2d");h.fillStyle="#00ffff",h.fillRect(0,0,a,o);const c=h.getImageData(0,0,a,o);if(i){h.drawImage(i,0,0,a,o);const t=r(e),s=h.getImageData(0,0,a,o).data;for(let e=2;e<s.length;e+=4)c.data[e]=256*t(s[e]/256)}if(n){h.drawImage(n,0,0,a,o);const e=r(s),t=h.getImageData(0,0,a,o).data;for(let s=1;s<t.length;s+=4)c.data[s]=256*e(t[s]/256)}h.putImageData(c,0,0);const u=(e||s).clone();return u.source=new t.Source(l),u.encoding=t.LinearEncoding,u}processBuffer(e){const t=this.json,s=this.buffers;return t.buffers||(t.buffers=[{byteLength:0}]),s.push(e),0}processBufferView(e,s,r,i,n){const a=this.json;let o;switch(a.bufferViews||(a.bufferViews=[]),s){case Be:case Oe:o=1;break;case ze:case De:o=2;break;default:o=4}const l=rt(i*e.itemSize*o),h=new DataView(new ArrayBuffer(l));let c=0;for(let n=r;n<r+i;n++)for(let r=0;r<e.itemSize;r++){let i;e.itemSize>4?i=e.array[n*e.itemSize+r]:(0===r?i=e.getX(n):1===r?i=e.getY(n):2===r?i=e.getZ(n):3===r&&(i=e.getW(n)),!0===e.normalized&&(i=t.MathUtils.normalize(i,e.array))),s===Ve?h.setFloat32(c,i,!0):s===Ne?h.setInt32(c,i,!0):s===Ue?h.setUint32(c,i,!0):s===ze?h.setInt16(c,i,!0):s===De?h.setUint16(c,i,!0):s===Be?h.setInt8(c,i):s===Oe&&h.setUint8(c,i),c+=o}const u={buffer:this.processBuffer(h.buffer),byteOffset:this.byteOffset,byteLength:l};void 0!==n&&(u.target=n),n===je&&(u.byteStride=e.itemSize*o),this.byteOffset+=l,a.bufferViews.push(u);return{id:a.bufferViews.length-1,byteLength:0}}processBufferViewImage(e){const t=this,s=t.json;return s.bufferViews||(s.bufferViews=[]),new Promise((function(r){const i=new FileReader;i.readAsArrayBuffer(e),i.onloadend=function(){const e=it(i.result),n={buffer:t.processBuffer(e),byteOffset:t.byteOffset,byteLength:e.byteLength};t.byteOffset+=e.byteLength,r(s.bufferViews.push(n)-1)}}))}processAccessor(e,s,r,i){const n=this.json;let a;if(e.array.constructor===Float32Array)a=Ve;else if(e.array.constructor===Int32Array)a=Ne;else if(e.array.constructor===Uint32Array)a=Ue;else if(e.array.constructor===Int16Array)a=ze;else if(e.array.constructor===Uint16Array)a=De;else if(e.array.constructor===Int8Array)a=Be;else{if(e.array.constructor!==Uint8Array)throw new Error("THREE.GLTFExporter: Unsupported bufferAttribute component type.");a=Oe}if(void 0===r&&(r=0),void 0===i&&(i=e.count),0===i)return null;const o=function(e,s,r){const i={min:new Array(e.itemSize).fill(Number.POSITIVE_INFINITY),max:new Array(e.itemSize).fill(Number.NEGATIVE_INFINITY)};for(let n=s;n<s+r;n++)for(let s=0;s<e.itemSize;s++){let r;e.itemSize>4?r=e.array[n*e.itemSize+s]:(0===s?r=e.getX(n):1===s?r=e.getY(n):2===s?r=e.getZ(n):3===s&&(r=e.getW(n)),!0===e.normalized&&(r=t.MathUtils.normalize(r,e.array))),i.min[s]=Math.min(i.min[s],r),i.max[s]=Math.max(i.max[s],r)}return i}(e,r,i);let l;void 0!==s&&(l=e===s.index?Ge:je);const h=this.processBufferView(e,a,r,i,l),c={bufferView:h.id,byteOffset:h.byteOffset,componentType:a,count:i,max:o.max,min:o.min,type:{1:"SCALAR",2:"VEC2",3:"VEC3",4:"VEC4",9:"MAT3",16:"MAT4"}[e.itemSize]};return!0===e.normalized&&(c.normalized=!0),n.accessors||(n.accessors=[]),n.accessors.push(c)-1}processImage(e,s,r,i="image/png"){if(null!==e){const n=this,a=n.cache,o=n.json,l=n.options,h=n.pending;a.images.has(e)||a.images.set(e,{});const c=a.images.get(e),u=i+":flipY/"+r.toString();if(void 0!==c[u])return c[u];o.images||(o.images=[]);const p={mimeType:i},d=nt();d.width=Math.min(e.width,l.maxTextureSize),d.height=Math.min(e.height,l.maxTextureSize);const m=d.getContext("2d");if(!0===r&&(m.translate(0,d.height),m.scale(1,-1)),void 0!==e.data){s!==t.RGBAFormat&&console.error("GLTFExporter: Only RGBAFormat is supported."),(e.width>l.maxTextureSize||e.height>l.maxTextureSize)&&console.warn("GLTFExporter: Image size is bigger than maxTextureSize",e);const r=new Uint8ClampedArray(e.height*e.width*4);for(let t=0;t<r.length;t+=4)r[t+0]=e.data[t+0],r[t+1]=e.data[t+1],r[t+2]=e.data[t+2],r[t+3]=e.data[t+3];m.putImageData(new ImageData(r,e.width,e.height),0,0)}else m.drawImage(e,0,0,d.width,d.height);!0===l.binary?h.push(at(d,i).then((e=>n.processBufferViewImage(e))).then((e=>{p.bufferView=e}))):void 0!==d.toDataURL?p.uri=d.toDataURL(i):h.push(at(d,i).then((e=>(new FileReader).readAsDataURL(e))).then((e=>{p.uri=e})));const f=o.images.push(p)-1;return c[u]=f,f}throw new Error("THREE.GLTFExporter: No valid image data found. Unable to process texture.")}processSampler(e){const t=this.json;t.samplers||(t.samplers=[]);const s={magFilter:$e[e.magFilter],minFilter:$e[e.minFilter],wrapS:$e[e.wrapS],wrapT:$e[e.wrapT]};return t.samplers.push(s)-1}processTexture(e){const t=this.cache,s=this.json;if(t.textures.has(e))return t.textures.get(e);s.textures||(s.textures=[]);let r=e.userData.mimeType;"image/webp"===r&&(r="image/png");const i={sampler:this.processSampler(e),source:this.processImage(e.image,e.format,e.flipY,r)};e.name&&(i.name=e.name),this._invokeAll((function(t){t.writeTexture&&t.writeTexture(e,i)}));const n=s.textures.push(i)-1;return t.textures.set(e,n),n}processMaterial(e){const s=this.cache,r=this.json;if(s.materials.has(e))return s.materials.get(e);if(e.isShaderMaterial)return console.warn("GLTFExporter: THREE.ShaderMaterial not supported."),null;r.materials||(r.materials=[]);const i={pbrMetallicRoughness:{}};!0!==e.isMeshStandardMaterial&&!0!==e.isMeshBasicMaterial&&console.warn("GLTFExporter: Use MeshStandardMaterial or MeshBasicMaterial for best results.");const n=e.color.toArray().concat([e.opacity]);if(st(n,[1,1,1,1])||(i.pbrMetallicRoughness.baseColorFactor=n),e.isMeshStandardMaterial?(i.pbrMetallicRoughness.metallicFactor=e.metalness,i.pbrMetallicRoughness.roughnessFactor=e.roughness):(i.pbrMetallicRoughness.metallicFactor=.5,i.pbrMetallicRoughness.roughnessFactor=.5),e.metalnessMap||e.roughnessMap){const t=this.buildMetalRoughTexture(e.metalnessMap,e.roughnessMap),s={index:this.processTexture(t)};this.applyTextureTransform(s,t),i.pbrMetallicRoughness.metallicRoughnessTexture=s}if(e.map){const t={index:this.processTexture(e.map)};this.applyTextureTransform(t,e.map),i.pbrMetallicRoughness.baseColorTexture=t}if(e.emissive){const t=e.emissive;if(Math.max(t.r,t.g,t.b)>0&&(i.emissiveFactor=e.emissive.toArray()),e.emissiveMap){const t={index:this.processTexture(e.emissiveMap)};this.applyTextureTransform(t,e.emissiveMap),i.emissiveTexture=t}}if(e.normalMap){const t={index:this.processTexture(e.normalMap)};e.normalScale&&1!==e.normalScale.x&&(t.scale=e.normalScale.x),this.applyTextureTransform(t,e.normalMap),i.normalTexture=t}if(e.aoMap){const t={index:this.processTexture(e.aoMap),texCoord:1};1!==e.aoMapIntensity&&(t.strength=e.aoMapIntensity),this.applyTextureTransform(t,e.aoMap),i.occlusionTexture=t}e.transparent?i.alphaMode="BLEND":e.alphaTest>0&&(i.alphaMode="MASK",i.alphaCutoff=e.alphaTest),e.side===t.DoubleSide&&(i.doubleSided=!0),""!==e.name&&(i.name=e.name),this.serializeUserData(e,i),this._invokeAll((function(t){t.writeMaterial&&t.writeMaterial(e,i)}));const a=r.materials.push(i)-1;return s.materials.set(e,a),a}processMesh(e){const s=this.cache,r=this.json,i=[e.geometry.uuid];if(Array.isArray(e.material))for(let t=0,s=e.material.length;t<s;t++)i.push(e.material[t].uuid);else i.push(e.material.uuid);const n=i.join(":");if(s.meshes.has(n))return s.meshes.get(n);const a=e.geometry;let o;o=e.isLineSegments?_e:e.isLineLoop?Le:e.isLine?Ce:e.isPoints?Ie:e.material.wireframe?_e:Fe;const l={},h={},c=[],u=[],p={uv:"TEXCOORD_0",uv2:"TEXCOORD_1",color:"COLOR_0",skinWeight:"WEIGHTS_0",skinIndex:"JOINTS_0"},d=a.getAttribute("normal");void 0===d||this.isNormalizedNormalAttribute(d)||(console.warn("THREE.GLTFExporter: Creating normalized normal attribute from the non-normalized one."),a.setAttribute("normal",this.createNormalizedNormalAttribute(d)));let m=null;for(let e in a.attributes){if("morph"===e.slice(0,5))continue;const r=a.attributes[e];e=p[e]||e.toUpperCase();if(/^(POSITION|NORMAL|TANGENT|TEXCOORD_\d+|COLOR_\d+|JOINTS_\d+|WEIGHTS_\d+)$/.test(e)||(e="_"+e),s.attributes.has(this.getUID(r))){h[e]=s.attributes.get(this.getUID(r));continue}m=null;const i=r.array;"JOINTS_0"!==e||i instanceof Uint16Array||i instanceof Uint8Array||(console.warn('GLTFExporter: Attribute "skinIndex" converted to type UNSIGNED_SHORT.'),m=new t.BufferAttribute(new Uint16Array(i),r.itemSize,r.normalized));const n=this.processAccessor(m||r,a);null!==n&&(e.startsWith("_")||this.detectMeshQuantization(e,r),h[e]=n,s.attributes.set(this.getUID(r),n))}if(void 0!==d&&a.setAttribute("normal",d),0===Object.keys(h).length)return null;if(void 0!==e.morphTargetInfluences&&e.morphTargetInfluences.length>0){const t=[],r=[],i={};if(void 0!==e.morphTargetDictionary)for(const t in e.morphTargetDictionary)i[e.morphTargetDictionary[t]]=t;for(let n=0;n<e.morphTargetInfluences.length;++n){const o={};let l=!1;for(const e in a.morphAttributes){if("position"!==e&&"normal"!==e){l||(console.warn("GLTFExporter: Only POSITION and NORMAL morph are supported."),l=!0);continue}const t=a.morphAttributes[e][n],r=e.toUpperCase(),i=a.attributes[e];if(s.attributes.has(this.getUID(t,!0))){o[r]=s.attributes.get(this.getUID(t,!0));continue}const h=t.clone();if(!a.morphTargetsRelative)for(let e=0,s=t.count;e<s;e++)for(let s=0;s<t.itemSize;s++)0===s&&h.setX(e,t.getX(e)-i.getX(e)),1===s&&h.setY(e,t.getY(e)-i.getY(e)),2===s&&h.setZ(e,t.getZ(e)-i.getZ(e)),3===s&&h.setW(e,t.getW(e)-i.getW(e));o[r]=this.processAccessor(h,a),s.attributes.set(this.getUID(i,!0),o[r])}u.push(o),t.push(e.morphTargetInfluences[n]),void 0!==e.morphTargetDictionary&&r.push(i[n])}l.weights=t,r.length>0&&(l.extras={},l.extras.targetNames=r)}const f=Array.isArray(e.material);if(f&&0===a.groups.length)return null;const g=f?e.material:[e.material],y=f?a.groups:[{materialIndex:0,start:void 0,count:void 0}];for(let e=0,t=y.length;e<t;e++){const t={mode:o,attributes:h};if(this.serializeUserData(a,t),u.length>0&&(t.targets=u),null!==a.index){let r=this.getUID(a.index);void 0===y[e].start&&void 0===y[e].count||(r+=":"+y[e].start+":"+y[e].count),s.attributes.has(r)?t.indices=s.attributes.get(r):(t.indices=this.processAccessor(a.index,a,y[e].start,y[e].count),s.attributes.set(r,t.indices)),null===t.indices&&delete t.indices}const r=this.processMaterial(g[y[e].materialIndex]);null!==r&&(t.material=r),c.push(t)}l.primitives=c,r.meshes||(r.meshes=[]),this._invokeAll((function(t){t.writeMesh&&t.writeMesh(e,l)}));const b=r.meshes.push(l)-1;return s.meshes.set(n,b),b}detectMeshQuantization(e,t){if(this.extensionsUsed.KHR_mesh_quantization)return;let s;switch(t.array.constructor){case Int8Array:s="byte";break;case Uint8Array:s="unsigned byte";break;case Int16Array:s="short";break;case Uint16Array:s="unsigned short";break;default:return}t.normalized&&(s+=" normalized");const r=e.split("_",1)[0];Ee[r]&&Ee[r].includes(s)&&(this.extensionsUsed.KHR_mesh_quantization=!0,this.extensionsRequired.KHR_mesh_quantization=!0)}processCamera(e){const s=this.json;s.cameras||(s.cameras=[]);const r=e.isOrthographicCamera,i={type:r?"orthographic":"perspective"};return r?i.orthographic={xmag:2*e.right,ymag:2*e.top,zfar:e.far<=0?.001:e.far,znear:e.near<0?0:e.near}:i.perspective={aspectRatio:e.aspect,yfov:t.MathUtils.degToRad(e.fov),zfar:e.far<=0?.001:e.far,znear:e.near<0?0:e.near},""!==e.name&&(i.name=e.type),s.cameras.push(i)-1}processAnimation(e,s){const r=this.json,i=this.nodeMap;r.animations||(r.animations=[]);const n=(e=Pe.Utils.mergeMorphTargetTracks(e.clone(),s)).tracks,a=[],o=[];for(let e=0;e<n.length;++e){const r=n[e],l=t.PropertyBinding.parseTrackName(r.name);let h=t.PropertyBinding.findNode(s,l.nodeName);const c=et[l.propertyName];if("bones"===l.objectName&&(h=!0===h.isSkinnedMesh?h.skeleton.getBoneByName(l.objectIndex):void 0),!h||!c)return console.warn('THREE.GLTFExporter: Could not export animation track "%s".',r.name),null;const u=1;let p,d=r.values.length/r.times.length;c===et.morphTargetInfluences&&(d/=h.morphTargetInfluences.length),!0===r.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline?(p="CUBICSPLINE",d/=3):p=r.getInterpolation()===t.InterpolateDiscrete?"STEP":"LINEAR",o.push({input:this.processAccessor(new t.BufferAttribute(r.times,u)),output:this.processAccessor(new t.BufferAttribute(r.values,d)),interpolation:p}),a.push({sampler:o.length-1,target:{node:i.get(h),path:c}})}return r.animations.push({name:e.name||"clip_"+r.animations.length,samplers:o,channels:a}),r.animations.length-1}processSkin(e){const s=this.json,r=this.nodeMap,i=s.nodes[r.get(e)],n=e.skeleton;if(void 0===n)return null;const a=e.skeleton.bones[0];if(void 0===a)return null;const o=[],l=new Float32Array(16*n.bones.length),h=new t.Matrix4;for(let t=0;t<n.bones.length;++t)o.push(r.get(n.bones[t])),h.copy(n.boneInverses[t]),h.multiply(e.bindMatrix).toArray(l,16*t);void 0===s.skins&&(s.skins=[]),s.skins.push({inverseBindMatrices:this.processAccessor(new t.BufferAttribute(l,16)),joints:o,skeleton:r.get(a)});return i.skin=s.skins.length-1}processNode(e){const t=this.json,s=this.options,r=this.nodeMap;t.nodes||(t.nodes=[]);const i={};if(s.trs){const t=e.quaternion.toArray(),s=e.position.toArray(),r=e.scale.toArray();st(t,[0,0,0,1])||(i.rotation=t),st(s,[0,0,0])||(i.translation=s),st(r,[1,1,1])||(i.scale=r)}else e.matrixAutoUpdate&&e.updateMatrix(),!1===st(e.matrix.elements,[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])&&(i.matrix=e.matrix.elements);if(""!==e.name&&(i.name=String(e.name)),this.serializeUserData(e,i),e.isMesh||e.isLine||e.isPoints){const t=this.processMesh(e);null!==t&&(i.mesh=t)}else e.isCamera&&(i.camera=this.processCamera(e));if(e.isSkinnedMesh&&this.skins.push(e),e.children.length>0){const t=[];for(let r=0,i=e.children.length;r<i;r++){const i=e.children[r];if(i.visible||!1===s.onlyVisible){const e=this.processNode(i);null!==e&&t.push(e)}}t.length>0&&(i.children=t)}this._invokeAll((function(t){t.writeNode&&t.writeNode(e,i)}));const n=t.nodes.push(i)-1;return r.set(e,n),n}processScene(e){const t=this.json,s=this.options;t.scenes||(t.scenes=[],t.scene=0);const r={};""!==e.name&&(r.name=e.name),t.scenes.push(r);const i=[];for(let t=0,r=e.children.length;t<r;t++){const r=e.children[t];if(r.visible||!1===s.onlyVisible){const e=this.processNode(r);null!==e&&i.push(e)}}i.length>0&&(r.nodes=i),this.serializeUserData(e,r)}processObjects(e){const s=new t.Scene;s.name="AuxScene";for(let t=0;t<e.length;t++)s.children.push(e[t]);this.processScene(s)}processInput(e){const s=this.options;e=e instanceof Array?e:[e],this._invokeAll((function(t){t.beforeParse&&t.beforeParse(e)}));const r=[];for(let s=0;s<e.length;s++)e[s]instanceof t.Scene?this.processScene(e[s]):r.push(e[s]);r.length>0&&this.processObjects(r);for(let e=0;e<this.skins.length;++e)this.processSkin(this.skins[e]);for(let t=0;t<s.animations.length;++t)this.processAnimation(s.animations[t],e[0]);this._invokeAll((function(t){t.afterParse&&t.afterParse(e)}))}_invokeAll(e){for(let t=0,s=this.plugins.length;t<s;t++)e(this.plugins[t])}}class lt{constructor(e){this.writer=e,this.name="KHR_lights_punctual"}writeNode(e,t){if(!e.isLight)return;if(!e.isDirectionalLight&&!e.isPointLight&&!e.isSpotLight)return void console.warn("THREE.GLTFExporter: Only directional, point, and spot lights are supported.",e);const s=this.writer,r=s.json,i=s.extensionsUsed,n={};e.name&&(n.name=e.name),n.color=e.color.toArray(),n.intensity=e.intensity,e.isDirectionalLight?n.type="directional":e.isPointLight?(n.type="point",e.distance>0&&(n.range=e.distance)):e.isSpotLight&&(n.type="spot",e.distance>0&&(n.range=e.distance),n.spot={},n.spot.innerConeAngle=(e.penumbra-1)*e.angle*-1,n.spot.outerConeAngle=e.angle),void 0!==e.decay&&2!==e.decay&&console.warn("THREE.GLTFExporter: Light decay may be lost. glTF is physically-based, and expects light.decay=2."),!e.target||e.target.parent===e&&0===e.target.position.x&&0===e.target.position.y&&-1===e.target.position.z||console.warn("THREE.GLTFExporter: Light direction may be lost. For best results, make light.target a child of the light with position 0,0,-1."),i[this.name]||(r.extensions=r.extensions||{},r.extensions[this.name]={lights:[]},i[this.name]=!0);const a=r.extensions[this.name].lights;a.push(n),t.extensions=t.extensions||{},t.extensions[this.name]={light:a.length-1}}}class ht{constructor(e){this.writer=e,this.name="KHR_materials_unlit"}writeMaterial(e,t){if(!e.isMeshBasicMaterial)return;const s=this.writer.extensionsUsed;t.extensions=t.extensions||{},t.extensions[this.name]={},s[this.name]=!0,t.pbrMetallicRoughness.metallicFactor=0,t.pbrMetallicRoughness.roughnessFactor=.9}}class ct{constructor(e){this.writer=e,this.name="KHR_materials_clearcoat"}writeMaterial(e,t){if(!e.isMeshPhysicalMaterial||0===e.clearcoat)return;const s=this.writer,r=s.extensionsUsed,i={};if(i.clearcoatFactor=e.clearcoat,e.clearcoatMap){const t={index:s.processTexture(e.clearcoatMap)};s.applyTextureTransform(t,e.clearcoatMap),i.clearcoatTexture=t}if(i.clearcoatRoughnessFactor=e.clearcoatRoughness,e.clearcoatRoughnessMap){const t={index:s.processTexture(e.clearcoatRoughnessMap)};s.applyTextureTransform(t,e.clearcoatRoughnessMap),i.clearcoatRoughnessTexture=t}if(e.clearcoatNormalMap){const t={index:s.processTexture(e.clearcoatNormalMap)};s.applyTextureTransform(t,e.clearcoatNormalMap),i.clearcoatNormalTexture=t}t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}}class ut{constructor(e){this.writer=e,this.name="KHR_materials_iridescence"}writeMaterial(e,t){if(!e.isMeshPhysicalMaterial||0===e.iridescence)return;const s=this.writer,r=s.extensionsUsed,i={};if(i.iridescenceFactor=e.iridescence,e.iridescenceMap){const t={index:s.processTexture(e.iridescenceMap)};s.applyTextureTransform(t,e.iridescenceMap),i.iridescenceTexture=t}if(i.iridescenceIor=e.iridescenceIOR,i.iridescenceThicknessMinimum=e.iridescenceThicknessRange[0],i.iridescenceThicknessMaximum=e.iridescenceThicknessRange[1],e.iridescenceThicknessMap){const t={index:s.processTexture(e.iridescenceThicknessMap)};s.applyTextureTransform(t,e.iridescenceThicknessMap),i.iridescenceThicknessTexture=t}t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}}class pt{constructor(e){this.writer=e,this.name="KHR_materials_transmission"}writeMaterial(e,t){if(!e.isMeshPhysicalMaterial||0===e.transmission)return;const s=this.writer,r=s.extensionsUsed,i={};if(i.transmissionFactor=e.transmission,e.transmissionMap){const t={index:s.processTexture(e.transmissionMap)};s.applyTextureTransform(t,e.transmissionMap),i.transmissionTexture=t}t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}}class dt{constructor(e){this.writer=e,this.name="KHR_materials_volume"}writeMaterial(e,t){if(!e.isMeshPhysicalMaterial||0===e.transmission)return;const s=this.writer,r=s.extensionsUsed,i={};if(i.thicknessFactor=e.thickness,e.thicknessMap){const t={index:s.processTexture(e.thicknessMap)};s.applyTextureTransform(t,e.thicknessMap),i.thicknessTexture=t}i.attenuationDistance=e.attenuationDistance,i.attenuationColor=e.attenuationColor.toArray(),t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}}class mt{constructor(e){this.writer=e,this.name="KHR_materials_ior"}writeMaterial(e,t){if(!e.isMeshPhysicalMaterial||1.5===e.ior)return;const s=this.writer.extensionsUsed,r={};r.ior=e.ior,t.extensions=t.extensions||{},t.extensions[this.name]=r,s[this.name]=!0}}class ft{constructor(e){this.writer=e,this.name="KHR_materials_specular"}writeMaterial(e,t){if(!e.isMeshPhysicalMaterial||1===e.specularIntensity&&e.specularColor.equals(tt)&&!e.specularIntensityMap&&!e.specularColorTexture)return;const s=this.writer,r=s.extensionsUsed,i={};if(e.specularIntensityMap){const t={index:s.processTexture(e.specularIntensityMap)};s.applyTextureTransform(t,e.specularIntensityMap),i.specularTexture=t}if(e.specularColorMap){const t={index:s.processTexture(e.specularColorMap)};s.applyTextureTransform(t,e.specularColorMap),i.specularColorTexture=t}i.specularFactor=e.specularIntensity,i.specularColorFactor=e.specularColor.toArray(),t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}}class gt{constructor(e){this.writer=e,this.name="KHR_materials_sheen"}writeMaterial(e,t){if(!e.isMeshPhysicalMaterial||0==e.sheen)return;const s=this.writer,r=s.extensionsUsed,i={};if(e.sheenRoughnessMap){const t={index:s.processTexture(e.sheenRoughnessMap)};s.applyTextureTransform(t,e.sheenRoughnessMap),i.sheenRoughnessTexture=t}if(e.sheenColorMap){const t={index:s.processTexture(e.sheenColorMap)};s.applyTextureTransform(t,e.sheenColorMap),i.sheenColorTexture=t}i.sheenRoughnessFactor=e.sheenRoughness,i.sheenColorFactor=e.sheenColor.toArray(),t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}}class yt{constructor(e){this.writer=e,this.name="KHR_materials_emissive_strength"}writeMaterial(e,t){if(!e.isMeshStandardMaterial||1===e.emissiveIntensity)return;const s=this.writer.extensionsUsed,r={};r.emissiveStrength=e.emissiveIntensity,t.extensions=t.extensions||{},t.extensions[this.name]=r,s[this.name]=!0}}function bt(e){const t=new Map,s=new Map,r=e.clone();return xt(e,r,(function(e,r){t.set(r,e),s.set(e,r)})),r.traverse((function(e){if(!e.isSkinnedMesh)return;const r=e,i=t.get(e),n=i.skeleton.bones;r.skeleton=i.skeleton.clone(),r.bindMatrix.copy(i.bindMatrix),r.skeleton.bones=n.map((function(e){return s.get(e)})),r.bind(r.skeleton,r.bindMatrix)})),r}function xt(e,t,s){s(e,t);for(let r=0;r<e.children.length;r++)xt(e.children[r],t.children[r],s)}Pe.Utils={insertKeyframe:function(e,t){const s=.001,r=e.getValueSize(),i=new e.TimeBufferType(e.times.length+1),n=new e.ValueBufferType(e.values.length+r),a=e.createInterpolant(new e.ValueBufferType(r));let o;if(0===e.times.length){i[0]=t;for(let e=0;e<r;e++)n[e]=0;o=0}else if(t<e.times[0]){if(Math.abs(e.times[0]-t)<s)return 0;i[0]=t,i.set(e.times,1),n.set(a.evaluate(t),0),n.set(e.values,r),o=0}else if(t>e.times[e.times.length-1]){if(Math.abs(e.times[e.times.length-1]-t)<s)return e.times.length-1;i[i.length-1]=t,i.set(e.times,0),n.set(e.values,0),n.set(a.evaluate(t),e.values.length),o=i.length-1}else for(let l=0;l<e.times.length;l++){if(Math.abs(e.times[l]-t)<s)return l;if(e.times[l]<t&&e.times[l+1]>t){i.set(e.times.slice(0,l+1),0),i[l+1]=t,i.set(e.times.slice(l+1),l+2),n.set(e.values.slice(0,(l+1)*r),0),n.set(a.evaluate(t),(l+1)*r),n.set(e.values.slice((l+1)*r),(l+2)*r),o=l+1;break}}return e.times=i,e.values=n,o},mergeMorphTargetTracks:function(e,s){const r=[],i={},n=e.tracks;for(let e=0;e<n.length;++e){let a=n[e];const o=t.PropertyBinding.parseTrackName(a.name),l=t.PropertyBinding.findNode(s,o.nodeName);if("morphTargetInfluences"!==o.propertyName||void 0===o.propertyIndex){r.push(a);continue}if(a.createInterpolant!==a.InterpolantFactoryMethodDiscrete&&a.createInterpolant!==a.InterpolantFactoryMethodLinear){if(a.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline)throw new Error("THREE.GLTFExporter: Cannot merge tracks with glTF CUBICSPLINE interpolation.");console.warn("THREE.GLTFExporter: Morph target interpolation mode not yet supported. Using LINEAR instead."),a=a.clone(),a.setInterpolation(t.InterpolateLinear)}const h=l.morphTargetInfluences.length,c=l.morphTargetDictionary[o.propertyIndex];if(void 0===c)throw new Error("THREE.GLTFExporter: Morph target name not found: "+o.propertyIndex);let u;if(void 0===i[l.uuid]){u=a.clone();const e=new u.ValueBufferType(h*u.times.length);for(let t=0;t<u.times.length;t++)e[t*h+c]=u.values[t];u.name=(o.nodeName||"")+".morphTargetInfluences",u.values=e,i[l.uuid]=u,r.push(u);continue}const p=a.createInterpolant(new a.ValueBufferType(1));u=i[l.uuid];for(let e=0;e<u.times.length;e++)u.values[e*h+c]=p.evaluate(u.times[e]);for(let e=0;e<a.times.length;e++){const t=this.insertKeyframe(u,a.times[e]);u.values[t*h+c]=a.values[e]}}return e.tracks=r,e}};class vt extends t.Loader{constructor(e){super(e),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register((function(e){return new kt(e)})),this.register((function(e){return new Ft(e)})),this.register((function(e){return new Bt(e)})),this.register((function(e){return new Ot(e)})),this.register((function(e){return new Et(e)})),this.register((function(e){return new Pt(e)})),this.register((function(e){return new It(e)})),this.register((function(e){return new _t(e)})),this.register((function(e){return new St(e)})),this.register((function(e){return new Lt(e)})),this.register((function(e){return new Rt(e)})),this.register((function(e){return new Ct(e)})),this.register((function(e){return new At(e)})),this.register((function(e){return new zt(e)})),this.register((function(e){return new Dt(e)}))}load(e,s,r,i){const n=this;let a;a=""!==this.resourcePath?this.resourcePath:""!==this.path?this.path:t.LoaderUtils.extractUrlBase(e),this.manager.itemStart(e);const o=function(t){i?i(t):console.error(t),n.manager.itemError(e),n.manager.itemEnd(e)},l=new t.FileLoader(this.manager);l.setPath(this.path),l.setResponseType("arraybuffer"),l.setRequestHeader(this.requestHeader),l.setWithCredentials(this.withCredentials),l.load(e,(function(t){try{n.parse(t,a,(function(t){s(t),n.manager.itemEnd(e)}),o)}catch(e){o(e)}}),r,o)}setDRACOLoader(e){return this.dracoLoader=e,this}setDDSLoader(){throw new Error('THREE.GLTFLoader: "MSFT_texture_dds" no longer supported. Please update to "KHR_texture_basisu".')}setKTX2Loader(e){return this.ktx2Loader=e,this}setMeshoptDecoder(e){return this.meshoptDecoder=e,this}register(e){return-1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this}unregister(e){return-1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,s,r){let i;const n={},a={},o=new TextDecoder;if("string"==typeof e)i=JSON.parse(e);else if(e instanceof ArrayBuffer){if(o.decode(new Uint8Array(e,0,4))===Nt){try{n[Mt.KHR_BINARY_GLTF]=new jt(e)}catch(e){return void(r&&r(e))}i=JSON.parse(n[Mt.KHR_BINARY_GLTF].content)}else i=JSON.parse(o.decode(e))}else i=e;if(void 0===i.asset||i.asset.version[0]<2)return void(r&&r(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported.")));const l=new ds(i,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});l.fileLoader.setRequestHeader(this.requestHeader);for(let e=0;e<this.pluginCallbacks.length;e++){const t=this.pluginCallbacks[e](l);a[t.name]=t,n[t.name]=!0}if(i.extensionsUsed)for(let e=0;e<i.extensionsUsed.length;++e){const t=i.extensionsUsed[e],s=i.extensionsRequired||[];switch(t){case Mt.KHR_MATERIALS_UNLIT:n[t]=new Tt;break;case Mt.KHR_DRACO_MESH_COMPRESSION:n[t]=new Gt(i,this.dracoLoader);break;case Mt.KHR_TEXTURE_TRANSFORM:n[t]=new Ht;break;case Mt.KHR_MESH_QUANTIZATION:n[t]=new Wt;break;default:s.indexOf(t)>=0&&void 0===a[t]&&console.warn('THREE.GLTFLoader: Unknown extension "'+t+'".')}}l.setExtensions(n),l.setPlugins(a),l.parse(s,r)}parseAsync(e,t){const s=this;return new Promise((function(r,i){s.parse(e,t,r,i)}))}}function wt(){let e={};return{get:function(t){return e[t]},add:function(t,s){e[t]=s},remove:function(t){delete e[t]},removeAll:function(){e={}}}}const Mt={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_IRIDESCENCE:"KHR_materials_iridescence",KHR_MATERIALS_ANISOTROPY:"KHR_materials_anisotropy",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",KHR_MATERIALS_EMISSIVE_STRENGTH:"KHR_materials_emissive_strength",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_TEXTURE_AVIF:"EXT_texture_avif",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression",EXT_MESH_GPU_INSTANCING:"EXT_mesh_gpu_instancing"};class At{constructor(e){this.parser=e,this.name=Mt.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){const e=this.parser,t=this.parser.json.nodes||[];for(let s=0,r=t.length;s<r;s++){const r=t[s];r.extensions&&r.extensions[this.name]&&void 0!==r.extensions[this.name].light&&e._addNodeRef(this.cache,r.extensions[this.name].light)}}_loadLight(e){const s=this.parser,r="light:"+e;let i=s.cache.get(r);if(i)return i;const n=s.json,a=((n.extensions&&n.extensions[this.name]||{}).lights||[])[e];let o;const l=new t.Color(16777215);void 0!==a.color&&l.fromArray(a.color);const h=void 0!==a.range?a.range:0;switch(a.type){case"directional":o=new t.DirectionalLight(l),o.target.position.set(0,0,-1),o.add(o.target);break;case"point":o=new t.PointLight(l),o.distance=h;break;case"spot":o=new t.SpotLight(l),o.distance=h,a.spot=a.spot||{},a.spot.innerConeAngle=void 0!==a.spot.innerConeAngle?a.spot.innerConeAngle:0,a.spot.outerConeAngle=void 0!==a.spot.outerConeAngle?a.spot.outerConeAngle:Math.PI/4,o.angle=a.spot.outerConeAngle,o.penumbra=1-a.spot.innerConeAngle/a.spot.outerConeAngle,o.target.position.set(0,0,-1),o.add(o.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+a.type)}return o.position.set(0,0,0),o.decay=2,os(o,a),void 0!==a.intensity&&(o.intensity=a.intensity),o.name=s.createUniqueName(a.name||"light_"+e),i=Promise.resolve(o),s.cache.add(r,i),i}getDependency(e,t){if("light"===e)return this._loadLight(t)}createNodeAttachment(e){const t=this,s=this.parser,r=s.json.nodes[e],i=(r.extensions&&r.extensions[this.name]||{}).light;return void 0===i?null:this._loadLight(i).then((function(e){return s._getNodeRef(t.cache,i,e)}))}}class Tt{constructor(){this.name=Mt.KHR_MATERIALS_UNLIT}getMaterialType(){return t.MeshBasicMaterial}extendParams(e,s,r){const i=[];e.color=new t.Color(1,1,1),e.opacity=1;const n=s.pbrMetallicRoughness;if(n){if(Array.isArray(n.baseColorFactor)){const t=n.baseColorFactor;e.color.fromArray(t),e.opacity=t[3]}void 0!==n.baseColorTexture&&i.push(r.assignTexture(e,"map",n.baseColorTexture,t.SRGBColorSpace))}return Promise.all(i)}}class St{constructor(e){this.parser=e,this.name=Mt.KHR_MATERIALS_EMISSIVE_STRENGTH}extendMaterialParams(e,t){const s=this.parser.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const r=s.extensions[this.name].emissiveStrength;return void 0!==r&&(t.emissiveIntensity=r),Promise.resolve()}}class kt{constructor(e){this.parser=e,this.name=Mt.KHR_MATERIALS_CLEARCOAT}getMaterialType(e){const s=this.parser.json.materials[e];return s.extensions&&s.extensions[this.name]?t.MeshPhysicalMaterial:null}extendMaterialParams(e,s){const r=this.parser,i=r.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const n=[],a=i.extensions[this.name];if(void 0!==a.clearcoatFactor&&(s.clearcoat=a.clearcoatFactor),void 0!==a.clearcoatTexture&&n.push(r.assignTexture(s,"clearcoatMap",a.clearcoatTexture)),void 0!==a.clearcoatRoughnessFactor&&(s.clearcoatRoughness=a.clearcoatRoughnessFactor),void 0!==a.clearcoatRoughnessTexture&&n.push(r.assignTexture(s,"clearcoatRoughnessMap",a.clearcoatRoughnessTexture)),void 0!==a.clearcoatNormalTexture&&(n.push(r.assignTexture(s,"clearcoatNormalMap",a.clearcoatNormalTexture)),void 0!==a.clearcoatNormalTexture.scale)){const e=a.clearcoatNormalTexture.scale;s.clearcoatNormalScale=new t.Vector2(e,e)}return Promise.all(n)}}class Rt{constructor(e){this.parser=e,this.name=Mt.KHR_MATERIALS_IRIDESCENCE}getMaterialType(e){const s=this.parser.json.materials[e];return s.extensions&&s.extensions[this.name]?t.MeshPhysicalMaterial:null}extendMaterialParams(e,t){const s=this.parser,r=s.json.materials[e];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();const i=[],n=r.extensions[this.name];return void 0!==n.iridescenceFactor&&(t.iridescence=n.iridescenceFactor),void 0!==n.iridescenceTexture&&i.push(s.assignTexture(t,"iridescenceMap",n.iridescenceTexture)),void 0!==n.iridescenceIor&&(t.iridescenceIOR=n.iridescenceIor),void 0===t.iridescenceThicknessRange&&(t.iridescenceThicknessRange=[100,400]),void 0!==n.iridescenceThicknessMinimum&&(t.iridescenceThicknessRange[0]=n.iridescenceThicknessMinimum),void 0!==n.iridescenceThicknessMaximum&&(t.iridescenceThicknessRange[1]=n.iridescenceThicknessMaximum),void 0!==n.iridescenceThicknessTexture&&i.push(s.assignTexture(t,"iridescenceThicknessMap",n.iridescenceThicknessTexture)),Promise.all(i)}}class Et{constructor(e){this.parser=e,this.name=Mt.KHR_MATERIALS_SHEEN}getMaterialType(e){const s=this.parser.json.materials[e];return s.extensions&&s.extensions[this.name]?t.MeshPhysicalMaterial:null}extendMaterialParams(e,s){const r=this.parser,i=r.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const n=[];s.sheenColor=new t.Color(0,0,0),s.sheenRoughness=0,s.sheen=1;const a=i.extensions[this.name];return void 0!==a.sheenColorFactor&&s.sheenColor.fromArray(a.sheenColorFactor),void 0!==a.sheenRoughnessFactor&&(s.sheenRoughness=a.sheenRoughnessFactor),void 0!==a.sheenColorTexture&&n.push(r.assignTexture(s,"sheenColorMap",a.sheenColorTexture,t.SRGBColorSpace)),void 0!==a.sheenRoughnessTexture&&n.push(r.assignTexture(s,"sheenRoughnessMap",a.sheenRoughnessTexture)),Promise.all(n)}}class Pt{constructor(e){this.parser=e,this.name=Mt.KHR_MATERIALS_TRANSMISSION}getMaterialType(e){const s=this.parser.json.materials[e];return s.extensions&&s.extensions[this.name]?t.MeshPhysicalMaterial:null}extendMaterialParams(e,t){const s=this.parser,r=s.json.materials[e];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();const i=[],n=r.extensions[this.name];return void 0!==n.transmissionFactor&&(t.transmission=n.transmissionFactor),void 0!==n.transmissionTexture&&i.push(s.assignTexture(t,"transmissionMap",n.transmissionTexture)),Promise.all(i)}}class It{constructor(e){this.parser=e,this.name=Mt.KHR_MATERIALS_VOLUME}getMaterialType(e){const s=this.parser.json.materials[e];return s.extensions&&s.extensions[this.name]?t.MeshPhysicalMaterial:null}extendMaterialParams(e,s){const r=this.parser,i=r.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const n=[],a=i.extensions[this.name];s.thickness=void 0!==a.thicknessFactor?a.thicknessFactor:0,void 0!==a.thicknessTexture&&n.push(r.assignTexture(s,"thicknessMap",a.thicknessTexture)),s.attenuationDistance=a.attenuationDistance||1/0;const o=a.attenuationColor||[1,1,1];return s.attenuationColor=new t.Color(o[0],o[1],o[2]),Promise.all(n)}}class _t{constructor(e){this.parser=e,this.name=Mt.KHR_MATERIALS_IOR}getMaterialType(e){const s=this.parser.json.materials[e];return s.extensions&&s.extensions[this.name]?t.MeshPhysicalMaterial:null}extendMaterialParams(e,t){const s=this.parser.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const r=s.extensions[this.name];return t.ior=void 0!==r.ior?r.ior:1.5,Promise.resolve()}}class Lt{constructor(e){this.parser=e,this.name=Mt.KHR_MATERIALS_SPECULAR}getMaterialType(e){const s=this.parser.json.materials[e];return s.extensions&&s.extensions[this.name]?t.MeshPhysicalMaterial:null}extendMaterialParams(e,s){const r=this.parser,i=r.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const n=[],a=i.extensions[this.name];s.specularIntensity=void 0!==a.specularFactor?a.specularFactor:1,void 0!==a.specularTexture&&n.push(r.assignTexture(s,"specularIntensityMap",a.specularTexture));const o=a.specularColorFactor||[1,1,1];return s.specularColor=new t.Color(o[0],o[1],o[2]),void 0!==a.specularColorTexture&&n.push(r.assignTexture(s,"specularColorMap",a.specularColorTexture,t.SRGBColorSpace)),Promise.all(n)}}class Ct{constructor(e){this.parser=e,this.name=Mt.KHR_MATERIALS_ANISOTROPY}getMaterialType(e){const s=this.parser.json.materials[e];return s.extensions&&s.extensions[this.name]?t.MeshPhysicalMaterial:null}extendMaterialParams(e,t){const s=this.parser,r=s.json.materials[e];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();const i=[],n=r.extensions[this.name];return void 0!==n.anisotropyStrength&&(t.anisotropy=n.anisotropyStrength),void 0!==n.anisotropyRotation&&(t.anisotropyRotation=n.anisotropyRotation),void 0!==n.anisotropyTexture&&i.push(s.assignTexture(t,"anisotropyMap",n.anisotropyTexture)),Promise.all(i)}}class Ft{constructor(e){this.parser=e,this.name=Mt.KHR_TEXTURE_BASISU}loadTexture(e){const t=this.parser,s=t.json,r=s.textures[e];if(!r.extensions||!r.extensions[this.name])return null;const i=r.extensions[this.name],n=t.options.ktx2Loader;if(!n){if(s.extensionsRequired&&s.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return t.loadTextureImage(e,i.source,n)}}class Bt{constructor(e){this.parser=e,this.name=Mt.EXT_TEXTURE_WEBP,this.isSupported=null}loadTexture(e){const t=this.name,s=this.parser,r=s.json,i=r.textures[e];if(!i.extensions||!i.extensions[t])return null;const n=i.extensions[t],a=r.images[n.source];let o=s.textureLoader;if(a.uri){const e=s.options.manager.getHandler(a.uri);null!==e&&(o=e)}return this.detectSupport().then((function(i){if(i)return s.loadTextureImage(e,n.source,o);if(r.extensionsRequired&&r.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: WebP required by asset but unsupported.");return s.loadTexture(e)}))}detectSupport(){return this.isSupported||(this.isSupported=new Promise((function(e){const t=new Image;t.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",t.onload=t.onerror=function(){e(1===t.height)}}))),this.isSupported}}class Ot{constructor(e){this.parser=e,this.name=Mt.EXT_TEXTURE_AVIF,this.isSupported=null}loadTexture(e){const t=this.name,s=this.parser,r=s.json,i=r.textures[e];if(!i.extensions||!i.extensions[t])return null;const n=i.extensions[t],a=r.images[n.source];let o=s.textureLoader;if(a.uri){const e=s.options.manager.getHandler(a.uri);null!==e&&(o=e)}return this.detectSupport().then((function(i){if(i)return s.loadTextureImage(e,n.source,o);if(r.extensionsRequired&&r.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: AVIF required by asset but unsupported.");return s.loadTexture(e)}))}detectSupport(){return this.isSupported||(this.isSupported=new Promise((function(e){const t=new Image;t.src="data:image/avif;base64,AAAAIGZ0eXBhdmlmAAAAAGF2aWZtaWYxbWlhZk1BMUIAAADybWV0YQAAAAAAAAAoaGRscgAAAAAAAAAAcGljdAAAAAAAAAAAAAAAAGxpYmF2aWYAAAAADnBpdG0AAAAAAAEAAAAeaWxvYwAAAABEAAABAAEAAAABAAABGgAAABcAAAAoaWluZgAAAAAAAQAAABppbmZlAgAAAAABAABhdjAxQ29sb3IAAAAAamlwcnAAAABLaXBjbwAAABRpc3BlAAAAAAAAAAEAAAABAAAAEHBpeGkAAAAAAwgICAAAAAxhdjFDgQAMAAAAABNjb2xybmNseAACAAIABoAAAAAXaXBtYQAAAAAAAAABAAEEAQKDBAAAAB9tZGF0EgAKCBgABogQEDQgMgkQAAAAB8dSLfI=",t.onload=t.onerror=function(){e(1===t.height)}}))),this.isSupported}}class zt{constructor(e){this.name=Mt.EXT_MESHOPT_COMPRESSION,this.parser=e}loadBufferView(e){const t=this.parser.json,s=t.bufferViews[e];if(s.extensions&&s.extensions[this.name]){const e=s.extensions[this.name],r=this.parser.getDependency("buffer",e.buffer),i=this.parser.options.meshoptDecoder;if(!i||!i.supported){if(t.extensionsRequired&&t.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return r.then((function(t){const s=e.byteOffset||0,r=e.byteLength||0,n=e.count,a=e.byteStride,o=new Uint8Array(t,s,r);return i.decodeGltfBufferAsync?i.decodeGltfBufferAsync(n,a,o,e.mode,e.filter).then((function(e){return e.buffer})):i.ready.then((function(){const t=new ArrayBuffer(n*a);return i.decodeGltfBuffer(new Uint8Array(t),n,a,o,e.mode,e.filter),t}))}))}return null}}class Dt{constructor(e){this.name=Mt.EXT_MESH_GPU_INSTANCING,this.parser=e}createNodeMesh(e){const s=this.parser.json,r=s.nodes[e];if(!r.extensions||!r.extensions[this.name]||void 0===r.mesh)return null;const i=s.meshes[r.mesh];for(const e of i.primitives)if(e.mode!==Qt.TRIANGLES&&e.mode!==Qt.TRIANGLE_STRIP&&e.mode!==Qt.TRIANGLE_FAN&&void 0!==e.mode)return null;const n=r.extensions[this.name].attributes,a=[],o={};for(const e in n)a.push(this.parser.getDependency("accessor",n[e]).then((t=>(o[e]=t,o[e]))));return a.length<1?null:(a.push(this.parser.createNodeMesh(e)),Promise.all(a).then((e=>{const s=e.pop(),r=s.isGroup?s.children:[s],i=e[0].count,n=[];for(const e of r){const s=new t.Matrix4,r=new t.Vector3,a=new t.Quaternion,l=new t.Vector3(1,1,1),h=new t.InstancedMesh(e.geometry,e.material,i);for(let e=0;e<i;e++)o.TRANSLATION&&r.fromBufferAttribute(o.TRANSLATION,e),o.ROTATION&&a.fromBufferAttribute(o.ROTATION,e),o.SCALE&&l.fromBufferAttribute(o.SCALE,e),h.setMatrixAt(e,s.compose(r,a,l));for(const t in o)"TRANSLATION"!==t&&"ROTATION"!==t&&"SCALE"!==t&&e.geometry.setAttribute(t,o[t]);t.Object3D.prototype.copy.call(h,e),this.parser.assignFinalMaterial(h),n.push(h)}return s.isGroup?(s.clear(),s.add(...n),s):n[0]})))}}const Nt="glTF",Ut=1313821514,Vt=5130562;class jt{constructor(e){this.name=Mt.KHR_BINARY_GLTF,this.content=null,this.body=null;const t=new DataView(e,0,12),s=new TextDecoder;if(this.header={magic:s.decode(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==Nt)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");const r=this.header.length-12,i=new DataView(e,12);let n=0;for(;n<r;){const t=i.getUint32(n,!0);n+=4;const r=i.getUint32(n,!0);if(n+=4,r===Ut){const r=new Uint8Array(e,12+n,t);this.content=s.decode(r)}else if(r===Vt){const s=12+n;this.body=e.slice(s,s+t)}n+=t}if(null===this.content)throw new Error("THREE.GLTFLoader: JSON content not found.")}}class Gt{constructor(e,t){if(!t)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=Mt.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}decodePrimitive(e,t){const s=this.json,r=this.dracoLoader,i=e.extensions[this.name].bufferView,n=e.extensions[this.name].attributes,a={},o={},l={};for(const e in n){const t=es[e]||e.toLowerCase();a[t]=n[e]}for(const t in e.attributes){const r=es[t]||t.toLowerCase();if(void 0!==n[t]){const i=s.accessors[e.attributes[t]],n=Zt[i.componentType];l[r]=n.name,o[r]=!0===i.normalized}}return t.getDependency("bufferView",i).then((function(e){return new Promise((function(t){r.decodeDracoFile(e,(function(e){for(const t in e.attributes){const s=e.attributes[t],r=o[t];void 0!==r&&(s.normalized=r)}t(e)}),a,l)}))}))}}class Ht{constructor(){this.name=Mt.KHR_TEXTURE_TRANSFORM}extendTexture(e,t){return void 0!==t.texCoord&&t.texCoord!==e.channel||void 0!==t.offset||void 0!==t.rotation||void 0!==t.scale?(e=e.clone(),void 0!==t.texCoord&&(e.channel=t.texCoord),void 0!==t.offset&&e.offset.fromArray(t.offset),void 0!==t.rotation&&(e.rotation=t.rotation),void 0!==t.scale&&e.repeat.fromArray(t.scale),e.needsUpdate=!0,e):e}}class Wt{constructor(){this.name=Mt.KHR_MESH_QUANTIZATION}}class qt extends t.Interpolant{constructor(e,t,s,r){super(e,t,s,r)}copySampleValue_(e){const t=this.resultBuffer,s=this.sampleValues,r=this.valueSize,i=e*r*3+r;for(let e=0;e!==r;e++)t[e]=s[i+e];return t}interpolate_(e,t,s,r){const i=this.resultBuffer,n=this.sampleValues,a=this.valueSize,o=2*a,l=3*a,h=r-t,c=(s-t)/h,u=c*c,p=u*c,d=e*l,m=d-l,f=-2*p+3*u,g=p-u,y=1-f,b=g-u+c;for(let e=0;e!==a;e++){const t=n[m+e+a],s=n[m+e+o]*h,r=n[d+e+a],l=n[d+e]*h;i[e]=y*t+b*s+f*r+g*l}return i}}const Xt=new t.Quaternion;class Kt extends qt{interpolate_(e,t,s,r){const i=super.interpolate_(e,t,s,r);return Xt.fromArray(i).normalize().toArray(i),i}}const Qt={FLOAT:5126,FLOAT_MAT3:35675,FLOAT_MAT4:35676,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,LINEAR:9729,REPEAT:10497,SAMPLER_2D:35678,POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,UNSIGNED_BYTE:5121,UNSIGNED_SHORT:5123},Zt={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},Yt={9728:t.NearestFilter,9729:t.LinearFilter,9984:t.NearestMipmapNearestFilter,9985:t.LinearMipmapNearestFilter,9986:t.NearestMipmapLinearFilter,9987:t.LinearMipmapLinearFilter},Jt={33071:t.ClampToEdgeWrapping,33648:t.MirroredRepeatWrapping,10497:t.RepeatWrapping},$t={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},es={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv1",TEXCOORD_2:"uv2",TEXCOORD_3:"uv3",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},ts={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},ss={CUBICSPLINE:void 0,LINEAR:t.InterpolateLinear,STEP:t.InterpolateDiscrete},rs="OPAQUE",is="MASK",ns="BLEND";function as(e,t,s){for(const r in s.extensions)void 0===e[r]&&(t.userData.gltfExtensions=t.userData.gltfExtensions||{},t.userData.gltfExtensions[r]=s.extensions[r])}function os(e,t){void 0!==t.extras&&("object"==typeof t.extras?Object.assign(e.userData,t.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+t.extras))}function ls(e,t){if(e.updateMorphTargets(),void 0!==t.weights)for(let s=0,r=t.weights.length;s<r;s++)e.morphTargetInfluences[s]=t.weights[s];if(t.extras&&Array.isArray(t.extras.targetNames)){const s=t.extras.targetNames;if(e.morphTargetInfluences.length===s.length){e.morphTargetDictionary={};for(let t=0,r=s.length;t<r;t++)e.morphTargetDictionary[s[t]]=t}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function hs(e){let t;const s=e.extensions&&e.extensions[Mt.KHR_DRACO_MESH_COMPRESSION];if(t=s?"draco:"+s.bufferView+":"+s.indices+":"+cs(s.attributes):e.indices+":"+cs(e.attributes)+":"+e.mode,void 0!==e.targets)for(let s=0,r=e.targets.length;s<r;s++)t+=":"+cs(e.targets[s]);return t}function cs(e){let t="";const s=Object.keys(e).sort();for(let r=0,i=s.length;r<i;r++)t+=s[r]+":"+e[s[r]]+";";return t}function us(e){switch(e){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}const ps=new t.Matrix4;class ds{constructor(e={},s={}){this.json=e,this.extensions={},this.plugins={},this.options=s,this.cache=new wt,this.associations=new Map,this.primitiveCache={},this.nodeCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={};let r=!1,i=!1,n=-1;"undefined"!=typeof navigator&&(r=!0===/^((?!chrome|android).)*safari/i.test(navigator.userAgent),i=navigator.userAgent.indexOf("Firefox")>-1,n=i?navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1]:-1),"undefined"==typeof createImageBitmap||r||i&&n<98?this.textureLoader=new t.TextureLoader(this.options.manager):this.textureLoader=new t.ImageBitmapLoader(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new t.FileLoader(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),"use-credentials"===this.options.crossOrigin&&this.fileLoader.setWithCredentials(!0)}setExtensions(e){this.extensions=e}setPlugins(e){this.plugins=e}parse(e,t){const s=this,r=this.json,i=this.extensions;this.cache.removeAll(),this.nodeCache={},this._invokeAll((function(e){return e._markDefs&&e._markDefs()})),Promise.all(this._invokeAll((function(e){return e.beforeRoot&&e.beforeRoot()}))).then((function(){return Promise.all([s.getDependencies("scene"),s.getDependencies("animation"),s.getDependencies("camera")])})).then((function(t){const n={scene:t[0][r.scene||0],scenes:t[0],animations:t[1],cameras:t[2],asset:r.asset,parser:s,userData:{}};as(i,n,r),os(n,r),Promise.all(s._invokeAll((function(e){return e.afterRoot&&e.afterRoot(n)}))).then((function(){e(n)}))})).catch(t)}_markDefs(){const e=this.json.nodes||[],t=this.json.skins||[],s=this.json.meshes||[];for(let s=0,r=t.length;s<r;s++){const r=t[s].joints;for(let t=0,s=r.length;t<s;t++)e[r[t]].isBone=!0}for(let t=0,r=e.length;t<r;t++){const r=e[t];void 0!==r.mesh&&(this._addNodeRef(this.meshCache,r.mesh),void 0!==r.skin&&(s[r.mesh].isSkinnedMesh=!0)),void 0!==r.camera&&this._addNodeRef(this.cameraCache,r.camera)}}_addNodeRef(e,t){void 0!==t&&(void 0===e.refs[t]&&(e.refs[t]=e.uses[t]=0),e.refs[t]++)}_getNodeRef(e,t,s){if(e.refs[t]<=1)return s;const r=s.clone(),i=(e,t)=>{const s=this.associations.get(e);null!=s&&this.associations.set(t,s);for(const[s,r]of e.children.entries())i(r,t.children[s])};return i(s,r),r.name+="_instance_"+e.uses[t]++,r}_invokeOne(e){const t=Object.values(this.plugins);t.push(this);for(let s=0;s<t.length;s++){const r=e(t[s]);if(r)return r}return null}_invokeAll(e){const t=Object.values(this.plugins);t.unshift(this);const s=[];for(let r=0;r<t.length;r++){const i=e(t[r]);i&&s.push(i)}return s}getDependency(e,t){const s=e+":"+t;let r=this.cache.get(s);if(!r){switch(e){case"scene":r=this.loadScene(t);break;case"node":r=this._invokeOne((function(e){return e.loadNode&&e.loadNode(t)}));break;case"mesh":r=this._invokeOne((function(e){return e.loadMesh&&e.loadMesh(t)}));break;case"accessor":r=this.loadAccessor(t);break;case"bufferView":r=this._invokeOne((function(e){return e.loadBufferView&&e.loadBufferView(t)}));break;case"buffer":r=this.loadBuffer(t);break;case"material":r=this._invokeOne((function(e){return e.loadMaterial&&e.loadMaterial(t)}));break;case"texture":r=this._invokeOne((function(e){return e.loadTexture&&e.loadTexture(t)}));break;case"skin":r=this.loadSkin(t);break;case"animation":r=this._invokeOne((function(e){return e.loadAnimation&&e.loadAnimation(t)}));break;case"camera":r=this.loadCamera(t);break;default:if(r=this._invokeOne((function(s){return s!=this&&s.getDependency&&s.getDependency(e,t)})),!r)throw new Error("Unknown type: "+e)}this.cache.add(s,r)}return r}getDependencies(e){let t=this.cache.get(e);if(!t){const s=this,r=this.json[e+("mesh"===e?"es":"s")]||[];t=Promise.all(r.map((function(t,r){return s.getDependency(e,r)}))),this.cache.add(e,t)}return t}loadBuffer(e){const s=this.json.buffers[e],r=this.fileLoader;if(s.type&&"arraybuffer"!==s.type)throw new Error("THREE.GLTFLoader: "+s.type+" buffer type is not supported.");if(void 0===s.uri&&0===e)return Promise.resolve(this.extensions[Mt.KHR_BINARY_GLTF].body);const i=this.options;return new Promise((function(e,n){r.load(t.LoaderUtils.resolveURL(s.uri,i.path),e,void 0,(function(){n(new Error('THREE.GLTFLoader: Failed to load buffer "'+s.uri+'".'))}))}))}loadBufferView(e){const t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then((function(e){const s=t.byteLength||0,r=t.byteOffset||0;return e.slice(r,r+s)}))}loadAccessor(e){const s=this,r=this.json,i=this.json.accessors[e];if(void 0===i.bufferView&&void 0===i.sparse){const e=$t[i.type],s=Zt[i.componentType],r=!0===i.normalized,n=new s(i.count*e);return Promise.resolve(new t.BufferAttribute(n,e,r))}const n=[];return void 0!==i.bufferView?n.push(this.getDependency("bufferView",i.bufferView)):n.push(null),void 0!==i.sparse&&(n.push(this.getDependency("bufferView",i.sparse.indices.bufferView)),n.push(this.getDependency("bufferView",i.sparse.values.bufferView))),Promise.all(n).then((function(e){const n=e[0],a=$t[i.type],o=Zt[i.componentType],l=o.BYTES_PER_ELEMENT,h=l*a,c=i.byteOffset||0,u=void 0!==i.bufferView?r.bufferViews[i.bufferView].byteStride:void 0,p=!0===i.normalized;let d,m;if(u&&u!==h){const e=Math.floor(c/u),r="InterleavedBuffer:"+i.bufferView+":"+i.componentType+":"+e+":"+i.count;let h=s.cache.get(r);h||(d=new o(n,e*u,i.count*u/l),h=new t.InterleavedBuffer(d,u/l),s.cache.add(r,h)),m=new t.InterleavedBufferAttribute(h,a,c%u/l,p)}else d=null===n?new o(i.count*a):new o(n,c,i.count*a),m=new t.BufferAttribute(d,a,p);if(void 0!==i.sparse){const s=$t.SCALAR,r=Zt[i.sparse.indices.componentType],l=i.sparse.indices.byteOffset||0,h=i.sparse.values.byteOffset||0,c=new r(e[1],l,i.sparse.count*s),u=new o(e[2],h,i.sparse.count*a);null!==n&&(m=new t.BufferAttribute(m.array.slice(),m.itemSize,m.normalized));for(let e=0,t=c.length;e<t;e++){const t=c[e];if(m.setX(t,u[e*a]),a>=2&&m.setY(t,u[e*a+1]),a>=3&&m.setZ(t,u[e*a+2]),a>=4&&m.setW(t,u[e*a+3]),a>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}}return m}))}loadTexture(e){const t=this.json,s=this.options,r=t.textures[e].source,i=t.images[r];let n=this.textureLoader;if(i.uri){const e=s.manager.getHandler(i.uri);null!==e&&(n=e)}return this.loadTextureImage(e,r,n)}loadTextureImage(e,s,r){const i=this,n=this.json,a=n.textures[e],o=n.images[s],l=(o.uri||o.bufferView)+":"+a.sampler;if(this.textureCache[l])return this.textureCache[l];const h=this.loadImageSource(s,r).then((function(s){s.flipY=!1,s.name=a.name||o.name||"",""===s.name&&"string"==typeof o.uri&&!1===o.uri.startsWith("data:image/")&&(s.name=o.uri);const r=(n.samplers||{})[a.sampler]||{};return s.magFilter=Yt[r.magFilter]||t.LinearFilter,s.minFilter=Yt[r.minFilter]||t.LinearMipmapLinearFilter,s.wrapS=Jt[r.wrapS]||t.RepeatWrapping,s.wrapT=Jt[r.wrapT]||t.RepeatWrapping,i.associations.set(s,{textures:e}),s})).catch((function(){return null}));return this.textureCache[l]=h,h}loadImageSource(e,s){const r=this,i=this.json,n=this.options;if(void 0!==this.sourceCache[e])return this.sourceCache[e].then((e=>e.clone()));const a=i.images[e],o=self.URL||self.webkitURL;let l=a.uri||"",h=!1;if(void 0!==a.bufferView)l=r.getDependency("bufferView",a.bufferView).then((function(e){h=!0;const t=new Blob([e],{type:a.mimeType});return l=o.createObjectURL(t),l}));else if(void 0===a.uri)throw new Error("THREE.GLTFLoader: Image "+e+" is missing URI and bufferView");const c=Promise.resolve(l).then((function(e){return new Promise((function(r,i){let a=r;!0===s.isImageBitmapLoader&&(a=function(e){const s=new t.Texture(e);s.needsUpdate=!0,r(s)}),s.load(t.LoaderUtils.resolveURL(e,n.path),a,void 0,i)}))})).then((function(e){var t;return!0===h&&o.revokeObjectURL(l),e.userData.mimeType=a.mimeType||((t=a.uri).search(/\.jpe?g($|\?)/i)>0||0===t.search(/^data\:image\/jpeg/)?"image/jpeg":t.search(/\.webp($|\?)/i)>0||0===t.search(/^data\:image\/webp/)?"image/webp":"image/png"),e})).catch((function(e){throw console.error("THREE.GLTFLoader: Couldn't load texture",l),e}));return this.sourceCache[e]=c,c}assignTexture(e,t,s,r){const i=this;return this.getDependency("texture",s.index).then((function(n){if(!n)return null;if(void 0!==s.texCoord&&s.texCoord>0&&((n=n.clone()).channel=s.texCoord),i.extensions[Mt.KHR_TEXTURE_TRANSFORM]){const e=void 0!==s.extensions?s.extensions[Mt.KHR_TEXTURE_TRANSFORM]:void 0;if(e){const t=i.associations.get(n);n=i.extensions[Mt.KHR_TEXTURE_TRANSFORM].extendTexture(n,e),i.associations.set(n,t)}}return void 0!==r&&(n.colorSpace=r),e[t]=n,n}))}assignFinalMaterial(e){const s=e.geometry;let r=e.material;const i=void 0===s.attributes.tangent,n=void 0!==s.attributes.color,a=void 0===s.attributes.normal;if(e.isPoints){const e="PointsMaterial:"+r.uuid;let s=this.cache.get(e);s||(s=new t.PointsMaterial,t.Material.prototype.copy.call(s,r),s.color.copy(r.color),s.map=r.map,s.sizeAttenuation=!1,this.cache.add(e,s)),r=s}else if(e.isLine){const e="LineBasicMaterial:"+r.uuid;let s=this.cache.get(e);s||(s=new t.LineBasicMaterial,t.Material.prototype.copy.call(s,r),s.color.copy(r.color),s.map=r.map,this.cache.add(e,s)),r=s}if(i||n||a){let e="ClonedMaterial:"+r.uuid+":";i&&(e+="derivative-tangents:"),n&&(e+="vertex-colors:"),a&&(e+="flat-shading:");let t=this.cache.get(e);t||(t=r.clone(),n&&(t.vertexColors=!0),a&&(t.flatShading=!0),i&&(t.normalScale&&(t.normalScale.y*=-1),t.clearcoatNormalScale&&(t.clearcoatNormalScale.y*=-1)),this.cache.add(e,t),this.associations.set(t,this.associations.get(r))),r=t}e.material=r}getMaterialType(){return t.MeshStandardMaterial}loadMaterial(e){const s=this,r=this.json,i=this.extensions,n=r.materials[e];let a;const o={},l=[];if((n.extensions||{})[Mt.KHR_MATERIALS_UNLIT]){const e=i[Mt.KHR_MATERIALS_UNLIT];a=e.getMaterialType(),l.push(e.extendParams(o,n,s))}else{const r=n.pbrMetallicRoughness||{};if(o.color=new t.Color(1,1,1),o.opacity=1,Array.isArray(r.baseColorFactor)){const e=r.baseColorFactor;o.color.fromArray(e),o.opacity=e[3]}void 0!==r.baseColorTexture&&l.push(s.assignTexture(o,"map",r.baseColorTexture,t.SRGBColorSpace)),o.metalness=void 0!==r.metallicFactor?r.metallicFactor:1,o.roughness=void 0!==r.roughnessFactor?r.roughnessFactor:1,void 0!==r.metallicRoughnessTexture&&(l.push(s.assignTexture(o,"metalnessMap",r.metallicRoughnessTexture)),l.push(s.assignTexture(o,"roughnessMap",r.metallicRoughnessTexture))),a=this._invokeOne((function(t){return t.getMaterialType&&t.getMaterialType(e)})),l.push(Promise.all(this._invokeAll((function(t){return t.extendMaterialParams&&t.extendMaterialParams(e,o)}))))}!0===n.doubleSided&&(o.side=t.DoubleSide);const h=n.alphaMode||rs;if(h===ns?(o.transparent=!0,o.depthWrite=!1):(o.transparent=!1,h===is&&(o.alphaTest=void 0!==n.alphaCutoff?n.alphaCutoff:.5)),void 0!==n.normalTexture&&a!==t.MeshBasicMaterial&&(l.push(s.assignTexture(o,"normalMap",n.normalTexture)),o.normalScale=new t.Vector2(1,1),void 0!==n.normalTexture.scale)){const e=n.normalTexture.scale;o.normalScale.set(e,e)}return void 0!==n.occlusionTexture&&a!==t.MeshBasicMaterial&&(l.push(s.assignTexture(o,"aoMap",n.occlusionTexture)),void 0!==n.occlusionTexture.strength&&(o.aoMapIntensity=n.occlusionTexture.strength)),void 0!==n.emissiveFactor&&a!==t.MeshBasicMaterial&&(o.emissive=(new t.Color).fromArray(n.emissiveFactor)),void 0!==n.emissiveTexture&&a!==t.MeshBasicMaterial&&l.push(s.assignTexture(o,"emissiveMap",n.emissiveTexture,t.SRGBColorSpace)),Promise.all(l).then((function(){const t=new a(o);return n.name&&(t.name=n.name),os(t,n),s.associations.set(t,{materials:e}),n.extensions&&as(i,t,n),t}))}createUniqueName(e){const s=t.PropertyBinding.sanitizeNodeName(e||"");return s in this.nodeNamesUsed?s+"_"+ ++this.nodeNamesUsed[s]:(this.nodeNamesUsed[s]=0,s)}loadGeometries(e){const s=this,r=this.extensions,i=this.primitiveCache;function n(e){return r[Mt.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(e,s).then((function(t){return ms(t,e,s)}))}const a=[];for(let r=0,o=e.length;r<o;r++){const o=e[r],l=hs(o),h=i[l];if(h)a.push(h.promise);else{let e;e=o.extensions&&o.extensions[Mt.KHR_DRACO_MESH_COMPRESSION]?n(o):ms(new t.BufferGeometry,o,s),i[l]={primitive:o,promise:e},a.push(e)}}return Promise.all(a)}loadMesh(e){const s=this,r=this.json,i=this.extensions,n=r.meshes[e],a=n.primitives,o=[];for(let e=0,s=a.length;e<s;e++){const s=void 0===a[e].material?(void 0===(l=this.cache).DefaultMaterial&&(l.DefaultMaterial=new t.MeshStandardMaterial({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:t.FrontSide})),l.DefaultMaterial):this.getDependency("material",a[e].material);o.push(s)}var l;return o.push(s.loadGeometries(a)),Promise.all(o).then((function(r){const o=r.slice(0,r.length-1),l=r[r.length-1],h=[];for(let r=0,c=l.length;r<c;r++){const c=l[r],u=a[r];let p;const d=o[r];if(u.mode===Qt.TRIANGLES||u.mode===Qt.TRIANGLE_STRIP||u.mode===Qt.TRIANGLE_FAN||void 0===u.mode)p=!0===n.isSkinnedMesh?new t.SkinnedMesh(c,d):new t.Mesh(c,d),!0===p.isSkinnedMesh&&p.normalizeSkinWeights(),u.mode===Qt.TRIANGLE_STRIP?p.geometry=te(p.geometry,t.TriangleStripDrawMode):u.mode===Qt.TRIANGLE_FAN&&(p.geometry=te(p.geometry,t.TriangleFanDrawMode));else if(u.mode===Qt.LINES)p=new t.LineSegments(c,d);else if(u.mode===Qt.LINE_STRIP)p=new t.Line(c,d);else if(u.mode===Qt.LINE_LOOP)p=new t.LineLoop(c,d);else{if(u.mode!==Qt.POINTS)throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+u.mode);p=new t.Points(c,d)}Object.keys(p.geometry.morphAttributes).length>0&&ls(p,n),p.name=s.createUniqueName(n.name||"mesh_"+e),os(p,n),u.extensions&&as(i,p,u),s.assignFinalMaterial(p),h.push(p)}for(let t=0,r=h.length;t<r;t++)s.associations.set(h[t],{meshes:e,primitives:t});if(1===h.length)return n.extensions&&as(i,h[0],n),h[0];const c=new t.Group;n.extensions&&as(i,c,n),s.associations.set(c,{meshes:e});for(let e=0,t=h.length;e<t;e++)c.add(h[e]);return c}))}loadCamera(e){let s;const r=this.json.cameras[e],i=r[r.type];if(i)return"perspective"===r.type?s=new t.PerspectiveCamera(t.MathUtils.radToDeg(i.yfov),i.aspectRatio||1,i.znear||1,i.zfar||2e6):"orthographic"===r.type&&(s=new t.OrthographicCamera(-i.xmag,i.xmag,i.ymag,-i.ymag,i.znear,i.zfar)),r.name&&(s.name=this.createUniqueName(r.name)),os(s,r),Promise.resolve(s);console.warn("THREE.GLTFLoader: Missing camera parameters.")}loadSkin(e){const s=this.json.skins[e],r=[];for(let e=0,t=s.joints.length;e<t;e++)r.push(this._loadNodeShallow(s.joints[e]));return void 0!==s.inverseBindMatrices?r.push(this.getDependency("accessor",s.inverseBindMatrices)):r.push(null),Promise.all(r).then((function(e){const r=e.pop(),i=e,n=[],a=[];for(let e=0,o=i.length;e<o;e++){const o=i[e];if(o){n.push(o);const s=new t.Matrix4;null!==r&&s.fromArray(r.array,16*e),a.push(s)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',s.joints[e])}return new t.Skeleton(n,a)}))}loadAnimation(e){const s=this.json,r=this,i=s.animations[e],n=i.name?i.name:"animation_"+e,a=[],o=[],l=[],h=[],c=[];for(let e=0,t=i.channels.length;e<t;e++){const t=i.channels[e],s=i.samplers[t.sampler],r=t.target,n=r.node,u=void 0!==i.parameters?i.parameters[s.input]:s.input,p=void 0!==i.parameters?i.parameters[s.output]:s.output;void 0!==r.node&&(a.push(this.getDependency("node",n)),o.push(this.getDependency("accessor",u)),l.push(this.getDependency("accessor",p)),h.push(s),c.push(r))}return Promise.all([Promise.all(a),Promise.all(o),Promise.all(l),Promise.all(h),Promise.all(c)]).then((function(e){const s=e[0],i=e[1],a=e[2],o=e[3],l=e[4],h=[];for(let e=0,t=s.length;e<t;e++){const t=s[e],n=i[e],c=a[e],u=o[e],p=l[e];if(void 0===t)continue;t.updateMatrix&&(t.updateMatrix(),t.matrixAutoUpdate=!0);const d=r._createAnimationTracks(t,n,c,u,p);if(d)for(let e=0;e<d.length;e++)h.push(d[e])}return new t.AnimationClip(n,void 0,h)}))}createNodeMesh(e){const t=this.json,s=this,r=t.nodes[e];return void 0===r.mesh?null:s.getDependency("mesh",r.mesh).then((function(e){const t=s._getNodeRef(s.meshCache,r.mesh,e);return void 0!==r.weights&&t.traverse((function(e){if(e.isMesh)for(let t=0,s=r.weights.length;t<s;t++)e.morphTargetInfluences[t]=r.weights[t]})),t}))}loadNode(e){const t=this,s=this.json.nodes[e],r=t._loadNodeShallow(e),i=[],n=s.children||[];for(let e=0,s=n.length;e<s;e++)i.push(t.getDependency("node",n[e]));const a=void 0===s.skin?Promise.resolve(null):t.getDependency("skin",s.skin);return Promise.all([r,Promise.all(i),a]).then((function(e){const t=e[0],s=e[1],r=e[2];null!==r&&t.traverse((function(e){e.isSkinnedMesh&&e.bind(r,ps)}));for(let e=0,r=s.length;e<r;e++)t.add(s[e]);return t}))}_loadNodeShallow(e){const s=this.json,r=this.extensions,i=this;if(void 0!==this.nodeCache[e])return this.nodeCache[e];const n=s.nodes[e],a=n.name?i.createUniqueName(n.name):"",o=[],l=i._invokeOne((function(t){return t.createNodeMesh&&t.createNodeMesh(e)}));return l&&o.push(l),void 0!==n.camera&&o.push(i.getDependency("camera",n.camera).then((function(e){return i._getNodeRef(i.cameraCache,n.camera,e)}))),i._invokeAll((function(t){return t.createNodeAttachment&&t.createNodeAttachment(e)})).forEach((function(e){o.push(e)})),this.nodeCache[e]=Promise.all(o).then((function(s){let o;if(o=!0===n.isBone?new t.Bone:s.length>1?new t.Group:1===s.length?s[0]:new t.Object3D,o!==s[0])for(let e=0,t=s.length;e<t;e++)o.add(s[e]);if(n.name&&(o.userData.name=n.name,o.name=a),os(o,n),n.extensions&&as(r,o,n),void 0!==n.matrix){const e=new t.Matrix4;e.fromArray(n.matrix),o.applyMatrix4(e)}else void 0!==n.translation&&o.position.fromArray(n.translation),void 0!==n.rotation&&o.quaternion.fromArray(n.rotation),void 0!==n.scale&&o.scale.fromArray(n.scale);return i.associations.has(o)||i.associations.set(o,{}),i.associations.get(o).nodes=e,o})),this.nodeCache[e]}loadScene(e){const s=this.extensions,r=this.json.scenes[e],i=this,n=new t.Group;r.name&&(n.name=i.createUniqueName(r.name)),os(n,r),r.extensions&&as(s,n,r);const a=r.nodes||[],o=[];for(let e=0,t=a.length;e<t;e++)o.push(i.getDependency("node",a[e]));return Promise.all(o).then((function(e){for(let t=0,s=e.length;t<s;t++)n.add(e[t]);return i.associations=(e=>{const s=new Map;for(const[e,r]of i.associations)(e instanceof t.Material||e instanceof t.Texture)&&s.set(e,r);return e.traverse((e=>{const t=i.associations.get(e);null!=t&&s.set(e,t)})),s})(n),n}))}_createAnimationTracks(e,s,r,i,n){const a=[],o=e.name?e.name:e.uuid,l=[];let h;switch(ts[n.path]===ts.weights?e.traverse((function(e){e.morphTargetInfluences&&l.push(e.name?e.name:e.uuid)})):l.push(o),ts[n.path]){case ts.weights:h=t.NumberKeyframeTrack;break;case ts.rotation:h=t.QuaternionKeyframeTrack;break;case ts.position:case ts.scale:default:switch(r.itemSize){case 1:h=t.NumberKeyframeTrack;break;case 2:case 3:h=t.VectorKeyframeTrack}}const c=void 0!==i.interpolation?ss[i.interpolation]:t.InterpolateLinear,u=this._getArrayFromAccessor(r);for(let e=0,t=l.length;e<t;e++){const t=new h(l[e]+"."+ts[n.path],s.array,u,c);"CUBICSPLINE"===c&&this._createCubicSplineTrackInterpolant(t),a.push(t)}return a}_getArrayFromAccessor(e){let t=e.array;if(e.normalized){const e=us(t.constructor),s=new Float32Array(t.length);for(let r=0,i=t.length;r<i;r++)s[r]=t[r]*e;t=s}return t}_createCubicSplineTrackInterpolant(e){e.createInterpolant=function(e){return new(this instanceof t.QuaternionKeyframeTrack?Kt:qt)(this.times,this.values,this.getValueSize()/3,e)},e.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0}}function ms(e,s,r){const i=s.attributes,n=[];function a(t,s){return r.getDependency("accessor",t).then((function(t){e.setAttribute(s,t)}))}for(const t in i){const s=es[t]||t.toLowerCase();s in e.attributes||n.push(a(i[t],s))}if(void 0!==s.indices&&!e.index){const t=r.getDependency("accessor",s.indices).then((function(t){e.setIndex(t)}));n.push(t)}return os(e,s),function(e,s,r){const i=s.attributes,n=new t.Box3;if(void 0===i.POSITION)return;{const e=r.json.accessors[i.POSITION],s=e.min,a=e.max;if(void 0===s||void 0===a)return void console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");if(n.set(new t.Vector3(s[0],s[1],s[2]),new t.Vector3(a[0],a[1],a[2])),e.normalized){const t=us(Zt[e.componentType]);n.min.multiplyScalar(t),n.max.multiplyScalar(t)}}const a=s.targets;if(void 0!==a){const e=new t.Vector3,s=new t.Vector3;for(let t=0,i=a.length;t<i;t++){const i=a[t];if(void 0!==i.POSITION){const t=r.json.accessors[i.POSITION],n=t.min,a=t.max;if(void 0!==n&&void 0!==a){if(s.setX(Math.max(Math.abs(n[0]),Math.abs(a[0]))),s.setY(Math.max(Math.abs(n[1]),Math.abs(a[1]))),s.setZ(Math.max(Math.abs(n[2]),Math.abs(a[2]))),t.normalized){const e=us(Zt[t.componentType]);s.multiplyScalar(e)}e.max(s)}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}n.expandByVector(e)}e.boundingBox=n;const o=new t.Sphere;n.getCenter(o.center),o.radius=n.min.distanceTo(n.max)/2,e.boundingSphere=o}(e,s,r),Promise.all(n).then((function(){return void 0!==s.targets?function(e,t,s){let r=!1,i=!1,n=!1;for(let e=0,s=t.length;e<s;e++){const s=t[e];if(void 0!==s.POSITION&&(r=!0),void 0!==s.NORMAL&&(i=!0),void 0!==s.COLOR_0&&(n=!0),r&&i&&n)break}if(!r&&!i&&!n)return Promise.resolve(e);const a=[],o=[],l=[];for(let h=0,c=t.length;h<c;h++){const c=t[h];if(r){const t=void 0!==c.POSITION?s.getDependency("accessor",c.POSITION):e.attributes.position;a.push(t)}if(i){const t=void 0!==c.NORMAL?s.getDependency("accessor",c.NORMAL):e.attributes.normal;o.push(t)}if(n){const t=void 0!==c.COLOR_0?s.getDependency("accessor",c.COLOR_0):e.attributes.color;l.push(t)}}return Promise.all([Promise.all(a),Promise.all(o),Promise.all(l)]).then((function(t){const s=t[0],a=t[1],o=t[2];return r&&(e.morphAttributes.position=s),i&&(e.morphAttributes.normal=a),n&&(e.morphAttributes.color=o),e.morphTargetsRelative=!0,e}))}(e,s.targets,r):e}))}const fs=new WeakMap;class gs extends t.Loader{constructor(e){super(e),this.decoderPath="",this.decoderConfig={},this.decoderBinary=null,this.decoderPending=null,this.workerLimit=4,this.workerPool=[],this.workerNextTaskID=1,this.workerSourceURL="",this.defaultAttributeIDs={position:"POSITION",normal:"NORMAL",color:"COLOR",uv:"TEX_COORD"},this.defaultAttributeTypes={position:"Float32Array",normal:"Float32Array",color:"Float32Array",uv:"Float32Array"}}setDecoderPath(e){return this.decoderPath=e,this}setDecoderConfig(e){return this.decoderConfig=e,this}setWorkerLimit(e){return this.workerLimit=e,this}load(e,s,r,i){const n=new t.FileLoader(this.manager);n.setPath(this.path),n.setResponseType("arraybuffer"),n.setRequestHeader(this.requestHeader),n.setWithCredentials(this.withCredentials),n.load(e,(e=>{this.parse(e,s,i)}),r,i)}parse(e,s,r){this.decodeDracoFile(e,s,null,null,t.SRGBColorSpace).catch(r)}decodeDracoFile(e,s,r,i,n=t.LinearSRGBColorSpace){const a={attributeIDs:r||this.defaultAttributeIDs,attributeTypes:i||this.defaultAttributeTypes,useUniqueIDs:!!r,vertexColorSpace:n};return this.decodeGeometry(e,a).then(s)}decodeGeometry(e,t){const s=JSON.stringify(t);if(fs.has(e)){const t=fs.get(e);if(t.key===s)return t.promise;if(0===e.byteLength)throw new Error("THREE.DRACOLoader: Unable to re-decode a buffer with different settings. Buffer has already been transferred.")}let r;const i=this.workerNextTaskID++,n=e.byteLength,a=this._getWorker(i,n).then((s=>(r=s,new Promise(((s,n)=>{r._callbacks[i]={resolve:s,reject:n},r.postMessage({type:"decode",id:i,taskConfig:t,buffer:e},[e])}))))).then((e=>this._createGeometry(e.geometry)));return a.catch((()=>!0)).then((()=>{r&&i&&this._releaseTask(r,i)})),fs.set(e,{key:s,promise:a}),a}_createGeometry(e){const s=new t.BufferGeometry;e.index&&s.setIndex(new t.BufferAttribute(e.index.array,1));for(let r=0;r<e.attributes.length;r++){const i=e.attributes[r],n=i.name,a=i.array,o=i.itemSize,l=new t.BufferAttribute(a,o);"color"===n&&(this._assignVertexColorSpace(l,i.vertexColorSpace),l.normalized=a instanceof Float32Array==!1),s.setAttribute(n,l)}return s}_assignVertexColorSpace(e,s){if(s!==t.SRGBColorSpace)return;const r=new t.Color;for(let t=0,s=e.count;t<s;t++)r.fromBufferAttribute(e,t).convertSRGBToLinear(),e.setXYZ(t,r.r,r.g,r.b)}_loadLibrary(e,s){const r=new t.FileLoader(this.manager);return r.setPath(this.decoderPath),r.setResponseType(s),r.setWithCredentials(this.withCredentials),new Promise(((t,s)=>{r.load(e,t,void 0,s)}))}preload(){return this._initDecoder(),this}_initDecoder(){if(this.decoderPending)return this.decoderPending;const e="object"!=typeof WebAssembly||"js"===this.decoderConfig.type,t=[];return e?t.push(this._loadLibrary("draco_decoder.js","text")):(t.push(this._loadLibrary("draco_wasm_wrapper.js","text")),t.push(this._loadLibrary("draco_decoder.wasm","arraybuffer"))),this.decoderPending=Promise.all(t).then((t=>{const s=t[0];e||(this.decoderConfig.wasmBinary=t[1]);const r=ys.toString(),i=["/* draco decoder */",s,"","/* worker */",r.substring(r.indexOf("{")+1,r.lastIndexOf("}"))].join("\n");this.workerSourceURL=URL.createObjectURL(new Blob([i]))})),this.decoderPending}_getWorker(e,t){return this._initDecoder().then((()=>{if(this.workerPool.length<this.workerLimit){const e=new Worker(this.workerSourceURL);e._callbacks={},e._taskCosts={},e._taskLoad=0,e.postMessage({type:"init",decoderConfig:this.decoderConfig}),e.onmessage=function(t){const s=t.data;switch(s.type){case"decode":e._callbacks[s.id].resolve(s);break;case"error":e._callbacks[s.id].reject(s);break;default:console.error('THREE.DRACOLoader: Unexpected message, "'+s.type+'"')}},this.workerPool.push(e)}else this.workerPool.sort((function(e,t){return e._taskLoad>t._taskLoad?-1:1}));const s=this.workerPool[this.workerPool.length-1];return s._taskCosts[e]=t,s._taskLoad+=t,s}))}_releaseTask(e,t){e._taskLoad-=e._taskCosts[t],delete e._callbacks[t],delete e._taskCosts[t]}debug(){console.log("Task load: ",this.workerPool.map((e=>e._taskLoad)))}dispose(){for(let e=0;e<this.workerPool.length;++e)this.workerPool[e].terminate();return this.workerPool.length=0,""!==this.workerSourceURL&&URL.revokeObjectURL(this.workerSourceURL),this}}function ys(){let e,t;function s(e,t,s,r,i,n){const a=n.num_components(),o=s.num_points()*a,l=o*i.BYTES_PER_ELEMENT,h=function(e,t){switch(t){case Float32Array:return e.DT_FLOAT32;case Int8Array:return e.DT_INT8;case Int16Array:return e.DT_INT16;case Int32Array:return e.DT_INT32;case Uint8Array:return e.DT_UINT8;case Uint16Array:return e.DT_UINT16;case Uint32Array:return e.DT_UINT32}}(e,i),c=e._malloc(l);t.GetAttributeDataArrayForAllPoints(s,n,h,l,c);const u=new i(e.HEAPF32.buffer,c,o).slice();return e._free(c),{name:r,array:u,itemSize:a}}onmessage=function(r){const i=r.data;switch(i.type){case"init":e=i.decoderConfig,t=new Promise((function(t){e.onModuleLoaded=function(e){t({draco:e})},DracoDecoderModule(e)}));break;case"decode":const r=i.buffer,n=i.taskConfig;t.then((e=>{const t=e.draco,a=new t.Decoder;try{const e=function(e,t,r,i){const n=i.attributeIDs,a=i.attributeTypes;let o,l;const h=t.GetEncodedGeometryType(r);if(h===e.TRIANGULAR_MESH)o=new e.Mesh,l=t.DecodeArrayToMesh(r,r.byteLength,o);else{if(h!==e.POINT_CLOUD)throw new Error("THREE.DRACOLoader: Unexpected geometry type.");o=new e.PointCloud,l=t.DecodeArrayToPointCloud(r,r.byteLength,o)}if(!l.ok()||0===o.ptr)throw new Error("THREE.DRACOLoader: Decoding failed: "+l.error_msg());const c={index:null,attributes:[]};for(const r in n){const l=self[a[r]];let h,u;if(i.useUniqueIDs)u=n[r],h=t.GetAttributeByUniqueId(o,u);else{if(u=t.GetAttributeId(o,e[n[r]]),-1===u)continue;h=t.GetAttribute(o,u)}const p=s(e,t,o,r,l,h);"color"===r&&(p.vertexColorSpace=i.vertexColorSpace),c.attributes.push(p)}h===e.TRIANGULAR_MESH&&(c.index=function(e,t,s){const r=3*s.num_faces(),i=4*r,n=e._malloc(i);t.GetTrianglesUInt32Array(s,i,n);const a=new Uint32Array(e.HEAPF32.buffer,n,r).slice();return e._free(n),{array:a,itemSize:1}}(e,t,o));return e.destroy(o),c}(t,a,new Int8Array(r),n),o=e.attributes.map((e=>e.array.buffer));e.index&&o.push(e.index.array.buffer),self.postMessage({type:"decode",id:i.id,geometry:e},o)}catch(e){console.error(e),self.postMessage({type:"error",id:i.id,error:e.message})}finally{t.destroy(a)}}))}}}
/*!
  fflate - fast JavaScript compression/decompression
  <https://101arrowz.github.io/fflate>
  Licensed under MIT. https://github.com/101arrowz/fflate/blob/master/LICENSE
  version 0.6.9
  */var bs=function(e){return URL.createObjectURL(new Blob([e],{type:"text/javascript"}))};try{URL.revokeObjectURL(bs(""))}catch(e){bs=function(e){return"data:application/javascript;charset=UTF-8,"+encodeURI(e)}}var xs=Uint8Array,vs=Uint16Array,ws=Uint32Array,Ms=new xs([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),As=new xs([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),Ts=new xs([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),Ss=function(e,t){for(var s=new vs(31),r=0;r<31;++r)s[r]=t+=1<<e[r-1];var i=new ws(s[30]);for(r=1;r<30;++r)for(var n=s[r];n<s[r+1];++n)i[n]=n-s[r]<<5|r;return[s,i]},ks=Ss(Ms,2),Rs=ks[0],Es=ks[1];Rs[28]=258,Es[258]=28;for(var Ps=Ss(As,0)[0],Is=new vs(32768),_s=0;_s<32768;++_s){var Ls=(43690&_s)>>>1|(21845&_s)<<1;Ls=(61680&(Ls=(52428&Ls)>>>2|(13107&Ls)<<2))>>>4|(3855&Ls)<<4,Is[_s]=((65280&Ls)>>>8|(255&Ls)<<8)>>>1}var Cs=function(e,t,s){for(var r=e.length,i=0,n=new vs(t);i<r;++i)++n[e[i]-1];var a,o=new vs(t);for(i=0;i<t;++i)o[i]=o[i-1]+n[i-1]<<1;if(s){a=new vs(1<<t);var l=15-t;for(i=0;i<r;++i)if(e[i])for(var h=i<<4|e[i],c=t-e[i],u=o[e[i]-1]++<<c,p=u|(1<<c)-1;u<=p;++u)a[Is[u]>>>l]=h}else for(a=new vs(r),i=0;i<r;++i)e[i]&&(a[i]=Is[o[e[i]-1]++]>>>15-e[i]);return a},Fs=new xs(288);for(_s=0;_s<144;++_s)Fs[_s]=8;for(_s=144;_s<256;++_s)Fs[_s]=9;for(_s=256;_s<280;++_s)Fs[_s]=7;for(_s=280;_s<288;++_s)Fs[_s]=8;var Bs=new xs(32);for(_s=0;_s<32;++_s)Bs[_s]=5;var Os=Cs(Fs,9,1),zs=Cs(Bs,5,1),Ds=function(e){for(var t=e[0],s=1;s<e.length;++s)e[s]>t&&(t=e[s]);return t},Ns=function(e,t,s){var r=t/8|0;return(e[r]|e[r+1]<<8)>>(7&t)&s},Us=function(e,t){var s=t/8|0;return(e[s]|e[s+1]<<8|e[s+2]<<16)>>(7&t)},Vs=function(e,t,s){var r=e.length;if(!r||s&&!s.l&&r<5)return t||new xs(0);var i=!t||s,n=!s||s.i;s||(s={}),t||(t=new xs(3*r));var a,o=function(e){var s=t.length;if(e>s){var r=new xs(Math.max(2*s,e));r.set(t),t=r}},l=s.f||0,h=s.p||0,c=s.b||0,u=s.l,p=s.d,d=s.m,m=s.n,f=8*r;do{if(!u){s.f=l=Ns(e,h,1);var g=Ns(e,h+1,3);if(h+=3,!g){var y=e[(E=((a=h)/8|0)+(7&a&&1)+4)-4]|e[E-3]<<8,b=E+y;if(b>r){if(n)throw"unexpected EOF";break}i&&o(c+y),t.set(e.subarray(E,b),c),s.b=c+=y,s.p=h=8*b;continue}if(1==g)u=Os,p=zs,d=9,m=5;else{if(2!=g)throw"invalid block type";var x=Ns(e,h,31)+257,v=Ns(e,h+10,15)+4,w=x+Ns(e,h+5,31)+1;h+=14;for(var M=new xs(w),A=new xs(19),T=0;T<v;++T)A[Ts[T]]=Ns(e,h+3*T,7);h+=3*v;var S=Ds(A),k=(1<<S)-1,R=Cs(A,S,1);for(T=0;T<w;){var E,P=R[Ns(e,h,k)];if(h+=15&P,(E=P>>>4)<16)M[T++]=E;else{var I=0,_=0;for(16==E?(_=3+Ns(e,h,3),h+=2,I=M[T-1]):17==E?(_=3+Ns(e,h,7),h+=3):18==E&&(_=11+Ns(e,h,127),h+=7);_--;)M[T++]=I}}var L=M.subarray(0,x),C=M.subarray(x);d=Ds(L),m=Ds(C),u=Cs(L,d,1),p=Cs(C,m,1)}if(h>f){if(n)throw"unexpected EOF";break}}i&&o(c+131072);for(var F=(1<<d)-1,B=(1<<m)-1,O=h;;O=h){var z=(I=u[Us(e,h)&F])>>>4;if((h+=15&I)>f){if(n)throw"unexpected EOF";break}if(!I)throw"invalid length/literal";if(z<256)t[c++]=z;else{if(256==z){O=h,u=null;break}var D=z-254;if(z>264){var N=Ms[T=z-257];D=Ns(e,h,(1<<N)-1)+Rs[T],h+=N}var U=p[Us(e,h)&B],V=U>>>4;if(!U)throw"invalid distance";h+=15&U;C=Ps[V];if(V>3){N=As[V];C+=Us(e,h)&(1<<N)-1,h+=N}if(h>f){if(n)throw"unexpected EOF";break}i&&o(c+131072);for(var j=c+D;c<j;c+=4)t[c]=t[c-C],t[c+1]=t[c+1-C],t[c+2]=t[c+2-C],t[c+3]=t[c+3-C];c=j}}s.l=u,s.p=O,s.b=c,u&&(l=1,s.m=d,s.d=p,s.n=m)}while(!l);return c==t.length?t:function(e,t,s){(null==t||t<0)&&(t=0),(null==s||s>e.length)&&(s=e.length);var r=new(e instanceof vs?vs:e instanceof ws?ws:xs)(s-t);return r.set(e.subarray(t,s)),r}(t,0,c)},js=new xs(0);function Gs(e,t){return Vs((function(e){if(8!=(15&e[0])||e[0]>>>4>7||(e[0]<<8|e[1])%31)throw"invalid zlib data";if(32&e[1])throw"invalid zlib data: preset dictionaries not supported"}(e),e.subarray(2,-4)),t)}var Hs="undefined"!=typeof TextDecoder&&new TextDecoder;try{Hs.decode(js,{stream:!0}),1}catch(e){}function Ws(e,t,s){const r=s.length-e-1;if(t>=s[r])return r-1;if(t<=s[e])return e;let i=e,n=r,a=Math.floor((i+n)/2);for(;t<s[a]||t>=s[a+1];)t<s[a]?n=a:i=a,a=Math.floor((i+n)/2);return a}function qs(e,t){let s=1;for(let t=2;t<=e;++t)s*=t;let r=1;for(let e=2;e<=t;++e)r*=e;for(let s=2;s<=e-t;++s)r*=s;return s/r}function Xs(e,s,r,i,n){return function(e){const s=e.length,r=[],i=[];for(let n=0;n<s;++n){const s=e[n];r[n]=new t.Vector3(s.x,s.y,s.z),i[n]=s.w}const n=[];for(let e=0;e<s;++e){const t=r[e].clone();for(let s=1;s<=e;++s)t.sub(n[e-s].clone().multiplyScalar(qs(e,s)*i[s]));n[e]=t.divideScalar(i[0])}return n}(function(e,s,r,i,n){const a=n<e?n:e,o=[],l=Ws(e,i,s),h=function(e,t,s,r,i){const n=[];for(let e=0;e<=s;++e)n[e]=0;const a=[];for(let e=0;e<=r;++e)a[e]=n.slice(0);const o=[];for(let e=0;e<=s;++e)o[e]=n.slice(0);o[0][0]=1;const l=n.slice(0),h=n.slice(0);for(let r=1;r<=s;++r){l[r]=t-i[e+1-r],h[r]=i[e+r]-t;let s=0;for(let e=0;e<r;++e){const t=h[e+1],i=l[r-e];o[r][e]=t+i;const n=o[e][r-1]/o[r][e];o[e][r]=s+t*n,s=i*n}o[r][r]=s}for(let e=0;e<=s;++e)a[0][e]=o[e][s];for(let e=0;e<=s;++e){let t=0,i=1;const l=[];for(let e=0;e<=s;++e)l[e]=n.slice(0);l[0][0]=1;for(let n=1;n<=r;++n){let r=0;const h=e-n,c=s-n;e>=n&&(l[i][0]=l[t][0]/o[c+1][h],r=l[i][0]*o[h][c]);const u=e-1<=c?n-1:s-e;for(let e=h>=-1?1:-h;e<=u;++e)l[i][e]=(l[t][e]-l[t][e-1])/o[c+1][h+e],r+=l[i][e]*o[h+e][c];e<=c&&(l[i][n]=-l[t][n-1]/o[c+1][e],r+=l[i][n]*o[e][c]),a[n][e]=r;const p=t;t=i,i=p}}let c=s;for(let e=1;e<=r;++e){for(let t=0;t<=s;++t)a[e][t]*=c;c*=s-e}return a}(l,i,e,a,s),c=[];for(let e=0;e<r.length;++e){const t=r[e].clone(),s=t.w;t.x*=s,t.y*=s,t.z*=s,c[e]=t}for(let t=0;t<=a;++t){const s=c[l-e].clone().multiplyScalar(h[t][0]);for(let r=1;r<=e;++r)s.add(c[l-e+r].clone().multiplyScalar(h[t][r]));o[t]=s}for(let e=a+1;e<=n+1;++e)o[e]=new t.Vector4(0,0,0);return o}(e,s,r,i,n))}class Ks extends t.Curve{constructor(e,s,r,i,n){super(),this.degree=e,this.knots=s,this.controlPoints=[],this.startKnot=i||0,this.endKnot=n||this.knots.length-1;for(let e=0;e<r.length;++e){const s=r[e];this.controlPoints[e]=new t.Vector4(s.x,s.y,s.z,s.w)}}getPoint(e,s=new t.Vector3){const r=s,i=this.knots[this.startKnot]+e*(this.knots[this.endKnot]-this.knots[this.startKnot]),n=function(e,s,r,i){const n=Ws(e,i,s),a=function(e,t,s,r){const i=[],n=[],a=[];i[0]=1;for(let o=1;o<=s;++o){n[o]=t-r[e+1-o],a[o]=r[e+o]-t;let s=0;for(let e=0;e<o;++e){const t=a[e+1],r=n[o-e],l=i[e]/(t+r);i[e]=s+t*l,s=r*l}i[o]=s}return i}(n,i,e,s),o=new t.Vector4(0,0,0,0);for(let t=0;t<=e;++t){const s=r[n-e+t],i=a[t],l=s.w*i;o.x+=s.x*l,o.y+=s.y*l,o.z+=s.z*l,o.w+=s.w*i}return o}(this.degree,this.knots,this.controlPoints,i);return 1!==n.w&&n.divideScalar(n.w),r.set(n.x,n.y,n.z)}getTangent(e,s=new t.Vector3){const r=s,i=this.knots[0]+e*(this.knots[this.knots.length-1]-this.knots[0]),n=Xs(this.degree,this.knots,this.controlPoints,i,1);return r.copy(n[1]).normalize(),r}}let Qs,Zs,Ys;class Js extends t.Loader{constructor(e){super(e)}load(e,s,r,i){const n=this,a=""===n.path?t.LoaderUtils.extractUrlBase(e):n.path,o=new t.FileLoader(this.manager);o.setPath(n.path),o.setResponseType("arraybuffer"),o.setRequestHeader(n.requestHeader),o.setWithCredentials(n.withCredentials),o.load(e,(function(t){try{s(n.parse(t,a))}catch(t){i?i(t):console.error(t),n.manager.itemError(e)}}),r,i)}parse(e,s){if(function(e){const t="Kaydara FBX Binary  \0";return e.byteLength>=t.length&&t===fr(e,0,t.length)}(e))Qs=(new rr).parse(e);else{const t=fr(e);if(!function(e){const t=["K","a","y","d","a","r","a","\\","F","B","X","\\","B","i","n","a","r","y","\\","\\"];let s=0;function r(t){const r=e[t-1];return e=e.slice(s+t),s++,r}for(let e=0;e<t.length;++e){if(r(1)===t[e])return!1}return!0}(t))throw new Error("THREE.FBXLoader: Unknown format.");if(ar(t)<7e3)throw new Error("THREE.FBXLoader: FBX version not supported, FileVersion: "+ar(t));Qs=(new sr).parse(t)}const r=new t.TextureLoader(this.manager).setPath(this.resourcePath||s).setCrossOrigin(this.crossOrigin);return new $s(r,this.manager).parse(Qs)}}class $s{constructor(e,t){this.textureLoader=e,this.manager=t}parse(){Zs=this.parseConnections();const e=this.parseImages(),t=this.parseTextures(e),s=this.parseMaterials(t),r=this.parseDeformers(),i=(new er).parse(r);return this.parseScene(r,i,s),Ys}parseConnections(){const e=new Map;if("Connections"in Qs){Qs.Connections.connections.forEach((function(t){const s=t[0],r=t[1],i=t[2];e.has(s)||e.set(s,{parents:[],children:[]});const n={ID:r,relationship:i};e.get(s).parents.push(n),e.has(r)||e.set(r,{parents:[],children:[]});const a={ID:s,relationship:i};e.get(r).children.push(a)}))}return e}parseImages(){const e={},t={};if("Video"in Qs.Objects){const s=Qs.Objects.Video;for(const r in s){const i=s[r];if(e[parseInt(r)]=i.RelativeFilename||i.Filename,"Content"in i){const e=i.Content instanceof ArrayBuffer&&i.Content.byteLength>0,n="string"==typeof i.Content&&""!==i.Content;if(e||n){const e=this.parseImage(s[r]);t[i.RelativeFilename||i.Filename]=e}}}}for(const s in e){const r=e[s];void 0!==t[r]?e[s]=t[r]:e[s]=e[s].split("\\").pop()}return e}parseImage(e){const t=e.Content,s=e.RelativeFilename||e.Filename,r=s.slice(s.lastIndexOf(".")+1).toLowerCase();let i;switch(r){case"bmp":i="image/bmp";break;case"jpg":case"jpeg":i="image/jpeg";break;case"png":i="image/png";break;case"tif":i="image/tiff";break;case"tga":null===this.manager.getHandler(".tga")&&console.warn("FBXLoader: TGA loader not found, skipping ",s),i="image/tga";break;default:return void console.warn('FBXLoader: Image type "'+r+'" is not supported.')}if("string"==typeof t)return"data:"+i+";base64,"+t;{const e=new Uint8Array(t);return window.URL.createObjectURL(new Blob([e],{type:i}))}}parseTextures(e){const t=new Map;if("Texture"in Qs.Objects){const s=Qs.Objects.Texture;for(const r in s){const i=this.parseTexture(s[r],e);t.set(parseInt(r),i)}}return t}parseTexture(e,s){const r=this.loadTexture(e,s);r.ID=e.id,r.name=e.attrName;const i=e.WrapModeU,n=e.WrapModeV,a=void 0!==i?i.value:0,o=void 0!==n?n.value:0;if(r.wrapS=0===a?t.RepeatWrapping:t.ClampToEdgeWrapping,r.wrapT=0===o?t.RepeatWrapping:t.ClampToEdgeWrapping,"Scaling"in e){const t=e.Scaling.value;r.repeat.x=t[0],r.repeat.y=t[1]}if("Translation"in e){const t=e.Translation.value;r.offset.x=t[0],r.offset.y=t[1]}return r}loadTexture(e,s){let r;const i=this.textureLoader.path,n=Zs.get(e.id).children;let a;void 0!==n&&n.length>0&&void 0!==s[n[0].ID]&&(r=s[n[0].ID],0!==r.indexOf("blob:")&&0!==r.indexOf("data:")||this.textureLoader.setPath(void 0));const o=e.FileName.slice(-3).toLowerCase();if("tga"===o){const s=this.manager.getHandler(".tga");null===s?(console.warn("FBXLoader: TGA loader not found, creating placeholder texture for",e.RelativeFilename),a=new t.Texture):(s.setPath(this.textureLoader.path),a=s.load(r))}else"psd"===o?(console.warn("FBXLoader: PSD textures are not supported, creating placeholder texture for",e.RelativeFilename),a=new t.Texture):a=this.textureLoader.load(r);return this.textureLoader.setPath(i),a}parseMaterials(e){const t=new Map;if("Material"in Qs.Objects){const s=Qs.Objects.Material;for(const r in s){const i=this.parseMaterial(s[r],e);null!==i&&t.set(parseInt(r),i)}}return t}parseMaterial(e,s){const r=e.id,i=e.attrName;let n=e.ShadingModel;if("object"==typeof n&&(n=n.value),!Zs.has(r))return null;const a=this.parseParameters(e,s,r);let o;switch(n.toLowerCase()){case"phong":o=new t.MeshPhongMaterial;break;case"lambert":o=new t.MeshLambertMaterial;break;default:console.warn('THREE.FBXLoader: unknown material type "%s". Defaulting to MeshPhongMaterial.',n),o=new t.MeshPhongMaterial}return o.setValues(a),o.name=i,o}parseParameters(e,s,r){const i={};e.BumpFactor&&(i.bumpScale=e.BumpFactor.value),e.Diffuse?i.color=(new t.Color).fromArray(e.Diffuse.value).convertSRGBToLinear():!e.DiffuseColor||"Color"!==e.DiffuseColor.type&&"ColorRGB"!==e.DiffuseColor.type||(i.color=(new t.Color).fromArray(e.DiffuseColor.value).convertSRGBToLinear()),e.DisplacementFactor&&(i.displacementScale=e.DisplacementFactor.value),e.Emissive?i.emissive=(new t.Color).fromArray(e.Emissive.value).convertSRGBToLinear():!e.EmissiveColor||"Color"!==e.EmissiveColor.type&&"ColorRGB"!==e.EmissiveColor.type||(i.emissive=(new t.Color).fromArray(e.EmissiveColor.value).convertSRGBToLinear()),e.EmissiveFactor&&(i.emissiveIntensity=parseFloat(e.EmissiveFactor.value)),e.Opacity&&(i.opacity=parseFloat(e.Opacity.value)),i.opacity<1&&(i.transparent=!0),e.ReflectionFactor&&(i.reflectivity=e.ReflectionFactor.value),e.Shininess&&(i.shininess=e.Shininess.value),e.Specular?i.specular=(new t.Color).fromArray(e.Specular.value).convertSRGBToLinear():e.SpecularColor&&"Color"===e.SpecularColor.type&&(i.specular=(new t.Color).fromArray(e.SpecularColor.value).convertSRGBToLinear());const n=this;return Zs.get(r).children.forEach((function(e){const r=e.relationship;switch(r){case"Bump":i.bumpMap=n.getTexture(s,e.ID);break;case"Maya|TEX_ao_map":i.aoMap=n.getTexture(s,e.ID);break;case"DiffuseColor":case"Maya|TEX_color_map":i.map=n.getTexture(s,e.ID),void 0!==i.map&&(i.map.colorSpace=t.SRGBColorSpace);break;case"DisplacementColor":i.displacementMap=n.getTexture(s,e.ID);break;case"EmissiveColor":i.emissiveMap=n.getTexture(s,e.ID),void 0!==i.emissiveMap&&(i.emissiveMap.colorSpace=t.SRGBColorSpace);break;case"NormalMap":case"Maya|TEX_normal_map":i.normalMap=n.getTexture(s,e.ID);break;case"ReflectionColor":i.envMap=n.getTexture(s,e.ID),void 0!==i.envMap&&(i.envMap.mapping=t.EquirectangularReflectionMapping,i.envMap.colorSpace=t.SRGBColorSpace);break;case"SpecularColor":i.specularMap=n.getTexture(s,e.ID),void 0!==i.specularMap&&(i.specularMap.colorSpace=t.SRGBColorSpace);break;case"TransparentColor":case"TransparencyFactor":i.alphaMap=n.getTexture(s,e.ID),i.transparent=!0;break;case"AmbientColor":case"ShininessExponent":case"SpecularFactor":case"VectorDisplacementColor":default:console.warn("THREE.FBXLoader: %s map is not supported in three.js, skipping texture.",r)}})),i}getTexture(e,t){return"LayeredTexture"in Qs.Objects&&t in Qs.Objects.LayeredTexture&&(console.warn("THREE.FBXLoader: layered textures are not supported in three.js. Discarding all but first layer."),t=Zs.get(t).children[0].ID),e.get(t)}parseDeformers(){const e={},t={};if("Deformer"in Qs.Objects){const s=Qs.Objects.Deformer;for(const r in s){const i=s[r],n=Zs.get(parseInt(r));if("Skin"===i.attrType){const t=this.parseSkeleton(n,s);t.ID=r,n.parents.length>1&&console.warn("THREE.FBXLoader: skeleton attached to more than one geometry is not supported."),t.geometryID=n.parents[0].ID,e[r]=t}else if("BlendShape"===i.attrType){const e={id:r};e.rawTargets=this.parseMorphTargets(n,s),e.id=r,n.parents.length>1&&console.warn("THREE.FBXLoader: morph target attached to more than one geometry is not supported."),t[r]=e}}}return{skeletons:e,morphTargets:t}}parseSkeleton(e,s){const r=[];return e.children.forEach((function(e){const i=s[e.ID];if("Cluster"!==i.attrType)return;const n={ID:e.ID,indices:[],weights:[],transformLink:(new t.Matrix4).fromArray(i.TransformLink.a)};"Indexes"in i&&(n.indices=i.Indexes.a,n.weights=i.Weights.a),r.push(n)})),{rawBones:r,bones:[]}}parseMorphTargets(e,t){const s=[];for(let r=0;r<e.children.length;r++){const i=e.children[r],n=t[i.ID],a={name:n.attrName,initialWeight:n.DeformPercent,id:n.id,fullWeights:n.FullWeights.a};if("BlendShapeChannel"!==n.attrType)return;a.geoID=Zs.get(parseInt(i.ID)).children.filter((function(e){return void 0===e.relationship}))[0].ID,s.push(a)}return s}parseScene(e,s,r){Ys=new t.Group;const i=this.parseModels(e.skeletons,s,r),n=Qs.Objects.Model,a=this;i.forEach((function(e){const t=n[e.ID];a.setLookAtProperties(e,t);Zs.get(e.ID).parents.forEach((function(t){const s=i.get(t.ID);void 0!==s&&s.add(e)})),null===e.parent&&Ys.add(e)})),this.bindSkeleton(e.skeletons,s,i),this.createAmbientLight(),Ys.traverse((function(e){if(e.userData.transformData){e.parent&&(e.userData.transformData.parentMatrix=e.parent.matrix,e.userData.transformData.parentMatrixWorld=e.parent.matrixWorld);const t=pr(e.userData.transformData);e.applyMatrix4(t),e.updateWorldMatrix()}}));const o=(new tr).parse();1===Ys.children.length&&Ys.children[0].isGroup&&(Ys.children[0].animations=o,Ys=Ys.children[0]),Ys.animations=o}parseModels(e,s,r){const i=new Map,n=Qs.Objects.Model;for(const a in n){const o=parseInt(a),l=n[a],h=Zs.get(o);let c=this.buildSkeleton(h,e,o,l.attrName);if(!c){switch(l.attrType){case"Camera":c=this.createCamera(h);break;case"Light":c=this.createLight(h);break;case"Mesh":c=this.createMesh(h,s,r);break;case"NurbsCurve":c=this.createCurve(h,s);break;case"LimbNode":case"Root":c=new t.Bone;break;case"Null":default:c=new t.Group}c.name=l.attrName?t.PropertyBinding.sanitizeNodeName(l.attrName):"",c.ID=o}this.getTransformData(c,l),i.set(o,c)}return i}buildSkeleton(e,s,r,i){let n=null;return e.parents.forEach((function(e){for(const a in s){const o=s[a];o.rawBones.forEach((function(s,a){if(s.ID===e.ID){const e=n;n=new t.Bone,n.matrixWorld.copy(s.transformLink),n.name=i?t.PropertyBinding.sanitizeNodeName(i):"",n.ID=r,o.bones[a]=n,null!==e&&n.add(e)}}))}})),n}createCamera(e){let s,r;if(e.children.forEach((function(e){const t=Qs.Objects.NodeAttribute[e.ID];void 0!==t&&(r=t)})),void 0===r)s=new t.Object3D;else{let e=0;void 0!==r.CameraProjectionType&&1===r.CameraProjectionType.value&&(e=1);let i=1;void 0!==r.NearPlane&&(i=r.NearPlane.value/1e3);let n=1e3;void 0!==r.FarPlane&&(n=r.FarPlane.value/1e3);let a=window.innerWidth,o=window.innerHeight;void 0!==r.AspectWidth&&void 0!==r.AspectHeight&&(a=r.AspectWidth.value,o=r.AspectHeight.value);const l=a/o;let h=45;void 0!==r.FieldOfView&&(h=r.FieldOfView.value);const c=r.FocalLength?r.FocalLength.value:null;switch(e){case 0:s=new t.PerspectiveCamera(h,l,i,n),null!==c&&s.setFocalLength(c);break;case 1:s=new t.OrthographicCamera(-a/2,a/2,o/2,-o/2,i,n);break;default:console.warn("THREE.FBXLoader: Unknown camera type "+e+"."),s=new t.Object3D}}return s}createLight(e){let s,r;if(e.children.forEach((function(e){const t=Qs.Objects.NodeAttribute[e.ID];void 0!==t&&(r=t)})),void 0===r)s=new t.Object3D;else{let e;e=void 0===r.LightType?0:r.LightType.value;let i=16777215;void 0!==r.Color&&(i=(new t.Color).fromArray(r.Color.value).convertSRGBToLinear());let n=void 0===r.Intensity?1:r.Intensity.value/100;void 0!==r.CastLightOnObject&&0===r.CastLightOnObject.value&&(n=0);let a=0;void 0!==r.FarAttenuationEnd&&(a=void 0!==r.EnableFarAttenuation&&0===r.EnableFarAttenuation.value?0:r.FarAttenuationEnd.value);const o=1;switch(e){case 0:s=new t.PointLight(i,n,a,o);break;case 1:s=new t.DirectionalLight(i,n);break;case 2:let e=Math.PI/3;void 0!==r.InnerAngle&&(e=t.MathUtils.degToRad(r.InnerAngle.value));let l=0;void 0!==r.OuterAngle&&(l=t.MathUtils.degToRad(r.OuterAngle.value),l=Math.max(l,1)),s=new t.SpotLight(i,n,a,e,l,o);break;default:console.warn("THREE.FBXLoader: Unknown light type "+r.LightType.value+", defaulting to a PointLight."),s=new t.PointLight(i,n)}void 0!==r.CastShadows&&1===r.CastShadows.value&&(s.castShadow=!0)}return s}createMesh(e,s,r){let i,n=null,a=null;const o=[];return e.children.forEach((function(e){s.has(e.ID)&&(n=s.get(e.ID)),r.has(e.ID)&&o.push(r.get(e.ID))})),o.length>1?a=o:o.length>0?a=o[0]:(a=new t.MeshPhongMaterial({color:13421772}),o.push(a)),"color"in n.attributes&&o.forEach((function(e){e.vertexColors=!0})),n.FBX_Deformer?(i=new t.SkinnedMesh(n,a),i.normalizeSkinWeights()):i=new t.Mesh(n,a),i}createCurve(e,s){const r=e.children.reduce((function(e,t){return s.has(t.ID)&&(e=s.get(t.ID)),e}),null),i=new t.LineBasicMaterial({color:3342591,linewidth:1});return new t.Line(r,i)}getTransformData(e,t){const s={};"InheritType"in t&&(s.inheritType=parseInt(t.InheritType.value)),s.eulerOrder="RotationOrder"in t?dr(t.RotationOrder.value):"ZYX","Lcl_Translation"in t&&(s.translation=t.Lcl_Translation.value),"PreRotation"in t&&(s.preRotation=t.PreRotation.value),"Lcl_Rotation"in t&&(s.rotation=t.Lcl_Rotation.value),"PostRotation"in t&&(s.postRotation=t.PostRotation.value),"Lcl_Scaling"in t&&(s.scale=t.Lcl_Scaling.value),"ScalingOffset"in t&&(s.scalingOffset=t.ScalingOffset.value),"ScalingPivot"in t&&(s.scalingPivot=t.ScalingPivot.value),"RotationOffset"in t&&(s.rotationOffset=t.RotationOffset.value),"RotationPivot"in t&&(s.rotationPivot=t.RotationPivot.value),e.userData.transformData=s}setLookAtProperties(e,s){if("LookAtProperty"in s){Zs.get(e.ID).children.forEach((function(s){if("LookAtProperty"===s.relationship){const r=Qs.Objects.Model[s.ID];if("Lcl_Translation"in r){const s=r.Lcl_Translation.value;void 0!==e.target?(e.target.position.fromArray(s),Ys.add(e.target)):e.lookAt((new t.Vector3).fromArray(s))}}}))}}bindSkeleton(e,s,r){const i=this.parsePoseNodes();for(const n in e){const a=e[n];Zs.get(parseInt(a.ID)).parents.forEach((function(e){if(s.has(e.ID)){const s=e.ID;Zs.get(s).parents.forEach((function(e){if(r.has(e.ID)){r.get(e.ID).bind(new t.Skeleton(a.bones),i[e.ID])}}))}}))}}parsePoseNodes(){const e={};if("Pose"in Qs.Objects){const s=Qs.Objects.Pose;for(const r in s)if("BindPose"===s[r].attrType&&s[r].NbPoseNodes>0){const i=s[r].PoseNode;Array.isArray(i)?i.forEach((function(s){e[s.Node]=(new t.Matrix4).fromArray(s.Matrix.a)})):e[i.Node]=(new t.Matrix4).fromArray(i.Matrix.a)}}return e}createAmbientLight(){if("GlobalSettings"in Qs&&"AmbientColor"in Qs.GlobalSettings){const e=Qs.GlobalSettings.AmbientColor.value,s=e[0],r=e[1],i=e[2];if(0!==s||0!==r||0!==i){const e=new t.Color(s,r,i).convertSRGBToLinear();Ys.add(new t.AmbientLight(e,1))}}}}class er{constructor(){this.negativeMaterialIndices=!1}parse(e){const t=new Map;if("Geometry"in Qs.Objects){const s=Qs.Objects.Geometry;for(const r in s){const i=Zs.get(parseInt(r)),n=this.parseGeometry(i,s[r],e);t.set(parseInt(r),n)}}return!0===this.negativeMaterialIndices&&console.warn("THREE.FBXLoader: The FBX file contains invalid (negative) material indices. The asset might not render as expected."),t}parseGeometry(e,t,s){switch(t.attrType){case"Mesh":return this.parseMeshGeometry(e,t,s);case"NurbsCurve":return this.parseNurbsGeometry(t)}}parseMeshGeometry(e,t,s){const r=s.skeletons,i=[],n=e.parents.map((function(e){return Qs.Objects.Model[e.ID]}));if(0===n.length)return;const a=e.children.reduce((function(e,t){return void 0!==r[t.ID]&&(e=r[t.ID]),e}),null);e.children.forEach((function(e){void 0!==s.morphTargets[e.ID]&&i.push(s.morphTargets[e.ID])}));const o=n[0],l={};"RotationOrder"in o&&(l.eulerOrder=dr(o.RotationOrder.value)),"InheritType"in o&&(l.inheritType=parseInt(o.InheritType.value)),"GeometricTranslation"in o&&(l.translation=o.GeometricTranslation.value),"GeometricRotation"in o&&(l.rotation=o.GeometricRotation.value),"GeometricScaling"in o&&(l.scale=o.GeometricScaling.value);const h=pr(l);return this.genGeometry(t,a,i,h)}genGeometry(e,s,r,i){const n=new t.BufferGeometry;e.attrName&&(n.name=e.attrName);const a=this.parseGeoNode(e,s),o=this.genBuffers(a),l=new t.Float32BufferAttribute(o.vertex,3);if(l.applyMatrix4(i),n.setAttribute("position",l),o.colors.length>0&&n.setAttribute("color",new t.Float32BufferAttribute(o.colors,3)),s&&(n.setAttribute("skinIndex",new t.Uint16BufferAttribute(o.weightsIndices,4)),n.setAttribute("skinWeight",new t.Float32BufferAttribute(o.vertexWeights,4)),n.FBX_Deformer=s),o.normal.length>0){const e=(new t.Matrix3).getNormalMatrix(i),s=new t.Float32BufferAttribute(o.normal,3);s.applyNormalMatrix(e),n.setAttribute("normal",s)}if(o.uvs.forEach((function(e,s){let r="uv"+(s+1).toString();0===s&&(r="uv"),n.setAttribute(r,new t.Float32BufferAttribute(o.uvs[s],2))})),a.material&&"AllSame"!==a.material.mappingType){let e=o.materialIndex[0],t=0;if(o.materialIndex.forEach((function(s,r){s!==e&&(n.addGroup(t,r-t,e),e=s,t=r)})),n.groups.length>0){const t=n.groups[n.groups.length-1],s=t.start+t.count;s!==o.materialIndex.length&&n.addGroup(s,o.materialIndex.length-s,e)}0===n.groups.length&&n.addGroup(0,o.materialIndex.length,o.materialIndex[0])}return this.addMorphTargets(n,e,r,i),n}parseGeoNode(e,t){const s={};if(s.vertexPositions=void 0!==e.Vertices?e.Vertices.a:[],s.vertexIndices=void 0!==e.PolygonVertexIndex?e.PolygonVertexIndex.a:[],e.LayerElementColor&&(s.color=this.parseVertexColors(e.LayerElementColor[0])),e.LayerElementMaterial&&(s.material=this.parseMaterialIndices(e.LayerElementMaterial[0])),e.LayerElementNormal&&(s.normal=this.parseNormals(e.LayerElementNormal[0])),e.LayerElementUV){s.uv=[];let t=0;for(;e.LayerElementUV[t];)e.LayerElementUV[t].UV&&s.uv.push(this.parseUVs(e.LayerElementUV[t])),t++}return s.weightTable={},null!==t&&(s.skeleton=t,t.rawBones.forEach((function(e,t){e.indices.forEach((function(r,i){void 0===s.weightTable[r]&&(s.weightTable[r]=[]),s.weightTable[r].push({id:t,weight:e.weights[i]})}))}))),s}genBuffers(e){const t={vertex:[],normal:[],colors:[],uvs:[],materialIndex:[],vertexWeights:[],weightsIndices:[]};let s=0,r=0,i=!1,n=[],a=[],o=[],l=[],h=[],c=[];const u=this;return e.vertexIndices.forEach((function(p,d){let m,f=!1;p<0&&(p^=-1,f=!0);let g=[],y=[];if(n.push(3*p,3*p+1,3*p+2),e.color){const t=hr(d,s,p,e.color);o.push(t[0],t[1],t[2])}if(e.skeleton){if(void 0!==e.weightTable[p]&&e.weightTable[p].forEach((function(e){y.push(e.weight),g.push(e.id)})),y.length>4){i||(console.warn("THREE.FBXLoader: Vertex has more than 4 skinning weights assigned to vertex. Deleting additional weights."),i=!0);const e=[0,0,0,0],t=[0,0,0,0];y.forEach((function(s,r){let i=s,n=g[r];t.forEach((function(t,s,r){if(i>t){r[s]=i,i=t;const a=e[s];e[s]=n,n=a}}))})),g=e,y=t}for(;y.length<4;)y.push(0),g.push(0);for(let e=0;e<4;++e)h.push(y[e]),c.push(g[e])}if(e.normal){const t=hr(d,s,p,e.normal);a.push(t[0],t[1],t[2])}e.material&&"AllSame"!==e.material.mappingType&&(m=hr(d,s,p,e.material)[0],m<0&&(u.negativeMaterialIndices=!0,m=0)),e.uv&&e.uv.forEach((function(e,t){const r=hr(d,s,p,e);void 0===l[t]&&(l[t]=[]),l[t].push(r[0]),l[t].push(r[1])})),r++,f&&(r>4&&console.warn("THREE.FBXLoader: Polygons with more than four sides are not supported. Make sure to triangulate the geometry during export."),u.genFace(t,e,n,m,a,o,l,h,c,r),s++,r=0,n=[],a=[],o=[],l=[],h=[],c=[])})),t}genFace(e,t,s,r,i,n,a,o,l,h){for(let c=2;c<h;c++)e.vertex.push(t.vertexPositions[s[0]]),e.vertex.push(t.vertexPositions[s[1]]),e.vertex.push(t.vertexPositions[s[2]]),e.vertex.push(t.vertexPositions[s[3*(c-1)]]),e.vertex.push(t.vertexPositions[s[3*(c-1)+1]]),e.vertex.push(t.vertexPositions[s[3*(c-1)+2]]),e.vertex.push(t.vertexPositions[s[3*c]]),e.vertex.push(t.vertexPositions[s[3*c+1]]),e.vertex.push(t.vertexPositions[s[3*c+2]]),t.skeleton&&(e.vertexWeights.push(o[0]),e.vertexWeights.push(o[1]),e.vertexWeights.push(o[2]),e.vertexWeights.push(o[3]),e.vertexWeights.push(o[4*(c-1)]),e.vertexWeights.push(o[4*(c-1)+1]),e.vertexWeights.push(o[4*(c-1)+2]),e.vertexWeights.push(o[4*(c-1)+3]),e.vertexWeights.push(o[4*c]),e.vertexWeights.push(o[4*c+1]),e.vertexWeights.push(o[4*c+2]),e.vertexWeights.push(o[4*c+3]),e.weightsIndices.push(l[0]),e.weightsIndices.push(l[1]),e.weightsIndices.push(l[2]),e.weightsIndices.push(l[3]),e.weightsIndices.push(l[4*(c-1)]),e.weightsIndices.push(l[4*(c-1)+1]),e.weightsIndices.push(l[4*(c-1)+2]),e.weightsIndices.push(l[4*(c-1)+3]),e.weightsIndices.push(l[4*c]),e.weightsIndices.push(l[4*c+1]),e.weightsIndices.push(l[4*c+2]),e.weightsIndices.push(l[4*c+3])),t.color&&(e.colors.push(n[0]),e.colors.push(n[1]),e.colors.push(n[2]),e.colors.push(n[3*(c-1)]),e.colors.push(n[3*(c-1)+1]),e.colors.push(n[3*(c-1)+2]),e.colors.push(n[3*c]),e.colors.push(n[3*c+1]),e.colors.push(n[3*c+2])),t.material&&"AllSame"!==t.material.mappingType&&(e.materialIndex.push(r),e.materialIndex.push(r),e.materialIndex.push(r)),t.normal&&(e.normal.push(i[0]),e.normal.push(i[1]),e.normal.push(i[2]),e.normal.push(i[3*(c-1)]),e.normal.push(i[3*(c-1)+1]),e.normal.push(i[3*(c-1)+2]),e.normal.push(i[3*c]),e.normal.push(i[3*c+1]),e.normal.push(i[3*c+2])),t.uv&&t.uv.forEach((function(t,s){void 0===e.uvs[s]&&(e.uvs[s]=[]),e.uvs[s].push(a[s][0]),e.uvs[s].push(a[s][1]),e.uvs[s].push(a[s][2*(c-1)]),e.uvs[s].push(a[s][2*(c-1)+1]),e.uvs[s].push(a[s][2*c]),e.uvs[s].push(a[s][2*c+1])}))}addMorphTargets(e,t,s,r){if(0===s.length)return;e.morphTargetsRelative=!0,e.morphAttributes.position=[];const i=this;s.forEach((function(s){s.rawTargets.forEach((function(s){const n=Qs.Objects.Geometry[s.geoID];void 0!==n&&i.genMorphGeometry(e,t,n,r,s.name)}))}))}genMorphGeometry(e,s,r,i,n){const a=void 0!==s.PolygonVertexIndex?s.PolygonVertexIndex.a:[],o=void 0!==r.Vertices?r.Vertices.a:[],l=void 0!==r.Indexes?r.Indexes.a:[],h=3*e.attributes.position.count,c=new Float32Array(h);for(let e=0;e<l.length;e++){const t=3*l[e];c[t]=o[3*e],c[t+1]=o[3*e+1],c[t+2]=o[3*e+2]}const u={vertexIndices:a,vertexPositions:c},p=this.genBuffers(u),d=new t.Float32BufferAttribute(p.vertex,3);d.name=n||r.attrName,d.applyMatrix4(i),e.morphAttributes.position.push(d)}parseNormals(e){const t=e.MappingInformationType,s=e.ReferenceInformationType,r=e.Normals.a;let i=[];return"IndexToDirect"===s&&("NormalIndex"in e?i=e.NormalIndex.a:"NormalsIndex"in e&&(i=e.NormalsIndex.a)),{dataSize:3,buffer:r,indices:i,mappingType:t,referenceType:s}}parseUVs(e){const t=e.MappingInformationType,s=e.ReferenceInformationType,r=e.UV.a;let i=[];return"IndexToDirect"===s&&(i=e.UVIndex.a),{dataSize:2,buffer:r,indices:i,mappingType:t,referenceType:s}}parseVertexColors(e){const s=e.MappingInformationType,r=e.ReferenceInformationType,i=e.Colors.a;let n=[];"IndexToDirect"===r&&(n=e.ColorIndex.a);for(let e=0,s=new t.Color;e<i.length;e+=4)s.fromArray(i,e).convertSRGBToLinear().toArray(i,e);return{dataSize:4,buffer:i,indices:n,mappingType:s,referenceType:r}}parseMaterialIndices(e){const t=e.MappingInformationType,s=e.ReferenceInformationType;if("NoMappingInformation"===t)return{dataSize:1,buffer:[0],indices:[0],mappingType:"AllSame",referenceType:s};const r=e.Materials.a,i=[];for(let e=0;e<r.length;++e)i.push(e);return{dataSize:1,buffer:r,indices:i,mappingType:t,referenceType:s}}parseNurbsGeometry(e){const s=parseInt(e.Order);if(isNaN(s))return console.error("THREE.FBXLoader: Invalid Order %s given for geometry ID: %s",e.Order,e.id),new t.BufferGeometry;const r=s-1,i=e.KnotVector.a,n=[],a=e.Points.a;for(let e=0,s=a.length;e<s;e+=4)n.push((new t.Vector4).fromArray(a,e));let o,l;if("Closed"===e.Form)n.push(n[0]);else if("Periodic"===e.Form){o=r,l=i.length-1-o;for(let e=0;e<r;++e)n.push(n[e])}const h=new Ks(r,i,n,o,l).getPoints(12*n.length);return(new t.BufferGeometry).setFromPoints(h)}}class tr{parse(){const e=[],t=this.parseClips();if(void 0!==t)for(const s in t){const r=t[s],i=this.addClip(r);e.push(i)}return e}parseClips(){if(void 0===Qs.Objects.AnimationCurve)return;const e=this.parseAnimationCurveNodes();this.parseAnimationCurves(e);const t=this.parseAnimationLayers(e);return this.parseAnimStacks(t)}parseAnimationCurveNodes(){const e=Qs.Objects.AnimationCurveNode,t=new Map;for(const s in e){const r=e[s];if(null!==r.attrName.match(/S|R|T|DeformPercent/)){const e={id:r.id,attr:r.attrName,curves:{}};t.set(e.id,e)}}return t}parseAnimationCurves(e){const t=Qs.Objects.AnimationCurve;for(const s in t){const r={id:t[s].id,times:t[s].KeyTime.a.map(or),values:t[s].KeyValueFloat.a},i=Zs.get(r.id);if(void 0!==i){const t=i.parents[0].ID,s=i.parents[0].relationship;s.match(/X/)?e.get(t).curves.x=r:s.match(/Y/)?e.get(t).curves.y=r:s.match(/Z/)?e.get(t).curves.z=r:s.match(/DeformPercent/)&&e.has(t)&&(e.get(t).curves.morph=r)}}}parseAnimationLayers(e){const s=Qs.Objects.AnimationLayer,r=new Map;for(const i in s){const s=[],n=Zs.get(parseInt(i));if(void 0!==n){n.children.forEach((function(r,i){if(e.has(r.ID)){const n=e.get(r.ID);if(void 0!==n.curves.x||void 0!==n.curves.y||void 0!==n.curves.z){if(void 0===s[i]){const e=Zs.get(r.ID).parents.filter((function(e){return void 0!==e.relationship}))[0].ID;if(void 0!==e){const n=Qs.Objects.Model[e.toString()];if(void 0===n)return void console.warn("THREE.FBXLoader: Encountered a unused curve.",r);const a={modelName:n.attrName?t.PropertyBinding.sanitizeNodeName(n.attrName):"",ID:n.id,initialPosition:[0,0,0],initialRotation:[0,0,0],initialScale:[1,1,1]};Ys.traverse((function(e){e.ID===n.id&&(a.transform=e.matrix,e.userData.transformData&&(a.eulerOrder=e.userData.transformData.eulerOrder))})),a.transform||(a.transform=new t.Matrix4),"PreRotation"in n&&(a.preRotation=n.PreRotation.value),"PostRotation"in n&&(a.postRotation=n.PostRotation.value),s[i]=a}}s[i]&&(s[i][n.attr]=n)}else if(void 0!==n.curves.morph){if(void 0===s[i]){const e=Zs.get(r.ID).parents.filter((function(e){return void 0!==e.relationship}))[0].ID,n=Zs.get(e).parents[0].ID,a=Zs.get(n).parents[0].ID,o=Zs.get(a).parents[0].ID,l=Qs.Objects.Model[o],h={modelName:l.attrName?t.PropertyBinding.sanitizeNodeName(l.attrName):"",morphName:Qs.Objects.Deformer[e].attrName};s[i]=h}s[i][n.attr]=n}}})),r.set(parseInt(i),s)}}return r}parseAnimStacks(e){const t=Qs.Objects.AnimationStack,s={};for(const r in t){const i=Zs.get(parseInt(r)).children;i.length>1&&console.warn("THREE.FBXLoader: Encountered an animation stack with multiple layers, this is currently not supported. Ignoring subsequent layers.");const n=e.get(i[0].ID);s[r]={name:t[r].attrName,layer:n}}return s}addClip(e){let s=[];const r=this;return e.layer.forEach((function(e){s=s.concat(r.generateTracks(e))})),new t.AnimationClip(e.name,-1,s)}generateTracks(e){const s=[];let r=new t.Vector3,i=new t.Quaternion,n=new t.Vector3;if(e.transform&&e.transform.decompose(r,i,n),r=r.toArray(),i=(new t.Euler).setFromQuaternion(i,e.eulerOrder).toArray(),n=n.toArray(),void 0!==e.T&&Object.keys(e.T.curves).length>0){const t=this.generateVectorTrack(e.modelName,e.T.curves,r,"position");void 0!==t&&s.push(t)}if(void 0!==e.R&&Object.keys(e.R.curves).length>0){const t=this.generateRotationTrack(e.modelName,e.R.curves,i,e.preRotation,e.postRotation,e.eulerOrder);void 0!==t&&s.push(t)}if(void 0!==e.S&&Object.keys(e.S.curves).length>0){const t=this.generateVectorTrack(e.modelName,e.S.curves,n,"scale");void 0!==t&&s.push(t)}if(void 0!==e.DeformPercent){const t=this.generateMorphTrack(e);void 0!==t&&s.push(t)}return s}generateVectorTrack(e,s,r,i){const n=this.getTimesForAllAxes(s),a=this.getKeyframeTrackValues(n,s,r);return new t.VectorKeyframeTrack(e+"."+i,n,a)}generateRotationTrack(e,s,r,i,n,a){void 0!==s.x&&(this.interpolateRotations(s.x),s.x.values=s.x.values.map(t.MathUtils.degToRad)),void 0!==s.y&&(this.interpolateRotations(s.y),s.y.values=s.y.values.map(t.MathUtils.degToRad)),void 0!==s.z&&(this.interpolateRotations(s.z),s.z.values=s.z.values.map(t.MathUtils.degToRad));const o=this.getTimesForAllAxes(s),l=this.getKeyframeTrackValues(o,s,r);void 0!==i&&((i=i.map(t.MathUtils.degToRad)).push(a),i=(new t.Euler).fromArray(i),i=(new t.Quaternion).setFromEuler(i)),void 0!==n&&((n=n.map(t.MathUtils.degToRad)).push(a),n=(new t.Euler).fromArray(n),n=(new t.Quaternion).setFromEuler(n).invert());const h=new t.Quaternion,c=new t.Euler,u=[];for(let e=0;e<l.length;e+=3)c.set(l[e],l[e+1],l[e+2],a),h.setFromEuler(c),void 0!==i&&h.premultiply(i),void 0!==n&&h.multiply(n),h.toArray(u,e/3*4);return new t.QuaternionKeyframeTrack(e+".quaternion",o,u)}generateMorphTrack(e){const s=e.DeformPercent.curves.morph,r=s.values.map((function(e){return e/100})),i=Ys.getObjectByName(e.modelName).morphTargetDictionary[e.morphName];return new t.NumberKeyframeTrack(e.modelName+".morphTargetInfluences["+i+"]",s.times,r)}getTimesForAllAxes(e){let t=[];if(void 0!==e.x&&(t=t.concat(e.x.times)),void 0!==e.y&&(t=t.concat(e.y.times)),void 0!==e.z&&(t=t.concat(e.z.times)),t=t.sort((function(e,t){return e-t})),t.length>1){let e=1,s=t[0];for(let r=1;r<t.length;r++){const i=t[r];i!==s&&(t[e]=i,s=i,e++)}t=t.slice(0,e)}return t}getKeyframeTrackValues(e,t,s){const r=s,i=[];let n=-1,a=-1,o=-1;return e.forEach((function(e){if(t.x&&(n=t.x.times.indexOf(e)),t.y&&(a=t.y.times.indexOf(e)),t.z&&(o=t.z.times.indexOf(e)),-1!==n){const e=t.x.values[n];i.push(e),r[0]=e}else i.push(r[0]);if(-1!==a){const e=t.y.values[a];i.push(e),r[1]=e}else i.push(r[1]);if(-1!==o){const e=t.z.values[o];i.push(e),r[2]=e}else i.push(r[2])})),i}interpolateRotations(e){for(let t=1;t<e.values.length;t++){const s=e.values[t-1],r=e.values[t]-s,i=Math.abs(r);if(i>=180){const n=i/180,a=r/n;let o=s+a;const l=e.times[t-1],h=(e.times[t]-l)/n;let c=l+h;const u=[],p=[];for(;c<e.times[t];)u.push(c),c+=h,p.push(o),o+=a;e.times=gr(e.times,t,u),e.values=gr(e.values,t,p)}}}}class sr{getPrevNode(){return this.nodeStack[this.currentIndent-2]}getCurrentNode(){return this.nodeStack[this.currentIndent-1]}getCurrentProp(){return this.currentProp}pushStack(e){this.nodeStack.push(e),this.currentIndent+=1}popStack(){this.nodeStack.pop(),this.currentIndent-=1}setCurrentProp(e,t){this.currentProp=e,this.currentPropName=t}parse(e){this.currentIndent=0,this.allNodes=new nr,this.nodeStack=[],this.currentProp=[],this.currentPropName="";const t=this,s=e.split(/[\r\n]+/);return s.forEach((function(e,r){const i=e.match(/^[\s\t]*;/),n=e.match(/^[\s\t]*$/);if(i||n)return;const a=e.match("^\\t{"+t.currentIndent+"}(\\w+):(.*){",""),o=e.match("^\\t{"+t.currentIndent+"}(\\w+):[\\s\\t\\r\\n](.*)"),l=e.match("^\\t{"+(t.currentIndent-1)+"}}");a?t.parseNodeBegin(e,a):o?t.parseNodeProperty(e,o,s[++r]):l?t.popStack():e.match(/^[^\s\t}]/)&&t.parseNodePropertyContinued(e)})),this.allNodes}parseNodeBegin(e,t){const s=t[1].trim().replace(/^"/,"").replace(/"$/,""),r=t[2].split(",").map((function(e){return e.trim().replace(/^"/,"").replace(/"$/,"")})),i={name:s},n=this.parseNodeAttr(r),a=this.getCurrentNode();0===this.currentIndent?this.allNodes.add(s,i):s in a?("PoseNode"===s?a.PoseNode.push(i):void 0!==a[s].id&&(a[s]={},a[s][a[s].id]=a[s]),""!==n.id&&(a[s][n.id]=i)):"number"==typeof n.id?(a[s]={},a[s][n.id]=i):"Properties70"!==s&&(a[s]="PoseNode"===s?[i]:i),"number"==typeof n.id&&(i.id=n.id),""!==n.name&&(i.attrName=n.name),""!==n.type&&(i.attrType=n.type),this.pushStack(i)}parseNodeAttr(e){let t=e[0];""!==e[0]&&(t=parseInt(e[0]),isNaN(t)&&(t=e[0]));let s="",r="";return e.length>1&&(s=e[1].replace(/^(\w+)::/,""),r=e[2]),{id:t,name:s,type:r}}parseNodeProperty(e,t,s){let r=t[1].replace(/^"/,"").replace(/"$/,"").trim(),i=t[2].replace(/^"/,"").replace(/"$/,"").trim();"Content"===r&&","===i&&(i=s.replace(/"/g,"").replace(/,$/,"").trim());const n=this.getCurrentNode();if("Properties70"!==n.name){if("C"===r){const e=i.split(",").slice(1),t=parseInt(e[0]),s=parseInt(e[1]);let a=i.split(",").slice(3);a=a.map((function(e){return e.trim().replace(/^"/,"")})),r="connections",i=[t,s],function(e,t){for(let s=0,r=e.length,i=t.length;s<i;s++,r++)e[r]=t[s]}(i,a),void 0===n[r]&&(n[r]=[])}"Node"===r&&(n.id=i),r in n&&Array.isArray(n[r])?n[r].push(i):"a"!==r?n[r]=i:n.a=i,this.setCurrentProp(n,r),"a"===r&&","!==i.slice(-1)&&(n.a=mr(i))}else this.parseNodeSpecialProperty(e,r,i)}parseNodePropertyContinued(e){const t=this.getCurrentNode();t.a+=e,","!==e.slice(-1)&&(t.a=mr(t.a))}parseNodeSpecialProperty(e,t,s){const r=s.split('",').map((function(e){return e.trim().replace(/^\"/,"").replace(/\s/,"_")})),i=r[0],n=r[1],a=r[2],o=r[3];let l=r[4];switch(n){case"int":case"enum":case"bool":case"ULongLong":case"double":case"Number":case"FieldOfView":l=parseFloat(l);break;case"Color":case"ColorRGB":case"Vector3D":case"Lcl_Translation":case"Lcl_Rotation":case"Lcl_Scaling":l=mr(l)}this.getPrevNode()[i]={type:n,type2:a,flag:o,value:l},this.setCurrentProp(this.getPrevNode(),i)}}class rr{parse(e){const t=new ir(e);t.skip(23);const s=t.getUint32();if(s<6400)throw new Error("THREE.FBXLoader: FBX version not supported, FileVersion: "+s);const r=new nr;for(;!this.endOfContent(t);){const e=this.parseNode(t,s);null!==e&&r.add(e.name,e)}return r}endOfContent(e){return e.size()%16==0?(e.getOffset()+160+16&-16)>=e.size():e.getOffset()+160+16>=e.size()}parseNode(e,t){const s={},r=t>=7500?e.getUint64():e.getUint32(),i=t>=7500?e.getUint64():e.getUint32();t>=7500?e.getUint64():e.getUint32();const n=e.getUint8(),a=e.getString(n);if(0===r)return null;const o=[];for(let t=0;t<i;t++)o.push(this.parseProperty(e));const l=o.length>0?o[0]:"",h=o.length>1?o[1]:"",c=o.length>2?o[2]:"";for(s.singleProperty=1===i&&e.getOffset()===r;r>e.getOffset();){const r=this.parseNode(e,t);null!==r&&this.parseSubNode(a,s,r)}return s.propertyList=o,"number"==typeof l&&(s.id=l),""!==h&&(s.attrName=h),""!==c&&(s.attrType=c),""!==a&&(s.name=a),s}parseSubNode(e,t,s){if(!0===s.singleProperty){const e=s.propertyList[0];Array.isArray(e)?(t[s.name]=s,s.a=e):t[s.name]=e}else if("Connections"===e&&"C"===s.name){const e=[];s.propertyList.forEach((function(t,s){0!==s&&e.push(t)})),void 0===t.connections&&(t.connections=[]),t.connections.push(e)}else if("Properties70"===s.name){Object.keys(s).forEach((function(e){t[e]=s[e]}))}else if("Properties70"===e&&"P"===s.name){let e=s.propertyList[0],r=s.propertyList[1];const i=s.propertyList[2],n=s.propertyList[3];let a;0===e.indexOf("Lcl ")&&(e=e.replace("Lcl ","Lcl_")),0===r.indexOf("Lcl ")&&(r=r.replace("Lcl ","Lcl_")),a="Color"===r||"ColorRGB"===r||"Vector"===r||"Vector3D"===r||0===r.indexOf("Lcl_")?[s.propertyList[4],s.propertyList[5],s.propertyList[6]]:s.propertyList[4],t[e]={type:r,type2:i,flag:n,value:a}}else void 0===t[s.name]?"number"==typeof s.id?(t[s.name]={},t[s.name][s.id]=s):t[s.name]=s:"PoseNode"===s.name?(Array.isArray(t[s.name])||(t[s.name]=[t[s.name]]),t[s.name].push(s)):void 0===t[s.name][s.id]&&(t[s.name][s.id]=s)}parseProperty(e){const t=e.getString(1);let s;switch(t){case"C":return e.getBoolean();case"D":return e.getFloat64();case"F":return e.getFloat32();case"I":return e.getInt32();case"L":return e.getInt64();case"R":return s=e.getUint32(),e.getArrayBuffer(s);case"S":return s=e.getUint32(),e.getString(s);case"Y":return e.getInt16();case"b":case"c":case"d":case"f":case"i":case"l":const r=e.getUint32(),i=e.getUint32(),n=e.getUint32();if(0===i)switch(t){case"b":case"c":return e.getBooleanArray(r);case"d":return e.getFloat64Array(r);case"f":return e.getFloat32Array(r);case"i":return e.getInt32Array(r);case"l":return e.getInt64Array(r)}const a=Gs(new Uint8Array(e.getArrayBuffer(n))),o=new ir(a.buffer);switch(t){case"b":case"c":return o.getBooleanArray(r);case"d":return o.getFloat64Array(r);case"f":return o.getFloat32Array(r);case"i":return o.getInt32Array(r);case"l":return o.getInt64Array(r)}break;default:throw new Error("THREE.FBXLoader: Unknown property type "+t)}}}class ir{constructor(e,t){this.dv=new DataView(e),this.offset=0,this.littleEndian=void 0===t||t,this._textDecoder=new TextDecoder}getOffset(){return this.offset}size(){return this.dv.buffer.byteLength}skip(e){this.offset+=e}getBoolean(){return 1==(1&this.getUint8())}getBooleanArray(e){const t=[];for(let s=0;s<e;s++)t.push(this.getBoolean());return t}getUint8(){const e=this.dv.getUint8(this.offset);return this.offset+=1,e}getInt16(){const e=this.dv.getInt16(this.offset,this.littleEndian);return this.offset+=2,e}getInt32(){const e=this.dv.getInt32(this.offset,this.littleEndian);return this.offset+=4,e}getInt32Array(e){const t=[];for(let s=0;s<e;s++)t.push(this.getInt32());return t}getUint32(){const e=this.dv.getUint32(this.offset,this.littleEndian);return this.offset+=4,e}getInt64(){let e,t;return this.littleEndian?(e=this.getUint32(),t=this.getUint32()):(t=this.getUint32(),e=this.getUint32()),2147483648&t?(t=4294967295&~t,e=4294967295&~e,4294967295===e&&(t=t+1&4294967295),e=e+1&4294967295,-(4294967296*t+e)):4294967296*t+e}getInt64Array(e){const t=[];for(let s=0;s<e;s++)t.push(this.getInt64());return t}getUint64(){let e,t;return this.littleEndian?(e=this.getUint32(),t=this.getUint32()):(t=this.getUint32(),e=this.getUint32()),4294967296*t+e}getFloat32(){const e=this.dv.getFloat32(this.offset,this.littleEndian);return this.offset+=4,e}getFloat32Array(e){const t=[];for(let s=0;s<e;s++)t.push(this.getFloat32());return t}getFloat64(){const e=this.dv.getFloat64(this.offset,this.littleEndian);return this.offset+=8,e}getFloat64Array(e){const t=[];for(let s=0;s<e;s++)t.push(this.getFloat64());return t}getArrayBuffer(e){const t=this.dv.buffer.slice(this.offset,this.offset+e);return this.offset+=e,t}getString(e){const t=this.offset;let s=new Uint8Array(this.dv.buffer,t,e);this.skip(e);const r=s.indexOf(0);return r>=0&&(s=new Uint8Array(this.dv.buffer,t,r)),this._textDecoder.decode(s)}}class nr{add(e,t){this[e]=t}}function ar(e){const t=e.match(/FBXVersion: (\d+)/);if(t){return parseInt(t[1])}throw new Error("THREE.FBXLoader: Cannot find the version number for the file given.")}function or(e){return e/46186158e3}const lr=[];function hr(e,t,s,r){let i;switch(r.mappingType){case"ByPolygonVertex":i=e;break;case"ByPolygon":i=t;break;case"ByVertice":i=s;break;case"AllSame":i=r.indices[0];break;default:console.warn("THREE.FBXLoader: unknown attribute mapping type "+r.mappingType)}"IndexToDirect"===r.referenceType&&(i=r.indices[i]);const n=i*r.dataSize,a=n+r.dataSize;return function(e,t,s,r){for(let i=s,n=0;i<r;i++,n++)e[n]=t[i];return e}(lr,r.buffer,n,a)}const cr=new t.Euler,ur=new t.Vector3;function pr(e){const s=new t.Matrix4,r=new t.Matrix4,i=new t.Matrix4,n=new t.Matrix4,a=new t.Matrix4,o=new t.Matrix4,l=new t.Matrix4,h=new t.Matrix4,c=new t.Matrix4,u=new t.Matrix4,p=new t.Matrix4,d=new t.Matrix4,m=e.inheritType?e.inheritType:0;if(e.translation&&s.setPosition(ur.fromArray(e.translation)),e.preRotation){const s=e.preRotation.map(t.MathUtils.degToRad);s.push(e.eulerOrder||t.Euler.DEFAULT_ORDER),r.makeRotationFromEuler(cr.fromArray(s))}if(e.rotation){const s=e.rotation.map(t.MathUtils.degToRad);s.push(e.eulerOrder||t.Euler.DEFAULT_ORDER),i.makeRotationFromEuler(cr.fromArray(s))}if(e.postRotation){const s=e.postRotation.map(t.MathUtils.degToRad);s.push(e.eulerOrder||t.Euler.DEFAULT_ORDER),n.makeRotationFromEuler(cr.fromArray(s)),n.invert()}e.scale&&a.scale(ur.fromArray(e.scale)),e.scalingOffset&&l.setPosition(ur.fromArray(e.scalingOffset)),e.scalingPivot&&o.setPosition(ur.fromArray(e.scalingPivot)),e.rotationOffset&&h.setPosition(ur.fromArray(e.rotationOffset)),e.rotationPivot&&c.setPosition(ur.fromArray(e.rotationPivot)),e.parentMatrixWorld&&(p.copy(e.parentMatrix),u.copy(e.parentMatrixWorld));const f=r.clone().multiply(i).multiply(n),g=new t.Matrix4;g.extractRotation(u);const y=new t.Matrix4;y.copyPosition(u);const b=y.clone().invert().multiply(u),x=g.clone().invert().multiply(b),v=a,w=new t.Matrix4;if(0===m)w.copy(g).multiply(f).multiply(x).multiply(v);else if(1===m)w.copy(g).multiply(x).multiply(f).multiply(v);else{const e=(new t.Matrix4).scale((new t.Vector3).setFromMatrixScale(p)).clone().invert(),s=x.clone().multiply(e);w.copy(g).multiply(f).multiply(s).multiply(v)}const M=c.clone().invert(),A=o.clone().invert();let T=s.clone().multiply(h).multiply(c).multiply(r).multiply(i).multiply(n).multiply(M).multiply(l).multiply(o).multiply(a).multiply(A);const S=(new t.Matrix4).copyPosition(T),k=u.clone().multiply(S);return d.copyPosition(k),T=d.clone().multiply(w),T.premultiply(u.invert()),T}function dr(e){const t=["ZYX","YZX","XZY","ZXY","YXZ","XYZ"];return 6===(e=e||0)?(console.warn("THREE.FBXLoader: unsupported Euler Order: Spherical XYZ. Animations and rotations may be incorrect."),t[0]):t[e]}function mr(e){return e.split(",").map((function(e){return parseFloat(e)}))}function fr(e,t,s){return void 0===t&&(t=0),void 0===s&&(s=e.byteLength),(new TextDecoder).decode(new Uint8Array(e,t,s))}function gr(e,t,s){return e.slice(0,t).concat(s).concat(e.slice(t))}class yr extends t.DataTextureLoader{constructor(e){super(e),this.type=t.HalfFloatType}parse(e){const s=function(e,t){switch(e){case 1:console.error("THREE.RGBELoader Read Error: "+(t||""));break;case 2:console.error("THREE.RGBELoader Write Error: "+(t||""));break;case 3:console.error("THREE.RGBELoader Bad File Format: "+(t||""));break;default:case 4:console.error("THREE.RGBELoader: Error: "+(t||""))}return-1},r=function(e,t,s){t=t||1024;let r=e.pos,i=-1,n=0,a="",o=String.fromCharCode.apply(null,new Uint16Array(e.subarray(r,r+128)));for(;0>(i=o.indexOf("\n"))&&n<t&&r<e.byteLength;)a+=o,n+=o.length,r+=128,o+=String.fromCharCode.apply(null,new Uint16Array(e.subarray(r,r+128)));return-1<i&&(!1!==s&&(e.pos+=n+i+1),a+o.slice(0,i))},i=function(e,t,s,r){const i=e[t+3],n=Math.pow(2,i-128)/255;s[r+0]=e[t+0]*n,s[r+1]=e[t+1]*n,s[r+2]=e[t+2]*n,s[r+3]=1},n=function(e,s,r,i){const n=e[s+3],a=Math.pow(2,n-128)/255;r[i+0]=t.DataUtils.toHalfFloat(Math.min(e[s+0]*a,65504)),r[i+1]=t.DataUtils.toHalfFloat(Math.min(e[s+1]*a,65504)),r[i+2]=t.DataUtils.toHalfFloat(Math.min(e[s+2]*a,65504)),r[i+3]=t.DataUtils.toHalfFloat(1)},a=new Uint8Array(e);a.pos=0;const o=function(e){const t=/^\s*GAMMA\s*=\s*(\d+(\.\d+)?)\s*$/,i=/^\s*EXPOSURE\s*=\s*(\d+(\.\d+)?)\s*$/,n=/^\s*FORMAT=(\S+)\s*$/,a=/^\s*\-Y\s+(\d+)\s+\+X\s+(\d+)\s*$/,o={valid:0,string:"",comments:"",programtype:"RGBE",format:"",gamma:1,exposure:1,width:0,height:0};let l,h;if(e.pos>=e.byteLength||!(l=r(e)))return s(1,"no header found");if(!(h=l.match(/^#\?(\S+)/)))return s(3,"bad initial token");for(o.valid|=1,o.programtype=h[1],o.string+=l+"\n";l=r(e),!1!==l;)if(o.string+=l+"\n","#"!==l.charAt(0)){if((h=l.match(t))&&(o.gamma=parseFloat(h[1])),(h=l.match(i))&&(o.exposure=parseFloat(h[1])),(h=l.match(n))&&(o.valid|=2,o.format=h[1]),(h=l.match(a))&&(o.valid|=4,o.height=parseInt(h[1],10),o.width=parseInt(h[2],10)),2&o.valid&&4&o.valid)break}else o.comments+=l+"\n";return 2&o.valid?4&o.valid?o:s(3,"missing image size specifier"):s(3,"missing format specifier")}(a);if(-1!==o){const e=o.width,r=o.height,l=function(e,t,r){const i=t;if(i<8||i>32767||2!==e[0]||2!==e[1]||128&e[2])return new Uint8Array(e);if(i!==(e[2]<<8|e[3]))return s(3,"wrong scanline width");const n=new Uint8Array(4*t*r);if(!n.length)return s(4,"unable to allocate buffer space");let a=0,o=0;const l=4*i,h=new Uint8Array(4),c=new Uint8Array(l);let u=r;for(;u>0&&o<e.byteLength;){if(o+4>e.byteLength)return s(1);if(h[0]=e[o++],h[1]=e[o++],h[2]=e[o++],h[3]=e[o++],2!=h[0]||2!=h[1]||(h[2]<<8|h[3])!=i)return s(3,"bad rgbe scanline format");let t,r=0;for(;r<l&&o<e.byteLength;){t=e[o++];const i=t>128;if(i&&(t-=128),0===t||r+t>l)return s(3,"bad scanline data");if(i){const s=e[o++];for(let e=0;e<t;e++)c[r++]=s}else c.set(e.subarray(o,o+t),r),r+=t,o+=t}const p=i;for(let e=0;e<p;e++){let t=0;n[a]=c[e+t],t+=i,n[a+1]=c[e+t],t+=i,n[a+2]=c[e+t],t+=i,n[a+3]=c[e+t],a+=4}u--}return n}(a.subarray(a.pos),e,r);if(-1!==l){let s,a,h;switch(this.type){case t.FloatType:h=l.length/4;const e=new Float32Array(4*h);for(let t=0;t<h;t++)i(l,4*t,e,4*t);s=e,a=t.FloatType;break;case t.HalfFloatType:h=l.length/4;const r=new Uint16Array(4*h);for(let e=0;e<h;e++)n(l,4*e,r,4*e);s=r,a=t.HalfFloatType;break;default:console.error("THREE.RGBELoader: unsupported type: ",this.type)}return{width:e,height:r,data:s,header:o.string,gamma:o.gamma,exposure:o.exposure,type:a}}}return null}setDataType(e){return this.type=e,this}load(e,s,r,i){return super.load(e,(function(e,r){switch(e.type){case t.FloatType:case t.HalfFloatType:e.colorSpace=t.LinearSRGBColorSpace,e.minFilter=t.LinearFilter,e.magFilter=t.LinearFilter,e.generateMipmaps=!1,e.flipY=!0}s&&s(e,r)}),r,i)}}class br extends t.DataTextureLoader{constructor(e){super(e),this.type=t.HalfFloatType}parse(e){const s=65536,r=14,i=65537,n=16384,a=Math.pow(2.7182818,2.2);const o={l:0,c:0,lc:0};function l(e,t,s,r,i){for(;s<e;)t=t<<8|j(r,i),s+=8;s-=e,o.l=t>>s&(1<<e)-1,o.c=t,o.lc=s}const h=new Array(59);function c(e,t,s,r,n,a){const c=t;let u=0,p=0;for(;r<=n;r++){if(c.value-t.value>s)return!1;l(6,u,p,e,c);const i=o.l;if(u=o.c,p=o.lc,a[r]=i,63==i){if(c.value-t.value>s)throw new Error("Something wrong with hufUnpackEncTable");l(8,u,p,e,c);let i=o.l+6;if(u=o.c,p=o.lc,r+i>n+1)throw new Error("Something wrong with hufUnpackEncTable");for(;i--;)a[r++]=0;r--}else if(i>=59){let e=i-59+2;if(r+e>n+1)throw new Error("Something wrong with hufUnpackEncTable");for(;e--;)a[r++]=0;r--}}!function(e){for(let e=0;e<=58;++e)h[e]=0;for(let t=0;t<i;++t)h[e[t]]+=1;let t=0;for(let e=58;e>0;--e){const s=t+h[e]>>1;h[e]=t,t=s}for(let t=0;t<i;++t){const s=e[t];s>0&&(e[t]=s|h[s]++<<6)}}(a)}function u(e){return 63&e}function p(e){return e>>6}const d={c:0,lc:0};function m(e,t,s,r){e=e<<8|j(s,r),t+=8,d.c=e,d.lc=t}const f={c:0,lc:0};function g(e,t,s,r,i,n,a,o,l){if(e==t){r<8&&(m(s,r,i,n),s=d.c,r=d.lc);let e=s>>(r-=8);if(e=new Uint8Array([e])[0],o.value+e>l)return!1;const t=a[o.value-1];for(;e-- >0;)a[o.value++]=t}else{if(!(o.value<l))return!1;a[o.value++]=e}f.c=s,f.lc=r}function y(e){return 65535&e}function b(e){const t=y(e);return t>32767?t-65536:t}const x={a:0,b:0};function v(e,t){const s=b(e),r=b(t),i=s+(1&r)+(r>>1),n=i,a=i-r;x.a=n,x.b=a}function w(e,t){const s=y(e),r=y(t),i=s-(r>>1)&65535,n=r+i-32768&65535;x.a=n,x.b=i}function M(e,t,s,r,i,n,a){const o=a<16384,l=s>i?i:s;let h,c,u=1;for(;u<=l;)u<<=1;for(u>>=1,h=u,u>>=1;u>=1;){c=0;const a=c+n*(i-h),l=n*u,p=n*h,d=r*u,m=r*h;let f,g,y,b;for(;c<=a;c+=p){let i=c;const n=c+r*(s-h);for(;i<=n;i+=m){const s=i+d,r=i+l,n=r+d;o?(v(e[i+t],e[r+t]),f=x.a,y=x.b,v(e[s+t],e[n+t]),g=x.a,b=x.b,v(f,g),e[i+t]=x.a,e[s+t]=x.b,v(y,b),e[r+t]=x.a,e[n+t]=x.b):(w(e[i+t],e[r+t]),f=x.a,y=x.b,w(e[s+t],e[n+t]),g=x.a,b=x.b,w(f,g),e[i+t]=x.a,e[s+t]=x.b,w(y,b),e[r+t]=x.a,e[n+t]=x.b)}if(s&u){const s=i+l;o?v(e[i+t],e[s+t]):w(e[i+t],e[s+t]),f=x.a,e[s+t]=x.b,e[i+t]=f}}if(i&u){let i=c;const n=c+r*(s-h);for(;i<=n;i+=m){const s=i+d;o?v(e[i+t],e[s+t]):w(e[i+t],e[s+t]),f=x.a,e[s+t]=x.b,e[i+t]=f}}h=u,u>>=1}return c}function A(e,t,s,a,o,l){const h=s.value,y=V(t,s),b=V(t,s);s.value+=4;const x=V(t,s);if(s.value+=4,y<0||y>=i||b<0||b>=i)throw new Error("Something wrong with HUF_ENCSIZE");const v=new Array(i),w=new Array(n);!function(e){for(let t=0;t<n;t++)e[t]={},e[t].len=0,e[t].lit=0,e[t].p=null}(w);if(c(e,s,a-(s.value-h),y,b,v),x>8*(a-(s.value-h)))throw new Error("Something wrong with hufUncompress");!function(e,t,s,i){for(;t<=s;t++){const s=p(e[t]),n=u(e[t]);if(s>>n)throw new Error("Invalid table entry");if(n>r){const e=i[s>>n-r];if(e.len)throw new Error("Invalid table entry");if(e.lit++,e.p){const t=e.p;e.p=new Array(e.lit);for(let s=0;s<e.lit-1;++s)e.p[s]=t[s]}else e.p=new Array(1);e.p[e.lit-1]=t}else if(n){let e=0;for(let a=1<<r-n;a>0;a--){const a=i[(s<<r-n)+e];if(a.len||a.p)throw new Error("Invalid table entry");a.len=n,a.lit=t,e++}}}}(v,y,b,w),function(e,t,s,i,n,a,o,l,h){let c=0,y=0;const b=o,x=Math.trunc(i.value+(n+7)/8);for(;i.value<x;)for(m(c,y,s,i),c=d.c,y=d.lc;y>=r;){const n=t[c>>y-r&16383];if(n.len)y-=n.len,g(n.lit,a,c,y,s,i,l,h,b),c=f.c,y=f.lc;else{if(!n.p)throw new Error("hufDecode issues");let t;for(t=0;t<n.lit;t++){const r=u(e[n.p[t]]);for(;y<r&&i.value<x;)m(c,y,s,i),c=d.c,y=d.lc;if(y>=r&&p(e[n.p[t]])==(c>>y-r&(1<<r)-1)){y-=r,g(n.p[t],a,c,y,s,i,l,h,b),c=f.c,y=f.lc;break}}if(t==n.lit)throw new Error("hufDecode issues")}}const v=8-n&7;for(c>>=v,y-=v;y>0;){const e=t[c<<r-y&16383];if(!e.len)throw new Error("hufDecode issues");y-=e.len,g(e.lit,a,c,y,s,i,l,h,b),c=f.c,y=f.lc}}(v,w,e,s,x,b,l,o,{value:0})}function T(e){for(let t=1;t<e.length;t++){const s=e[t-1]+e[t]-128;e[t]=s}}function S(e,t){let s=0,r=Math.floor((e.length+1)/2),i=0;const n=e.length-1;for(;!(i>n||(t[i++]=e[s++],i>n));)t[i++]=e[r++]}function k(e){let t=e.byteLength;const s=new Array;let r=0;const i=new DataView(e);for(;t>0;){const e=i.getInt8(r++);if(e<0){const n=-e;t-=n+1;for(let e=0;e<n;e++)s.push(i.getUint8(r++))}else{const n=e;t-=2;const a=i.getUint8(r++);for(let e=0;e<n+1;e++)s.push(a)}}return s}function R(e,t,s){let r,i=1;for(;i<64;)r=t[e.value],65280==r?i=64:r>>8==255?i+=255&r:(s[i]=r,i++),e.value++}function E(e,t){t[0]=X(e[0]),t[1]=X(e[1]),t[2]=X(e[5]),t[3]=X(e[6]),t[4]=X(e[14]),t[5]=X(e[15]),t[6]=X(e[27]),t[7]=X(e[28]),t[8]=X(e[2]),t[9]=X(e[4]),t[10]=X(e[7]),t[11]=X(e[13]),t[12]=X(e[16]),t[13]=X(e[26]),t[14]=X(e[29]),t[15]=X(e[42]),t[16]=X(e[3]),t[17]=X(e[8]),t[18]=X(e[12]),t[19]=X(e[17]),t[20]=X(e[25]),t[21]=X(e[30]),t[22]=X(e[41]),t[23]=X(e[43]),t[24]=X(e[9]),t[25]=X(e[11]),t[26]=X(e[18]),t[27]=X(e[24]),t[28]=X(e[31]),t[29]=X(e[40]),t[30]=X(e[44]),t[31]=X(e[53]),t[32]=X(e[10]),t[33]=X(e[19]),t[34]=X(e[23]),t[35]=X(e[32]),t[36]=X(e[39]),t[37]=X(e[45]),t[38]=X(e[52]),t[39]=X(e[54]),t[40]=X(e[20]),t[41]=X(e[22]),t[42]=X(e[33]),t[43]=X(e[38]),t[44]=X(e[46]),t[45]=X(e[51]),t[46]=X(e[55]),t[47]=X(e[60]),t[48]=X(e[21]),t[49]=X(e[34]),t[50]=X(e[37]),t[51]=X(e[47]),t[52]=X(e[50]),t[53]=X(e[56]),t[54]=X(e[59]),t[55]=X(e[61]),t[56]=X(e[35]),t[57]=X(e[36]),t[58]=X(e[48]),t[59]=X(e[49]),t[60]=X(e[57]),t[61]=X(e[58]),t[62]=X(e[62]),t[63]=X(e[63])}function P(e){const t=.5*Math.cos(.7853975),s=.5*Math.cos(3.14159/16),r=.5*Math.cos(3.14159/8),i=.5*Math.cos(3*3.14159/16),n=.5*Math.cos(.981746875),a=.5*Math.cos(3*3.14159/8),o=.5*Math.cos(1.374445625),l=new Array(4),h=new Array(4),c=new Array(4),u=new Array(4);for(let p=0;p<8;++p){const d=8*p;l[0]=r*e[d+2],l[1]=a*e[d+2],l[2]=r*e[d+6],l[3]=a*e[d+6],h[0]=s*e[d+1]+i*e[d+3]+n*e[d+5]+o*e[d+7],h[1]=i*e[d+1]-o*e[d+3]-s*e[d+5]-n*e[d+7],h[2]=n*e[d+1]-s*e[d+3]+o*e[d+5]+i*e[d+7],h[3]=o*e[d+1]-n*e[d+3]+i*e[d+5]-s*e[d+7],c[0]=t*(e[d+0]+e[d+4]),c[3]=t*(e[d+0]-e[d+4]),c[1]=l[0]+l[3],c[2]=l[1]-l[2],u[0]=c[0]+c[1],u[1]=c[3]+c[2],u[2]=c[3]-c[2],u[3]=c[0]-c[1],e[d+0]=u[0]+h[0],e[d+1]=u[1]+h[1],e[d+2]=u[2]+h[2],e[d+3]=u[3]+h[3],e[d+4]=u[3]-h[3],e[d+5]=u[2]-h[2],e[d+6]=u[1]-h[1],e[d+7]=u[0]-h[0]}for(let p=0;p<8;++p)l[0]=r*e[16+p],l[1]=a*e[16+p],l[2]=r*e[48+p],l[3]=a*e[48+p],h[0]=s*e[8+p]+i*e[24+p]+n*e[40+p]+o*e[56+p],h[1]=i*e[8+p]-o*e[24+p]-s*e[40+p]-n*e[56+p],h[2]=n*e[8+p]-s*e[24+p]+o*e[40+p]+i*e[56+p],h[3]=o*e[8+p]-n*e[24+p]+i*e[40+p]-s*e[56+p],c[0]=t*(e[p]+e[32+p]),c[3]=t*(e[p]-e[32+p]),c[1]=l[0]+l[3],c[2]=l[1]-l[2],u[0]=c[0]+c[1],u[1]=c[3]+c[2],u[2]=c[3]-c[2],u[3]=c[0]-c[1],e[0+p]=u[0]+h[0],e[8+p]=u[1]+h[1],e[16+p]=u[2]+h[2],e[24+p]=u[3]+h[3],e[32+p]=u[3]-h[3],e[40+p]=u[2]-h[2],e[48+p]=u[1]-h[1],e[56+p]=u[0]-h[0]}function I(e){for(let t=0;t<64;++t){const s=e[0][t],r=e[1][t],i=e[2][t];e[0][t]=s+1.5747*i,e[1][t]=s-.1873*r-.4682*i,e[2][t]=s+1.8556*r}}function _(e,s,r){for(let i=0;i<64;++i)s[r+i]=t.DataUtils.toHalfFloat(L(e[i]))}function L(e){return e<=1?Math.sign(e)*Math.pow(Math.abs(e),2.2):Math.sign(e)*Math.pow(a,Math.abs(e)-1)}function C(e){return new DataView(e.array.buffer,e.offset.value,e.size)}function F(e){const t=e.viewer.buffer.slice(e.offset.value,e.offset.value+e.size),s=new Uint8Array(k(t)),r=new Uint8Array(s.length);return T(s),S(s,r),new DataView(r.buffer)}function B(e){const t=Gs(e.array.slice(e.offset.value,e.offset.value+e.size)),s=new Uint8Array(t.length);return T(t),S(t,s),new DataView(s.buffer)}function O(e){const t=e.viewer,r={value:e.offset.value},i=new Uint16Array(e.width*e.scanlineBlockSize*(e.channels*e.type)),n=new Uint8Array(8192);let a=0;const o=new Array(e.channels);for(let t=0;t<e.channels;t++)o[t]={},o[t].start=a,o[t].end=o[t].start,o[t].nx=e.width,o[t].ny=e.lines,o[t].size=e.type,a+=o[t].nx*o[t].ny*o[t].size;const l=K(t,r),h=K(t,r);if(h>=8192)throw new Error("Something is wrong with PIZ_COMPRESSION BITMAP_SIZE");if(l<=h)for(let e=0;e<h-l+1;e++)n[e+l]=G(t,r);const c=new Uint16Array(s),u=function(e,t){let r=0;for(let i=0;i<s;++i)(0==i||e[i>>3]&1<<(7&i))&&(t[r++]=i);const i=r-1;for(;r<s;)t[r++]=0;return i}(n,c),p=V(t,r);A(e.array,t,r,p,i,a);for(let t=0;t<e.channels;++t){const e=o[t];for(let s=0;s<o[t].size;++s)M(i,e.start+s,e.nx,e.size,e.ny,e.nx*e.size,u)}!function(e,t,s){for(let r=0;r<s;++r)t[r]=e[t[r]]}(c,i,a);let d=0;const m=new Uint8Array(i.buffer.byteLength);for(let t=0;t<e.lines;t++)for(let t=0;t<e.channels;t++){const e=o[t],s=e.nx*e.size,r=new Uint8Array(i.buffer,2*e.end,2*s);m.set(r,d),d+=2*s,e.end+=s}return new DataView(m.buffer)}function z(e){const t=Gs(e.array.slice(e.offset.value,e.offset.value+e.size)),s=e.lines*e.channels*e.width,r=1==e.type?new Uint16Array(s):new Uint32Array(s);let i=0,n=0;const a=new Array(4);for(let s=0;s<e.lines;s++)for(let s=0;s<e.channels;s++){let s=0;switch(e.type){case 1:a[0]=i,a[1]=a[0]+e.width,i=a[1]+e.width;for(let i=0;i<e.width;++i){s+=t[a[0]++]<<8|t[a[1]++],r[n]=s,n++}break;case 2:a[0]=i,a[1]=a[0]+e.width,a[2]=a[1]+e.width,i=a[2]+e.width;for(let i=0;i<e.width;++i){s+=t[a[0]++]<<24|t[a[1]++]<<16|t[a[2]++]<<8,r[n]=s,n++}}}return new DataView(r.buffer)}function D(e){const t=e.viewer,s={value:e.offset.value},r=new Uint8Array(e.width*e.lines*(e.channels*e.type*2)),i={version:H(t,s),unknownUncompressedSize:H(t,s),unknownCompressedSize:H(t,s),acCompressedSize:H(t,s),dcCompressedSize:H(t,s),rleCompressedSize:H(t,s),rleUncompressedSize:H(t,s),rleRawSize:H(t,s),totalAcUncompressedCount:H(t,s),totalDcUncompressedCount:H(t,s),acCompression:H(t,s)};if(i.version<2)throw new Error("EXRLoader.parse: "+ee.compression+" version "+i.version+" is unsupported");const n=new Array;let a=K(t,s)-2;for(;a>0;){const e=N(t.buffer,s),r=G(t,s),i=r>>2&3,o=new Int8Array([(r>>4)-1])[0],l=G(t,s);n.push({name:e,index:o,type:l,compression:i}),a-=e.length+3}const o=ee.channels,l=new Array(e.channels);for(let t=0;t<e.channels;++t){const s=l[t]={},r=o[t];s.name=r.name,s.compression=0,s.decoded=!1,s.type=r.pixelType,s.pLinear=r.pLinear,s.width=e.width,s.height=e.lines}const h={idx:new Array(3)};for(let t=0;t<e.channels;++t){const e=l[t];for(let s=0;s<n.length;++s){const r=n[s];e.name==r.name&&(e.compression=r.compression,r.index>=0&&(h.idx[r.index]=t),e.offset=t)}}let c,u,p;if(i.acCompressedSize>0)switch(i.acCompression){case 0:c=new Uint16Array(i.totalAcUncompressedCount),A(e.array,t,s,i.acCompressedSize,c,i.totalAcUncompressedCount);break;case 1:const r=Gs(e.array.slice(s.value,s.value+i.totalAcUncompressedCount));c=new Uint16Array(r.buffer),s.value+=i.totalAcUncompressedCount}if(i.dcCompressedSize>0){const t={array:e.array,offset:s,size:i.dcCompressedSize};u=new Uint16Array(B(t).buffer),s.value+=i.dcCompressedSize}if(i.rleRawSize>0){p=k(Gs(e.array.slice(s.value,s.value+i.rleCompressedSize)).buffer),s.value+=i.rleCompressedSize}let d=0;const m=new Array(l.length);for(let e=0;e<m.length;++e)m[e]=new Array;for(let t=0;t<e.lines;++t)for(let t=0;t<l.length;++t)m[t].push(d),d+=l[t].width*e.type*2;!function(e,t,s,r,i,n){let a=new DataView(n.buffer);const o=s[e.idx[0]].width,l=s[e.idx[0]].height,h=Math.floor(o/8),c=Math.ceil(o/8),u=Math.ceil(l/8),p=o-8*(c-1),d=l-8*(u-1),m={value:0},f=new Array(3),g=new Array(3),y=new Array(3),b=new Array(3),x=new Array(3);for(let s=0;s<3;++s)x[s]=t[e.idx[s]],f[s]=s<1?0:f[s-1]+c*u,g[s]=new Float32Array(64),y[s]=new Uint16Array(64),b[s]=new Uint16Array(64*c);for(let t=0;t<u;++t){let n=8;t==u-1&&(n=d);let o=8;for(let e=0;e<c;++e){e==c-1&&(o=p);for(let e=0;e<3;++e)y[e].fill(0),y[e][0]=i[f[e]++],R(m,r,y[e]),E(y[e],g[e]),P(g[e]);I(g);for(let t=0;t<3;++t)_(g[t],b[t],64*e)}let l=0;for(let r=0;r<3;++r){const i=s[e.idx[r]].type;for(let e=8*t;e<8*t+n;++e){l=x[r][e];for(let t=0;t<h;++t){const s=64*t+8*(7&e);a.setUint16(l+0*i,b[r][s+0],!0),a.setUint16(l+2*i,b[r][s+1],!0),a.setUint16(l+4*i,b[r][s+2],!0),a.setUint16(l+6*i,b[r][s+3],!0),a.setUint16(l+8*i,b[r][s+4],!0),a.setUint16(l+10*i,b[r][s+5],!0),a.setUint16(l+12*i,b[r][s+6],!0),a.setUint16(l+14*i,b[r][s+7],!0),l+=16*i}}if(h!=c)for(let e=8*t;e<8*t+n;++e){const t=x[r][e]+8*h*2*i,s=64*h+8*(7&e);for(let e=0;e<o;++e)a.setUint16(t+2*e*i,b[r][s+e],!0)}}}const v=new Uint16Array(o);a=new DataView(n.buffer);for(let t=0;t<3;++t){s[e.idx[t]].decoded=!0;const r=s[e.idx[t]].type;if(2==s[t].type)for(let e=0;e<l;++e){const s=x[t][e];for(let e=0;e<o;++e)v[e]=a.getUint16(s+2*e*r,!0);for(let e=0;e<o;++e)a.setFloat32(s+2*e*r,X(v[e]),!0)}}}(h,m,l,c,u,r);for(let t=0;t<l.length;++t){const s=l[t];if(!s.decoded)switch(s.compression){case 2:let i=0,n=0;for(let a=0;a<e.lines;++a){let e=m[t][i];for(let t=0;t<s.width;++t){for(let t=0;t<2*s.type;++t)r[e++]=p[n+t*s.width*s.height];n++}i++}break;case 1:default:throw new Error("EXRLoader.parse: unsupported channel compression")}}return new DataView(r.buffer)}function N(e,t){const s=new Uint8Array(e);let r=0;for(;0!=s[t.value+r];)r+=1;const i=(new TextDecoder).decode(s.slice(t.value,t.value+r));return t.value=t.value+r+1,i}function U(e,t){const s=e.getInt32(t.value,!0);return t.value=t.value+4,s}function V(e,t){const s=e.getUint32(t.value,!0);return t.value=t.value+4,s}function j(e,t){const s=e[t.value];return t.value=t.value+1,s}function G(e,t){const s=e.getUint8(t.value);return t.value=t.value+1,s}const H=function(e,t){let s;return s="getBigInt64"in DataView.prototype?Number(e.getBigInt64(t.value,!0)):e.getUint32(t.value+4,!0)+Number(e.getUint32(t.value,!0)<<32),t.value+=8,s};function W(e,t){const s=e.getFloat32(t.value,!0);return t.value+=4,s}function q(e,s){return t.DataUtils.toHalfFloat(W(e,s))}function X(e){const t=(31744&e)>>10,s=1023&e;return(e>>15?-1:1)*(t?31===t?s?NaN:1/0:Math.pow(2,t-15)*(1+s/1024):s/1024*6103515625e-14)}function K(e,t){const s=e.getUint16(t.value,!0);return t.value+=2,s}function Q(e,t){return X(K(e,t))}function Z(e,t,s,r,i){return"string"===r||"stringvector"===r||"iccProfile"===r?function(e,t,s){const r=(new TextDecoder).decode(new Uint8Array(e).slice(t.value,t.value+s));return t.value=t.value+s,r}(t,s,i):"chlist"===r?function(e,t,s,r){const i=s.value,n=[];for(;s.value<i+r-1;){const r=N(t,s),i=U(e,s),a=G(e,s);s.value+=3;const o=U(e,s),l=U(e,s);n.push({name:r,pixelType:i,pLinear:a,xSampling:o,ySampling:l})}return s.value+=1,n}(e,t,s,i):"chromaticities"===r?function(e,t){return{redX:W(e,t),redY:W(e,t),greenX:W(e,t),greenY:W(e,t),blueX:W(e,t),blueY:W(e,t),whiteX:W(e,t),whiteY:W(e,t)}}(e,s):"compression"===r?function(e,t){return["NO_COMPRESSION","RLE_COMPRESSION","ZIPS_COMPRESSION","ZIP_COMPRESSION","PIZ_COMPRESSION","PXR24_COMPRESSION","B44_COMPRESSION","B44A_COMPRESSION","DWAA_COMPRESSION","DWAB_COMPRESSION"][G(e,t)]}(e,s):"box2i"===r?function(e,t){return{xMin:V(e,t),yMin:V(e,t),xMax:V(e,t),yMax:V(e,t)}}(e,s):"lineOrder"===r?function(e,t){return["INCREASING_Y"][G(e,t)]}(e,s):"float"===r?W(e,s):"v2f"===r?function(e,t){return[W(e,t),W(e,t)]}(e,s):"v3f"===r?function(e,t){return[W(e,t),W(e,t),W(e,t)]}(e,s):"int"===r?U(e,s):"rational"===r?function(e,t){return[U(e,t),V(e,t)]}(e,s):"timecode"===r?function(e,t){return[V(e,t),V(e,t)]}(e,s):"preview"===r?(s.value+=i,"skipped"):void(s.value+=i)}const Y=new DataView(e),J=new Uint8Array(e),$={value:0},ee=function(e,t,s){const r={};if(20000630!=e.getUint32(0,!0))throw new Error("THREE.EXRLoader: provided file doesn't appear to be in OpenEXR format.");r.version=e.getUint8(4);const i=e.getUint8(5);r.spec={singleTile:!!(2&i),longName:!!(4&i),deepFormat:!!(8&i),multiPart:!!(16&i)},s.value=8;let n=!0;for(;n;){const i=N(t,s);if(0==i)n=!1;else{const n=N(t,s),a=Z(e,t,s,n,V(e,s));void 0===a?console.warn(`EXRLoader.parse: skipped unknown header attribute type '${n}'.`):r[i]=a}}if(0!=(-5&i))throw console.error("EXRHeader:",r),new Error("THREE.EXRLoader: provided file is currently unsupported.");return r}(Y,e,$),te=function(e,s,r,i,n){const a={size:0,viewer:s,array:r,offset:i,width:e.dataWindow.xMax-e.dataWindow.xMin+1,height:e.dataWindow.yMax-e.dataWindow.yMin+1,channels:e.channels.length,bytesPerLine:null,lines:null,inputSize:null,type:e.channels[0].pixelType,uncompress:null,getter:null,format:null,colorSpace:t.LinearSRGBColorSpace};switch(e.compression){case"NO_COMPRESSION":a.lines=1,a.uncompress=C;break;case"RLE_COMPRESSION":a.lines=1,a.uncompress=F;break;case"ZIPS_COMPRESSION":a.lines=1,a.uncompress=B;break;case"ZIP_COMPRESSION":a.lines=16,a.uncompress=B;break;case"PIZ_COMPRESSION":a.lines=32,a.uncompress=O;break;case"PXR24_COMPRESSION":a.lines=16,a.uncompress=z;break;case"DWAA_COMPRESSION":a.lines=32,a.uncompress=D;break;case"DWAB_COMPRESSION":a.lines=256,a.uncompress=D;break;default:throw new Error("EXRLoader.parse: "+e.compression+" is unsupported")}if(a.scanlineBlockSize=a.lines,1==a.type)switch(n){case t.FloatType:a.getter=Q,a.inputSize=2;break;case t.HalfFloatType:a.getter=K,a.inputSize=2}else{if(2!=a.type)throw new Error("EXRLoader.parse: unsupported pixelType "+a.type+" for "+e.compression+".");switch(n){case t.FloatType:a.getter=W,a.inputSize=4;break;case t.HalfFloatType:a.getter=q,a.inputSize=4}}a.blockCount=(e.dataWindow.yMax+1)/a.scanlineBlockSize;for(let e=0;e<a.blockCount;e++)H(s,i);a.outputChannels=3==a.channels?4:a.channels;const o=a.width*a.height*a.outputChannels;switch(n){case t.FloatType:a.byteArray=new Float32Array(o),a.channels<a.outputChannels&&a.byteArray.fill(1,0,o);break;case t.HalfFloatType:a.byteArray=new Uint16Array(o),a.channels<a.outputChannels&&a.byteArray.fill(15360,0,o);break;default:console.error("THREE.EXRLoader: unsupported type: ",n)}return a.bytesPerLine=a.width*a.inputSize*a.channels,4==a.outputChannels?(a.format=t.RGBAFormat,a.colorSpace=t.LinearSRGBColorSpace):(a.format=t.RedFormat,a.colorSpace=t.NoColorSpace),a}(ee,Y,J,$,this.type),se={value:0},re={R:0,G:1,B:2,A:3,Y:0};for(let e=0;e<te.height/te.scanlineBlockSize;e++){const t=V(Y,$);te.size=V(Y,$),te.lines=t+te.scanlineBlockSize>te.height?te.height-t:te.scanlineBlockSize;const s=te.size<te.lines*te.bytesPerLine?te.uncompress(te):C(te);$.value+=te.size;for(let t=0;t<te.scanlineBlockSize;t++){const r=t+e*te.scanlineBlockSize;if(r>=te.height)break;for(let e=0;e<te.channels;e++){const i=re[ee.channels[e].name];for(let n=0;n<te.width;n++){se.value=(t*(te.channels*te.width)+e*te.width+n)*te.inputSize;const a=(te.height-1-r)*(te.width*te.outputChannels)+n*te.outputChannels+i;te.byteArray[a]=te.getter(s,se)}}}}return{header:ee,width:te.width,height:te.height,data:te.byteArray,format:te.format,colorSpace:te.colorSpace,type:this.type}}setDataType(e){return this.type=e,this}load(e,s,r,i){return super.load(e,(function(e,r){e.colorSpace=r.colorSpace,e.minFilter=t.LinearFilter,e.magFilter=t.LinearFilter,e.generateMipmaps=!1,e.flipY=!1,s&&s(e,r)}),r,i)}}class xr{constructor(e){this.callback_obj={},this.lzma_worker=new Worker(e||"./lzma_worker-min.js"),this.lzma_worker.onmessage=function(e){3===e.data.action?this.callback_obj[e.data.cbn]&&"function"==typeof this.callback_obj[e.data.cbn].on_progress&&this.callback_obj[e.data.cbn].on_progress(e.data.result):this.callback_obj[e.data.cbn]&&"function"==typeof this.callback_obj[e.data.cbn].on_finish&&(this.callback_obj[e.data.cbn].on_finish(e.data.result,e.data.error),delete this.callback_obj[e.data.cbn])}.bind(this),this.lzma_worker.onerror=function(e){var t=new Error(e.message+" ("+e.filename+":"+e.lineno+")");for(var s in this.callback_obj)this.callback_obj[s].on_finish(null,t);console.error("Uncaught error in lzma_worker",t)}.bind(this)}send_to_worker(e,t,s,r,i){var n;do{n=Math.floor(1e7*Math.random())}while(void 0!==this.callback_obj[n]);this.callback_obj[n]={on_finish:r,on_progress:i},this.lzma_worker.postMessage({action:e,cbn:n,data:t,mode:s})}compress(e,t,s,r){this.send_to_worker(1,e,t,s,r)}decompress(e,t,s){this.send_to_worker(2,e,!1,t,s)}worker(){return this.lzma_worker}}const vr={getMesh:(e,t)=>{let s={};return e.traverse((e=>{e.isMesh&&(s[e.name]=e)})),s},keepMaterial:e=>{let t,s={};e.traverse((e=>{e.isMesh&&(t=e.material,s[t.name]||(s[t.name]=!0))}))},getGroup:(e,t,s)=>{const r={};let i=null;return s&&(i=vr.getMaterial(e,!0)),e.traverse((e=>{e.isGroup&&(r[e.name]=t?vr.groupToMesh(e,i):e)})),r},getMaterial:(e,t)=>{const s={},r=[];let i,n;return e.traverse((e=>{e.isMesh&&(i=e.material,s[i.name]||(s[i.name]=i,n=Number(i.name.substring(0,i.name.lastIndexOf("_"))),r[n]=i))})),t?r:s},groupToMesh:(e,t)=>{if(e.children[0].name!==e.name+"_1")return e;if(!e.children[0].isMesh)return e;let s,r=[],i=e.children.length,n=0;for(let t=0;t<i;t++)s=e.children[t].material.name,n=Number(s.substring(0,s.lastIndexOf("_"))),e.children[t].material.dispose(),r[t]=e.children[t].geometry,r[t].forceMatId=n;let a=new THREE.Mesh(new J(r,!0),t);return a.name=e.name,a},symetric:e=>{e.isMesh&&(e=e.geometry);let t=e.attributes.uv.array,s=.5*t.length;for(;s--;)t[2*s]<0&&(t[2*s]*=-1);e.attributes.uv.needsUpdate=!0},uv2:e=>{e.isMesh&&(e=e.geometry),e.setAttribute("uv2",e.attributes.uv)},autoMorph:(e,s,r=!0,i=!1)=>{let n,a,o,l,h,c,u,p,d,m,f,g={},y=[];e.traverse((e=>{e.isMesh&&-1!==e.name.search("__M__")&&(g[e.name]=e.geometry,y.push(e))}));for(let e in g)if(n=e.substring(0,e.indexOf("__")),a=e.substring(e.lastIndexOf("__")+2),o=s[n],o)if(h=o.geometry,c=g[e],h.morphTargetsRelative=i,h.attributes.position.count===c.attributes.position.count){if(h.morphAttributes.position||(h.morphAttributes.position=[],r&&(h.morphAttributes.normal=[]),o.morphTargetInfluences=[],o.morphTargetDictionary={}),l=h.morphAttributes.position.length,i){for(u=c.attributes.position.array.length,m=[];u--;)m[u]=c.attributes.position.array[u]-h.attributes.position.array[u];p=new t.Float32BufferAttribute(m,3)}else p=new t.Float32BufferAttribute(c.attributes.position.array,3);h.morphAttributes.position.push(p),r&&(d=new t.Float32BufferAttribute(c.attributes.normal.array,3),h.morphAttributes.normal.push(d)),o.morphTargetInfluences.push(0),o.morphTargetDictionary[a]=l}else console.warn("Morph "+a+" target is no good on "+o.name);for(g={},u=y.length;u--;)f=y[u],f.parent&&f.parent.remove(f),f.material&&f.material.dispose(),f.geometry&&f.geometry.dispose()}},wr={msg:"",inLoad:!1,clip:[],data:new Map,tmp:[],dracoLoader:null,dracoLoaderType:"js",dracoPath:"./src/libs/draco/",onLoad:()=>{},onEnd:()=>{},log:e=>{},materialRoot:e=>{console.log(e)},setLoadEvent:(e,t)=>{wr.onLoad=e,wr.onEnd=t},prefix:e=>{let t="";switch(e){case"S":case"sound":case"mp3":case"wav":case"ogg":t="S_";break;case"I":case"image":case"jpg":case"png":t="I_";break;case"E":case"hdr":case"env":t="T_";break;case"J":case"json":t="J_";break;case"JS":case"js":t="JS_";break;case"O":case"object3d":t="O_";break;case"M":case"material":t="M_";break;case"T":case"texture":t="T_"}return t},dispose:()=>{wr.data.forEach((function(e,t){(e.isMaterial||e.isTexture)&&(e.dispose(),wr.data.delete(t)),e.isObject3D&&(e.traverse((function(e){e.isMesh&&(e.geometry&&e.geometry.dispose(),e.material&&e.material.dispose())})),wr.data.delete(t))}))},createElementNS:e=>document.createElementNS("http://www.w3.org/1999/xhtml",e),exist:(e,t="")=>!!wr.get(e,t),delete:(e,t="")=>wr.data.delete(wr.prefix(t)+e),get:(e,t="")=>wr.data.get(wr.prefix(t)+e),set:(e,t,s="",r)=>{t.isMaterial&&(s="material",t.name=e,wr.materialRoot(t,r)),t.isTexture&&(s="texture"),t.isObject3D&&(s="object3d"),wr.get(e,s)||wr.data.set(wr.prefix(s)+e,t)},getScript:e=>wr.data.get(wr.prefix("js")+e),getMaterials:(e,t)=>("string"==typeof e&&(e=wr.get(e,"O")),vr.getMaterial(e,t)),getMesh:(e,t)=>("string"==typeof e&&(e=wr.get(e,"O")),vr.getMesh(e,t)),getGroup:(e,t,s)=>("string"==typeof e&&(e=wr.get(e,"O")),vr.getGroup(e,t,s)),applyMorph(e,t=null,s=!0,r=!0){let i;i=e.isObject3D?e:wr.get(e,"O"),t||(t=wr.getMesh(e)),i&&t&&vr.autoMorph(i,t,s,r)},uv2(e){vr.uv2(e)},add:(e,t,s)=>{wr.set(e,t,s),wr.next()},getMaterial:e=>wr.data.get("M_"+e),texture:(e={})=>{wr.loaderMap||(wr.loaderMap=new t.TextureLoader);let s=e.url.substring(e.url.lastIndexOf("/")+1,e.url.lastIndexOf("."));return-1===s.search("_c")&&-1===s.search("_l")&&-1===s.search("_u")&&-1===s.search("_d")||(e.srgb=!0),wr.exist(s,"texture")?get(s,"texture"):wr.exist(s,"image")?wr.getTexture(s,e):wr.loaderMap.load(e.url,(function(t){return wr.setTextureOption(t,e),wr.data.set("T_"+s,t),e.callback&&e.callback(),t}))},getTexture:(e,s={})=>{let r=wr.get(e,"texture");if(!r){let i=wr.data.get("I_"+e);if(!i)return null;r=new t.Texture(i),-1===e.search("_c")&&-1===e.search("_d")&&-1===e.search("_l")&&-1===e.search("_u")||(s.srgb=!0),wr.data.set("T_"+e,r)}return wr.setTextureOption(r,s),r},setTextureOption:(e,s={})=>{s.encoding&&(e.colorSpace=t.SRGBColorSpace),s.srgb&&(e.colorSpace=t.SRGBColorSpace),e.flipY=void 0!==(s.flipY||s.flip)&&s.flipY,void 0!==s.anisotropy&&(e.anisotropy=s.anisotropy),void 0!==s.generateMipmaps&&(e.generateMipmaps=s.generateMipmaps),s.repeat&&(e.repeat.fromArray(s.repeat),e.wrapS=e.wrapT=t.RepeatWrapping),s.filter&&"near"===s.filter&&(e.minFilter=t.NearestFilter,e.magFilter=t.NearestFilter),s.channel&&(e.channel=s.channel),e.needsUpdate=!0},load:(e,t,s="",r="")=>{wr.msg=r;let i=[],n=t||function(){},a=("undefined"==typeof performance?Date:performance).now();"string"==typeof e||e instanceof String?i.push(e):i=i.concat(e),wr.tmp.push({urls:i,path:s,callback:n,start:a}),wr.inLoad||wr.loadOne()},loadOne:()=>{wr.inLoad=!0,wr.onLoad();let e=wr.tmp[0].path+wr.tmp[0].urls[0],t=e.substring(e.lastIndexOf("/")+1,e.lastIndexOf(".")),s=e.substring(e.lastIndexOf(".")+1).toLowerCase();wr.exist(t,s)?wr.next():wr.loading(e,t,s)},next:()=>{wr.tmp[0].urls.shift(),0===wr.tmp[0].urls.length?(Math.floor(("undefined"==typeof performance?Date:performance).now()-wr.tmp[0].start),wr.tmp[0].callback(),wr.tmp.shift(),wr.tmp.length>0?wr.loadOne():(wr.inLoad=!1,wr.onEnd())):wr.loadOne()},loading:(e,t,s)=>{switch(wr.log(wr.msg),s){case"glb":case"gltf":wr.load_GLTF(e,t);break;case"fbx":case"FBX":wr.load_FBX(e,t);break;case"hdr":wr.load_RGBE(e,t);break;case"exr":wr.load_EXR(e,t);break;default:wr.extand(e,t,s)}},extand:(e,t,s)=>{wr.XHTTP||(wr.XHTTP=new XMLHttpRequest);const r=wr.XHTTP;switch(r.open("GET",e,!0),"json"===s&&r.overrideMimeType("application/json"),s){case"hex":case"wasm":case"mp3":case"wav":case"ogg":case"jpg":case"png":r.responseType="arraybuffer";break;case"bvh":case"glsl":case"js":case"json":r.responseType="text"}r.onreadystatechange=function(){4===r.readyState&&(r.status>=300?console.log("Error, status code = "+r.status):wr.direct(r.response,t,s))},"onprogress"in r&&(r.onprogress=function(e){}),r.send(null)},direct:(e,t,s)=>{switch(s){case"jpg":case"png":let r=wr.createElementNS("img");r.src=window.URL.createObjectURL(new Blob([e])),wr.add(t,r,"image");break;case"mp3":case"wav":case"ogg":AudioContext.getContext().decodeAudioData(e.slice(0),(function(e){wr.add(t,e,"sound")}),(function(e){console.error("decodeAudioData error",e)}));break;case"hex":LzmaUnpack.parse(e,(function(e){wr.add(t,e,s)}));break;case"wasm":wr.add(t,new Uint8Array(e),s);break;case"json":wr.add(t,JSON.parse(e),s);break;case"js":wr.add(t,e,s);break;default:wr.add(t,e,s)}},loaderDRACO:()=>{if(wr.dracoLoader)return wr.dracoLoader;if(!wr.dracoLoaderType)if(navigator.userAgentData)wr.dracoLoaderType="wasm";else{let e=navigator.userAgent.toLowerCase();wr.dracoLoaderType=-1!==e.indexOf("safari")&&-1===e.indexOf("chrome")?"js":"wasm"}return wr.dracoLoader=(new gs).setDecoderPath(wr.dracoPath),wr.dracoLoader.setDecoderConfig({type:wr.dracoLoaderType}),wr.dracoLoader},loaderGLTF:()=>(wr.GLTF||(wr.GLTF=new vt,wr.GLTF.setDRACOLoader(wr.loaderDRACO())),wr.GLTF),loaderFBX:()=>(wr.FBX||(wr.FBX=new Js),wr.FBX),loaderRGBE:()=>(wr.RGBE||(wr.RGBE=new yr),wr.RGBE),loaderEXR:()=>(wr.EXR||(wr.EXR=new br),wr.EXR),load_GLTF:(e,s)=>{wr.loaderGLTF().load(e,(function(e){const r=e.scene;if(e.animations){const s=e.animations,i=new t.AnimationMixer(e.scene);r.mixer=i,r.actions={};for(let e=0;e<s.length;e++){let t=s[e];r.actions[t.name]=i.clipAction(t)}r.play=e=>{r.actions[e]&&(r.actions[e].paused=!1,r.actions[e].time=0,r.actions[e].play())},r.pause=(e,t=!0)=>{r.actions[e]&&(r.actions[e].paused=t)}}wr.add(s,r)}))},load_FBX:(e,t)=>{wr.loaderFBX().load(e,(function(e){wr.add(t,e)}))},load_RGBE:(e,s)=>{wr.loaderRGBE().load(e,(function(e){e.mapping=t.EquirectangularReflectionMapping,wr.add(s,e)}))},load_EXR:(e,t,s)=>{wr.loaderEXR().load(e,(function(e){return console.log(e),s&&s(e),e}))},direct_EXR:(e,t)=>{wr.loaderEXR().parse(url,(function(e){return wr.add(t,e),e}))}};class Mr{constructor(e,s){this.target=s||e,this.baseGeometry=e.geometry,this.geometry=this.target.geometry,this.V=[new t.Vector3,new t.Vector3,new t.Vector3],this.X=[new t.Vector4,new t.Vector4,new t.Matrix4],this.M=[new t.Vector3,new t.Vector3,new t.Vector3],this.isMorph=!!this.target.morphTargetInfluences,this.isSkin=!!this.target.isSkinnedMesh,this.init()}init(){this.geometry.attributes.position.count===this.baseGeometry.attributes.position.count?(this.length=this.baseGeometry.attributes.position.count,this.indexLength=this.baseGeometry.index.count/3,this.originEdges=new Array(this.length).fill(0),this.targetEdges=new Array(this.length).fill(0),(this.isSkin||this.isMorph)&&(this.back=new Array(3*this.length).fill(0)),this.num=new Array(this.length).fill(0),this.getEdge(this.baseGeometry,this.originEdges),this.addColor(),setTimeout(this.start.bind(this),100)):console.log("object not have same number of vertices !!")}start(){this.ready=!0,this.update()}addColor(){const e=this.geometry;let s=e.attributes.position.array.length;e.setAttribute("color",new t.Float32BufferAttribute(new Array(s).fill(0),3))}resetEdge(e){let t=e.length;for(;t--;)e[t]=0}getEdge(e,t,s=!1,r=!1){let i=e.attributes.position.array;const n=e.index.array;let a,o,l,h,c,u,p,d=this.V[0],m=this.V[1],f=this.V[2],g=0;for(r&&(i=this.getMorph()),s&&(i=this.getSkinned(i)),(s||r)&&this.resetEdge(t),a=this.indexLength;a--;)o=n[g],l=n[g+1],h=n[g+2],d.fromArray(i,3*o),m.fromArray(i,3*l),f.fromArray(i,3*h),c=d.distanceTo(m),u=d.distanceTo(f),p=m.distanceTo(f),t[o]+=.5*(c+u),t[l]+=.5*(c+p),t[h]+=.5*(u+p),g+=3}isZero(e){return 0===e.x&&0===e.y&&0===e.z}getMorph(){const e=this.target.morphTargetInfluences,t=this.geometry.morphAttributes.position,s=e.length,r=this.geometry.attributes.position.array;let i,n,a,o,l=this.geometry.attributes.position.count,h=this.M[0],c=this.M[1],u=this.M[2],p=this.geometry.morphTargetsRelative;for(n=l;n--;){for(i=3*n,c.fromArray(r,i),h.set(0,0,0),a=s;a--;)0!=e[a]&&(o=t[a].data?t[a].data.array:t[a].array,p?h.addScaledVector(u.fromArray(o,i),e[a]):h.addScaledVector(u.fromArray(o,i).sub(c),e[a]));c.add(h),c.toArray(this.back,i)}return this.back}getSkinned(e){const t=this.target.skeleton;t.boneMatrices;const s=this.geometry,r=s.attributes.skinIndex.array,i=s.attributes.skinWeight.array,n=this.target.bindMatrix,a=this.target.bindMatrixInverse;let o,l,h,c,u,p=this.V[0],d=this.V[1],m=this.V[2],f=this.X[0],g=this.X[1],y=this.X[2];for(o=s.attributes.position.count;o--;){for(u=3*o,f.fromArray(r,4*o),g.fromArray(i,4*o),p.fromArray(e,u).applyMatrix4(n),d.set(0,0,0),l=4;l--;)c=g.getComponent(l),c>0&&(h=f.getComponent(l),y.multiplyMatrices(t.bones[h].matrixWorld,t.boneInverses[h]),d.addScaledVector(m.copy(p).applyMatrix4(y),c));d.applyMatrix4(a),d.toArray(this.back,u)}return this.back}update(){if(!this.ready)return;this.getEdge(this.geometry,this.targetEdges,this.isSkin,this.isMorph);const e=this.geometry.attributes.color.array;let t,s,r,i=this.length;for(;i--;)t=this.originEdges[i],s=(t-this.targetEdges[i])/t+.5,r=3*i,e[r]=s>.5?2*(s-.5):0,e[r+1]=0,e[r+2]=s<.5?1-2*s:0;this.geometry.attributes.color.needsUpdate=!0}}class Ar extends t.Object3D{constructor(e,s){super(),this.isReady=!1,this.skeleton=s,this.bones=this.skeleton.bones,this.root=e,this.box=new t.BoxGeometry,this.mtxr=new t.Matrix4,this.mtx0=new t.Matrix4,this.mtx1=new t.Matrix4,this.mtx=new t.Matrix4,this.mtx2=new t.Matrix4,this.p=new t.Vector3,this.s=new t.Vector3,this.q=new t.Quaternion,this.e=new t.Euler,this.mat=new t.MeshBasicMaterial({color:13421696,wireframe:!0,toneMapped:!1}),this.init(),this.matrix=e.matrixWorld,this.matrixAutoUpdate=!1}updateMatrixWorld(e){if(!this.isReady)return;let t,s,r=this.children,i=r.length;for(this.mtxr.copy(this.root.matrixWorld).invert();i--;)t=r[i],s=t.userData.bone,this.mtx0.multiplyMatrices(this.mtxr,s.matrixWorld),this.mtx.multiplyMatrices(this.mtx0,t.userData.decal),this.mtx.decompose(this.p,this.q,this.s),t.position.copy(this.p),t.quaternion.copy(this.q),t.updateMatrix();super.updateMatrixWorld(e)}init(){this.mtxr.copy(this.root.matrixWorld).invert();const e=this.bones;let s,r,i,n,a,o,l,h,c,u,p,d=new t.Vector3,m=new t.Vector3,f=e.length;for(s=0;s<f;s++)h=null,n=e[s],r=n.name,a=n.parent,a&&(i=a.name,d.setFromMatrixPosition(a.matrixWorld),m.setFromMatrixPosition(n.matrixWorld),l=d.distanceTo(m),c=[0,0,.5*l],o=[l,1,1],u=[0,0,0],p="_C","head"===i&&"End_head"===r&&(h="box",o=[.16,.2,l],c=[0,.025,.5*-l]),"chest"===i&&"neck"===r&&(h="box",o=[.3,.28,l],c=[0,0,.5*-l]),"abdomen"===i&&(h="box",o=[.28,.24,l+.14],u[2]=0,c=[0,0,.5*-l],c[2]+=.07),"rThigh"===i&&(h="box",o=[.15,.15,l]),"lThigh"===i&&(h="box",o=[.15,.15,l]),"rShin"===i&&(h="box",o=[.12,.12,l+.1],c[2]+=.05),"lShin"===i&&(h="box",o=[.12,.12,l+.1],c[2]+=.05),"rShldr"===i&&(h="box",o=[l+.06,.12,.12],c[0]=.03-c[2],c[2]=0),"lShldr"===i&&(h="box",o=[l+.06,.12,.12],c[0]=c[2]-.03,c[2]=0),"rForeArm"===i&&(h="box",o=[l+.1,.1,.1],c[0]=-c[2]-.05,c[2]=0),"lForeArm"===i&&(h="box",o=[l+.1,.1,.1],c[0]=c[2]+.05,c[2]=0),null!==h&&this.addMesh(a,h,o,c,u,"_C"));this.isReady=!0}addMesh(e,s,r,i,n,a){this.mtx.makeTranslation(i[0],i[1],i[2]);var o=new t.Mesh(this.box,this.mat);o.scale.fromArray(r),o.userData.decal=this.mtx.clone(),o.userData.bone=e,o.userData.size=r,this.add(o)}dispose(){this.children=[],this.box.dispose(),this.mat.dispose(),this.isReady=!1}}const Tr={mixRatio:0,threshold:.1,normal:.25,hair:10761234,bow:1049602,sheen:2,sheenRoughness:1,metalness:.6,roughness:.4,wireframe:!1,vertexColors:!1,alphaTest:.3,h_metal:.4,h_rough:.6,clearcoat:1},Sr={isBreath:!1,isEyeMove:!0,haveMorph:!0,skeletonRef:"body",fullMorph:["MUSCLE","LOW","BIG","MONSTER"],haveQuality:!0,textureRef:"avatar_c",texturePath:"assets/textures/avatar_",textures:["avatar_c.jpg","avatar_n.jpg","avatar_m.jpg","avatar_r.jpg","avatar_u.jpg","mouth_c.jpg","mouth_a.jpg","mouth_n.jpg","eye_c.jpg","eye_n.jpg","hair.jpg","hair_a.jpg","eyelash_c.jpg","eyelash_a.jpg","eyelash_n.jpg","hair_man.jpg","hair_man_a.jpg"],modelPath:"assets/models/avatar/",forceModel:null,setting:Tr,materialRef:"skin",materials:{skin:{type:"Physical",map:"avatar_c",normalMap:"avatar_n",roughness:1,metalness:1,metalnessMap:"avatar_m",roughnessMap:"avatar_r",normalScale:new t.Vector2(Tr.normal,-Tr.normal),sheen:Tr.sheen,sheenRoughness:Tr.sheenRoughness,sheenColor:16777215,sheenColorMap:"avatar_u",iridescence:.5},mouth:{type:"Standard",map:"mouth_c",roughness:.6,metalness:.6,alphaMap:"mouth_a",alphaTest:.5,normalMap:"mouth_n"},sub_eye:{type:"Physical",roughness:0,metalness:1,ior:1.376,opacity:1,blending:t.AdditiveBlending,clearcoat:1,transparent:!0,envMapIntensity:0},eye:{type:"Physical",map:"eye_c",roughness:.7,metalness:.15,normalMap:"eye_n",normalScale:new t.Vector2(2,-2),clearcoat:.25},hair:{type:"Standard",map:"hair",color:Tr.hair,roughness:Tr.h_rough,metalness:Tr.h_metal,alphaMap:"hair_a",alphaTest:Tr.alphaTest,side:t.DoubleSide,opacity:1,transparent:!0,blending:t.CustomBlending,blendDst:t.ZeroFactor,blendDstAlpha:t.SrcAlphaFactor,alphaToCoverage:!0},hair_man:{type:"Standard",map:"hair_man",color:Tr.hair,roughness:Tr.h_rough,metalness:Tr.h_metal,alphaMap:"hair_man_a",alphaTest:Tr.alphaTest,side:t.DoubleSide,opacity:1,transparent:!0,blending:t.CustomBlending,blendDst:t.ZeroFactor,blendDstAlpha:t.SrcAlphaFactor,alphaToCoverage:!0},eyelash:{type:"Standard",color:Tr.hair,map:"eyelash_c",roughness:Tr.h_rough,metalness:Tr.h_metal,alphaMap:"eyelash_a",alphaTest:Tr.alphaTest,transparent:!0,side:t.DoubleSide,alphaToCoverage:!0,polygonOffset:!0,polygonOffsetFactor:-4},tear:{type:"Physical",map:"eyelash_c",roughness:.5,metalness:.5,alphaMap:"eyelash_a",transparent:!0,alphaToCoverage:!0,opacity:1},low:{type:"Basic",color:0,wireframe:!0}},changeMaterial:e=>{if(!wr.getMaterial("skin"))return;const t=Sr.setting;if(e)for(let s in e)void 0!==t[s]&&(t[s]=e[s])},applyMaterial:(e,t)=>{const s=wr.getMaterial("skin");e.traverse((e=>{if(e.isMesh)switch(e.name){case"body":e.material=s,e.receiveShadow=!0,e.castShadow=!0;break;case"body_low":e.material=s,e.receiveShadow=!1,e.castShadow=!1,e.visible=!1;break;case"Head":e.material=s,e.receiveShadow=!0,e.castShadow=!0;break;case"mouth":e.material=wr.getMaterial("mouth")||s,e.receiveShadow=!1,e.castShadow=!1;break;case"eyelash":case"eyebrow":e.material=wr.getMaterial("eyelash")||s,e.receiveShadow=!1,e.castShadow=!1;break;case"tear":e.material=wr.getMaterial("tear")||s,e.receiveShadow=!1,e.castShadow=!1;break;case"eye_l":case"eye_r":e.material=wr.getMaterial("eye")||s,e.receiveShadow=!1,e.castShadow=!1;break;case"eye_l_s":case"eye_r_s":e.material=wr.getMaterial("sub_eye")||s,e.receiveShadow=!1,e.castShadow=!1;break;case"hair":e.material=wr.getMaterial("hair")||s,e.receiveShadow=!0,e.castShadow=!0,e.matrixWorldAutoUpdate=!1;break;case"hair_man":e.material=wr.getMaterial("hair_man")||s,e.receiveShadow=!0,e.castShadow=!0,e.matrixWorldAutoUpdate=!1}}))}},kr={metalness:.6,roughness:.4,clearcoat:1,wireframe:!1},Rr={decalY:.02,isBreath:!1,isEyeMove:!1,haveMorph:!1,skeletonRef:"eva_SKIN",fullMorph:[],haveQuality:!1,skinRef:"eva_00",texturePath:"assets/textures/eva/",textures:["eva00_c.jpg","eva01_c.jpg","eva02_c.jpg","eva_l.jpg"],modelPath:"assets/models/",forceModel:"eva",setting:kr,materialRef:"eva00",materials:{eva00:{type:"Physical",map:"eva00_c",emissiveMap:"eva_l",emissive:16777215,roughness:kr.roughness,metalness:kr.metalness,wireframe:kr.wireframe,clearcoat:kr.clearcoat,iridescence:.5},eva01:{type:"Physical",map:"eva01_c",emissiveMap:"eva_l",emissive:16777215,roughness:kr.roughness,metalness:kr.metalness,wireframe:kr.wireframe,clearcoat:kr.clearcoat,iridescence:.5},eva02:{type:"Physical",map:"eva02_c",emissiveMap:"eva_l",emissive:16777215,roughness:kr.roughness,metalness:kr.metalness,wireframe:kr.wireframe,clearcoat:kr.clearcoat,iridescence:.5}},changeMaterial:e=>{const t=Rr.setting;if(e)for(let s in e)void 0!==t[s]&&(t[s]=e[s]);let s=wr.getMaterial("eva00");s.roughness=t.roughness,s.metalness=t.metalness,s.wireframe=t.wireframe,s.clearcoat=t.clearcoat,s=wr.getMaterial("eva01"),s.roughness=t.roughness,s.metalness=t.metalness,s.wireframe=t.wireframe,s.clearcoat=t.clearcoat,s=wr.getMaterial("eva02"),s.roughness=t.roughness,s.metalness=t.metalness,s.wireframe=t.wireframe,s.clearcoat=t.clearcoat},applyMaterial:(e,t)=>{const s=wr.getMaterial(t);e.traverse((e=>{if(e.isMesh)switch(e.material=s,e.receiveShadow=!0,e.castShadow=!0,e.name){case"eva_2_head":case"eva_2_mach":e.visible="eva02"===t;break;case"eva_L_COLLAR":case"eva_R_COLLAR":e.visible="eva00"!==t;break;case"eva_HEAD":case"eva_MACHOIR":e.visible="eva01"===t;break;case"eva_0_R_COLLAR":case"eva_0_L_COLLAR":case"eva_0_head":case"eva_0_head2":e.visible="eva00"===t;break;case"eva_0_CHEST2":e.visible="eva01"!==t}}))}},Er={metalness:.2,roughness:.8,wireframe:!1},Pr={decalY:-.06,isBreath:!1,isEyeMove:!1,haveMorph:!1,skeletonRef:"leeSkin",fullMorph:[],haveQuality:!1,texturePath:"assets/textures/",textures:["lee_c.jpg","lee_ao.jpg"],modelPath:"assets/models/",forceModel:"lee",setting:Er,materialRef:"lee_material",materials:{lee_material:{type:"Physical",map:"lee_c",roughness:.3,metalness:.08,wireframe:Er.wireframe,sheen:2.2,sheenColorMap:"lee_c",sheenColor:16777215,sheenRoughness:.4,envMapIntensity:1}},changeMaterial:e=>{const t=Pr.setting;if(e)for(let s in e)void 0!==t[s]&&(t[s]=e[s]);let s=wr.getMaterial("lee_material");s.roughness=t.roughness,s.metalness=t.metalness,s.wireframe=t.wireframe},applyMaterial:(e,t)=>{const s=wr.getMaterial("lee_material");e.traverse((e=>{e.isMesh&&(e.material=s,e.receiveShadow=!0,e.castShadow=!0)}))},adjustment:()=>[{name:"lHand",values:[-60,0,0]},{name:"rHand",values:[-60,0,0]}]},Ir=1/30,_r=Math.PI/180,Lr=180/Math.PI,Cr=new t.Vector3;class Fr extends t.Group{constructor(e={}){switch(super(),this.rootPath=e.path||"./",this.lzmaPath=this.rootPath+"src/libs/lzma_worker.js",wr.dracoPath=this.rootPath+"src/libs/draco/",this.callback=e.callback||function(){},this.matrixAutoUpdate=!1,this.isPause=!0,this.textureQuality=e.quality||1,this.model=e.type||"man",this.startAnimation=e.anim||"idle",this.ref=null,this.model){case"lee":this.ref=Pr;break;case"man":case"woman":this.ref=Sr;break;case"eva00":case"eva01":case"eva02":this.ref=Rr}this.compact=void 0===e.compact||e.compact,this.haveMorph=void 0!==e.morph&&e.morph,this.fullMaterial=void 0===e.material||e.material,this.size=e.size||1,this.fullMorph=this.ref.fullMorph,this.skeleton=null,this.mixer=null,this.mesh={},this.bones={},this.done=!1,this.isClone=!1,this.isBreath=this.ref.isBreath||!1,this.isEyeMove=this.ref.isEyeMove||!1,this.decalY=this.ref.decalY||0,this.tensionTest=!1,this.tensionActive=!1,this.fixToe=!1,this.clipsToesFix=[],this.n=Math.round(1e3*Math.random()),this.actions=new Map,this.current=null,this.old=null,this.breath=0,this.breathSide=-1,this.q=(new t.Quaternion).setFromAxisAngle({x:0,y:1,z:0},.5*Math.PI),this.headBoneLook=new t.Vector3,this.eyeTarget=new t.Group,this.eyeTarget.position.set(0,1,0),this.tmpMtx=new t.Matrix4,this.tmpQ=new t.Quaternion,this.setting={mixRatio:0,threshold:.1,normal:.2,hair:10761234,bow:1049602,sheen:2.25,sheenRoughness:1,metalness:1,roughness:.5,wireframe:!1,vertexColors:!1,alphaTest:.3,h_metal:.4,h_rough:.6},this.root=wr.get(this.ref.forceModel?this.ref.forceModel:this.model,"O"),this.root?(this.isClone=!0,this.tensionTest=!1,this.root=bt(this.root),this.init()):this.fullMaterial?this.load():this.loadModels()}load(){if(this.skin=wr.getTexture(this.ref.textureRef),this.skin)this.loadModels();else{const e=this.rootPath+this.ref.texturePath+(this.ref.haveQuality?this.textureQuality+"k/":"");wr.load(this.ref.textures,this.loadModels.bind(this),e,"loading images...")}}loadModels(){const e=this.ref.forceModel?this.ref.forceModel:this.model,t=[e+".glb"],s=this.rootPath+this.ref.modelPath;this.ref.haveMorph&&this.haveMorph&&t.push(e+"_morph.glb"),wr.load(t,this.init.bind(this),s,"loading models...")}update(e){if(this.done&&this.mixer){this.mixer.update(e);const t=this.n;t<=20&&this.eyeControl(.05*t),t>10&&t<=40&&this.eyeControl(1-.05*(t-20)),this.n++,1e3===this.n&&(this.n=0),this.isClone||(this.look(10*e),this.breathing(),this.autoToes()),this.tensionActive&&(this.tension1.update(),this.tension2.update()),window.gui&&this.current&&window.gui.updateTimeBarre(Math.round(30*this.current.time),this.current.frameMax)}}look(e){if(!this.isEyeMove)return;if(this.isPause)return;const t=window.mouse||{x:0,y:0};e>1&&(e=1),this.headBoneLook.lerp({x:-20*t.y*_r,y:0,z:-20*t.x*_r},e),this.eyeTarget.position.lerp({x:.5*t.x,y:1,z:.25*-t.y},e);let s=this.headBoneLook;this.tmpQ.setFromEuler({_x:s.x,_y:s.y,_z:s.z,_order:"XYZ"},!1),this.bones.head.quaternion.multiply(this.tmpQ);let r=this.bones.ER,i=this.bones.EL,n={x:0,y:0,z:1};this.tmpMtx.lookAt(i.position,this.eyeTarget.position.clone().add({x:.03,y:0,z:-.074}),n),i.quaternion.setFromRotationMatrix(this.tmpMtx).multiply(this.q),this.tmpMtx.lookAt(r.position,this.eyeTarget.position.clone().add({x:-.03,y:0,z:-.074}),n),r.quaternion.setFromRotationMatrix(this.tmpMtx).multiply(this.q)}breathing(){if(!this.bones)return;if(!this.isBreath)return;if(!this.skeleton.setScalling)return;let e=.01*this.breath;this.breathSide>0?(this.skeleton.setScalling(this.bones.chest,this.lerp(1,1.02,e),this.lerp(1,1.04,e),1),this.skeleton.setScalling(this.bones.abdomen,1,this.lerp(1,.92,e),1)):(this.skeleton.setScalling(this.bones.chest,this.lerp(1.02,1,e),this.lerp(1.04,1,e),1),this.skeleton.setScalling(this.bones.abdomen,1,this.lerp(.92,1,e),1)),this.breath++,100===this.breath&&(this.breath=0,this.breathSide=this.breathSide>0?-1:1)}setPosition(e,t,s){this.position.set(e,t,s),this.updateMatrix()}setRotation(e,t,s,r){let i=this.lerp(this.rotation.y,t,r);this.rotation.set(e,i,s),this.updateMatrix()}lerp(e,t,s){return(1-s)*e+s*t}onReady(){}initMaterial(){if(wr.getMaterial(this.ref.materialRef))return;if(!this.fullMaterial)return void wr.set(this.ref.materialRef,new t.MeshStandardMaterial);let e,s,r;for(const i in this.ref.materials){r={...this.ref.materials[i]},s=r.type,delete r.type;for(const e in r)"envMapIntensity"!==e&&("map"!==e&&-1===e.search("Map")||(r[e]=wr.getTexture(r[e])));"Basic"===s?e=new t.MeshBasicMaterial(r):"Standard"===s?e=new t.MeshStandardMaterial(r):"Physical"===s&&(e=new t.MeshPhysicalMaterial(r)),e.name=i,wr.set(i,e)}this.setting=this.ref.setting}setMaterial(e){this.ref.changeMaterial(e)}getMaterial(e){return wr.getMaterial(e)}init(){this.initMaterial(),this.isClone||(this.root=wr.get(this.ref.forceModel?this.ref.forceModel:this.model,"O"),this.ref.applyMaterial(this.root,this.model)),this.ref.forceModel&&this.isClone&&this.ref.applyMaterial(this.root,this.model),this.root.traverse(function(e){e.isMesh&&(e.name===this.ref.skeletonRef&&(e.matrixAutoUpdate=!1,this.skeleton=e.skeleton,this.skeleton.resetScalling&&this.skeleton.resetScalling()),e.raycast=function(){},this.mesh[e.name]=e),e.isBone&&(this.bones[e.name]=e)}.bind(this)),this.ref.isEyeMove&&this.bones.neck.add(this.eyeTarget);for(let e in this.mesh)this.mesh[e].isSkinnedMesh&&e!==this.ref.skeletonRef&&(this.mesh[e].skeleton.dispose(),this.mesh[e].skeleton=this.skeleton);if(this.isClone||(this.haveMorph&&wr.applyMorph(this.model+"_morph",this.mesh,!0,!1),wr.set(this.model,this.root,"O")),1!==this.size&&this.root.scale.set(1,1,1).multiplyScalar(this.size),this.mixer=new t.AnimationMixer(this),0===wr.clip.length)this.compact?this.loadCompactAnimation(this.rootPath+"assets/animation/animations.bin"):this.loadAnimationJson(this.rootPath+"assets/animation/animations.json",this.start.bind(this));else{let e=wr.clip.length;for(;e--;)this.addAction(wr.clip[e]);this.start()}}addTensionMap(){this.tension1=new Mr(this.mesh.body),this.tension2=new Mr(this.mesh.Head)}setBounding(e){for(let t in this.mesh)this.mesh[t].isMesh&&(this.mesh[t].geometry.boundingSphere.radius=e)}eyeControl(e){this.setMorph("EyeBlink",e)}setMorph(e,t){this.haveMorph&&(this.morpher("eyelash",e,t),this.morpher("eyebrow",e,t),this.morpher("tear",e,t),this.morpher("mouth",e,t),this.morpher("body",e,t),this.morpher("Head",e,t),this.morpher("body_low",e,t))}morpher(e,t,s){this.mesh[e]&&this.mesh[e].morphTargetInfluences&&void 0!==this.mesh[e].morphTargetDictionary[t]&&(this.mesh[e].morphTargetInfluences[this.mesh[e].morphTargetDictionary[t]]=s)}lerp(e,t,s){return(1-s)*e+s*t}clone(e){return new this.constructor({type:e.type},this)}dispose(){this.exoskel&&this.addExo(),this.helper&&this.addHelper(),this.stop(),this.mixer.uncacheRoot(this),this.remove(this.root),this.skeleton.dispose(),this.parent.remove(this),this.isClone}start(){this.done||(this.done=!0,this.add(this.root),this.onReady(),this.playAll(),this.play(this.startAnimation),this.ref.adjustment&&this.makePoseTrack("adjustment",this.ref.adjustment()),setTimeout(this.callback,10))}addHelper(){this.helper?(this.helper.dispose(),this.remove(this.helper),this.helper=null):(this.helper=new t.SkeletonHelper(this.root),this.helper.raycast=function(){},this.helper.matrix=this.root.matrix,this.add(this.helper))}addExo(){return this.exoskel?(this.exoskel.dispose(),this.remove(this.exoskel),this.exoskel=null):(this.exoskel=new Ar(this.root,this.skeleton),this.exoskel.matrix=this.root.matrix,this.add(this.exoskel)),this.exoskel}attachToBone(e,t){e.matrix=t.matrixWorld,e.matrixAutoUpdate=!1}loadAnimationJson(e,t){const s=new XMLHttpRequest;s.open("GET",e,!0),s.onreadystatechange=function(){if(4===s.readyState&&(200===s.status||0===s.status)){let e=JSON.parse(s.responseText);this.urls=[];for(let t in e)"main"===t?this.urls.push(...e[t]):this.urls.push(...e[t].map((e=>t+"/"+e)));this.endCallback=t||function(){},this.loadOne()}}.bind(this),s.send()}loadOne(){let e=this.urls[0];this.loadAnimationFbx(this.rootPath+"assets/animation/fbx/"+e+".fbx",this.next.bind(this))}next(){this.urls.shift(),0===this.urls.length?this.endCallback():this.loadOne()}loadCompactAnimation(e="./assets/models/animations.bin"){this.lzma||(this.lzma=new xr(this.lzmaPath));var s=new XMLHttpRequest;s.open("GET",e,!0),s.responseType="arraybuffer";const r={animations:[]},i=this;s.onload=function(){i.lzma.decompress(new Uint8Array(s.response),(function(e){const s=JSON.parse(e);for(let e in s)r.animations.push(t.AnimationClip.parse(s[e]));i.applydAnimation(r),i.start()}))},s.send()}loadAnimationGlb(e,t){let s=e.substring(e.lastIndexOf("/")+1,e.lastIndexOf("."));wr.loaderGLTF().load(e,function(e){this.applydAnimation(e,s),t&&t()}.bind(this),null,t)}directGlb(e,t){wr.loaderGLTF().parse(e,"",function(e){this.stop(),this.applydAnimation(e,t)}.bind(this))}loadAnimationFbx(e,t){let s=e.substring(e.lastIndexOf("/")+1,e.lastIndexOf("."));wr.loaderFBX().load(e,function(e){this.convertFbx(s,e.animations[0]),t&&t()}.bind(this),null,t)}directFbx(e,t){try{let s=wr.loaderFBX().parse(e,"");this.convertFbx(t,s.animations[0],!0)}catch(e){console.error("bug",e)}}applydAnimation(e,t){let s=e.animations.length,r=!1;for(1===s&&(t&&(e.animations[0].name=t),r=!0);s--;)this.addClip(e.animations[s]),this.addAction(e.animations[s],r)}addClip(e,s=!1){s&&t.AnimationUtils.makeClipAdditive(e);let r=wr.clip.length,i=-1;for(;r--;)wr.clip[r].name===e.name&&(i=r);-1!==i&&wr.clip.slice(i,1),wr.clip.push(e)}addAction(e,t){const s=this.mixer.clipAction(e);s.frameMax=Math.round(30*e.duration),s.enabled=!0,s.setEffectiveWeight(0),"Jumping Up"===e.name&&(s.loop=LoopPingPong),this.actions.set(e.name,s),-1!==e.name.search("walk")&&this.clipsToesFix.push(e.name),-1!==e.name.search("run")&&this.clipsToesFix.push(e.name),-1!==e.name.search("strafe")&&this.clipsToesFix.push(e.name),-1!==e.name.search("jog")&&this.clipsToesFix.push(e.name),-1!==e.name.search("RUN")&&this.clipsToesFix.push(e.name),window.gui&&window.gui.getAnimation()}getAnimation(e=!1,t=!1){let s=[],r=0;if(t){let t=wr.clip.length;for(;t--;)s[r]=e?wr.clip[r].toJSON():wr.clip[r],r++}else this.actions.forEach((function(t,i){s[r]=e?t._clip.toJSON():t._clip,r++}));return s}exportAnimationLzma(e){this.lzma||(this.lzma=new xr(this.lzmaPath));const t=this.getAnimation(!0);this.lzma.compress(JSON.stringify(t),2,(function(t){if(e)e({name:"animations",data:new Uint8Array(t),type:"bin"});else{let e=document.createElement("a");e.style.display="none",document.body.appendChild(e),e.href=URL.createObjectURL(new Blob([new Uint8Array(t)],{type:"application/octet-stream"})),e.download="animations.bin",e.click()}}))}exportGLB(e){this.exporter||(this.exporter=new Pe);const t=this.getAnimation();this.exporter.parse(this.root,(function(t){if(e)e({name:"model",data:t,type:"glb"});else{let e=document.createElement("a");e.style.display="none",document.body.appendChild(e),e.href=URL.createObjectURL(new Blob([t],{type:"application/octet-stream"})),e.download="model.glb",e.click()}}),null,{animations:t,binary:!0,onlyVisible:!0})}armAngle(){}autoToes(){if(!this.fixToe)return;let e=this.getRot("rFoot"),t=this.getRot("lFoot"),s=this.getWorldPos("hip"),r=this.getWorldPos("rToes"),i=this.getWorldPos("lToes");e[0]>0&&r.z-s.z<0?this.setRot("rToes",1.5*-e[0],0,0):0!==e[0]&&this.setRot("rToes",0,0,0),t[0]>0&&i.z-s.z<0?this.setRot("lToes",1.5*-t[0],0,0):0!==t[0]&&this.setRot("lToes",0,0,0)}resetToes(){this.fixToe&&(this.fixToe=!1,this.setRot("rToes",0,0,0),this.setRot("lToes",0,0,0))}convertFbx(e,s,r){const i=Math.PI/180;let n=new t.Vector3,a=new t.Quaternion,o=(new t.Quaternion).setFromAxisAngle({x:1,y:0,z:0},90*i);const l=s.tracks,h=[];let c,u,p,d,m=l.length,f=0;for(;m--;){if(p=l[f],d=p.name.substring(0,p.name.lastIndexOf(".")),"hip.position"===p.name){let e=[];for(c=p.values.length/3;c--;)u=3*c,n.set(p.values[u],p.values[u+1],0).multiplyScalar(.01),n.toArray(e,u);h.push(new t.VectorKeyframeTrack(p.name,p.times,e))}else{let e=[];for(c=p.values.length/4;c--;)u=4*c,"hip"===d?a.set(p.values[u],p.values[u+1],p.values[u+2],p.values[u+3]).multiply(o):a.set(p.values[u],p.values[u+2],-p.values[u+1],p.values[u+3]),a.toArray(e,u);h.push(new t.QuaternionKeyframeTrack(p.name,p.times,e))}f++}let g=new t.AnimationClip(e,-1,h);g.duration=s.duration,this.stop(),this.addClip(g),this.addAction(g,r)}makePoseTrack(e,s){const r=Math.PI/180;let i=new t.Quaternion;const n=s,a=[];let o,l,h,c,u=n.length,p=0;for(;u--;){c=n[u];let e=[],s=[];for(p=0,o=3;o--;)l=0,h=4*p,s.push(.03333333507180214*p),i.setFromEuler({_x:c.values[0]*r,_y:c.values[1]*r,_z:c.values[2]*r,_order:"XYZ"}),i.toArray(e,h),p++;a.push(new t.QuaternionKeyframeTrack(c.name+".quaternion",s,e))}let d=new t.AnimationClip(e,-1,a);d.duration=.10000000521540642;const m=this.mixer.clipAction(d);m.enabled=!0,m.setEffectiveTimeScale(1),m.setEffectiveWeight(1),m.play()}prepareCrossFade(e,t,s){this.unPause(),e===idleAction?this.executeCrossFade(e,t,s):this.synchronize(e,t,s)}synchronize(e,t,s){this.mixer.addEventListener("loop",(function i(n){n.action===e&&(r.mixer.removeEventListener("loop",i),r.executeCrossFade(e,t,s))}));const r=this}executeCrossFade(e,t,s){this.setWeight(t,1),t.time=0,e.crossFadeTo(t,s,!0)}pause(){this.actions.forEach((function(e){e.paused=!0})),this.isPause=!0}unPause(){this.actions.forEach((function(e){e.paused=!1})),this.isPause=!1}playAll(){this.actions.forEach((function(e){e.play()}))}setTimescale(e){this.actions.forEach((function(t){t.setEffectiveTimeScale(e)}))}syncro(e){let t=this.getAction(e);if(!t)return;let s=t.time;this.actions.forEach((function(e){e.time=s}))}setWeight(e,t){"string"==typeof e&&(e=this.getAction(e)),e&&(e.enabled=!0,t<0&&(t=0),t>1&&(t=1),e.getEffectiveWeight(),e.setEffectiveWeight(t))}getAnimInfo(e){let t=this.getAction(e);if(t)return{name:e,time:t.time,frame:Math.round(30*t.time),frameMax:t.frameMax,timeScale:t.timeScale}}getAction(e){return this.actions.get(e)}play(e,t=.5){let s=this.getAction(e);return!!s&&(this.current?this.current!==s&&(this.old=this.current,this.current=s,s.play(),-1!==this.clipsToesFix.indexOf(e)?this.fixToe=!0:this.resetToes(),this.executeCrossFade(this.old,this.current,t)):(this.stop(),this.current=s,s.setEffectiveWeight(1)),this.isPause=!1,!0)}playFrame(e,t,s=1){let r=this.getAction(e);r&&(r.time=t*Ir,r.setEffectiveWeight(s),r.play(),r.paused=!0,this.isPause=!0)}playOne(e,t=1){this.current&&(this.current.time=e*Ir,this.current.setEffectiveWeight(t),this.current.play(),this.current.paused=!0,this.isPause=!0)}stop(){this.actions.forEach((function(e){e.setEffectiveWeight(0)}))}setRot(e,t,s,r){let i=this.bones[e];i&&(i.rotation.set(t*_r,s*_r,r*_r,"XYZ"),i.updateMatrix())}setRot2(e,s,r,i){let n=this.bones[e];if(!n)return;let a=(new t.Quaternion).setFromEuler({_x:s*Lr,_y:r*Lr,_z:i*Lr,_order:"XYZ"}).invert();n.quaternion.premultiply(a),n.updateMatrix()}getRot(e){let t=this.bones[e];if(!t)return;let s=t.rotation.toArray();return[Math.round(s[0]*Lr),Math.round(s[1]*Lr),Math.round(s[2]*Lr)]}getWorldPos(e){let t=this.bones[e];if(t)return Cr.set(0,0,0),t.localToWorld(Cr),{x:Cr.x,y:Cr.y,z:Cr.z}}bodyMask(e={arm:!0,leg:!0,foot:!0,chest:!0}){let s=.25;this.canvas||(this.canvas=document.createElement("canvas"),this.canvas.width=this.canvas.height=256);const r=this.canvas.getContext("2d");r.fillStyle="#FFFFFF",r.fillRect(0,0,256,256),r.fillStyle="black",e.arm&&r.fillRect(196,112,59,46.5),e.leg&&r.fillRect(128,183.5,71.75,72.5),e.foot&&r.fillRect(817*s,205.5,51.5,50),e.chest&&(r.fillRect(120,144,75,40),r.fillRect(553*s,116.5,57,27.5),r.fillRect(533*s,531*s,5,45*s));let i=new Image;i.src=this.canvas.toDataURL(),this.mask&&this.mask.dispose(),this.mask=new t.Texture(i),this.mask.flipY=!1,this.mask.needsUpdate=!0;const n=wr.getMaterial("skin");n.alphaTest=.9,n.alphaMap=this.mask}zeroColor(e){e.isMesh&&(e=e.geometry);let s=e.attributes.position.array.length;e.setAttribute("color",new t.Float32BufferAttribute(new Array(s).fill(0),3))}}class Br extends t.Object3D{constructor(e,s,r,i){super(),this.matrixAutoUpdate=!1,this.type="SpotLightHelper";const n=new t.BufferGeometry;let a=.5*s-e,o=32,l=.2*e;const h=[e,a,0,e,-a,0,-e,a,0,-e,-a,0,0,a,e-l,0,a,e+l];for(let t=0,s=1;t<o;t++,s++){const r=t/o*Math.PI*2,i=s/o*Math.PI*2;h.push(e*Math.cos(r),a,e*Math.sin(r),e*Math.cos(i),a,e*Math.sin(i),e*Math.cos(r),-a,e*Math.sin(r),e*Math.cos(i),-a,e*Math.sin(i))}for(let t=0,s=1;t<o;t++,s++){const r=t/o*Math.PI*2,i=s/o*Math.PI*2;let n=s<=16?1:-1;h.push(e*Math.cos(r),a*n+e*Math.sin(r),0,e*Math.cos(i),a*n+e*Math.sin(i),0)}let c=[],u=h.length/3;for(;u--;)c.push(0,1,0);if(n.setAttribute("position",new t.Float32BufferAttribute(h,3)),n.setAttribute("color",new t.Float32BufferAttribute(c,3)),this.cone=new t.LineSegments(n,i),this.cone.raycast=function(){},this.add(this.cone),!r)return;const p=new t.BufferGeometry,d=[.5*l,-a,e-l,.5*l,-a,e+l,.5*-l,-a,e-l,.5*-l,-a,e+l,.5*l,-a,e-l,.5*-l,-a,e-l,.5*-l,-a,e+l,-l,-a,e+l,.5*l,-a,e+l,l,-a,e+l,-l,-a,e+l,0,-a,e+2*l,l,-a,e+l,0,-a,e+2*l];for(c=[],u=d.length/3;u--;)c.push(1,0,0);p.setAttribute("position",new t.Float32BufferAttribute(d,3)),p.setAttribute("color",new t.Float32BufferAttribute(c,3)),this.direction=new t.LineSegments(p,i),this.direction.raycast=function(){},this.add(this.direction)}setDirection(e){this.direction&&(this.direction.rotation.y=e)}dispose(){this.cone.geometry.dispose(),this.direction&&this.direction.geometry.dispose()}raycast(){}update(){}}const Or=new t.Matrix4,zr=new t.Vector3,Dr=new t.Quaternion,Nr=new t.Vector3;class Ur extends t.Object3D{constructor(e){super(),this.prefix=e.name||"yoo_",this.mode="follow",this.withFinger=!1,this.nodes=[],this.bones=e.model.skeleton.bones,this.model=e.model.root,this.posRef={},this.quatRef={},this.useSolver=!1,"PHYSX"!==b.engine&&(this.useSolver=!1),this.nameList=[],this.jointList=[],this.breast=!1,this.ready=!1,this.init()}setMode(e){if(e===this.mode)return;this.mode=e;const t=[];let s,r="follow"===this.mode,i=this.nodes.length;for(;i--;)s=this.nodes[i],t.push({name:s.name,kinematic:r}),s.kinematic=r,s.bone.isPhysics=!r;b.motor.change(t)}freeBone(e){e.kinematic&&(e.cc++,20===e.cc&&(e.cc=0,e.kinematic=!1,e.bone.isPhysics=!0,b.motor.change({name:e.name,kinematic:!1})))}isVisible(e){let t=this.nameList.length;for(;t--;)x.byName(this.nameList[t]).visible=e;let s=[];for(t=this.jointList.length;t--;)s.push({name:this.jointList[t],visible:e});b.motor.change(s)}init(){this.useSolver&&(this.solver=b.motor.add({type:"solver",name:this.prefix+"_solver",iteration:32,fix:!0,needData:!0}));const e=[];let s,r,n,a,o,h,c,u,p,d,m,f,g,y=new t.Vector3,x=new t.Vector3,v=new t.Quaternion,w=new t.Euler,M=new t.Matrix4,A=new t.Matrix4,T=new t.Matrix4,S=new t.Vector3,k=new t.Vector3,R=this.bones.length;for(s=0;s<R;s++)if(p=null,a=this.bones[s],r=a.name,o=a.parent,o&&(n=o.name,S.setFromMatrixPosition(o.matrixWorld),k.setFromMatrixPosition(a.matrixWorld),c=S.distanceTo(k),m=[0,0,.5*c],h=[c,1,1],u=null,d=!0,g=!1,"hip"===n&&"abdomen"===r&&(p="capsule",h=[1.8*c,.08],m=[0,0,.5*-c],u=[0,0,90]),"abdomen"===n&&"chest"===r&&(p="capsule",h=[.7*c,.08],m=[0,0,.5*-c-.06],u=[90,0,0]),"chest"===n&&"neck"===r&&(p="capsule",h=[.4*c,.04],m=[0,0,.5*-c-.02],u=[0,0,90]),"neck"===n&&"head"===r&&(p="capsule",h=[.06,c],m=[0,0,.5*-c],u=[90,0,0]),"head"===n&&"End_head"===r&&(p="capsule",h=[.1,c-.17],m=[0,.02,.5*-c+.02],u=[90,0,0]),"chest"===n&&"rBreast"===r&&"HAVOK"!==b.engine&&(n="rBreast",o=a,p="sphere",h=[.065],m=[.065,0,0],this.breast=!0,g=!0),"chest"===n&&"lBreast"===r&&"HAVOK"!==b.engine&&(n="lBreast",o=a,p="sphere",h=[.065],m=[.065,0,0],this.breast=!0,g=!0),"lCollar"===n&&"lShldr"===r&&(p="capsule",h=[.05,.3*c],m=[.6*c,0,0],u=[0,0,90]),"lShldr"===n&&"lForeArm"===r&&(p="capsule",h=[.05,c],m=[.5*c,0,0],u=[0,0,90]),"lForeArm"===n&&"lHand"===r&&(p="capsule",h=[.04,c],m=[.5*c,0,0],u=[0,0,90]),"lHand"===n&&"lMid1"===r&&(p="box",h=[2*c,.09,.05],m=[c,0,0]),"rCollar"===n&&"rShldr"===r&&(p="capsule",h=[.05,.3*c],m=[.6*-c,0,0],u=[0,0,90]),"rShldr"===n&&"rForeArm"===r&&(p="capsule",h=[.05,c],m=[.5*-c,0,0],u=[0,0,90]),"rForeArm"===n&&"rHand"===r&&(p="capsule",h=[.04,c],m=[.5*-c,0,0],u=[0,0,90]),"rHand"===n&&"rMid1"===r&&(p="box",h=[2*c,.09,.05],m=[-c,0,0]),"lThigh"===n&&(p="capsule",h=[.08,c],u=[90,0,0]),"lShin"===n&&(p="capsule",h=[.065,c],u=[90,0,0]),"lFoot"===n&&(p="capsule",h=[.05,c],m=[0,.5*c-.025,.04]),"rThigh"===n&&(p="capsule",h=[.08,c],u=[90,0,0]),"rShin"===n&&(p="capsule",h=[.065,c],u=[90,0,0]),"rFoot"===n&&(p="capsule",h=[.05,c],m=[0,.5*c-.025,.04]),this.withFinger&&("lHand"===n&&"lMid1"===r&&(p="box",h=[c,.09,.05],m=[.5*c,0,0]),"rHand"===n&&"rMid1"===r&&(p="box",h=[c,.09,.05],m=[.5*-c,0,0]),"rThumb1"===n&&"rThumb2"===r&&(p="capsule",h=[.02,c],u=[0,0,90]),"rThumb2"===n&&"rThumb3"===r&&(p="capsule",h=[.02,c],u=[0,0,90]),"rHand"===n&&"rMid1"===r&&(p="capsule",h=[.02,c],u=[0,0,90],m=[.6*-c,0,0]),"rMid1"===n&&"rMid2"===r&&(p="capsule",h=[.02,c],u=[0,0,90],m=[.6*-c,0,0]),"rMid2"===n&&"rMid3"===r&&(p="capsule",h=[.02,c],u=[0,0,90],m=[.6*-c,0,0])),null!==p)){f=this.prefix+"_bone_"+n,A.makeTranslation(m[0],m[1],m[2]),u&&(T.makeRotationFromEuler(w.set(u[0]*i,u[1]*i,u[2]*i)),A.multiply(T)),M.copy(o.matrixWorld),M.decompose(y,v,x),this.posRef[f]=y.toArray(),"lForeArm"!==n&&"rForeArm"!==n||(Dr.setFromAxisAngle({x:0,y:1,z:0},-90*i),v.multiply(Dr)),this.quatRef[f]=v.toArray(),M.multiplyMatrices(o.matrixWorld,A),M.decompose(y,v,x);let t={name:f,density:1,type:p,size:l.scaleArray(h,1,3),pos:y.toArray(),quat:v.toArray(),kinematic:true,friction:.5,restitution:.1,group:1,mask:3,material:"bones2",shadow:!1,neverSleep:!0};e.push(t),this.nameList.push(f),this.nodes.push({name:f,kinematic:true,motion:g,bone:o,decal:A.clone(),decalinv:A.clone().invert(),quat:v.toArray(),pos:y.toArray(),cc:0})}b.motor.add(e),this.addLink(),this.ready=!0}addLink(){let e=[.05,1,0];"PHYSX"===b.engine&&(e=[50,10,0,.5]);let t=this.prefix+"_bone_",s=[],r={type:"joint",mode:"d6",visible:!1,lm:[["ry",-180,180,...e],["rz",-180,180,...e]],collision:!1,helperSize:.05,autoDrive:!0},i=[-.001,.001,100,.2,.5];s.push({...r,b1:t+"hip",b2:t+"abdomen",worldPos:this.posRef[t+"abdomen"],worldQuat:this.quatRef[t+"hip"],lm:[["rx",-20,20,...e],["ry",-20,20,...e],["rz",-20,20,...e]]}),s.push({...r,b1:t+"abdomen",b2:t+"chest",worldPos:this.posRef[t+"chest"],worldQuat:this.quatRef[t+"chest"],lm:[["rx",-20,20,...e],["ry",-20,20,...e],["rz",-20,20,...e]]}),s.push({...r,b1:t+"chest",b2:t+"neck",worldPos:this.posRef[t+"neck"],worldQuat:this.quatRef[t+"neck"],lm:[["rx",-60,60,...e],["ry",-1,1,...e],["rz",-30,30,...e]]}),s.push({...r,b1:t+"neck",b2:t+"head",worldPos:this.posRef[t+"head"],worldQuat:this.quatRef[t+"head"],lm:[["rx",-60,60,...e],["ry",-1,1,...e],["rz",-30,30,...e]]}),s.push({...r,b1:t+"chest",b2:t+"rCollar",worldPos:this.posRef[t+"rCollar"],worldQuat:this.quatRef[t+"rCollar"],lm:[["rx",-10,10,...e],["ry",-10,10,...e],["rz",-10,10,...e]]}),s.push({...r,b1:t+"chest",b2:t+"lCollar",worldPos:this.posRef[t+"lCollar"],worldQuat:this.quatRef[t+"lCollar"],lm:[["rx",-10,10,...e],["ry",-10,10,...e],["rz",-10,10,...e]]}),s.push({...r,b1:t+"rCollar",b2:t+"rShldr",worldPos:this.posRef[t+"rShldr"],worldQuat:this.quatRef[t+"rShldr"]}),s.push({...r,b1:t+"lCollar",b2:t+"lShldr",worldPos:this.posRef[t+"lShldr"],worldQuat:this.quatRef[t+"lShldr"]}),s.push({...r,b1:t+"rShldr",b2:t+"rForeArm",worldPos:this.posRef[t+"rForeArm"],worldQuat:this.quatRef[t+"rForeArm"],lm:[["rx",0,160,...e]]}),s.push({...r,b1:t+"lShldr",b2:t+"lForeArm",worldPos:this.posRef[t+"lForeArm"],worldQuat:this.quatRef[t+"lForeArm"],lm:[["rx",0,160,...e]]}),s.push({...r,b1:t+"rForeArm",b2:t+"rHand",worldPos:this.posRef[t+"rHand"],worldQuat:this.quatRef[t+"rHand"],lm:[["rx",0,160,...e],["ry",-10,10,...e]]}),s.push({...r,b1:t+"lForeArm",b2:t+"lHand",worldPos:this.posRef[t+"lHand"],worldQuat:this.quatRef[t+"lHand"],lm:[["rx",0,160,...e],["ry",-10,10,...e]]}),s.push({...r,b1:t+"hip",b2:t+"rThigh",worldPos:this.posRef[t+"rThigh"],worldQuat:this.quatRef[t+"rThigh"]}),s.push({...r,b1:t+"hip",b2:t+"lThigh",worldPos:this.posRef[t+"lThigh"],worldQuat:this.quatRef[t+"lThigh"]}),s.push({...r,b1:t+"rThigh",b2:t+"rShin",worldPos:this.posRef[t+"rShin"],lm:[["rx",0,160,...e]],worldQuat:this.quatRef[t+"rShin"]}),s.push({...r,b1:t+"lThigh",b2:t+"lShin",worldPos:this.posRef[t+"lShin"],lm:[["rx",0,160,...e]],worldQuat:this.quatRef[t+"lShin"]}),s.push({...r,b1:t+"rShin",b2:t+"rFoot",worldPos:this.posRef[t+"rFoot"],lm:[["rx",-10,30,...e],["rz",-10,10,...e]],worldQuat:this.quatRef[t+"rFoot"]}),s.push({...r,b1:t+"lShin",b2:t+"lFoot",worldPos:this.posRef[t+"lFoot"],lm:[["rx",-10,30,...e],["rz",-10,10,...e]],worldQuat:this.quatRef[t+"lFoot"]}),this.breast&&(s.push({...r,b1:t+"chest",b2:t+"rBreast",worldPos:this.posRef[t+"rBreast"],worldQuat:this.quatRef[t+"rBreast"],lm:[["x",...i],["y",...i],["z",...i]]}),s.push({...r,b1:t+"chest",b2:t+"lBreast",worldPos:this.posRef[t+"lBreast"],worldQuat:this.quatRef[t+"lBreast"],lm:[["x",...i],["y",...i],["z",...i]]}));let n=0;for(let e in s)s[e].name=this.prefix+"_joint_"+n,this.nameList.push(s[e].name),this.jointList.push(s[e].name),n++;b.motor.add(s)}updateMatrixWorld(e){if(!this.ready)return;let t=[];const s=this.nodes;let r,i,n,a=s.length;for(;a--;)r=s[a],i=r.bone,r.kinematic?(Or.multiplyMatrices(i.matrixWorld,r.decal),Or.decompose(zr,Dr,Nr),r.pos=zr.toArray(),r.quat=Dr.toArray(),t.push({name:r.name,pos:r.pos,quat:r.quat}),r.motion&&this.freeBone(r)):(n=x.byName(r.name),n&&(Or.copy(n.matrixWorld).multiply(r.decalinv),i.phyMtx.copy(Or),i.isPhysics=!0));0!==t.length&&b.motor.change(t,!0)}dispose(){b.motor.remove(this.nameList),this.nodes=[],this.posRef={},this.quatRef={},this.parent.remove(this),this.nameList=[],this.jointList=[]}}class Vr extends F{constructor(){super(),this.Utils=x,this.type="character",this.num=g[this.type]}step(e,t){let s,r,i=this.list.length;for(;i--;)r=this.list[i],s=t+i*this.num,r.step(e,s)}add(e={}){this.setName(e);return new jr(e)}set(e={},t=null){null===t&&(t=this.byName(e.name)),null!==t&&t.set(e)}}class jr extends Z{constructor(e={}){super(),this.type="character",this.name=e.name||"hero",e.name=this.name,this.isRay=!1,this.ray=null,this.model=null,this.static=!1,this.radius=e.radius||.3,this.height=e.height||1.8,e.radius&&delete e.radius,this.fall=!1,this.floor=!0,this.distance=0,this.rayAngle=0,this.rayStart=-.5*this.height+this.radius,this.rayEnd=this.rayStart-this.height,this.maxRayDistance=this.height,this.contact=!1,this.tmpV1=new t.Vector3,this.tmpV2=new t.Vector3,this.ease=new t.Vector3,this.tmpAcc=0,this.rs=0,this.ts=0,this.diagonal=1/Math.sqrt(2),this.jump=!1,this.crouch=!1,this.toggle=!0,this.oy=0,this.vy=0,this.angle=(e.angle||0)*i,this.speed={idle:1,fight:1,walk:7.8,crouch:7,run:12},this.valheimStyle=!0,this.globalRay=e.ray||!1,this.callback=e.callback||function(){},e.callback&&delete e.callback,this.init(e)}init(e){e.size||(e.size=[this.radius,this.height-2*this.radius]),e.pos||(e.pos=[0,.5*this.height,0]),this.py=.5*-this.height,this.globalRay&&b.items.body.geometry({...e,type:"capsule",ray:!0},this,L.get("hide")),e.density=e.density||1,e.friction=.5,e.angularFactor=[0,0,0],e.group=16,e.regular=!0,e.filter=[1,-1,[1,3,4,5,9],0],e.inertia=[0,0,0],e.noGravity=!0,e.volume=l.getVolume("capsule",e.size),b.items.character.addToWorld(this,e.id),b.post({m:"add",o:e}),this.ray=b.motor.add({type:"ray",name:this.name+"_ray",begin:[0,this.rayStart,0],end:[0,this.rayEnd,0],callback:this.selfRay.bind(this),visible:!1,parent:this.name}),e.gender?this.addModel(e):this.showHelper(!0)}selfRay(e){e.hit?(this.distance=l.toFixed(e.distance-this.radius),this.rayAngle=e.angle):(this.distance=this.maxRayDistance,this.rayAngle=0)}hit(e){this.contact=e}showHelper(e){e?this.helper||(this.helper=new Br(this.radius,this.height,!0,L.get("line")),this.add(this.helper)):this.helper&&(this.remove(this.helper),this.helper.dispose(),this.helper=null),this.ray&&(this.ray.visible=e)}addSkeleton(){this.skeletonBody||(this.skeletonBody=new Ur(this),b.scene.add(this.skeletonBody),this.skeletonBody.isVisible(!1))}debugMode(e){this.skeletonBody&&this.skeletonBody.isVisible(e),this.model&&this.model.setMaterial({wireframe:e}),this.showHelper(e)}setMode(e){this.skeletonBody&&this.skeletonBody.setMode(e)}addModel(e){this.model=new Fr({type:e.gender,anim:void 0!==e.anim?e.anim:"idle",compact:!0,material:!e.noMat,morph:e.morph||!1,callback:this.callback}),this.add(this.model),this.model.setPosition(0,this.py+this.model.decalY,0),this.model.rotation.y=this.angle,this.model.updateMatrix()}raycast(){}step(e,t){this.position.fromArray(e,t+1),this.quaternion.fromArray(e,t+4),this.fall=this.position.y<this.oy,this.floor=l.nearEquals(this.position.y,this.oy,.1),this.oy=this.position.y,this.updateMatrix(),this.model&&this.model.update(b.delta)}set(e){e.morph&&this.model&&this.model.setMorph(e.morph,e.value)}dispose(){this.callback=null,this.skeletonBody&&this.skeletonBody.dispose(),this.model&&this.model.dispose(),this.helper&&this.showHelper(),console.log("model remove"),super.dispose()}move(){const e=b.motor.getKey(),t=b.motor.getAzimut(),s=b.delta;let r=0!==e[7]?"run":"walk";0===e[0]&&0===e[1]&&(r="idle");let i=0!==e[0]&&0!==e[1]?this.diagonal:1;e[5]&&this.toggle&&(this.crouch=!this.crouch,this.toggle=!1),0===e[5]&&(this.toggle=!0),"walk"!==r&&"run"!==r||!this.crouch||(r="crouch"),1===e[6]&&(r="fight"),!this.jump&&e[4]&&(this.vy=22,this.jump=!0),this.jump&&(this.vy-=1,this.vy<=0&&(this.vy=0,this.floor&&(this.jump=!1)));let n="idle";switch(r){case"idle":n=this.crouch?"Crouch Idle":"idle";break;case"walk":n="Jog Forward";break;case"run":n="Standard Run";break;case"crouch":n="Crouch Walk";break;case"fight":n="Attack"}let a=1*this.speed[r];0===e[0]&&0===e[1]||(this.tmpAcc+=4*s,this.rs=e[0]*a,this.ts=e[1]*a),0===e[0]&&0===e[1]&&(this.tmpAcc=0),this.tmpAcc>1&&(this.tmpAcc=1),this.ease.set(this.rs,0,this.ts).multiplyScalar(this.tmpAcc*i);let o=l.unwrapRad(Math.atan2(this.ease.x,this.ease.z)+t);this.ease.length(),this.static&&(this.ease.x=this.ease.z=0);let h=this.vy-9.81;if(this.ease.y=h,this.tmpV1.copy(this.ease).applyAxisAngle({x:0,y:1,z:0},t),this.tmpV2.set(0,0,0),b.motor.change({name:this.name,linearVelocity:this.tmpV1.toArray(),wake:!0}),this.helper&&(this.helper.cone.rotation.y=t,"idle"!==r&&this.helper.setDirection(o)),this.model&&(this.jump?(this.model.play("Jump",0),this.model.setTimescale(1)):(this.model.play(n,.25),this.model.setTimescale(1)),"idle"!==r)){let e=l.unwrapRad(this.model.rotation.y),s=l.nearAngle(o,e);this.model.rotation.y="fight"===r?t+Math.PI:l.lerp(e,s,.1),this.model.updateMatrix(),this.model.setTimescale(1*this.tmpAcc)}}}const Gr={torad:Math.PI/180,todeg:180/Math.PI,Pi:Math.PI,TwoPI:2*Math.PI,PI90:.5*Math.PI,PI45:.25*Math.PI,PI270:.5*Math.PI*3,inv255:.003921569,golden:1.618033,epsilon:Math.pow(2,-52),randomSign:()=>Math.random()<.5?-1:1,randSpread:e=>e*(.5-Math.random()),rand:(e=0,t=1)=>e+Math.random()*(t-e),randInt:(e,t)=>e+Math.floor(Math.random()*(t-e+1)),toFixed:(e,t=3)=>1*e.toFixed(t),int:e=>Math.floor(e),lerp:(e,t,s)=>(1-s)*e+s*t,clamp:(e,t,s)=>Math.max(t,Math.min(s,e)),nearEquals:(e,t,s)=>Math.abs(e-t)<=s,lerpAr:(e,t,s,r)=>{let i=e.length;for(;i--;)e[i]=Gr.lerp(t[i],s[i],r)},unwrapDeg:e=>e-360*Math.floor((e+180)/360),unwrapRad:e=>Math.atan2(Math.sin(e),Math.cos(e)),scaleArray:(e,t)=>{for(var s=e.length;s--;)e[s]*=t;return e},addArray:(e,t)=>{for(var s=[],r=e.length;r--;)s[r]=e[r]+t[r];return s},angleDistance:(e,t)=>{var s=(e-t+180)%360-180;return s<-180?s+360:s},tmpE:new t.Euler,tmpM:new t.Matrix4,tmpM2:new t.Matrix4,tmpV:new t.Vector3,tmpQ:new t.Quaternion,fromTransformToQ:(e,t,s)=>(s=s||!1,Gr.tmpM.compose(Gr.tmpV.fromArray(e),Gr.tmpQ.fromArray(t),{x:1,y:1,z:1}),Gr.tmpM.decompose(Gr.tmpV,Gr.tmpQ,{x:1,y:1,z:1}),s&&Gr.tmpQ.invert(),Gr.tmpQ.toArray()),fromTransform:(e,t,s,r,i)=>(i=i||!1,r=r||[0,0,0,1],Gr.tmpM.compose(Gr.tmpV.fromArray(e),Gr.tmpQ.fromArray(t),{x:1,y:1,z:1}),Gr.tmpM2.compose(Gr.tmpV.fromArray(s),Gr.tmpQ.fromArray(r),{x:1,y:1,z:1}),i?(Gr.tmpM.invert(),Gr.tmpM.multiply(Gr.tmpM2)):Gr.tmpM.multiply(Gr.tmpM2),Gr.tmpM.decompose(Gr.tmpV,Gr.tmpQ,{x:1,y:1,z:1}),Gr.tmpV.toArray()),arCopy:(e,t)=>{},axisToQuatArray:(e,t)=>(t=t||!1,Gr.tmpQ.setFromAxisAngle(Gr.tmpV.fromArray(e,1),t?e[0]*Gr.torad:e[0]).normalize().toArray()),toQuatArray:e=>Gr.tmpQ.setFromEuler(Gr.tmpE.fromArray(Gr.vectorad(e))).toArray(),vectorad:e=>{let t=3,s=[];for(;t--;)s[t]=e[t]*Gr.torad;return s[3]=e[3],s},rgbToHex:e=>"0x"+("000000"+(255*e[0]<<16^255*e[1]<<8^255*e[2]<<0).toString(16)).slice(-6),hexToRgb:e=>[((e=Math.floor(e))>>16&255)/255,(e>>8&255)/255,(255&e)/255],htmlToHex:e=>e.toUpperCase().replace("#","0x"),hexToHtml:e=>"#"+("000000"+(e=void 0===e?0:e).toString(16)).substr(-6),rgbToHtml:e=>"#"+("000000"+(255*e[0]<<16^255*e[1]<<8^255*e[2]<<0).toString(16)).slice(-6),perlin:null,resetPerlin:()=>{null!==Gr.perlin&&(Gr.perlin=null)},noise:(e,t)=>{null===Gr.perlin&&(Gr.perlin=new Hr);let s,r,i=(t=t||{}).level||[1,.2,.05],n=t.frequency||[.016,.05,.2],a=0,o=0;for(s=0;s<i.length;s++)r=n[s],a+=i[s]*(.5+.5*Gr.perlin.noise3d(e.x*r,e.y*r,e.z*r)),o+=i[s];return a/=o,a}};class Hr{constructor(e){null==e&&(e=Math),this.grad3=[[1,1,0],[-1,1,0],[1,-1,0],[-1,-1,0],[1,0,1],[-1,0,1],[1,0,-1],[-1,0,-1],[0,1,1],[0,-1,1],[0,1,-1],[0,-1,-1]],this.grad4=[[0,1,1,1],[0,1,1,-1],[0,1,-1,1],[0,1,-1,-1],[0,-1,1,1],[0,-1,1,-1],[0,-1,-1,1],[0,-1,-1,-1],[1,0,1,1],[1,0,1,-1],[1,0,-1,1],[1,0,-1,-1],[-1,0,1,1],[-1,0,1,-1],[-1,0,-1,1],[-1,0,-1,-1],[1,1,0,1],[1,1,0,-1],[1,-1,0,1],[1,-1,0,-1],[-1,1,0,1],[-1,1,0,-1],[-1,-1,0,1],[-1,-1,0,-1],[1,1,1,0],[1,1,-1,0],[1,-1,1,0],[1,-1,-1,0],[-1,1,1,0],[-1,1,-1,0],[-1,-1,1,0],[-1,-1,-1,0]],this.p=[];for(var t=0;t<256;t++)this.p[t]=Math.floor(256*e.random());this.perm=[];for(t=0;t<512;t++)this.perm[t]=this.p[255&t];this.simplex=[[0,1,2,3],[0,1,3,2],[0,0,0,0],[0,2,3,1],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,2,3,0],[0,2,1,3],[0,0,0,0],[0,3,1,2],[0,3,2,1],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,3,2,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,2,0,3],[0,0,0,0],[1,3,0,2],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,3,0,1],[2,3,1,0],[1,0,2,3],[1,0,3,2],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,0,3,1],[0,0,0,0],[2,1,3,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,0,1,3],[0,0,0,0],[0,0,0,0],[0,0,0,0],[3,0,1,2],[3,0,2,1],[0,0,0,0],[3,1,2,0],[2,1,0,3],[0,0,0,0],[0,0,0,0],[0,0,0,0],[3,1,0,2],[0,0,0,0],[3,2,0,1],[3,2,1,0]]}dot(e,t,s){return e[0]*t+e[1]*s}dot3(e,t,s,r){return e[0]*t+e[1]*s+e[2]*r}dot4(e,t,s,r,i){return e[0]*t+e[1]*s+e[2]*r+e[3]*i}noise(e,t){var s,r,i=(e+t)*(.5*(Math.sqrt(3)-1)),n=Math.floor(e+i),a=Math.floor(t+i),o=(3-Math.sqrt(3))/6,l=(n+a)*o,h=e-(n-l),c=t-(a-l);h>c?(s=1,r=0):(s=0,r=1);var u=h-s+o,p=c-r+o,d=h-1+2*o,m=c-1+2*o,f=255&n,g=255&a,y=this.perm[f+this.perm[g]]%12,b=this.perm[f+s+this.perm[g+r]]%12,x=this.perm[f+1+this.perm[g+1]]%12,v=.5-h*h-c*c,w=.5-u*u-p*p,M=.5-d*d-m*m;return 70*((v<0?0:(v*=v)*v*this.dot(this.grad3[y],h,c))+(w<0?0:(w*=w)*w*this.dot(this.grad3[b],u,p))+(M<0?0:(M*=M)*M*this.dot(this.grad3[x],d,m)))}noise3d(e,t,s){var r,i,n,a,o,l,h=(e+t+s)*(1/3),c=Math.floor(e+h),u=Math.floor(t+h),p=Math.floor(s+h),d=1/6,m=(c+u+p)*d,f=e-(c-m),g=t-(u-m),y=s-(p-m);f>=g?g>=y?(r=1,i=0,n=0,a=1,o=1,l=0):f>=y?(r=1,i=0,n=0,a=1,o=0,l=1):(r=0,i=0,n=1,a=1,o=0,l=1):g<y?(r=0,i=0,n=1,a=0,o=1,l=1):f<y?(r=0,i=1,n=0,a=0,o=1,l=1):(r=0,i=1,n=0,a=1,o=1,l=0);var b=f-r+d,x=g-i+d,v=y-n+d,w=f-a+2*d,M=g-o+2*d,A=y-l+2*d,T=f-1+.5,S=g-1+.5,k=y-1+.5,R=255&c,E=255&u,P=255&p,I=this.perm[R+this.perm[E+this.perm[P]]]%12,_=this.perm[R+r+this.perm[E+i+this.perm[P+n]]]%12,L=this.perm[R+a+this.perm[E+o+this.perm[P+l]]]%12,C=this.perm[R+1+this.perm[E+1+this.perm[P+1]]]%12,F=.6-f*f-g*g-y*y,B=.6-b*b-x*x-v*v,O=.6-w*w-M*M-A*A,z=.6-T*T-S*S-k*k;return 32*((F<0?0:(F*=F)*F*this.dot3(this.grad3[I],f,g,y))+(B<0?0:(B*=B)*B*this.dot3(this.grad3[_],b,x,v))+(O<0?0:(O*=O)*O*this.dot3(this.grad3[L],w,M,A))+(z<0?0:(z*=z)*z*this.dot3(this.grad3[C],T,S,k)))}noise4d(e,t,s,r){var i,n,a,o,l,h,c,u,p,d,m,f,g=this.grad4,y=this.simplex,b=this.perm,x=(Math.sqrt(5)-1)/4,v=(5-Math.sqrt(5))/20,w=(e+t+s+r)*x,M=Math.floor(e+w),A=Math.floor(t+w),T=Math.floor(s+w),S=Math.floor(r+w),k=(M+A+T+S)*v,R=e-(M-k),E=t-(A-k),P=s-(T-k),I=r-(S-k),_=(R>E?32:0)+(R>P?16:0)+(E>P?8:0)+(R>I?4:0)+(E>I?2:0)+(P>I?1:0),L=R-(i=y[_][0]>=3?1:0)+v,C=E-(n=y[_][1]>=3?1:0)+v,F=P-(a=y[_][2]>=3?1:0)+v,B=I-(o=y[_][3]>=3?1:0)+v,O=R-(l=y[_][0]>=2?1:0)+2*v,z=E-(h=y[_][1]>=2?1:0)+2*v,D=P-(c=y[_][2]>=2?1:0)+2*v,N=I-(u=y[_][3]>=2?1:0)+2*v,U=R-(p=y[_][0]>=1?1:0)+3*v,V=E-(d=y[_][1]>=1?1:0)+3*v,j=P-(m=y[_][2]>=1?1:0)+3*v,G=I-(f=y[_][3]>=1?1:0)+3*v,H=R-1+4*v,W=E-1+4*v,q=P-1+4*v,X=I-1+4*v,K=255&M,Q=255&A,Z=255&T,Y=255&S,J=b[K+b[Q+b[Z+b[Y]]]]%32,$=b[K+i+b[Q+n+b[Z+a+b[Y+o]]]]%32,ee=b[K+l+b[Q+h+b[Z+c+b[Y+u]]]]%32,te=b[K+p+b[Q+d+b[Z+m+b[Y+f]]]]%32,se=b[K+1+b[Q+1+b[Z+1+b[Y+1]]]]%32,re=.6-R*R-E*E-P*P-I*I,ie=.6-L*L-C*C-F*F-B*B,ne=.6-O*O-z*z-D*D-N*N,ae=.6-U*U-V*V-j*j-G*G,oe=.6-H*H-W*W-q*q-X*X;return 27*((re<0?0:(re*=re)*re*this.dot4(g[J],R,E,P,I))+(ie<0?0:(ie*=ie)*ie*this.dot4(g[$],L,C,F,B))+(ne<0?0:(ne*=ne)*ne*this.dot4(g[ee],O,z,D,N))+(ae<0?0:(ae*=ae)*ae*this.dot4(g[te],U,V,j,G))+(oe<0?0:(oe*=oe)*oe*this.dot4(g[se],H,W,q,X)))}}class Wr extends t.Mesh{constructor(e={}){super(),this.ready=!1,this.needUpdate=!1,this.type="terrain",this.name=e.name,this.folder=e.folder||"./assets/textures/terrain/",this.mapN=0,this.mapMax=7,this.ttype=e.terrainType||"terrain",this.callback=e.callback||function(){},this.physicsUpdate=()=>{},this.uvx=[e.uv||18,e.uv||18],this.sample=null==e.sample?[128,128]:e.sample,this.size=void 0===e.size?[100,30,100]:e.size;let s=this.sample[0]-1,r=this.sample[1]-1;this.rx=s/this.size[0],this.rz=r/this.size[2],this.zone=e.zone||1;let i=[this.size[0]/s,this.size[2]/r];this.sampleZ=[e.sample[0]*this.zone,e.sample[1]*this.zone],this.sizeZ=[(this.sampleZ[0]-1)*i[0],e.size[1],(this.sampleZ[1]-1)*i[1]],this.lng=this.sample[0]*this.sample[1],this.lngZ=this.sampleZ[0]*this.sampleZ[1],this.getZid(),this.data={level:e.level||[1,.2,.05],frequency:e.frequency||[.016,.05,.2],expo:e.expo||1},this.isWater=e.water||!1,this.isBorder=!1,this.wantBorder=e.border||!1,this.isBottom=!1,this.wantBottom=e.bottom||!1,this.wantBorder=e.border||!1,this.colorBase=this.isWater?{r:0,g:.7,b:1}:{r:.25,g:.25,b:.25},this.maxspeed=e.maxSpeed||.1,this.acc=null==e.acc?.01:e.acc,this.dec=null==e.dec?.01:e.dec,this.deep=null==e.deep?0:e.deep,this.ease=new t.Vector2,this.complexity=null==e.complexity?30:e.complexity,this.complexity2=null==e.complexity2?null:e.complexity2,this.local=new t.Vector3,e.local&&this.local.fromArray(e.local),this.pp=new t.Vector3,this.ratioZ=1/this.sampleZ[0],this.ratio=1/this.sample[0],this.ruvx=1/(this.size[0]/this.uvx[0]),this.ruvy=-1/(this.size[2]/this.uvx[1]),this.is64=e.is64||!1,this.isTurn=e.turn||!1,this.heightData=new Float32Array(this.lngZ),this.height=[],this.isAbsolute=e.isAbsolute||!1,this.isTurned=e.isTurned||!1,this.isReverse=e.isReverse||!1,this.changeId=this.isReverse||this.isTurned,this.changeId&&this.getReverseID(),this.colors=new Float32Array(3*this.lng),this.geometry=new t.PlaneGeometry(this.size[0],this.size[2],this.sample[0]-1,this.sample[1]-1),this.geometry.rotateX(-Gr.PI90),this.geometry.setAttribute("color",new t.BufferAttribute(this.colors,3)),this.vertices=this.geometry.attributes.position.array;var n=new t.Quaternion(.95,.8,.1,.05);e.maplevels&&n.fromArray(e.maplevels);var a,o=qr,l=e.maps||["sand","grass","rock"],h={};this.isWater&&(l=["water"]);for(let t in l)a=l[t],h[a+"_c"]=wr.texture({url:this.folder+a+"_c.jpg",flip:!1,repeat:this.uvx,encoding:e.encoding||!0,callback:this.mapcallback.bind(this)}),h[a+"_n"]=wr.texture({url:this.folder+a+"_n.jpg",flip:!1,repeat:this.uvx,callback:this.mapcallback.bind(this)});h.noise=wr.texture({url:this.folder+"noise.png",flip:!1,repeat:[1,1],encoding:!1,callback:this.mapcallback.bind(this)}),this.txt=h,this.material=new t.MeshPhysicalMaterial({name:"terrain",vertexColors:!0,color:16777215,map:h[l[0]+"_c"],normalMap:h[l[0]+"_n"]}),void 0!==e.envmap&&(this.material.envMap=e.envmap),this.isWater?(this.material.transparent=!0,this.material.opacity=e.opacity||.4,this.material.side=t.DoubleSide,this.material.alphaMap=h[l[0]+"_c"],this.material.map=null,this.material.metalness=.9,this.material.roughness=.1):(this.material.reflectivity=.1,this.material.metalness=e.metalness||.1,this.material.roughness=e.roughness||.5);var c=e.nScale||1;this.material.normalScale.set(c,c),this.isWater?this.material.onBeforeCompile=function(e){var t=e.fragmentShader;t=t.replace("#include <alphamap_fragment>",o.alphamap),e.fragmentShader=t}:(this.material.onBeforeCompile=function(e){var t=e.uniforms;t.clevels={value:n},t.map1={value:h[l[1]+"_c"]},t.map2={value:h[l[2]+"_c"]},t.randomUv={value:1},t.normalMap1={value:h[l[1]+"_n"]},t.normalMap2={value:h[l[2]+"_n"]},t.noise={value:h.noise},e.uniforms=t;var s=e.fragmentShader;s=(s=(s=(s=s.replace("uniform vec3 diffuse;",o.baseRemplace)).replace("#include <map_fragment>",o.map)).replace("#include <normal_fragment_maps>",o.normal)).replace("#include <color_fragment>",""),e.fragmentShader=s,this.userData.shader=e},Object.defineProperty(this.material,"randomUv",{get(){return!!this.userData.shader.uniforms.randomUv.value},set(e){this.userData.shader.uniforms.randomUv.value=e?1:0}}),Object.defineProperty(this.material,"map1",{get(){return this.userData.shader.uniforms.map1.value},set(e){this.userData.shader.uniforms.map1.value=e}}),Object.defineProperty(this.material,"map2",{get(){return this.userData.shader.uniforms.map2.value},set(e){this.userData.shader.uniforms.map2.value=e}}),Object.defineProperty(this.material,"normalMap1",{get(){return this.userData.shader.uniforms.normalMap1.value},set(e){this.userData.shader.uniforms.normalMap1.value=e}}),Object.defineProperty(this.material,"normalMap2",{get(){return this.userData.shader.uniforms.normalMap2.value},set(e){this.userData.shader.uniforms.normalMap2.value=e}})),e.debug&&this.debugZone(e),this.wantBorder&&this.addBorder(e),this.wantBottom&&this.addBottom(e),e.pos&&this.position.fromArray(e.pos),e.quat=void 0===e.quat?[0,0,0,1]:e.quat,void 0!==e.rot&&(e.quat=Gr.toQuatArray(e.rot),delete e.rot),this.quaternion.fromArray(e.quat),e.decal&&(this.position.y+=e.decal),this.castShadow=!0,this.receiveShadow=!0,wr.set("terrain"+this.name,this.material,"material",!0),this.update()}getZid(){this.zid={};let e=.5*(this.sample[0]-this.sampleZ[0]),t=.5*(this.sample[1]-this.sampleZ[1]),s=this.sample[0]*t+e,r=0;for(let t=0;t<this.lngZ;t++)r=Math.floor(t/this.sampleZ[0]),this.zid[s+t+r*(2*e)]=t}debugZone(e){this.geometryZ=new t.PlaneGeometry(this.sizeZ[0],this.sizeZ[2],this.sampleZ[0]-1,this.sampleZ[1]-1),this.geometryZ.rotateX(-Gr.PI90),this.verticesZ=this.geometryZ.attributes.position.array;const s=new t.Mesh(this.geometryZ,new t.MeshBasicMaterial({color:16711680,wireframe:!0}));e.pos&&s.position.fromArray(e.pos),this.add(s)}mapcallback(){this.mapN++,this.mapN==this.mapMax&&this.callback()}addBottom(e){var s=new t.PlaneGeometry(this.size[0],this.size[2],1,1);s.rotateX(Gr.PI90),this.bottomMesh=new t.Mesh(s,this.borderMaterial),this.add(this.bottomMesh),this.isBottom=!0}addBorder(e){this.borderMaterial=new t.MeshStandardMaterial({vertexColors:!0,metalness:this.isWater?.8:.4,roughness:this.isWater?.2:.6,normalScale:this.isWater?[.25,.25]:[2,2],transparent:!!this.isWater,opacity:this.isWater?e.opacity||.8:1,envMap:e.envmap||null});var s=new t.PlaneGeometry(this.size[0],2,this.sample[0]-1,1),r=new t.PlaneGeometry(this.size[0],2,this.sample[0]-1,1),i=new t.PlaneGeometry(this.size[2],2,this.sample[1]-1,1),n=new t.PlaneGeometry(this.size[2],2,this.sample[1]-1,1);s.translate(0,1,.5*this.size[2]),r.rotateY(-Gr.Pi),r.translate(0,1,.5*-this.size[2]),i.rotateY(-Gr.PI90),i.translate(.5*-this.size[0],1,0),n.rotateY(Gr.PI90),n.translate(.5*this.size[0],1,0),this.borderGeometry=ee(function(e,t=!1){return console.warn("THREE.BufferGeometryUtils: mergeBufferGeometries() has been renamed to mergeGeometries()."),J(e,t)}([s,r,i,n])),this.borderVertices=this.borderGeometry.attributes.position.array,this.lng2=this.borderVertices.length/3,this.list=new Array(this.lng2),this.borderColors=new Float32Array(3*this.lng),this.borderGeometry.setAttribute("color",new t.BufferAttribute(this.borderColors,3)),this.borderMesh=new t.Mesh(this.borderGeometry,this.borderMaterial);for(var a,o,l=this.lng2;l--;)a=3*l,o=this.borderVertices[a+1]>0?this.findPoint(this.borderVertices[a],this.borderVertices[a+2]):-1,this.list[l]=o;this.add(this.borderMesh),this.borderMesh.castShadow=!0,this.borderMesh.receiveShadow=!0,this.isBorder=!0}dispose(){this.isBottom&&(this.remove(this.bottomMesh),this.bottomMesh.geometry.dispose()),this.isBorder&&(this.remove(this.borderMesh),this.borderMesh.geometry.dispose(),this.borderMesh.material.dispose()),this.geometry.dispose(),this.material.dispose();for(let e in this.txt)this.txt[e].dispose()}easing(e,t,s){if(0!==e[0]||0!==e[1]){var r=t||0;e[7]?this.maxspeed=1.5:this.maxspeed=.25,this.ease.y+=e[1]*this.acc,this.ease.x+=e[0]*this.acc,this.ease.x=this.ease.x>this.maxspeed?this.maxspeed:this.ease.x,this.ease.x=this.ease.x<-this.maxspeed?-this.maxspeed:this.ease.x,this.ease.y=this.ease.y>this.maxspeed?this.maxspeed:this.ease.y,this.ease.y=this.ease.y<-this.maxspeed?-this.maxspeed:this.ease.y,e[1]||(this.ease.y>this.dec?this.ease.y-=this.dec:this.ease.y<-this.dec?this.ease.y+=this.dec:this.ease.y=0),e[0]||(this.ease.x>this.dec?this.ease.x-=this.dec:this.ease.x<-this.dec?this.ease.x+=this.dec:this.ease.x=0),(this.ease.x||this.ease.y)&&(this.local.z+=Math.sin(r)*this.ease.x+Math.cos(r)*this.ease.y,this.local.x+=Math.cos(r)*this.ease.x-Math.sin(r)*this.ease.y,this.update(s))}}getTri(){return this.geometry}getHeight(e,t){return e*=this.rx,t*=this.rz,e+=.5*this.sample[0],t+=.5*this.sample[1],e=Math.floor(e),t=Math.floor(t),(this.isTurn?this.height[this.findId2(e,t)]:this.height[this.findId(e,t)])*this.size[1]+this.position.y}findIdZ(e,t){return e+t*this.sampleZ[1]}findId(e,t){return e+t*this.sample[1]}findId2(e,t){return t+-e*this.sample[0]||1}findPoint(e,t){for(var s,r=this.lng;r--;)if(s=3*r,this.vertices[s]===e&&this.vertices[s+2]===t)return r;return-1}getReverseID(){this.invId=[];let e,t,s=this.lngZ;const r=this.sampleZ[1]-1;for(this.sampleZ[0];s--;)e=s%this.sampleZ[0],t=Math.floor(s*this.ratioZ),this.isReverse&&(t=r-t),this.invId[s]=this.isTurned?this.lngZ-1-this.findIdZ(t,e):this.findIdZ(e,t)}set(e){e.ease&&this.easing(e.key,e.azimut),e.decal&&this.decal(e.decal,!0)}decal(e,t){this.local.x+=e[0],this.local.y+=e[1],this.local.z+=e[2],this.update(t)}updateUv(){this.isWater?(this.material.normalMap.offset.x+=.002,this.material.normalMap.offset.y+=.001):this.material.map&&(this.material.map.offset.x=this.local.x*this.ruvx,this.material.map.offset.y=this.local.z*this.ruvy)}update(e){let t,s,r,i,n,a,o,l,h,c,u,p=this.pp,d=[1,1,1],m=this.lng;for(;m--;)t=3*m,s=m%this.sample[0],r=Math.floor(m*this.ratio),p.set(s+this.local.x*this.rx,this.local.y,r+this.local.z*this.rz),i=Gr.noise(p,this.data),i=Math.pow(i,this.data.expo),i=i>1?1:i,i=i<0?0:i,"road"===this.ttype&&(l===r?i=1===s||2===s||29===s||30===s?h+.1:h:(l=r,h=i)),this.height[m]=i,c=i*this.size[1]+this.deep,this.vertices[t+1]=c,a=this.isAbsolute?i:i*this.size[1],void 0!==this.zid[m]&&(o=this.zid[m],n=this.changeId?this.invId[o]:o,this.heightData[n]=a,this.verticesZ&&(this.verticesZ[3*o+1]=c)),d=this.isWater?[i*this.colorBase.r,i*this.colorBase.g,i*this.colorBase.b]:[i,0,0],u=Gr.clamp(d[0]+.25,.25,1),this.colors[t]=u,this.colors[t+1]=u,this.colors[t+2]=u;if(this.isBorder){let e,s=this.lng2;for(;s--;)t=3*s,-1!==this.list[s]?(e=this.height[this.list[s]],this.borderVertices[t+1]=e*this.size[1]+this.deep,u=Gr.clamp(e+.25,.25,1),this.borderColors[t]=u,this.borderColors[t+1]=u,this.borderColors[t+2]=u):(this.borderColors[t]=this.colorBase.r,this.borderColors[t+1]=this.colorBase.g,this.borderColors[t+2]=this.colorBase.b)}e?this.needUpdate=!0:this.updateGeometry(),this.ready&&this.physicsUpdate(this.name,this.heightData),this.ready=!0}step(e){this.needUpdate&&(this.updateGeometry(),this.needUpdate=!1)}updateGeometry(){this.geometry.attributes.position.needsUpdate=!0,this.geometry.attributes.color.needsUpdate=!0,this.geometry.computeVertexNormals(),this.updateUv(),this.geometryZ&&(this.geometryZ.attributes.position.needsUpdate=!0),this.isBorder&&(this.borderGeometry.attributes.position.needsUpdate=!0,this.borderGeometry.attributes.color.needsUpdate=!0)}}const qr={baseRemplace:"\n        uniform vec3 diffuse; \n        uniform vec4 clevels;\n\n        uniform float randomUv;\n\n        uniform sampler2D noise;\n\n        uniform sampler2D normalMap1;\n        uniform sampler2D normalMap2;\n\n        uniform sampler2D roughnessMap1;\n        uniform sampler2D roughnessMap2;\n\n        uniform float aoMapIntensity;\n        uniform sampler2D map1;\n        uniform sampler2D map2;\n\n        float sum( vec3 v ) { return v.x+v.y+v.z; }\n\n        vec4 textureNoTile( sampler2D mapper, in vec2 uv ){\n\n            // sample variation pattern    \n            float k = texture2D( noise, 0.005*uv ).x; // cheap (cache friendly) lookup    \n            \n            // compute index    \n            float index = k*8.0;\n            float f = fract( index );\n\n            float ia = floor( index );\n            float ib = ia + 1.0;\n            // or\n            //float ia = floor(index+0.5); // suslik's method (see comments)\n            //float ib = floor(index);\n            //f = min(f, 1.0-f)*2.0;\n\n            // offsets for the different virtual patterns    \n            vec2 offa = sin(vec2(3.0,7.0)*ia); // can replace with any other hash    \n            vec2 offb = sin(vec2(3.0,7.0)*ib); // can replace with any other hash    \n\n            // compute derivatives for mip-mapping    \n            vec2 dx = dFdx(uv);\n            vec2 dy = dFdy(uv);\n            \n            // sample the two closest virtual patterns    \n            vec3 cola = textureGrad( mapper, uv + offa, dx, dy ).xyz;\n            vec3 colb = textureGrad( mapper, uv + offb, dx, dy ).xyz;\n\n            // interpolate between the two virtual patterns    \n            return vec4( mix( cola, colb, smoothstep(0.2,0.8,f-0.1*sum(cola-colb)) ), 1.0);\n\n        }\n\n        vec4 textureMAP( sampler2D mapper, in vec2 uv ){\n            if( randomUv == 1.0 ) return textureNoTile( mapper, uv );\n            else return texture2D( mapper, uv );\n        }\n\n        vec4 MappingMix( float slope, vec4 level, vec4 rocks, vec4 grasss, vec4 sands ){\n            vec4 cc = rocks;\n            if (slope < level.y) cc = grasss;\n            if (slope < level.z) cc = sands;\n            if (( slope < level.x ) && (slope >= level.y)) cc = mix( grasss , rocks, (slope - level.y) * (1. / (level.x - level.y)));\n            if (( slope < level.y ) && (slope >= level.z)) cc = mix( sands , grasss, (slope - level.z) * (1. / (level.y - level.z)));\n            return cc;\n        }\n    ",rough:"\n        float roughnessFactor = roughness;\n        float metalnessFactor = metalness;\n        #ifdef USE_ROUGHNESSMAP\n\n            vec4 sandR = textureMAP( roughnessMap, vRoughnessMapUv );\n            vec4 grassR = textureMAP( roughnessMap1, vRoughnessMapUv );\n            vec4 rockR = textureMAP( roughnessMap2, vRoughnessMapUv );\n\n            vec4 baseColorR = MappingMix( vColor.r, clevels, rockR, grassR, sandR );\n            // reads channel G, compatible with a combined OcclusionRoughnessMetallic (RGB) texture\n            float ambientOcclusion =( baseColorR.r - 1.0 ) * aoMapIntensity + 1.0;\n            roughnessFactor *= baseColorR.g;\n            metalnessFactor *= baseColorR.b;\n        #endif\n    ",ao:"\n        reflectedLight.indirectDiffuse *= ambientOcclusion;\n        #if defined( USE_ENVMAP ) && defined( STANDARD )\n            float dotNV = saturate( dot( geometry.normal, geometry.viewDir ) );\n            reflectedLight.indirectSpecular *= computeSpecularOcclusion( dotNV, ambientOcclusion, material.specularRoughness );\n        #endif\n    ",map:"\n        #ifdef USE_MAP\n\n            vec4 sand = textureMAP( map, vMapUv );\n            vec4 grass = textureMAP( map1, vMapUv );\n            vec4 rock = textureMAP( map2, vMapUv ); \n\n            vec4 baseColor = MappingMix(vColor.r, clevels, rock, grass, sand);\n            diffuseColor *= baseColor;\n\n        #endif\n    ",normal:"\n\n        #ifdef USE_NORMALMAP_OBJECTSPACE\n\n            normal = texture2D( normalMap, vNormalMapUv ).xyz * 2.0 - 1.0; // overrides both flatShading and attribute normals\n\n            #ifdef FLIP_SIDED\n\n                normal = - normal;\n\n            #endif\n\n            #ifdef DOUBLE_SIDED\n\n                normal = normal * faceDirection;\n\n            #endif\n\n            normal = normalize( normalMatrix * normal );\n\n        #elif defined( USE_NORMALMAP_TANGENTSPACE )\n\n            vec4 sandN = textureMAP( normalMap, vNormalMapUv );\n            vec4 grassN = textureMAP( normalMap1, vNormalMapUv );\n            vec4 rockN = textureMAP( normalMap2, vNormalMapUv );\n            vec3 mapN = MappingMix(vColor.r, clevels, rockN, grassN, sandN).xyz * 2.0 - 1.0;\n\n            ///vec3 mapN = texture2D( normalMap, vNormalMapUv ).xyz * 2.0 - 1.0;\n\n            mapN.xy *= normalScale;\n            normal = normalize( tbn * mapN );\n\n        #elif defined( USE_BUMPMAP )\n\n            normal = perturbNormalArb( - vViewPosition, normal, dHdxy_fwd(), faceDirection );\n\n        #endif\n    ",normal2:"\n\n        #ifdef OBJECTSPACE_NORMALMAP\n\n            normal = texture2D( normalMap, vNormalMapUv ).xyz * 2.0 - 1.0; // overrides both flatShading and attribute normals\n\n            #ifdef FLIP_SIDED\n\n                normal = - normal;\n\n            #endif\n\n            #ifdef DOUBLE_SIDED\n\n                normal = normal * faceDirection;\n\n            #endif\n\n            normal = normalize( normalMatrix * normal );\n\n        #elif defined( TANGENTSPACE_NORMALMAP )\n\n            vec4 sandN = textureMAP( normalMap, vNormalMapUv );\n            vec4 grassN = textureMAP( normalMap1, vNormalMapUv );\n            vec4 rockN = textureMAP( normalMap2, vNormalMapUv );\n\n            vec3 mapN = MappingMix(vColor.r, clevels, rockN, grassN, sandN).xyz * 2.0 - 1.0;\n\n            //vec3 mapN = texture2D( normalMap, vNormalMapUv ).xyz * 2.0 - 1.0;\n            mapN.xy *= normalScale;\n\n            normal = normalize( tbn * mapN );\n\n        #elif defined( USE_BUMPMAP )\n\n            normal = perturbNormalArb( - vViewPosition, normal, dHdxy_fwd(), faceDirection );\n\n        #endif\n    ",alphamap:"\n        #ifdef USE_ALPHAMAP\n            diffuseColor.a = opacity +( texture2D( alphaMap, vAlphaMapUv ).g * opacity) * (1.0-opacity);\n        #endif\n    "};class Xr extends F{constructor(){super(),this.Utils=x,this.type="terrain",this.num=g[this.type]}step(e,t){let s,r=this.list.length;for(;r--;)s=this.list[r],s.step()}add(e={}){this.setName(e),"PHYSX"===b.engine&&(e.isAbsolute=!0,e.isTurned=!0),"HAVOK"===b.engine&&(e.isAbsolute=!0,e.isTurned=!0,e.isReverse=!1),"OIMO"!==b.engine&&(e.zone=e.zone||.25);const t=new Wr(e);return t.physicsUpdate=(e,t)=>{b.flow.tmp.push({name:e,heightData:t})},this.addToWorld(t,e.id),b.post({m:"add",o:Kr(t)}),t}set(e={},t=null){null===t&&(t=this.byName(e.name)),null!==t&&t.set(e)}}const Kr=function(e){const t={name:e.name,type:e.type,pos:e.position.toArray(),quat:"PHYSX"===b.engine?[0,0,0,1]:e.quaternion.toArray()};return"PHYSX"===b.engine||"AMMO"===b.engine||"HAVOK"===b.engine?(t.type="terrain",t.size=e.sizeZ,t.sample=e.sampleZ,t.zone=e.zone,t.heightData=e.heightData):(t.type="mesh",t.v=l.getVertex(e.geometry,"OIMO"===b.engine),t.index="OIMO"===b.engine?null:l.getIndex(e.geometry)),t};class Qr extends F{constructor(){super(),this.Utils=x,this.type="solver"}step(e,t){let s,r=this.list.length;for(;r--;)s=t+r*g[this.type],this.list[r].update(e,s)}add(e={}){this.setName(e);let t=new Zr(e);return this.addToWorld(t,e.id),b.post({m:"add",o:e}),t}set(e={}){}}class Zr{constructor(e){this.name=e.name,this.type="solver",this.needData=e.needData||!1,this.joints=[],this.jid=0,this.speed=1}update(e,t){if(!this.needData)return;let s,r,i=this.joints.length;for(;i--;)r=t+7*i,s=this.joints[i],s.data.target.x=e[r+0],s.data.target.y=e[r+1],s.data.target.z=e[r+2],s.data.target.rx=Math.round(e[r+3]),s.data.target.ry=Math.round(e[r+4]),s.data.target.rz=Math.round(e[r+5]),s.data.target.count=e[r+6]}start(){b.post({m:"startArticulation",o:{name:this.name}})}stop(){b.post({m:"stopArticulation",o:{name:this.name}})}commonInit(){b.post({m:"commonInitArticulation",o:{name:this.name}})}addJoint(e){this.jid=this.joints.length,e.name=e.name||this.name+"_Joint_"+this.jid,e.solver=this.name,void 0!==e.rot1&&(e.quat1=l.quatFromEuler(e.rot1),delete e.rot1),void 0!==e.rot2&&(e.quat2=l.quatFromEuler(e.rot2),delete e.rot2),"fixe"!==e.type&&this.joints.push(new Yr(e,this)),b.post({m:"addSolverJoint",o:e})}driveJoints(e){let t,s,r=!1,i=this.joints.length,n=[];for(;i--;)t=this.joints[i],t.update(e),s=t.isDrive,s&&n.push(t.nup),r=!!s||r;r?b.motor.change(n):this.resolve&&(this.resolve(),delete this.resolve)}setAngles(e,t){if(!e)return;let s=this.joints.length;for(;s--;)this.joints[s].pose(void 0!==e[s]?e[s]:0,void 0!==t?t:this.speed);return new Promise((e=>this.resolve=e))}}class Yr{constructor(e,t){if(this.name=e.name,this.solver=t,this.type="solverJoint",this.isDrive=!1,this.current=0,this.tmp=0,this.target=0,this.start=0,this.time=0,this.nup=null,this.data={target:{x:0,y:0,z:0,rx:0,ry:0,rz:0,count:0}},e.limits&&(this.driveType=e.limits[0][0],this.min=e.limits[0][1],this.max=e.limits[0][2]),e.position){let t,s=e.position.length;for(;s--;)t=e.position[s],this.data.target[t[0]]=t[1]}}start(){}pose(e,t){this.target=l.clamp(e,this.min,this.max),this.current=l.clamp(this.data.target[this.driveType],this.min,this.max),this.target!==this.current&&(this.start=this.current,this.tmp=0,this.time=t,this.isDrive=!0)}update(e){if(this.isDrive){this.tmp+=e;let t=this.tmp/this.time;t=t>1?1:t;let s=l.lerp(this.start,this.target,t);this.nup={name:this.name,drivesTarget:[[this.driveType,s]]},1===t&&(this.isDrive=!1)}}}class Jr extends t.Mesh{constructor(e={}){super(new t.PlaneGeometry,new t.MeshBasicMaterial({polygonOffset:!0,polygonOffsetFactor:-4})),this.name=e.nam||"text",this.canvas=null,this.w=e.w||0,this.h=e.h||0,this.weight=e.weight??700,this.font=e.font??"'Mulish', sans-serif",this.fontSize=e.fontSize??32,this.backgroundColor=e.backgroundColor??"#00000000",this.fontColor=e.fontColor??"#FFFFFF",this.material.alphaTest=.5,this.set(e.text),e.pos&&this.position.fromArray(e.pos),e.rot&&this.quaternion.fromArray(l.quatFromEuler(e.rot))}set(e){this.canvas||(this.canvas=document.createElement("canvas"));let s,r,i,n=this.canvas.getContext("2d");n.font=this.weight+" "+this.fontSize+"px "+this.font;let a=n.measureText(e);s=2**Math.ceil(Math.log2(a.width)),r=2**Math.ceil(Math.log2(n.measureText("M").width)),this.canvas.width=s,this.canvas.height=r,n.fillStyle=this.backgroundColor,n.fillRect(0,0,s,r),n.fillStyle=this.fontColor,n.font=this.weight+" "+this.fontSize+"px "+this.font,n.textAlign="center",n.textBaseline="middle",n.fillText(e,.5*s,.5*r),this.material.map=new t.CanvasTexture(this.canvas),0!==this.h?(i=this.h/r,this.scale.set(s*i,this.h,0)):0!==this.w?(i=this.w/r,this.scale.set(this.w,r*i,0)):this.scale.set(.025*s,.025*r,0)}dispose(){this.parent.remove(this),this.material.map.dispose(),this.material.dispose(),this.geometry.dispose()}}let $r=0;class ei{constructor(e={}){this.down=!1,this.time=e.time||250,this.p=e.pos||[0,0,0],this.type=e.type||"box",this.name=e.name||"button"+$r++,this.pos=e.pos||[0,0,0],this.size=e.size||[1,1,1],this.radius=e.radius||0,this.axe=void 0!==e.axe?e.axe:1,this.fontSize=e.fontSize||.8,this.fontScale=e.fontScale||1,this.extraForce=!0,this.decal="sphere"===this.type?.5*this.size[1]:.5*this.size[1]-this.radius,"sphere"!==this.type&&(this.pos[this.axe]+=this.decal),this.origin=this.pos[this.axe];let t=this.size[this.axe]-2*this.radius;this.range=[this.origin-t,this.origin],this.value=this.origin,this.target=this.origin,this.speed=this.size[this.axe]/3/this.size[this.axe],this.callback=function(){console.log("action down")},e.callback&&(this.callback=e.callback,delete e.callback),e.button=!0,e.pos=this.pos,e.material||(e.material="button"),e.kinematic=!0,e.mask=1,this.timeout=null,this.b=b.motor.add(e),this.b.userData.action=this.action.bind(this),this.b.userData.out=this.out.bind(this),e.text&&this.addText(e.text)}addText(e,t){this.fontSize="box"===this.type?.8*this.size[1]:.8*this.size[0],this.fontSize*=this.fontScale,this.txt=new Jr({text:e,pos:[0,.5*this.size[1],0],rot:[-90,0,0],h:this.fontSize}),this.b.add(this.txt)}action(e){this.down||(this.down=!0,this.target=this.range[0],this.extraForce&&b.motor.explosion(e||this.p,2*this.size[0],.01),this.callback())}out(){this.down&&(this.down=!1,this.target=this.range[1],this.extraForce&&b.motor.explosion(this.p,2*this.size[0],.01))}update(){if(this.value!==this.target){this.value=l.lerp(this.value,this.target,this.speed),l.nearEquals(this.value,this.target,1e-4)?this.value=this.target:(this.pos[this.axe]=this.value,b.motor.change({name:this.b.name,pos:this.pos}))}}dispose(){this.txt&&this.txt.dispose()}}class ti{constructor(e={}){this.isCompound=!0,this.init(e)}init(e){let s=e.size||[5,3,8],r=e.pos||[0,2,0],i=.1,n=.05,a=.2,o=new ae(s[0],s[1],s[2],e.radius||n),h=new t.Mesh(o),c=[[i,s[1]-a,s[2]],[i,s[1]-a,s[2]],[s[0],i,s[2]],[s[0],i,s[2]],[s[0]-a,s[1]-a,i],[s[0]-a,s[1]-a,i]],u=[[n-.5*s[0],0,0],[.5*s[0]-n,0,0],[0,n-.5*s[1],0],[0,.5*s[1]-n,0],[0,0,n-.5*s[2]],[0,0,.5*s[2]-n]];const p=[];let d,m=6,f=0;for(;m--;)d=this.isCompound?u[f]:l.addArray(r,u[f]),p.push({type:"box",size:c[f],pos:d,material:e.material}),f++;this.isCompound?b.motor.add({...e,shapes:p,mesh:h,type:"compound"}):b.motor.add(p)}}class si{constructor(e,s="drag"){this.needRay=!0,this.moveDirect=!1,this.moveDeep=!1,this.mode=s,this.option={},this.controler=e,this.dom=this.controler.domElement,this.selected=null,this.buttonRef=null,this.numBullet=0,this.maxBullet=10,this.sticky=!1,this.pz=0,this.isActive=!1,this.raycastTest=!1,this.firstSelect=!1,this.mouseDown=!1,this.mouseDown2=!1,this.mouseMove=!1,this.decal=new t.Vector3,this.tmpPos=new t.Vector3,this.tmpD=new t.Vector3,this.mouse=new t.Vector2,this.oldMouse=new t.Vector2,this.raycast=new t.Raycaster,this.raycast.far=1e3,this.button=0,this.pos=new t.Vector3,this.velocity=new t.Vector3,this.angle=0,this.helper=null,this.dragPlane=null,this.activeDragMouse(!0)}addDrag(){this.dragPlane||(this.helper=new ri,this.dragPlane=new t.Mesh(new t.PlaneGeometry(1,1),L.get("hide")),this.dragPlane.castShadow=!1,this.dragPlane.receiveShadow=!1,this.dragPlane.scale.set(1,1,1).multiplyScalar(200),b.scenePlus.add(this.helper),b.scenePlus.add(this.dragPlane))}clearDrag(){this.dragPlane&&(b.scenePlus.remove(this.dragPlane),b.scenePlus.remove(this.helper),this.dragPlane.geometry.dispose(),this.helper.geometry.dispose(),this.dragPlane=null,this.helper=null)}setMode(e,t={}){e!==this.mode&&(this.mode=e,this.option=t,"blast"===this.mode&&this.option.visible&&b.motor.initParticle())}activeDragMouse(e){e?this.isActive||(this.dom.addEventListener("pointermove",this.mousemove.bind(this),!1),this.dom.addEventListener("pointerdown",this.mousedown.bind(this),!1),document.addEventListener("pointerup",this.mouseup.bind(this),!1),document.addEventListener("contextmenu",this.contextmenu.bind(this),!1),this.controler.addEventListener("end",this.controleEnd.bind(this),!1),this.controler.addEventListener("change",this.controleChange.bind(this),!1),this.isActive=!0,this.raycastTest=!0):this.isActive&&(this.dom.removeEventListener("pointermove",this.mousemove.bind(this)),this.dom.removeEventListener("pointerdown",this.mousedown.bind(this)),document.removeEventListener("pointerup",this.mouseup.bind(this)),this.controler.removeEventListener("end",this.controleEnd.bind(this)),this.controler.removeEventListener("change",this.controleChange.bind(this)),this.isActive=!1)}controleEnd(e){this.raycastTest=!0,this.controler.getInfo&&this.controler.getInfo()}controleChange(e){-1!==this.controler.getState()&&(this.raycastTest=!1)}getMouse(e){b.viewSize?(this.mouse.x=e.offsetX/b.viewSize.w*2-1,this.mouse.y=-e.offsetY/b.viewSize.h*2+1):(this.mouse.x=e.offsetX/this.dom.clientWidth*2-1,this.mouse.y=-e.offsetY/this.dom.clientHeight*2+1),this.button="touch"!==e.pointerType?e.button:0}contextmenu(e){e.preventDefault()}mousedown(e){switch(this.sticky&&(this.unSelect(),console.log("unstick")),this.getMouse(e),this.mode){case"drag":this.drag();break;case"shoot":this.shoot();break;case"blast":this.blast()}}mouseup(e){this.mouseMove=!(this.oldMouse.distanceTo(this.mouse)<.01),this.mouseDown=!1,this.mouseDown2=!1,b.mouseDown=!1,this.sticky?this.controler.enabled=!0:(this.unSelect(),this.resetButton())}mousemove(e){switch(this.mode){case"drag":this.getMouse(e),this.needRay=!0}}castray(){let e,t,s,r,i,n="auto";if(null!==this.selected)this.raycast.setFromCamera(this.mouse,this.controler.object),e=this.raycast.intersectObject(this.dragPlane),e.length&&this.mouseDown&&this.moveSelect(e[0].point);else{if(!this.raycastTest)return;this.controler.enableRotate=!1,this.controler.enablePan=!1,this.raycast.setFromCamera(this.mouse,this.controler.object),e=this.raycast.intersectObjects(b.scene.children,!0),this.tmpSelected=null,e.length>0?(s=e[0].object,i=e[0].instanceId,void 0!==i?t=b.motor.byName(s.name+i):s.parent!==b.scene?(r=s.parent,t=r.parent!==b.scene?r.parent:r):t=s,this.mouseDown2&&t.extra&&t.extra(t.name),n=t.isButton?this.actionButton(t,e[0]):this.select(t,e[0].point)):(this.controler.enableRotate=!0,this.controler.enablePan=!0),document.body.style.cursor=n}}drag(){this.mouseDown||(this.firstSelect&&(this.firstSelect=!1),this.oldMouse.copy(this.mouse)),2===this.button&&(this.mouseDown2=!0),this.mouseDown=!0,b.mouseDown=!0,this.needRay=!0}blast(){let e=null;this.raycast.setFromCamera(this.mouse,this.controler.object);let t=this.raycast.intersectObjects(b.scene.children,!0);t.length>0?e=t[0]:(t=this.raycast.intersectObjects(b.scenePlus.children,!0),t.length>0&&(e=t[0]));const s=this.option;e&&(b.motor.explosion(e.point,s.radius||3,s.power||.1),s.visible&&b.motor.addParticle({name:"blast",type:"cube",position:e.point.toArray(),numParticles:60,radius:.2,radiusRange:.1,acceleration:[50,5,50],lifeTime:.5,endTime:.5,startTime:0,gravity:[0,.2,0],startSize:.5,endSize:.1,tween:"outQuad"}))}shoot(){this.raycast.setFromCamera(this.mouse,this.controler.object),this.pos.copy(this.raycast.ray.direction).add(this.raycast.ray.origin),this.velocity.copy(this.raycast.ray.direction).multiplyScalar(60),b.motor.add({name:"bullet_"+this.numBullet,type:"sphere",density:20,size:[.2],material:"chrome",pos:this.pos.toArray(),linearVelocity:this.velocity.toArray(),bullet:!0}),this.numBullet++,this.numBullet>this.maxBullet&&(this.numBullet=0)}resetButton(){this.buttonRef&&(this.buttonRef.userData.out&&this.buttonRef.userData.out(),this.buttonRef=null),this.raycastTest=!0,this.selected=null,this.firstSelect=!0,this.controler.enableRotate=!0,this.controler.enablePan=!0}actionButton(e,t){if(this.buttonRef?this.buttonRef.name!==e.name&&(this.buttonRef.userData.out&&this.buttonRef.userData.out(),this.buttonRef=e):this.mouseDown&&(this.buttonRef=e),this.mouseDown&&this.buttonRef.userData.action){let e=t.point;this.buttonRef.userData.action(e)}return"pointer"}select(e,t){if(!this.mouseDown||this.selected===e)return"pointer";this.pz=0;let s=t,r=[0,0,0,1];this.selected=e,this.decal.copy(s).sub(this.selected.position),this.tmpPos.copy(s).sub(this.decal),this.angle=this.controler.getAzimuthalAngle();let i=this.selected.quaternion;r=[i._x,i._y,i._z,i._w],this.addDrag(),this.dragPlane.rotation.set(0,this.angle,0),this.dragPlane.position.copy(s),this.dragPlane.position.y=0,this.helper.position.copy(s);let n=s.toArray();if(b.motor.change({name:this.selected.name,neverSleep:!0,wake:!0}),this.moveDirect)b.motor.change({name:this.selected.name,kinematic:!1,gravity:!1,damping:[.9,.9]});else{let e=[-.01,.01,60,1],t=[-.1,.1,60,1],s="OIMO"===b.engine||"RAPIER"===b.engine||"HAVOK"===b.engine,i="HAVOK"===b.engine?"fixe":"d6";b.motor.add([{name:"mouse",type:"null",pos:n,quat:r,kinematic:!s},{name:"mouseJoint",type:"joint",mode:i,lm:[["x",...e],["y",...e],["z",...e],["rx",...t],["ry",...t],["rz",...t]],autoDrive:!0,b1:"mouse",b2:this.selected.name,worldAnchor:n,worldAxis:[1,0,0],visible:!1}])}return"url('./assets/icons/point.png') 8 8, move"}moveSelect(e){if(null===this.selected)return;if(e&&this.tmpPos.copy(e).sub(this.decal),this.moveDeep){let e=this.selected.position.y,t=e-this.tmpPos.y;this.tmpPos.y=e,this.tmpD.set(0,0,t).applyAxisAngle({x:0,y:1,z:0},this.angle),this.tmpPos.add(this.tmpD)}this.helper.position.copy(this.tmpPos);let t=this.tmpPos.toArray();this.moveDirect?b.motor.change({name:this.selected.name,pos:t,reset:!0}):b.motor.change({name:"mouse",pos:e.toArray()},!0)}unSelect(){null!==this.selected&&(this.clearDrag(),this.moveDirect?b.motor.change({name:this.selected.name,kinematic:!1,wake:!0,gravity:!0,damping:[0,.1]}):(b.motor.remove(["mouseJoint","mouse"]),b.motor.change({name:this.selected.name,neverSleep:!1,wake:!0})),this.raycastTest=!0,this.selected=null,this.firstSelect=!0)}step(){if(this.needRay&&this.castray(),this.needRay=!1,null===this.selected)return;let e=b.flow.key;if(0!==e[1]){let t=.1*e[1];this.dragPlane.translateZ(t),this.needRay=!0}this.moveDirect&&this.moveSelect()}}class ri extends t.Line{constructor(e={}){super(new t.BufferGeometry,L.get("line"));let s=.75;const r=[s,s,s,0,0,0];this.geometry.setAttribute("position",new t.Float32BufferAttribute([0,0,0,0,-100,0],3)),this.geometry.setAttribute("color",new t.Float32BufferAttribute(r,3)),this.vertices=this.geometry.attributes.position,this.colors=this.geometry.attributes.color,this.local=[0,0,0,0,0,0,0,0,0],this.frustumCulled=!1}}const ii=new t.Vector3;class ni{constructor(e=1.4,s=1e-4){this.minSizeForBreak=e,this.smallDelta=s,this.tempLine1=new t.Line3,this.tempPlane1=new t.Plane,this.tempPlane2=new t.Plane,this.tempPlane_Cut=new t.Plane,this.tempCM1=new t.Vector3,this.tempCM2=new t.Vector3,this.tempVector3=new t.Vector3,this.tempVector3_2=new t.Vector3,this.tempVector3_3=new t.Vector3,this.tempVector3_P0=new t.Vector3,this.tempVector3_P1=new t.Vector3,this.tempVector3_P2=new t.Vector3,this.tempVector3_N0=new t.Vector3,this.tempVector3_N1=new t.Vector3,this.tempVector3_AB=new t.Vector3,this.tempVector3_CB=new t.Vector3,this.tempResultObjects={object1:null,object2:null},this.box1=new t.Box3,this.box2=new t.Box3,this.sph1=new t.Sphere,this.sph2=new t.Sphere,this.tt=new t.Vector3,this.s1=new t.Vector3,this.s2=new t.Vector3,this.segments=[];for(let e=0;e<900;e++)this.segments[e]=!1}prepareBreakableObject(e,t,s,r,i){const n=e.userData;n.mass=t,n.velocity=s.clone(),n.angularVelocity=r.clone(),n.breakable=i}subdivideByImpact(e,t,s,r,i){const n=[],a=this.tempPlane1,o=this.tempPlane2;this.tempVector3.addVectors(t,s),a.setFromCoplanarPoints(t,e.position,this.tempVector3);const l=i+r,h=this;return function i(c,u,p,d){if(Math.random()<.05*d||d>l)return void n.push(c);let m=Math.PI;0===d?(o.normal.copy(a.normal),o.constant=a.constant):d<=r?(m=(p-u)*(.2+.6*Math.random())+u,h.tempVector3_2.copy(e.position).sub(t).applyAxisAngle(s,m).add(t),o.setFromCoplanarPoints(t,h.tempVector3,h.tempVector3_2)):(m=(.5*(1&d)+.2*(2-Math.random()))*Math.PI,h.tempVector3_2.copy(t).sub(c.position).applyAxisAngle(s,m).add(c.position),h.tempVector3_3.copy(s).add(c.position),o.setFromCoplanarPoints(c.position,h.tempVector3_3,h.tempVector3_2)),h.cutByPlane(c,o,h.tempResultObjects);const f=h.tempResultObjects.object1,g=h.tempResultObjects.object2;f&&i(f,u,m,d+1),g&&i(g,m,p,d+1)}(e,0,2*Math.PI,0),n}cutByPlane(e,s,r){let i;const n=e.geometry,a=n.attributes.position.array,o=n.attributes.normal.array,l=a.length/3;let h=l/3,c=n.getIndex();function u(e,t){const s=3*e+t;return c?c[s]:s}c&&(c=c.array,h=c.length/3);const p=[],d=[],m=this.smallDelta,f=l*l;for(let e=0;e<f;e++)this.segments[e]=!1;const g=this.tempVector3_P0,y=this.tempVector3_P1,b=this.tempVector3_N0,x=this.tempVector3_N1;for(let e=0;e<h-1;e++){const t=u(e,0),s=u(e,1),r=u(e,2);b.set(o[t],o[t]+1,o[t]+2);for(let i=e+1;i<h;i++){const e=u(i,0),n=u(i,1),a=u(i,2);x.set(o[e],o[e]+1,o[e]+2);1-b.dot(x)<m&&(t===e||t===n||t===a?s===e||s===n||s===a?(this.segments[t*l+s]=!0,this.segments[s*l+t]=!0):(this.segments[r*l+t]=!0,this.segments[t*l+r]=!0):s!==e&&s!==n&&s!==a||(this.segments[r*l+s]=!0,this.segments[s*l+r]=!0))}}const v=this.tempPlane_Cut;e.updateMatrix(),ni.transformPlaneToLocalSpace(s,e.matrix,v);for(let e=0;e<h;e++){const s=u(e,0),i=u(e,1),n=u(e,2);for(let e=0;e<3;e++){const o=0===e?s:1===e?i:n,h=0===e?i:1===e?n:s;if(this.segments[o*l+h])continue;this.segments[o*l+h]=!0,this.segments[h*l+o]=!0,g.set(a[3*o],a[3*o+1],a[3*o+2]),y.set(a[3*h],a[3*h+1],a[3*h+2]);let c=0,u=v.distanceToPoint(g);u>m?(c=2,d.push(g.clone())):u<-m?(c=1,p.push(g.clone())):(c=3,p.push(g.clone()),d.push(g.clone()));let f=0;if(u=v.distanceToPoint(y),u>m?(f=2,d.push(y.clone())):u<-m?(f=1,p.push(y.clone())):(f=3,p.push(y.clone()),d.push(y.clone())),1===c&&2===f||2===c&&1===f){this.tempLine1.start.copy(g),this.tempLine1.end.copy(y);let e=new t.Vector3;if(e=v.intersectLine(this.tempLine1,e),null===e)return console.error("Internal error: segment does not intersect plane."),r.segmentedObject1=null,r.segmentedObject2=null,0;p.push(e),d.push(e.clone())}}}e.userData.mass;let w=this.box1,M=this.box2,A=p.length,T=d.length;for(w.makeEmpty(),M.makeEmpty(),i=A;i--;)w.expandByPoint(p[i]);for(i=T;i--;)M.expandByPoint(d[i]);for(w.getBoundingSphere(this.sph1),M.getBoundingSphere(this.sph2),this.tempCM1.copy(this.sph1.center),this.tempCM2.copy(this.sph2.center),i=A;i--;)p[i].sub(this.tempCM1);for(i=T;i--;)d[i].sub(this.tempCM2);this.tempCM1.add(e.position),this.tempCM2.add(e.position),w.getSize(this.s1),M.getSize(this.s2),2*this.sph1.radius<this.minSizeForBreak&&(A=0),2*this.sph2.radius<this.minSizeForBreak&&(T=0),this.testSize(this.s1)&&(A=0),this.testSize(this.s2)&&(T=0);let S=null,k=null,R=0;return A>4&&(S=new t.Mesh(new ve(p),e.material),S.position.copy(this.tempCM1),S.quaternion.copy(e.quaternion),R++),T>4&&(k=new t.Mesh(new ve(d),e.material),k.position.copy(this.tempCM2),k.quaternion.copy(e.quaternion),R++),r.object1=S,r.object2=k,R}testSize(e){let t=0;return e.x<.01&&t++,e.y<.01&&t++,e.z<.01&&t++,t>1}static transformFreeVector(e,t){const s=e.x,r=e.y,i=e.z,n=t.elements;return e.x=n[0]*s+n[4]*r+n[8]*i,e.y=n[1]*s+n[5]*r+n[9]*i,e.z=n[2]*s+n[6]*r+n[10]*i,e}static transformFreeVectorInverse(e,t){const s=e.x,r=e.y,i=e.z,n=t.elements;return e.x=n[0]*s+n[1]*r+n[2]*i,e.y=n[4]*s+n[5]*r+n[6]*i,e.z=n[8]*s+n[9]*r+n[10]*i,e}static transformTiedVectorInverse(e,t){const s=e.x,r=e.y,i=e.z,n=t.elements;return e.x=n[0]*s+n[1]*r+n[2]*i-n[12],e.y=n[4]*s+n[5]*r+n[6]*i-n[13],e.z=n[8]*s+n[9]*r+n[10]*i-n[14],e}static transformPlaneToLocalSpace(e,t,s){s.normal.copy(e.normal),s.constant=e.constant;const r=ni.transformTiedVectorInverse(e.coplanarPoint(ii),t);ni.transformFreeVectorInverse(s.normal,t),s.constant=-r.dot(s.normal)}}class ai{constructor(){this.convexBreaker=new ni,this.tmpI=new THREE.Vector3,this.tpos=new THREE.Vector3,this.tnormal=new THREE.Vector3,this.nDebris=0,this.maxDebris=300,this.tt=null}step(){let e;for(let t in b.reflow.point)e=b.reflow.point[t],0!==e.distance&&(this.makeBreak(e.b1,e.pos,e.normal,e.impulse,e.v1),this.makeBreak(e.b2,e.pos,e.normal,e.impulse,e.v2))}makeBreak(e,t,s,r,i){let n=x.byName(e);if(!n)return;if(!n.breakable)return;let a=n.breakOption;if(r<a[0])return;let o=this.convexBreaker.subdivideByImpact(n,this.tpos.fromArray(t),this.tnormal.fromArray(s),a[1],a[2]);if(o.length<1)return;a[3]-=1;const l={material:n.material,linearVelocity:[i[0],i[1],i[2]],angularVelocity:[i[3],i[4],i[5]],density:n.density};let h=[],c=o.length,u=0;for(;c--;)h.push(this.addDebris(o[u],a,l)),u++;this.tt=setTimeout((()=>{b.motor.remove(e),b.motor.add(h)}),0)}addDebris(e,t,s){let r=t[3]>0,i={...s,name:"debris_"+this.nDebris++,type:"convex",shape:e.geometry,pos:e.position.toArray(),quat:e.quaternion.toArray(),breakable:r,breakOption:t};return this.nDebris>this.maxDebris&&(this.nDebris=0),i}}new t.Vector3;const oi=new t.Vector3,li=new t.Vector3,hi=new t.Vector3,ci=new t.Vector3,ui=new t.Vector3;class pi{constructor(e={}){this.name=e.name||"ppp",this.particles=[],this.density=.01,this.smoothingRadius=.2,this.speedOfSound=.1,this.viscosity=.03,this.eps=1e-6,this.group=256,this.pressures=[],this.densities=[],this.neighbors=[]}add(e){let s=b.motor.add({instance:this.name,type:"particle",flags:"noQuery",size:[.1],inertia:[0,0,0],pos:e,mass:.01,restitution:0,friction:.5,maxVelocity:[2,100],group:this.group,mask:3,material:"hide"});s.force=new t.Vector3,this.particles.push(s),this.neighbors.length<this.particles.length&&this.neighbors.push([])}connect(e){let t,s=e.length,r=[];for(;s--;)t=e[s],r.push({type:"joint",mode:"distance",b1:this.name+t[0],b2:this.name+t[1],lm:[.01,.15],spring:[100,.01]});b.motor.add(r)}getPosition(){let e,t,s=[],r=this.particles.length;for(;r--;)t=3*r,e=this.particles[r],s[t]=e.position.x,s[t+1]=e.position.y,s[t+2]=e.position.z;return s}getNeighbors(e,t){const s=this.particles.length,r=e.id,i=this.smoothingRadius*this.smoothingRadius;let n=0;for(let a=0;a!==s;a++){const s=this.particles[a];n=this.distance(s,e),r!==s.id&&n<i&&t.push(s)}}distance(e,t){const s=e.position.x-t.position.x,r=e.position.y-t.position.y,i=e.position.z-t.position.z;return s*s+r*r+i*i}w(e){const t=this.smoothingRadius;return 315/(64*Math.PI*t**9)*(t*t-e*e)**3}gradw(e,t){const s=e.length(),r=this.smoothingRadius;t.copy(e).multiplyScalar(945/(32*Math.PI*r**9)*(r*r-s*s)**2)}nablaw(e){const t=this.smoothingRadius;return 945/(32*Math.PI*t**9)*(t*t-e*e)*(7*e*e-3*t*t)}update(){const e=[],t=this.particles.length,s=this.speedOfSound,r=this.eps;let i,n=t;for(;n--;){const e=this.particles[n];e.force.set(0,0,0);const t=this.neighbors[n];t.length=0,this.getNeighbors(e,t),t.push(this.particles[n]);let r=0;for(i=t.length;i--;){const s=this.w(this.distance(e,t[i]));r+=t[i].mass*s}this.densities[n]=r,this.pressures[n]=s*s*(this.densities[n]-this.density)}const a=oi,o=li,l=hi,h=ci,c=ui;for(n=t;n--;){const t=this.particles[n];let s,u;a.set(0,0,0),o.set(0,0,0);const p=this.neighbors[n];for(i=p.length;i--;){const e=p[i];h.copy(t.position).sub(e.position);const d=h.length();s=-e.mass*(this.pressures[n]/(this.densities[n]*this.densities[n]+r)+this.pressures[i]/(this.densities[i]*this.densities[i]+r)),this.gradw(h,l),l.multiplyScalar(s),a.add(l),c.copy(e.velocity).sub(t.velocity),c.multiplyScalar(1/(1e-4+this.densities[n]*this.densities[i])*this.viscosity*e.mass),u=this.nablaw(d),c.multiplyScalar(u),o.add(c)}o.multiplyScalar(t.mass),a.multiplyScalar(t.mass),t.force.add(o),t.force.add(a),e.push({name:t.name,force:t.force.toArray()})}b.motor.change(e)}}const di=new t.Matrix4,mi=new t.Matrix4;new t.Vector3;let fi,gi=t.Skeleton.prototype;gi.byName=function(e){let t=this.bones.length;for(;t--;)if(this.bones[t].name===e)return this.bones[t];return null},gi.getId=function(e){let t=this.bones.length;for(;t--;)if(this.bones[t].name===e)return t;return null},gi.setExtraRotation=function(e,s,r,i){(e.isBone?e:this.byName(e))&&t.MathUtils.DEG2RAD},gi.setScalling=function(e,s,r,i){let n=e.isBone?e:this.byName(e);n&&(n.scalling=new t.Vector3(s,r,i))},gi.resetScalling=function(e){this.pose(),this.scalled=!0;for(let e=0,s=this.bones.length;e<s;e++)this.bones[e].isPhysics=!1,this.bones[e].phyMtx=new t.Matrix4;e||this.applyScalling()},gi.childScale=function(e,t){if(!this.scalled)return;e.scalling&&t.scale(e.scalling);let s,r=e.children.length;for(;r--;)s=e.children[r],s.isBone,s.matrixWorld.multiplyMatrices(t,s.matrix)},gi.applyScalling=function(e){let t,s,r,i=this.bones.length;for(s=0;s<i;s++)t=this.bones[s],r=t.parent||null,null!==r&&r.scalling&&"root"!==t.name&&(t.position.multiply(r.scalling),t.updateMatrixWorld(!0));this.calculateInverses()},gi.update=function(){const e=this.bones,t=this.boneInverses,s=this.boneMatrices,r=this.boneTexture;let i,n=e.length,a=0;for(;n--;){i=e[a];const r=i?i.isPhysics?i.phyMtx:i.matrixWorld:mi;i.isPhysics&&(this.scalled=!0),this.childScale(i,r),di.multiplyMatrices(r,t[a]),di.toArray(s,16*a),a++}null!==r&&(r.needsUpdate=!0)};let yi=null,bi=null,xi=null,vi={},wi=null,Mi=!1,Ai=!1,Ti=!1,Si=!0,ki=!1,Ri=null,Ei={t1:0,t2:0,t3:0,t4:0},Pi=null,Ii=!1,_i=null,Li=null,Ci=!0,Fi=null,Bi=null,Oi=0,zi=0;const Di=new class{constructor(){this.key=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.key2=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.gamepad=new C(this.key),this.useGamepad=!1,this.sameAxis=!0,document.addEventListener("keydown",function(e){this.keyDown(e)}.bind(this),!1),document.addEventListener("keyup",function(e){this.keyUp(e)}.bind(this),!1)}setKey(e,t){this.key[e]=t}update(){return this.gamepad.update(),this.gamepad.ready&&(this.useGamepad||(this.useGamepad=!0),this.gamepad.getValue(0)),this.sameAxis&&(this.key[2]=this.key[0],this.key[3]=this.key[1]),this.key}keyDown(e){var t=this.key,s=this.key2;if(e=e||window.event,this.sameAxis)switch(e.which){case 65:case 81:case 37:t[0]=-1,s[0]=1;break;case 68:case 39:t[0]=1,s[1]=1;break;case 87:case 90:case 38:t[1]=-1;break;case 83:case 40:t[1]=1;break;case 32:t[4]=1;break;case 17:case 67:t[5]=1;break;case 69:t[6]=1;break;case 16:t[7]=1}else switch(e.which){case 65:case 81:t[0]=-1,s[0]=1;break;case 68:t[0]=1,s[1]=1;break;case 87:case 90:t[1]=-1;break;case 83:t[1]=1;break;case 37:t[2]=-1,s[0]=1;break;case 39:t[2]=1,s[1]=1;break;case 38:t[3]=-1;break;case 40:t[3]=1;break;case 32:t[4]=1;break;case 17:case 67:t[5]=1;break;case 69:t[6]=1;break;case 16:t[7]=1}this.gamepad.reset()}keyUp(e){var t=this.key,s=this.key2;if(e=e||window.event,this.sameAxis)switch(e.which){case 65:case 81:case 37:t[0]=t[0]<0?0:t[0],s[0]=0;break;case 68:case 39:t[0]=t[0]>0?0:t[0],s[1]=0;break;case 87:case 90:case 38:t[1]=t[1]<0?0:t[1];break;case 83:case 40:t[1]=t[1]>0?0:t[1];break;case 32:t[4]=0;break;case 17:case 67:t[5]=0;break;case 69:t[6]=0;break;case 16:t[7]=0}else switch(e.which){case 65:case 81:t[0]=t[0]<0?0:t[0],s[0]=0;break;case 68:t[0]=t[0]>0?0:t[0],s[1]=0;break;case 87:case 90:t[1]=t[1]<0?0:t[1];break;case 83:t[1]=t[1]>0?0:t[1];break;case 37:t[2]=t[2]<0?0:t[2],s[0]=0;break;case 39:t[2]=t[2]>0?0:t[2],s[1]=0;break;case 38:t[3]=t[3]<0?0:t[3];break;case 40:t[3]=t[3]>0?0:t[3];break;case 32:t[4]=0;break;case 17:case 67:t[5]=0;break;case 69:t[6]=0;break;case 16:t[7]=0}}},Ni=new class{constructor(e=-1){this.time={now:0,delta:0,then:0,interval:0,tmp:0,n:0,dt:0},this.fps=0,this.delta=0,this.elapsedTime=0,this.unlimited=!1,this.setFramerate(e),this.force=!1}up(e=0){let t=this.time;return this.unlimited&&(this.force=!0),t.now=e,t.delta=t.now-t.then,this.force&&(t.delta=t.interval,this.force=!1),!!(t.delta>=t.interval||this.unlimited)&&(t.then=this.unlimited?t.now:t.now-t.delta%t.interval,this.delta=.001*t.interval,this.elapsedTime+=this.delta,!0)}setFramerate(e){this.elapsedTime=0,this.framerate=e,this.unlimited=this.framerate<0,this.time.interval=1e3/e,60===e&&(this.time.interval=16.67)}}(60);let Ui=function(){return 0},Vi=function(){},ji=function(){},Gi=function(){},Hi=[],Wi=[],qi=[];const Xi={fps:60,fixe:!0,full:!1,substep:2,gravity:[0,-9.81,0]};class Ki{static getSetting(){return Xi}static setGravity(){b.post({m:"setGravity",o:{gravity:Xi.gravity}})}static set(e={}){Xi.fixe=void 0===e.fixe||e.fixe,Xi.full=void 0!==e.full&&e.full,Xi.gravity=e.gravity?e.gravity:[0,-9.81,0],Xi.substep=e.substep?e.substep:2,Xi.fps=e.fps?e.fps:60,e.key&&Gi(),fi.body.setFull(Xi.full),Ki.initArray(Xi.full),zi=0,Ti=Mi,Si=!Ti,b.jointVisible=e.jointVisible||!1,Si&&Ni.setFramerate(Xi.fps);const t={...Xi,ArPos:vi,isTimeout:Ti,outsideStep:Si};b.post({m:"set",o:t})}static math=l;static activeMouse(e,t){Pi||(Pi=new si(e,t))}static mouseMode(e,t){Pi&&Pi.setMode(e,t)}static getTimeTest(){return Ei}static setMaxFps(e){}static setAddControl(e){Gi=e}static setPostUpdate(e){ji=null!==e?e:function(){}}static setAzimut(e){Ui=e}static setKey(e,t){return Di.setKey(e,t)}static getKey(){return Di.key}static getKey2(){return Di.key2}static getAzimut(){return Ui()}static setContent(e){b.threeScene=e,e.add(b.scene),e.add(b.scenePlus)}static setControl(e){Li=e,Ui=Li.getAzimuthalAngle}static message(e){let t=e.data;t.Ar&&(xi=t.Ar),t.reflow&&(b.reflow=t.reflow,b.reflow.stat.delta&&(zi+=b.reflow.stat.delta)),Ki[t.m](t.o)}static post(e,t=null,s=!1){Mi?(e.o&&("solver"!==e.o.type&&void 0===e.o.solver||(s=!0)),s?wi.postMessage(e,t):"add"===e.m?b.flow.add.push(e.o):"remove"===e.m?b.flow.remove.push(e.o):wi.postMessage(e,t)):_i({data:e})}static makeView(){}static getScene(){return b.scene}static resize(e){b.viewSize=e}static init(e={}){let s=document.location.href.replace(/\/[^/]*$/,"/");var r=s.split("/");s=r[0]+"//"+r[2]+"/","https://lo-th.github.io/"===s&&(s="https://lo-th.github.io/phy/");const i=e.path||"build/",n={Ammo:i+"ammo3.wasm.js",Physx:i+"physx-js-webidl.js",Havok:i+"HavokPhysics.js"};let a=e.type||"PHYSX",o=a.toLowerCase(),l=o.charAt(0).toUpperCase()+o.slice(1);if(navigator.userAgent.toLowerCase().indexOf("firefox"),b.engine=a,Ki.initItems(),wr.materialRoot=L.set,e.callback&&(bi=e.callback,delete e.callback),Mi=e.worker||!1,b.scene=new t.Group,b.scene.name="phy_scene",b.scenePlus=new t.Group,b.scenePlus.name="phy_scenePlus",e.scene&&(Ki.setContent(e.scene),delete e.scene),b.post=Ki.post,b.motor=Ki,Mi){n[l]&&(e.blob=s+n[l]),wi=new Worker(s+i+l+".min.js"),wi.postMessage=wi.webkitPostMessage||wi.postMessage,wi.onmessage=Ki.message;let t=new ArrayBuffer(1);wi.postMessage({m:"test",ab:t},[t]),Ai=!t.byteLength,e.isBuffer=Ai,console.log(" Worker "+a+(e.isBuffer?" with Shared Buffer":"")),Ki.initPhysics(e)}else n[l]?Ki.loadWasmDirect(n[l],e,l,s):Ki.preLoad(l,e,s)}static loadWasmDirect(e,t,s,r){let i=document.createElement("script");i.src=r+e,document.body.appendChild(i),i.onload=()=>{Ki.preLoad(s,t,r)}}static async preLoad(e,t,s){let r=await import(t.devMode?s+"src/"+e+".js":s+"build/"+e+".module.js");_i=r.engine.message,t.message=Ki.message,Ki.initPhysics(t)}static initPhysics(e){b.post({m:"init",o:e}),ki=!0}static getPause(){return Ii}static pause(e){e!==Ii&&(Ii=e,Ii?Ki.pausetimout():Ki.playtimout(),b.post({m:"pause",o:{value:Ii}}))}static flowReset(){b.flow={stamp:0,current:"",key:[],tmp:[],add:[],remove:[]}}static reset(e){if(Ci)return Ci=!1,void e();Hi=[],Ki.clearText(),Ki.clearParticleSolver(),Ki.cleartimout(),yi=null,Li&&Li.resetAll(),Pi&&Pi.unSelect(),Vi=e,ji=function(){},Ki.flowReset(),Ki.clearInstance(),Ki.resetItems(),k(),L.dispose(),b.disposeTmp(),null!==Ri&&(Ri=null),b.tmpTex=[],b.scenePlus.children=[],b.scene.children=[],b.post({m:"reset"})}static resetCallback(){Vi()}static ready(){console.log((Mi?"Worker ":"Direct ")+b.engine+" is ready !"),bi&&bi()}static start(e={}){b.post({m:"start",o:e})}static morph(e,t,s){x.morph(e,t,s)}static getFps(){return b.reflow.stat.fps}static getDelta2(){return b.reflow.stat.delta}static getElapsedTime2(){return zi}static getDelta(){return Ni.delta}static getElapsedTime(){return Ni.elapsedTime}static doStep(e){ki&&Si&&Ni.up(e)&&b.post({m:"step",o:e})}static step(){b.delta=Si?Ni.delta:b.reflow.stat.delta,Ki.stepItems(),b.flow.key=Di.update(),b.flow.current=null!==yi?yi.name:"",null!==Ri&&Ri.step(),null!==yi&&yi.move(),Pi&&Pi.step(),ji(Ni.delta),Ki.changes(b.flow.tmp),Ai?b.post({m:"poststep",flow:b.flow,Ar:xi},[xi.buffer]):b.post({m:"poststep",flow:b.flow}),Ki.flowReset()}static initArray(e=!1){vi=function(e,t=!1){let s={},r={body:h*(t?g.bodyFull:g.body),joint:c*g.joint,ray:p*g.ray,contact:u*g.contact,character:d*g.character};"PHYSX"!==e&&"AMMO"!==e||(r.vehicle=m*g.vehicle),"PHYSX"===e&&(r.solver=f*g.solver),"HAVOK"!==e&&"RAPIER"!==e||(g.joint=0);let i=0;for(let e in r)s[e]=i,i+=r[e];return s.total=i,s}(b.engine,e)}static upInstance(){for(let e in b.instanceMesh)b.instanceMesh[e].update()}static clearInstance(){for(let e in b.instanceMesh)b.instanceMesh[e].dispose();b.instanceMesh={}}static texture(e={}){return wr.texture(e)}static material(e={}){return L.create(e)}static setExtendShader(e){L.extendShader=e}static getMaterialList(){return L.getList()}static getOneMaterial(e){return console.log("use getMat"),L.get(e)}static addMaterial(e,t){L.set(e,t)}static setEnvmapIntensity(e){L.setEnvmapIntensity(e)}static getMat(e){return L.get(e)}static control(e){null!==yi?e!==yi.name&&(yi=Ki.byName(e)):yi=Ki.byName(e)}static byName(e){return x.byName(e)}static getAllBody(e){return fi.body.list}static explosion(e=[0,0,0],s=10,r=1){let i=[],n=new t.Vector3;e&&(e.isVector3?n.copy(e):n.fromArray(e));let a,o,l=new t.Vector3,h=fi.body.list.length;for(;h--;)a=fi.body.list[h],l.copy(a.position).sub(n),o=1-l.length()/s,a.isKinematic||o<0||(l.setLength(o),l.multiplyScalar(r),i.push({name:a.name,impulse:l.toArray(),wake:!0}));Ki.change(i)}static addButton(e){let t=new ei(e);return Hi.push(t),t}static upButton(e){for(const e in Hi)Hi[e].update()}static getBodyRef(){return fi.body}static initItems(){fi={body:new we,solid:new Qi,character:new Vr,ray:new B,joint:new Me,contact:new Te,terrain:new Xr},"PHYSX"!==b.engine&&"AMMO"!==b.engine||(fi.vehicle=new ke),"PHYSX"===b.engine&&(fi.solver=new Qr),b.items=fi}static clearBody(){fi.body.reset()}static resetItems(){for(const e in fi)fi[e].reset()}static stepItems(){if(null!==xi){Ki.upButton();for(const e in fi)fi[e].step(xi,vi[e]);Ki.upInstance()}}static addDirect(e){b.scenePlus.add(e),b.tmpMesh.push(e)}static adds(e=[],t){let s=e.length,r=0;for(;s--;)Ki.add(e[r],t),r++}static add(e={},t=!1){if(e.isObject3D)return Ki.addDirect(e);if(e.constructor===Array)return Ki.adds(e,t);if("container"===e.type)return new ti(e);void 0!==e.bounce&&(e.restitution=e.bounce),void 0===e.type&&(e.type="box");let s=function(e){switch(e.type){case"plane":case"box":case"sphere":case"highSphere":case"cylinder":case"stair":case"particle":case"cone":case"capsule":case"mesh":case"convex":case"compound":case"null":return e.mass||e.density||e.kinematic?"body":"solid";default:return e.type}}(e);return fi[s].add(e)}static removes(e=[],t){for(let s in e)Ki.remove(e[s],t)}static remove(e,t=!1){if(e.constructor===Array)return Ki.removes(e,t);let s=Ki.byName(e);null!==s&&(fi[s.type].clear(s),b.post({m:"remove",o:{name:e,type:s.type}},null,t))}static up(e){console.log("up is old"),Ki.change(e,!0)}static update(e){console.log("update is old"),Ki.change(e)}static change(e,t=!1){t?e instanceof Array?Ki.changes(e,!0):Ki.changeOne(e,!0):e instanceof Array?b.flow.tmp.push(...e):b.flow.tmp.push(e)}static changes(e=[],t=!1){for(let s in e)Ki.changeOne(e[s],t)}static changeOne(e={},t=!1){if(e.heightData)return;let s=Ki.byName(e.name);if(null===s)return null;let r=s.type;switch(e.drivePosition&&void 0!==e.drivePosition.rot&&(e.drivePosition.quat=l.quatFromEuler(e.drivePosition.rot),delete e.drivePosition.rot),void 0!==e.rot&&(e.quat=l.quatFromEuler(e.rot),delete e.rot),void 0!==e.localRot&&(e.quat=l.toLocalQuatArray(e.localRot,s),delete e.localRot),r){case"terrain":s=fi.terrain.set(e,s),t=!1;break;case"character":s=fi.character.set(e,s);break;case"solid":s=fi.solid.set(e,s);break;case"ray":s=fi.ray.set(e,s),t=!1;break;case"joint":s=fi.joint.set(e,s);break;case"body":s.isKinematic&&fi.body.set(e,s)}t&&b.post({m:"change",o:e})}static setCamera(e={}){Li.moveCam(e)}static follow(e="",t={}){let s=null;"string"==typeof e||e instanceof String?s=""===e?null:Ki.byName(e):e.isObject3D&&(s=e),null===s?Li.resetFollow():Li.startFollow(s,t)}static setTimeout(e,t=0){Bi=e,Oi=t,Fi=setTimeout(Bi,Oi)}static playtimout(){null!==Bi&&(Fi=setTimeout(Bi,Oi))}static pausetimout(){null!==Fi&&clearTimeout(Fi)}static cleartimout(e,t){null!==Fi&&(Bi=null,Oi=0,clearTimeout(Fi),Fi=null)}static addBreaker(){null===Ri&&(Ri=new ai)}static load(e,t,s="",r=""){wr.load(e,t,s,r)}static applyMorph(e,t=null,s=!0,r=!0){wr.applyMorph(e,null,!0,!0)}static uv2(e){wr.uv2(e)}static getMesh(e,t){if(t){let t=wr.getMaterials(e);for(let e in t)Ki.addMaterial(t[e])}return wr.getMesh(e,t)}static getGroup(e,t,s){return wr.getGroup(e,t,s)}static getTexture(e,t){return wr.getTexture(obj,autoMesh,autoMaterial)}static getScript(e){return wr.getScript(e)}static get(e,t){return wr.get(e,t)}static poolDispose(){return wr.dispose()}static setDracoPath(e){return wr.dracoPath=e}static initParticle(){}static addParticle(){}static getParticle(){}static addParticleSolver(e){let t=new pi(e);return qi.push(t),t}static updateParticleSolver(){let e=qi.length;for(;e--;)qi[e].update()}static clearParticleSolver(){qi.length,qi=[]}static addText(e){let t=new Jr(e);return e.parent?e.parent.add(t):b.scenePlus.add(t),Wi.push(t),t}static clearText(){let e=Wi.length;for(;e--;)Wi[e].dispose();Wi=[]}}class Qi extends we{constructor(){super(),this.type="solid"}step(e,t){}}const Zi=Ki;e.phy=Zi,Object.defineProperty(e,"__esModule",{value:!0})}));
